<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>bee-doo ¬∑ Enpal Board</title>
<script src="config.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.2/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',system-ui,sans-serif;background:#0c1222;color:#e1e7ef;min-height:100vh}
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap');
button,select,input{font-family:inherit;color:inherit}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:#263354;border-radius:3px}
</style>

<style>

/* ‚ïê‚ïê‚ïê bee-doo Responsive + Lesbarkeit Fix ‚ïê‚ïê‚ïê */

/* === LESBARKEIT: Schriften aufhellen === */
/* Zu dunkle Graut√∂ne auf Dark Theme aufhellen */
body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

/* === TABLET (768px) === */
@media (max-width: 768px) {
  /* Grid ‚Üí weniger Spalten */
  [style*="grid-template-columns"][style*="repeat"] { 
    grid-template-columns: repeat(2, 1fr) !important; 
  }
  [style*="gridTemplateColumns"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* Flex-Container wrappen */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'], [style*="display:'flex'"] {
    flex-wrap: wrap !important;
  }
  /* Ausnahme: Nav-Items und kleine Icon-Rows nicht wrappen */
  [style*="align-items:center"][style*="gap:4px"],
  [style*="alignItems:"center""][style*="gap:"4px""] {
    flex-wrap: nowrap !important;
  }
  
  /* Sidebar verkleinern */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'] {
    width: 200px !important;
    min-width: 200px !important;
  }
  
  /* Modals nicht breiter als Screen */
  .modal, [style*="width:480px"], [style*="width:520px"], [style*="width:560px"],
  [style*="width:600px"], [style*="width:640px"], [style*="width:700px"] {
    width: 95vw !important;
    max-width: 95vw !important;
  }
  
  /* Padding reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"] {
    padding: 20px !important;
  }
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"] {
    padding: 20px !important;
  }
  
  /* Tabellen scrollbar */
  table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  
  /* Font-Size Minimum */
  * { min-height: 0; }
}

/* === MOBILE (480px) === */
@media (max-width: 480px) {
  /* Grid ‚Üí 1 Spalte */
  [style*="grid-template-columns"], [style*="gridTemplateColumns"] { 
    grid-template-columns: 1fr !important; 
  }
  .grid { grid-template-columns: 1fr !important; }
  
  /* Sidebar ausblenden oder collapsieren */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*="width:200px"], [style*="width: 200px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'],
  [style*='width:"200px"'] {
    position: fixed !important;
    left: -300px !important;
    z-index: 999 !important;
    transition: left 0.3s ease !important;
    width: 260px !important;
    height: 100vh !important;
    top: 0 !important;
  }
  
  /* Alle Flex-Container stacken */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'] {
    flex-wrap: wrap !important;
  }
  [style*="flex-direction:row"], [style*="flexDirection:"row""],
  [style*="flex-direction: row"] {
    flex-direction: column !important;
  }
  
  /* Form-Elemente full width */
  input, select, textarea, .input-field {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    font-size: 16px !important; /* Prevents iOS zoom */
  }
  
  /* Buttons touch-friendly */
  button, .btn-primary, .btn-secondary, [role="button"] {
    min-height: 44px !important;
    min-width: 44px !important;
    font-size: 14px !important;
  }
  
  /* Padding stark reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"],
  [style*="padding:28px"], [style*="padding:24px"],
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"],
  [style*="padding: 28px"], [style*="padding: 24px"] {
    padding: 12px !important;
  }
  
  /* Gap reduzieren */
  [style*="gap:24px"], [style*="gap:20px"], [style*="gap:28px"],
  [style*="gap: 24px"], [style*="gap: 20px"], [style*="gap: 28px"] {
    gap: 12px !important;
  }
  
  /* Font sizes - minimum 12px */
  [style*="font-size:8px"], [style*="font-size:9px"], [style*="font-size:10px"],
  [style*="font-size: 8px"], [style*="font-size: 9px"], [style*="font-size: 10px"],
  [style*="fontSize:8px"], [style*="fontSize:9px"], [style*="fontSize:10px"],
  [style*='fontSize:"8px"'], [style*='fontSize:"9px"'], [style*='fontSize:"10px"'] {
    font-size: 12px !important;
  }
  
  /* Bilder responsive */
  img { max-width: 100% !important; height: auto !important; }
  
  /* Fixed elements repositionieren */
  [style*="position:fixed"][style*="top:12px"][style*="left:12px"],
  [style*="position: fixed"][style*="top: 12px"][style*="left: 12px"] {
    top: 6px !important;
    left: 6px !important;
    font-size: 11px !important;
    padding: 4px 8px !important;
  }
  
  /* Logo kleiner */
  .logo { font-size: 32px !important; }
  
  /* Text wrap erzwingen */
  * { word-wrap: break-word !important; overflow-wrap: break-word !important; }
  [style*="white-space:nowrap"], [style*="white-space: nowrap"],
  [style*='whiteSpace:"nowrap"'] {
    white-space: normal !important;
  }
  
  /* Modals full width */
  .modal, [class*="modal"], [style*="width:480px"], [style*="width:520px"],
  [style*="width:560px"], [style*="width:600px"] {
    width: 96vw !important;
    max-width: 96vw !important;
    padding: 16px !important;
    margin: 8px !important;
  }
  
  /* Map containers */
  #map, .leaflet-container, [style*="height:100vh"] {
    height: calc(100vh - 60px) !important;
  }
  .map-toolbar {
    flex-direction: column !important;
    top: 6px !important;
    left: 6px !important;
    right: 6px !important;
  }
  .map-tool-btn {
    font-size: 11px !important;
    padding: 5px 10px !important;
  }
}

/* ‚ïê‚ïê‚ïê Lesbarkeit: Zu dunkle Farben aufhellen ‚ïê‚ïê‚ïê */
/* #0c1222 backgrounds ‚Üí Schrift mindestens #8b95a5 */
[style*="color:#0c1222"], [style*="color: #0c1222"] { color: #8b95a5 !important; }
[style*="color:#151d30"], [style*="color: #151d30"] { color: #8b95a5 !important; }
[style*="color:#263354"], [style*="color: #263354"] { color: #7a8baa !important; }
[style*="color:#1c2640"], [style*="color: #1c2640"] { color: #8b95a5 !important; }
[style*="color:#334155"], [style*="color: #334155"] { color: #8b95a5 !important; }
[style*="color:#252530"], [style*="color: #252530"] { color: #8b95a5 !important; }
[style*='color:"#0c1222"'] { color: #8b95a5 !important; }
[style*='color:"#151d30"'] { color: #8b95a5 !important; }
[style*='color:"#263354"'] { color: #7a8baa !important; }
[style*='color:"#1c2640"'] { color: #8b95a5 !important; }
[style*='color:"#334155"'] { color: #8b95a5 !important; }
[style*='color:"#252530"'] { color: #8b95a5 !important; }

/* Gr√ºnt√∂ne auf Dark besser lesbar machen */
[style*="color:#166534"], [style*="color: #166534"] { color: #34d399 !important; }
[style*='color:"#166534"'] { color: #34d399 !important; }

/* Generell: Alle font-sizes unter 10px auf mindestens 11px */
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useMemo, useRef, useEffect } = React;

const SB_URL = window.BEEDOO_CONFIG?.SB_URL || 'https://hqzpemfaljxcysyqssng.supabase.co';
const SB_SRV = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTMzNTM5NywiZXhwIjoyMDg2OTExMzk3fQ.MJ3cyAAquE8DK2ngzfIIn4bTpQ8_H9DaeJ3YTlBdFz4';

const DK='#0c1222',C1='#151d30',C2='#1c2640',BD='#263354',TX='#e1e7ef',DM='#5c6b8a';
const Y='#FDE154',GN='#22c55e',RD='#ef4444',AM='#f59e0b',BL='#3b82f6',PP='#a855f7';

const fmt  = n => n==null ? '‚Äî' : Number(n).toLocaleString('de-DE');
const fmtE = n => n==null ? '‚Äî' : Math.round(n).toLocaleString('de-DE')+' ‚Ç¨';
const fmtP = n => n==null ? '‚Äî' : n.toFixed(1)+' %';

function parseCSV(txt) {
  let r = Papa.parse(txt.trim(), {header:true, skipEmptyLines:true, delimiter:';'});
  if (!r.data.length || Object.keys(r.data[0]).length < 3)
    r = Papa.parse(txt.trim(), {header:true, skipEmptyLines:true, delimiter:','});
  return r.data.map(row => {
    const n={};
    for (const [k,v] of Object.entries(row)) n[k.trim()]=(v||'').trim();
    return n;
  });
}

async function saveToSupabase(rows, label) {
  await fetch(SB_URL+'/rest/v1/enpal_leads?id=gte.0', {
    method:'DELETE',
    headers:{'apikey':SB_SRV,'Authorization':'Bearer '+SB_SRV}
  });
  for (let i=0; i<rows.length; i+=500) {
    const chunk = rows.slice(i,i+500).map(r=>({import_label:label, row_data:r}));
    const res = await fetch(SB_URL+'/rest/v1/enpal_leads', {
      method:'POST',
      headers:{'apikey':SB_SRV,'Authorization':'Bearer '+SB_SRV,'Content-Type':'application/json','Prefer':'return=minimal'},
      body: JSON.stringify(chunk)
    });
    if (!res.ok) throw new Error(await res.text());
  }
}

function getCols(rows) {
  if (!rows.length) return {};
  const K = Object.keys(rows[0]);
  const f = (...t) => K.find(k => t.some(x => k.toLowerCase().includes(x.toLowerCase())));
  return {
    status:  f('Status','Terminstatus','Ergebnis'),
    berater: f('Berater (VB)','Berater','VB'),
    datum:   f('Datum','Termin Datum'),
    umsatz:  f('Umsatz','Auftragswert','Wert','Netto','Brutto'),
    ag:      f('Ausfallgrund','Stornogr','Absagegrund','Grund'),
  };
}

function calcM(rows, cols) {
  const n = rows.length; if (!n) return null;
  const isA   = s => ['abgeschlossen','abschluss','gewonnen','auftrag','deal'].some(x=>s.includes(x));
  const isAus  = s => ['ausgefallen','abgesagt','storno','abgelehnt','nicht erschienen'].some(x=>s.includes(x));
  const isT   = s => isA(s)||['stattgefunden','durchgef√ºhrt','positiv','interessiert'].some(x=>s.includes(x));
  const sv = rows.map(r => (r[cols.status]||'').toLowerCase());
  const ab=sv.filter(isA).length, aus=sv.filter(isAus).length, ter=sv.filter(isT).length;
  let um=0;
  if (cols.umsatz) rows.forEach(r => {
    if (isA((r[cols.status]||'').toLowerCase())) {
      const v=parseFloat((r[cols.umsatz]||'0').replace(/\./g,'').replace(',','.'));
      if (!isNaN(v)) um+=v;
    }
  });
  const gr={};
  if (cols.ag) rows.filter(r=>isAus((r[cols.status]||'').toLowerCase())).forEach(r=>{
    const g=r[cols.ag]||'Unbekannt'; gr[g]=(gr[g]||0)+1;
  });
  const byB={};
  if (cols.berater) rows.forEach(r=>{
    const b=r[cols.berater]||'?';
    if (!byB[b]) byB[b]={name:b,total:0,ab:0,um:0,aus:0};
    byB[b].total++;
    const s=(r[cols.status]||'').toLowerCase();
    if (isA(s)) { byB[b].ab++; if (cols.umsatz){const v=parseFloat((r[cols.umsatz]||'0').replace(/\./g,'').replace(',','.'));if(!isNaN(v))byB[b].um+=v;}}
    if (isAus(s)) byB[b].aus++;
  });
  const byM={};
  if (cols.datum) rows.forEach(r=>{
    const raw=r[cols.datum]; if (!raw) return;
    const p=raw.split('.');
    const key=p.length>=2 ? (p[1]+'/'+(p.length>=3?p[2].substring(2):'??')) : raw.substring(0,7);
    if (!byM[key]) byM[key]={monat:key,total:0,ab:0,aus:0};
    byM[key].total++;
    const s=(r[cols.status]||'').toLowerCase();
    if (isA(s)) byM[key].ab++;
    if (isAus(s)) byM[key].aus++;
  });
  const sm={};
  rows.forEach(r=>{const s=r[cols.status]||'Unbekannt';sm[s]=(sm[s]||0)+1;});
  return {
    n, ab, aus, ter, um,
    tq: n>0?(ter/n)*100:0, aq: ter>0?(ab/ter)*100:0, auq: n>0?(aus/n)*100:0,
    avgDeal: ab>0?um/ab:0,
    byB: Object.values(byB).sort((a,b)=>b.ab-a.ab),
    byM: Object.values(byM).sort((a,b)=>a.monat.localeCompare(b.monat)),
    gr: Object.entries(gr).map(([k,v])=>({name:k,count:v})).sort((a,b)=>b.count-a.count),
    sm: Object.entries(sm).map(([k,v])=>({name:k,value:v})).sort((a,b)=>b.value-a.value),
  };
}

function Bar({pct, color}) {
  return (
    <div style={{height:6,background:C2,borderRadius:3,marginTop:4}}>
      <div style={{height:'100%',width:Math.min(100,pct||0)+'%',background:color,borderRadius:3}} />
    </div>
  );
}

function KPI({label, value, sub, color, large}) {
  const c = color || Y;
  return (
    <div style={{background:C1,border:'1px solid '+BD,borderRadius:10,padding:'20px 24px',minWidth:140}}>
      <div style={{fontSize:large?28:22,fontWeight:800,color:c}}>{value}</div>
      <div style={{fontSize:13,fontWeight:600,color:TX,marginTop:2}}>{label}</div>
      {sub && <div style={{fontSize:11,color:DM,marginTop:2}}>{sub}</div>}
    </div>
  );
}

function DropZone({label, file, onFile, color}) {
  const [drag, setDrag] = useState(false);
  const ref = useRef();
  const handle = f => {
    if (!f || !f.name.endsWith('.csv')) return;
    const reader = new FileReader();
    reader.onload = e => { try { onFile({name:f.name, rows:parseCSV(e.target.result)}); } catch(err){ alert(err.message); } };
    reader.readAsText(f,'utf-8');
  };
  const bc = drag ? color : (file ? color : BD);
  const bg = drag ? C2 : (file ? C2 : C1);
  return (
    <div
      onClick={() => ref.current.click()}
      onDragOver={e=>{e.preventDefault();setDrag(true);}}
      onDragLeave={() => setDrag(false)}
      onDrop={e=>{e.preventDefault();setDrag(false);handle(e.dataTransfer.files[0]);}}
      style={{borderRadius:10,padding:16,cursor:'pointer',textAlign:'center',border:'2px dashed '+bc,background:bg,transition:'all .2s'}}
    >
      <input ref={ref} type="file" accept=".csv" style={{display:'none'}} onChange={e=>handle(e.target.files[0])} />
      <div style={{fontSize:20,marginBottom:4}}>{file?'‚úÖ':'üìÇ'}</div>
      <div style={{fontSize:12,fontWeight:700,color:file?color:DM}}>{label}</div>
      <div style={{fontSize:11,color:DM,marginTop:3}}>{file ? file.name+' ¬∑ '+file.rows.length+' Zeilen' : 'CSV ablegen oder klicken'}</div>
    </div>
  );
}

function Board({enpalRows, allRows}) {
  const [tab, setTab] = useState('uebersicht');
  const [bf, setBf] = useState('alle');
  const [zf, setZf] = useState('alle');
  const [saving, setSaving] = useState(false);
  const [saveStatus, setSaveStatus] = useState(null);

  const cols = useMemo(() => getCols(enpalRows), [enpalRows]);
  const beraterList = useMemo(() => {
    if (!cols.berater) return [];
    return [...new Set(enpalRows.map(r=>r[cols.berater]).filter(Boolean))].sort();
  }, [enpalRows, cols]);

  const filtered = useMemo(() => {
    let r = enpalRows;
    if (bf !== 'alle' && cols.berater) r = r.filter(x => x[cols.berater]===bf);
    if (zf !== 'alle' && cols.datum) {
      const now = new Date();
      r = r.filter(x => {
        const raw=x[cols.datum]; if (!raw) return false;
        const p=raw.split('.');
        const d=p.length===3?new Date(p[2]+'-'+p[1]+'-'+p[0]):new Date(raw);
        if (isNaN(d)) return false;
        const diff=(now-d)/86400000;
        return zf==='7'?diff<=7:zf==='30'?diff<=30:diff<=90;
      });
    }
    return r;
  }, [enpalRows, bf, zf, cols]);

  const M = useMemo(() => calcM(filtered, cols), [filtered, cols]);

  const doSave = async () => {
    setSaving(true); setSaveStatus(null);
    try {
      const label = new Date().toLocaleString('de-DE');
      await saveToSupabase(allRows, label);
      setSaveStatus('ok');
    } catch(e) { setSaveStatus('err'); }
    setSaving(false);
    setTimeout(() => setSaveStatus(null), 5000);
  };

  const TABS = [
    {k:'uebersicht',l:'üìä √úbersicht'},
    {k:'berater',l:'üë§ Berater'},
    {k:'qualitaet',l:'üîç Qualit√§t'},
    {k:'trend',l:'üìà Trend'},
    {k:'tabelle',l:'üìã Tabelle'},
  ];
  const saveBorder = saveStatus==='ok' ? GN : saveStatus==='err' ? RD : BD;

  return (
    <div>
      <div style={{background:C2,border:'1px solid '+saveBorder,borderRadius:12,padding:'14px 20px',marginBottom:20,display:'flex',alignItems:'center',justifyContent:'space-between',gap:16,flexWrap:'wrap'}}>
        <div>
          <div style={{fontSize:14,fontWeight:700}}>‚òÅÔ∏è In Supabase speichern</div>
          <div style={{fontSize:12,color:DM,marginTop:2}}>{enpalRows.length} Enpal-Leads ¬∑ {allRows.length} Gesamtzeilen ¬∑ Externes Board aktualisieren</div>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          {saveStatus==='ok' && <span style={{color:GN,fontSize:13,fontWeight:600}}>‚úì Gespeichert!</span>}
          {saveStatus==='err' && <span style={{color:RD,fontSize:13}}>‚úó Fehler ‚Äî nochmal</span>}
          <button onClick={doSave} disabled={saving} style={{background:saving?BD:Y,color:saving?TX:'#0c1222',border:'none',borderRadius:8,padding:'10px 22px',fontWeight:800,fontSize:14,cursor:saving?'not-allowed':'pointer',fontFamily:'inherit'}}>
            {saving ? '‚è≥ Speichern...' : '‚¨ÜÔ∏è Jetzt speichern'}
          </button>
        </div>
      </div>

      <div style={{display:'flex',gap:8,marginBottom:16,flexWrap:'wrap',alignItems:'center'}}>
        <span style={{fontSize:12,color:DM}}>{enpalRows.length} Enpal-Leads</span>
        {beraterList.length > 0 && (
          <select value={bf} onChange={e=>setBf(e.target.value)} style={{background:C2,border:'1px solid '+BD,borderRadius:8,color:TX,padding:'6px 10px',fontSize:12}}>
            <option value="alle">üë§ Alle Berater</option>
            {beraterList.map(b => <option key={b} value={b}>{b}</option>)}
          </select>
        )}
        <select value={zf} onChange={e=>setZf(e.target.value)} style={{background:C2,border:'1px solid '+BD,borderRadius:8,color:TX,padding:'6px 10px',fontSize:12}}>
          <option value="alle">üìÖ Gesamt</option>
          <option value="7">7 Tage</option>
          <option value="30">30 Tage</option>
          <option value="90">90 Tage</option>
        </select>
      </div>

      <div style={{display:'flex',gap:4,marginBottom:20,flexWrap:'wrap'}}>
        {TABS.map(t => {
          const active = tab===t.k;
          return (
            <button key={t.k} onClick={()=>setTab(t.k)} style={{padding:'8px 16px',borderRadius:8,border:'none',cursor:'pointer',fontSize:13,fontWeight:600,fontFamily:'inherit',background:active?Y:C1,color:active?'#0c1222':DM}}>
              {t.l}
            </button>
          );
        })}
      </div>

      {!M ? (
        <div style={{textAlign:'center',padding:60,color:DM}}>Keine Daten nach Filter.</div>
      ) : (
        <div>
          {/* √úBERSICHT */}
          {tab==='uebersicht' && (
            <div>
              <div style={{display:'flex',gap:12,flexWrap:'wrap',marginBottom:20}}>
                <KPI label="Enpal Leads" value={fmt(M.n)} large />
                <KPI label="Terminierungsquote" value={fmtP(M.tq)} sub={M.ter+' terminiert'} color={M.tq>=50?GN:AM} large />
                <KPI label="Abschlussquote" value={fmtP(M.aq)} sub={M.ab+' Abschl√ºsse'} color={M.aq>=30?GN:AM} large />
                {cols.umsatz && <KPI label="Umsatz" value={fmtE(M.um)} sub={'√ò '+fmtE(M.avgDeal)} color={GN} large />}
                <KPI label="Ausfallquote" value={fmtP(M.auq)} sub={M.aus+' ausgefallen'} color={M.auq<30?GN:RD} large />
              </div>
              <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(300px,1fr))',gap:16}}>
                <div style={{background:C1,border:'1px solid '+BD,borderRadius:12,padding:20}}>
                  <div style={{fontSize:14,fontWeight:700,marginBottom:16}}>Status-Verteilung</div>
                  {M.sm.slice(0,8).map((s,i) => {
                    const colors=[Y,GN,BL,PP,AM,RD];
                    return (
                      <div key={s.name} style={{marginBottom:8}}>
                        <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
                          <span style={{fontSize:12}}>{s.name}</span>
                          <span style={{fontSize:12,fontWeight:700,color:Y}}>{s.value}</span>
                        </div>
                        <Bar pct={M.n?s.value/M.n*100:0} color={colors[i%6]} />
                      </div>
                    );
                  })}
                </div>
                {M.byB.length > 0 && (
                  <div style={{background:C1,border:'1px solid '+BD,borderRadius:12,padding:20}}>
                    <div style={{fontSize:14,fontWeight:700,marginBottom:16}}>Top Berater</div>
                    {M.byB.slice(0,8).map((b,i) => (
                      <div key={b.name} style={{marginBottom:8}}>
                        <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
                          <span style={{fontSize:12}}>{i+1}. {b.name}</span>
                          <span style={{fontSize:12,fontWeight:700,color:GN}}>{b.ab} Abschl√ºsse</span>
                        </div>
                        <Bar pct={M.byB[0].ab?b.ab/M.byB[0].ab*100:0} color={Y} />
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* BERATER */}
          {tab==='berater' && (
            <div>
              <div style={{fontSize:14,fontWeight:700,marginBottom:16}}>Berater-Ranking</div>
              {!M.byB.length ? (
                <div style={{color:DM,padding:40,textAlign:'center'}}>Keine Berater-Spalte erkannt.</div>
              ) : (
                <div style={{overflowX:'auto',background:C1,border:'1px solid '+BD,borderRadius:12}}>
                  <table style={{width:'100%',borderCollapse:'collapse',fontSize:13}}>
                    <thead>
                      <tr>
                        {['#','Berater','Leads','Abschl√ºsse','%','Ausgefallen','%',...(cols.umsatz?['Umsatz']:[])].map(h => (
                          <th key={h} style={{padding:'10px 12px',textAlign:['Leads','Abschl√ºsse','%','Ausgefallen','Umsatz'].includes(h)?'right':'left',color:DM,fontWeight:600,whiteSpace:'nowrap',borderBottom:'2px solid '+BD}}>{h}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {M.byB.map((b,i) => (
                        <tr key={b.name} style={{background:i%2===1?C1:DK}}>
                          <td style={{padding:'9px 12px',color:DM,fontWeight:700}}>{i+1}</td>
                          <td style={{padding:'9px 12px',fontWeight:600}}>{b.name}</td>
                          <td style={{padding:'9px 12px',textAlign:'right'}}>{b.total}</td>
                          <td style={{padding:'9px 12px',textAlign:'right',color:b.ab?GN:DM,fontWeight:700}}>{b.ab}</td>
                          <td style={{padding:'9px 12px',textAlign:'right',color:b.total&&b.ab/b.total>=.3?GN:AM}}>{b.total?fmtP(b.ab/b.total*100):'‚Äî'}</td>
                          <td style={{padding:'9px 12px',textAlign:'right',color:b.aus?AM:DM}}>{b.aus}</td>
                          <td style={{padding:'9px 12px',textAlign:'right'}}>{b.total?fmtP(b.aus/b.total*100):'‚Äî'}</td>
                          {cols.umsatz && <td style={{padding:'9px 12px',textAlign:'right',color:Y,fontWeight:600}}>{b.um?fmtE(b.um):'‚Äî'}</td>}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* QUALIT√ÑT */}
          {tab==='qualitaet' && (
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(300px,1fr))',gap:16}}>
              <div style={{background:C1,border:'1px solid '+BD,borderRadius:12,padding:20}}>
                <div style={{fontSize:14,fontWeight:700,marginBottom:4}}>Lead-Qualit√§t</div>
                <div style={{fontSize:12,color:DM,marginBottom:16}}>Enpal vs. Zielwerte</div>
                {[
                  {label:'Terminierungsquote',val:M.tq,bench:60,good:'>60%'},
                  {label:'Abschlussquote',val:M.aq,bench:30,good:'>30%'},
                  {label:'Ausfallquote',val:M.auq,bench:30,good:'<30%',inv:true},
                ].map(item => {
                  const color = item.inv ? (item.val<item.bench?GN:RD) : (item.val>item.bench?GN:AM);
                  return (
                    <div key={item.label} style={{marginBottom:14}}>
                      <div style={{display:'flex',justifyContent:'space-between',marginBottom:4}}>
                        <span style={{fontSize:13}}>{item.label}</span>
                        <span style={{fontSize:13,fontWeight:700,color}}>{fmtP(item.val)}</span>
                      </div>
                      <Bar pct={item.val} color={color} />
                      <div style={{fontSize:10,color:DM,marginTop:2}}>Ziel: {item.good}</div>
                    </div>
                  );
                })}
              </div>
              <div style={{background:C1,border:'1px solid '+BD,borderRadius:12,padding:20}}>
                <div style={{fontSize:14,fontWeight:700,marginBottom:16}}>Ausfallgr√ºnde</div>
                {!M.gr.length ? (
                  <div style={{color:DM,fontSize:13}}>Keine Ausfallgr√ºnde-Spalte erkannt.</div>
                ) : M.gr.slice(0,8).map(g => (
                  <div key={g.name} style={{marginBottom:8}}>
                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
                      <span style={{fontSize:12,flex:1,marginRight:8,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{g.name}</span>
                      <span style={{fontSize:12,fontWeight:700,color:RD}}>{g.count}</span>
                    </div>
                    <Bar pct={M.gr[0].count?g.count/M.gr[0].count*100:0} color={RD} />
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* TREND */}
          {tab==='trend' && (
            <div style={{background:C1,border:'1px solid '+BD,borderRadius:12,padding:20}}>
              <div style={{fontSize:14,fontWeight:700,marginBottom:16}}>Monatlicher Verlauf</div>
              {!M.byM.length ? (
                <div style={{color:DM,fontSize:13}}>Keine Datum-Spalte erkannt.</div>
              ) : (
                <div style={{overflowX:'auto'}}>
                  <table style={{width:'100%',borderCollapse:'collapse',fontSize:13}}>
                    <thead>
                      <tr>
                        {['Monat','Leads','Abschl√ºsse','%','Ausgefallen','%'].map(h => (
                          <th key={h} style={{padding:'10px 12px',textAlign:h==='Monat'?'left':'right',color:DM,fontWeight:600,borderBottom:'2px solid '+BD}}>{h}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {M.byM.map((m,i) => (
                        <tr key={m.monat} style={{background:i%2===1?C1:DK}}>
                          <td style={{padding:'9px 12px',fontWeight:600}}>{m.monat}</td>
                          <td style={{padding:'9px 12px',textAlign:'right',color:Y,fontWeight:700}}>{m.total}</td>
                          <td style={{padding:'9px 12px',textAlign:'right',color:GN}}>{m.ab}</td>
                          <td style={{padding:'9px 12px',textAlign:'right'}}>{m.total?fmtP(m.ab/m.total*100):'‚Äî'}</td>
                          <td style={{padding:'9px 12px',textAlign:'right',color:AM}}>{m.aus}</td>
                          <td style={{padding:'9px 12px',textAlign:'right'}}>{m.total?fmtP(m.aus/m.total*100):'‚Äî'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* TABELLE */}
          {tab==='tabelle' && (
            <div>
              <div style={{fontSize:13,color:DM,marginBottom:12}}>{filtered.length} Zeilen</div>
              <div style={{overflowX:'auto',background:C1,border:'1px solid '+BD,borderRadius:12}}>
                <table style={{width:'100%',borderCollapse:'collapse',fontSize:13}}>
                  <thead>
                    <tr>
                      {Object.keys(filtered[0]||{}).slice(0,12).map(col => (
                        <th key={col} style={{padding:'10px 12px',textAlign:'left',color:DM,fontWeight:600,whiteSpace:'nowrap',borderBottom:'2px solid '+BD,background:C1}}>{col}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.slice(0,200).map((row,i) => (
                      <tr key={i} style={{background:i%2===1?C1:DK}}>
                        {Object.keys(filtered[0]).slice(0,12).map(col => (
                          <td key={col} style={{padding:'9px 12px',whiteSpace:'nowrap',maxWidth:180,overflow:'hidden',textOverflow:'ellipsis'}}>{row[col]}</td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
                {filtered.length>200 && <div style={{padding:'12px 16px',fontSize:12,color:DM,borderTop:'1px solid '+BD}}>Zeige 200 von {filtered.length} Zeilen</div>}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

function App() {
  const [files, setFiles] = useState({f1:null,f2:null,f3:null,f4:null});
  const setF = k => d => setFiles(f=>({...f,[k]:d}));

  const allRows = useMemo(() => [files.f1,files.f2,files.f3,files.f4].filter(Boolean).flatMap(f=>f.rows), [files]);
  const lqk = useMemo(() => allRows.length ? Object.keys(allRows[0]).find(k=>k.toLowerCase().includes('leadquelle')||k.toLowerCase()==='quelle') : null, [allRows]);
  const enpalRows = useMemo(() => lqk ? allRows.filter(r=>(r[lqk]||'').toLowerCase().includes('enpal')) : allRows, [allRows,lqk]);
  const fc = [files.f1,files.f2,files.f3,files.f4].filter(Boolean).length;

  return (
    <div style={{minHeight:'100vh',background:DK}}>
      <div style={{background:C1,borderBottom:'1px solid '+BD,padding:'0 24px'}}>
        <div style={{maxWidth:1200,margin:'0 auto',display:'flex',alignItems:'center',justifyContent:'space-between',height:56}}>
          <div style={{display:'flex',alignItems:'center',gap:12}}>
            <a href="./" style={{color:DM,textDecoration:'none',fontSize:12,border:'1px solid '+BD,borderRadius:8,padding:'4px 10px'}}>‚Üê Launcher</a>
            <span style={{fontWeight:800,fontSize:18}}>bee<span style={{color:Y}}>¬∑</span>doo</span>
            <span style={{background:'rgba(253,225,84,.15)',color:Y,fontSize:11,fontWeight:700,padding:'3px 10px',borderRadius:20}}>ENPAL BOARD</span>
            <span style={{fontSize:11,color:DM,background:C2,padding:'2px 8px',borderRadius:6}}>Intern</span>
          </div>
          {fc>0 && <span style={{fontSize:12,color:GN}}>‚úì {fc} CSV{fc>1?'s':''} ¬∑ {allRows.length} Zeilen ¬∑ {enpalRows.length} Enpal</span>}
        </div>
      </div>

      <div style={{maxWidth:1200,margin:'0 auto',padding:24}}>
        <div style={{background:C1,border:'1px solid '+BD,borderRadius:12,padding:24,marginBottom:24}}>
          <div style={{fontSize:15,fontWeight:700,marginBottom:4}}>üìÇ T√§glicher CSV-Upload</div>
          <div style={{fontSize:12,color:DM,marginBottom:16}}>Morgen-Export aus Leveto laden ‚Üí Board pr√ºfen ‚Üí Speichern ‚Üí Extern-Board aktuell</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:12}}>
            <DropZone label="Tabelle 1 ¬∑ Terminauswertung" file={files.f1} onFile={setF('f1')} color={Y} />
            <DropZone label="Tabelle 2 ¬∑ Auftr√§ge" file={files.f2} onFile={setF('f2')} color={GN} />
            <DropZone label="Tabelle 3 ¬∑ Stornos / Leads" file={files.f3} onFile={setF('f3')} color={BL} />
            <DropZone label="Tabelle 4 ¬∑ Weitere CSV" file={files.f4} onFile={setF('f4')} color={PP} />
          </div>
          {allRows.length > 0 && (
            <button onClick={()=>setFiles({f1:null,f2:null,f3:null,f4:null})} style={{marginTop:12,background:'transparent',border:'1px solid '+BD,borderRadius:8,color:DM,padding:'6px 12px',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>
              üóë Reset
            </button>
          )}
        </div>

        {!allRows.length ? (
          <div style={{textAlign:'center',padding:'80px 24px',color:DM}}>
            <div style={{fontSize:48,marginBottom:16}}>‚ö°</div>
            <div style={{fontSize:18,fontWeight:700,color:TX,marginBottom:8}}>Enpal Lead Board ‚Äî Intern</div>
            <div style={{fontSize:14}}>CSVs hochladen ‚Üí Board analysiert ‚Üí Speichern ‚Üí Externes Board f√ºr Enpal aktuell</div>
          </div>
        ) : (
          <Board enpalRows={enpalRows} allRows={allRows} />
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
