<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo Â· Strategische Karte NRW</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'DM Sans', system-ui, sans-serif; background:#0c1222; color:#e1e7ef; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');

nav { display:flex; align-items:center; gap:10px; padding:0 16px; height:50px; background:#0c1222; border-bottom:1px solid #1c2640; flex-shrink:0; }
.logo { font-size:17px; font-weight:700; color:#FDE154; }
.subtitle { font-size:12px; color:#5c6b8a; margin-left:4px; }
.tabs { display:flex; gap:3px; margin-left:12px; }
.tab { padding:5px 12px; border-radius:7px; font-size:12px; font-weight:500; cursor:pointer; border:none; background:transparent; color:#5c6b8a; }
.tab:hover { background:#1c2640; color:#e1e7ef; }
.tab.active { background:#1c2640; color:#FDE154; }
.stats { margin-left:auto; display:flex; gap:8px; }
.stat { background:#151d30; padding:3px 10px; border-radius:6px; font-size:11px; color:#5c6b8a; }
.stat b { color:#FDE154; }

#map { flex:1; }
/* Leaflet dark tiles */
.leaflet-tile { filter: brightness(0.5) invert(1) contrast(2) hue-rotate(200deg) saturate(0.4) brightness(0.7); }

/* Layers panel */
#layers { position:absolute; top:58px; left:10px; z-index:1000; background:#0f1320ee; border:1px solid #1c2640; border-radius:10px; padding:12px; min-width:190px; }
.ly-title { font-size:10px; color:#5c6b8a; font-weight:600; text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; }
.ly-row { display:flex; align-items:center; gap:8px; padding:3px 0; cursor:pointer; font-size:12px; }
.ly-row input { accent-color:#FDE154; cursor:pointer; }
.ly-dot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }
.ly-n { margin-left:auto; font-size:10px; color:#5c6b8a; background:#151d30; padding:1px 6px; border-radius:4px; }

/* Detail panel */
#detail { position:absolute; top:58px; right:10px; z-index:1000; width:300px; background:#0f1320ee; border:1px solid #1c2640; border-radius:10px; padding:14px; display:none; backdrop-filter:blur(4px); }
#detail h3 { font-size:14px; font-weight:700; color:#FDE154; margin-bottom:10px; }
.d-row { display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #1c264030; font-size:12px; }
.d-row:last-child { border:none; }
.d-key { color:#5c6b8a; }
.kpis { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:10px; }
.kpi { background:#151d30; border-radius:7px; padding:8px; text-align:center; }
.kpi .v { font-size:18px; font-weight:700; color:#FDE154; }
.kpi .l { font-size:10px; color:#5c6b8a; margin-top:1px; }
.close { position:absolute; top:10px; right:12px; background:none; border:none; color:#5c6b8a; cursor:pointer; font-size:16px; }
.close:hover { color:#e1e7ef; }
.gap-box { background:#1a0f0f; border:1px solid #ef444440; border-radius:7px; padding:10px; margin-top:8px; font-size:12px; }
.gap-box .gh { color:#ef4444; font-weight:600; margin-bottom:6px; font-size:12px; }
.rec-box { background:#0f1a0f; border:1px solid #fde15430; border-radius:7px; padding:10px; margin-top:6px; font-size:12px; }
.rec-box .rh { color:#FDE154; font-weight:600; margin-bottom:6px; font-size:12px; }

/* ROI panel */
#roi { position:absolute; top:58px; left:210px; z-index:1000; width:340px; background:#0f1320ee; border:1px solid #1c2640; border-radius:10px; padding:14px; display:none; backdrop-filter:blur(4px); }
#roi h3 { font-size:14px; font-weight:700; color:#FDE154; margin-bottom:12px; }
.sl-row { margin-bottom:10px; }
.sl-row label { display:flex; justify-content:space-between; font-size:11px; color:#5c6b8a; margin-bottom:3px; }
.sl-row label span { color:#FDE154; font-weight:600; }
input[type=range] { width:100%; accent-color:#FDE154; }
.roi-sel { width:100%; background:#151d30; border:1px solid #263354; color:#e1e7ef; border-radius:7px; padding:5px 8px; font-size:12px; margin-bottom:10px; }
.roi-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.roi-item { background:#151d30; border-radius:7px; padding:8px; text-align:center; }
.roi-item .rv { font-size:15px; font-weight:700; }
.roi-item .rl { font-size:10px; color:#5c6b8a; margin-top:2px; }
.roi-winner { grid-column:1/-1; border-radius:7px; padding:8px; text-align:center; font-size:12px; font-weight:600; margin-top:2px; }
.w-lead { background:rgba(34,197,94,.12); color:#22c55e; border:1px solid rgba(34,197,94,.25); }
.w-scout { background:rgba(253,225,84,.12); color:#FDE154; border:1px solid rgba(253,225,84,.25); }

/* Alerts */
#alerts { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); z-index:1000; display:flex; gap:6px; flex-wrap:wrap; justify-content:center; pointer-events:none; }
.alert { background:#1a0f10ee; border:1px solid #ef444460; border-radius:7px; padding:5px 12px; font-size:11px; cursor:pointer; pointer-events:all; white-space:nowrap; }
.alert:hover { background:#2a1418; }

/* Legend */
#legend { position:absolute; bottom:50px; left:10px; z-index:1000; background:#0f1320ee; border:1px solid #1c2640; border-radius:8px; padding:10px 12px; font-size:11px; }
.leg-row { display:flex; align-items:center; gap:7px; padding:2px 0; color:#5c6b8a; }
.leg-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.leg-sq { width:10px; height:6px; border-radius:2px; flex-shrink:0; opacity:.5; }
</style>
</head>
<body>

<nav>
  <div class="logo">ğŸ bee-doo</div>
  <div class="subtitle">Strategische Karte Â· NRW Demo</div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('overview')">Ãœbersicht</button>
    <button class="tab" onclick="switchTab('gaps')">âš  LÃ¼cken</button>
    <button class="tab" onclick="switchTab('roi')">ROI Rechner</button>
    <button class="tab" onclick="switchTab('heatmap')">Heatmap</button>
  </div>
  <div class="stats">
    <div class="stat">VB: <b id="n-vb">â€”</b></div>
    <div class="stat">Scouter: <b id="n-sc">â€”</b></div>
    <div class="stat">Qualif.: <b id="n-qu">â€”</b></div>
    <div class="stat">LÃ¼cken: <b id="n-gap" style="color:#ef4444">â€”</b></div>
  </div>
</nav>

<div id="map"></div>

<div id="layers">
  <div class="ly-title">Layer</div>
  <label class="ly-row"><input type="checkbox" id="l-vb" checked onchange="toggleLayer('vb')"><div class="ly-dot" style="background:#FDE154"></div>Vertriebler<span class="ly-n" id="ln-vb"></span></label>
  <label class="ly-row"><input type="checkbox" id="l-sc" checked onchange="toggleLayer('sc')"><div class="ly-dot" style="background:#22c55e"></div>Scouter<span class="ly-n" id="ln-sc"></span></label>
  <label class="ly-row"><input type="checkbox" id="l-qu" checked onchange="toggleLayer('qu')"><div class="ly-dot" style="background:#60a5fa"></div>Qualifizierungen<span class="ly-n" id="ln-qu"></span></label>
  <label class="ly-row"><input type="checkbox" id="l-inf" onchange="toggleLayer('inf')"><div class="ly-dot" style="background:#f97316"></div>infas360 Potenzial<span class="ly-n" id="ln-inf"></span></label>
  <label class="ly-row"><input type="checkbox" id="l-gap" checked onchange="toggleLayer('gap')"><div class="ly-dot" style="background:#ef4444"></div>LÃ¼cken<span class="ly-n" id="ln-gap"></span></label>
</div>

<div id="detail">
  <button class="close" onclick="document.getElementById('detail').style.display='none'">âœ•</button>
  <div id="detail-body"></div>
</div>

<div id="roi">
  <h3>ğŸ’° ROI Rechner</h3>
  <div class="sl-row">
    <label>Termine/Monat <span id="rv-t">20</span></label>
    <input type="range" min="5" max="60" value="20" id="r-t" oninput="calcROI()">
  </div>
  <div class="sl-row">
    <label>Zeitraum (Monate) <span id="rv-m">12</span></label>
    <input type="range" min="3" max="24" value="12" id="r-m" oninput="calcROI()">
  </div>
  <select class="roi-sel" id="r-q" onchange="calcROI()">
    <option value="29.9:0.18">Fenerum (â‚¬29,90/Lead Â· 18% Conv.)</option>
    <option value="24.5:0.14">Verivox (â‚¬24,50/Lead Â· 14% Conv.)</option>
    <option value="19.9:0.12">Check24 (â‚¬19,90/Lead Â· 12% Conv.)</option>
    <option value="149:1.0">SolarMarkt (â‚¬149/Termin direkt)</option>
    <option value="34.9:0.20">Enpal Leads (â‚¬34,90/Lead Â· 20% Conv.)</option>
    <option value="27.5:0.17">SolardachbÃ¶rse (â‚¬27,50/Lead Â· 17% Conv.)</option>
  </select>
  <div class="roi-grid" id="roi-result"></div>
</div>

<div id="alerts"></div>

<div id="legend">
  <div class="leg-row"><div class="leg-dot" style="background:#FDE154"></div>Vertriebler (80km Radius)</div>
  <div class="leg-row"><div class="leg-dot" style="background:#22c55e"></div>Scouter (30km Gebiet)</div>
  <div class="leg-row"><div class="leg-dot" style="background:#60a5fa"></div>Qualifizierungen</div>
  <div class="leg-row"><div class="leg-dot" style="background:#f97316"></div>infas360 Potenzial</div>
  <div class="leg-row"><div class="leg-dot" style="background:#ef4444; opacity:.6"></div>AbdeckungslÃ¼cke</div>
</div>

<script>
// â”€â”€â”€ TEST DATA NRW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VB = [
  {id:1, name:'Thomas MÃ¼ller', ort:'Bielefeld', funktion:'HGB haupt', lat:52.02, lng:8.53, radius:80},
  {id:2, name:'Stefan Becker', ort:'Dortmund', funktion:'angestellt', lat:51.51, lng:7.46, radius:80},
  {id:3, name:'Anna Fischer', ort:'KÃ¶ln', funktion:'HGB haupt', lat:50.94, lng:6.96, radius:80},
  {id:4, name:'Michael Wagner', ort:'DÃ¼sseldorf', funktion:'angestellt', lat:51.22, lng:6.78, radius:80},
  {id:5, name:'Julia Schneider', ort:'MÃ¼nster', funktion:'HGB haupt', lat:51.96, lng:7.63, radius:80},
  {id:6, name:'Markus Schmidt', ort:'Aachen', funktion:'angestellt', lat:50.78, lng:6.08, radius:80},
  {id:7, name:'Sabine Koch', ort:'Paderborn', funktion:'HGB haupt', lat:51.72, lng:8.75, radius:80},
  {id:8, name:'Klaus Weber', ort:'Bochum', funktion:'angestellt', lat:51.48, lng:7.22, radius:80},
  {id:9, name:'Laura Zimmermann', ort:'Siegen', funktion:'HGB haupt', lat:50.88, lng:8.02, radius:80},
  {id:10, name:'Peter Hoffmann', ort:'Bonn', funktion:'angestellt', lat:50.73, lng:7.10, radius:80},
];

const SCOUTER = [
  {id:1, name:'Jan Richter', ort:'Bielefeld', lat:52.03, lng:8.55},
  {id:2, name:'Mia Braun', ort:'Dortmund', lat:51.52, lng:7.48},
  {id:3, name:'Finn Hartmann', ort:'KÃ¶ln', lat:50.92, lng:6.98},
  {id:4, name:'Lena Schulz', ort:'MÃ¼nster', lat:51.97, lng:7.65},
  // deliberately missing coverage for DÃ¼sseldorf, Aachen, Siegen, Bonn
];

// 120 fake qualifizierungen scattered around NRW
const QUALIF = [];
const statusPool = ['qualified','qualified','unsuitable','revisit','open'];
for(let i=0;i<120;i++){
  const base = VB[i%VB.length];
  QUALIF.push({
    id:i, lat: base.lat + (Math.sin(i*7.3)*0.4), lng: base.lng + (Math.cos(i*5.1)*0.5),
    status: statusPool[i%5], scouter_id: SCOUTER[i%SCOUTER.length].id
  });
}

// infas360 sample points NRW (random within rough NRW bbox)
const INFAS = [];
for(let i=0;i<800;i++){
  INFAS.push({
    lat: 50.3 + Math.random()*1.9,
    lng: 6.0 + Math.random()*2.5
  });
}

// â”€â”€â”€ MAP INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', {zoomControl:false}).setView([51.5, 7.5], 8);
L.control.zoom({position:'bottomright'}).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'Â© OpenStreetMap',
  maxZoom:18
}).addTo(map);

// Layer groups
const layers = { vb:L.layerGroup(), sc:L.layerGroup(), qu:L.layerGroup(), inf:L.layerGroup(), gap:L.layerGroup() };
layers.vb.addTo(map); layers.sc.addTo(map); layers.qu.addTo(map); layers.gap.addTo(map);

// â”€â”€â”€ HAVERSINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dist(a,b){
  const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLng=(b.lng-a.lng)*Math.PI/180;
  const s=Math.sin(dLat/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}

// â”€â”€â”€ RENDER VB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const gaps = [];
VB.forEach(vb => {
  const nearbyScouts = SCOUTER.filter(s => dist(vb,s) < 48);
  const isGap = nearbyScouts.length === 0;
  if(isGap) gaps.push(vb);

  // Radius circle
  L.circle([vb.lat, vb.lng], {
    radius: vb.radius * 1000,
    color: '#FDE154', fillColor: '#FDE154',
    fillOpacity: 0.04, weight: 1, opacity: 0.2
  }).addTo(layers.vb);

  // Marker
  const icon = L.divIcon({
    html:`<div style="width:14px;height:14px;background:#FDE154;border-radius:50%;border:2px solid #0c1222;box-shadow:0 0 6px #FDE15460"></div>`,
    iconSize:[14,14], iconAnchor:[7,7], className:''
  });
  L.marker([vb.lat, vb.lng], {icon}).addTo(layers.vb)
    .bindTooltip(vb.name + '<br>' + vb.ort, {className:'dark-tip'})
    .on('click', () => showVBDetail(vb, nearbyScouts));
});

// â”€â”€â”€ RENDER SCOUTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SCOUTER.forEach(sc => {
  L.circle([sc.lat, sc.lng], {
    radius: 30000,
    color:'#22c55e', fillColor:'#22c55e',
    fillOpacity:0.07, weight:1.5, opacity:0.3
  }).addTo(layers.sc);

  const icon = L.divIcon({
    html:`<div style="width:11px;height:11px;background:#22c55e;border-radius:50%;border:2px solid #0c1222;box-shadow:0 0 5px #22c55e60"></div>`,
    iconSize:[11,11], iconAnchor:[5.5,5.5], className:''
  });
  L.marker([sc.lat, sc.lng], {icon}).addTo(layers.sc)
    .bindTooltip('ğŸ” '+sc.name+'<br>'+sc.ort, {className:'dark-tip'})
    .on('click', () => showSCDetail(sc));
});

// â”€â”€â”€ RENDER QUALIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const qColors = {qualified:'#22c55e', unsuitable:'#ef4444', revisit:'#f59e0b', open:'#60a5fa'};
QUALIF.forEach(q => {
  const icon = L.divIcon({
    html:`<div style="width:7px;height:7px;background:${qColors[q.status]||'#60a5fa'};border-radius:50%;opacity:.8"></div>`,
    iconSize:[7,7], iconAnchor:[3.5,3.5], className:''
  });
  L.marker([q.lat, q.lng], {icon, zIndexOffset:-100}).addTo(layers.qu);
});

// â”€â”€â”€ RENDER INFAS360 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INFAS.forEach(a => {
  const icon = L.divIcon({
    html:`<div style="width:4px;height:4px;background:#f97316;border-radius:50%;opacity:.4"></div>`,
    iconSize:[4,4], iconAnchor:[2,2], className:''
  });
  L.marker([a.lat, a.lng], {icon, zIndexOffset:-200}).addTo(layers.inf);
});

// â”€â”€â”€ RENDER GAPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gaps.forEach(vb => {
  L.circle([vb.lat, vb.lng], {
    radius: 50000,
    color:'#ef4444', fillColor:'#ef4444',
    fillOpacity:0.08, weight:2, opacity:0.5,
    dashArray:'8,6'
  }).addTo(layers.gap).on('click', () => showGapDetail(vb));
});

// â”€â”€â”€ UPDATE COUNTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('n-vb').textContent = VB.length;
document.getElementById('n-sc').textContent = SCOUTER.length;
document.getElementById('n-qu').textContent = QUALIF.length;
document.getElementById('n-gap').textContent = gaps.length;
document.getElementById('ln-vb').textContent = VB.length;
document.getElementById('ln-sc').textContent = SCOUTER.length;
document.getElementById('ln-qu').textContent = QUALIF.length;
document.getElementById('ln-inf').textContent = INFAS.length+' (Demo)';
document.getElementById('ln-gap').textContent = gaps.length;

// â”€â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const alertsEl = document.getElementById('alerts');
gaps.slice(0,3).forEach(vb => {
  const a = document.createElement('div');
  a.className = 'alert';
  a.innerHTML = `âš  <b>${vb.name}</b> (${vb.ort}) â€” kein Scouter in 48km`;
  a.onclick = () => { map.setView([vb.lat, vb.lng], 10); showGapDetail(vb); };
  alertsEl.appendChild(a);
});

// â”€â”€â”€ DETAIL PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showVBDetail(vb, scouts) {
  const nearQu = QUALIF.filter(q => dist(vb, q) < vb.radius);
  const qualified = nearQu.filter(q => q.status === 'qualified').length;
  const isGap = scouts.length === 0;

  document.getElementById('detail-body').innerHTML = `
    <h3>ğŸ‘¤ ${vb.name}</h3>
    <div class="kpis">
      <div class="kpi"><div class="v">${nearQu.length}</div><div class="l">Qualif. im Gebiet</div></div>
      <div class="kpi"><div class="v">${qualified}</div><div class="l">Davon qualifiziert</div></div>
      <div class="kpi"><div class="v">${scouts.length}</div><div class="l">Scouter im Radius</div></div>
      <div class="kpi"><div class="v">${nearQu.length?Math.round(qualified/nearQu.length*100):0}%</div><div class="l">Conversion</div></div>
    </div>
    <div class="d-row"><span class="d-key">Funktion</span><span>${vb.funktion}</span></div>
    <div class="d-row"><span class="d-key">Standort</span><span>${vb.ort}</span></div>
    <div class="d-row"><span class="d-key">Aktionsradius</span><span>${vb.radius} km</span></div>
    ${isGap ? `<div class="gap-box"><div class="gh">âš  AbdeckungslÃ¼cke</div>Kein Scouter innerhalb 48km. Empfehlung: Online-Leads kaufen oder Scouter in ${vb.ort} rekrutieren.</div>` : ''}
  `;
  document.getElementById('detail').style.display = 'block';
}

function showSCDetail(sc) {
  const nearQu = QUALIF.filter(q => q.scouter_id === sc.id);
  const qualified = nearQu.filter(q => q.status === 'qualified').length;
  document.getElementById('detail-body').innerHTML = `
    <h3>ğŸ” ${sc.name}</h3>
    <div class="kpis">
      <div class="kpi"><div class="v">${nearQu.length}</div><div class="l">Besuche</div></div>
      <div class="kpi"><div class="v">${nearQu.length?Math.round(qualified/nearQu.length*100):0}%</div><div class="l">Conversion</div></div>
    </div>
    <div class="d-row"><span class="d-key">Standort</span><span>${sc.ort}</span></div>
    <div class="d-row"><span class="d-key">Qualifiziert</span><span style="color:#22c55e">${qualified}</span></div>
    <div class="d-row"><span class="d-key">Ungeeignet</span><span style="color:#ef4444">${nearQu.filter(q=>q.status==='unsuitable').length}</span></div>
    <div class="d-row"><span class="d-key">Revisit</span><span style="color:#f59e0b">${nearQu.filter(q=>q.status==='revisit').length}</span></div>
  `;
  document.getElementById('detail').style.display = 'block';
}

function showGapDetail(vb) {
  const costPerTermin = Math.round(29.9/0.18);
  const monthly30 = costPerTermin * 30;
  const be = Math.ceil((3200+2500)/(monthly30-3200));
  document.getElementById('detail-body').innerHTML = `
    <h3>âš  AbdeckungslÃ¼cke</h3>
    <div class="d-row"><span class="d-key">Vertriebler</span><span>${vb.name}</span></div>
    <div class="d-row"><span class="d-key">Region</span><span>${vb.ort}</span></div>
    <div class="d-row"><span class="d-key">Scouter in 48km</span><span style="color:#ef4444">0</span></div>
    <div class="gap-box">
      <div class="gh">ğŸ“¦ Option 1: Online-Leads kaufen</div>
      <div class="d-row"><span class="d-key">Quelle</span><span>Fenerum</span></div>
      <div class="d-row"><span class="d-key">â‚¬/Termin (eff.)</span><span>â‚¬${costPerTermin}</span></div>
      <div class="d-row"><span class="d-key">30 Termine/Mo</span><span>â‚¬${monthly30.toLocaleString('de')}</span></div>
    </div>
    <div class="rec-box">
      <div class="rh">ğŸ™‹ Option 2: Scouter einstellen</div>
      <div class="d-row"><span class="d-key">Fixkosten/Mo</span><span>â‚¬3.200</span></div>
      <div class="d-row"><span class="d-key">Onboarding</span><span>â‚¬2.500</span></div>
      <div class="d-row"><span class="d-key">Break-even</span><span>${be} Monate</span></div>
    </div>
  `;
  document.getElementById('detail').style.display = 'block';
  map.setView([vb.lat, vb.lng], 10);
}

// â”€â”€â”€ TOGGLE LAYERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleLayer(type) {
  const show = document.getElementById('l-'+type).checked;
  if(show) layers[type].addTo(map); else map.removeLayer(layers[type]);
}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',['overview','gaps','roi','heatmap'][i]===tab));
  document.getElementById('roi').style.display = tab==='roi' ? 'block' : 'none';

  if(tab==='gaps') {
    if(gaps.length>0) map.setView([gaps[0].lat, gaps[0].lng], 9);
    document.getElementById('l-gap').checked=true; toggleLayer('gap');
  }
  if(tab==='heatmap') {
    document.getElementById('l-inf').checked=true; toggleLayer('inf');
    document.getElementById('l-qu').checked=true; toggleLayer('qu');
  }
  if(tab==='overview') {
    map.setView([51.5,7.5],8);
  }
}

// â”€â”€â”€ ROI RECHNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcROI() {
  const t = parseInt(document.getElementById('r-t').value);
  const m = parseInt(document.getElementById('r-m').value);
  document.getElementById('rv-t').textContent = t;
  document.getElementById('rv-m').textContent = m;
  const [preis,conv] = document.getElementById('r-q').value.split(':').map(Number);
  const leadsProMo = Math.ceil(t/conv);
  const leadMo = Math.round(leadsProMo*preis);
  const leadGes = leadMo*m;
  const scoutGes = 3200*m+2500;
  const diff = Math.abs(scoutGes-leadGes);
  const winner = leadGes < scoutGes ? 'lead' : 'scout';
  const be = (leadMo>3200) ? Math.ceil(5700/(leadMo-3200)) : null;

  document.getElementById('roi-result').innerHTML=`
    <div class="roi-item"><div class="rv" style="color:#f97316">â‚¬${leadMo.toLocaleString('de')}</div><div class="rl">Leads/Monat</div></div>
    <div class="roi-item"><div class="rv" style="color:#f97316">â‚¬${leadGes.toLocaleString('de')}</div><div class="rl">Leads ${m} Mo.</div></div>
    <div class="roi-item"><div class="rv" style="color:#FDE154">â‚¬3.200</div><div class="rl">Scout Fix/Mo.</div></div>
    <div class="roi-item"><div class="rv" style="color:#FDE154">â‚¬${scoutGes.toLocaleString('de')}</div><div class="rl">Scout ${m} Mo.</div></div>
    <div class="roi-winner ${winner==='lead'?'w-lead':'w-scout'}">
      ${winner==='lead'?'ğŸ“¦ Leads gÃ¼nstiger':'ğŸ™‹ Scout gÃ¼nstiger'} um â‚¬${diff.toLocaleString('de')}
      ${be&&be>0&&be<=24?' Â· Scout lohnt sich nach '+be+' Monaten':''}
    </div>
  `;
}
calcROI();

// Leaflet tooltip dark style
const style = document.createElement('style');
style.textContent='.dark-tip{background:#151d30!important;border:1px solid #263354!important;color:#e1e7ef!important;font-size:11px!important;}.dark-tip.leaflet-tooltip-top::before{border-top-color:#263354!important}';
document.head.appendChild(style);
</script>
</body>
</html>
