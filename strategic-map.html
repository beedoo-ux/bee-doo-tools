<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>bee-doo Â· Strategische Karte</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#07080d;--s1:#0d0e1a;--s2:#11121f;--b1:#181926;--b2:#20212e;--tx:#e4e5f0;--mu:#3d3e52;--mu2:#6b6c82;--acc:#FF5C35;--green:#22c55e;--yellow:#f59e0b;--red:#ef4444;--blue:#3b82f6;--purple:#8b5cf6;--teal:#14b8a6}
html,body,#root{height:100%;width:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx)}
#map-container{position:fixed;inset:0;z-index:0}
#gmap{width:100%;height:100%}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--b2)}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.mono{font-family:'Space Mono',monospace}
.pl{position:fixed;top:0;left:0;bottom:0;width:268px;background:rgba(7,8,13,.96);border-right:1px solid var(--b1);backdrop-filter:blur(20px);z-index:100;display:flex;flex-direction:column;overflow:hidden}
.logo{padding:13px 15px 11px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:9px;flex-shrink:0}
.logo-ic{width:30px;height:30px;background:linear-gradient(135deg,#FF5C35,#ff9900);border-radius:7px;display:grid;place-items:center;font-size:15px}
.logo-n{font-size:13px;font-weight:700}.logo-s{font-size:9px;color:var(--mu2);letter-spacing:2px;text-transform:uppercase}
.modes{display:flex;gap:3px;padding:9px 11px;border-bottom:1px solid var(--b1);flex-shrink:0}
.mode{flex:1;padding:5px 2px;border-radius:6px;border:1px solid var(--b1);background:transparent;color:var(--mu2);font-size:10px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;text-align:center}
.mode.on{background:rgba(255,92,53,.1);border-color:rgba(255,92,53,.3);color:var(--acc)}
.layers{padding:9px 11px;border-bottom:1px solid var(--b1);flex-shrink:0}
.lr{display:flex;align-items:center;gap:7px;padding:4px 6px;border-radius:6px;cursor:pointer;transition:background .1s;margin-bottom:1px}
.lr:hover{background:rgba(255,255,255,.03)}
.ld{width:8px;height:8px;border-radius:2px;flex-shrink:0;transition:background .15s}
.ln{font-size:11px;font-weight:600;flex:1;transition:color .15s}
.lc{font-size:10px;color:var(--mu2);font-family:'Space Mono',monospace;font-size:9px}
.tog{width:24px;height:13px;border-radius:6px;background:var(--b2);position:relative;transition:background .2s;flex-shrink:0}
.tog::after{content:'';position:absolute;top:2px;left:2px;width:9px;height:9px;border-radius:50%;background:#fff;transition:transform .2s}
.tog.on::after{transform:translateX(11px)}
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:9px 11px;border-bottom:1px solid var(--b1);flex-shrink:0}
.kpi{background:var(--s1);border:1px solid var(--b1);border-radius:7px;padding:7px 8px}
.kv{font-size:17px;font-weight:700;font-family:'Space Mono',monospace;line-height:1;margin-bottom:1px}
.kl{font-size:9px;color:var(--mu2);text-transform:uppercase;letter-spacing:1px}
.pcont{flex:1;overflow-y:auto;padding:9px 11px}
.sec{font-size:9px;color:var(--mu2);text-transform:uppercase;letter-spacing:1.5px;font-weight:700;margin:10px 0 5px}
.card{background:var(--s1);border:1px solid var(--b1);border-radius:8px;padding:8px 10px;margin-bottom:4px;cursor:pointer;transition:all .12s}
.card:hover{border-color:var(--b2);background:var(--s2)}
.ct{font-size:11px;font-weight:700;margin-bottom:1px}.cs{font-size:10px;color:var(--mu2)}
.pill{display:inline-flex;align-items:center;padding:1px 5px;border-radius:7px;font-size:9px;font-weight:700}
.bar{height:3px;background:var(--b1);border-radius:2px;overflow:hidden;margin-top:4px}
.barf{height:100%;border-radius:2px;transition:width .6s}
.alert-box{border-radius:8px;padding:8px 10px;margin-bottom:4px;border:1px solid;cursor:pointer}
.rec{background:rgba(139,92,246,.05);border:1px solid rgba(139,92,246,.2);border-radius:8px;padding:8px 10px;margin-bottom:4px}
.rect{font-size:10px;color:#a78bfa;font-weight:700;margin-bottom:4px}
.krow{display:flex;justify-content:space-between;padding:2px 0;font-size:10px;border-bottom:1px solid var(--b1)}
.krow:last-child{border:none}
.krl{color:var(--mu2)}.krv{font-weight:700;font-family:'Space Mono',monospace}
.pr{position:fixed;top:0;right:0;bottom:0;width:290px;background:rgba(7,8,13,.96);border-left:1px solid var(--b1);backdrop-filter:blur(20px);z-index:100;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .22s ease}
.pr.open{transform:none}
.pr-h{padding:13px 15px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:8px;flex-shrink:0}
.pr-ico{width:34px;height:34px;border-radius:8px;display:grid;place-items:center;font-size:16px;flex-shrink:0}
.pr-c{flex:1;overflow-y:auto;padding:11px 14px}
.close{margin-left:auto;background:none;border:none;color:var(--mu2);font-size:16px;cursor:pointer;padding:3px;border-radius:4px;flex-shrink:0}
.close:hover{color:var(--tx)}
.bigkpi{background:var(--s1);border:1px solid var(--b1);border-radius:8px;padding:10px;text-align:center}
.bigv{font-size:26px;font-weight:700;font-family:'Space Mono',monospace;line-height:1}
.bigl{font-size:9px;color:var(--mu2);text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.dvd{height:1px;background:var(--b1);margin:9px 0}
.topbar{position:fixed;top:12px;left:280px;right:302px;z-index:90;display:flex;gap:5px;align-items:center;pointer-events:none}
.topbar>*{pointer-events:all}
.nbtn{background:rgba(7,8,13,.88);border:1px solid var(--b2);padding:5px 12px;border-radius:14px;font-size:10px;font-weight:700;color:var(--mu2);cursor:pointer;font-family:'DM Sans',sans-serif;backdrop-filter:blur(10px);transition:all .12s;letter-spacing:.3px;text-transform:uppercase;white-space:nowrap;text-decoration:none;display:inline-block}
.nbtn:hover{color:var(--tx)}
.tspc{flex:1}
.tinfo{font-size:10px;color:var(--mu);background:rgba(7,8,13,.7);padding:5px 10px;border-radius:10px;border:1px solid var(--b1);white-space:nowrap}
.alerts{position:fixed;bottom:14px;left:280px;right:302px;z-index:90;display:flex;gap:5px;flex-wrap:wrap;pointer-events:none}
.achip{background:rgba(7,8,13,.92);border-radius:7px;padding:6px 10px;font-size:10px;display:flex;align-items:center;gap:5px;backdrop-filter:blur(10px);border:1px solid;animation:fadeUp .25s;pointer-events:all;cursor:pointer}
.loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:999;background:var(--bg)}
.spinner{width:22px;height:22px;border:2px solid var(--b2);border-top-color:var(--acc);border-radius:50%;animation:spin 1s linear infinite}
.ltxt{font-size:12px;color:var(--mu2);text-align:center}.lsub{font-size:10px;color:var(--mu);margin-top:2px}
.roi{background:var(--s1);border:1px solid var(--b1);border-radius:8px;padding:11px;margin-bottom:6px}
.roi-t{font-size:10px;font-weight:700;color:#ff9900;margin-bottom:7px}
.roi-r{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--b1);font-size:10px}
.roi-r:last-child{border:none}
.win{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.2);border-radius:6px;padding:6px 8px;margin-top:5px;font-size:10px;color:#22c55e;font-weight:600}
.infas-banner{background:rgba(20,184,166,.07);border:1px solid rgba(20,184,166,.25);border-radius:8px;padding:9px 11px;margin-bottom:7px}
.infas-num{font-size:22px;font-weight:700;font-family:'Space Mono',monospace;color:var(--teal);line-height:1;margin-bottom:2px}
.infas-sub{font-size:10px;color:var(--mu2)}
input[type=range]{width:100%;accent-color:var(--acc);margin:3px 0}
select{width:100%;background:var(--b1);border:1px solid var(--b2);border-radius:5px;color:var(--tx);padding:4px 7px;font-size:11px;font-family:'DM Sans',sans-serif}
</style>
</head>
<body>
<div id="root"></div>
<div id="map-container"><div id="gmap"></div></div>
<script src="/config.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js" crossorigin></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js" crossorigin></script>
<script>
// â”€â”€ WAIT FOR BOTH REACT LIBS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function waitReact(cb){
  if(window.React&&window.ReactDOM){cb();return;}
  setTimeout(()=>waitReact(cb),30);
}

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SVC=(window.BEEDOO_SVC||'').trim();
const SB=(window.BEEDOO_SB||'https://hqzpemfaljxcysyqssng.supabase.co').trim();
const GKEY=(window.BEEDOO_GKEY||'AIzaSyB6GngBnHzfITUnkOHsFKgO9SwmKbRvGA8').trim();

// â”€â”€ COORD TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PLZ2={'10':{lat:52.52,lng:13.40},'12':{lat:52.45,lng:13.43},'13':{lat:52.56,lng:13.35},'20':{lat:53.57,lng:9.98},'21':{lat:53.47,lng:9.98},'22':{lat:53.62,lng:10.00},'23':{lat:53.87,lng:10.70},'24':{lat:54.33,lng:10.13},'25':{lat:53.93,lng:9.53},'26':{lat:53.13,lng:8.21},'27':{lat:53.04,lng:8.79},'28':{lat:53.07,lng:8.81},'29':{lat:52.93,lng:10.50},'30':{lat:52.37,lng:9.74},'31':{lat:52.10,lng:9.36},'32':{lat:52.11,lng:8.67},'33':{lat:52.02,lng:8.53},'34':{lat:51.31,lng:9.50},'35':{lat:50.82,lng:8.77},'36':{lat:50.55,lng:9.68},'37':{lat:51.54,lng:9.93},'38':{lat:52.27,lng:10.52},'39':{lat:52.13,lng:11.62},'40':{lat:51.23,lng:6.78},'41':{lat:51.20,lng:6.45},'42':{lat:51.27,lng:7.20},'44':{lat:51.51,lng:7.46},'45':{lat:51.46,lng:7.01},'46':{lat:51.66,lng:6.62},'47':{lat:51.33,lng:6.57},'48':{lat:51.96,lng:7.63},'49':{lat:52.27,lng:8.05},'50':{lat:50.94,lng:6.96},'51':{lat:50.88,lng:7.13},'52':{lat:50.78,lng:6.09},'53':{lat:50.73,lng:7.10},'54':{lat:49.75,lng:6.64},'55':{lat:49.99,lng:8.27},'56':{lat:50.36,lng:7.59},'57':{lat:50.92,lng:8.02},'58':{lat:51.37,lng:7.66},'59':{lat:51.66,lng:7.83},'60':{lat:50.11,lng:8.68},'63':{lat:50.05,lng:8.90},'64':{lat:49.87,lng:8.65},'65':{lat:50.08,lng:8.24},'66':{lat:49.23,lng:7.00},'67':{lat:49.44,lng:8.10},'68':{lat:49.49,lng:8.47},'69':{lat:49.41,lng:8.69},'70':{lat:48.78,lng:9.18},'71':{lat:48.72,lng:9.22},'72':{lat:48.50,lng:9.21},'73':{lat:48.72,lng:9.72},'74':{lat:49.12,lng:9.21},'75':{lat:48.99,lng:8.50},'76':{lat:49.01,lng:8.40},'77':{lat:48.47,lng:8.00},'78':{lat:47.97,lng:8.48},'79':{lat:47.99,lng:7.85},'80':{lat:48.14,lng:11.58},'83':{lat:47.87,lng:12.10},'85':{lat:48.37,lng:11.74},'86':{lat:48.37,lng:10.88},'87':{lat:47.74,lng:10.32},'88':{lat:47.76,lng:9.62},'89':{lat:48.40,lng:10.00},'90':{lat:49.45,lng:11.08},'97':{lat:49.79,lng:9.93},'98':{lat:50.69,lng:10.92},'99':{lat:50.98,lng:11.03}};
const CITIES={'Bielefeld':{lat:52.02,lng:8.53},'Aachen':{lat:50.78,lng:6.09},'Berlin':{lat:52.52,lng:13.40},'Hamburg':{lat:53.55,lng:9.99},'MÃ¼nchen':{lat:48.14,lng:11.58},'KÃ¶ln':{lat:50.94,lng:6.96},'Dortmund':{lat:51.51,lng:7.46},'Bremen':{lat:53.07,lng:8.81},'Paderborn':{lat:51.72,lng:8.76},'Hannover':{lat:52.37,lng:9.74},'Stuttgart':{lat:48.78,lng:9.18},'Frankfurt':{lat:50.11,lng:8.68},'DÃ¼sseldorf':{lat:51.23,lng:6.78},'Leipzig':{lat:51.34,lng:12.38},'Dresden':{lat:51.05,lng:13.74},'NÃ¼rnberg':{lat:49.45,lng:11.08},'OsnabrÃ¼ck':{lat:52.28,lng:8.05},'MÃ¼nster':{lat:51.96,lng:7.63},'GÃ¼tersloh':{lat:51.91,lng:8.38},'Magdeburg':{lat:52.13,lng:11.62},'Oldenburg':{lat:53.14,lng:8.21},'Krefeld':{lat:51.33,lng:6.57},'SaarbrÃ¼cken':{lat:49.23,lng:7.00},'Herford':{lat:52.11,lng:8.67}};

function utm32toWGS(east,north){
  if(east>1000000)east-=32000000;
  const k0=.9996,a=6378137,e2=.00669438,lon0=Math.PI/20;
  const x=east-500000,e2p=e2/(1-e2);
  const M=north/k0,mu=M/(a*(1-e2/4-3*e2*e2/64));
  const e1=(1-Math.sqrt(1-e2))/(1+Math.sqrt(1-e2));
  const p1=mu+(1.5*e1-27*e1*e1*e1/32)*Math.sin(2*mu)+(21*e1*e1/16)*Math.sin(4*mu)+(151*e1*e1*e1/96)*Math.sin(6*mu);
  const N1=a/Math.sqrt(1-e2*Math.sin(p1)**2),T1=Math.tan(p1)**2,C1=e2p*Math.cos(p1)**2;
  const R1=a*(1-e2)/(1-e2*Math.sin(p1)**2)**1.5,D=x/(N1*k0);
  const lat=p1-(N1*Math.tan(p1)/R1)*(D*D/2-(5+3*T1+10*C1-4*C1**2-9*e2p)*D**4/24);
  const lon=lon0+(D-(1+2*T1+C1)*D**3/6)/Math.cos(p1);
  return{lat:lat*180/Math.PI,lng:lon*180/Math.PI};
}
function rnd(id,a,b){let h=0;for(const c of String(id)){h=((h<<5)-h)+c.charCodeAt(0);h|=0;}return a+(((h>>>0)/0xFFFFFFFF)*(b-a));}
function geocode(r){
  const ort=r.ort||r.einsatzort;
  if(ort&&CITIES[ort]){const c=CITIES[ort];return{lat:c.lat+rnd(r.id+'a',-.07,.07),lng:c.lng+rnd(r.id+'b',-.09,.09)};}
  if(r.plz&&r.plz.length>=2){const p=PLZ2[r.plz.slice(0,2)];if(p)return{lat:p.lat+rnd(r.id+'a',-.1,.1),lng:p.lng+rnd(r.id+'b',-.14,.14)};}
  return null;
}
function haversine(a,b){
  const R=6371,dL=(b.lat-a.lat)*Math.PI/180,dN=(b.lng-a.lng)*Math.PI/180;
  const x=Math.sin(dL/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dN/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

async function sbGet(t,q){
  const url=`${SB}/rest/v1/${t}${q?'?'+q:''}`;
  const r=await fetch(url,{headers:{apikey:SVC,Authorization:`Bearer ${SVC}`}});
  const txt=await r.text();
  try{return JSON.parse(txt);}catch{return[];}
}
async function sbCount(t){
  const r=await fetch(`${SB}/rest/v1/${t}?select=id&limit=1`,{headers:{apikey:SVC,Authorization:`Bearer ${SVC}`,'Prefer':'count=exact'}});
  const h=r.headers.get('content-range')||'';
  return parseInt(h.split('/')[1])||0;
}

const VCOLS=['#FF5C35','#ff9900','#22c55e','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f59e0b','#a78bfa','#84cc16','#f97316','#06b6d4'];
const SCOLS=['#4ECDC4','#45B7D1','#A78BFA','#34D399','#F59E0B','#F472B6','#60A5FA','#FF5C35'];
const LEADS=[{id:'l1',name:'Fenerum',typ:'lead',preis_lead:29.9,conv:.18,lat:49.45,lng:11.08,radius:200,score:85,info:'SÃ¼d/Mitte'},
  {id:'l2',name:'Verivox',typ:'lead',preis_lead:24.5,conv:.14,lat:51.23,lng:6.78,radius:300,score:72,info:'NRW/BW/BY'},
  {id:'l3',name:'Check24',typ:'lead',preis_lead:19.9,conv:.12,lat:51.16,lng:10.45,radius:600,score:65,info:'DE-weit'},
  {id:'l4',name:'SolarMarkt',typ:'termin',preis_termin:149,conv:1.0,lat:53.07,lng:8.81,radius:120,score:90,info:'Nord, Direkttermine'},
  {id:'l5',name:'Enpal Leads',typ:'lead',preis_lead:34.9,conv:.20,lat:52.52,lng:13.40,radius:150,score:88,info:'Berlin/BB'},
  {id:'l6',name:'SolardachbÃ¶rse',typ:'lead',preis_lead:27.5,conv:.17,lat:51.45,lng:7.01,radius:150,score:80,info:'Ruhrgebiet'},
  {id:'l7',name:'ImmobilienSolar',typ:'lead',preis_lead:22,conv:.16,lat:51.96,lng:7.63,radius:100,score:78,info:'MÃ¼nsterland'}];
function kpt(q){return q.typ==='termin'?q.preis_termin:+(q.preis_lead/q.conv).toFixed(0);}

const MSTYLE=[{featureType:'all',elementType:'geometry',stylers:[{color:'#0d0e18'}]},{featureType:'water',stylers:[{color:'#06070f'}]},{featureType:'road',elementType:'geometry',stylers:[{color:'#18192a'}]},{featureType:'road.arterial',elementType:'geometry',stylers:[{color:'#1e1f30'}]},{featureType:'road.highway',elementType:'geometry',stylers:[{color:'#252638'}]},{featureType:'road',elementType:'labels',stylers:[{visibility:'off'}]},{featureType:'administrative',elementType:'geometry.stroke',stylers:[{color:'#1c1d2e'}]},{featureType:'administrative.locality',elementType:'labels.text.fill',stylers:[{color:'#3a3b52'}]},{featureType:'administrative.locality',elementType:'labels',stylers:[{visibility:'simplified'}]},{featureType:'poi',stylers:[{visibility:'off'}]},{featureType:'transit',stylers:[{visibility:'off'}]},{featureType:'landscape',elementType:'geometry',stylers:[{color:'#0f1018'}]}];

waitReact(()=>{
const {useState,useEffect,useRef,useMemo}=React;
const E=React.createElement;

function App(){
  const mapRef=useRef(null);
  const objs=useRef({v:[],s:[],m:[],l:[],g:[],hQ:null,hI:null});
  const [loading,setLoading]=useState(true);
  const [step,setStep]=useState('Verbinde...');
  const [mit,setMit]=useState([]);
  const [quals,setQuals]=useState([]);
  const [gebiete,setGebiete]=useState([]);
  const [zuweisungen,setZuweisungen]=useState([]);
  const [appScouter,setAppScouter]=useState([]);
  const [infasSample,setInfasSample]=useState([]);
  const [infasCount,setInfasCount]=useState(0);
  const [layers,setLayers]=useState({vb:true,sc:true,mt:false,ld:false,heatmap:false,infas:false});
  const [mode,setMode]=useState('overview');
  const [sel,setSel]=useState(null);

  useEffect(()=>{
    // Load Google Maps
    if(!window.google){
      window.__mapReady=()=>initMap();
      const s=document.createElement('script');
      s.src=`https://maps.googleapis.com/maps/api/js?key=${GKEY}&libraries=visualization&callback=__mapReady`;
      document.head.appendChild(s);
    } else initMap();
    loadData();
  },[]);

  function initMap(){
    if(mapRef.current)return;
    mapRef.current=new google.maps.Map(document.getElementById('gmap'),{
      center:{lat:51.5,lng:10.0},zoom:6,
      mapTypeId:'roadmap',disableDefaultUI:true,zoomControl:true,styles:MSTYLE
    });
  }

  async function loadData(){
    try{
      setStep('Lade Mitarbeiter...');
      const [m,q,g,z,sc]=await Promise.all([
        sbGet('pay_mitarbeiter','select=id,vorname,nachname,typ,aktiv,ort,plz,einsatzort,grundgehalt&aktiv=eq.true&limit=500'),
        sbGet('qualifizierungen','select=scouter_id,status,lat,lng,created_at&limit=2000'),
        sbGet('gebiete','select=id,name,polygon'),
        sbGet('zuweisungen','select=scouter_id,gebiet_id&active=eq.true'),
        sbGet('scouter','select=id,vorname,nachname,email,aktiv&aktiv=eq.true'),
      ]);
      setStep('Lade infas360...');
      const [inf,cnt]=await Promise.all([
        sbGet('infas_adressen','select=id,utm32east,utm32north,plz,status&limit=8000&status=eq.open'),
        sbCount('infas_adressen'),
      ]);
      setMit(Array.isArray(m)?m:[]);
      setQuals(Array.isArray(q)?q:[]);
      setGebiete(Array.isArray(g)?g:[]);
      setZuweisungen(Array.isArray(z)?z:[]);
      setAppScouter(Array.isArray(sc)?sc:[]);
      setInfasCount(cnt);
      // Convert UTM32 â†’ WGS84
      const wgs=(Array.isArray(inf)?inf:[]).map(a=>{
        try{const c=utm32toWGS(a.utm32east,a.utm32north);return{...a,...c};}catch{return null;}
      }).filter(a=>a&&a.lat>47&&a.lat<55.5&&a.lng>5.5&&a.lng<15.5);
      setInfasSample(wgs);
    }catch(e){console.error('loadData error',e);}
    setLoading(false);
  }

  const vertriebler=useMemo(()=>mit.filter(m=>m.typ&&m.typ.includes('vertriebler'))
    .map((m,i)=>({...m,coords:geocode(m),color:VCOLS[i%VCOLS.length]})),[mit]);
  const scouter=useMemo(()=>mit.filter(m=>m.typ&&m.typ.includes('scouter'))
    .map((m,i)=>({...m,coords:geocode(m),color:SCOLS[i%SCOLS.length]})),[mit]);
  const montage=useMemo(()=>mit.filter(m=>m.typ&&m.typ.includes('montage'))
    .map(m=>({...m,coords:geocode(m),color:'#60a5fa'})),[mit]);

  const scoutStats=useMemo(()=>{
    const mp={};
    quals.forEach(q=>{if(!q.scouter_id)return;if(!mp[q.scouter_id])mp[q.scouter_id]={total:0,qualified:0,revisit:0,rejected:0};mp[q.scouter_id].total++;if(q.status==='qualified')mp[q.scouter_id].qualified++;else if(q.status==='revisit')mp[q.scouter_id].revisit++;else if(q.status==='rejected')mp[q.scouter_id].rejected++;});
    return mp;
  },[quals]);

  const gaps=useMemo(()=>vertriebler.filter(v=>{
    if(!v.coords)return false;
    return!scouter.filter(s=>s.coords).some(s=>haversine(v.coords,s.coords)<50);
  }),[vertriebler,scouter]);

  const gapRecs=useMemo(()=>gaps.map(v=>({
    v,leads:LEADS.filter(q=>haversine(v.coords,{lat:q.lat,lng:q.lng})<q.radius)
      .sort((a,b)=>b.score-a.score)
  })),[gaps]);

  // Render map objects whenever layers/mode change
  useEffect(()=>{
    if(loading||!mapRef.current)return;
    renderMap();
  },[loading,layers,mode,vertriebler,scouter,montage,quals,infasSample,gebiete,zuweisungen,appScouter]);

  function clr(k){(objs.current[k]||[]).forEach(o=>{try{o.setMap&&o.setMap(null);}catch{}});objs.current[k]=[];}
  function circle(lat,lng,km,col,fo=.06,so=.35,sw=1.5){
    return new google.maps.Circle({center:{lat,lng},radius:km*1000,strokeColor:col,strokeOpacity:so,strokeWeight:sw,fillColor:col,fillOpacity:fo,map:mapRef.current});
  }
  function marker(lat,lng,svg,sz,zi,onClick){
    const mk=new google.maps.Marker({position:{lat,lng},map:mapRef.current,zIndex:zi,
      icon:{url:`data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`,scaledSize:new google.maps.Size(sz,sz),anchor:new google.maps.Point(sz/2,sz/2)}});
    if(onClick)mk.addListener('click',onClick);
    return mk;
  }

  function renderMap(){
    const map=mapRef.current;if(!map)return;
    // Vertriebler
    clr('v');
    if(layers.vb){
      vertriebler.filter(v=>v.coords).forEach(v=>{
        objs.current.v.push(circle(v.coords.lat,v.coords.lng,80,v.color,.04,.25,1));
        const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='28' height='34'><circle cx='14' cy='13' r='11' fill='${v.color}bb' stroke='${v.color}' stroke-width='2'/><text x='14' y='17' font-family='Arial' font-size='7' font-weight='bold' fill='white' text-anchor='middle'>VB</text><polygon points='14,30 10,21 18,21' fill='${v.color}bb'/></svg>`;
        objs.current.v.push(marker(v.coords.lat,v.coords.lng,svg,28,20,()=>setSel({type:'vb',data:v})));
      });
    }
    // Scouter gebiete + markers
    clr('s');
    if(layers.sc){
      appScouter.forEach((sc,i)=>{
        const col=SCOLS[i%SCOLS.length];
        zuweisungen.filter(z=>z.scouter_id===sc.id).forEach(z=>{
          const g=gebiete.find(x=>x.id===z.gebiet_id);
          if(!g?.polygon)return;
          let pts;try{pts=JSON.parse(g.polygon);}catch{return;}
          objs.current.s.push(new google.maps.Polygon({paths:pts.map(([la,ln])=>({lat:la,lng:ln})),strokeColor:col,strokeWeight:1.5,fillColor:col,fillOpacity:.15,map}));
        });
      });
      scouter.filter(s=>s.coords).forEach((s,i)=>{
        const col=s.color,init=(s.vorname?.[0]||'')+(s.nachname?.[0]||'');
        const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='26' height='26'><circle cx='13' cy='13' r='11' fill='${col}bb' stroke='${col}' stroke-width='2'/><text x='13' y='17' font-family='Arial' font-size='8' font-weight='bold' fill='white' text-anchor='middle'>${init.toUpperCase()}</text></svg>`;
        objs.current.s.push(marker(s.coords.lat,s.coords.lng,svg,26,30,()=>setSel({type:'sc',data:s})));
      });
    }
    // Montage
    clr('m');
    if(layers.mt){
      montage.filter(m=>m.coords).forEach(m=>{
        objs.current.m.push(circle(m.coords.lat,m.coords.lng,60,m.color,.06,.4,1.5));
        const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'><rect x='2' y='2' width='20' height='20' rx='4' fill='rgba(96,165,250,.7)' stroke='#60a5fa' stroke-width='2'/><text x='12' y='16' font-size='12' text-anchor='middle' fill='white'>âš¡</text></svg>`;
        objs.current.m.push(marker(m.coords.lat,m.coords.lng,svg,24,15,()=>setSel({type:'mt',data:m})));
      });
    }
    // Leads
    clr('l');
    if(layers.ld){
      LEADS.forEach(q=>{
        objs.current.l.push(circle(q.lat,q.lng,q.radius,'#8b5cf6',.04,.3,1.5));
        const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'><circle cx='12' cy='12' r='10' fill='rgba(139,92,246,.75)' stroke='#8b5cf6' stroke-width='2'/><text x='12' y='16' font-family='Arial' font-size='11' font-weight='bold' fill='white' text-anchor='middle'>â‚¬</text></svg>`;
        objs.current.l.push(marker(q.lat,q.lng,svg,24,10,()=>setSel({type:'ld',data:q})));
      });
    }
    // Gap circles
    clr('g');
    if(mode==='gaps'){
      gaps.filter(v=>v.coords).forEach(v=>{
        objs.current.g.push(circle(v.coords.lat,v.coords.lng,80,'#ef4444',.08,.7,2));
      });
    }
    // Qualifizierungen heatmap
    if(objs.current.hQ){try{objs.current.hQ.setMap(null);}catch{}}
    objs.current.hQ=null;
    if(layers.heatmap&&window.google?.maps?.visualization){
      const pts=quals.filter(q=>q.lat&&q.lng).map(q=>({location:new google.maps.LatLng(q.lat,q.lng),weight:q.status==='qualified'?3:1}));
      if(pts.length)objs.current.hQ=new google.maps.visualization.HeatmapLayer({data:pts,map,radius:25,opacity:.75,gradient:['rgba(0,0,0,0)','rgba(59,130,246,.3)','rgba(34,197,94,.6)','rgba(245,158,11,.8)','rgba(239,68,68,1)']});
    }
    // infas360 heatmap
    if(objs.current.hI){try{objs.current.hI.setMap(null);}catch{}}
    objs.current.hI=null;
    if(layers.infas&&infasSample.length&&window.google?.maps?.visualization){
      const pts=infasSample.map(a=>new google.maps.LatLng(a.lat,a.lng));
      objs.current.hI=new google.maps.visualization.HeatmapLayer({data:pts,map,radius:8,opacity:.6,gradient:['rgba(0,0,0,0)','rgba(20,184,166,.2)','rgba(59,130,246,.5)','rgba(139,92,246,.8)','rgba(255,92,53,1)']});
    }
  }

  const tog=k=>setLayers(p=>({...p,[k]:!p[k]}));
  const panTo=(lat,lng,z=9)=>{mapRef.current?.panTo({lat,lng});mapRef.current?.setZoom(z);};

  const qualN=quals.filter(q=>q.status==='qualified').length;
  const convR=quals.length>0?(qualN/quals.length*100).toFixed(1):0;
  const vOk=vertriebler.filter(v=>v.coords).length;
  const sOk=scouter.filter(s=>s.coords).length;

  const LDEFS=[
    {k:'vb',col:'#FF5C35',lbl:'Vertriebler',n:`${vOk}/${vertriebler.length}`},
    {k:'sc',col:'#4ECDC4',lbl:'Scouter',n:`${sOk}/${scouter.length}`},
    {k:'mt',col:'#60a5fa',lbl:'Montage',n:montage.length},
    {k:'ld',col:'#8b5cf6',lbl:'Lead-Quellen',n:LEADS.length},
    {k:'heatmap',col:'#f59e0b',lbl:'Scout Heatmap',n:quals.length},
    {k:'infas',col:'#14b8a6',lbl:'infas360',n:infasCount>0?(infasCount/1000000).toFixed(1)+'M':'â€¦'},
  ];
  const MODES=[{m:'overview',l:'Karte'},{m:'gaps',l:'âš  LÃ¼cken'},{m:'roi',l:'ROI'},{m:'perf',l:'Perf.'}];

  if(loading)return E('div',{className:'loader'},
    E('div',{className:'spinner'}),
    E('div',null,E('div',{className:'ltxt'},'bee-doo Strategische Karte'),E('div',{className:'lsub'},step))
  );

  return E('div',null,
    // LEFT PANEL
    E('div',{className:'pl'},
      E('div',{className:'logo'},E('div',{className:'logo-ic'},'ðŸ'),E('div',null,E('div',{className:'logo-n'},'bee-doo'),E('div',{className:'logo-s'},'Strategie'))),
      E('div',{className:'modes'},...MODES.map(({m,l})=>E('button',{key:m,className:`mode${mode===m?' on':''}`,onClick:()=>setMode(m)},l))),
      E('div',{className:'layers'},...LDEFS.map(({k,col,lbl,n})=>E('div',{key:k,className:'lr',onClick:()=>tog(k)},
        E('div',{className:'ld',style:{background:layers[k]?col:'#2a2b3a',borderRadius:k==='ld'||k==='infas'?'50%':2}}),
        E('span',{className:'ln',style:{color:layers[k]?col:'#555'}},lbl),
        E('span',{className:'lc'},n),
        E('div',{className:`tog${layers[k]?' on':''}`,style:layers[k]?{background:col}:{}})
      ))),
      E('div',{className:'kpis'},
        E('div',{className:'kpi'},E('div',{className:'kv',style:{color:gaps.length?'#ef4444':'#22c55e'}},gaps.length),E('div',{className:'kl'},'LÃ¼cken')),
        E('div',{className:'kpi'},E('div',{className:'kv',style:{color:'#22c55e'}},qualN),E('div',{className:'kl'},'Termine')),
        E('div',{className:'kpi'},E('div',{className:'kv',style:{color:'#f59e0b'}},convR+'%'),E('div',{className:'kl'},'Conv.')),
        E('div',{className:'kpi'},E('div',{className:'kv',style:{color:'#14b8a6'}},scouter.length),E('div',{className:'kl'},'Scouter')),
      ),
      E('div',{className:'pcont'},
        mode==='overview'&&E(OvView,{vertriebler,scouter,gaps,infasCount,panTo,setSel}),
        mode==='gaps'&&E(GapsView,{gaps,gapRecs,panTo,setSel}),
        mode==='roi'&&E(ROIView,{}),
        mode==='perf'&&E(PerfView,{appScouter,scoutStats}),
      )
    ),
    // TOP BAR
    E('div',{className:'topbar'},
      E('a',{href:'/index.html',className:'nbtn'},'â† Ãœbersicht'),
      E('div',{className:'tspc'}),
      E('div',{className:'tinfo'},`${vertriebler.length} VB Â· ${scouter.length} SC Â· ${infasCount>0?(infasCount/1000000).toFixed(1)+'M Adressen':'ladenâ€¦'}`)
    ),
    // GAP ALERTS
    gaps.length>0&&E('div',{className:'alerts'},
      ...gaps.slice(0,3).filter(v=>v.coords).map(v=>E('div',{key:v.id,className:'achip',
        style:{borderColor:'rgba(239,68,68,.3)'},onClick:()=>{panTo(v.coords.lat,v.coords.lng);setSel({type:'vb',data:v});}},
        'âš ',E('div',null,E('strong',{style:{color:'#ef4444',display:'block',fontSize:10}},`${v.vorname} ${v.nachname}`),E('span',{style:{fontSize:9,color:'#6b6c82'}},v.ort||v.plz||''))
      ))
    ),
    // DETAIL PANEL
    sel&&E(Detail,{sel,gaps,gapRecs,scoutStats,quals,onClose:()=>setSel(null),panTo})
  );
}

function OvView({vertriebler,scouter,gaps,infasCount,panTo,setSel}){
  return E('div',null,
    E('div',{className:'infas-banner'},
      E('div',{className:'infas-num'},(infasCount/1000000).toFixed(1)+' Mio.'),
      E('div',{className:'infas-sub'},'infas360 Haushalte Â· Layer links aktivieren')
    ),
    E('div',{className:'sec'},'Top Vertriebler'),
    ...vertriebler.filter(v=>v.coords).slice(0,8).map(v=>
      E('div',{key:v.id,className:'card',onClick:()=>{setSel({type:'vb',data:v});panTo(v.coords.lat,v.coords.lng);}},
        E('div',{style:{display:'flex',justifyContent:'space-between'}},
          E('span',{className:'ct',style:{color:v.color}},`${v.vorname} ${v.nachname}`),
          E('span',{className:'pill',style:{background:v.color+'22',color:v.color}},v.typ?.split('_')[0])
        ),
        E('div',{className:'cs'},v.ort||v.plz||'â€”')
      )
    )
  );
}

function GapsView({gaps,gapRecs,panTo,setSel}){
  if(!gaps.length)return E('div',{style:{color:'#22c55e',fontSize:11,padding:'6px 0'}},'âœ“ Alle Regionen gedeckt');
  return E('div',null,
    E('div',{className:'sec'},`${gaps.length} Regionen ohne Scout`),
    gapRecs.map(({v,leads})=>{
      const top=leads[0];
      return E('div',{key:v.id,style:{marginBottom:8}},
        E('div',{className:'alert-box',style:{background:'rgba(239,68,68,.05)',borderColor:'rgba(239,68,68,.2)'},onClick:()=>{setSel({type:'vb',data:v});if(v.coords)panTo(v.coords.lat,v.coords.lng);}},
          E('div',{style:{color:'#ef4444',fontWeight:700,fontSize:11}},`âš  ${v.vorname} ${v.nachname}`),
          E('div',{style:{fontSize:10,color:'#6b6c82'}},v.ort||v.plz||'â€”')
        ),
        top&&E('div',{className:'rec'},
          E('div',{className:'rect'},`ðŸ’¡ ${top.name}`),
          E('div',{className:'krow'},E('span',{className:'krl'},'â‚¬/Termin'),E('span',{className:'krv',style:{color:'#a78bfa'}},`~â‚¬${kpt(top)}`)),
          E('div',{className:'krow'},E('span',{className:'krl'},'Score'),E('span',{className:'krv',style:{color:top.score>=80?'#22c55e':'#f59e0b'}},top.score+'/100')),
          E('div',{className:'krow'},E('span',{className:'krl'},'Break-Even'},E('span',{className:'krv'},`~${Math.ceil(2500/(Math.ceil(30/top.conv)*top.preis_lead-3200))}M`))
        )
      );
    })
  );
}

function ROIView(){
  const {useState}=React;
  const [termine,setTermine]=useState(20);
  const [monate,setMonate]=useState(12);
  const [qi,setQi]=useState(0);
  const q=LEADS[qi];
  const lMo=Math.ceil(termine/q.conv)*(q.preis_lead||q.preis_termin);
  const lGes=lMo*monate,sGes=3200*monate+2500;
  const bE=lMo>3200?Math.ceil(2500/(lMo-3200)):null;
  return E('div',null,
    E('div',{className:'sec'},'Scout vs Leads'),
    E('div',{style:{background:'#0d0e1a',border:'1px solid #181926',borderRadius:8,padding:10,marginBottom:8}},
      E('div',{style:{fontSize:10,color:'#6b6c82',marginBottom:3}},'Termine/Monat'),
      E('input',{type:'range',min:5,max:60,value:termine,onChange:e=>setTermine(+e.target.value)}),
      E('div',{className:'mono',style:{fontSize:14,fontWeight:700,color:'#FF5C35',textAlign:'center',marginBottom:7}},termine,' T/Mo'),
      E('div',{style:{fontSize:10,color:'#6b6c82',marginBottom:3}},'Zeitraum (Monate)'),
      E('input',{type:'range',min:3,max:24,value:monate,onChange:e=>setMonate(+e.target.value)}),
      E('div',{className:'mono',style:{fontSize:12,fontWeight:700,color:'#8b5cf6',textAlign:'center',marginBottom:7}},monate,' Monate'),
      E('select',{value:qi,onChange:e=>setQi(+e.target.value)},
        LEADS.map((q,i)=>E('option',{key:i,value:i},`${q.name} Â· â‚¬${kpt(q)}/T`))
      )
    ),
    E('div',{className:'roi'},
      E('div',{className:'roi-t'},'Vergleich'),
      E('div',{className:'krow'},E('span',{className:'krl'},'Lead-Kosten/Mo'),E('span',{className:'krv',style:{color:'#a78bfa'}},`â‚¬${lMo.toFixed(0)}`)),
      E('div',{className:'krow'},E('span',{className:'krl'},`${monate}M Leads`),E('span',{className:'krv',style:{color:'#ef4444'}},`â‚¬${lGes.toFixed(0)}`)),
      E('div',{className:'krow'},E('span',{className:'krl'},'Scout Fix/Mo'),E('span',{className:'krv'},'â‚¬3.200')),
      E('div',{className:'krow'},E('span',{className:'krl'},`${monate}M Scout ges.`),E('span',{className:'krv',style:{color:'#22c55e'}},`â‚¬${sGes.toFixed(0)}`)),
      E('div',{className:'krow roi-r',style:{fontWeight:700,fontSize:12,paddingTop:6,border:'none'}},
        E('span',{style:{color:lGes<sGes?'#f59e0b':'#22c55e'}},lGes<sGes?'âš¡ Leads gÃ¼nstiger':'âœ“ Scout gÃ¼nstiger'),
        E('span',{className:'mono',style:{fontSize:10}},`â‚¬${Math.abs(sGes-lGes).toFixed(0)}`)
      )
    ),
    bE>0&&bE<30&&E('div',{className:'win'},`âœ“ Scout Break-Even nach ${bE} Monaten`)
  );
}

function PerfView({appScouter,scoutStats}){
  const sorted=[...appScouter].map(s=>{const st=scoutStats[s.id]||{};return{...s,tot:st.total||0,qual:st.qualified||0,conv:st.total>0?+(st.qualified/st.total*100).toFixed(0):0};}).sort((a,b)=>b.tot-a.tot);
  const max=sorted[0]?.tot||1;
  return E('div',null,
    E('div',{className:'sec'},'Scout Performance'),
    sorted.slice(0,12).map((s,i)=>{
      const cc=s.conv>=30?'#22c55e':s.conv>=15?'#f59e0b':'#ef4444';
      return E('div',{key:s.id||i,className:'card'},
        E('div',{style:{display:'flex',justifyContent:'space-between',marginBottom:3}},
          E('span',{className:'ct',style:{fontSize:10}},`${s.vorname} ${s.nachname}`),
          E('div',{style:{display:'flex',gap:3}},
            E('span',{className:'pill',style:{background:cc+'22',color:cc}},s.conv+'%'),
            E('span',{className:'pill',style:{background:'rgba(255,255,255,.05)',color:'#6b6c82'}},s.tot)
          )
        ),
        E('div',{className:'bar'},E('div',{className:'barf',style:{width:(s.tot/max*100)+'%',background:SCOLS[i%SCOLS.length]}}))
      );
    })
  );
}

function Detail({sel,gaps,gapRecs,scoutStats,quals,onClose,panTo}){
  const{type,data}=sel;
  const krow=(l,v,c='#e4e5f0')=>E('div',{key:l,className:'krow'},E('span',{className:'krl'},l),E('span',{className:'krv',style:{color:c}},v));
  const hdr=(ico,bg,name,sub)=>E('div',{className:'pr-h'},
    E('div',{className:'pr-ico',style:{background:bg}},ico),
    E('div',{style:{flex:1}},E('div',{style:{fontWeight:700,fontSize:13}},name),E('div',{style:{fontSize:10,color:'#6b6c82'}},sub)),
    E('button',{className:'close',onClick:onClose},'âœ•')
  );
  if(type==='vb'){
    const isGap=gaps.some(g=>g.id===data.id);
    const rec=gapRecs.find(r=>r.v.id===data.id);
    const top=rec?.leads[0];
    return E('div',{className:'pr open'},
      hdr('ðŸ‘¤',data.color||'#FF5C35',`${data.vorname} ${data.nachname}`,data.ort||data.plz||'â€”'),
      E('div',{className:'pr-c'},
        isGap&&E('div',{style:{background:'rgba(239,68,68,.07)',border:'1px solid rgba(239,68,68,.2)',borderRadius:7,padding:'7px 9px',marginBottom:9,fontSize:11,color:'#ef4444',fontWeight:600}},'âš  Kein Scout im Umfeld'),
        krow('Typ',data.typ||'â€”'),krow('Ort',data.ort||data.einsatzort||data.plz||'â€”'),
        data.grundgehalt&&krow('Grundgehalt',`â‚¬${data.grundgehalt}/Mo`),
        isGap&&top&&E('div',null,
          E('div',{className:'dvd'}),
          E('div',{className:'rec'},
            E('div',{className:'rect'},`ðŸ’¡ Empfehlung: ${top.name}`),
            krow('â‚¬/Termin',`~â‚¬${kpt(top)}`,'#a78bfa'),
            krow('Leads fÃ¼r 30T',Math.ceil(30/top.conv),''),
            krow('Kosten/Mo',`â‚¬${(Math.ceil(30/top.conv)*top.preis_lead).toFixed(0)}`),
            E('div',{style:{marginTop:5,fontSize:10,color:'#6b6c82',fontStyle:'italic'}},top.info)
          )
        )
      )
    );
  }
  if(type==='sc'){
    const st=scoutStats[data.id]||{};
    const conv=st.total>0?(st.qualified/st.total*100).toFixed(1):0;
    const cc=conv>=25?'#22c55e':conv>=15?'#f59e0b':'#ef4444';
    return E('div',{className:'pr open'},
      hdr('ðŸŽ¯','rgba(78,205,196,.2)',`${data.vorname} ${data.nachname}`,'App-Scouter'),
      E('div',{className:'pr-c'},
        E('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:5,marginBottom:8}},
          E('div',{className:'bigkpi'},E('div',{className:'bigv',style:{color:'#4ECDC4'}},st.total||0),E('div',{className:'bigl'},'Besuche')),
          E('div',{className:'bigkpi'},E('div',{className:'bigv',style:{color:cc}},conv+'%'),E('div',{className:'bigl'},'Conversion')),
          E('div',{className:'bigkpi'},E('div',{className:'bigv',style:{color:'#22c55e'}},st.qualified||0),E('div',{className:'bigl'},'Qualifiziert')),
          E('div',{className:'bigkpi'},E('div',{className:'bigv',style:{color:'#f59e0b'}},st.revisit||0),E('div',{className:'bigl'},'Revisit')),
        ),
        krow('Typ',data.typ||'Scouter'),
        data.email&&krow('Email',data.email)
      )
    );
  }
  if(type==='ld'){
    return E('div',{className:'pr open'},
      hdr('â‚¬','rgba(139,92,246,.2)',data.name,data.typ==='termin'?'Direkttermine':'Lead-Plattform'),
      E('div',{className:'pr-c'},
        data.preis_lead&&krow('Preis/Lead',`â‚¬${data.preis_lead}`),
        data.preis_termin&&krow('Preis/Termin',`â‚¬${data.preis_termin}`),
        krow('Conversion',`${(data.conv*100).toFixed(0)}%`,'#f59e0b'),
        krow('Eff. â‚¬/Termin',`~â‚¬${kpt(data)}`,'#a78bfa'),
        krow('Score',`${data.score}/100`,data.score>=80?'#22c55e':'#f59e0b'),
        krow('Radius',`${data.radius}km`),
        E('div',{style:{marginTop:8,fontSize:11,color:'#6b6c82',fontStyle:'italic',padding:'7px 9px',background:'#0d0e1a',borderRadius:6,border:'1px solid #181926'}},data.info),
        E('div',{className:'dvd'}),
        E('div',{className:'sec'},'Abgedeckte LÃ¼cken'),
        ...gaps.filter(v=>v.coords&&haversine(v.coords,{lat:data.lat,lng:data.lng})<data.radius)
          .map(v=>E('div',{key:v.id,style:{fontSize:10,color:'#22c55e',padding:'2px 0',borderBottom:'1px solid #181926'}},`âœ“ ${v.vorname} ${v.nachname}`))
      )
    );
  }
  return null;
}

ReactDOM.createRoot(document.getElementById('root')).render(E(App));
}); // end waitReact
</script>
</body>
</html>
