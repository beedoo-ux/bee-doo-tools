<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo ¬∑ Provisions- & Sonderl√∂sungen</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0c0c0f;--surface:#15161b;--surface2:#1c1d24;--surface3:#24252e;
  --border:#2a2b35;--border2:#353642;
  --text:#e8e8ec;--text2:#a0a0b0;--text3:#6a6a7a;
  --accent:#F5C500;--accent2:#ffd84d;--accent-dim:rgba(245,197,0,.12);
  --green:#34d399;--green-dim:rgba(52,211,153,.12);
  --red:#f87171;--red-dim:rgba(248,113,113,.12);
  --blue:#60a5fa;--blue-dim:rgba(96,165,250,.12);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,.12);
  --orange:#fb923c;--orange-dim:rgba(251,146,60,.12);
  --radius:12px;--radius-sm:8px;
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}

/* Header */
.header{
  background:linear-gradient(135deg,#15161b 0%,#1a1b22 100%);
  border-bottom:1px solid var(--border);
  padding:20px 24px;position:sticky;top:0;z-index:100;
  backdrop-filter:blur(20px);
}
.header-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.header h1{font-size:1.5rem;font-weight:700;letter-spacing:-.02em}
.header h1 span{color:var(--accent)}
.header .sub{color:var(--text3);font-size:.85rem;margin-top:2px}
.badge-live{display:inline-flex;align-items:center;gap:6px;background:var(--green-dim);color:var(--green);padding:4px 12px;border-radius:20px;font-size:.75rem;font-weight:600}
.badge-live::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* Layout */
.container{max-width:1400px;margin:0 auto;padding:24px}
.section{margin-bottom:32px}
.section-title{font-size:1.1rem;font-weight:600;color:var(--text2);margin-bottom:16px;display:flex;align-items:center;gap:10px}
.section-title .icon{width:32px;height:32px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1rem}

/* Grid */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:border-color .2s}
.card:hover{border-color:var(--border2)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.card-title{font-size:.95rem;font-weight:600}
.card-badge{font-size:.7rem;font-weight:600;padding:3px 10px;border-radius:20px;text-transform:uppercase;letter-spacing:.04em}

/* Table */
.tbl{width:100%;border-collapse:collapse;font-size:.85rem}
.tbl th{text-align:left;padding:10px 14px;color:var(--text3);font-weight:500;font-size:.75rem;text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--border);white-space:nowrap}
.tbl td{padding:10px 14px;border-bottom:1px solid var(--border);vertical-align:top}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--surface2)}
.tbl .num{text-align:right;font-variant-numeric:tabular-nums;font-weight:500}
.tbl .eur{color:var(--accent);font-weight:600}

/* Provision Model Cards */
.model-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:all .2s}
.model-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 32px rgba(245,197,0,.06)}
.model-card .top{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.model-card .top h3{font-size:.9rem;font-weight:600}
.model-card .typ-badge{font-size:.65rem;padding:2px 8px;border-radius:12px;font-weight:600}
.model-card .body{padding:16px 20px}
.model-card .row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.model-card .row:last-child{border-bottom:none}
.model-card .row .label{color:var(--text3);font-size:.8rem}
.model-card .row .val{font-size:.85rem;font-weight:600;font-variant-numeric:tabular-nums}

/* Special deal cards */
.deal-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;display:flex;gap:16px;align-items:flex-start;transition:border-color .2s}
.deal-card:hover{border-color:var(--accent)}
.deal-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;flex-shrink:0}
.deal-content{flex:1;min-width:0}
.deal-name{font-weight:600;font-size:.9rem;margin-bottom:2px}
.deal-desc{color:var(--text2);font-size:.8rem;line-height:1.5}
.deal-meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.deal-tag{font-size:.7rem;padding:2px 8px;border-radius:10px;font-weight:500}

/* Stat boxes */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:28px}
.stat-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;text-align:center}
.stat-box .val{font-size:1.6rem;font-weight:700;font-variant-numeric:tabular-nums}
.stat-box .lbl{font-size:.75rem;color:var(--text3);margin-top:2px}

/* Colors for types */
.typ-vt{background:var(--accent-dim);color:var(--accent)}
.typ-sc{background:var(--blue-dim);color:var(--blue)}
.typ-hgb{background:var(--purple-dim);color:var(--purple)}
.typ-mont{background:var(--green-dim);color:var(--green)}
.typ-flat{background:var(--orange-dim);color:var(--orange)}
.typ-scout{background:var(--blue-dim);color:var(--blue)}
.typ-team{background:var(--purple-dim);color:var(--purple)}
.typ-skip{background:var(--red-dim);color:var(--red)}
.typ-warn{background:var(--red-dim);color:var(--red)}

/* Open items */
.open-item{display:flex;align-items:center;gap:12px;padding:10px 16px;border-radius:var(--radius-sm);background:var(--surface2);margin-bottom:8px}
.open-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.open-text{font-size:.85rem;flex:1}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--text3)}
.loading .spinner{display:inline-block;width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:1024px){
  .grid-3{grid-template-columns:1fr 1fr}
}
@media(max-width:768px){
  .grid-2,.grid-3{grid-template-columns:1fr}
  .header-inner{flex-direction:column;align-items:flex-start}
  .container{padding:16px}
  .stat-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:480px){
  .stat-grid{grid-template-columns:1fr}
  .tbl{font-size:.75rem}
  .tbl th,.tbl td{padding:8px 10px}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div>
      <h1><img src="https://bee-doo-tools.vercel.app/bee-doo-Logo-white.svg" style="height:26px;vertical-align:middle;margin-right:8px" alt="bee-doo">Provisions- & Sonderl√∂sungen</h1>
      <div class="sub">Komplett√ºbersicht aller aktiven Regeln, Stand: Live aus Supabase</div>
    </div>
    <div class="badge-live">Live-Daten</div>
  </div>
</div>

<div class="container">
  <div id="app">
    <div class="loading"><div class="spinner"></div><br>Daten werden geladen...</div>
  </div>
</div>

<script>
const SB_URL = 'https://hqzpemfaljxcysyqssng.supabase.co/rest/v1';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';

async function sb(table, params = '') {
  const r = await fetch(`${SB_URL}/${table}?${params}`, {
    headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` }
  });
  return r.json();
}

function eur(v) {
  if (!v && v !== 0) return '‚Äì';
  return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
}

function initials(name) {
  return name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
}

function typLabel(typ) {
  const map = {
    'angestellt_vertriebler': 'Angest. VT',
    'angestellt_vt': 'Angest. VT',
    'angestellt_scouter': 'Angest. Scout',
    'hgb_vertriebler_haupt': 'HGB Haupt',
    'hgb_vertriebler_agentur': 'HGB Agentur',
    'hgb_vertriebler': 'HGB VT',
    'hgb_scouter': 'HGB Scout',
    'hgb84': 'HGB ¬ß84',
    'montage_partner': 'Montage',
    'vertriebler': 'Vertriebler',
  };
  return map[typ] || typ;
}

function typClass(typ) {
  if (typ.includes('scouter') || typ.includes('scout')) return 'typ-sc';
  if (typ.includes('hgb')) return 'typ-hgb';
  if (typ.includes('montage')) return 'typ-mont';
  return 'typ-vt';
}

async function loadAll() {
  const [models, sonder, stufen, teamBonus, staffel, reserve, system, abzuege, darlehen, pfaend, vorsch, einmal, mitarbeiter] = await Promise.all([
    sb('provisionsmodelle', 'aktiv=eq.true&order=name'),
    sb('pay_sonderprovisionen', 'order=mitarbeiter_name'),
    sb('pay_stufenbonus', 'aktiv=eq.true&order=gilt_fuer,min_anlagen'),
    sb('pay_team_bonus', 'aktiv=eq.true&order=mitarbeiter_name'),
    sb('pay_staffel_regeln', 'aktiv=eq.true&order=sort_order'),
    sb('pay_reserve_einstellungen', 'aktiv=eq.true'),
    sb('systemgebuehr', 'aktiv=eq.true'),
    sb('pay_abzuege', 'aktiv=eq.true&order=bezeichnung'),
    sb('pay_darlehen', 'aktiv=eq.true'),
    sb('pay_pfaendungen', 'aktiv=eq.true'),
    sb('pay_vorschuesse', 'order=jahr.desc,monat.desc&limit=20'),
    sb('pay_einmalzahlungen', 'order=jahr.desc,monat.desc&limit=20'),
    sb('mitarbeiter', 'select=id,vorname,nachname&limit=500'),
  ]);

  const maMap = {};
  mitarbeiter.forEach(m => maMap[m.id] = `${m.vorname} ${m.nachname}`);

  render({ models, sonder, stufen, teamBonus, staffel, reserve, system, abzuege, darlehen, pfaend, vorsch, einmal, maMap });
}

function render(d) {
  const app = document.getElementById('app');
  
  const activeSonder = d.sonder.filter(s => s.aktiv);
  const inactiveSonder = d.sonder.filter(s => !s.aktiv);

  app.innerHTML = `
    <!-- Stats -->
    <div class="stat-grid">
      <div class="stat-box">
        <div class="val" style="color:var(--accent)">${d.models.length}</div>
        <div class="lbl">Provisionsmodelle</div>
      </div>
      <div class="stat-box">
        <div class="val" style="color:var(--orange)">${activeSonder.length}</div>
        <div class="lbl">Aktive Sonderl√∂sungen</div>
      </div>
      <div class="stat-box">
        <div class="val" style="color:var(--purple)">${d.teamBonus.length}</div>
        <div class="lbl">Team-Bonus Regeln</div>
      </div>
      <div class="stat-box">
        <div class="val" style="color:var(--green)">${d.stufen.length}</div>
        <div class="lbl">Stufenboni</div>
      </div>
      <div class="stat-box">
        <div class="val" style="color:var(--blue)">${d.abzuege.length + d.darlehen.length}</div>
        <div class="lbl">Laufende Abz√ºge</div>
      </div>
      <div class="stat-box">
        <div class="val" style="color:var(--red)">${d.pfaend.length}</div>
        <div class="lbl">Pf√§ndungen</div>
      </div>
    </div>

    <!-- 1. Provisionsmodelle -->
    <div class="section">
      <div class="section-title">
        <div class="icon" style="background:var(--accent-dim);color:var(--accent)">üìä</div>
        Globale Provisionsmodelle
      </div>
      <div class="grid-3" id="models-grid"></div>
    </div>

    <!-- 2. Stufenboni -->
    <div class="section">
      <div class="section-title">
        <div class="icon" style="background:var(--green-dim);color:var(--green)">üèÜ</div>
        Stufenboni (monatlich)
      </div>
      <div class="card">
        <table class="tbl">
          <thead><tr><th>Stufe</th><th>Ab Anlagen</th><th>Gilt f√ºr</th><th class="num">Bonus</th></tr></thead>
          <tbody>${d.stufen.map(s => `
            <tr>
              <td><strong>${s.stufe_name}</strong></td>
              <td>‚â• ${s.min_anlagen}</td>
              <td><span class="card-badge ${typClass(s.gilt_fuer)}">${typLabel(s.gilt_fuer)}</span></td>
              <td class="num eur">${eur(s.bonus_betrag)}</td>
            </tr>
          `).join('')}</tbody>
        </table>
      </div>
    </div>

    <!-- 3. Staffel-Regeln -->
    ${d.staffel.length ? `
    <div class="section">
      <div class="section-title">
        <div class="icon" style="background:var(--blue-dim);color:var(--blue)">üìà</div>
        Staffel-Regeln
      </div>
      <div class="card">
        <table class="tbl">
          <thead><tr><th>Name</th><th>Schwelle</th><th class="num">Bonus HGB</th><th class="num">Bonus Angest.</th><th>Kumulativ</th></tr></thead>
          <tbody>${d.staffel.map(s => `
            <tr>
              <td><strong>${s.name}</strong></td>
              <td>‚â• ${s.schwelle} Anlagen</td>
              <td class="num eur">${eur(s.bonus_hgb)}</td>
              <td class="num eur">${eur(s.bonus_angestellt)}</td>
              <td>${s.kumulativ ? '‚úÖ Ja' : '‚ùå Nein'}</td>
            </tr>
          `).join('')}</tbody>
        </table>
      </div>
    </div>` : ''}

    <!-- 4. Sonderl√∂sungen -->
    <div class="section">
      <div class="section-title">
        <div class="icon" style="background:var(--orange-dim);color:var(--orange)">‚ö°</div>
        Aktive Sonderl√∂sungen & Flat-Rates
      </div>
      <div class="grid-2" id="sonder-grid"></div>
    </div>

    <!-- 5. Team-Bonus -->
    <div class="section">
      <div class="section-title">
        <div class="icon" style="background:var(--purple-dim);color:var(--purple)">üë•</div>
        Team-Bonus Regeln
      </div>
      <div class="grid-2" id="team-grid"></div>
    </div>

    <!-- 6. Stornoreserve & Systemgeb√ºhr -->
    <div class="section">
      <div class="section-title">
        <div class="icon" style="background:var(--accent-dim);color:var(--accent)">üîí</div>
        Stornoreserve & Systemgeb√ºhr
      </div>
      <div class="grid-2">
        ${d.reserve.filter(r => r.typ === 'global_hgb').map(r => `
          <div class="card">
            <div class="card-header">
              <div class="card-title">Stornoreserve HGB</div>
              <span class="card-badge typ-warn">${r.prozent}%</span>
            </div>
            <div style="color:var(--text2);font-size:.85rem">
              ${r.prozent}% auf alle Provisionen ¬∑ Laufzeit ${r.laufzeit_monate} Monate ¬∑ R√ºckzahlung nach Ablauf wenn keine Stornierung
            </div>
          </div>
        `).join('')}
        ${d.system.map(s => `
          <div class="card">
            <div class="card-header">
              <div class="card-title">${s.bezeichnung}</div>
              <span class="card-badge typ-hgb">${s.gilt_fuer}</span>
            </div>
            <div style="color:var(--text2);font-size:.85rem">
              ${s.beschreibung}
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- 7. Laufende Abz√ºge & Darlehen -->
    <div class="section">
      <div class="section-title">
        <div class="icon" style="background:var(--red-dim);color:var(--red)">üìã</div>
        Laufende Abz√ºge, Darlehen & Pf√§ndungen
      </div>
      <div class="card">
        <table class="tbl">
          <thead><tr><th>Mitarbeiter</th><th>Bezeichnung</th><th>Kategorie</th><th class="num">Betrag/Monat</th></tr></thead>
          <tbody>
            ${d.abzuege.map(a => `
              <tr>
                <td>${d.maMap[a.mitarbeiter_id] || '?'}</td>
                <td>${a.bezeichnung}</td>
                <td><span class="card-badge typ-warn">${a.kategorie}</span></td>
                <td class="num" style="color:var(--red)">${eur(a.betrag)}</td>
              </tr>
            `).join('')}
            ${d.darlehen.map(dl => `
              <tr>
                <td>${d.maMap[dl.mitarbeiter_id] || '?'}</td>
                <td>${dl.bezeichnung}</td>
                <td><span class="card-badge typ-purple">Darlehen</span></td>
                <td class="num" style="color:var(--red)">${eur(dl.monatliche_rate)}</td>
              </tr>
            `).join('')}
            ${d.pfaend.map(p => `
              <tr>
                <td>${d.maMap[p.mitarbeiter_id] || '?'}</td>
                <td>Pf√§ndung ‚Äì ${p.glaeubiger}</td>
                <td><span class="card-badge typ-warn">Pf√§ndung</span></td>
                <td class="num" style="color:var(--red)">${p.pfaendbarer_betrag ? eur(p.pfaendbarer_betrag) : 'StB'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 8. Offene Punkte -->
    <div class="section">
      <div class="section-title">
        <div class="icon" style="background:var(--accent-dim);color:var(--accent)">‚ùì</div>
        Offene Punkte
      </div>
      <div class="open-item"><div class="open-dot" style="background:var(--accent)"></div><div class="open-text"><strong>Zero Bonus</strong> ‚Äì 150 ‚Ç¨/200 ‚Ç¨ bei Preismodell "Zero" in EFS. <em>Auszahlungs-Trigger noch offen.</em></div></div>
      <div class="open-item"><div class="open-dot" style="background:var(--orange)"></div><div class="open-text"><strong>DC Monteur (Sven)</strong> ‚Äì 20 ‚Ç¨/St√ºck bei "DC Montage vollst√§ndig". <em>Noch nicht in DB.</em></div></div>
      <div class="open-item"><div class="open-dot" style="background:var(--orange)"></div><div class="open-text"><strong>Montage-Leiter (Holger)</strong> ‚Äì 100 ‚Ç¨/Paket bei DC + AC vollst√§ndig. <em>Noch nicht in DB.</em></div></div>
      <div class="open-item"><div class="open-dot" style="background:var(--orange)"></div><div class="open-text"><strong>AC Installateur</strong> ‚Äì 200 ‚Ç¨/Anlage bei "AC Montage vollst√§ndig". <em>Noch nicht in DB.</em></div></div>
      <div class="open-item"><div class="open-dot" style="background:var(--text3)"></div><div class="open-text"><strong>Krankenkassen</strong> ‚Äì Pro Mitarbeiter noch nicht erfasst (nicht aus Lohnjournal-PDF extrahierbar)</div></div>
      ${inactiveSonder.length ? inactiveSonder.map(s => `
        <div class="open-item"><div class="open-dot" style="background:var(--text3)"></div><div class="open-text"><strong>${s.mitarbeiter_name}</strong> ‚Äì ${s.typ}: ${s.beschreibung} <em>(inaktiv)</em></div></div>
      `).join('') : ''}
    </div>
  `;

  // Render model cards
  const modelsGrid = document.getElementById('models-grid');
  d.models.forEach(m => {
    const div = document.createElement('div');
    div.className = 'model-card';
    const hasStaffel = m.staffel_schwelle < 999;
    div.innerHTML = `
      <div class="top">
        <h3>${m.name}</h3>
        <span class="typ-badge ${typClass(m.typ)}">${typLabel(m.typ)}</span>
      </div>
      <div class="body">
        <div class="row"><span class="label">Basis / Sale</span><span class="val eur">${eur(m.basis_rate)}</span></div>
        ${hasStaffel ? `<div class="row"><span class="label">Staffel / Sale (ab ${m.staffel_schwelle})</span><span class="val eur">${eur(m.staffel_rate)}</span></div>` : ''}
        ${hasStaffel && m.rueckwirkend ? `<div class="row"><span class="label">R√ºckwirkend</span><span class="val" style="color:var(--green)">‚úÖ Ja</span></div>` : ''}
        ${m.eigenlead_bonus ? `<div class="row"><span class="label">Eigenlead-Bonus</span><span class="val eur">${eur(m.eigenlead_bonus)}</span></div>` : ''}
        ${m.empfehlungs_bonus ? `<div class="row"><span class="label">Empfehlungs-Bonus</span><span class="val eur">${eur(m.empfehlungs_bonus)}</span></div>` : ''}
        ${m.speicher_bonus ? `<div class="row"><span class="label">Speicher-Bonus</span><span class="val eur">${eur(m.speicher_bonus)}</span></div>` : ''}
        ${m.termin_bonus ? `<div class="row"><span class="label">Stattgefundene selbst gelegte Termine</span><span class="val eur">${eur(m.termin_bonus)}</span></div>` : ''}
        ${m.lead_bonus ? `<div class="row"><span class="label">Lead-Bonus</span><span class="val eur">${eur(m.lead_bonus)}</span></div>` : ''}
        ${m.zero_bonus ? `<div class="row"><span class="label">Zero-Bonus</span><span class="val eur">${eur(m.zero_bonus)}</span></div>` : ''}
      </div>
    `;
    modelsGrid.appendChild(div);
  });

  // Render Sonderl√∂sungen
  const sonderGrid = document.getElementById('sonder-grid');
  activeSonder.forEach(s => {
    const div = document.createElement('div');
    div.className = 'deal-card';

    let desc = s.beschreibung;
    let typTag = s.typ;
    let typCls = 'typ-flat';
    if (s.typ === 'scout_umleitung') { typCls = 'typ-scout'; typTag = 'Scout-Umleitung'; }
    if (s.typ === 'scout_eigenlead') { typCls = 'typ-scout'; typTag = 'Scout-Eigenlead'; }
    if (s.typ === 'flat_rate') { typCls = 'typ-flat'; typTag = 'Flat-Rate'; }
    if (s.typ === 'skip_abrechnung') { typCls = 'typ-skip'; typTag = 'Keine Abrechnung'; }

    // Parse JSON descriptions
    try {
      const parsed = JSON.parse(desc);
      desc = parsed.regel || desc;
    } catch(e) {}

    const colors = ['#F5C500','#60a5fa','#a78bfa','#34d399','#fb923c','#f87171'];
    const ci = s.mitarbeiter_name.charCodeAt(0) % colors.length;

    div.innerHTML = `
      <div class="deal-avatar" style="background:${colors[ci]}22;color:${colors[ci]}">${initials(s.mitarbeiter_name)}</div>
      <div class="deal-content">
        <div class="deal-name">${s.mitarbeiter_name}</div>
        <div class="deal-desc">${desc}</div>
        <div class="deal-meta">
          <span class="deal-tag ${typCls}">${typTag}</span>
          ${s.betrag ? `<span class="deal-tag typ-vt">${eur(s.betrag)}</span>` : ''}
          <span class="deal-tag" style="background:var(--surface3);color:var(--text3)">seit ${new Date(s.gueltig_ab).toLocaleDateString('de-DE')}</span>
        </div>
      </div>
    `;
    sonderGrid.appendChild(div);
  });

  // Render Team-Bonus
  const teamGrid = document.getElementById('team-grid');
  d.teamBonus.forEach(t => {
    const div = document.createElement('div');
    div.className = 'deal-card';
    const members = t.team_mitglieder ? t.team_mitglieder.join(', ') : 'Alle Vertriebler';
    const colors = ['#F5C500','#60a5fa','#a78bfa','#34d399','#fb923c'];
    const ci = t.mitarbeiter_name.charCodeAt(0) % colors.length;

    div.innerHTML = `
      <div class="deal-avatar" style="background:${colors[ci]}22;color:${colors[ci]}">${initials(t.mitarbeiter_name)}</div>
      <div class="deal-content">
        <div class="deal-name">${t.mitarbeiter_name}</div>
        <div class="deal-desc">${eur(t.betrag_pro_sale)} pro Sale ¬∑ Bezugsgruppe: ${t.bezugsgruppe === 'alle_vt' ? 'Alle Vertriebler' : 'Eigenes Team'}</div>
        ${t.team_mitglieder ? `<div class="deal-desc" style="margin-top:4px;font-size:.75rem;color:var(--text3)">Team: ${members}</div>` : ''}
        <div class="deal-meta">
          <span class="deal-tag typ-team">Team-Bonus</span>
          <span class="deal-tag" style="background:var(--surface3);color:var(--text3)">seit ${new Date(t.gueltig_ab).toLocaleDateString('de-DE')}</span>
        </div>
      </div>
    `;
    teamGrid.appendChild(div);
  });
}

loadAll().catch(err => {
  document.getElementById('app').innerHTML = `<div class="card" style="color:var(--red)">Fehler: ${err.message}</div>`;
});
</script>
</body>
</html>

