<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bee-doo | Daten-Import Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --accent: #F5C500;
            --accent-dim: rgba(245, 197, 0, 0.15);
            --bg: #0a0a0f;
            --bg-card: #12131a;
            --bg-card-hover: #181924;
            --bg-elevated: #1a1b25;
            --border: rgba(255,255,255,0.06);
            --border-accent: rgba(245, 197, 0, 0.25);
            --text: #e2e4ea;
            --text-dim: #8b95a5;
            --text-bright: #ffffff;
            --success: #22c55e;
            --success-dim: rgba(34, 197, 94, 0.15);
            --error: #ef4444;
            --error-dim: rgba(239, 68, 68, 0.15);
            --warning: #f59e0b;
            --warning-dim: rgba(245, 158, 11, 0.15);
            --info: #3b82f6;
            --info-dim: rgba(59, 130, 246, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.35s ease-out; }

        .header { padding: 18px 32px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: linear-gradient(180deg, rgba(245,197,0,0.03) 0%, transparent 100%); }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .logo { font-size: 20px; font-weight: 700; color: var(--accent); letter-spacing: -0.5px; }
        .logo span { color: var(--text-dim); font-weight: 400; }
        .subtitle { font-size: 13px; color: var(--text-dim); padding-left: 16px; border-left: 1px solid var(--border); }
        .back-link { font-size: 13px; color: var(--text-dim); text-decoration: none; padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s; }
        .back-link:hover { color: var(--accent); border-color: var(--border-accent); background: var(--accent-dim); }

        .main { max-width: 1400px; margin: 0 auto; padding: 28px 32px; }

        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 28px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; transition: all 0.2s; }
        .stat-card:hover { border-color: var(--border-accent); transform: translateY(-1px); }
        .stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .stat-value { font-size: 26px; font-weight: 700; color: var(--text-bright); }
        .stat-sub { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

        .import-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; margin-bottom: 28px; }
        .import-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 22px; transition: all 0.3s; position: relative; overflow: hidden; }
        .import-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--accent); opacity: 0; transition: opacity 0.3s; }
        .import-card:hover::before { opacity: 1; }
        .import-card:hover { border-color: var(--border-accent); background: var(--bg-card-hover); }
        .import-card.active { border-color: var(--accent); box-shadow: 0 0 30px rgba(245, 197, 0, 0.05); }
        .import-card.active::before { opacity: 1; }

        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
        .card-title-area { display: flex; align-items: center; gap: 12px; }
        .card-icon { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 17px; }
        .card-icon.leads { background: var(--info-dim); }
        .card-icon.appointments { background: var(--success-dim); }
        .card-icon.provisions { background: var(--warning-dim); }
        .card-title { font-size: 15px; font-weight: 600; color: var(--text-bright); }
        .card-desc { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

        .card-badge { font-size: 11px; padding: 3px 10px; border-radius: 20px; font-weight: 500; }
        .badge-ready { background: var(--success-dim); color: var(--success); }
        .badge-empty { background: rgba(255,255,255,0.05); color: var(--text-dim); }
        .badge-importing { background: var(--accent-dim); color: var(--accent); }
        .badge-done { background: var(--success-dim); color: var(--success); }
        .badge-error { background: var(--error-dim); color: var(--error); }

        .multi-hint { font-size: 11px; color: var(--accent); background: var(--accent-dim); padding: 6px 10px; border-radius: 6px; margin-bottom: 10px; text-align: center; }

        .drop-zone { border: 2px dashed rgba(255,255,255,0.1); border-radius: 10px; padding: 22px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: var(--accent-dim); }
        .drop-zone-text { font-size: 13px; color: var(--text-dim); }
        .drop-zone-text strong { color: var(--accent); }
        .drop-zone input { display: none; }

        .file-info { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--bg-elevated); border-radius: 8px; margin-top: 8px; }
        .file-icon { font-size: 18px; }
        .file-details { flex: 1; }
        .file-name { font-size: 12px; font-weight: 500; color: var(--text-bright); }
        .file-meta { font-size: 11px; color: var(--text-dim); margin-top: 1px; }
        .file-remove { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 4px; font-size: 14px; transition: color 0.2s; }
        .file-remove:hover { color: var(--error); }

        .progress-bar { height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; margin-top: 14px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #ffd84d); border-radius: 2px; transition: width 0.3s ease; }
        .progress-text { font-size: 11px; color: var(--text-dim); margin-top: 5px; display: flex; justify-content: space-between; }

        .result-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 10px; }
        .result-item { padding: 8px; border-radius: 8px; text-align: center; }
        .result-item.new { background: var(--success-dim); }
        .result-item.updated { background: var(--info-dim); }
        .result-item.errors { background: var(--error-dim); }
        .result-num { font-size: 18px; font-weight: 700; }
        .result-item.new .result-num { color: var(--success); }
        .result-item.updated .result-num { color: var(--info); }
        .result-item.errors .result-num { color: var(--error); }
        .result-label { font-size: 10px; color: var(--text-dim); margin-top: 1px; }

        .merge-info { font-size: 12px; color: var(--accent); margin-top: 8px; text-align: center; font-weight: 600; }

        .btn { padding: 10px 20px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover:not(:disabled) { background: #ffd84d; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245, 197, 0, 0.3); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
        .btn-outline:hover { border-color: var(--border-accent); color: var(--accent); }
        .btn-danger { background: var(--error-dim); color: var(--error); border: 1px solid rgba(239,68,68,0.2); }
        .btn-danger:hover { background: rgba(239,68,68,0.25); }
        .btn-sm { padding: 7px 14px; font-size: 12px; }
        .action-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }

        .log-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 22px; }
        .log-title { font-size: 15px; font-weight: 600; color: var(--text-bright); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .log-entries { display: flex; flex-direction: column; gap: 6px; max-height: 300px; overflow-y: auto; }
        .log-entry { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--bg-elevated); border-radius: 8px; font-size: 12px; }
        .log-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .log-dot.success { background: var(--success); }
        .log-dot.error { background: var(--error); }
        .log-dot.pending { background: var(--accent); }
        .log-time { color: var(--text-dim); font-size: 10px; min-width: 55px; font-family: monospace; }
        .log-msg { color: var(--text); flex: 1; }
        .log-empty { text-align: center; padding: 28px; color: var(--text-dim); font-size: 13px; }

        .setup-banner { background: linear-gradient(135deg, rgba(245, 197, 0, 0.08), rgba(245, 197, 0, 0.02)); border: 1px solid var(--border-accent); border-radius: 12px; padding: 18px 22px; margin-bottom: 22px; display: flex; align-items: center; gap: 14px; }
        .setup-icon { font-size: 22px; }
        .setup-text { flex: 1; }
        .setup-text h3 { font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 3px; }
        .setup-text p { font-size: 12px; color: var(--text-dim); line-height: 1.5; }
        .spinner { width: 14px; height: 14px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }

        @media (max-width: 1100px) { .import-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) {
            .main { padding: 16px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .import-grid { grid-template-columns: 1fr; }
            .header { padding: 14px 16px; flex-wrap: wrap; gap: 8px; }
            .subtitle { display: none; }
            .stat-value { font-size: 20px; }
            .action-bar { flex-direction: column; }
            .action-bar .btn { justify-content: center; }
        }
        @media (max-width: 480px) { .stats-row { grid-template-columns: 1fr 1fr; } .result-summary { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SUPA_URL = 'https://hqzpemfaljxcysyqssng.supabase.co';
        const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
        const BATCH = 50;
        const api = (t) => `${SUPA_URL}/rest/v1/${t}`;
        const hdr = (x={}) => ({ 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation', ...x });

        // ‚îÄ‚îÄ CSV Parser ‚îÄ‚îÄ
        function parseCSV(text) {
            const lines = []; let cur = '', inQ = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"') { if (inQ && text[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
                else if ((c === '\n' || c === '\r') && !inQ) { if (cur.length > 0 || lines.length > 0) { lines.push(cur); cur = ''; } if (c === '\r' && text[i+1] === '\n') i++; }
                else cur += c;
            }
            if (cur.length > 0) lines.push(cur);
            const split = (l) => { const cells=[]; let cell='',q=false; for(let i=0;i<l.length;i++){const c=l[i]; if(c==='"'){if(q&&l[i+1]==='"'){cell+='"';i++;}else q=!q;}else if(c===','&&!q){cells.push(cell.trim());cell='';}else cell+=c;} cells.push(cell.trim()); return cells; };
            if(!lines.length) return [];
            const h = split(lines[0].replace(/^\uFEFF/,'')); return lines.slice(1).map(l=>{const c=split(l);const o={};h.forEach((k,i)=>o[k]=c[i]||'');return o;});
        }

        // ‚îÄ‚îÄ Mappers ‚îÄ‚îÄ
        const pI = (v) => { const n=parseInt(String(v).replace(/[^0-9-]/g,'')); return isNaN(n)?0:n; };
        const cl = (v) => v&&v.trim()?v.trim():null;

        function mapLead(r) {
            return { lead_id:parseInt(r['Lead ID']), leadstatus:cl(r['Leadstatus']), mitarbeiter:cl(r['Mitarbeiter/Berater']), indikator:cl(r['Indikator']), letzter_bearbeitungsstatus:cl(r['LetzterBearbeitungsstatus']), projektstatus:cl(r['Projektstatus']), anrede:cl(r['Anrede']), vorname:cl(r['Vorname']), nachname:cl(r['Nachname']), name:cl(r['Name']), firma:cl(r['Firma']), strasse:cl(r['Strasse']), hausnummer:cl(r['Hausnummer']), plz:cl(r['PLZ']), ort:cl(r['Ort']), telefon:cl(r['Telefon']), mobil:cl(r['Mobil']), email:cl(r['E-Mail']), quelle:cl(r['Quelle']), projekt:cl(r['Projekt']), gruppe:cl(r['Gruppe']), anmerkung:cl(r['Anmerkung']), tags:cl(r['Tags']), erreichbarkeit:cl(r['Erreichbarkeit']), nicht_erreicht:pI(r['Nicht erreicht']), rueckruf:cl(r['R√ºckruf']), importiert:cl(r['Importiert']), verifizierung:cl(r['Verifizierung']), aktive_wiedervorlagen:pI(r['Aktive Wiedervorlagen']), mvpp_name:cl(r['MVPP-Name']), mvpp_id:cl(r['MVPP-ID']), qualitaetscall:cl(r['Qualit√§tscall']), qualitaetscall_notizen:cl(r['Qualit√§tscall Notizen']), externe_lead_id:cl(r['externeLeadID']), externe_lead_id_2:cl(r['externeLeadID 2']), externe_lead_id_3:cl(r['externeLeadID 3']), zuweisungsstatus:cl(r['Zuweisungsstatus']), qcells_zahlungsstatus:cl(r['Q-CellsZahlungsstatus']), qcells_fortschritt:cl(r['Q-CellsFortschritt']), lieferdatum:cl(r['Lieferdatum']), auftragsbestaetigung:cl(r['Auftragsbest√§tigung']), slots_verfuegbar:cl(r['Slots verf√ºgbar']), importierte_medien:pI(r['ImportierteMedien']), datum_qualifiziert:cl(r['Datum Qualifiziert']), datum_abgeschlossen:cl(r['Datumabgeschlossen']), datum_importiert:cl(r['Datumimportiert']) };
        }
        function mapAppt(r, q) {
            return { termin_id:parseInt(r['TerminID']), lead_id:parseInt(r['LEADID'])||null, extern_id:cl(r['EXTERNID']), csv_quelle:q, leadquelle:cl(r['Leadquelle']), mvpp_name:cl(r['MVPP - NAME']), mvpp_id:cl(r['MVPP - ID']), leadkunde:cl(r['Leadkunde']), leadadresse:cl(r['Leadadresse']), terminiert_von:cl(r['Terminiertvon']), terminiert_an_name:cl(r['Terminiert anName']), terminiert_an_email:cl(r['Terminiert anE-Mail']), terminstatus:cl(r['Terminstatus']), aktueller_status:cl(r['AktuellerStatus']), angebotsstatus:cl(r['Angebotsstatus']), angebot_angenommen:cl(r['Angebot angenommen']), provisionsstatus:cl(r['Provisionsstatus']), terminausfall_begruendung:cl(r['TerminausfallBegr√ºndung']), abschlussstatus:cl(r['Abschlussstatus']), abschlussbemerkung:cl(r['Abschlussbemerkung']), bestaetigt_durch:cl(r['Best√§tigt Durch']), indikator:cl(r['Indikator']), datum_terminerstellung:cl(r['DatumTerminerstellung']), datum_termin_beginn:cl(r['DatumTermin Beginn']), datum_termin_ende:cl(r['DatumTermin Ende']), datum_abgeschlossen:cl(r['DatumAbgeschlossen']), datum_bestaetigt_partner:cl(r['DatumBest√§tigt Partner']), datum_bestaetigt_kunde:cl(r['DatumBest√§tigt Kunde']) };
        }
        function mapProv(r) {
            return { an_nr:parseInt(r['AN Nr.']), lead_id:parseInt(r['Lead ID'])||null, auftragsstatus:cl(r['Auftragsstatus']), typ:cl(r['Typ']), speichererweiterung:cl(r['Speichererweiterung']), dokumentstatus:cl(r['Dokumentstatus']), beedoo_fortschritt:cl(r['BeeDooFortschritt']), workflow_history:cl(r['WorkflowHistory']), ablehnung_freigabe_grund:cl(r['Ablehnung FreigabeGrund']), angebot_erstellt_von:cl(r['Angebot erstellt von']), kundenberater:cl(r['Kundenberater']), vp_nummer:cl(r['VP Nummer']), mvpp_id:cl(r['MVPP-ID']), mvpp_name:cl(r['MVPP-Name']), termine_agenten:cl(r['Termine Agenten']), termine_berater:cl(r['Termine Berater']), kunde:cl(r['Kunde']), kunde_plz:cl(r['Kunde PLZ']), kundennummer:cl(r['Kundennummer']), quelle:cl(r['Quelle']), an_wert_netto:cl(r['AN-WertNetto']), auszahlungsrelevant:cl(r['Auszahlungsrelevant']), ausgezahlt_am:cl(r['Ausgezahlt am']), efs_prozent:cl(r['EFS %']), finanzierung_gewuenscht:cl(r['Finanzierung gew√ºnscht']), angebot_kwp:cl(r['Angebot KWP']), angebot_module:cl(r['Angebot Module']), angebot_solarmodule:cl(r['Angebot Solarmodule']), angebot_batteriekapazitaet:cl(r['Angebot Batteriekapazit√§t Gesamt']), metrify:cl(r['Metrify']), lieferdatum:cl(r['Lieferdatum']), auftragsbestaetigung:cl(r['Auftragsbest√§tigung']), datum_erstellt:cl(r['DatumErstellt']), datum_an_kunde_gesendet:cl(r['DatumAn Kunde gesendet']), datum_gelesen:cl(r['DatumGelesen']), datum_angenommen:cl(r['DatumAngenommen']), zeit_vergangen:cl(r['Zeit vergangennach Kundenbenachrichtigung']) };
        }

        // ‚îÄ‚îÄ Upsert ‚îÄ‚îÄ
        async function upsertBatch(table, rows, onProg) {
            let ins=0, upd=0, errs=0; const errD=[];
            for (let i=0; i<rows.length; i+=BATCH) {
                const b = rows.slice(i, i+BATCH);
                try {
                    const res = await fetch(api(table), { method:'POST', headers:hdr({'Prefer':'resolution=merge-duplicates,return=representation'}), body:JSON.stringify(b) });
                    if(!res.ok){const e=await res.text();errs+=b.length;errD.push({batch:Math.floor(i/BATCH)+1,error:e.substring(0,300)});}
                    else{const d=await res.json();d.forEach(r=>{if(r.created_at===r.updated_at)ins++;else upd++;});}
                } catch(e){errs+=b.length;errD.push({batch:Math.floor(i/BATCH)+1,error:e.message});}
                onProg?.(Math.min(i+BATCH,rows.length),rows.length);
            }
            return {inserted:ins,updated:upd,errors:errs,errorDetails:errD};
        }

        const CSV_TYPES = [
            { key:'leads', label:'Leads Incoming', icon:'üìã', desc:'Eingehende Leads mit Kontaktdaten', color:'leads', table:'import_leads' },
            { key:'appointments', label:'Termine', icon:'üìÖ', desc:'Created + Closed CSVs zusammen hochladen', color:'appointments', table:'import_appointments', multi:true },
            { key:'provisions', label:'Provisionsrelevant', icon:'üí∞', desc:'Auftr√§ge mit Workflow & Finanzen', color:'provisions', table:'import_provisions' },
        ];

        function App() {
            const [files, setFiles] = useState({});
            const [importing, setImporting] = useState(null);
            const [progress, setProgress] = useState({});
            const [results, setResults] = useState({});
            const [logs, setLogs] = useState([]);
            const [db, setDb] = useState({leads:0,appointments:0,provisions:0,logs:0});
            const [tablesOk, setTablesOk] = useState(null);

            useEffect(() => { checkTables(); }, []);

            const checkTables = async () => {
                try {
                    const ck = await Promise.all(['import_leads','import_appointments','import_provisions','import_logs'].map(t=>fetch(api(t)+'?select=id&limit=1',{headers:hdr()})));
                    const ok = ck.every(r=>r.ok); setTablesOk(ok); if(ok) loadCounts();
                } catch { setTablesOk(false); }
            };

            const loadCounts = async () => {
                try {
                    const cnt = async(t)=>{const r=await fetch(api(t)+'?select=id&limit=0',{headers:{...hdr(),'Prefer':'count=exact'}});const rng=r.headers.get('content-range');return rng?parseInt(rng.split('/')[1])||0:0;};
                    const [a,b,c,d] = await Promise.all(['import_leads','import_appointments','import_provisions','import_logs'].map(cnt));
                    setDb({leads:a,appointments:b,provisions:c,logs:d});
                } catch(e){console.error(e);}
            };

            const log = (msg,s='success') => setLogs(p=>[{time:new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),msg,status:s,id:Date.now()},...p].slice(0,50));

            const detectSub = (fn) => fn.toLowerCase().includes('closed') ? 'closed' : 'created';

            const handleFile = (key, file) => {
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const rows = parseCSV(e.target.result);
                    if (key === 'appointments') {
                        const sub = detectSub(file.name);
                        setFiles(prev => {
                            const ex = prev.appointments || { fileList:[], allRows:[], totalSize:0 };
                            const newList = [...ex.fileList, { name:file.name, size:file.size, rowCount:rows.length, subtype:sub }];
                            const mapped = rows.map(r=>mapAppt(r,sub)).filter(r=>!isNaN(r.termin_id));
                            const merged = [...ex.allRows];
                            mapped.forEach(row => {
                                const idx = merged.findIndex(r=>r.termin_id===row.termin_id);
                                if(idx>=0){ if(row.csv_quelle==='closed'||merged[idx].csv_quelle!=='closed') merged[idx]=row; }
                                else merged.push(row);
                            });
                            return {...prev, appointments:{ fileList:newList, allRows:merged, totalSize:ex.totalSize+file.size, rowCount:merged.length }};
                        });
                        log(`${file.name} (${sub}) geladen: ${rows.length.toLocaleString('de-DE')} Zeilen`);
                    } else {
                        setFiles(prev=>({...prev,[key]:{file,rows,rowCount:rows.length,name:file.name,size:file.size}}));
                        log(`${file.name} geladen: ${rows.length.toLocaleString('de-DE')} Zeilen`);
                    }
                };
                reader.readAsText(file,'UTF-8');
            };

            const removeFile = (key) => { setFiles(p=>{const n={...p};delete n[key];return n;}); setResults(p=>{const n={...p};delete n[key];return n;}); };

            const importOne = async (key) => {
                const ct = CSV_TYPES.find(t=>t.key===key);
                const fd = files[key];
                if(!fd||!ct) return;
                setImporting(key);
                const total = key==='appointments' ? fd.allRows.length : fd.rowCount;
                setProgress(p=>({...p,[key]:{current:0,total}}));
                log(`Import: ${ct.label} (${total.toLocaleString('de-DE')} Zeilen)`, 'pending');
                const bid = crypto.randomUUID();
                try {
                    let mapped;
                    if(key==='leads') mapped = fd.rows.map(mapLead).filter(r=>!isNaN(r.lead_id));
                    else if(key==='appointments') mapped = fd.allRows;
                    else mapped = fd.rows.map(mapProv).filter(r=>!isNaN(r.an_nr));
                    mapped = mapped.map(r=>({...r, import_batch_id:bid}));
                    const res = await upsertBatch(ct.table, mapped, (c,t)=>setProgress(p=>({...p,[key]:{current:c,total:t}})));
                    setResults(p=>({...p,[key]:res}));
                    log(`‚úì ${ct.label}: ${res.inserted} neu, ${res.updated} aktualisiert${res.errors>0?`, ${res.errors} Fehler`:''}`, res.errors>0?'error':'success');
                    const fnames = key==='appointments' ? fd.fileList.map(f=>f.name).join(' + ') : fd.name;
                    await fetch(api('import_logs'),{method:'POST',headers:hdr(),body:JSON.stringify({batch_id:bid,csv_typ:key,dateiname:fnames,zeilen_gesamt:total,zeilen_neu:res.inserted,zeilen_aktualisiert:res.updated,zeilen_fehler:res.errors,fehler_details:res.errorDetails.length?res.errorDetails:null,finished_at:new Date().toISOString()})});
                    loadCounts();
                } catch(e) { log(`‚úó ${ct.label}: ${e.message}`,'error'); setResults(p=>({...p,[key]:{inserted:0,updated:0,errors:total,errorDetails:[{error:e.message}]}})); }
                setImporting(null);
            };

            const importAll = async () => { for(const k of ['leads','appointments','provisions']) if(files[k]) await importOne(k); };

            const clearAll = async () => {
                if(!confirm('‚ö†Ô∏è Alle Import-Daten l√∂schen?')) return;
                log('L√∂sche alle Daten...','pending');
                try {
                    for(const t of ['import_leads','import_appointments','import_provisions','import_logs']){
                        await fetch(api(t)+'?id=gte.0',{method:'DELETE',headers:hdr({'Prefer':'return=minimal'})});
                    }
                    await fetch(api('import_logs')+'?batch_id=neq.00000000-0000-0000-0000-000000000000',{method:'DELETE',headers:hdr({'Prefer':'return=minimal'})});
                    log('‚úì Daten gel√∂scht'); setResults({}); loadCounts();
                } catch(e){log(`‚úó ${e.message}`,'error');}
            };

            const fc = Object.keys(files).length;
            return (
                <React.Fragment>
                    <div className="header">
                        <div className="header-left">
                            <div className="logo">bee-doo <span>| Daten-Import Hub</span></div>
                            <div className="subtitle">CSV ‚Üí Supabase ¬∑ Duplikat-Erkennung</div>
                        </div>
                        <div className="header-right">
                            <a href="https://bee-doo-tools.vercel.app/" className="back-link">‚Üê Toolbox</a>
                        </div>
                    </div>
                    <div className="main">
                        {tablesOk===false && (
                            <div className="setup-banner fade-in">
                                <div className="setup-icon">‚ö†Ô∏è</div>
                                <div className="setup-text">
                                    <h3>Tabellen noch nicht erstellt</h3>
                                    <p>SQL-Schema im Supabase SQL Editor ausf√ºhren, bevor Daten importiert werden.</p>
                                </div>
                                <a href="https://supabase.com/dashboard/project/hqzpemfaljxcysyqssng/sql/new" target="_blank" className="btn btn-primary btn-sm" style={{whiteSpace:'nowrap'}}>SQL Editor ‚Üí</a>
                            </div>
                        )}
                        <div className="stats-row fade-in">
                            {[{l:'Leads',v:db.leads,s:'import_leads'},{l:'Termine',v:db.appointments,s:'import_appointments'},{l:'Auftr√§ge',v:db.provisions,s:'import_provisions'},{l:'Imports',v:db.logs,s:'import_logs'}].map(s=>(
                                <div key={s.l} className="stat-card"><div className="stat-label">{s.l} in DB</div><div className="stat-value">{s.v.toLocaleString('de-DE')}</div><div className="stat-sub">{s.s}</div></div>
                            ))}
                        </div>
                        <div className="import-grid">
                            {CSV_TYPES.map(ct=>(
                                <Card key={ct.key} ct={ct} fd={files[ct.key]} imp={importing===ct.key} prog={progress[ct.key]} res={results[ct.key]}
                                    onFile={f=>handleFile(ct.key,f)} onRemove={()=>removeFile(ct.key)} onImport={()=>importOne(ct.key)} tok={tablesOk} />
                            ))}
                        </div>
                        <div className="action-bar">
                            <button className="btn btn-primary" disabled={fc===0||importing!==null||!tablesOk} onClick={importAll}>
                                {importing?<React.Fragment><span className="spinner"/> Importiert...</React.Fragment>:<React.Fragment>üöÄ Alle importieren ({fc})</React.Fragment>}
                            </button>
                            <button className="btn btn-outline" onClick={()=>{loadCounts();log('Z√§hler aktualisiert');}}>üîÑ Aktualisieren</button>
                            <button className="btn btn-danger" onClick={clearAll} disabled={importing!==null}>üóë Alle Daten l√∂schen</button>
                        </div>
                        <div className="log-section">
                            <div className="log-title">üìä Import-Log</div>
                            {logs.length===0 ? <div className="log-empty">Noch keine Aktivit√§t ‚Äì CSV-Dateien hochladen um zu starten.</div> : (
                                <div className="log-entries">{logs.map(l=>(
                                    <div key={l.id} className="log-entry fade-in"><div className={`log-dot ${l.status}`}/><div className="log-time">{l.time}</div><div className="log-msg">{l.msg}</div></div>
                                ))}</div>
                            )}
                        </div>
                    </div>
                </React.Fragment>
            );
        }

        function Card({ ct, fd, imp, prog, res, onFile, onRemove, onImport, tok }) {
            const ref = useRef(null);
            const [drag,setDrag] = useState(false);
            const multi = ct.multi;
            const has = multi ? fd?.fileList?.length>0 : !!fd;

            const onDrop = (e) => { e.preventDefault(); setDrag(false); Array.from(e.dataTransfer.files).filter(f=>f.name.endsWith('.csv')).forEach(f=>onFile(f)); };
            const onInput = (e) => { Array.from(e.target.files).forEach(f=>onFile(f)); e.target.value=''; };

            const badge = () => {
                if(imp) return <span className="card-badge badge-importing"><span className="spinner" style={{width:10,height:10,borderWidth:1.5,marginRight:4}}/> Import</span>;
                if(res&&res.errors>0&&res.inserted===0) return <span className="card-badge badge-error">Fehler</span>;
                if(res) return <span className="card-badge badge-done">‚úì Fertig</span>;
                if(has) return <span className="card-badge badge-ready">Bereit</span>;
                return <span className="card-badge badge-empty">Keine Datei</span>;
            };

            const pct = prog ? Math.round((prog.current/prog.total)*100) : 0;
            const total = multi ? (fd?.rowCount||0) : (fd?.rowCount||0);

            return (
                <div className={`import-card ${has?'active':''}`}>
                    <div className="card-header">
                        <div className="card-title-area">
                            <div className={`card-icon ${ct.color}`}>{ct.icon}</div>
                            <div><div className="card-title">{ct.label}</div><div className="card-desc">{ct.desc}</div></div>
                        </div>
                        {badge()}
                    </div>

                    {multi && <div className="multi-hint">‚ö° Mehrere CSVs m√∂glich ‚Äì Closed √ºberschreibt Created bei gleicher TerminID</div>}

                    {(!has||(multi&&!res))&&!imp && (
                        <div className={`drop-zone ${drag?'dragover':''}`} onDragOver={e=>{e.preventDefault();setDrag(true);}} onDragLeave={()=>setDrag(false)} onDrop={onDrop} onClick={()=>ref.current?.click()}>
                            <div className="drop-zone-text">{multi?'Created + Closed CSVs':'CSV'} hierher ziehen oder <strong>klicken</strong></div>
                            <input ref={ref} type="file" accept=".csv" multiple={multi} onChange={onInput}/>
                        </div>
                    )}

                    {multi && fd?.fileList?.map((f,i) => (
                        <div key={i} className="file-info">
                            <div className="file-icon">{f.subtype==='closed'?'‚úÖ':'üìÑ'}</div>
                            <div className="file-details">
                                <div className="file-name">{f.name}</div>
                                <div className="file-meta">{f.rowCount.toLocaleString('de-DE')} Zeilen ¬∑ {(f.size/1024).toFixed(0)} KB ¬∑ {f.subtype}</div>
                            </div>
                        </div>
                    ))}

                    {!multi && fd && (
                        <div className="file-info">
                            <div className="file-icon">üìÑ</div>
                            <div className="file-details">
                                <div className="file-name">{fd.name}</div>
                                <div className="file-meta">{fd.rowCount.toLocaleString('de-DE')} Zeilen ¬∑ {(fd.size/1024).toFixed(0)} KB</div>
                            </div>
                            {!imp&&!res && <button className="file-remove" onClick={onRemove}>‚úï</button>}
                        </div>
                    )}

                    {multi && fd?.fileList?.length>1 && <div className="merge-info">‚Üí {fd.rowCount.toLocaleString('de-DE')} eindeutige Termine nach Merge</div>}

                    {imp && prog && (
                        <React.Fragment>
                            <div className="progress-bar"><div className="progress-fill" style={{width:`${pct}%`}}/></div>
                            <div className="progress-text"><span>{prog.current.toLocaleString('de-DE')} / {prog.total.toLocaleString('de-DE')}</span><span>{pct}%</span></div>
                        </React.Fragment>
                    )}

                    {res && (
                        <div className="result-summary">
                            <div className="result-item new"><div className="result-num">{res.inserted.toLocaleString('de-DE')}</div><div className="result-label">Neu</div></div>
                            <div className="result-item updated"><div className="result-num">{res.updated.toLocaleString('de-DE')}</div><div className="result-label">Aktualisiert</div></div>
                            <div className="result-item errors"><div className="result-num">{res.errors.toLocaleString('de-DE')}</div><div className="result-label">Fehler</div></div>
                        </div>
                    )}

                    {has&&!imp&&!res && <button className="btn btn-primary" style={{width:'100%',marginTop:12,justifyContent:'center'}} onClick={onImport} disabled={!tok}>‚ö° {total.toLocaleString('de-DE')} Zeilen importieren</button>}
                    {res&&!imp && <button className="btn btn-outline btn-sm" style={{width:'100%',marginTop:8,justifyContent:'center'}} onClick={onRemove}>‚Üª Neuen Import starten</button>}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
</body>
</html>
