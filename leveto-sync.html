<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bee-doo | Import Cockpit</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root{--a:#FDE154;--ad:rgba(253,225,84,.12);--bg:#08090d;--c:#111219;--ch:#16171f;--el:#1a1b24;--b:rgba(255,255,255,.06);--ba:rgba(253,225,84,.2);--t:#d8dae2;--td:#6b7280;--tb:#f3f4f6;--g:#22c55e;--gd:rgba(34,197,94,.12);--r:#ef4444;--rd:rgba(239,68,68,.12);--o:#f59e0b;--od:rgba(245,158,11,.12);--bl:#3b82f6;--bld:rgba(59,130,246,.12)}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t);min-height:100vh}
        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
        @keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}@keyframes sp{to{transform:rotate(360deg)}}@keyframes pu{0%,100%{opacity:1}50%{opacity:.5}}
        .fi{animation:fi .3s ease-out}.spinner{width:13px;height:13px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:sp .6s linear infinite;display:inline-block}
        .hdr{padding:14px 28px;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(253,225,84,.02) 0%,transparent 100%)}
        .hdr-l{display:flex;align-items:center;gap:14px}.logo{font-size:18px;font-weight:700;color:var(--a);letter-spacing:-.5px}.logo span{color:var(--td);font-weight:400;font-size:15px}
        .hdr-lk{font-size:12px;color:var(--td);text-decoration:none;padding:5px 10px;border-radius:6px;border:1px solid var(--b);transition:all .2s}.hdr-lk:hover{color:var(--a);border-color:var(--ba);background:var(--ad)}
        .tabs{display:flex;gap:2px;padding:0 28px;background:var(--bg);border-bottom:1px solid var(--b)}
        .tab{padding:12px 20px;font-size:13px;font-weight:500;color:var(--td);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;display:flex;align-items:center;gap:8px}.tab:hover{color:var(--t)}.tab.on{color:var(--a);border-bottom-color:var(--a)}
        .mn{max-width:1440px;margin:0 auto;padding:24px 28px}
        .sts{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin-bottom:24px}
        .st{background:var(--c);border:1px solid var(--b);border-radius:10px;padding:16px 18px;transition:all .2s}.st:hover{border-color:var(--ba)}
        .st-l{font-size:10px;color:var(--td);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}.st-v{font-size:24px;font-weight:700;color:var(--tb)}.st-s{font-size:10px;color:var(--td);margin-top:2px}
        .cd{background:var(--c);border:1px solid var(--b);border-radius:12px;padding:20px;margin-bottom:16px}
        .cd-t{font-size:15px;font-weight:600;color:var(--tb);display:flex;align-items:center;gap:8px;margin-bottom:14px}
        .btn{padding:9px 18px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:7px}
        .by{background:var(--a);color:#000}.by:hover:not(:disabled){background:#ffe566;box-shadow:0 4px 12px rgba(253,225,84,.25)}.by:disabled{opacity:.35;cursor:not-allowed}
        .bo{background:transparent;color:var(--t);border:1px solid var(--b)}.bo:hover{border-color:var(--ba);color:var(--a)}
        .br{background:var(--rd);color:var(--r);border:1px solid rgba(239,68,68,.15)}.br:hover{background:rgba(239,68,68,.2)}
        .bsm{padding:6px 12px;font-size:11px}.brow{display:flex;gap:10px;flex-wrap:wrap}
        .lb{background:var(--el);border-radius:8px;padding:14px;max-height:260px;overflow-y:auto;font-size:12px;font-family:monospace;line-height:1.8}
        .lb .tm{color:var(--td)}.lb .info{color:var(--t)}.lb .success{color:var(--g)}.lb .warn{color:var(--o)}.lb .error{color:var(--r)}
        .pb{height:4px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden;margin:10px 0 4px}.pf{height:100%;background:linear-gradient(90deg,var(--a),#ffe566);border-radius:2px;transition:width .3s}
        .pt{font-size:11px;color:var(--td);display:flex;justify-content:space-between}
        .mt{width:100%;border-collapse:collapse;font-size:12px}.mt th{text-align:left;padding:8px 12px;color:var(--td);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--b)}
        .mt td{padding:7px 12px;border-bottom:1px solid var(--b)}.mt tr:last-child td{border:none}
        .tg{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:500}.tg-ok{background:var(--gd);color:var(--g)}.tg-w{background:var(--od);color:var(--o)}.tg-m{background:var(--rd);color:var(--r)}
        .ig{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:18px}
        .ic{background:var(--c);border:1px solid var(--b);border-radius:12px;padding:18px;transition:all .2s;position:relative;overflow:hidden}
        .ic::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--a);opacity:0;transition:opacity .3s}.ic:hover::before{opacity:1}.ic.on{border-color:var(--a)}.ic.on::before{opacity:1}
        .ich{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .ict{display:flex;align-items:center;gap:10px}.ici{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
        .icn{font-size:14px;font-weight:600;color:var(--tb)}.icd{font-size:11px;color:var(--td);margin-top:1px}
        .icb{font-size:10px;padding:2px 8px;border-radius:12px;font-weight:500}
        .dz{border:2px dashed rgba(255,255,255,.08);border-radius:8px;padding:18px;text-align:center;cursor:pointer;transition:all .3s;font-size:12px;color:var(--td)}
        .dz:hover,.dz.dv{border-color:var(--a);background:var(--ad)}.dz strong{color:var(--a)}.dz input{display:none}
        .fi2{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--el);border-radius:6px;margin-top:6px;font-size:11px}
        .fi2-n{color:var(--tb);font-weight:500}.fi2-m{color:var(--td)}.fi2-x{background:none;border:none;color:var(--td);cursor:pointer;font-size:13px;margin-left:auto}.fi2-x:hover{color:var(--r)}
        .mh{font-size:11px;color:var(--a);background:var(--ad);padding:5px 8px;border-radius:5px;margin-bottom:8px;text-align:center}
        .rg{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-top:8px}
        .ri{padding:7px;border-radius:6px;text-align:center}.ri.nw{background:var(--gd)}.ri.up{background:var(--bld)}.ri.er{background:var(--rd)}
        .rn{font-size:16px;font-weight:700}.ri.nw .rn{color:var(--g)}.ri.up .rn{color:var(--bl)}.ri.er .rn{color:var(--r)}.rl{font-size:9px;color:var(--td);margin-top:1px}
        .eg{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        .mg{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:18px}
        .mc{background:var(--c);border:1px solid var(--b);border-radius:12px;padding:18px;text-align:center}
        .mv{font-size:28px;font-weight:700;color:var(--a);margin:8px 0}.ml{font-size:12px;color:var(--td)}
        @media(max-width:1100px){.ig,.eg{grid-template-columns:1fr 1fr}.mg{grid-template-columns:1fr}}
        @media(max-width:768px){.mn{padding:14px}.tabs{padding:0 14px;overflow-x:auto}.tab{padding:10px 14px;font-size:12px;white-space:nowrap}.sts{grid-template-columns:1fr 1fr}.ig,.eg{grid-template-columns:1fr}.hdr{padding:12px 14px}}
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback}=React;
if(typeof pdfjsLib!=='undefined')pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
const SU='https://hqzpemfaljxcysyqssng.supabase.co';
const SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
const LU='/api/leveto-proxy';const LN='api@bee-doo.de';const LP='Patrick123456789!';
const B=50;const ap=t=>`${SU}/rest/v1/${t}`;const hd=(x={})=>({apikey:SK,Authorization:`Bearer ${SK}`,'Content-Type':'application/json',...x});

// CSV Parser
function parseCSV(t){const ls=[];let c='',q=false;for(let i=0;i<t.length;i++){const ch=t[i];if(ch==='"'){if(q&&t[i+1]==='"'){c+='"';i++}else q=!q}else if((ch==='\n'||ch==='\r')&&!q){if(c.length>0||ls.length>0){ls.push(c);c=''}if(ch==='\r'&&t[i+1]==='\n')i++}else c+=ch}if(c.length>0)ls.push(c);const sp=l=>{const cs=[];let cl='',q2=false;for(let i=0;i<l.length;i++){const ch=l[i];if(ch==='"'){if(q2&&l[i+1]==='"'){cl+='"';i++}else q2=!q2}else if(ch===','&&!q2){cs.push(cl.trim());cl=''}else cl+=ch}cs.push(cl.trim());return cs};if(!ls.length)return[];const h=sp(ls[0].replace(/^\uFEFF/,''));return ls.slice(1).filter(l=>l.trim()).map(l=>{const c2=sp(l);const o={};h.forEach((k,i)=>o[k]=c2[i]||'');return o})}

// ‚ïê‚ïê‚ïê AUTO-SYNC COMPONENT ‚ïê‚ïê‚ïê
const CRON_LABELS={'0 */4 * * *':'Alle 4 Stunden','0 6 * * *':'T√§glich 06:00','0 7 * * 1':'Montags 07:00','30 6 * * *':'T√§glich 06:30','0 8 1 * *':'1. des Monats 08:00','‚Äî manuell ‚Äî':'Kein Auto-Sync'};
const CRON_OPTIONS=[{v:'0 6 * * *',l:'T√§glich 06:00'},{v:'0 7 * * *',l:'T√§glich 07:00'},{v:'0 8 * * *',l:'T√§glich 08:00'},{v:'0 */4 * * *',l:'Alle 4 Stunden'},{v:'0 7 * * 1',l:'Montags 07:00'},{v:'30 6 * * *',l:'T√§glich 06:30'},{v:'0 */2 * * *',l:'Alle 2 Stunden'},{v:'0 12 * * *',l:'T√§glich 12:00'}];
const SRK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTMzNTM5NywiZXhwIjoyMDg2OTExMzk3fQ.MJ3cyAAquE8DK2ngzfIIn4bTpQ8_H9DaeJ3YTlBdFz4';
function AutoSync({syncKey,log,extraConfig}){
    const[cfg,setCfg]=useState(null);const[loading,setLoading]=useState(true);const[saving,setSaving]=useState(false);
    const load=useCallback(async()=>{try{const r=await fetch(ap('sync_configs')+`?sync_key=eq.${syncKey}&select=*`,{headers:hd()});const d=await r.json();if(d.length)setCfg(d[0])}catch(e){}setLoading(false)},[syncKey]);
    useEffect(()=>{load()},[load]);
    const toggle=async()=>{if(!cfg)return;setSaving(true);
        const newEnabled=!cfg.enabled;const upd={enabled:newEnabled,updated_at:new Date().toISOString()};
        if(extraConfig)upd.config={...cfg.config,...extraConfig};
        try{await fetch(ap('sync_configs')+`?sync_key=eq.${syncKey}`,{method:'PATCH',headers:{...hd(),Authorization:`Bearer ${SRK}`},body:JSON.stringify(upd)});
            setCfg(p=>({...p,...upd}));log?.(`${newEnabled?'‚úÖ':'‚è∏Ô∏è'} Auto-Sync ${newEnabled?'aktiviert':'deaktiviert'}: ${cfg.sync_name}`,newEnabled?'success':'warn');
        }catch(e){log?.(`‚ùå Fehler: ${e.message}`,'error')}setSaving(false)};
    const updateSchedule=async(newCron)=>{if(!cfg)return;setSaving(true);
        try{await fetch(ap('sync_configs')+`?sync_key=eq.${syncKey}`,{method:'PATCH',headers:{...hd(),Authorization:`Bearer ${SRK}`},body:JSON.stringify({cron_schedule:newCron,updated_at:new Date().toISOString()})});
            setCfg(p=>({...p,cron_schedule:newCron}));log?.(`üïê Zeitplan ge√§ndert: ${CRON_LABELS[newCron]||newCron}`,'success');
        }catch(e){log?.(`‚ùå ${e.message}`,'error')}setSaving(false)};
    const fmtDate=d=>d?new Date(d).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
    if(loading)return <div style={{fontSize:11,color:'var(--td)',padding:8}}>Lade Sync-Config...</div>;
    if(!cfg)return null;
    const isManual=cfg.cron_schedule==='‚Äî manuell ‚Äî';
    return(<div style={{background:'var(--el)',borderRadius:10,padding:14,marginTop:14,border:`1px solid ${cfg.enabled?'rgba(34,197,94,.3)':'var(--b)'}`}}>
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:cfg.enabled?10:0}}>
            <div style={{display:'flex',alignItems:'center',gap:10}}>
                <div style={{width:8,height:8,borderRadius:'50%',background:cfg.enabled?'var(--g)':'var(--td)',boxShadow:cfg.enabled?'0 0 8px rgba(34,197,94,.5)':'none'}}/>
                <div><div style={{fontSize:13,fontWeight:600,color:'var(--tb)'}}>‚è±Ô∏è Auto-Sync: {cfg.sync_name}</div>
                    <div style={{fontSize:11,color:'var(--td)',marginTop:2}}>{isManual?'Manueller Upload n√∂tig ‚Äî kein automatischer Sync m√∂glich':`Zeitplan: ${CRON_LABELS[cfg.cron_schedule]||cfg.cron_schedule}`}</div></div>
            </div>
            {!isManual&&<button className={`btn bsm ${cfg.enabled?'br':'bo'}`} disabled={saving} onClick={toggle} style={{minWidth:100}}>
                {saving?<span className="spinner"/>:cfg.enabled?'‚è∏Ô∏è Deaktivieren':'‚ñ∂Ô∏è Aktivieren'}
            </button>}
        </div>
        {cfg.enabled&&!isManual&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10,fontSize:11}}>
            <div style={{background:'var(--c)',borderRadius:6,padding:8}}><div style={{color:'var(--td)'}}>Letzter Sync</div><div style={{color:'var(--g)',fontWeight:600,marginTop:2}}>{fmtDate(cfg.last_sync_at)}</div></div>
            <div style={{background:'var(--c)',borderRadius:6,padding:8}}><div style={{color:'var(--td)'}}>Zeitplan</div>
                <select value={cfg.cron_schedule} onChange={e=>updateSchedule(e.target.value)} style={{background:'transparent',color:'var(--a)',border:'none',fontSize:11,fontWeight:600,fontFamily:'DM Sans',cursor:'pointer',marginTop:2,width:'100%'}}>
                    {CRON_OPTIONS.map(o=><option key={o.v} value={o.v} style={{background:'var(--c)'}}>{o.l}</option>)}
                </select>
            </div>
            <div style={{background:'var(--c)',borderRadius:6,padding:8}}><div style={{color:'var(--td)'}}>Status</div><div style={{color:cfg.last_sync_result?.error?'var(--r)':'var(--g)',fontWeight:600,marginTop:2}}>{cfg.last_sync_result?.error?'‚ùå Fehler':'‚úÖ OK'}</div></div>
        </div>}
    </div>);
}

// Mappers
const pI=v=>{const n=parseInt(String(v).replace(/[^0-9-]/g,''));return isNaN(n)?0:n};const cl=v=>v&&v.trim()?v.trim():null;
function mL(r){return{lead_id:parseInt(r['Lead ID']),leadstatus:cl(r['Leadstatus']),mitarbeiter:cl(r['Mitarbeiter/Berater']),indikator:cl(r['Indikator']),letzter_bearbeitungsstatus:cl(r['LetzterBearbeitungsstatus']),projektstatus:cl(r['Projektstatus']),anrede:cl(r['Anrede']),vorname:cl(r['Vorname']),nachname:cl(r['Nachname']),name:cl(r['Name']),firma:cl(r['Firma']),strasse:cl(r['Strasse']),hausnummer:cl(r['Hausnummer']),plz:cl(r['PLZ']),ort:cl(r['Ort']),telefon:cl(r['Telefon']),mobil:cl(r['Mobil']),email:cl(r['E-Mail']),quelle:cl(r['Quelle']),projekt:cl(r['Projekt']),gruppe:cl(r['Gruppe']),anmerkung:cl(r['Anmerkung']),tags:cl(r['Tags']),erreichbarkeit:cl(r['Erreichbarkeit']),nicht_erreicht:pI(r['Nicht erreicht']),rueckruf:cl(r['R√ºckruf']),importiert:cl(r['Importiert']),verifizierung:cl(r['Verifizierung']),aktive_wiedervorlagen:pI(r['Aktive Wiedervorlagen']),mvpp_name:cl(r['MVPP-Name']),mvpp_id:cl(r['MVPP-ID']),qualitaetscall:cl(r['Qualit√§tscall']),qualitaetscall_notizen:cl(r['Qualit√§tscall Notizen']),externe_lead_id:cl(r['externeLeadID']),externe_lead_id_2:cl(r['externeLeadID 2']),externe_lead_id_3:cl(r['externeLeadID 3']),zuweisungsstatus:cl(r['Zuweisungsstatus']),qcells_zahlungsstatus:cl(r['Q-CellsZahlungsstatus']),qcells_fortschritt:cl(r['Q-CellsFortschritt']),lieferdatum:cl(r['Lieferdatum']),auftragsbestaetigung:cl(r['Auftragsbest√§tigung']),slots_verfuegbar:cl(r['Slots verf√ºgbar']),importierte_medien:pI(r['ImportierteMedien']),datum_qualifiziert:cl(r['Datum Qualifiziert']),datum_abgeschlossen:cl(r['Datumabgeschlossen']),datum_importiert:cl(r['Datumimportiert'])}}
function mA(r,q){return{termin_id:parseInt(r['TerminID']),lead_id:parseInt(r['LEADID'])||null,extern_id:cl(r['EXTERNID']),csv_quelle:q,leadquelle:cl(r['Leadquelle']),mvpp_name:cl(r['MVPP - NAME']),mvpp_id:cl(r['MVPP - ID']),leadkunde:cl(r['Leadkunde']),leadadresse:cl(r['Leadadresse']),terminiert_von:cl(r['Terminiertvon']),terminiert_an_name:cl(r['Terminiert anName']),terminiert_an_email:cl(r['Terminiert anE-Mail']),terminstatus:cl(r['Terminstatus']),aktueller_status:cl(r['AktuellerStatus']),angebotsstatus:cl(r['Angebotsstatus']),angebot_angenommen:cl(r['Angebot angenommen']),provisionsstatus:cl(r['Provisionsstatus']),terminausfall_begruendung:cl(r['TerminausfallBegr√ºndung']),abschlussstatus:cl(r['Abschlussstatus']),abschlussbemerkung:cl(r['Abschlussbemerkung']),bestaetigt_durch:cl(r['Best√§tigt Durch']),indikator:cl(r['Indikator']),datum_terminerstellung:cl(r['DatumTerminerstellung']),datum_termin_beginn:cl(r['DatumTermin Beginn']),datum_termin_ende:cl(r['DatumTermin Ende']),datum_abgeschlossen:cl(r['DatumAbgeschlossen']),datum_bestaetigt_partner:cl(r['DatumBest√§tigt Partner']),datum_bestaetigt_kunde:cl(r['DatumBest√§tigt Kunde'])}}
function mP(r){return{an_nr:parseInt(r['AN Nr.']),lead_id:parseInt(r['Lead ID'])||null,auftragsstatus:cl(r['Auftragsstatus']),typ:cl(r['Typ']),speichererweiterung:cl(r['Speichererweiterung']),dokumentstatus:cl(r['Dokumentstatus']),beedoo_fortschritt:cl(r['BeeDooFortschritt']),workflow_history:cl(r['WorkflowHistory']),ablehnung_freigabe_grund:cl(r['Ablehnung FreigabeGrund']),angebot_erstellt_von:cl(r['Angebot erstellt von']),kundenberater:cl(r['Kundenberater']),vp_nummer:cl(r['VP Nummer']),mvpp_id:cl(r['MVPP-ID']),mvpp_name:cl(r['MVPP-Name']),termine_agenten:cl(r['Termine Agenten']),termine_berater:cl(r['Termine Berater']),kunde:cl(r['Kunde']),kunde_plz:cl(r['Kunde PLZ']),kundennummer:cl(r['Kundennummer']),quelle:cl(r['Quelle']),an_wert_netto:cl(r['AN-WertNetto']),auszahlungsrelevant:cl(r['Auszahlungsrelevant']),ausgezahlt_am:cl(r['Ausgezahlt am']),efs_prozent:cl(r['EFS %']),finanzierung_gewuenscht:cl(r['Finanzierung gew√ºnscht']),angebot_kwp:cl(r['Angebot KWP']),angebot_module:cl(r['Angebot Module']),angebot_solarmodule:cl(r['Angebot Solarmodule']),angebot_batteriekapazitaet:cl(r['Angebot Batteriekapazit√§t Gesamt']),metrify:cl(r['Metrify']),lieferdatum:cl(r['Lieferdatum']),auftragsbestaetigung:cl(r['Auftragsbest√§tigung']),datum_erstellt:cl(r['DatumErstellt']),datum_an_kunde_gesendet:cl(r['DatumAn Kunde gesendet']),datum_gelesen:cl(r['DatumGelesen']),datum_angenommen:cl(r['DatumAngenommen']),zeit_vergangen:cl(r['Zeit vergangennach Kundenbenachrichtigung'])}}

// Supabase
async function sCnt(t){const r=await fetch(ap(t)+'?select=id&limit=0',{headers:{...hd(),'Prefer':'count=exact'}});const rng=r.headers.get('content-range');return rng?parseInt(rng.split('/')[1])||0:0}
async function uBat(t,rows,onP){let ins=0,upd=0,er=0;const eD=[];for(let i=0;i<rows.length;i+=B){const b=rows.slice(i,i+B);try{const r=await fetch(ap(t),{method:'POST',headers:{...hd(),'Prefer':'resolution=merge-duplicates,return=representation'},body:JSON.stringify(b)});if(!r.ok){er+=b.length;eD.push({error:(await r.text()).substring(0,300)})}else{(await r.json()).forEach(x=>{if(x.created_at===x.updated_at)ins++;else upd++})}}catch(e){er+=b.length;eD.push({error:e.message})}onP?.(Math.min(i+B,rows.length),rows.length)}return{inserted:ins,updated:upd,errors:er,errorDetails:eD}}

// Leveto
let lTk=null,lEx=0;
async function lAuth(retry=0){if(lTk&&Date.now()<lEx-30000)return lTk;try{const r=await fetch(LU+'?path=auth',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`username=${encodeURIComponent(LN)}&password=${encodeURIComponent(LP)}`});if(!r.ok)throw new Error(`HTTP ${r.status}: ${await r.text().catch(()=>'')}`);const d=await r.json();if(!d.login)throw new Error('Leveto Auth: '+d.message);lTk=d.token;lEx=Date.now()+4.5*60*1000;return lTk}catch(e){if(retry<2){await new Promise(r=>setTimeout(r,1000*(retry+1)));return lAuth(retry+1)}throw new Error(`Auth fehlgeschlagen (${retry+1} Versuche): ${e.message}`)}}
async function lGet(p={},retry=0){const tk=await lAuth();const qs=new URLSearchParams({path:'leads',...p}).toString();try{const r=await fetch(`${LU}?${qs}`,{headers:{Authorization:`Bearer ${tk}`}});if(!r.ok)throw new Error(`HTTP ${r.status}`);return await r.json()}catch(e){if(retry<2){await new Promise(r=>setTimeout(r,1000*(retry+1)));lTk=null;return lGet(p,retry+1)}throw new Error(`Leads-Abruf fehlgeschlagen (${retry+1} Versuche): ${e.message}`)}}
function lMap(l){const a=l.homeAddress||{},s=l.status||{},sf=l.statusFirst||{},sv=l.survey||{};let sd=null;if(sv.data&&Array.isArray(sv.data)){sd={};sv.data.forEach(x=>{if(x.answer)sd[(x.question||'').replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü]/g,'_').toLowerCase()]=x.answer})}return{leveto_id:l.id,id_extern:l.idExtern||null,anrede:l.salutation||null,vorname:(l.firstName||'').trim(),nachname:(l.lastName||'').trim(),firma:l.companyName||null,email:l.email||null,telefon:l.telephone||null,telefon2:l.telephone2||null,mobil:l.mobile||null,erreichbarkeit:l.reachability||null,strasse:a.fullstreet||a.street||null,hausnr:a.housenr||null,plz:a.postalCode||null,ort:a.city||null,lat:a.lat||null,lng:a.lng||null,quelle:l.source||null,tags:l.tags||null,berater_name:l.berater||null,berater_ma_nummer:l.ma_nummer||null,notizen:l.notes||null,nachricht:l.message||null,status_id:s.id??null,status_name:s.name||null,status_indicator:s.indicator||null,status_datum:s.date&&s.date!=='0000-00-00 00:00:00'?s.date:null,erster_status_id:sf.id??null,erster_status_name:sf.name||null,erster_status_datum:sf.date&&sf.date!=='0000-00-00 00:00:00'?sf.date:null,letzter_status_wechsel:l.last_status_change&&l.last_status_change!=='0000-00-00 00:00:00'?l.last_status_change:null,zuweisungsstatus:l.zuweisungsstatus||null,assignments_count:l.assignmentsCount||0,accepted_count:l.acceptedCount||0,declined_count:l.declinedCount||0,objekt_typ:l.objectType||null,personen_haushalt:l.personsInHousehold||null,dach_groesse:l.roofSize||null,dach_form:l.roofShape||null,stromverbrauch:l.powerConsumption||null,monatl_abschlag:l.partPayment||null,finanzierung:l.financingModel||null,survey_data:sd?JSON.stringify(sd):null,opt_in_bestaetigt:l.optIn?.confirmed||false,leveto_erstellt_am:l.createdOn&&l.createdOn!=='0000-00-00 00:00:00'?l.createdOn:null,leveto_importiert_am:l.importedOn&&l.importedOn!=='0000-00-00 00:00:00'?l.importedOn:null,leveto_abgeschlossen_am:l.finishedOn&&l.finishedOn!=='0000-00-00 00:00:00'?l.finishedOn:null,leveto_letzte_bearbeitung:l.lastEditOn&&l.lastEditOn!=='0000-00-00 00:00:00'?l.lastEditOn:null,sync_aktualisiert_am:new Date().toISOString()}}

// ‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê
function App(){
    const[tab,setTab]=useState('leveto');
    const[ct,setCt]=useState({leveto:'-',efs:'-',leads:'-',termine:'-',auftraege:'-',bank:'-',lohnjournal:'-',lohnsheet:'-'});
    const[logs,setLogs]=useState([]);
    const log=useCallback((m,l='info')=>setLogs(p=>[{t:new Date().toLocaleTimeString('de-DE'),m,l,id:Date.now()+Math.random()},...p].slice(0,100)),[]);
    const rc=useCallback(async()=>{try{const[a,b,c,d,e,f,g,h]=await Promise.allSettled([sCnt('leveto_leads'),sCnt('efs_projekte'),sCnt('import_leads'),sCnt('import_appointments'),sCnt('import_provisions'),sCnt('bank_transactions'),sCnt('lohnjournal_imports'),sCnt('lohn_sheet_data')]);setCt({leveto:a.status==='fulfilled'?a.value:'-',efs:b.status==='fulfilled'?b.value:'-',leads:c.status==='fulfilled'?c.value:'-',termine:d.status==='fulfilled'?d.value:'-',auftraege:e.status==='fulfilled'?e.value:'-',bank:f.status==='fulfilled'?f.value:'-',lohnjournal:g.status==='fulfilled'?g.value:'-',lohnsheet:h.status==='fulfilled'?h.value:'-'})}catch(e){log('Count-Fehler: '+e.message,'error')}},[log]);
    useEffect(()=>{rc()},[rc]);
    const fm=v=>typeof v==='number'?v.toLocaleString('de-DE'):v;
    const TS=[{k:'leveto',l:'Leveto Sync',i:'üîÑ'},{k:'efs',l:'EFS Sync',i:'üìä'},{k:'csv',l:'CSV Import',i:'üìã'},{k:'bank',l:'Bank / EBICS',i:'üè¶'},{k:'lohnjournal',l:'Lohnjournal',i:'üíº'},{k:'lohnsheet',l:'Lohn Sheet',i:'üìä'},{k:'merge',l:'Auto-Merge',i:'üîó'}];
    return(<React.Fragment>
        <div className="hdr"><div className="hdr-l"><div className="logo"><img src="https://bee-doo-tools.vercel.app/bee-doo-Logo-white.svg" style={{height:28}} alt="bee-doo" /> <span>Import Cockpit</span></div></div><a href="https://bee-doo-tools.vercel.app/" className="hdr-lk">‚Üê Toolbox</a></div>
        <div className="tabs">{TS.map(t=><div key={t.k} className={`tab ${tab===t.k?'on':''}`} onClick={()=>setTab(t.k)}>{t.i} {t.l}</div>)}</div>
        <div className="mn">
            <div className="sts fi">{[{l:'Leveto Leads',v:ct.leveto,s:'leveto_leads'},{l:'EFS Projekte',v:ct.efs,s:'efs_projekte'},{l:'CSV Leads',v:ct.leads,s:'import_leads'},{l:'CSV Termine',v:ct.termine,s:'import_appointments'},{l:'CSV Auftr√§ge',v:ct.auftraege,s:'import_provisions'},{l:'Bank Trans.',v:ct.bank,s:'bank_transactions'},{l:'Lohnjournal',v:ct.lohnjournal,s:'lohnjournal_imports'},{l:'Lohn Sheet',v:ct.lohnsheet,s:'lohn_sheet_data'}].map(s=><div key={s.l} className="st"><div className="st-l">{s.l}</div><div className="st-v">{fm(s.v)}</div><div className="st-s">{s.s}</div></div>)}</div>
            {tab==='leveto'&&<LT log={log} rc={rc}/>}
            {tab==='efs'&&<ET log={log} rc={rc}/>}
            {tab==='csv'&&<CT log={log} rc={rc}/>}
            {tab==='bank'&&<BKT log={log} rc={rc}/>}
            {tab==='lohnjournal'&&<LJT log={log} rc={rc}/>}
            {tab==='lohnsheet'&&<LST log={log} rc={rc}/>}
            {tab==='merge'&&<MT log={log} rc={rc} ct={ct}/>}
            <div className="cd" style={{marginTop:16}}><div className="cd-t">üìä Activity Log</div>
                <div className="lb">{logs.length===0&&<div style={{color:'var(--td)',textAlign:'center',padding:20}}>Noch keine Aktivit√§t</div>}{logs.map(l=><div key={l.id}><span className="tm">[{l.t}]</span> <span className={l.l}>{l.m}</span></div>)}</div>
            </div>
        </div>
    </React.Fragment>);
}

// ‚ïê‚ïê‚ïê LEVETO TAB ‚ïê‚ïê‚ïê
function LT({log,rc}){
    const[run,setRun]=useState(false);const[prog,setProg]=useState(null);const ab=useRef(false);
    const sync=async(mode)=>{if(run)return;setRun(true);ab.current=false;const bs=500;const RL=14;const RLPAUSE=22000;log(`üöÄ Leveto ${mode==='full'?'Voll':'Inkrement'}-Sync (500er Batches)`,'warn');
        try{const p=mode==='full'?{limit:1}:{limit:1,lastEditFrom:new Date(Date.now()-25*3600000).toISOString().split('T')[0]};const f=await lGet(p);const tot=f.totalrecords;log(`üìä ${tot.toLocaleString()} Leads ${mode==='full'?'total':'ge√§ndert'}`);
            let sy=0,pg=1,reqCount=0;while(!ab.current){const off=(pg-1)*bs;if(off>=tot)break;const fp=mode==='full'?{limit:bs,offset:off}:{limit:bs,offset:off,lastEditFrom:new Date(Date.now()-25*3600000).toISOString().split('T')[0]};let d;try{d=await lGet(fp);reqCount++}catch(fe){log(`‚ö†Ô∏è Fetch error: ${fe.message}, warte 20s...`,'warn');await new Promise(r=>setTimeout(r,RLPAUSE));lTk=null;lEx=0;try{d=await lGet(fp);reqCount++}catch(fe2){throw fe2}};if(d.msg==='maximum_requests_exceeded'||d.allowed===false){log(`‚è≥ Rate-Limit bei ${sy.toLocaleString()} ‚Äî 22s Pause...`,'warn');await new Promise(r=>setTimeout(r,RLPAUSE));lTk=null;lEx=0;continue};if(!d.leads||!d.leads.length){log(`‚ö†Ô∏è Keine Leads bei offset ${off}, keys: ${Object.keys(d).join(',')}`,'warn');break};const rows=d.leads.map(lMap);const r=await fetch(ap('leveto_leads')+'?on_conflict=leveto_id',{method:'POST',headers:{apikey:SRK,Authorization:`Bearer ${SRK}`,'Content-Type':'application/json','Prefer':'resolution=merge-duplicates'},body:JSON.stringify(rows)});if(!r.ok)throw new Error('Supabase: '+await r.text());sy+=rows.length;setProg({c:sy,t:tot,p:Math.round(sy/tot*100)});log(`üì¶ ${sy.toLocaleString()} / ${tot.toLocaleString()}`);pg++;if(reqCount>=RL){log(`‚è≥ Rate-Limit Pause (${reqCount} Requests)...`,'warn');await new Promise(r=>setTimeout(r,RLPAUSE));reqCount=0}else{await new Promise(r=>setTimeout(r,300))}}
            log(ab.current?`‚èπ Abgebrochen bei ${sy}`:`‚úÖ ${sy.toLocaleString()} Leads gesynct`,ab.current?'warn':'success');
        }catch(e){log(`‚ùå Leveto: ${e.message}`,'error')}setRun(false);setProg(null);rc()};
    return(<React.Fragment>
        <div className="cd fi"><div className="cd-t">üîÑ Leveto ‚Üí Supabase Sync</div>
            <div className="brow" style={{marginBottom:14}}>
                <button className="btn by" disabled={run} onClick={()=>sync('full')}>{run?<React.Fragment><span className="spinner"/> Sync l√§uft...</React.Fragment>:'Voll-Sync starten'}</button>
                <button className="btn bo" disabled={run} onClick={()=>sync('incr')}>Inkrementell (24h)</button>
                {run&&<button className="btn br" onClick={()=>{ab.current=true}}>‚èπ Stop</button>}
            </div>
            {prog&&<React.Fragment><div className="pb"><div className="pf" style={{width:`${prog.p}%`}}/></div><div className="pt"><span>{prog.c.toLocaleString()} / {prog.t.toLocaleString()}</span><span>{prog.p}%</span></div></React.Fragment>}
        </div>
        <div className="cd fi"><div className="cd-t">üó∫Ô∏è Feld-Mapping</div>
            <table className="mt"><thead><tr><th>Leveto</th><th>‚Üí Supabase</th><th>Status</th><th>Nutzen</th></tr></thead><tbody>
                {[['id','leveto_id','ok','Unique Key'],['idExtern','id_extern','ok','MVPP-ID'],['firstName + lastName','vorname, nachname','ok','Kontakt'],['homeAddress.*','strasse, plz, ort, lat, lng','ok','Geo'],['telephone, mobile, email','telefon, mobil, email','ok','Kontakt'],['berater','berater_name','ok','VT-Zuordnung'],['source','quelle','ok','Lead-Quelle'],['status.*','status_name, indicator','ok','Status'],['survey.data','survey_data (JSON)','ok','Details'],['‚Äî','kWp','m','Anlagengr√∂√üe (EFS/CSV)'],['‚Äî','Auftragswert','m','Vertragssumme (EFS/CSV)']].map((r,i)=><tr key={i}><td style={{color:'var(--tb)'}}>{r[0]}</td><td>{r[1]}</td><td><span className={`tg tg-${r[2]}`}>{r[2]==='ok'?'‚úÖ Sync':'‚ùå Fehlt'}</span></td><td style={{color:'var(--td)'}}>{r[3]}</td></tr>)}
            </tbody></table>
        </div>
        <div className="cd fi"><div className="cd-t">üìä Status-Mapping</div>
            <table className="mt"><thead><tr><th>Leveto</th><th>‚Üí bee-doo</th><th>Provision?</th></tr></thead><tbody>
                {[['Neuer Lead','Neuer Lead','‚Äî'],['WVL','Wiedervorlage','‚Äî'],['Terminiert','Termin gelegt','‚ö° Z√§hlt!'],['Angebot erstellt','Angebot','‚ö° Z√§hlt!'],['Angebot angenommen','Auftrag','üí∞ Auszahlung'],['AB erstellt','AB erstellt','üí∞ Auszahlung'],['Rechnung beglichen','Abgeschlossen','üí∞ Bezahlt'],['STORNO','Storniert','üî¥ R√ºckford.'],['Kein Interesse','Ausfall','‚Äî']].map((r,i)=><tr key={i}><td style={{color:'var(--tb)'}}>{r[0]}</td><td>{r[1]}</td><td>{r[2]}</td></tr>)}
            </tbody></table>
        </div>
        <AutoSync syncKey="leveto_sync" log={log}/>
    </React.Fragment>);
}

// ‚ïê‚ïê‚ïê EFS TAB ‚ïê‚ïê‚ïê
function ET({log,rc}){
    const[run,setRun]=useState(false);const[res,setRes]=useState(null);const[csv,setCsv]=useState(null);
    useEffect(()=>{fetch(`${SU}/storage/v1/object/public/efs-exports/latest.csv`,{method:'HEAD'}).then(r=>{if(r.ok)setCsv({url:`${SU}/storage/v1/object/public/efs-exports/latest.csv`,d:r.headers.get('last-modified')})}).catch(()=>{})},[]);
    const trigger=async()=>{setRun(true);setRes(null);log('üöÄ EFS Sync manuell gestartet...','warn');try{const r=await fetch('/api/efs-sync',{headers:{Authorization:'Bearer manual'}});const d=await r.json();setRes(d);if(d.success){log(`‚úÖ EFS: ${d.summary?.totalProjects} Projekte, ${d.summary?.csvRows} CSV-Zeilen`,'success');if(d.summary?.latestCsvUrl)setCsv({url:d.summary.latestCsvUrl,d:new Date().toISOString()})}else log(`‚ùå EFS: ${d.error}`,'error')}catch(e){log(`‚ùå EFS: ${e.message}`,'error')}setRun(false);rc()};
    return(<React.Fragment>
        <div className="eg fi">
            <div className="cd"><div className="cd-t">üìä EFS ‚Üí Supabase Sync</div>
                <p style={{fontSize:13,color:'var(--td)',marginBottom:14,lineHeight:1.6}}>Cron l√§uft t√§glich um <strong style={{color:'var(--a)'}}>06:00 Uhr</strong>. Holt alle Projekte via EFS tRPC API ‚Üí <code style={{background:'var(--el)',padding:'2px 6px',borderRadius:4}}>efs_projekte</code> ‚Üí CSV.</p>
                <div className="brow">
                    <button className="btn by" disabled={run} onClick={trigger}>{run?<React.Fragment><span className="spinner"/> Sync l√§uft...</React.Fragment>:'‚ö° Manuell triggern'}</button>
                    {csv&&<a href={csv.url} target="_blank" className="btn bo" style={{textDecoration:'none'}}>üì• Latest CSV</a>}
                </div>
                {run&&<div style={{marginTop:12,fontSize:12,color:'var(--o)'}}>‚è≥ Bis zu 5 Min (Vercel Pro)...</div>}
            </div>
            <div className="cd"><div className="cd-t">üìã Sync-Details</div>
                {res?.success?<div style={{fontSize:12,lineHeight:2}}><div>‚úÖ <strong>{res.summary.totalProjects}</strong> Projekte</div><div>üì¶ <strong>{res.summary.basisdatenUpserted}</strong> Basisdaten</div><div>üîç <strong>{res.summary.detailsEnriched}</strong> Details{res.summary.detailErrors>0&&<span style={{color:'var(--r)'}}> ({res.summary.detailErrors} Fehler)</span>}</div><div>üìä <strong>{res.summary.csvRows}</strong> CSV-Zeilen</div><div>‚è±Ô∏è {res.summary.durationSeconds}s</div></div>:res?.error?<div style={{fontSize:12,color:'var(--r)'}}>{res.error}</div>:<div style={{fontSize:12,color:'var(--td)',padding:20,textAlign:'center'}}>Noch kein manueller Sync. Cron l√§uft t√§glich.</div>}
                {res?.log&&<div className="lb" style={{marginTop:12,maxHeight:160,fontSize:11}}>{res.log.map((l,i)=><div key={i} style={{color:l.includes('FEHLER')?'var(--r)':l.includes('‚úÖ')?'var(--g)':'var(--td)'}}>{l}</div>)}</div>}
            </div>
        </div>
        <div className="cd fi"><div className="cd-t">üó∫Ô∏è EFS Feld-Mapping</div>
            <table className="mt"><thead><tr><th>EFS API</th><th>‚Üí Supabase</th><th>Phase</th></tr></thead><tbody>
                {[['id','efs_id','List'],['status / simplifiedStatus','status, simplified_status','List'],['primaryCustomer.*','kunde_*, plz, stadt','List'],['totalAmount','gesamtpreis_eur','List'],['user.*','zustaendiger, email','List'],['coSignedAt','co_signed_at','List'],['contract.rate','monatl_rate_eur','Detail'],['contract.product.*','preismodell, nominalzins, factoringrate','Detail'],['projectComponents','pv_kwp, wr_kw, bat_kwh, wb_kw','Detail'],['installedAt / gridConnectedAt','installed_at, grid_connected_at','Detail']].map((r,i)=><tr key={i}><td style={{color:'var(--tb)'}}>{r[0]}</td><td>{r[1]}</td><td><span className={`tg ${r[2]==='List'?'tg-ok':'tg-w'}`}>{r[2]}</span></td></tr>)}
            </tbody></table>
        </div>
        <AutoSync syncKey="efs_sync" log={log}/>
    </React.Fragment>);
}

// ‚ïê‚ïê‚ïê CSV TAB ‚ïê‚ïê‚ïê
const CVT=[{k:'leads',l:'Leads Incoming',i:'üìã',d:'Eingehende Leads',c:'bld',t:'import_leads'},{k:'appointments',l:'Termine',i:'üìÖ',d:'Created + Closed CSVs',c:'gd',t:'import_appointments',m:true},{k:'provisions',l:'Provisionsrelevant',i:'üí∞',d:'Auftr√§ge & Finanzen',c:'od',t:'import_provisions'}];

function CT({log,rc}){
    const[fs,setFs]=useState({});const[imp,setImp]=useState(null);const[prog,setProg]=useState({});const[res,setRes]=useState({});
    const det=fn=>fn.toLowerCase().includes('closed')?'closed':'created';
    const hf=(k,f)=>{if(!f)return;const rd=new FileReader();rd.onload=e=>{const rows=parseCSV(e.target.result);if(k==='appointments'){const sub=det(f.name);setFs(p=>{const ex=p.appointments||{fl:[],ar:[],ts:0};const nl=[...ex.fl,{n:f.name,s:f.size,rc:rows.length,sub}];const mp=rows.map(r=>mA(r,sub)).filter(r=>!isNaN(r.termin_id));const mg=[...ex.ar];mp.forEach(row=>{const idx=mg.findIndex(r=>r.termin_id===row.termin_id);if(idx>=0){if(row.csv_quelle==='closed'||mg[idx].csv_quelle!=='closed')mg[idx]=row}else mg.push(row)});return{...p,appointments:{fl:nl,ar:mg,ts:ex.ts+f.size,rc:mg.length}}});log(`${f.name} (${sub}): ${rows.length.toLocaleString('de-DE')} Zeilen`)}else{setFs(p=>({...p,[k]:{f,rows,rc:rows.length,n:f.name,s:f.size}}));log(`${f.name}: ${rows.length.toLocaleString('de-DE')} Zeilen`)}};rd.readAsText(f,'UTF-8')};
    const rf=k=>{setFs(p=>{const n={...p};delete n[k];return n});setRes(p=>{const n={...p};delete n[k];return n})};
    const io=async k=>{const ct=CVT.find(t=>t.k===k);const fd=fs[k];if(!fd||!ct)return;setImp(k);const tot=k==='appointments'?fd.ar.length:fd.rc;setProg(p=>({...p,[k]:{c:0,t:tot}}));log(`Import: ${ct.l} (${tot.toLocaleString('de-DE')} Zeilen)`,'warn');const bid=crypto.randomUUID();
        try{let mp;if(k==='leads')mp=fd.rows.map(mL).filter(r=>!isNaN(r.lead_id));else if(k==='appointments')mp=fd.ar;else mp=fd.rows.map(mP).filter(r=>!isNaN(r.an_nr));mp=mp.map(r=>({...r,import_batch_id:bid}));const r=await uBat(ct.t,mp,(c,t)=>setProg(p=>({...p,[k]:{c,t}})));setRes(p=>({...p,[k]:r}));log(`‚úì ${ct.l}: ${r.inserted} neu, ${r.updated} aktualisiert${r.errors>0?`, ${r.errors} Fehler`:''}`,r.errors>0?'error':'success');
        await fetch(ap('import_logs'),{method:'POST',headers:hd(),body:JSON.stringify({batch_id:bid,csv_typ:k,dateiname:k==='appointments'?fd.fl.map(f=>f.n).join(' + '):fd.n,zeilen_gesamt:tot,zeilen_neu:r.inserted,zeilen_aktualisiert:r.updated,zeilen_fehler:r.errors,fehler_details:r.errorDetails.length?r.errorDetails:null,finished_at:new Date().toISOString()})});rc()}catch(e){log(`‚úó ${ct.l}: ${e.message}`,'error');setRes(p=>({...p,[k]:{inserted:0,updated:0,errors:tot,errorDetails:[{error:e.message}]}}))};setImp(null)};
    const ia=async()=>{for(const k of['leads','appointments','provisions'])if(fs[k])await io(k)};
    const fc=Object.keys(fs).length;
    return(<React.Fragment>
        <div className="ig fi">{CVT.map(ct=><CC key={ct.k} ct={ct} fd={fs[ct.k]} imp={imp===ct.k} prog={prog[ct.k]} res={res[ct.k]} onF={f=>hf(ct.k,f)} onR={()=>rf(ct.k)} onI={()=>io(ct.k)}/>)}</div>
        <div className="brow fi"><button className="btn by" disabled={fc===0||imp!==null} onClick={ia}>{imp?<React.Fragment><span className="spinner"/> Importiert...</React.Fragment>:<React.Fragment>üöÄ Alle importieren ({fc})</React.Fragment>}</button><button className="btn bo" onClick={rc}>üîÑ Aktualisieren</button></div>
    </React.Fragment>);
}

function CC({ct,fd,imp,prog,res,onF,onR,onI}){
    const ref=useRef(null);const[dg,setDg]=useState(false);const ml=ct.m;const has=ml?fd?.fl?.length>0:!!fd;
    const onD=e=>{e.preventDefault();setDg(false);Array.from(e.dataTransfer.files).filter(f=>f.name.endsWith('.csv')).forEach(f=>onF(f))};
    const onIn=e=>{Array.from(e.target.files).forEach(f=>onF(f));e.target.value=''};
    const pc=prog?Math.round(prog.c/prog.t*100):0;const tot=fd?.rc||0;
    const cols={bld:'var(--bld)',gd:'var(--gd)',od:'var(--od)'};
    const bd=()=>{if(imp)return<span className="icb" style={{background:'var(--ad)',color:'var(--a)'}}><span className="spinner" style={{width:8,height:8,borderWidth:1.5,marginRight:4}}/>Import</span>;if(res?.errors>0&&res?.inserted===0)return<span className="icb" style={{background:'var(--rd)',color:'var(--r)'}}>Fehler</span>;if(res)return<span className="icb" style={{background:'var(--gd)',color:'var(--g)'}}>‚úì Fertig</span>;if(has)return<span className="icb" style={{background:'var(--gd)',color:'var(--g)'}}>Bereit</span>;return<span className="icb" style={{background:'rgba(255,255,255,.05)',color:'var(--td)'}}>‚Äî</span>};
    return(<div className={`ic ${has?'on':''}`}>
        <div className="ich"><div className="ict"><div className="ici" style={{background:cols[ct.c]}}>{ct.i}</div><div><div className="icn">{ct.l}</div><div className="icd">{ct.d}</div></div></div>{bd()}</div>
        {ml&&<div className="mh">‚ö° Mehrere CSVs ‚Äì Closed √ºberschreibt Created</div>}
        {(!has||(ml&&!res))&&!imp&&<div className={`dz ${dg?'dv':''}`} onDragOver={e=>{e.preventDefault();setDg(true)}} onDragLeave={()=>setDg(false)} onDrop={onD} onClick={()=>ref.current?.click()}>{ml?'Created + Closed CSVs':'CSV'} hierher ziehen oder <strong>klicken</strong><input ref={ref} type="file" accept=".csv" multiple={ml} onChange={onIn}/></div>}
        {ml&&fd?.fl?.map((f,i)=><div key={i} className="fi2"><span>{f.sub==='closed'?'‚úÖ':'üìÑ'}</span><div><span className="fi2-n">{f.n}</span> <span className="fi2-m">¬∑ {f.rc.toLocaleString('de-DE')} Zeilen ¬∑ {f.sub}</span></div></div>)}
        {!ml&&fd&&<div className="fi2"><span>üìÑ</span><div><span className="fi2-n">{fd.n}</span> <span className="fi2-m">¬∑ {fd.rc.toLocaleString('de-DE')} Zeilen ¬∑ {(fd.s/1024).toFixed(0)} KB</span></div>{!imp&&!res&&<button className="fi2-x" onClick={onR}>‚úï</button>}</div>}
        {ml&&fd?.fl?.length>1&&<div style={{fontSize:11,color:'var(--a)',textAlign:'center',marginTop:4}}>‚Üí {fd.rc.toLocaleString('de-DE')} eindeutige Termine</div>}
        {imp&&prog&&<React.Fragment><div className="pb"><div className="pf" style={{width:`${pc}%`}}/></div><div className="pt"><span>{prog.c.toLocaleString('de-DE')} / {prog.t.toLocaleString('de-DE')}</span><span>{pc}%</span></div></React.Fragment>}
        {res&&<div className="rg"><div className="ri nw"><div className="rn">{res.inserted.toLocaleString('de-DE')}</div><div className="rl">Neu</div></div><div className="ri up"><div className="rn">{res.updated.toLocaleString('de-DE')}</div><div className="rl">Aktualisiert</div></div><div className="ri er"><div className="rn">{res.errors.toLocaleString('de-DE')}</div><div className="rl">Fehler</div></div></div>}
        {has&&!imp&&!res&&<button className="btn by" style={{width:'100%',marginTop:10,justifyContent:'center'}} onClick={onI}>‚ö° {tot.toLocaleString('de-DE')} Zeilen importieren</button>}
        {res&&!imp&&<button className="btn bo bsm" style={{width:'100%',marginTop:6,justifyContent:'center'}} onClick={onR}>‚Üª Neuer Import</button>}
    </div>);
}

// ‚ïê‚ïê‚ïê BANK / EBICS TAB ‚ïê‚ïê‚ïê
function parseCAMT(xml){const dp=new DOMParser();const doc=dp.parseFromString(xml,'text/xml');const ns=doc.documentElement.namespaceURI;const gn=(el,tag)=>{const r=ns?el.getElementsByTagNameNS(ns,tag):el.getElementsByTagName(tag);return r.length?r:el.getElementsByTagName(tag)};
    const stmts=gn(doc,'Stmt');const txns=[];let acctIBAN='';
    for(const stmt of stmts){const ai=gn(stmt,'IBAN');if(ai.length)acctIBAN=ai[0].textContent;const entries=gn(stmt,'Ntry');
        for(const ntry of entries){const bd=gn(ntry,'BookgDt');const vd=gn(ntry,'ValDt');const am=gn(ntry,'Amt');const cd=gn(ntry,'CdtDbtInd');
            const dtls=gn(ntry,'NtryDtls');let vz='',gIBAN='',gBIC='',gName='',e2e='',mnd='',ref='';
            if(dtls.length){const tx=gn(dtls[0],'TxDtls');if(tx.length){const ri=gn(tx[0],'RmtInf');if(ri.length){const us=gn(ri[0],'Ustrd');vz=Array.from(us).map(u=>u.textContent).join(' ')}
                const rp=gn(tx[0],'RltdPties');if(rp.length){const da=[...gn(rp[0],'DbtrAcct'),...gn(rp[0],'CdtrAcct')];for(const a of da){const ib=gn(a,'IBAN');if(ib.length){gIBAN=ib[0].textContent;break}}const dn=[...gn(rp[0],'Dbtr'),...gn(rp[0],'Cdtr')];for(const d of dn){const nm=gn(d,'Nm');if(nm.length){gName=nm[0].textContent;break}}}
                const ra=gn(tx[0],'RltdAgts');if(ra.length){const bc=gn(ra[0],'BIC');if(bc.length)gBIC=bc[0].textContent}
                const refs=gn(tx[0],'Refs');if(refs.length){const ei=gn(refs[0],'EndToEndId');if(ei.length)e2e=ei[0].textContent;const mr=gn(refs[0],'MndtId');if(mr.length)mnd=mr[0].textContent}}}
            const bkDt=bd.length?gn(bd[0],'Dt'):[null];const vlDt=vd.length?gn(vd[0],'Dt'):[null];
            txns.push({buchungsdatum:bkDt[0]?.textContent||null,valutadatum:vlDt[0]?.textContent||null,betrag:am.length?parseFloat(am[0].textContent):0,waehrung:am.length?am[0].getAttribute('Ccy')||'EUR':'EUR',soll_haben:cd.length?cd[0].textContent:'',gegenkonto_iban:gIBAN,gegenkonto_bic:gBIC,gegenkonto_name:gName,verwendungszweck:vz,end2end_id:e2e!=='NOTPROVIDED'?e2e:'',mandate_id:mnd,eigenes_konto_iban:acctIBAN})}}
    return txns}

function parseMT940(text){const txns=[];let acctIBAN='',curDate='',curAmt=0,curSH='',lines=text.split('\n');let i=0;const buf={vz:'',ref:''};
    const toDate=s=>{if(!s||s.length<6)return null;const y=s.substring(0,2);const m=s.substring(2,4);const d=s.substring(4,6);return`20${y}-${m}-${d}`};
    while(i<lines.length){const l=lines[i].trim();
        if(l.startsWith(':25:')){acctIBAN=l.substring(4).replace(/\//g,'')}
        else if(l.startsWith(':61:')){if(buf.vz&&curDate){txns.push({buchungsdatum:curDate,valutadatum:curDate,betrag:curAmt,waehrung:'EUR',soll_haben:curSH,gegenkonto_iban:'',gegenkonto_bic:'',gegenkonto_name:'',verwendungszweck:buf.vz,end2end_id:'',mandate_id:'',eigenes_konto_iban:acctIBAN,bank_referenz:buf.ref});buf.vz='';buf.ref=''}
            const ln=l.substring(4);curDate=toDate(ln.substring(0,6));const dm=ln.match(/\d{6}(C|D|RC|RD)([\d,]+)/);if(dm){curSH=dm[1].includes('D')?'DBIT':'CRDT';curAmt=parseFloat(dm[2].replace(',','.'))}const rm=ln.match(/\/\/(.+)/);if(rm)buf.ref=rm[1]}
        else if(l.startsWith(':86:')){buf.vz=l.substring(4);let j=i+1;while(j<lines.length&&!lines[j].trim().startsWith(':')){buf.vz+=' '+lines[j].trim();j++}i=j-1}
        i++}
    if(buf.vz&&curDate)txns.push({buchungsdatum:curDate,valutadatum:curDate,betrag:curAmt,waehrung:'EUR',soll_haben:curSH,gegenkonto_iban:'',gegenkonto_bic:'',gegenkonto_name:'',verwendungszweck:buf.vz,end2end_id:'',mandate_id:'',eigenes_konto_iban:acctIBAN,bank_referenz:buf.ref});
    return txns}

function parseCSVBank(text){
    // CSV-MT940 / Sparkasse CSV Export Parser
    const lines=text.replace(/^\uFEFF/,'').split(/\r?\n/).filter(l=>l.trim());
    if(lines.length<2)return[];
    // Auto-detect delimiter (Sparkasse uses semicolon)
    const delim=lines[0].split(';').length>lines[0].split(',').length?';':',';
    const splitRow=(line)=>{const cols=[];let cur='',inQ=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(inQ&&line[i+1]==='"'){cur+='"';i++}else inQ=!inQ}else if(ch===delim&&!inQ){cols.push(cur);cur=''}else cur+=ch}cols.push(cur);return cols};
    const hdr=splitRow(lines[0]).map(h=>h.replace(/^"|"$/g,'').trim());
    // Flexible column finder
    const find=(names)=>{for(const n of names){const nl=n.toLowerCase();const i=hdr.findIndex(h=>h.toLowerCase().includes(nl));if(i>=0)return i}return-1};
    const iKonto=find(['Auftragskonto','Kontonummer des Auftraggebers']);
    const iBuchung=find(['Buchungstag','Buchungsdatum']);
    const iValuta=find(['Valutadatum','Valuta','Wertstellung']);
    const iBuchText=find(['Buchungstext']);
    const iVwz=find(['Verwendungszweck']);
    const iName=find(['Beguenstigter','Beg√ºnstigter','Zahlungspflichtiger','Empf√§nger','Empfaenger']);
    const iIBAN=find(['Kontonummer']);
    const iBLZ=find(['BLZ','BIC']);
    const iBetrag=find(['Betrag','Umsatz']);
    const iWaehrung=find(['Waehrung','W√§hrung']);
    const iInfo=find(['Info']);
    // Parse German date DD.MM.YY or DD.MM.YYYY
    const parseDE=(s)=>{if(!s)return null;const m=s.match(/(\d{1,2})\.(\d{1,2})\.(\d{2,4})/);if(!m)return null;let y=m[3];if(y.length===2)y=parseInt(y)>50?'19'+y:'20'+y;return`${y}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`};
    // Parse German amount: "-1.758,79" or "1.758,79"
    const parseAmt=(s)=>{if(!s)return 0;const c=s.replace(/\s/g,'').replace(/\./g,'').replace(',','.');return parseFloat(c)||0};
    const txns=[];
    for(let i=1;i<lines.length;i++){
        const cols=splitRow(lines[i]).map(c=>c.replace(/^"|"$/g,''));
        if(cols.length<3||cols.every(c=>!c.trim()))continue;
        const betrag=iBetrag>=0?parseAmt(cols[iBetrag]):0;
        if(betrag===0)continue;
        const sh=betrag>=0?'CRDT':'DBIT';
        txns.push({
            buchungsdatum:iBuchung>=0?parseDE(cols[iBuchung]):null,
            valutadatum:iValuta>=0?parseDE(cols[iValuta]):null,
            betrag:Math.abs(betrag),
            waehrung:iWaehrung>=0&&cols[iWaehrung]?cols[iWaehrung].trim()||'EUR':'EUR',
            soll_haben:sh,
            gegenkonto_iban:iIBAN>=0?cols[iIBAN].trim():'',
            gegenkonto_bic:iBLZ>=0?cols[iBLZ].trim():'',
            gegenkonto_name:iName>=0?cols[iName].trim():'',
            verwendungszweck:[iBuchText>=0?cols[iBuchText]:'',iVwz>=0?cols[iVwz]:''].filter(Boolean).map(s=>s.trim()).join(' ¬∑ '),
            end2end_id:'',mandate_id:'',
            eigenes_konto_iban:iKonto>=0?cols[iKonto].trim():'',
            bank_referenz:'',
            info:iInfo>=0?cols[iInfo].trim():''
        })}
    return txns}

function IBANFinder({log}){
    const[loading,setLoading]=useState(false);const[matches,setMatches]=useState(null);const[saved,setSaved]=useState({});
    const normalize=s=>(s||'').toLowerCase().replace(/[^a-z√§√∂√º√ü]/g,' ').replace(/\s+/g,' ').trim();
    const scan=async()=>{setLoading(true);setSaved({});log('üîç IBAN-Finder: Scanne Banktransaktionen...','warn');
        try{
            // HGB-Mitarbeiter ohne IBAN laden
            const maR=await fetch(ap('pay_mitarbeiter')+'?aktiv=eq.true&typ=like.*hgb*&select=id,vorname,nachname,typ,iban',{headers:hd()});
            const allHGB=await maR.json();
            const missing=allHGB.filter(m=>!m.iban||!m.iban.trim());
            if(!missing.length){log('‚úÖ Alle HGB-Mitarbeiter haben eine IBAN','success');setMatches([]);setLoading(false);return}
            log(`üìã ${missing.length} HGB ohne IBAN, ${allHGB.length-missing.length} mit IBAN`);
            // Banktransaktionen mit IBAN laden (Ausg√§nge = √úberweisungen an VTs)
            const bkR=await fetch(ap('bank_transactions')+'?soll_haben=eq.DBIT&gegenkonto_iban=not.is.null&gegenkonto_iban=neq.&select=gegenkonto_name,gegenkonto_iban,gegenkonto_bic,betrag,buchungsdatum&order=buchungsdatum.desc&limit=5000',{headers:hd()});
            const txns=await bkR.json();
            log(`üè¶ ${txns.length} ausgehende Transaktionen mit IBAN geladen`);
            // Unique IBANs pro Gegenkonto-Name
            const ibanMap={};
            txns.forEach(t=>{if(!t.gegenkonto_name||!t.gegenkonto_iban)return;const k=normalize(t.gegenkonto_name);if(!ibanMap[k])ibanMap[k]={iban:t.gegenkonto_iban,bic:t.gegenkonto_bic||'',name:t.gegenkonto_name,dates:[],total:0,count:0};ibanMap[k].dates.push(t.buchungsdatum);ibanMap[k].total+=t.betrag;ibanMap[k].count++});
            // Matching: Nachname im Gegenkonto-Name
            const found=[];
            missing.forEach(m=>{const nn=normalize(m.nachname);const vn=normalize(m.vorname);const full=normalize(m.vorname+' '+m.nachname);
                for(const[k,v] of Object.entries(ibanMap)){
                    // Exakt: "vorname nachname" oder "nachname vorname" oder nur nachname wenn eindeutig
                    const parts=k.split(' ');
                    const nameMatch=k.includes(full)||k.includes(normalize(m.nachname+' '+m.vorname))||(parts.some(p=>p===nn)&&parts.some(p=>p===vn));
                    if(nameMatch){found.push({mitarbeiter:m,iban:v.iban,bic:v.bic,bankName:v.name,txCount:v.count,txTotal:v.total,lastDate:v.dates.sort().reverse()[0]});break}}});
            setMatches(found);
            log(`‚úÖ ${found.length} IBAN-Matches gefunden von ${missing.length} fehlenden`,'success');
        }catch(e){log(`‚ùå IBAN-Finder: ${e.message}`,'error')}setLoading(false)};
    const saveIBAN=async(m,iban,bic)=>{
        try{const r=await fetch(ap('pay_mitarbeiter')+`?id=eq.${m.id}`,{method:'PATCH',headers:{...hd(),Authorization:`Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTMzNTM5NywiZXhwIjoyMDg2OTExMzk3fQ.MJ3cyAAquE8DK2ngzfIIn4bTpQ8_H9DaeJ3YTlBdFz4`,'Prefer':'return=representation'},body:JSON.stringify({iban:iban,bic:bic||null})});
            if(!r.ok)throw new Error(await r.text());
            setSaved(p=>({...p,[m.id]:true}));log(`‚úÖ IBAN gespeichert: ${m.vorname} ${m.nachname} ‚Üí ${iban}`,'success');
        }catch(e){log(`‚ùå IBAN speichern: ${e.message}`,'error')}};
    const saveAll=async()=>{if(!matches)return;const unsaved=matches.filter(m=>!saved[m.mitarbeiter.id]);
        for(const mt of unsaved)await saveIBAN(mt.mitarbeiter,mt.iban,mt.bic);
        log(`‚úÖ ${unsaved.length} IBANs gespeichert`,'success')};
    return(<div className="cd fi"><div className="cd-t">üîç IBAN-Finder (nur HGB)</div>
        <p style={{fontSize:13,color:'var(--td)',marginBottom:14,lineHeight:1.6}}>Scannt importierte Banktransaktionen und matcht Empf√§ngernamen mit HGB-Mitarbeitern ohne IBAN. Angestellte werden √ºber das Lohnb√ºro abgerechnet.</p>
        <button className="btn by" disabled={loading} onClick={scan} style={{marginBottom:14}}>{loading?<React.Fragment><span className="spinner"/> Scanne...</React.Fragment>:'üîç IBANs aus Banktransaktionen suchen'}</button>
        {matches!==null&&matches.length===0&&<div style={{fontSize:13,color:'var(--g)',padding:16,textAlign:'center',background:'var(--gd)',borderRadius:8}}>‚úÖ Keine fehlenden IBANs gefunden oder keine Matches in Banktransaktionen</div>}
        {matches!==null&&matches.length>0&&<React.Fragment>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
                <span style={{fontSize:12,color:'var(--a)'}}>{matches.length} Matches gefunden</span>
                <button className="btn bo bsm" onClick={saveAll} disabled={matches.every(m=>saved[m.mitarbeiter.id])}>üíæ Alle speichern</button>
            </div>
            <div style={{maxHeight:350,overflowY:'auto',fontSize:12}}>
                <table className="mt"><thead><tr><th>Mitarbeiter</th><th>Typ</th><th>IBAN (aus Bank)</th><th>Transaktionen</th><th></th></tr></thead><tbody>
                {matches.map((mt,i)=><tr key={i} style={{opacity:saved[mt.mitarbeiter.id]?.8:1}}>
                    <td style={{color:'var(--tb)',fontWeight:600}}>{mt.mitarbeiter.vorname} {mt.mitarbeiter.nachname}</td>
                    <td><span className="tg tg-w">{mt.mitarbeiter.typ.replace('hgb_vertriebler_','').replace('hgb','HGB')}</span></td>
                    <td style={{fontFamily:'monospace',fontSize:11,color:'var(--a)'}}>{mt.iban}</td>
                    <td style={{color:'var(--td)'}}>{mt.txCount}√ó ¬∑ {mt.txTotal.toLocaleString('de-DE',{minimumFractionDigits:2})} ‚Ç¨ ¬∑ letzte: {mt.lastDate}</td>
                    <td>{saved[mt.mitarbeiter.id]?<span style={{color:'var(--g)'}}>‚úÖ</span>:<button className="btn bo bsm" onClick={()=>saveIBAN(mt.mitarbeiter,mt.iban,mt.bic)}>üíæ</button>}</td>
                </tr>)}
                </tbody></table>
            </div>
        </React.Fragment>}
    </div>);
}

function BKT({log,rc}){
    const[file,setFile]=useState(null);const[txns,setTxns]=useState(null);const[imp,setImp]=useState(false);const[res,setRes]=useState(null);const ref=useRef(null);const[dg,setDg]=useState(false);const[fmt,setFmt]=useState('');
    const hf=f=>{const rd=new FileReader();const fn=f.name.toLowerCase();rd.onload=e=>{const c=e.target.result;let parsed;let fmt='';try{if(fn.endsWith('.xml')||c.trim().startsWith('<?xml')||c.includes('BkToCstmrStmt')){parsed=parseCAMT(c);fmt='CAMT.053'}else if(fn.endsWith('.csv')){parsed=parseCSVBank(c);fmt='CSV-MT940'}else{parsed=parseMT940(c);fmt='MT940'}setTxns(parsed);setFile(f);setFmt(fmt);setRes(null);log(`üè¶ ${f.name}: ${parsed.length} Transaktionen geparsed (${fmt})`)}catch(err){log(`‚ùå Parse-Fehler: ${err.message}`,'error')}};
        // CSV files from German banks are often ISO-8859-1
        rd.readAsText(f,fn.endsWith('.csv')?'ISO-8859-1':'UTF-8')};
    const onD=e=>{e.preventDefault();setDg(false);const f=Array.from(e.dataTransfer.files).find(f=>{const n=f.name.toLowerCase();return n.endsWith('.xml')||n.endsWith('.csv')||n.endsWith('.sta')||n.endsWith('.mt940')||n.endsWith('.txt')});if(f)hf(f)};
    const doImport=async()=>{if(!txns)return;setImp(true);log(`üè¶ Import: ${txns.length} Transaktionen`,'warn');const bid=crypto.randomUUID();
        const rows=txns.map(t=>{const{info,...rest}=t;return{...rest,import_batch_id:bid,import_dateiname:file.name,import_format:fmt||'CSV-MT940'}});
        try{const r=await uBat('bank_transactions',rows,(c,t)=>{});setRes(r);log(`‚úÖ Bank: ${r.inserted} neu, ${r.updated} aktualisiert${r.errors>0?`, ${r.errors} Fehler`:''}`,r.errors>0?'error':'success');rc()}catch(e){log(`‚ùå Bank: ${e.message}`,'error');setRes({inserted:0,updated:0,errors:txns.length})}setImp(false)};
    const reset=()=>{setFile(null);setTxns(null);setRes(null);setFmt('')};
    const fm=v=>typeof v==='number'?v.toLocaleString('de-DE',{minimumFractionDigits:2}):v;
    const sums=txns?{ein:txns.filter(t=>t.soll_haben==='CRDT').reduce((s,t)=>s+t.betrag,0),aus:txns.filter(t=>t.soll_haben==='DBIT').reduce((s,t)=>s+t.betrag,0)}:null;
    return(<React.Fragment>
        <div className="eg fi">
            <div className="cd"><div className="cd-t">üè¶ Bank-Kontoauszug Import</div>
                <p style={{fontSize:13,color:'var(--td)',marginBottom:14,lineHeight:1.6}}>Unterst√ºtzt <strong style={{color:'var(--a)'}}>CSV-MT940</strong> (Sparkasse Excel-Export), <strong style={{color:'var(--a)'}}>CAMT.053</strong> (XML) und <strong style={{color:'var(--a)'}}>MT940</strong> (SWIFT).</p>
                {!file&&<div className={`dz ${dg?'dv':''}`} onDragOver={e=>{e.preventDefault();setDg(true)}} onDragLeave={()=>setDg(false)} onDrop={onD} onClick={()=>ref.current?.click()}>CSV (.csv), CAMT.053 (.xml) oder MT940 (.sta/.txt) hierher ziehen oder <strong>klicken</strong><input ref={ref} type="file" accept=".csv,.CSV,.xml,.XML,.sta,.mt940,.txt" onChange={e=>{if(e.target.files[0])hf(e.target.files[0]);e.target.value=''}}/></div>}
                {file&&<div className="fi2"><span>üìÑ</span><div><span className="fi2-n">{file.name}</span> <span className="fi2-m">¬∑ {txns?.length||0} Transaktionen ¬∑ {fmt} ¬∑ {(file.size/1024).toFixed(0)} KB</span></div>{!imp&&!res&&<button className="fi2-x" onClick={reset}>‚úï</button>}</div>}
                {txns&&!imp&&!res&&<button className="btn by" style={{width:'100%',marginTop:10,justifyContent:'center'}} onClick={doImport}>‚ö° {txns.length} Transaktionen importieren</button>}
                {res&&<React.Fragment><div className="rg"><div className="ri nw"><div className="rn">{res.inserted}</div><div className="rl">Neu</div></div><div className="ri up"><div className="rn">{res.updated}</div><div className="rl">Aktualisiert</div></div><div className="ri er"><div className="rn">{res.errors}</div><div className="rl">Fehler</div></div></div><button className="btn bo bsm" style={{width:'100%',marginTop:6,justifyContent:'center'}} onClick={reset}>‚Üª Neuer Import</button></React.Fragment>}
            </div>
            <div className="cd"><div className="cd-t">üìä Vorschau</div>
                {sums?<React.Fragment><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
                    <div style={{background:'var(--gd)',borderRadius:8,padding:12,textAlign:'center'}}><div style={{fontSize:11,color:'var(--td)'}}>Eing√§nge</div><div style={{fontSize:18,fontWeight:700,color:'var(--g)'}}>+{fm(sums.ein)} ‚Ç¨</div></div>
                    <div style={{background:'var(--rd)',borderRadius:8,padding:12,textAlign:'center'}}><div style={{fontSize:11,color:'var(--td)'}}>Ausg√§nge</div><div style={{fontSize:18,fontWeight:700,color:'var(--r)'}}>-{fm(sums.aus)} ‚Ç¨</div></div></div>
                    <div style={{maxHeight:200,overflowY:'auto',fontSize:11}}><table className="mt"><thead><tr><th>Datum</th><th>Betrag</th><th>Gegenkonto</th><th>Verwendungszweck</th>{txns[0]?.info!==undefined&&<th>Status</th>}</tr></thead><tbody>
                    {txns.slice(0,20).map((t,i)=><tr key={i}><td>{t.buchungsdatum||t.valutadatum}</td><td style={{color:t.soll_haben==='CRDT'?'var(--g)':'var(--r)',fontWeight:600,whiteSpace:'nowrap'}}>{t.soll_haben==='CRDT'?'+':'-'}{fm(t.betrag)} ‚Ç¨</td><td style={{maxWidth:120,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{t.gegenkonto_name||t.gegenkonto_iban||'‚Äî'}</td><td style={{maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{t.verwendungszweck||'‚Äî'}</td>{t.info!==undefined&&<td><span className={`tg ${t.info?.includes('gebucht')?'tg-ok':'tg-w'}`}>{t.info?.includes('gebucht')?'gebucht':'vorgemerkt'}</span></td>}</tr>)}
                    </tbody></table>{txns.length>20&&<div style={{textAlign:'center',padding:8,color:'var(--td)'}}>... und {txns.length-20} weitere</div>}</div>
                </React.Fragment>:<div style={{fontSize:12,color:'var(--td)',padding:30,textAlign:'center'}}>Datei hochladen um Vorschau zu sehen</div>}
            </div>
        </div>
        <IBANFinder log={log}/>
        <AutoSync syncKey="bank_import" log={log}/>
        <div className="cd fi"><div className="cd-t">üó∫Ô∏è Feld-Mapping</div>
            <table className="mt"><thead><tr><th>Quelle</th><th>‚Üí Supabase</th><th>Format</th></tr></thead><tbody>
                {[['Buchungstag / BookgDt / :61:','buchungsdatum','CSV / CAMT / MT940'],['Valutadatum','valutadatum','CSV / CAMT / MT940'],['Betrag / Amt','betrag','CSV / CAMT / MT940'],['¬±Vorzeichen / CdtDbtInd','soll_haben','CRDT / DBIT'],['Beg√ºnstigter / RltdPties Nm','gegenkonto_name','CSV / CAMT'],['Kontonummer / RltdPties IBAN','gegenkonto_iban','CSV / CAMT'],['BLZ/BIC / RltdAgts','gegenkonto_bic','CSV / CAMT'],['Verwendungszweck / RmtInf','verwendungszweck','CSV / CAMT / MT940'],['Auftragskonto / Acct IBAN','eigenes_konto_iban','CSV / CAMT / MT940'],['EndToEndId','end2end_id','CAMT']].map((r,i)=><tr key={i}><td style={{color:'var(--tb)'}}>{r[0]}</td><td>{r[1]}</td><td style={{color:'var(--td)'}}>{r[2]}</td></tr>)}
            </tbody></table>
        </div>
    </React.Fragment>);
}

// ‚ïê‚ïê‚ïê LOHNJOURNAL TAB ‚ïê‚ïê‚ïê
function LJT({log,rc}){
    const[file,setFile]=useState(null);const[parsed,setParsed]=useState(null);const[rawText,setRawText]=useState('');const[imp,setImp]=useState(false);const[res,setRes]=useState(null);const ref=useRef(null);const[dg,setDg]=useState(false);
    const parseLJ=async(f)=>{log('üìÑ PDF wird gelesen...','warn');const ab=await f.arrayBuffer();
        const pdf=await pdfjsLib.getDocument({data:ab}).promise;let text='';
        for(let i=1;i<=pdf.numPages;i++){const pg=await pdf.getPage(i);const tc=await pg.getTextContent();text+=tc.items.map(x=>x.str).join(' ')+'\n'}
        setRawText(text);log(`üìÑ ${pdf.numPages} Seiten, ${text.length} Zeichen extrahiert`);
        // Parse Lohnjournal structure
        const data={mitarbeiter:[],monat:'',brutto:0,netto:0,sv:0,lst:0,ag:0};
        // Try to find month
        const monatMatch=text.match(/(Januar|Februar|M√§rz|April|Mai|Juni|Juli|August|September|Oktober|November|Dezember)\s*(\d{4})/i)||text.match(/(\d{2})[\./](\d{4})/);
        if(monatMatch)data.monat=monatMatch[0];
        // Try to find totals
        const nums=text.match(/[\d.]+,\d{2}/g)||[];const bigNums=nums.map(n=>parseFloat(n.replace(/\./g,'').replace(',','.'))).filter(n=>n>100);
        // Count employees - look for Personalnummer or sequential numbers
        const pnrMatch=text.match(/\d{4,6}\s+[A-Z√Ñ√ñ√úa-z√§√∂√º√ü]+/g)||[];data.mitarbeiter_count=Math.max(pnrMatch.length,1);
        // Store parsed data
        const result={monat:data.monat,mitarbeiter_count:data.mitarbeiter_count,brutto_gesamt:bigNums[0]||null,sv_gesamt:bigNums[1]||null,lst_gesamt:bigNums[2]||null,netto_gesamt:bigNums[3]||null,ag_anteil_gesamt:bigNums[4]||null,raw_text:text.substring(0,5000),parsed_data:{detected_numbers:bigNums.slice(0,20),line_count:text.split('\n').length}};
        setParsed(result);setFile(f);log(`‚úÖ Lohnjournal geparsed: ${data.monat||'Monat?'}, ~${data.mitarbeiter_count} Mitarbeiter`,'success')};
    const onD=e=>{e.preventDefault();setDg(false);const f=Array.from(e.dataTransfer.files).find(f=>f.name.endsWith('.pdf'));if(f)parseLJ(f)};
    const doImport=async()=>{if(!parsed)return;setImp(true);const bid=crypto.randomUUID();
        const row={...parsed,dateiname:file.name,import_batch_id:bid,parsed_data:JSON.stringify(parsed.parsed_data)};
        try{const r=await fetch(ap('lohnjournal_imports'),{method:'POST',headers:{...hd(),'Prefer':'return=representation'},body:JSON.stringify(row)});if(!r.ok)throw new Error(await r.text());setRes({inserted:1,updated:0,errors:0});log('‚úÖ Lohnjournal importiert','success');rc()}catch(e){log(`‚ùå Import: ${e.message}`,'error');setRes({inserted:0,updated:0,errors:1})}setImp(false)};
    const reset=()=>{setFile(null);setParsed(null);setRawText('');setRes(null)};
    return(<React.Fragment>
        <div className="eg fi">
            <div className="cd"><div className="cd-t">üíº Lohnjournal PDF Import</div>
                <p style={{fontSize:13,color:'var(--td)',marginBottom:14,lineHeight:1.6}}>Monatliches Lohnjournal vom Steuerberater. PDF wird gescannt und Summen extrahiert.</p>
                {!file&&<div className={`dz ${dg?'dv':''}`} onDragOver={e=>{e.preventDefault();setDg(true)}} onDragLeave={()=>setDg(false)} onDrop={onD} onClick={()=>ref.current?.click()}>Lohnjournal PDF hierher ziehen oder <strong>klicken</strong><input ref={ref} type="file" accept=".pdf" onChange={e=>{if(e.target.files[0])parseLJ(e.target.files[0]);e.target.value=''}}/></div>}
                {file&&<div className="fi2"><span>üìÑ</span><div><span className="fi2-n">{file.name}</span> <span className="fi2-m">¬∑ {(file.size/1024).toFixed(0)} KB</span></div>{!imp&&!res&&<button className="fi2-x" onClick={reset}>‚úï</button>}</div>}
                {parsed&&!imp&&!res&&<button className="btn by" style={{width:'100%',marginTop:10,justifyContent:'center'}} onClick={doImport}>‚ö° Lohnjournal importieren</button>}
                {res&&<React.Fragment><div className="rg"><div className="ri nw"><div className="rn">{res.inserted}</div><div className="rl">Neu</div></div><div className="ri up"><div className="rn">{res.updated}</div><div className="rl">Aktualisiert</div></div><div className="ri er"><div className="rn">{res.errors}</div><div className="rl">Fehler</div></div></div><button className="btn bo bsm" style={{width:'100%',marginTop:6,justifyContent:'center'}} onClick={reset}>‚Üª Neuer Import</button></React.Fragment>}
            </div>
            <div className="cd"><div className="cd-t">üìä Erkannte Daten</div>
                {parsed?<React.Fragment>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10,marginBottom:14}}>
                        <div style={{background:'var(--ad)',borderRadius:8,padding:12,textAlign:'center'}}><div style={{fontSize:11,color:'var(--td)'}}>Monat</div><div style={{fontSize:14,fontWeight:700,color:'var(--a)'}}>{parsed.monat||'‚Äî'}</div></div>
                        <div style={{background:'var(--bld)',borderRadius:8,padding:12,textAlign:'center'}}><div style={{fontSize:11,color:'var(--td)'}}>Mitarbeiter</div><div style={{fontSize:14,fontWeight:700,color:'var(--bl)'}}>~{parsed.mitarbeiter_count}</div></div>
                        <div style={{background:'var(--gd)',borderRadius:8,padding:12,textAlign:'center'}}><div style={{fontSize:11,color:'var(--td)'}}>Brutto Ges.</div><div style={{fontSize:14,fontWeight:700,color:'var(--g)'}}>{parsed.brutto_gesamt?parsed.brutto_gesamt.toLocaleString('de-DE',{minimumFractionDigits:2})+' ‚Ç¨':'‚Äî'}</div></div>
                    </div>
                    <div className="mh">‚ö†Ô∏è PDF-Parsing ist approximativ ‚Äî bitte Werte pr√ºfen</div>
                    <details style={{fontSize:12}}><summary style={{cursor:'pointer',color:'var(--td)',padding:'8px 0'}}>Raw Text anzeigen ({rawText.length} Zeichen)</summary>
                        <div className="lb" style={{maxHeight:200,fontSize:10,whiteSpace:'pre-wrap'}}>{rawText.substring(0,3000)}{rawText.length>3000&&'\n... (gek√ºrzt)'}</div>
                    </details>
                </React.Fragment>:<div style={{fontSize:12,color:'var(--td)',padding:30,textAlign:'center'}}>PDF hochladen um Daten zu extrahieren</div>}
            </div>
        </div>
    </React.Fragment>);
}

// ‚ïê‚ïê‚ïê LOHN SHEET TAB ‚ïê‚ïê‚ïê
function LST({log,rc}){
    const[url,setUrl]=useState(localStorage.getItem('lohnSheetUrl')||'');const[syncing,setSyncing]=useState(false);const[data,setData]=useState(null);const[res,setRes]=useState(null);const[lastSync,setLastSync]=useState(null);
    const extractId=u=>{const m=u.match(/\/d\/([a-zA-Z0-9_-]+)/);return m?m[1]:u};
    const doSync=async()=>{if(!url.trim())return;setSyncing(true);setRes(null);const sid=extractId(url);log(`üìä Google Sheet Sync: ${sid.substring(0,15)}...`,'warn');
        localStorage.setItem('lohnSheetUrl',url);
        try{
            // Try public CSV export
            const csvUrl=`https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:csv`;
            const r=await fetch(csvUrl);if(!r.ok)throw new Error(`Sheet nicht erreichbar (${r.status}). Ist es auf "Jeder mit dem Link" geteilt?`);
            const text=await r.text();const rows=parseCSV(text);if(!rows.length)throw new Error('Keine Daten im Sheet');
            log(`üìä ${rows.length} Zeilen geladen`);setData(rows);
            // Import to Supabase
            const bid=crypto.randomUUID();const headers=Object.keys(rows[0]);
            const dbRows=rows.map((r,i)=>({sheet_id:sid,sheet_name:'Sheet1',zeile_nr:i+2,mitarbeiter_name:r[headers.find(h=>h.toLowerCase().includes('name')||h.toLowerCase().includes('mitarbeiter'))]||`Zeile ${i+2}`,raw_row:JSON.stringify(r),sync_batch_id:bid,synced_at:new Date().toISOString()}));
            // Delete old data for this sheet first
            await fetch(ap('lohn_sheet_data')+`?sheet_id=eq.${sid}`,{method:'DELETE',headers:hd()});
            const ir=await uBat('lohn_sheet_data',dbRows,()=>{});setRes(ir);setLastSync(new Date().toLocaleTimeString('de-DE'));
            log(`‚úÖ Sheet: ${ir.inserted} Zeilen gesynct`,'success');rc()
        }catch(e){log(`‚ùå Sheet: ${e.message}`,'error');setRes({inserted:0,updated:0,errors:1,msg:e.message})}setSyncing(false)};
    const fm=v=>typeof v==='number'?v.toLocaleString('de-DE'):v;
    return(<React.Fragment>
        <div className="eg fi">
            <div className="cd"><div className="cd-t">üìä Google Sheet Auto-Sync</div>
                <p style={{fontSize:13,color:'var(--td)',marginBottom:14,lineHeight:1.6}}>Lohn Google Sheet live anbinden. Sheet muss auf <strong style={{color:'var(--a)'}}>"Jeder mit dem Link"</strong> geteilt sein.</p>
                <div style={{display:'flex',gap:8,marginBottom:14}}>
                    <input value={url} onChange={e=>setUrl(e.target.value)} placeholder="https://docs.google.com/spreadsheets/d/..." style={{flex:1,padding:'9px 14px',borderRadius:8,border:'1px solid var(--b)',background:'var(--el)',color:'var(--t)',fontFamily:'DM Sans',fontSize:13,outline:'none'}}/>
                    <button className="btn by" disabled={syncing||!url.trim()} onClick={doSync}>{syncing?<React.Fragment><span className="spinner"/> Sync...</React.Fragment>:'üîÑ Sync'}</button>
                </div>
                {lastSync&&<div style={{fontSize:11,color:'var(--g)',marginBottom:8}}>‚úÖ Letzter Sync: {lastSync}</div>}
                {res?.msg&&<div style={{fontSize:11,color:'var(--r)',marginBottom:8}}>‚ùå {res.msg}</div>}
                {res&&!res.msg&&<div className="rg"><div className="ri nw"><div className="rn">{res.inserted}</div><div className="rl">Importiert</div></div><div className="ri up"><div className="rn">{res.updated}</div><div className="rl">Aktualisiert</div></div><div className="ri er"><div className="rn">{res.errors}</div><div className="rl">Fehler</div></div></div>}
            </div>
            <div className="cd"><div className="cd-t">üìã Sheet-Daten Vorschau</div>
                {data?<React.Fragment>
                    <div style={{fontSize:11,color:'var(--a)',marginBottom:8}}>{data.length} Zeilen ¬∑ {Object.keys(data[0]).length} Spalten</div>
                    <div style={{maxHeight:250,overflowY:'auto',overflowX:'auto',fontSize:11}}>
                        <table className="mt"><thead><tr>{Object.keys(data[0]).slice(0,8).map((h,i)=><th key={i}>{h.length>15?h.substring(0,15)+'‚Ä¶':h}</th>)}{Object.keys(data[0]).length>8&&<th>...</th>}</tr></thead><tbody>
                        {data.slice(0,15).map((r,i)=><tr key={i}>{Object.values(r).slice(0,8).map((v,j)=><td key={j} style={{maxWidth:100,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{v||'‚Äî'}</td>)}{Object.keys(data[0]).length>8&&<td style={{color:'var(--td)'}}>...</td>}</tr>)}
                        </tbody></table>{data.length>15&&<div style={{textAlign:'center',padding:8,color:'var(--td)'}}>... und {data.length-15} weitere Zeilen</div>}
                    </div>
                </React.Fragment>:<div style={{fontSize:12,color:'var(--td)',padding:30,textAlign:'center'}}>Sheet-URL eingeben und Sync starten</div>}
            </div>
        </div>
        <AutoSync syncKey="lohn_sheet" log={log} extraConfig={url?{sheet_url:url}:null}/>
    </React.Fragment>);
}

// ‚ïê‚ïê‚ïê MERGE TAB ‚ïê‚ïê‚ïê
function MT({log,rc,ct}){
    const[run,setRun]=useState(false);const[mr,setMr]=useState(null);
    const norm=s=>(s||'').toLowerCase().trim().replace(/\s+/g,' ');
    const go=async()=>{setRun(true);setMr(null);log('üîó Auto-Merge gestartet','warn');let le=0,lc=0,ec=0,ew=0;
        try{
            // Phase 1: EFS ‚Üî Leveto Matching (Nachname+PLZ, mit Vorname-Boost)
            log('Phase 1: EFS ‚Üî Leveto matchen (Nachname+PLZ+Vorname)...');
            const er=await(await fetch(ap('efs_projekte')+'?select=efs_id,kunde_nachname,kunde_vorname,kunde_plz,leveto_id&leveto_id=is.null&limit=2000',{headers:hd()})).json();
            if(er.length>0){
                const lr=await(await fetch(ap('leveto_leads')+'?select=id,leveto_id,vorname,nachname,plz&limit=25000',{headers:hd()})).json();
                const lkNP={};lr.forEach(l=>{const k=`${norm(l.nachname)}_${(l.plz||'').trim()}`;if(!lkNP[k])lkNP[k]=[];lkNP[k].push(l)});
                for(const e of er){
                    const k=`${norm(e.kunde_nachname)}_${(e.kunde_plz||'').trim()}`;
                    const cands=lkNP[k];
                    if(cands){
                        // Prefer vorname match if possible
                        const evn=norm(e.kunde_vorname||'').split(' ')[0];
                        let best=cands[0];
                        if(evn.length>=2){const vnM=cands.find(c=>norm(c.vorname||'').startsWith(evn.substring(0,3)));if(vnM)best=vnM;}
                        await fetch(ap('efs_projekte')+`?efs_id=eq.${e.efs_id}`,{method:'PATCH',headers:hd(),body:JSON.stringify({leveto_id:best.leveto_id})});le++
                    }
                }
                log(`‚úÖ Phase 1: ${le} neue Matches`,'success');
            }else log('Phase 1: Alle bereits gematcht');

            // Phase 2: EFS-Daten ‚Üí Leveto schreiben (IMMER f√ºr alle gematchten)
            log('Phase 2: EFS-Daten ‚Üí Leveto Leads √ºbertragen...');
            const allEfs=[];
            for(let off=0;off<2000;off+=1000){const batch=await(await fetch(ap('efs_projekte')+`?select=efs_id,leveto_id,status,simplified_status,gesamtpreis_eur,monatl_rate_eur,pv_kwp,bat_kwh,installed_at,grid_connected_at,zustaendiger,preismodell&leveto_id=not.is.null&limit=1000&offset=${off}`,{headers:hd()})).json();if(!batch.length)break;allEfs.push(...batch)}
            if(allEfs.length>0){
                // Load all leveto with leveto_id for lookup
                const allLev=[];
                for(let off=0;off<30000;off+=1000){const batch=await(await fetch(ap('leveto_leads')+`?select=id,leveto_id&limit=1000&offset=${off}`,{headers:hd()})).json();if(!batch.length)break;allLev.push(...batch)}
                const levMap={};allLev.forEach(l=>{levMap[l.leveto_id]=l.id});
                const now=new Date().toISOString();
                for(const e of allEfs){
                    const lid=levMap[e.leveto_id];
                    if(!lid)continue;
                    const patch={
                        efs_id:e.efs_id,
                        efs_status:e.status,
                        efs_simplified_status:e.simplified_status,
                        efs_gesamtpreis_eur:e.gesamtpreis_eur,
                        efs_monatl_rate_eur:e.monatl_rate_eur,
                        efs_pv_kwp:e.pv_kwp,
                        efs_bat_kwh:e.bat_kwh,
                        efs_installed_at:e.installed_at,
                        efs_grid_connected_at:e.grid_connected_at,
                        efs_zustaendiger:(e.zustaendiger||'').replace(/\t/g,'').trim(),
                        efs_preismodell:e.preismodell,
                        efs_merged_at:now
                    };
                    await fetch(ap('leveto_leads')+`?id=eq.${lid}`,{method:'PATCH',headers:hd(),body:JSON.stringify(patch)});ew++
                }
                log(`‚úÖ Phase 2: ${ew} Leveto-Leads mit EFS-Daten aktualisiert`,'success');
            }else log('Phase 2: Keine gematchten EFS-Projekte');

            // Phase 3: CSV ‚Üî Leveto
            log('Phase 3: CSV ‚Üî Leveto (Lead ID)...');const pr=await(await fetch(ap('import_provisions')+'?select=an_nr,lead_id&lead_id=not.is.null&limit=5000',{headers:hd()})).json();
            if(pr.length>0){const li=await(await fetch(ap('leveto_leads')+'?select=id,leveto_id&limit=50000',{headers:hd()})).json();const ik={};li.forEach(l=>{ik[l.leveto_id]=l.id});for(const p of pr)if(ik[p.lead_id])lc++; log(`‚úÖ Phase 3: ${lc} CSV ‚Üî Leveto zuordenbar`,'success')}

            // Phase 4: EFS ‚Üî CSV
            log('Phase 4: EFS ‚Üî CSV (Name + PLZ)...');const ea=await(await fetch(ap('efs_projekte')+'?select=efs_id,kunde_nachname,kunde_plz&limit=2000',{headers:hd()})).json();const pa=await(await fetch(ap('import_provisions')+'?select=an_nr,kunde,kunde_plz&limit=5000',{headers:hd()})).json();
            const pk={};pa.forEach(p=>{const nm=(p.kunde||'').split(/\s+/).pop()||'';const k=`${nm.toLowerCase()}_${p.kunde_plz||''}`;if(!pk[k])pk[k]=[];pk[k].push(p)});for(const e of ea){const k=`${norm(e.kunde_nachname)}_${e.kunde_plz||''}`;if(pk[k])ec++}log(`‚úÖ Phase 4: ${ec} EFS ‚Üî CSV Matches`,'success');

            setMr({le,ew,lc,ec});log(`üîó Merge fertig: ${le} neue Matches, ${ew} Leads aktualisiert`,'success');
        }catch(e){log(`‚ùå Merge: ${e.message}`,'error')}setRun(false);rc()};
    const fm=v=>typeof v==='number'?v.toLocaleString('de-DE'):v;
    return(<React.Fragment>
        <div className="cd fi"><div className="cd-t">üîó Datenquellen verkn√ºpfen</div>
            <p style={{fontSize:13,color:'var(--td)',marginBottom:16,lineHeight:1.6}}>Matcht Leveto ‚Üî EFS ‚Üî CSV √ºber Name+PLZ und Lead-IDs. Schreibt EFS-Status, Preis, kWp und Anlagendaten direkt in die Leveto-Leads.</p>
            <div className="mg">{[{i:'üîÑ',v:ct.leveto,l:'Leveto Leads'},{i:'üìä',v:ct.efs,l:'EFS Projekte'},{i:'üí∞',v:ct.auftraege,l:'CSV Auftr√§ge'},{i:'üè¶',v:ct.bank,l:'Bank Trans.'}].map(s=><div key={s.l} className="mc"><div style={{fontSize:28}}>{s.i}</div><div className="mv">{fm(s.v)}</div><div className="ml">{s.l}</div></div>)}</div>
            <button className="btn by" disabled={run} onClick={go} style={{width:'100%',justifyContent:'center'}}>{run?<React.Fragment><span className="spinner"/> Merge l√§uft...</React.Fragment>:'üîó Auto-Merge starten'}</button>
        </div>
        {mr&&<div className="cd fi"><div className="cd-t">‚úÖ Merge-Ergebnis</div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:14}}>
                {[{v:mr.le,l:'Neue EFS‚ÜîLeveto Matches',bg:'var(--ad)',c:'var(--a)'},{v:mr.ew,l:'Leveto mit EFS aktualisiert',bg:'rgba(245,197,0,0.15)',c:'var(--a)'},{v:mr.lc,l:'CSV ‚Üî Leveto',bg:'var(--bld)',c:'var(--bl)'},{v:mr.ec,l:'EFS ‚Üî CSV',bg:'var(--gd)',c:'var(--g)'}].map(s=><div key={s.l} style={{background:s.bg,borderRadius:10,padding:16,textAlign:'center'}}><div style={{fontSize:24,fontWeight:700,color:s.c}}>{s.v}</div><div style={{fontSize:11,color:'var(--td)',marginTop:4}}>{s.l}</div></div>)}
            </div>
        </div>}
        <div className="cd fi"><div className="cd-t">‚ÑπÔ∏è Merge-Logik</div>
            <table className="mt"><thead><tr><th>Phase</th><th>Aktion</th><th>Match-Kriterium</th></tr></thead><tbody>
                <tr><td style={{color:'var(--a)'}}>1</td><td>EFS ‚Üî Leveto verkn√ºpfen</td><td>Nachname + PLZ + Vorname</td></tr>
                <tr><td style={{color:'var(--a)'}}>2</td><td><strong>EFS ‚Üí Leveto Daten schreiben</strong></td><td>Status, Preis, kWp, Batterie, Montage-Datum</td></tr>
                <tr><td style={{color:'var(--bl)'}}>3</td><td>CSV ‚Üî Leveto</td><td>Lead ID (direkt)</td></tr>
                <tr><td style={{color:'var(--g)'}}>4</td><td>EFS ‚Üî CSV</td><td>Kunde Nachname + PLZ</td></tr>
            </tbody></table>
            <div style={{marginTop:12,fontSize:12,color:'var(--td)',lineHeight:1.6}}>
                <strong style={{color:'var(--tb)'}}>EFS-Felder in Leveto:</strong> efs_status, efs_simplified_status, efs_gesamtpreis_eur, efs_monatl_rate_eur, efs_pv_kwp, efs_bat_kwh, efs_installed_at, efs_grid_connected_at, efs_zustaendiger, efs_preismodell
            </div>
        </div>
        <AutoSync syncKey="auto_merge" log={log}/>
    </React.Fragment>);
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>

