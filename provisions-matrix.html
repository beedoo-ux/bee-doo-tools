<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>bee-doo PAY ‚Äì Provisions-Matrix</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0c14;--s1:#0f1119;--s2:#14161f;--s3:#1a1d27;--s4:#222531;--bd:#2a2d37;--tx:#e2e4ea;--ts:#8b95a5;--y:#F5C500;--g:#34d399;--r:#f87171;--b:#60a5fa;--o:#fb923c;--t:#2dd4bf;--p:#a78bfa}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--s1)}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
input,select,textarea{font-family:inherit;font-size:13px;background:var(--s1);color:var(--tx);border:1px solid var(--bd);border-radius:6px;padding:6px 10px;outline:none;transition:border .2s}
input:focus,select:focus,textarea:focus{border-color:var(--y)}
select{cursor:pointer}
button{font-family:inherit;cursor:pointer;border:none;outline:none;transition:all .2s}
table{width:100%;border-collapse:collapse}
th{background:var(--s3);color:var(--ts);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;padding:10px 12px;text-align:left;position:sticky;top:0;z-index:2;border-bottom:2px solid var(--bd)}
td{padding:8px 12px;border-bottom:1px solid var(--bd);font-size:13px;vertical-align:middle}
tr:hover td{background:var(--s2)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}
.b-y{background:#F5C50018;color:var(--y)}
.b-g{background:#34d39918;color:var(--g)}
.b-r{background:#f8717118;color:var(--r)}
.b-b{background:#60a5fa18;color:var(--b)}
.b-o{background:#fb923c18;color:var(--o)}
.b-t{background:#2dd4bf18;color:var(--t)}
.b-p{background:#a78bfa18;color:var(--p)}
.eur{font-variant-numeric:tabular-nums;text-align:right;font-weight:600}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .3s ease}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{animation:spin .8s linear infinite}
@media(max-width:768px){
  .desktop-only{display:none!important}
  .tab-bar{flex-wrap:wrap;gap:4px!important}
  .tab-btn{font-size:11px!important;padding:6px 10px!important}
  th,td{padding:6px 8px;font-size:11px}
  .hdr-title{font-size:16px!important}
}
@media(max-width:480px){
  .tab-btn{font-size:10px!important;padding:5px 8px!important}
  th,td{padding:4px 6px;font-size:10px}
  input,select{font-size:11px;padding:4px 7px}
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ‚ïê‚ïê‚ïê Config ‚ïê‚ïê‚ïê
const SB = "https://hqzpemfaljxcysyqssng.supabase.co";
const AK = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik";
const H = { apikey: AK, Authorization: `Bearer ${AK}`, "Content-Type": "application/json" };

const db = {
  get: async (t, q = "") => { const r = await fetch(`${SB}/rest/v1/${t}${q}`, { headers: H }); if (!r.ok) throw new Error(await r.text()); return r.json(); },
  post: async (t, b) => { const r = await fetch(`${SB}/rest/v1/${t}`, { method: "POST", headers: { ...H, Prefer: "return=representation" }, body: JSON.stringify(b) }); if (!r.ok) throw new Error(await r.text()); return r.json(); },
  patch: async (t, w, b) => { const r = await fetch(`${SB}/rest/v1/${t}?${w}`, { method: "PATCH", headers: { ...H, Prefer: "return=representation" }, body: JSON.stringify(b) }); if (!r.ok) throw new Error(await r.text()); return r.json(); },
  del: async (t, w) => { const r = await fetch(`${SB}/rest/v1/${t}?${w}`, { method: "DELETE", headers: H }); if (!r.ok) throw new Error(await r.text()); }
};

const eur = v => v == null ? "‚Äì" : Number(v).toLocaleString("de-DE", { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + " ‚Ç¨";
const ts = () => new Date().toISOString();

// ‚ïê‚ïê‚ïê Components ‚ïê‚ïê‚ïê
function Toast({ msg, type }) {
  if (!msg) return null;
  const c = type === "ok" ? "var(--g)" : type === "err" ? "var(--r)" : "var(--y)";
  return <div style={{ position: "fixed", bottom: 20, right: 20, background: "var(--s3)", border: `1px solid ${c}`, color: c, padding: "10px 18px", borderRadius: 8, fontSize: 13, fontWeight: 600, zIndex: 999, boxShadow: "0 8px 24px #0008" }} className="fade-in">{msg}</div>;
}

function Btn({ label, color, onClick, small, disabled, icon }) {
  return <button disabled={disabled} onClick={onClick} style={{ background: disabled ? "var(--bd)" : `${color || "var(--y)"}18`, color: disabled ? "var(--ts)" : color || "var(--y)", border: `1px solid ${disabled ? "var(--bd)" : `${color || "var(--y)"}44`}`, borderRadius: 6, padding: small ? "4px 10px" : "7px 16px", fontSize: small ? 11 : 13, fontWeight: 600, opacity: disabled ? .5 : 1 }}>{icon && <span style={{ marginRight: 4 }}>{icon}</span>}{label}</button>;
}

function EditCell({ value, onChange, type = "text", options, width, align }) {
  if (type === "select") {
    return <select value={value || ""} onChange={e => onChange(e.target.value)} style={{ width: width || "100%", textAlign: align }}>
      {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
    </select>;
  }
  return <input type={type === "number" ? "number" : "text"} value={value ?? ""} onChange={e => onChange(type === "number" ? (e.target.value === "" ? null : +e.target.value) : e.target.value)} style={{ width: width || "100%", textAlign: align || (type === "number" ? "right" : "left") }} />;
}

function SearchSelect({ value, onChange, options, placeholder = "Suchen...", width }) {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState("");
  const ref = React.useRef(null);
  useEffect(() => { const h = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); }; document.addEventListener("mousedown", h); return () => document.removeEventListener("mousedown", h); }, []);
  const filtered = options.filter(o => o.label.toLowerCase().includes(query.toLowerCase()));
  return <div ref={ref} style={{ position: "relative", width: width || "100%" }}>
    <div onClick={() => setOpen(!open)} style={{ background: "var(--s2)", border: "1px solid var(--bd)", borderRadius: 6, padding: "6px 10px", cursor: "pointer", fontSize: 12, color: value ? "#fff" : "var(--ts)", display: "flex", justifyContent: "space-between", alignItems: "center", minHeight: 32 }}>
      <span style={{ overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{value || placeholder}</span>
      <span style={{ fontSize: 10, marginLeft: 6, opacity: 0.5 }}>‚ñº</span>
    </div>
    {open && <div style={{ position: "absolute", top: "100%", left: 0, right: 0, zIndex: 100, background: "var(--s2)", border: "1px solid var(--bd)", borderRadius: 8, marginTop: 2, boxShadow: "0 8px 24px #0008", maxHeight: 240, display: "flex", flexDirection: "column" }}>
      <div style={{ padding: 6 }}>
        <input autoFocus type="text" value={query} onChange={e => setQuery(e.target.value)} placeholder="Name eingeben..." style={{ width: "100%", padding: "6px 10px", fontSize: 12, background: "var(--s1)", border: "1px solid var(--bd)", borderRadius: 6, color: "#fff" }} />
      </div>
      <div style={{ overflowY: "auto", maxHeight: 190, padding: "0 4px 4px" }}>
        {filtered.length === 0 && <div style={{ padding: "8px 10px", fontSize: 11, color: "var(--ts)" }}>Keine Treffer</div>}
        {filtered.map(o => <div key={o.value} onClick={() => { onChange(o.value); setOpen(false); setQuery(""); }} style={{ padding: "7px 10px", cursor: "pointer", borderRadius: 6, fontSize: 12, color: value === o.value ? "var(--y)" : "#ccc", fontWeight: value === o.value ? 600 : 400, background: value === o.value ? "var(--y)15" : "transparent" }} onMouseOver={e => e.currentTarget.style.background = "var(--y)15"} onMouseOut={e => e.currentTarget.style.background = value === o.value ? "var(--y)15" : "transparent"}>
          {o.label}
        </div>)}
      </div>
    </div>}
  </div>;
}

function MultiSearchSelect({ value = [], onChange, options, placeholder = "Mitglieder w√§hlen..." }) {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState("");
  const ref = React.useRef(null);
  useEffect(() => { const h = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); }; document.addEventListener("mousedown", h); return () => document.removeEventListener("mousedown", h); }, []);
  const selected = Array.isArray(value) ? value : (value ? String(value).split(",").map(s => s.trim()).filter(Boolean) : []);
  const filtered = options.filter(o => o.label.toLowerCase().includes(query.toLowerCase()));
  const toggle = (name) => {
    const next = selected.includes(name) ? selected.filter(n => n !== name) : [...selected, name];
    onChange(next);
  };
  return <div ref={ref} style={{ position: "relative" }}>
    <div onClick={() => setOpen(!open)} style={{ background: "var(--s2)", border: "1px solid var(--bd)", borderRadius: 6, padding: "4px 10px", cursor: "pointer", fontSize: 11, color: selected.length ? "#fff" : "var(--ts)", minHeight: 32, display: "flex", alignItems: "center", gap: 4, flexWrap: "wrap" }}>
      {selected.length === 0 && <span>{placeholder}</span>}
      {selected.map(n => <span key={n} style={{ background: "var(--t)", color: "#fff", borderRadius: 4, padding: "2px 6px", fontSize: 10, display: "inline-flex", alignItems: "center", gap: 4 }}>
        {n} <span onClick={e => { e.stopPropagation(); toggle(n); }} style={{ cursor: "pointer", opacity: 0.7, fontWeight: 700 }}>√ó</span>
      </span>)}
      <span style={{ fontSize: 10, marginLeft: "auto", opacity: 0.5 }}>‚ñº</span>
    </div>
    {open && <div style={{ position: "absolute", top: "100%", left: 0, right: 0, zIndex: 100, background: "var(--s2)", border: "1px solid var(--bd)", borderRadius: 8, marginTop: 2, boxShadow: "0 8px 24px #0008", maxHeight: 280, display: "flex", flexDirection: "column", minWidth: 280 }}>
      <div style={{ padding: 6 }}>
        <input autoFocus type="text" value={query} onChange={e => setQuery(e.target.value)} placeholder="Name suchen..." style={{ width: "100%", padding: "6px 10px", fontSize: 12, background: "var(--s1)", border: "1px solid var(--bd)", borderRadius: 6, color: "#fff" }} />
      </div>
      <div style={{ overflowY: "auto", maxHeight: 220, padding: "0 4px 4px" }}>
        {filtered.map(o => {
          const isSel = selected.includes(o.label);
          return <div key={o.value} onClick={() => toggle(o.label)} style={{ padding: "6px 10px", cursor: "pointer", borderRadius: 6, fontSize: 12, display: "flex", alignItems: "center", gap: 8, color: isSel ? "var(--g)" : "#ccc", background: isSel ? "var(--g)12" : "transparent" }} onMouseOver={e => e.currentTarget.style.background = isSel ? "var(--g)18" : "var(--y)10"} onMouseOut={e => e.currentTarget.style.background = isSel ? "var(--g)12" : "transparent"}>
            <span style={{ width: 18, height: 18, borderRadius: 4, border: `2px solid ${isSel ? "var(--g)" : "var(--bd)"}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, flexShrink: 0 }}>{isSel ? "‚úì" : ""}</span>
            {o.label}
          </div>;
        })}
      </div>
      {selected.length > 0 && <div style={{ padding: "6px 10px", borderTop: "1px solid var(--bd)", fontSize: 11, color: "var(--ts)" }}>{selected.length} ausgew√§hlt</div>}
    </div>}
  </div>;
}

function ConfirmModal({ msg, onOk, onCancel }) {
  return <div style={{ position: "fixed", inset: 0, background: "#000a", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 1000 }}>
    <div style={{ background: "var(--s2)", border: "1px solid var(--bd)", borderRadius: 12, padding: 24, maxWidth: 400, width: "90%" }} className="fade-in">
      <div style={{ fontSize: 14, marginBottom: 16, lineHeight: 1.5 }}>{msg}</div>
      <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
        <Btn label="Abbrechen" color="var(--ts)" onClick={onCancel} small />
        <Btn label="L√∂schen" color="var(--r)" onClick={onOk} small icon="üóëÔ∏è" />
      </div>
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: Provisions-Regeln ‚ïê‚ïê‚ïê
function TabRegeln({ regeln, setRegeln, toast }) {
  const save = async (r) => {
    try {
      await db.patch("provisions_regeln", `id=eq.${r.id}`, {
        basis_betrag_sale: r.basis_betrag_sale, staffel_betrag_sale: r.staffel_betrag_sale,
        staffel_schwelle: r.staffel_schwelle, betrag_eigenlead: r.betrag_eigenlead,
        betrag_empfehlung: r.betrag_empfehlung, betrag_speicher: r.betrag_speicher,
        betrag_termin_sf: r.betrag_termin_sf, betrag_lead: r.betrag_lead,
        betrag_sondereinsatz: r.betrag_sondereinsatz, betrag_zero: r.betrag_zero, rueckwirkend: r.rueckwirkend,
        geaendert_am: ts()
      });
      toast("Regel gespeichert", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const upd = (id, k, v) => setRegeln(prev => prev.map(r => r.id === id ? { ...r, [k]: v } : r));

  return <div>
    <div style={{ display: "grid", gap: 16 }}>
      {regeln.map(r => <div key={r.id} style={{ background: "var(--s2)", border: "1px solid var(--bd)", borderRadius: 10, padding: 16 }} className="fade-in">
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
          <div>
            <div style={{ fontWeight: 700, fontSize: 15, color: "var(--y)" }}>{r.modell_name}</div>
            <span className="badge b-b">{r.mitarbeiter_typ}</span>
          </div>
          <Btn label="Speichern" onClick={() => save(r)} small icon="üíæ" />
        </div>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill,minmax(180px,1fr))", gap: 8 }}>
          {[
            ["Basis ‚Ç¨/Sale", "basis_betrag_sale", "number"],
            ["Staffel ‚Ç¨/Sale", "staffel_betrag_sale", "number"],
            ["Staffel ab", "staffel_schwelle", "number"],
            ["Eigenlead ‚Ç¨", "betrag_eigenlead", "number"],
            ["Empfehlung ‚Ç¨", "betrag_empfehlung", "number"],
            ["Speicher ‚Ç¨", "betrag_speicher", "number"],
            ["Termin SF ‚Ç¨", "betrag_termin_sf", "number"],
            ["Lead ‚Ç¨", "betrag_lead", "number"],
            ["Sondereinsatz ‚Ç¨", "betrag_sondereinsatz", "number"],
            ["Zero ‚Ç¨", "betrag_zero", "number"],
          ].map(([lbl, key, type]) => <div key={key}>
            <div style={{ fontSize: 10, color: "var(--ts)", marginBottom: 3, textTransform: "uppercase", fontWeight: 600 }}>{lbl}</div>
            <EditCell value={r[key]} onChange={v => upd(r.id, key, v)} type={type} />
          </div>)}
          <div>
            <div style={{ fontSize: 10, color: "var(--ts)", marginBottom: 3, textTransform: "uppercase", fontWeight: 600 }}>R√ºckwirkend</div>
            <EditCell value={r.rueckwirkend ? "ja" : "nein"} onChange={v => upd(r.id, "rueckwirkend", v === "ja")} type="select" options={[{ value: "ja", label: "‚úì Ja" }, { value: "nein", label: "‚úó Nein" }]} />
          </div>
        </div>
      </div>)}
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: Sonderprovisionen ‚ïê‚ïê‚ïê
function TabSonder({ sonder, setSonder, toast, mitarbeiterList }) {
  const [adding, setAdding] = useState(false);
  const [newRow, setNewRow] = useState({ mitarbeiter_name: "", mitarbeiter_id: "", typ: "flat_rate", betrag: 0, beschreibung: "", gueltig_ab: "2026-01-01" });
  const maOptions = mitarbeiterList.map(m => ({ value: m.id, label: `${m.vorname} ${m.nachname}` }));
  const [delId, setDelId] = useState(null);

  const save = async (s) => {
    try {
      await db.patch("pay_sonderprovisionen", `id=eq.${s.id}`, {
        mitarbeiter_name: s.mitarbeiter_name, typ: s.typ, betrag: s.betrag,
        beschreibung: s.beschreibung, gueltig_ab: s.gueltig_ab, gueltig_bis: s.gueltig_bis,
        aktiv: s.aktiv, geaendert_am: ts()
      });
      toast("Gespeichert", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const add = async () => {
    try {
      const res = await db.post("pay_sonderprovisionen", { ...newRow, aktiv: true });
      setSonder(prev => [...prev, res[0]]);
      setAdding(false);
      setNewRow({ mitarbeiter_name: "", typ: "flat_rate", betrag: 0, beschreibung: "", gueltig_ab: "2026-01-01" });
      toast("Hinzugef√ºgt", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const remove = async (id) => {
    try {
      await db.del("pay_sonderprovisionen", `id=eq.${id}`);
      setSonder(prev => prev.filter(s => s.id !== id));
      setDelId(null);
      toast("Gel√∂scht", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const upd = (id, k, v) => setSonder(prev => prev.map(s => s.id === id ? { ...s, [k]: v } : s));

  const typLabels = { flat_rate: "Flat Rate", eigenlead_override: "Eigenlead Override", empfehlung_override: "Empfehlung Override", speicher_override: "Speicher Override", scout_eigenlead: "Scout ‚Üí Eigenlead", scout_umleitung: "Scout-Umleitung", skip_abrechnung: "√úbersprungen" };
  const typOpts = Object.entries(typLabels).map(([v, l]) => ({ value: v, label: l }));

  return <div>
    {delId && <ConfirmModal msg="Sonderprovision wirklich l√∂schen?" onOk={() => remove(delId)} onCancel={() => setDelId(null)} />}
    <div style={{ marginBottom: 12, display: "flex", gap: 8 }}>
      <Btn label="+ Neue Sonderprovision" onClick={() => setAdding(true)} icon="‚≠ê" />
    </div>
    <div style={{ overflowX: "auto" }}>
      <table>
        <thead><tr>
          <th>Mitarbeiter</th><th>Typ</th><th style={{ textAlign: "right" }}>Betrag</th>
          <th>Beschreibung</th><th>G√ºltig ab</th><th>G√ºltig bis</th><th>Aktiv</th><th style={{ width: 100 }}>Aktionen</th>
        </tr></thead>
        <tbody>
          {adding && <tr style={{ background: "var(--y)08" }}>
            <td><SearchSelect value={newRow.mitarbeiter_name} onChange={name => { const ma = mitarbeiterList.find(m => `${m.vorname} ${m.nachname}` === name); setNewRow(p => ({ ...p, mitarbeiter_name: name, mitarbeiter_id: ma?.id || "" })); }} options={maOptions.map(o => ({ ...o, value: o.label }))} placeholder="Mitarbeiter w√§hlen..." /></td>
            <td><EditCell value={newRow.typ} onChange={v => setNewRow(p => ({ ...p, typ: v }))} type="select" options={typOpts} /></td>
            <td><EditCell value={newRow.betrag} onChange={v => setNewRow(p => ({ ...p, betrag: v }))} type="number" /></td>
            <td><EditCell value={newRow.beschreibung} onChange={v => setNewRow(p => ({ ...p, beschreibung: v }))} /></td>
            <td><EditCell value={newRow.gueltig_ab} onChange={v => setNewRow(p => ({ ...p, gueltig_ab: v }))} type="date" /></td>
            <td>‚Äì</td>
            <td><span className="badge b-g">Ja</span></td>
            <td style={{ display: "flex", gap: 4 }}>
              <Btn label="‚úì" color="var(--g)" onClick={add} small />
              <Btn label="‚úó" color="var(--r)" onClick={() => setAdding(false)} small />
            </td>
          </tr>}
          {sonder.map(s => {
            const desc = (s.beschreibung||'').toLowerCase();
            const flags = {
              kein_eigenlead: desc.includes('kein eigenlead'),
              kein_empfehlung: desc.includes('kein empfehlung'),
              kein_stufenbonus: desc.includes('kein stufenbonus'),
              kein_speicher: desc.includes('kein speicher'),
            };
            const toggleFlag = (flag, label) => {
              let b = s.beschreibung || '';
              if(flags[flag]) {
                b = b.replace(new RegExp(',?\\s*kein '+label, 'i'), '').replace(/^,\s*/, '').replace(/,\s*$/, '');
              } else {
                b = b ? b + ', kein ' + label : 'kein ' + label;
              }
              upd(s.id, 'beschreibung', b.trim());
            };
            return <React.Fragment key={s.id}>
            <tr>
              <td style={{ fontWeight: 600 }}>{s.mitarbeiter_name}</td>
              <td><EditCell value={s.typ} onChange={v => upd(s.id, "typ", v)} type="select" options={typOpts} width="140px" /></td>
              <td><EditCell value={s.betrag} onChange={v => upd(s.id, "betrag", v)} type="number" width="90px" /></td>
              <td><EditCell value={s.beschreibung} onChange={v => upd(s.id, "beschreibung", v)} /></td>
              <td><EditCell value={s.gueltig_ab?.slice(0, 10)} onChange={v => upd(s.id, "gueltig_ab", v)} /></td>
              <td><EditCell value={s.gueltig_bis?.slice(0, 10) || ""} onChange={v => upd(s.id, "gueltig_bis", v || null)} /></td>
              <td><span className={`badge ${s.aktiv ? "b-g" : "b-r"}`} style={{ cursor: "pointer" }} onClick={() => upd(s.id, "aktiv", !s.aktiv)}>{s.aktiv ? "‚úì Ja" : "‚úó Nein"}</span></td>
              <td style={{ display: "flex", gap: 4 }}>
                <Btn label="üíæ" color="var(--g)" onClick={() => save(s)} small />
                <Btn label="üóëÔ∏è" color="var(--r)" onClick={() => setDelId(s.id)} small />
              </td>
            </tr>
            <tr><td colSpan={8} style={{padding:'2px 8px 8px',borderBottom:'1px solid var(--bd)'}}>
              <div style={{display:'flex',gap:6,flexWrap:'wrap',alignItems:'center'}}>
                <span style={{fontSize:10,color:'var(--ts)',marginRight:4}}>Bonus-Ausschl√ºsse:</span>
                {[['kein_eigenlead','Eigenlead','üéØ'],['kein_empfehlung','Empfehlung','ü§ù'],['kein_stufenbonus','Stufenbonus','üèÜ'],['kein_speicher','Speicher','üîã']].map(([flag,label,icon])=>
                  <span key={flag} onClick={()=>toggleFlag(flag,label)} style={{cursor:'pointer',fontSize:11,padding:'3px 10px',borderRadius:6,fontWeight:600,
                    background:flags[flag]?'#f8514920':'var(--c2)',color:flags[flag]?'var(--r)':'var(--ts)',
                    border:`1px solid ${flags[flag]?'#f8514940':'var(--bd)'}`}}>{icon} {flags[flag]?'‚úó Kein '+label:'‚úì '+label}</span>
                )}
              </div>
            </td></tr>
            </React.Fragment>;
          })}
          {!sonder.length && !adding && <tr><td colSpan={8} style={{ textAlign: "center", color: "var(--ts)", padding: 24 }}>Keine Sonderprovisionen vorhanden</td></tr>}
        </tbody>
      </table>
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: Stufenbonus ‚ïê‚ïê‚ïê
function TabStufen({ stufen, setStufen, toast }) {
  const [adding, setAdding] = useState(false);
  const [newRow, setNewRow] = useState({ stufe_name: "", min_anlagen: 10, bonus_betrag: 2000, gilt_fuer: "hgb_vertriebler_haupt" });

  const save = async (s) => {
    try {
      await db.patch("pay_stufenbonus", `id=eq.${s.id}`, { stufe_name: s.stufe_name, min_anlagen: s.min_anlagen, bonus_betrag: s.bonus_betrag, gilt_fuer: s.gilt_fuer, aktiv: s.aktiv });
      toast("Gespeichert", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const add = async () => {
    try {
      const res = await db.post("pay_stufenbonus", { ...newRow, aktiv: true });
      setStufen(prev => [...prev, res[0]]);
      setAdding(false); toast("Hinzugef√ºgt", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const upd = (id, k, v) => setStufen(prev => prev.map(s => s.id === id ? { ...s, [k]: v } : s));

  return <div>
    <div style={{ marginBottom: 16, background: '#1a1f2e', border: '1px solid #F5C500', borderRadius: 8, padding: '12px 16px' }}>
      <div style={{ fontSize: 13, fontWeight: 700, color: '#F5C500', marginBottom: 6 }}>üìã Stufenbonus-Regel</div>
      <div style={{ fontSize: 12, color: '#c9d1d9', lineHeight: 1.6 }}>
        Stufenbonus z√§hlt <b style={{ color: '#F5C500' }}>NUR Auftr√§ge aus dem aktuellen Leistungszeitraum (LZ)</b>. Nachz√ºgler (NZ) aus Vormonaten werden <b style={{ color: '#da3633' }}>NICHT</b> mitgez√§hlt.<br/>
        <b style={{ color: '#da3633' }}>Wichtig:</b> Bereits abgerechnete Vormonate werden <b style={{ color: '#da3633' }}>NICHT</b> erneut gepr√ºft. Nur die Monate der aktuellen LZ-Auftr√§ge z√§hlen f√ºr den Stufenbonus.<br/>
        Beispiel: VT hatte 11 Sales Nov (bereits bezahlt) + 3 LZ-Sales Jan ‚Üí Stufe basiert auf <b style={{ color: '#F5C500' }}>3 Sales</b>, nicht 11.
      </div>
    </div>
    <div style={{ marginBottom: 12 }}><Btn label="+ Neue Stufe" onClick={() => setAdding(true)} icon="üèÜ" /></div>
    <div style={{ overflowX: "auto" }}>
      <table>
        <thead><tr><th>Stufe</th><th style={{ textAlign: "right" }}>Min. Anlagen</th><th style={{ textAlign: "right" }}>Bonus</th><th>Gilt f√ºr</th><th>Aktiv</th><th style={{ width: 80 }}>Aktion</th></tr></thead>
        <tbody>
          {adding && <tr style={{ background: "var(--y)08" }}>
            <td><EditCell value={newRow.stufe_name} onChange={v => setNewRow(p => ({ ...p, stufe_name: v }))} /></td>
            <td><EditCell value={newRow.min_anlagen} onChange={v => setNewRow(p => ({ ...p, min_anlagen: v }))} type="number" width="80px" /></td>
            <td><EditCell value={newRow.bonus_betrag} onChange={v => setNewRow(p => ({ ...p, bonus_betrag: v }))} type="number" width="100px" /></td>
            <td><EditCell value={newRow.gilt_fuer} onChange={v => setNewRow(p => ({ ...p, gilt_fuer: v }))} type="select" options={[{value:"hgb_vertriebler_haupt",label:"HGB Vertriebler Haupt"},{value:"hgb_vertriebler_agentur",label:"HGB Vertriebler Agentur"},{value:"angestellt_vertriebler",label:"Angestellt Vertriebler"},{value:"vertriebler",label:"Vertriebler"},{value:"hgb_scouter",label:"HGB Scouter"},{value:"angestellt_scouter",label:"Angestellt Scouter"},{value:"montage_partner",label:"Montage Partner"}]} /></td>
            <td><span className="badge b-g">Ja</span></td>
            <td><Btn label="‚úì" color="var(--g)" onClick={add} small /> <Btn label="‚úó" color="var(--r)" onClick={() => setAdding(false)} small /></td>
          </tr>}
          {stufen.map(s => <tr key={s.id}>
            <td><EditCell value={s.stufe_name} onChange={v => upd(s.id, "stufe_name", v)} width="120px" /></td>
            <td><EditCell value={s.min_anlagen} onChange={v => upd(s.id, "min_anlagen", v)} type="number" width="80px" /></td>
            <td className="eur" style={{ color: "var(--y)" }}><EditCell value={s.bonus_betrag} onChange={v => upd(s.id, "bonus_betrag", v)} type="number" width="100px" align="right" /></td>
            <td><EditCell value={s.gilt_fuer} onChange={v => upd(s.id, "gilt_fuer", v)} type="select" options={[{value:"hgb_vertriebler_haupt",label:"HGB Vertriebler Haupt"},{value:"hgb_vertriebler_agentur",label:"HGB Vertriebler Agentur"},{value:"angestellt_vertriebler",label:"Angestellt Vertriebler"},{value:"vertriebler",label:"Vertriebler"},{value:"hgb_scouter",label:"HGB Scouter"},{value:"angestellt_scouter",label:"Angestellt Scouter"},{value:"montage_partner",label:"Montage Partner"}]} width="180px" /></td>
            <td><span className={`badge ${s.aktiv ? "b-g" : "b-r"}`} style={{ cursor: "pointer" }} onClick={() => upd(s.id, "aktiv", !s.aktiv)}>{s.aktiv ? "‚úì" : "‚úó"}</span></td>
            <td><Btn label="üíæ" color="var(--g)" onClick={() => save(s)} small /></td>
          </tr>)}
        </tbody>
      </table>
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: Team-Bonus ‚ïê‚ïê‚ïê
function TabTeam({ team, setTeam, toast, mitarbeiterList }) {
  const [adding, setAdding] = useState(false);
  const [newRow, setNewRow] = useState({ mitarbeiter_name: "", mitarbeiter_id: "", betrag_pro_sale: 200, bezugsgruppe: "alle_vt", team_mitglieder: [], gueltig_ab: "2026-01-01" });
  const maOptions = mitarbeiterList.map(m => ({ value: m.id, label: `${m.vorname} ${m.nachname}` }));

  const save = async (t) => {
    try {
      const tm = typeof t.team_mitglieder === "string" ? (t.team_mitglieder ? t.team_mitglieder.split(",").map(s => s.trim()) : null) : t.team_mitglieder;
      await db.patch("pay_team_bonus", `id=eq.${t.id}`, {
        mitarbeiter_name: t.mitarbeiter_name, betrag_pro_sale: t.betrag_pro_sale,
        bezugsgruppe: t.bezugsgruppe, team_mitglieder: tm,
        gueltig_ab: t.gueltig_ab, aktiv: t.aktiv
      });
      toast("Gespeichert", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const add = async () => {
    try {
      const tm = Array.isArray(newRow.team_mitglieder) ? (newRow.team_mitglieder.length ? newRow.team_mitglieder : null) : (newRow.team_mitglieder ? newRow.team_mitglieder.split(",").map(s => s.trim()) : null);
      const res = await db.post("pay_team_bonus", { ...newRow, team_mitglieder: tm, aktiv: true });
      setTeam(prev => [...prev, res[0]]);
      setAdding(false); toast("Hinzugef√ºgt", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const upd = (id, k, v) => setTeam(prev => prev.map(t => t.id === id ? { ...t, [k]: v } : t));

  const grpOpts = [{ value: "alle_vt", label: "Alle VT" }, { value: "eigenes_team", label: "Eigenes Team" }, { value: "custom", label: "Custom" }];

  return <div>
    <div style={{ marginBottom: 12 }}><Btn label="+ Neuer Team-Bonus" onClick={() => setAdding(true)} icon="üë•" /></div>
    <div style={{ overflowX: "auto" }}>
      <table>
        <thead><tr><th>Mitarbeiter</th><th style={{ textAlign: "right" }}>‚Ç¨/Sale</th><th>Bezugsgruppe</th><th>Team-Mitglieder</th><th>G√ºltig ab</th><th>Aktiv</th><th style={{ width: 80 }}>Aktion</th></tr></thead>
        <tbody>
          {adding && <tr style={{ background: "var(--y)08" }}>
            <td><SearchSelect value={newRow.mitarbeiter_name} onChange={name => { const ma = mitarbeiterList.find(m => `${m.vorname} ${m.nachname}` === name); setNewRow(p => ({ ...p, mitarbeiter_name: name, mitarbeiter_id: ma?.id || "" })); }} options={maOptions.map(o => ({ ...o, value: o.label }))} placeholder="Mitarbeiter w√§hlen..." /></td>
            <td><EditCell value={newRow.betrag_pro_sale} onChange={v => setNewRow(p => ({ ...p, betrag_pro_sale: v }))} type="number" width="80px" /></td>
            <td><EditCell value={newRow.bezugsgruppe} onChange={v => setNewRow(p => ({ ...p, bezugsgruppe: v }))} type="select" options={grpOpts} /></td>
            <td><MultiSearchSelect value={newRow.team_mitglieder} onChange={v => setNewRow(p => ({ ...p, team_mitglieder: v }))} options={maOptions.map(o => ({ ...o, value: o.label }))} /></td>
            <td><EditCell value={newRow.gueltig_ab} onChange={v => setNewRow(p => ({ ...p, gueltig_ab: v }))} /></td>
            <td><span className="badge b-g">Ja</span></td>
            <td><Btn label="‚úì" color="var(--g)" onClick={add} small /></td>
          </tr>}
          {team.map(t => <tr key={t.id}>
            <td style={{ fontWeight: 600 }}>{t.mitarbeiter_name}</td>
            <td className="eur" style={{ color: "var(--y)" }}><EditCell value={t.betrag_pro_sale} onChange={v => upd(t.id, "betrag_pro_sale", v)} type="number" width="80px" align="right" /></td>
            <td><EditCell value={t.bezugsgruppe} onChange={v => upd(t.id, "bezugsgruppe", v)} type="select" options={grpOpts} width="140px" /></td>
            <td style={{ fontSize: 11, color: "var(--ts)" }}>
              {Array.isArray(t.team_mitglieder) ? t.team_mitglieder.join(", ") : (t.team_mitglieder || "‚Äì")}
            </td>
            <td>{t.gueltig_ab?.slice(0, 10)}</td>
            <td><span className={`badge ${t.aktiv ? "b-g" : "b-r"}`} style={{ cursor: "pointer" }} onClick={() => upd(t.id, "aktiv", !t.aktiv)}>{t.aktiv ? "‚úì" : "‚úó"}</span></td>
            <td><Btn label="üíæ" color="var(--g)" onClick={() => save(t)} small /></td>
          </tr>)}
        </tbody>
      </table>
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: Sperrlisten ‚ïê‚ïê‚ïê
function TabSperr({ sperr, setSperr, toast }) {
  const [adding, setAdding] = useState(false);
  const [filter, setFilter] = useState("alle");
  const [newRow, setNewRow] = useState({ auftrag_nr: "", kunde_name: "", vertriebler: "", typ: "grundbuch", status: "gesperrt", betrag: 0, notiz: "" });
  const [delId, setDelId] = useState(null);

  const save = async (s) => {
    try {
      await db.patch("pay_sperrlisten", `id=eq.${s.id}`, {
        auftrag_nr: s.auftrag_nr, kunde_name: s.kunde_name, vertriebler: s.vertriebler,
        typ: s.typ, status: s.status, betrag: s.betrag, notiz: s.notiz, geaendert_am: ts()
      });
      toast("Gespeichert", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const add = async () => {
    try {
      const res = await db.post("pay_sperrlisten", newRow);
      setSperr(prev => [...prev, res[0]]);
      setAdding(false); toast("Hinzugef√ºgt", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const remove = async (id) => {
    try { await db.del("pay_sperrlisten", `id=eq.${id}`); setSperr(prev => prev.filter(s => s.id !== id)); setDelId(null); toast("Gel√∂scht", "ok"); }
    catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const upd = (id, k, v) => setSperr(prev => prev.map(s => s.id === id ? { ...s, [k]: v } : s));

  const typOpts = [{ value: "grundbuch", label: "üîí Grundbuch" }, { value: "montage_abbruch", label: "‚ùå MA-Abbruch" }, { value: "crm_storno", label: "‚ö†Ô∏è CRM-Storno" }, { value: "sonstige", label: "üìå Sonstige" }];
  const statusOpts = [{ value: "gesperrt", label: "üîí Gesperrt" }, { value: "ausgezahlt", label: "üí∞ Ausgezahlt" }, { value: "rueckforderung", label: "‚Ü©Ô∏è R√ºckford." }, { value: "geklaert", label: "‚úÖ Gekl√§rt" }];
  const typLabel = { grundbuch: "üîí Grundbuch", montage_abbruch: "‚ùå MA-Abbruch", crm_storno: "‚ö†Ô∏è CRM-Storno", sonstige: "üìå Sonstige" };
  const statusLabel = { gesperrt: "b-r", ausgezahlt: "b-o", rueckforderung: "b-p", geklaert: "b-g" };

  const filtered = filter === "alle" ? sperr : sperr.filter(s => s.typ === filter);
  const counts = { alle: sperr.length, grundbuch: sperr.filter(s => s.typ === "grundbuch").length, montage_abbruch: sperr.filter(s => s.typ === "montage_abbruch").length, crm_storno: sperr.filter(s => s.typ === "crm_storno").length };

  return <div>
    {delId && <ConfirmModal msg="Sperrlisten-Eintrag wirklich l√∂schen?" onOk={() => remove(delId)} onCancel={() => setDelId(null)} />}
    <div style={{ display: "flex", gap: 8, marginBottom: 12, flexWrap: "wrap", alignItems: "center" }}>
      {[["alle", "Alle", "var(--ts)"], ["grundbuch", "üîí Grundbuch", "var(--r)"], ["montage_abbruch", "‚ùå MA-Abbruch", "var(--o)"], ["crm_storno", "‚ö†Ô∏è CRM-Storno", "var(--p)"]].map(([k, l, c]) =>
        <button key={k} onClick={() => setFilter(k)} style={{ background: filter === k ? `${c}22` : "var(--s3)", color: filter === k ? c : "var(--ts)", border: `1px solid ${filter === k ? `${c}44` : "var(--bd)"}`, borderRadius: 6, padding: "5px 12px", fontSize: 12, fontWeight: 600 }}>
          {l} <span style={{ background: `${c}22`, padding: "1px 6px", borderRadius: 4, fontSize: 10, marginLeft: 4 }}>{counts[k]}</span>
        </button>
      )}
      <div style={{ flex: 1 }} />
      <Btn label="+ Neue Sperre" onClick={() => setAdding(true)} color="var(--r)" icon="üîí" />
    </div>
    <div style={{ overflowX: "auto" }}>
      <table>
        <thead><tr><th>AN Nr.</th><th>Kunde</th><th>Vertriebler</th><th>Typ</th><th>Status</th><th style={{ textAlign: "right" }}>Betrag</th><th>Notiz</th><th style={{ width: 100 }}>Aktionen</th></tr></thead>
        <tbody>
          {adding && <tr style={{ background: "var(--r)08" }}>
            <td><EditCell value={newRow.auftrag_nr} onChange={v => setNewRow(p => ({ ...p, auftrag_nr: v }))} width="70px" /></td>
            <td><EditCell value={newRow.kunde_name} onChange={v => setNewRow(p => ({ ...p, kunde_name: v }))} /></td>
            <td><EditCell value={newRow.vertriebler} onChange={v => setNewRow(p => ({ ...p, vertriebler: v }))} /></td>
            <td><EditCell value={newRow.typ} onChange={v => setNewRow(p => ({ ...p, typ: v }))} type="select" options={typOpts} /></td>
            <td><EditCell value={newRow.status} onChange={v => setNewRow(p => ({ ...p, status: v }))} type="select" options={statusOpts} /></td>
            <td><EditCell value={newRow.betrag} onChange={v => setNewRow(p => ({ ...p, betrag: v }))} type="number" width="80px" /></td>
            <td><EditCell value={newRow.notiz} onChange={v => setNewRow(p => ({ ...p, notiz: v }))} /></td>
            <td><Btn label="‚úì" color="var(--g)" onClick={add} small /> <Btn label="‚úó" color="var(--r)" onClick={() => setAdding(false)} small /></td>
          </tr>}
          {filtered.map(s => <tr key={s.id}>
            <td style={{ fontWeight: 700, fontVariantNumeric: "tabular-nums" }}>{s.auftrag_nr}</td>
            <td>{s.kunde_name}</td>
            <td>{s.vertriebler || "‚Äì"}</td>
            <td><EditCell value={s.typ} onChange={v => upd(s.id, "typ", v)} type="select" options={typOpts} width="140px" /></td>
            <td><EditCell value={s.status} onChange={v => upd(s.id, "status", v)} type="select" options={statusOpts} width="130px" /></td>
            <td className="eur">{s.betrag > 0 ? eur(s.betrag) : "‚Äì"}</td>
            <td style={{ fontSize: 11, color: "var(--ts)", maxWidth: 200 }}><EditCell value={s.notiz || ""} onChange={v => upd(s.id, "notiz", v)} /></td>
            <td style={{ display: "flex", gap: 4 }}>
              <Btn label="üíæ" color="var(--g)" onClick={() => save(s)} small />
              <Btn label="üóëÔ∏è" color="var(--r)" onClick={() => setDelId(s.id)} small />
            </td>
          </tr>)}
        </tbody>
      </table>
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: Duplikate ‚ïê‚ïê‚ïê
function TabDuplikate({ duplikate, setDuplikate, toast }) {
  const [delId, setDelId] = useState(null);
  const save = async (d) => {
    try {
      await db.patch("pay_duplikate", `id=eq.${d.id}`, { status: d.status, aktion: d.aktion, notiz: d.notiz, geaendert_am: ts() });
      toast("Gespeichert", "ok");
    } catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const remove = async (id) => {
    try { await db.del("pay_duplikate", `id=eq.${id}`); setDuplikate(prev => prev.filter(d => d.id !== id)); setDelId(null); toast("Gel√∂scht", "ok"); }
    catch (e) { toast("Fehler: " + e.message, "err"); }
  };
  const upd = (id, k, v) => setDuplikate(prev => prev.map(d => d.id === id ? { ...d, [k]: v } : d));
  const statusOpts = [{ value: "offen", label: "‚ö†Ô∏è Offen" }, { value: "geklaert", label: "‚úÖ Gekl√§rt" }, { value: "storniert", label: "‚ùå Storniert" }, { value: "entscheidung_noetig", label: "üî∂ Entscheidung" }];
  const statusColors = { offen: "b-o", geklaert: "b-g", storniert: "b-r", entscheidung_noetig: "b-y" };

  return <div>
    {delId && <ConfirmModal msg="Duplikat-Eintrag wirklich l√∂schen?" onOk={() => remove(delId)} onCancel={() => setDelId(null)} />}
    <div style={{ marginBottom: 8 }}>
      <span style={{ fontSize: 12, color: "var(--ts)" }}>
        {duplikate.filter(d => d.status === "entscheidung_noetig" || d.status === "offen").length} offen von {duplikate.length} Duplikaten
      </span>
    </div>
    <div style={{ overflowX: "auto" }}>
      <table>
        <thead><tr><th>Kunde</th><th>PLZ</th><th style={{ textAlign: "right" }}>kWp</th><th>AN 1</th><th>AN 2</th><th>VT</th><th>Status</th><th>Aktion/Notiz</th><th style={{ width: 100 }}>Aktionen</th></tr></thead>
        <tbody>
          {duplikate.map(d => <tr key={d.id}>
            <td style={{ fontWeight: 600 }}>{d.kunde_name}</td>
            <td>{d.plz}</td>
            <td className="eur">{d.kwp}</td>
            <td style={{ fontVariantNumeric: "tabular-nums", fontWeight: 600 }}>{d.auftrag_nr_1}</td>
            <td style={{ fontVariantNumeric: "tabular-nums", fontWeight: 600 }}>{d.auftrag_nr_2}</td>
            <td>{d.vertriebler || "‚Äì"}</td>
            <td><EditCell value={d.status} onChange={v => upd(d.id, "status", v)} type="select" options={statusOpts} width="140px" /></td>
            <td><EditCell value={d.notiz || d.aktion || ""} onChange={v => upd(d.id, "notiz", v)} /></td>
            <td style={{ display: "flex", gap: 4 }}>
              <Btn label="üíæ" color="var(--g)" onClick={() => save(d)} small />
              <Btn label="üóëÔ∏è" color="var(--r)" onClick={() => setDelId(d.id)} small />
            </td>
          </tr>)}
          {!duplikate.length && <tr><td colSpan={9} style={{ textAlign: "center", color: "var(--ts)", padding: 24 }}>Keine Duplikate vorhanden</td></tr>}
        </tbody>
      </table>
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: Provisions-Historie (Stichtagsprinzip) ‚ïê‚ïê‚ïê
function TabHistorie({ historie, setHistorie, toast }) {
  const [adding, setAdding] = useState(false);
  const [delId, setDelId] = useState(null);
  const [filter, setFilter] = useState("alle");
  const [testDate, setTestDate] = useState("");
  const [testVT, setTestVT] = useState("");
  const [newRow, setNewRow] = useState({ mitarbeiter_name:"", gueltig_ab:"2026-01-01", gueltig_bis:"", basis_betrag:1400, staffel_betrag:1700, staffel_schwelle:8, eigenlead_betrag:800, empfehlung_betrag:500, speicher_betrag:0, stufenbonus_berechtigt:true, ist_flat_rate:false, notiz:"" });

  const save = async (h) => {
    try {
      await db.patch("pay_provisions_historie", `id=eq.${h.id}`, {
        mitarbeiter_name:h.mitarbeiter_name, gueltig_ab:h.gueltig_ab, gueltig_bis:h.gueltig_bis||null,
        basis_betrag:h.basis_betrag, staffel_betrag:h.staffel_betrag, staffel_schwelle:h.staffel_schwelle,
        eigenlead_betrag:h.eigenlead_betrag, empfehlung_betrag:h.empfehlung_betrag, speicher_betrag:h.speicher_betrag,
        stufenbonus_berechtigt:h.stufenbonus_berechtigt, ist_flat_rate:h.ist_flat_rate, notiz:h.notiz
      });
      toast("Gespeichert", "ok");
    } catch(e) { toast("Fehler: " + e.message, "err"); }
  };
  const add = async () => {
    try {
      const payload = { ...newRow, gueltig_bis: newRow.gueltig_bis||null, stufenbonus_berechtigt:!!newRow.stufenbonus_berechtigt, ist_flat_rate:!!newRow.ist_flat_rate };
      const res = await db.post("pay_provisions_historie", payload);
      setHistorie(prev => [...prev, res[0]]);
      setAdding(false); toast("Hinzugef√ºgt", "ok");
    } catch(e) { toast("Fehler: " + e.message, "err"); }
  };
  const remove = async (id) => {
    try { await db.del("pay_provisions_historie", `id=eq.${id}`); setHistorie(prev => prev.filter(h => h.id !== id)); setDelId(null); toast("Gel√∂scht", "ok"); }
    catch(e) { toast("Fehler: " + e.message, "err"); }
  };
  const upd = (id, k, v) => setHistorie(prev => prev.map(h => h.id === id ? { ...h, [k]: v } : h));

  // Group by VT name
  const grouped = {};
  historie.forEach(h => { if(!grouped[h.mitarbeiter_name]) grouped[h.mitarbeiter_name]=[]; grouped[h.mitarbeiter_name].push(h); });
  Object.values(grouped).forEach(arr => arr.sort((a,b) => a.gueltig_ab?.localeCompare(b.gueltig_ab)));

  // VTs with multiple periods (= √Ñnderungen)
  const multiPeriod = Object.entries(grouped).filter(([,arr]) => arr.length > 1);
  const singlePeriod = Object.entries(grouped).filter(([,arr]) => arr.length === 1);

  // Stichtags-Rechner
  const findRate = (vtName, date) => {
    const entries = grouped[vtName];
    if (!entries) return null;
    const sorted = [...entries].sort((a,b) => b.gueltig_ab.localeCompare(a.gueltig_ab));
    for (const e of sorted) {
      const ab = e.gueltig_ab?.slice(0,10);
      const bis = e.gueltig_bis?.slice(0,10);
      if (date >= ab && (!bis || date <= bis)) return e;
    }
    return sorted[sorted.length - 1]; // Fallback: √§ltester Eintrag
  };
  const testResult = testDate && testVT ? findRate(testVT, testDate) : null;

  const filtered = filter === "alle" ? Object.entries(grouped) : filter === "geaendert" ? multiPeriod : singlePeriod;
  const vtNames = Object.keys(grouped).sort();

  return <div>
    {delId && <ConfirmModal msg="Historie-Eintrag wirklich l√∂schen?" onOk={() => remove(delId)} onCancel={() => setDelId(null)} />}

    {/* Stichtags-Rechner */}
    <div style={{ background:"var(--s2)", border:"1px solid var(--y)33", borderRadius:10, padding:16, marginBottom:16 }}>
      <div style={{ fontWeight:700, fontSize:14, color:"var(--y)", marginBottom:10 }}>üìÖ Stichtags-Rechner ‚Äì Welcher Satz gilt?</div>
      <div style={{ display:"flex", gap:12, flexWrap:"wrap", alignItems:"flex-end" }}>
        <div>
          <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Vertriebler</div>
          <select value={testVT} onChange={e=>setTestVT(e.target.value)} style={{ width:220 }}>
            <option value="">‚Äì w√§hlen ‚Äì</option>
            {vtNames.map(n => <option key={n} value={n}>{n}</option>)}
          </select>
        </div>
        <div>
          <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>DatumErstellt (Auftrag)</div>
          <input type="date" value={testDate} onChange={e=>setTestDate(e.target.value)} style={{ width:160 }} />
        </div>
        {testResult && <div style={{ background:testResult.ist_flat_rate?"#F5C50018":"var(--s3)", border:`1px solid ${testResult.ist_flat_rate?"var(--y)":"var(--bd)"}`, borderRadius:8, padding:"8px 14px" }}>
          <div style={{ fontSize:11, color:"var(--ts)" }}>G√ºltiger Satz:</div>
          <div style={{ fontWeight:700, fontSize:16, color:testResult.ist_flat_rate?"var(--y)":"var(--g)" }}>
            {eur(testResult.basis_betrag)} {testResult.ist_flat_rate ? "flat" : `/ ${eur(testResult.staffel_betrag)} ab ${testResult.staffel_schwelle}`}
          </div>
          <div style={{ fontSize:10, color:"var(--ts)", marginTop:2 }}>{testResult.notiz}</div>
        </div>}
      </div>
    </div>

    {/* Filter + Add */}
    <div style={{ display:"flex", gap:8, marginBottom:12, flexWrap:"wrap", alignItems:"center" }}>
      {[["alle","Alle","var(--ts)"],["geaendert",`‚ö° Mit √Ñnderungen (${multiPeriod.length})`,"var(--y)"],["standard","Standard","var(--b)"]].map(([k,l,c]) =>
        <button key={k} onClick={()=>setFilter(k)} style={{ background:filter===k?`${c}22`:"var(--s3)", color:filter===k?c:"var(--ts)", border:`1px solid ${filter===k?`${c}44`:"var(--bd)"}`, borderRadius:6, padding:"5px 12px", fontSize:12, fontWeight:600 }}>{l}</button>
      )}
      <div style={{ flex:1 }} />
      <Btn label="+ Neue Periode / Erh√∂hung" onClick={()=>setAdding(true)} icon="üìà" />
    </div>

    {/* Add form */}
    {adding && <div style={{ background:"var(--y)08", border:"1px solid var(--y)33", borderRadius:10, padding:16, marginBottom:16 }} className="fade-in">
      <div style={{ fontWeight:700, fontSize:13, color:"var(--y)", marginBottom:10 }}>Neue Provisions-Periode anlegen</div>
      <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(170px,1fr))", gap:8 }}>
        {[["Mitarbeiter","mitarbeiter_name","text"],["G√ºltig ab","gueltig_ab","date"],["G√ºltig bis (leer=offen)","gueltig_bis","date"],
          ["Basis ‚Ç¨/Sale","basis_betrag","number"],["Staffel ‚Ç¨/Sale","staffel_betrag","number"],["Staffel ab (999=keine)","staffel_schwelle","number"],
          ["Eigenlead ‚Ç¨","eigenlead_betrag","number"],["Empfehlung ‚Ç¨","empfehlung_betrag","number"],["Speicher ‚Ç¨","speicher_betrag","number"],
          ["Notiz","notiz","text"]
        ].map(([lbl,key,type]) => <div key={key}>
          <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>{lbl}</div>
          <EditCell value={newRow[key]} onChange={v => setNewRow(p=>({...p,[key]:v}))} type={type} />
        </div>)}
        <div>
          <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Flat Rate?</div>
          <EditCell value={newRow.ist_flat_rate?"ja":"nein"} onChange={v=>setNewRow(p=>({...p,ist_flat_rate:v==="ja"}))} type="select" options={[{value:"ja",label:"Ja ‚Äì Flat"},{value:"nein",label:"Nein ‚Äì Staffel"}]} />
        </div>
      </div>
      <div style={{ display:"flex", gap:8, marginTop:12 }}>
        <Btn label="Anlegen" color="var(--g)" onClick={add} icon="‚úì" />
        <Btn label="Abbrechen" color="var(--ts)" onClick={()=>setAdding(false)} />
      </div>
    </div>}

    {/* Timeline per VT */}
    <div style={{ display:"grid", gap:12 }}>
      {filtered.sort((a,b) => a[0].localeCompare(b[0])).map(([name, entries]) => {
        const hasChange = entries.length > 1;
        return <div key={name} style={{ background:"var(--s2)", border:`1px solid ${hasChange?"var(--y)33":"var(--bd)"}`, borderRadius:10, padding:14, borderLeft:hasChange?"3px solid var(--y)":"3px solid var(--bd)" }} className="fade-in">
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
            <div style={{ display:"flex", alignItems:"center", gap:8 }}>
              <span style={{ fontWeight:700, fontSize:14 }}>{name}</span>
              {hasChange && <span className="badge b-y">‚ö° {entries.length} Perioden</span>}
              {entries.some(e=>e.ist_flat_rate) && <span className="badge b-o">Flat Rate</span>}
            </div>
          </div>

          {/* Timeline entries */}
          <div style={{ display:"grid", gap:6 }}>
            {entries.map((h, i) => <div key={h.id} style={{ display:"grid", gridTemplateColumns:"1fr 1fr auto", gap:8, alignItems:"center", background:i===entries.length-1?"var(--s3)":"var(--s1)", borderRadius:6, padding:"8px 12px", border:`1px solid ${i===entries.length-1?"var(--y)22":"var(--bd)"}` }}>
              <div>
                <div style={{ display:"flex", gap:6, alignItems:"center", marginBottom:4 }}>
                  <span style={{ fontSize:11, color:"var(--ts)", fontWeight:600 }}>
                    {h.gueltig_ab?.slice(0,10)} ‚Üí {h.gueltig_bis?.slice(0,10) || "offen"}
                  </span>
                  {i === entries.length-1 && <span className="badge b-g" style={{ fontSize:9 }}>AKTUELL</span>}
                </div>
                <div style={{ fontSize:12, color:"var(--ts)" }}>{h.notiz || "‚Äì"}</div>
              </div>
              <div style={{ display:"flex", gap:12, flexWrap:"wrap" }}>
                <div style={{ textAlign:"center" }}>
                  <div style={{ fontSize:9, color:"var(--ts)", textTransform:"uppercase" }}>Basis</div>
                  <div style={{ fontWeight:700, color:h.ist_flat_rate?"var(--y)":"var(--tx)" }}>{eur(h.basis_betrag)}</div>
                </div>
                {!h.ist_flat_rate && <div style={{ textAlign:"center" }}>
                  <div style={{ fontSize:9, color:"var(--ts)", textTransform:"uppercase" }}>Staffel</div>
                  <div style={{ fontWeight:600 }}>{eur(h.staffel_betrag)} ab {h.staffel_schwelle}</div>
                </div>}
                {+h.eigenlead_betrag > 0 && <div style={{ textAlign:"center" }}>
                  <div style={{ fontSize:9, color:"var(--ts)", textTransform:"uppercase" }}>Eigenlead</div>
                  <div style={{ fontWeight:600, color:"var(--t)" }}>{eur(h.eigenlead_betrag)}</div>
                </div>}
              </div>
              <div style={{ display:"flex", gap:4 }}>
                <Btn label="üíæ" color="var(--g)" onClick={()=>save(h)} small />
                <Btn label="üóëÔ∏è" color="var(--r)" onClick={()=>setDelId(h.id)} small />
              </div>
            </div>)}
          </div>
        </div>;
      })}
    </div>

    {/* Info-Box */}
    <div style={{ marginTop:16, background:"var(--s2)", border:"1px solid var(--bd)", borderRadius:8, padding:12 }}>
      <div style={{ fontSize:12, fontWeight:600, color:"var(--y)", marginBottom:4 }}>‚ÑπÔ∏è Stichtagsprinzip</div>
      <div style={{ fontSize:11, color:"var(--ts)", lineHeight:1.6 }}>
        Der Provisionssatz wird durch das <b style={{ color:"var(--tx)" }}>DatumErstellt</b> des Auftrags bestimmt, nicht durch den Auszahlungszeitpunkt. Wenn ein Auftrag z.B. am 15.12.2025 erstellt wurde, aber erst im Feb 2026 auszahlungsrelevant wird, gilt der Satz der am 15.12.2025 aktiv war. Bei Provisionserh√∂hungen: neue Periode anlegen mit gueltig_ab = √Ñnderungsdatum und beim alten Eintrag gueltig_bis = Tag davor setzen.
      </div>
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: √úbersicht (Dashboard) ‚ïê‚ïê‚ïê
function TabOverview({ regeln, sonder, setSonder, stufen, teamBonus, sperr, duplikate, historie, mitarbeiterList, toast }) {
  const skipIds = new Set(sonder.filter(s => s.typ === 'skip_abrechnung' && s.aktiv).map(s => s.mitarbeiter_id));
  const toggleSkip = async (ma) => {
    const name = `${ma.vorname} ${ma.nachname}`;
    const existing = sonder.find(s => s.typ === 'skip_abrechnung' && s.mitarbeiter_id === ma.id);
    if (existing) {
      await db.patch("pay_sonderprovisionen", `id=eq.${existing.id}`, { aktiv: !existing.aktiv });
      setSonder(prev => prev.map(s => s.id === existing.id ? { ...s, aktiv: !s.aktiv } : s));
      toast(existing.aktiv ? `‚úÖ ${name} wird wieder abgerechnet` : `‚è∏Ô∏è ${name} wird √ºbersprungen`);
    } else {
      const res = await db.post("pay_sonderprovisionen", { mitarbeiter_name: name, mitarbeiter_id: ma.id, typ: "skip_abrechnung", betrag: 0, beschreibung: "Keine Abrechnung erstellen", aktiv: true, gueltig_ab: new Date().toISOString().substring(0, 10) });
      setSonder(prev => [...prev, ...(Array.isArray(res) ? res : [res])]);
      toast(`‚è∏Ô∏è ${name} wird √ºbersprungen`);
    }
  };
  const stats = [
    { label: "Provisions-Regeln", val: regeln.length, icon: "üìã", color: "var(--b)", sub: `${regeln.filter(r => r.staffel_schwelle < 999).length} mit Staffel` },
    { label: "Sonderprovisionen", val: sonder.filter(s=>s.typ!=='skip_abrechnung').length, icon: "‚≠ê", color: "var(--y)", sub: `${sonder.filter(s => s.aktiv&&s.typ!=='skip_abrechnung').length} aktiv` },
    { label: "Stufenbonus", val: stufen.length, icon: "üèÜ", color: "var(--g)", sub: stufen.map(s => `‚â•${s.min_anlagen}: ${eur(s.bonus_betrag)}`).join(", ") || "‚Äì" },
    { label: "Team-Bonus", val: teamBonus.length, icon: "üë•", color: "var(--t)", sub: teamBonus.map(t => `${t.mitarbeiter_name}: ${eur(t.betrag_pro_sale)}/Sale`).join(", ") || "‚Äì" },
    { label: "Sperrlisten", val: sperr.length, icon: "üîí", color: "var(--r)", sub: `${sperr.filter(s => s.status === "gesperrt").length} gesperrt, ${sperr.filter(s => s.status === "ausgezahlt").length} ausgezahlt` },
    { label: "Duplikate", val: duplikate.length, icon: "‚ö†Ô∏è", color: "var(--o)", sub: `${duplikate.filter(d => d.status === "entscheidung_noetig" || d.status === "offen").length} offen` },
    { label: "Provisions-Historie", val: historie.length, icon: "üìú", color: "var(--p)", sub: (() => { const g={}; historie.forEach(h=>{if(!g[h.mitarbeiter_name])g[h.mitarbeiter_name]=0;g[h.mitarbeiter_name]++;}); const multi=Object.values(g).filter(c=>c>1).length; return `${Object.keys(g).length} VTs, ${multi} mit √Ñnderungen`; })() },
    { label: "√úbersprungen", val: skipIds.size, icon: "‚è∏Ô∏è", color: "var(--r)", sub: skipIds.size > 0 ? `${skipIds.size} VTs ohne Abrechnung` : "Alle werden abgerechnet" },
  ];

  return <div>
    <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill,minmax(280px,1fr))", gap: 14 }}>
    {stats.map(s => <div key={s.label} style={{ background: "var(--s2)", border: "1px solid var(--bd)", borderRadius: 10, padding: 18, borderLeft: `3px solid ${s.color}` }} className="fade-in">
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
        <span style={{ fontSize: 13, color: "var(--ts)", fontWeight: 600 }}>{s.label}</span>
        <span style={{ fontSize: 20 }}>{s.icon}</span>
      </div>
      <div style={{ fontSize: 28, fontWeight: 700, color: s.color }}>{s.val}</div>
      <div style={{ fontSize: 11, color: "var(--ts)", marginTop: 4 }}>{s.sub}</div>
    </div>)}
    </div>

    <div style={{ marginTop: 20, background: '#1a1f2e', border: '1px solid #F5C500', borderRadius: 10, padding: 18 }}>
      <div style={{ fontSize: 14, fontWeight: 700, color: '#F5C500', marginBottom: 10 }}>üìè Abrechnungsregeln</div>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill,minmax(300px,1fr))', gap: 12 }}>
        <div style={{ background: 'var(--bg)', borderRadius: 8, padding: 12, border: '1px solid var(--bd)' }}>
          <div style={{ fontSize: 11, fontWeight: 700, color: '#F5C500', marginBottom: 4 }}>üìä Staffel-Fortschritt</div>
          <div style={{ fontSize: 11, color: '#c9d1d9', lineHeight: 1.5 }}>Z√§hlt nur <b style={{ color: '#F5C500' }}>LZ-Auftr√§ge</b>. Nachz√ºgler (NZ) werden nicht mitgez√§hlt. Anzeige: "4 LZ / 8" statt "5 / 8".</div>
        </div>
        <div style={{ background: 'var(--bg)', borderRadius: 8, padding: 12, border: '1px solid var(--bd)' }}>
          <div style={{ fontSize: 11, fontWeight: 700, color: '#F5C500', marginBottom: 4 }}>üèÜ Stufenbonus</div>
          <div style={{ fontSize: 11, color: '#c9d1d9', lineHeight: 1.5 }}>Nur <b style={{ color: '#F5C500' }}>aktuelle LZ-Monate</b> werden gepr√ºft. Bereits bezahlte Vormonate z√§hlen nicht erneut.</div>
        </div>
        <div style={{ background: 'var(--bg)', borderRadius: 8, padding: 12, border: '1px solid var(--bd)' }}>
          <div style={{ fontSize: 11, fontWeight: 700, color: '#F5C500', marginBottom: 4 }}>üèÖ Team-Bonus</div>
          <div style={{ fontSize: 11, color: '#c9d1d9', lineHeight: 1.5 }}>Detail-Seite zeigt <b style={{ color: '#F5C500' }}>Kundennamen pro Team-Mitglied</b> mit Auftragsnr. und kWp.</div>
        </div>
        <div style={{ background: 'var(--bg)', borderRadius: 8, padding: 12, border: '1px solid var(--bd)' }}>
          <div style={{ fontSize: 11, fontWeight: 700, color: '#F5C500', marginBottom: 4 }}>üìÑ PDF Seite 1</div>
          <div style={{ fontSize: 11, color: '#c9d1d9', lineHeight: 1.5 }}>Alle Kategorien (Sales, Storno, Offen, On Hold) zeigen <b style={{ color: '#F5C500' }}>explizit Kundennamen</b>.</div>
        </div>
      </div>
    </div>

    {/* Scout-Eigenlead Paarungen */}
    {(()=>{const se=sonder.filter(s=>s.typ==='scout_eigenlead'&&s.aktiv);const su=sonder.filter(s=>s.typ==='scout_umleitung'&&s.aktiv);if(!se.length&&!su.length)return null;return <div style={{ marginTop: 20, background: '#1a1f2e', border: '1px solid #2563eb', borderRadius: 10, padding: 18 }}>
      <div style={{ fontSize: 14, fontWeight: 700, color: '#93c5fd', marginBottom: 10 }}>üéØ Scout ‚Üí VT Sonderregeln ({se.length + su.length})</div>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill,minmax(320px,1fr))', gap: 10 }}>
        {se.map(s=>{let cfg={};try{cfg=JSON.parse(s.beschreibung)}catch(e){}return <div key={s.id} style={{ background: 'var(--bg)', borderRadius: 8, padding: 12, border: '1px solid #2563eb40', display:'flex', alignItems:'center', gap:10 }}>
          <div style={{fontSize:24}}>üîç</div>
          <div style={{flex:1}}>
            <div style={{ fontSize: 11, color: '#93c5fd', fontWeight:600 }}>Scout ‚Üí Eigenlead</div>
            <div style={{ fontSize: 12, color: '#c9d1d9', marginTop:2 }}><b style={{color:'#F5C500'}}>{cfg.scout_name||'?'}</b> scouted ‚Üí <b style={{color:'#58a6ff'}}>{s.mitarbeiter_name}</b></div>
            <div style={{ fontSize: 11, color: '#8b949e', marginTop:2 }}>Scout: 200‚Ç¨ ¬∑ VT: <span style={{color:'#3fb950',fontWeight:700}}>+{s.betrag}‚Ç¨ Eigenlead</span></div>
          </div>
        </div>;})}
        {su.map(s=>{let cfg={};try{cfg=JSON.parse(s.beschreibung)}catch(e){}return <div key={s.id} style={{ background: 'var(--bg)', borderRadius: 8, padding: 12, border: '1px solid #da363340', display:'flex', alignItems:'center', gap:10 }}>
          <div style={{fontSize:24}}>üîÄ</div>
          <div style={{flex:1}}>
            <div style={{ fontSize: 11, color: '#f78166', fontWeight:600 }}>Scout-Umleitung</div>
            <div style={{ fontSize: 12, color: '#c9d1d9', marginTop:2 }}><b style={{color:'#F5C500'}}>{cfg.scout_name||'?'}</b> bei Fremd-VT ‚Üí <b style={{color:'#58a6ff'}}>{s.mitarbeiter_name}</b></div>
            <div style={{ fontSize: 11, color: '#8b949e', marginTop:2 }}>Scouter beh√§lt 200‚Ç¨ ¬∑ Empf√§nger: <span style={{color:'#3fb950',fontWeight:700}}>+{s.betrag}‚Ç¨ extra</span></div>
          </div>
        </div>;})}
      </div>
    </div>;})()}

    <div style={{ marginTop: 20, background: "var(--s2)", border: "1px solid var(--bd)", borderRadius: 10, padding: 18 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
        <div>
          <div style={{ fontSize: 14, fontWeight: 700, color: "var(--tx)" }}>‚è∏Ô∏è Abrechnung √ºberspringen</div>
          <div style={{ fontSize: 11, color: "var(--ts)", marginTop: 2 }}>Deaktivierte Partner werden bei der Generierung √ºbersprungen</div>
        </div>
        {skipIds.size > 0 && <span style={{ fontSize: 11, padding: "3px 10px", borderRadius: 6, background: "var(--r)", color: "#fff", fontWeight: 600 }}>{skipIds.size} √ºbersprungen</span>}
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill,minmax(220px,1fr))", gap: 8 }}>
        {mitarbeiterList.map(ma => {
          const isSkipped = skipIds.has(ma.id);
          const isHGB = (ma.typ||'').includes('hgb');
          const isScouter = (ma.typ||'').includes('scouter');
          return <div key={ma.id} onClick={() => toggleSkip(ma)} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 12px", borderRadius: 8, cursor: "pointer", background: isSkipped ? "#da363315" : "var(--bg)", border: `1px solid ${isSkipped ? "#da363340" : "var(--bd)"}`, transition: "all .15s" }}>
            <div style={{ width: 36, height: 20, borderRadius: 10, background: isSkipped ? "#da3633" : "#238636", position: "relative", transition: "background .2s", flexShrink: 0 }}>
              <div style={{ width: 16, height: 16, borderRadius: 8, background: "#fff", position: "absolute", top: 2, left: isSkipped ? 2 : 18, transition: "left .2s" }} />
            </div>
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ fontSize: 12, fontWeight: 600, color: isSkipped ? "#f85149" : "var(--tx)", whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{ma.vorname} {ma.nachname}</div>
              <div style={{ fontSize: 10, color: "var(--ts)" }}>{isScouter ? "Scout" : (isHGB ? "HGB ¬ß84" : "Angestellt")}</div>
            </div>
          </div>;
        })}
      </div>
    </div>
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: Staffel-History (Vormonat-Daten + Freigabe) ‚ïê‚ïê‚ïê
function TabStaffelHistory({ mitarbeiterList, toast }) {
  const now = new Date();
  const [selMonat, setSelMonat] = useState(now.getMonth() + 1);
  const [selJahr, setSelJahr] = useState(now.getFullYear());
  const [entries, setEntries] = useState([]);
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(null);

  // Load entries for selected month
  const loadEntries = async () => {
    setLoading(true);
    try {
      const data = await db.get("pay_staffel_history", `?monat=eq.${selMonat}&jahr=eq.${selJahr}&order=created_at.asc`);
      setEntries(data || []);
    } catch(e) { toast("Fehler: " + e.message, "err"); }
    setLoading(false);
  };
  useEffect(() => { loadEntries(); }, [selMonat, selJahr]);

  // Build MA lookup
  const maById = {};
  (mitarbeiterList||[]).forEach(ma => { maById[ma.id] = ma; });

  // Get VTs that don't have an entry yet
  const existingIds = new Set(entries.map(e => e.mitarbeiter_id));
  const vtList = (mitarbeiterList||[]).filter(ma => !ma.typ?.includes('scouter'));

  // Add new entry for a VT
  const addEntry = async (ma) => {
    const name = `${ma.vorname} ${ma.nachname}`;
    try {
      const payload = {
        mitarbeiter_id: ma.id,
        monat: selMonat,
        jahr: selJahr,
        bezahlte_auftraege: 0,
        staffel_erreicht: false,
        staffel_betrag: 0,
        stufenbonus_betrag: 0,
        korrektur_typ: null,
        korrektur_betrag: 0,
        korrektur_grund: null,
        freigegeben: false
      };
      const res = await db.post("pay_staffel_history", payload);
      setEntries(prev => [...prev, ...(Array.isArray(res) ? res : [res])]);
      toast(`‚úÖ ${name} hinzugef√ºgt`);
    } catch(e) { toast("Fehler: " + e.message, "err"); }
  };

  // Update field
  const updateField = async (entry, field, value) => {
    setSaving(entry.id + field);
    try {
      const patch = { [field]: value, updated_at: new Date().toISOString() };
      await db.patch("pay_staffel_history", `id=eq.${entry.id}`, patch);
      setEntries(prev => prev.map(e => e.id === entry.id ? { ...e, ...patch } : e));
    } catch(e) { toast("Fehler: " + e.message, "err"); }
    setSaving(null);
  };

  // Toggle freigabe
  const toggleFreigabe = async (entry) => {
    const newVal = !entry.freigegeben;
    setSaving(entry.id + "freigabe");
    try {
      const patch = {
        freigegeben: newVal,
        freigegeben_am: newVal ? new Date().toISOString() : null,
        freigegeben_von: newVal ? "Matrix-UI" : null,
        updated_at: new Date().toISOString()
      };
      await db.patch("pay_staffel_history", `id=eq.${entry.id}`, patch);
      setEntries(prev => prev.map(e => e.id === entry.id ? { ...e, ...patch } : e));
      toast(newVal ? "‚úÖ Freigegeben" : "‚è∏Ô∏è Freigabe zur√ºckgenommen");
    } catch(e) { toast("Fehler: " + e.message, "err"); }
    setSaving(null);
  };

  // Delete entry
  const removeEntry = async (entry) => {
    try {
      await db.del("pay_staffel_history", `id=eq.${entry.id}`);
      setEntries(prev => prev.filter(e => e.id !== entry.id));
      toast("üóëÔ∏è Gel√∂scht");
    } catch(e) { toast("Fehler: " + e.message, "err"); }
  };

  // Add all VTs at once
  const addAllVTs = async () => {
    const missing = vtList.filter(ma => !existingIds.has(ma.id));
    if(missing.length === 0) return toast("Alle VTs bereits vorhanden");
    for(const ma of missing) await addEntry(ma);
    toast(`‚úÖ ${missing.length} VTs hinzugef√ºgt`);
  };

  const monatLabel = (m, j) => {
    const months = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
    return `${months[m-1]} ${j}`;
  };

  const freigegebene = entries.filter(e => e.freigegeben && e.korrektur_betrag > 0);
  const offene = entries.filter(e => !e.freigegeben && e.korrektur_betrag > 0);

  return <div>
    {/* Monat-Auswahl */}
    <div style={{ display:"flex", gap:12, alignItems:"center", marginBottom:16, flexWrap:"wrap" }}>
      <div>
        <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Abrechnungsmonat</div>
        <div style={{ display:"flex", gap:6 }}>
          <select value={selMonat} onChange={e => setSelMonat(+e.target.value)} style={{ width:100 }}>
            {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => <option key={m} value={m}>{["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"][m-1]}</option>)}
          </select>
          <select value={selJahr} onChange={e => setSelJahr(+e.target.value)} style={{ width:80 }}>
            {[2025,2026,2027].map(j => <option key={j} value={j}>{j}</option>)}
          </select>
        </div>
      </div>
      <div style={{ display:"flex", gap:8, alignItems:"flex-end" }}>
        <Btn label="Alle VTs hinzuf√ºgen" icon="‚ûï" onClick={addAllVTs} />
        <Btn label="Aktualisieren" icon="üîÑ" onClick={loadEntries} />
      </div>
      {loading && <div style={{ fontSize:12, color:"var(--y)" }}>Laden‚Ä¶</div>}
      <div style={{ flex:1 }} />
      {freigegebene.length > 0 && <span style={{ fontSize:11, padding:"4px 12px", borderRadius:6, background:"#238636", color:"#fff", fontWeight:600 }}>‚úÖ {freigegebene.length} freigegeben</span>}
      {offene.length > 0 && <span style={{ fontSize:11, padding:"4px 12px", borderRadius:6, background:"#da3633", color:"#fff", fontWeight:600 }}>‚è≥ {offene.length} offen</span>}
    </div>

    {/* Info-Box */}
    <div style={{ background:"var(--s2)", border:"1px solid var(--y)33", borderRadius:10, padding:14, marginBottom:16 }}>
      <div style={{ fontSize:12, fontWeight:700, color:"var(--y)", marginBottom:6 }}>‚ÑπÔ∏è So funktioniert die Staffel-History</div>
      <div style={{ fontSize:11, color:"var(--ts)", lineHeight:1.7 }}>
        <b style={{ color:"var(--tx)" }}>1.</b> F√ºr jeden VT die Daten aus dem <b style={{ color:"var(--tx)" }}>Vormonat</b> eintragen: Wie viele Auftr√§ge wurden bezahlt? War die Staffel aktiv? Welcher Stufenbonus?<br/>
        <b style={{ color:"var(--tx)" }}>2.</b> Wenn durch NZ oder Storno eine Staffel-√Ñnderung eintritt ‚Üí <b style={{ color:"var(--tx)" }}>Korrektur-Betrag</b> eingeben<br/>
        <b style={{ color:"var(--tx)" }}>3.</b> Korrektur <b style={{ color:"#238636" }}>freigeben</b> ‚Äì nur freigegebene Korrekturen flie√üen in die Abrechnung<br/>
        <b style={{ color:"var(--tx)" }}>Wichtig:</b> Ohne Freigabe wird <b style={{ color:"var(--r)" }}>keine automatische Staffel-Korrektur</b> berechnet!
      </div>
    </div>

    {/* Entries grid */}
    {entries.length === 0 ? (
      <div style={{ textAlign:"center", padding:40, color:"var(--ts)" }}>
        <div style={{ fontSize:36, marginBottom:8 }}>üìä</div>
        <div style={{ fontSize:14, fontWeight:600 }}>Keine Eintr√§ge f√ºr {monatLabel(selMonat, selJahr)}</div>
        <div style={{ fontSize:12, marginTop:4 }}>Klicke "Alle VTs hinzuf√ºgen" um Vormonat-Daten einzupflegen</div>
      </div>
    ) : (
      <div style={{ display:"grid", gap:10 }}>
        {entries.map(entry => {
          const ma = maById[entry.mitarbeiter_id];
          const name = ma ? `${ma.vorname} ${ma.nachname}` : entry.mitarbeiter_id?.substring(0,8);
          const isHGB = ma?.typ?.includes('hgb');
          const hasKorrektur = entry.korrektur_betrag && +entry.korrektur_betrag !== 0;
          const isNZ = entry.korrektur_typ === 'nachzahlung';
          const isRF = entry.korrektur_typ === 'rueckforderung';

          return <div key={entry.id} style={{
            background: "var(--s2)",
            border: `1px solid ${entry.freigegeben ? "#23863666" : hasKorrektur ? "#da363366" : "var(--bd)"}`,
            borderRadius: 10,
            padding: 14,
            borderLeft: `3px solid ${entry.freigegeben ? "#238636" : hasKorrektur ? "#da3633" : "var(--bd)"}`
          }}>
            {/* Header */}
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:10 }}>
              <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                <span style={{ fontWeight:700, fontSize:14, color:"var(--tx)" }}>{name}</span>
                <span className="badge" style={{ background: isHGB ? "var(--y)22" : "var(--b)22", color: isHGB ? "var(--y)" : "var(--b)", fontSize:9 }}>{isHGB ? "HGB ¬ß84" : "Angestellt"}</span>
                {entry.freigegeben && <span className="badge b-g" style={{ fontSize:9 }}>‚úÖ FREIGEGEBEN</span>}
              </div>
              <Btn label="üóëÔ∏è" color="var(--r)" onClick={() => removeEntry(entry)} small />
            </div>

            {/* Vormonat-Daten */}
            <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(160px,1fr))", gap:10, marginBottom: hasKorrektur || true ? 12 : 0 }}>
              <div>
                <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Bezahlte Auftr√§ge (Vormonat)</div>
                <input type="number" value={entry.bezahlte_auftraege||0}
                  onChange={e => { const v=+e.target.value; setEntries(prev=>prev.map(x=>x.id===entry.id?{...x,bezahlte_auftraege:v}:x)); }}
                  onBlur={e => updateField(entry, "bezahlte_auftraege", +e.target.value)}
                  style={{ width:"100%", background:"var(--bg)", border:"1px solid var(--bd)", borderRadius:6, padding:"6px 10px", color:"var(--tx)", fontSize:16, fontWeight:700 }}
                />
              </div>
              <div>
                <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Staffel erreicht?</div>
                <div onClick={() => updateField(entry, "staffel_erreicht", !entry.staffel_erreicht)}
                  style={{ display:"flex", alignItems:"center", gap:8, padding:"6px 10px", background:"var(--bg)", border:"1px solid var(--bd)", borderRadius:6, cursor:"pointer" }}>
                  <div style={{ width:36, height:20, borderRadius:10, background: entry.staffel_erreicht ? "#238636" : "#484f58", position:"relative", transition:"background .2s" }}>
                    <div style={{ width:16, height:16, borderRadius:8, background:"#fff", position:"absolute", top:2, left: entry.staffel_erreicht ? 18 : 2, transition:"left .2s" }} />
                  </div>
                  <span style={{ fontSize:13, fontWeight:600, color: entry.staffel_erreicht ? "#238636" : "var(--ts)" }}>{entry.staffel_erreicht ? "Ja (‚â•8)" : "Nein"}</span>
                </div>
              </div>
              <div>
                <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Staffel-Betrag (‚Ç¨/Sale)</div>
                <input type="number" value={entry.staffel_betrag||0}
                  onChange={e => { const v=+e.target.value; setEntries(prev=>prev.map(x=>x.id===entry.id?{...x,staffel_betrag:v}:x)); }}
                  onBlur={e => updateField(entry, "staffel_betrag", +e.target.value)}
                  style={{ width:"100%", background:"var(--bg)", border:"1px solid var(--bd)", borderRadius:6, padding:"6px 10px", color:"var(--tx)", fontSize:14, fontWeight:600 }}
                />
              </div>
              <div>
                <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Stufenbonus (‚Ç¨)</div>
                <input type="number" value={entry.stufenbonus_betrag||0}
                  onChange={e => { const v=+e.target.value; setEntries(prev=>prev.map(x=>x.id===entry.id?{...x,stufenbonus_betrag:v}:x)); }}
                  onBlur={e => updateField(entry, "stufenbonus_betrag", +e.target.value)}
                  style={{ width:"100%", background:"var(--bg)", border:"1px solid var(--bd)", borderRadius:6, padding:"6px 10px", color:"var(--tx)", fontSize:14, fontWeight:600 }}
                />
              </div>
            </div>

            {/* Korrektur-Bereich */}
            <div style={{ background: hasKorrektur ? (isNZ ? "#23863612" : "#da363312") : "var(--bg)", border:`1px solid ${hasKorrektur ? (isNZ ? "#23863644" : "#da363344") : "var(--bd)"}`, borderRadius:8, padding:12 }}>
              <div style={{ fontSize:11, fontWeight:700, color: hasKorrektur ? (isNZ ? "#238636" : "#da3633") : "var(--ts)", marginBottom:8 }}>
                {hasKorrektur ? (isNZ ? "üìà Staffel-Nachzahlung" : "üìâ Staffel-R√ºckforderung") : "üìä Staffel-Korrektur (falls n√∂tig)"}
              </div>
              <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(160px,1fr))", gap:10, alignItems:"end" }}>
                <div>
                  <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Korrektur-Typ</div>
                  <select value={entry.korrektur_typ||""} onChange={e => updateField(entry, "korrektur_typ", e.target.value || null)}
                    style={{ width:"100%", background:"var(--bg)", border:"1px solid var(--bd)", borderRadius:6, padding:"6px 10px", color:"var(--tx)", fontSize:12 }}>
                    <option value="">‚Äì Keine ‚Äì</option>
                    <option value="nachzahlung">üìà Nachzahlung</option>
                    <option value="rueckforderung">üìâ R√ºckforderung</option>
                  </select>
                </div>
                <div>
                  <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Korrektur-Betrag (‚Ç¨)</div>
                  <input type="number" value={entry.korrektur_betrag||0} step="0.01"
                    onChange={e => { const v=+e.target.value; setEntries(prev=>prev.map(x=>x.id===entry.id?{...x,korrektur_betrag:v}:x)); }}
                    onBlur={e => updateField(entry, "korrektur_betrag", +e.target.value)}
                    style={{ width:"100%", background:"var(--bg)", border:"1px solid var(--bd)", borderRadius:6, padding:"6px 10px", color: hasKorrektur ? (isNZ ? "#238636" : "#da3633") : "var(--tx)", fontSize:16, fontWeight:700 }}
                  />
                </div>
                <div>
                  <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Grund / Details</div>
                  <input type="text" value={entry.korrektur_grund||""} placeholder="z.B. NZ‚Üí14 Sales, Staffel erreicht"
                    onChange={e => { const v=e.target.value; setEntries(prev=>prev.map(x=>x.id===entry.id?{...x,korrektur_grund:v}:x)); }}
                    onBlur={e => updateField(entry, "korrektur_grund", e.target.value||null)}
                    style={{ width:"100%", background:"var(--bg)", border:"1px solid var(--bd)", borderRadius:6, padding:"6px 10px", color:"var(--tx)", fontSize:12 }}
                  />
                </div>
                {/* Freigabe Toggle */}
                {hasKorrektur && <div>
                  <div style={{ fontSize:10, color:"var(--ts)", marginBottom:3, textTransform:"uppercase", fontWeight:600 }}>Freigabe</div>
                  <div onClick={() => toggleFreigabe(entry)}
                    style={{ display:"flex", alignItems:"center", gap:8, padding:"6px 10px", background: entry.freigegeben ? "#23863618" : "var(--bg)", border:`1px solid ${entry.freigegeben ? "#23863644" : "var(--bd)"}`, borderRadius:6, cursor:"pointer" }}>
                    <div style={{ width:36, height:20, borderRadius:10, background: entry.freigegeben ? "#238636" : "#484f58", position:"relative", transition:"background .2s" }}>
                      <div style={{ width:16, height:16, borderRadius:8, background:"#fff", position:"absolute", top:2, left: entry.freigegeben ? 18 : 2, transition:"left .2s" }} />
                    </div>
                    <span style={{ fontSize:12, fontWeight:700, color: entry.freigegeben ? "#238636" : "var(--ts)" }}>{entry.freigegeben ? "‚úÖ Freigegeben" : "‚è≥ Ausstehend"}</span>
                  </div>
                </div>}
              </div>
            </div>
          </div>;
        })}
      </div>
    )}

    {/* Nicht erfasste VTs */}
    {vtList.filter(ma => !existingIds.has(ma.id)).length > 0 && (
      <div style={{ marginTop:16, background:"var(--s2)", border:"1px solid var(--bd)", borderRadius:10, padding:14 }}>
        <div style={{ fontSize:12, fontWeight:700, color:"var(--ts)", marginBottom:8 }}>Noch nicht erfasste VTs ({vtList.filter(ma => !existingIds.has(ma.id)).length})</div>
        <div style={{ display:"flex", flexWrap:"wrap", gap:6 }}>
          {vtList.filter(ma => !existingIds.has(ma.id)).map(ma => (
            <button key={ma.id} onClick={() => addEntry(ma)}
              style={{ background:"var(--bg)", border:"1px solid var(--bd)", borderRadius:6, padding:"5px 12px", fontSize:11, color:"var(--tx)", cursor:"pointer", fontWeight:600 }}>
              + {ma.vorname} {ma.nachname}
            </button>
          ))}
        </div>
      </div>
    )}
  </div>;
}

// ‚ïê‚ïê‚ïê Tab: CSV-Import (Auftr√§ge) ‚ïê‚ïê‚ïê
function TabImport({ toast, mitarbeiterList }) {
  const [file, setFile] = useState(null);
  const [preview, setPreview] = useState(null);
  const [importing, setImporting] = useState(false);
  const [importLog, setImportLog] = useState([]);
  const [mode, setMode] = useState('replace');
  const fileRef = useRef(null);

  const addLog = (msg) => setImportLog(prev => [...prev, `${new Date().toLocaleTimeString('de-DE')} ${msg}`]);

  const maMap = React.useMemo(() => {
    const m = {};
    (mitarbeiterList||[]).forEach(ma => {
      const full = `${ma.vorname} ${ma.nachname}`.trim().toLowerCase();
      m[full] = ma.id;
      const parts = full.split(' ');
      if(parts.length > 2) m[`${parts[0]} ${parts[parts.length-1]}`] = ma.id;
    });
    return m;
  }, [mitarbeiterList]);

  const findVT = (name) => {
    if(!name) return null;
    name = name.replace(/\s*\(.*?\)\s*/g, '').trim();
    const key = name.toLowerCase();
    if(maMap[key]) return maMap[key];
    const parts = key.split(' ');
    if(parts.length >= 2) { const k2 = `${parts[0]} ${parts[parts.length-1]}`; if(maMap[k2]) return maMap[k2]; }
    return null;
  };

  const parseDt = (d) => {
    if(!d || d.trim() === '-' || d.trim() === '') return null;
    const m1 = d.trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    if(m1) return `${m1[3]}-${m1[2]}-${m1[1]}`;
    if(/^\d{4}-\d{2}-\d{2}$/.test(d.trim())) return d.trim();
    return null;
  };

  const parseMoney = (v) => {
    if(!v) return null;
    const n = parseFloat(v.trim().replace(/\./g,'').replace(',','.').replace(/\s/g,''));
    return isNaN(n) ? null : n;
  };

  const parseKwp = (v) => {
    if(!v) return null;
    const n = parseFloat(v.trim().replace(',','.'));
    return isNaN(n) ? null : n;
  };

  const handleFile = (f) => {
    if(!f) return;
    setFile(f); setPreview(null); setImportLog([]);
    Papa.parse(f, {
      header: true, encoding: 'UTF-8', skipEmptyLines: true,
      complete: (res) => {
        const rows = res.data.filter(r => r['AN Nr.'] && r['AN Nr.'].trim());
        const stats = { total: rows.length, ausgezahlt: 0, storno: 0, auszahlbar: 0, offen: 0, onHold: 0, unmapped: new Set() };
        const mapped = rows.map(r => {
          const status = (r['Auftragsstatus']||'').trim();
          const fort = (r['BeeDooFortschritt']||'').trim();
          const kb = (r['Kundenberater']||'').trim();
          const ql = (r['Quelle']||'').trim().toLowerCase();
          const vtId = findVT(kb);
          if(!vtId && kb) stats.unmapped.add(kb);
          const isStorno = status === 'Storniert' || fort === 'Storniert';
          let zahlungsstatus = 'offen';
          if((r['Auszahlungsrelevant']||'').trim().toLowerCase() === 'ja' || status === 'Auftragsbest√§tigung erstellt')
            zahlungsstatus = 'anzahlung_eingegangen';
          let leadQuelle = 'sonstige';
          if(ql.includes('eigenlead')) leadQuelle = 'eigenlead';
          else if(ql.includes('empfehlung')) leadQuelle = 'empfehlung';
          else if(ql.includes('omega')) leadQuelle = 'mvpp';
          else if(ql.includes('sadd')) leadQuelle = 'sadd';
          else if(ql.includes('mvpp')) leadQuelle = 'mvpp';
          const speicherRaw = (r['Speichererweiterung']||'').trim();
          const hasSpeicher = speicherRaw.length > 0;
          const speicherAnz = hasSpeicher ? (parseInt((speicherRaw.match(/^(\d+)\s*X/i)||[])[1]) || 1) : 0;
          // On Hold Detection: "On hold" im WorkflowHistory ohne nachfolgende "Baustelle gestartet"
          const wfHist = (r['WorkflowHistory']||'');
          const wfParts = wfHist.split('- ');
          let lastOnHoldIdx = -1, lastBaustelleIdx = -1;
          wfParts.forEach((p,i) => { if(/on\s*hold/i.test(p)) lastOnHoldIdx=i; if(/Baustelle gestartet/i.test(p)) lastBaustelleIdx=i; });
          const isOnHold = lastOnHoldIdx > -1 && lastBaustelleIdx <= lastOnHoldIdx;
          const notizParts = [];
          if(speicherAnz > 1) notizParts.push(`speicher_x${speicherAnz}`);
          if(isOnHold) notizParts.push('on_hold');
          const datum = parseDt(r['DatumAngenommen']);
          const ausgezahlt = parseDt(r['Ausgezahlt am']);
          let abMonat = null, abJahr = null;
          if(ausgezahlt) { const p = ausgezahlt.split('-'); abJahr = parseInt(p[0]); abMonat = parseInt(p[1]); stats.ausgezahlt++; }
          if(isStorno) stats.storno++;
          else if(zahlungsstatus === 'anzahlung_eingegangen' && !ausgezahlt) stats.auszahlbar++;
          else if(!isStorno && !ausgezahlt) stats.offen++;
          if(isOnHold && !isStorno) stats.onHold++;
          return {
            auftrag_nr: `AN-${(r['AN Nr.']||'').trim()}`, kunde_name: (r['Kunde']||'').trim() || null,
            kunde_adresse: (r['Kunde PLZ']||'').trim() || null, vertriebler_id: vtId, auftrags_datum: datum,
            kwp: parseKwp(r['Angebot KWP']), netto_auftragswert: parseMoney(r['AN-WertNetto']),
            zahlungsstatus, lead_quelle: leadQuelle, speichererweiterung: hasSpeicher,
            storniert: isStorno, produkt_typ: 'pv', beedoo_fortschritt: fort || null,
            termin_stattgefunden: status === 'Auftragsbest√§tigung erstellt',
            notiz: notizParts.length > 0 ? notizParts.join(' ') : null,
            abgerechnet_monat: abMonat, abgerechnet_jahr: abJahr,
          };
        });
        stats.unmapped = [...stats.unmapped];
        setPreview({ stats, mapped });
      }
    });
  };

  const doImport = async () => {
    if(!preview) return;
    setImporting(true); setImportLog([]);
    try {
      if(mode === 'replace') {
        addLog('üóëÔ∏è L√∂sche bestehende Daten...');
        await db.del('pay_provisionen','id=not.is.null').catch(()=>{});
        await db.del('pay_abrechnungen_positionen','id=not.is.null').catch(()=>{});
        await db.del('pay_abrechnungen','id=not.is.null').catch(()=>{});
        await db.del('pay_auftraege','id=not.is.null').catch(()=>{});
        addLog('‚úÖ Alte Daten gel√∂scht');
      }
      let inserted = 0;
      for(let i = 0; i < preview.mapped.length; i += 100) {
        const batch = preview.mapped.slice(i, i+100);
        await db.post('pay_auftraege', batch);
        inserted += batch.length;
        addLog(`üì¶ Batch ${Math.floor(i/100)+1}: ${batch.length} Auftr√§ge`);
      }
      addLog(`‚úÖ Import fertig: ${inserted} Auftr√§ge`);
      addLog(`   üìã ${preview.stats.auszahlbar} auszahlbar | üí∞ ${preview.stats.ausgezahlt} ausgezahlt | ‚ùå ${preview.stats.storno} storniert | ‚è≥ ${preview.stats.offen} offen | ‚è∏Ô∏è ${preview.stats.onHold} on hold`);
      toast('‚úÖ ' + inserted + ' Auftr√§ge importiert', 'ok');
    } catch(e) {
      addLog(`‚ùå Fehler: ${e.message}`);
      toast('Import-Fehler: ' + e.message, 'err');
    }
    setImporting(false);
  };

  return <div style={{ display: 'flex', flexDirection: 'column', gap: 20 }}>
    <div style={{ background: 'var(--s2)', border: '1px solid var(--bd)', borderRadius: 10, padding: 16 }}>
      <div style={{ fontWeight: 700, fontSize: 14, marginBottom: 6, color: 'var(--y)' }}>üì• Standard CSV-Import ‚Äì Auftr√§ge (Leveto)</div>
      <div style={{ fontSize: 12, color: 'var(--ts)', lineHeight: 1.8 }}>
        <span style={{ color: 'var(--g)' }}>‚úì</span> <b>DatumAngenommen</b> ‚Üí Auftragsdatum (ma√ügeblich f√ºr Leistungszeitraum)<br/>
        <span style={{ color: 'var(--g)' }}>‚úì</span> <b>Ausgezahlt am</b> ‚Üí bereits abgerechnet ‚Üí wird bei Generierung √ºbersprungen<br/>
        <span style={{ color: 'var(--g)' }}>‚úì</span> <b>BeeDooFortschritt</b> ‚Üí Fortschritt f√ºr Duplikat-Entscheidungen<br/>
        <span style={{ color: 'var(--g)' }}>‚úì</span> <b>Kundenberater</b> ‚Üí Vertriebler-Zuordnung via pay_mitarbeiter<br/>
        <span style={{ color: 'var(--g)' }}>‚úì</span> <b>Auftragsbest√§tigung erstellt</b> = auszahlbar | <b>Storniert</b> = storniert
      </div>
    </div>

    <div style={{ border: '2px dashed var(--bd)', borderRadius: 12, padding: 40, textAlign: 'center', cursor: 'pointer', transition: 'all .2s' }}
      onClick={() => fileRef.current?.click()}
      onDragOver={(e) => { e.preventDefault(); e.currentTarget.style.borderColor = 'var(--y)'; e.currentTarget.style.background = 'var(--s2)'; }}
      onDragLeave={(e) => { e.currentTarget.style.borderColor = 'var(--bd)'; e.currentTarget.style.background = 'transparent'; }}
      onDrop={(e) => { e.preventDefault(); e.currentTarget.style.borderColor = 'var(--bd)'; e.currentTarget.style.background = 'transparent'; handleFile(e.dataTransfer.files[0]); }}>
      <input ref={fileRef} type="file" accept=".csv" style={{ display: 'none' }} onChange={(e) => handleFile(e.target.files[0])} />
      <div style={{ fontSize: 36, marginBottom: 8 }}>{file ? '‚úÖ' : 'üìÑ'}</div>
      <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--tx)', marginBottom: 4 }}>
        {file ? file.name : 'CSV-Datei hierher ziehen oder klicken'}
      </div>
      <div style={{ fontSize: 11, color: 'var(--ts)' }}>Leveto-Export (Auftr√§ge)</div>
    </div>

    {preview && <div style={{ background: 'var(--s2)', border: '1px solid var(--bd)', borderRadius: 10, padding: 16 }}>
      <div style={{ fontWeight: 700, fontSize: 14, marginBottom: 12 }}>üìä Vorschau ‚Äì {preview.stats.total} Auftr√§ge</div>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill,minmax(130px,1fr))', gap: 10, marginBottom: 16 }}>
        {[
          { label: 'Gesamt', val: preview.stats.total, c: 'var(--b)' },
          { label: 'Auszahlbar', val: preview.stats.auszahlbar, c: 'var(--g)' },
          { label: 'Ausgezahlt', val: preview.stats.ausgezahlt, c: 'var(--y)' },
          { label: 'Storniert', val: preview.stats.storno, c: 'var(--r)' },
          { label: 'Offen', val: preview.stats.offen, c: 'var(--o)' },
          { label: 'On Hold', val: preview.stats.onHold, c: '#6366f1' },
        ].map(s => <div key={s.label} style={{ background: 'var(--s3)', borderRadius: 8, padding: '10px 14px', borderLeft: `3px solid ${s.c}` }}>
          <div style={{ fontSize: 10, color: 'var(--ts)' }}>{s.label}</div>
          <div style={{ fontSize: 20, fontWeight: 700, color: s.c }}>{s.val}</div>
        </div>)}
      </div>

      {preview.stats.unmapped.length > 0 && <div style={{ background: '#422006', border: '1px solid #92400e', borderRadius: 8, padding: 12, marginBottom: 16 }}>
        <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--o)', marginBottom: 4 }}>‚ö†Ô∏è {preview.stats.unmapped.length} Vertriebler nicht in pay_mitarbeiter:</div>
        <div style={{ fontSize: 11, color: 'var(--ts)' }}>{preview.stats.unmapped.join(', ')}</div>
      </div>}

      <div style={{ display: 'flex', gap: 10, marginBottom: 16, flexWrap: 'wrap' }}>
        {[['replace','üóëÔ∏è Alles ersetzen','var(--r)'],['append','‚ûï Hinzuf√ºgen','var(--g)']].map(([k,l,c])=>
          <button key={k} onClick={() => setMode(k)} style={{
            background: mode === k ? `${c}20` : 'var(--s3)', color: mode === k ? c : 'var(--ts)',
            border: `1px solid ${mode === k ? c : 'var(--bd)'}`, borderRadius: 8, padding: '8px 16px', fontSize: 12, fontWeight: 600, cursor: 'pointer'
          }}>{l}</button>
        )}
      </div>

      <button onClick={doImport} disabled={importing} style={{
        background: importing ? 'var(--s4)' : 'var(--y)', color: importing ? 'var(--ts)' : '#000',
        border: 'none', borderRadius: 8, padding: '12px 24px', fontSize: 14, fontWeight: 700, width: '100%', cursor: importing ? 'wait' : 'pointer'
      }}>{importing ? '‚è≥ Importiere...' : `üì• ${preview.stats.total} Auftr√§ge importieren (${mode === 'replace' ? 'Ersetzen' : 'Hinzuf√ºgen'})`}</button>
    </div>}

    {importLog.length > 0 && <div style={{ background: 'var(--s1)', border: '1px solid var(--bd)', borderRadius: 10, padding: 16, fontFamily: 'monospace', fontSize: 11, color: 'var(--ts)', maxHeight: 300, overflowY: 'auto' }}>
      {importLog.map((l,i) => <div key={i} style={{ padding: '2px 0', color: l.includes('‚úÖ') ? 'var(--g)' : l.includes('‚ùå') ? 'var(--r)' : l.includes('‚ö†Ô∏è') ? 'var(--o)' : 'var(--ts)' }}>{l}</div>)}
    </div>}
  </div>;
}

// ‚ïê‚ïê‚ïê Main App ‚ïê‚ïê‚ïê
function App() {
  const [tab, setTab] = useState("uebersicht");
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [toastMsg, setToastMsg] = useState(null);
  const [toastType, setToastType] = useState("ok");

  const [regeln, setRegeln] = useState([]);
  const [sonder, setSonder] = useState([]);
  const [stufen, setStufen] = useState([]);
  const [teamBonus, setTeamBonus] = useState([]);
  const [sperrData, setSperrData] = useState([]);
  const [duplikateData, setDuplikateData] = useState([]);
  const [historieData, setHistorieData] = useState([]);
  const [mitarbeiterList, setMitarbeiterList] = useState([]);

  const toast = (msg, type = "ok") => { setToastMsg(msg); setToastType(type); setTimeout(() => setToastMsg(null), 3000); };

  useEffect(() => {
    (async () => {
      try {
        const [r, s, st, tb, sp, dp, hi, ma] = await Promise.all([
          db.get("provisions_regeln", "?aktiv=eq.true&order=modell_name.asc"),
          db.get("pay_sonderprovisionen", "?order=mitarbeiter_name.asc").catch(() => []),
          db.get("pay_stufenbonus", "?order=min_anlagen.asc").catch(() => []),
          db.get("pay_team_bonus", "?order=mitarbeiter_name.asc").catch(() => []),
          db.get("pay_sperrlisten", "?order=auftrag_nr.asc").catch(() => []),
          db.get("pay_duplikate", "?order=kunde_name.asc").catch(() => []),
          db.get("pay_provisions_historie", "?order=mitarbeiter_name.asc,gueltig_ab.asc").catch(() => []),
          db.get("pay_mitarbeiter", "?select=id,vorname,nachname,typ&order=nachname.asc").catch(() => []),
        ]);
        setRegeln(r); setSonder(s); setStufen(st); setTeamBonus(tb); setSperrData(sp); setDuplikateData(dp); setHistorieData(hi); setMitarbeiterList(ma);
        setLoading(false);
      } catch (e) {
        setError(e.message);
        setLoading(false);
      }
    })();
  }, []);

  const tabs = [
    { key: "uebersicht", label: "üìä √úbersicht", color: "var(--y)" },
    { key: "regeln", label: "üìã Regeln", color: "var(--b)" },
    { key: "sonder", label: "‚≠ê Sonderprovisionen", color: "var(--y)" },
    { key: "stufen", label: "üèÜ Stufenbonus", color: "var(--g)" },
    { key: "team", label: "üë• Team-Bonus", color: "var(--t)" },
    { key: "sperr", label: "üîí Sperrlisten", color: "var(--r)" },
    { key: "duplikate", label: "‚ö†Ô∏è Duplikate", color: "var(--o)" },
    { key: "historie", label: "üìú Historie", color: "var(--p)" },
    { key: "staffel", label: "üìà Staffel-History", color: "var(--g)" },
    { key: "import", label: "üì• CSV-Import", color: "var(--t)" },
  ];

  const tabDescriptions = {
    uebersicht: "Gesamt√ºbersicht aller Provisions-Konfigurationen",
    regeln: `${regeln.length} aktive Provisionsmodelle ‚Äì Basis-S√§tze, Staffel, Boni inline editieren`,
    sonder: `${sonder.length} Sonderprovisionen ‚Äì Flat Rates & Overrides pro Mitarbeiter`,
    stufen: `${stufen.length} Stufenbonus-Definitionen ‚Äì NUR LZ-Auftr√§ge z√§hlen (keine NZ)`,
    team: `${teamBonus.length} Team-Bonus-Regeln ‚Äì ‚Ç¨/Sale f√ºr Team-Leiter`,
    sperr: `${sperrData.length} Sperrlisten-Eintr√§ge ‚Äì Grundbuch, MA-Abbruch, CRM-Storno`,
    duplikate: `${duplikateData.length} Duplikat-Verdachtsf√§lle ‚Äì gleicher Kunde + kWp + PLZ`,
    historie: `${historieData.length} Provisions-Perioden ‚Äì Stichtagsprinzip: DatumErstellt bestimmt den Satz`,
    staffel: `Vormonat-Daten pro VT eintragen und Staffel-Korrekturen manuell freigeben`,
    import: `Leveto CSV-Import ‚Äì DatumAngenommen als Auftragsdatum, Ausgezahlt am = bereits abgerechnet`,
  };

  if (loading) return <div style={{ display: "flex", alignItems: "center", justifyContent: "center", height: "100vh", flexDirection: "column", gap: 16 }}>
    <div style={{ width: 40, height: 40, border: "3px solid var(--bd)", borderTopColor: "var(--y)", borderRadius: "50%" }} className="spin" />
    <div style={{ color: "var(--ts)", fontSize: 14 }}>Lade Provisions-Matrix‚Ä¶</div>
  </div>;

  if (error) return <div style={{ padding: 40, textAlign: "center" }}>
    <div style={{ fontSize: 48, marginBottom: 16 }}>‚ö†Ô∏è</div>
    <div style={{ fontSize: 16, fontWeight: 600, color: "var(--r)", marginBottom: 8 }}>Fehler beim Laden</div>
    <div style={{ fontSize: 13, color: "var(--ts)", maxWidth: 500, margin: "0 auto", lineHeight: 1.6 }}>{error}</div>
    <div style={{ marginTop: 16, fontSize: 12, color: "var(--ts)", background: "var(--s2)", padding: 12, borderRadius: 8, maxWidth: 500, margin: "16px auto" }}>
      Tabellen noch nicht erstellt? ‚Üí SQL im <a href="https://supabase.com/dashboard" target="_blank" style={{ color: "var(--y)" }}>Supabase Dashboard</a> ausf√ºhren.
    </div>
  </div>;

  return <div style={{ minHeight: "100vh", padding: "0 0 40px" }}>
    {/* Header */}
    <div style={{ background: "var(--s1)", borderBottom: "1px solid var(--bd)", padding: "16px 24px", position: "sticky", top: 0, zIndex: 10 }}>
      <div style={{ maxWidth: 1400, margin: "0 auto" }}>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 12 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
            <div style={{ width: 36, height: 36, background: "var(--y)", borderRadius: 8, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, fontWeight: 700, color: "#000" }}>P</div>
            <div>
              <div className="hdr-title" style={{ fontWeight: 700, fontSize: 18, color: "var(--tx)" }}>Provisions-Matrix</div>
              <div style={{ fontSize: 11, color: "var(--ts)" }}>bee-doo PAY ‚Äì Alle Regeln, Sperren & Boni editierbar</div>
            </div>
          </div>
          <a href="https://bee-doo-tools.vercel.app/" style={{ color: "var(--ts)", fontSize: 12, textDecoration: "none" }}>‚Üê Zur√ºck zur Toolbox</a>
        </div>
      </div>
    </div>

    <div style={{ maxWidth: 1400, margin: "0 auto", padding: "16px 24px" }}>
      {/* Tabs */}
      <div className="tab-bar" style={{ display: "flex", gap: 6, marginBottom: 16, overflowX: "auto", paddingBottom: 4 }}>
        {tabs.map(t => <button key={t.key} className="tab-btn" onClick={() => setTab(t.key)} style={{
          background: tab === t.key ? `${t.color}18` : "var(--s2)",
          color: tab === t.key ? t.color : "var(--ts)",
          border: `1px solid ${tab === t.key ? `${t.color}44` : "var(--bd)"}`,
          borderRadius: 8, padding: "8px 16px", fontSize: 13, fontWeight: 600, whiteSpace: "nowrap",
          borderBottom: tab === t.key ? `2px solid ${t.color}` : "2px solid transparent"
        }}>{t.label}</button>)}
      </div>

      {/* Tab Description */}
      <div style={{ fontSize: 12, color: "var(--ts)", marginBottom: 16, padding: "8px 12px", background: "var(--s2)", borderRadius: 6, borderLeft: `3px solid ${tabs.find(t => t.key === tab)?.color}` }}>
        {tabDescriptions[tab]}
      </div>

      {/* Content */}
      <div className="fade-in" key={tab}>
        {tab === "uebersicht" && <TabOverview regeln={regeln} sonder={sonder} setSonder={setSonder} stufen={stufen} teamBonus={teamBonus} sperr={sperrData} duplikate={duplikateData} historie={historieData} mitarbeiterList={mitarbeiterList} toast={toast} />}
        {tab === "regeln" && <TabRegeln regeln={regeln} setRegeln={setRegeln} toast={toast} />}
        {tab === "sonder" && <TabSonder sonder={sonder} setSonder={setSonder} toast={toast} mitarbeiterList={mitarbeiterList} />}
        {tab === "stufen" && <TabStufen stufen={stufen} setStufen={setStufen} toast={toast} />}
        {tab === "team" && <TabTeam team={teamBonus} setTeam={setTeamBonus} toast={toast} mitarbeiterList={mitarbeiterList} />}
        {tab === "sperr" && <TabSperr sperr={sperrData} setSperr={setSperrData} toast={toast} />}
        {tab === "duplikate" && <TabDuplikate duplikate={duplikateData} setDuplikate={setDuplikateData} toast={toast} />}
        {tab === "historie" && <TabHistorie historie={historieData} setHistorie={setHistorieData} toast={toast} />}
        {tab === "staffel" && <TabStaffelHistory mitarbeiterList={mitarbeiterList} toast={toast} />}
        {tab === "import" && <TabImport toast={toast} mitarbeiterList={mitarbeiterList} />}
      </div>
    </div>

    <Toast msg={toastMsg} type={toastType} />
  </div>;
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
