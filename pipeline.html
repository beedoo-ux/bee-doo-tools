<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bee-doo Pipeline</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a0a;
            --card: #141414;
            --card-hover: #1a1a1a;
            --border: #2a2a2a;
            --yellow: #F5C500;
            --yellow-dim: rgba(245,197,0,0.15);
            --green: #22c55e;
            --green-dim: rgba(34,197,94,0.15);
            --red: #ef4444;
            --red-dim: rgba(239,68,68,0.15);
            --blue: #3b82f6;
            --blue-dim: rgba(59,130,246,0.15);
            --orange: #f97316;
            --orange-dim: rgba(249,115,22,0.15);
            --purple: #a855f7;
            --purple-dim: rgba(168,85,247,0.15);
            --text: #e5e5e5;
            --text-dim: #888;
            --radius: 12px;
        }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        
        /* Header */
        .header { 
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 24px; border-bottom: 1px solid var(--border);
            position: sticky; top: 0; background: var(--bg); z-index: 100;
        }
        .header h1 { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .header h1 span { color: var(--yellow); }
        
        /* Tabs */
        .tabs { display: flex; gap: 4px; background: var(--card); border-radius: 10px; padding: 4px; }
        .tab { 
            padding: 8px 20px; border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: 500; color: var(--text-dim);
            border: none; background: none; transition: all 0.2s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { background: var(--yellow); color: #000; font-weight: 600; }
        
        /* Main */
        .main { padding: 24px; max-width: 1400px; margin: 0 auto; }
        
        /* Stats Row */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .stat-card {
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 16px; text-align: center;
        }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .label { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
        
        /* Pipeline Board */
        .pipeline-board { 
            display: flex; gap: 12px; overflow-x: auto; padding-bottom: 16px;
            scroll-snap-type: x mandatory;
        }
        .pipeline-col {
            min-width: 260px; max-width: 300px; flex-shrink: 0;
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            scroll-snap-align: start;
        }
        .pipeline-col-header {
            padding: 14px 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .pipeline-col-header h3 { font-size: 13px; font-weight: 600; }
        .pipeline-col-header .count {
            background: var(--yellow-dim); color: var(--yellow);
            padding: 2px 10px; border-radius: 20px; font-size: 12px; font-weight: 700;
        }
        .pipeline-col-body { padding: 8px; max-height: 60vh; overflow-y: auto; }
        .pipeline-card {
            background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
            padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
        }
        .pipeline-card:hover { border-color: var(--yellow); transform: translateY(-1px); }
        .pipeline-card .name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .pipeline-card .detail { font-size: 12px; color: var(--text-dim); }
        .pipeline-card .badges { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .badge {
            font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: 600;
        }
        .badge-efs { background: var(--green-dim); color: var(--green); }
        .badge-no-efs { background: var(--red-dim); color: var(--red); }
        .badge-kwp { background: var(--blue-dim); color: var(--blue); }
        .badge-storno { background: var(--red-dim); color: var(--red); }
        .badge-pv { background: var(--purple-dim); color: var(--purple); }
        .badge-wp { background: var(--orange-dim); color: var(--orange); }
        
        /* EFS Matching Tab */
        .match-section { margin-bottom: 24px; }
        .match-section h2 { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .match-controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .btn {
            padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600;
            border: none; cursor: pointer; transition: all 0.2s; font-family: inherit;
        }
        .btn-primary { background: var(--yellow); color: #000; }
        .btn-primary:hover { background: #e0b400; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--yellow); }
        .btn-success { background: var(--green); color: #fff; }
        .btn-danger { background: var(--red); color: #fff; }
        .btn-sm { padding: 6px 14px; font-size: 12px; }
        
        /* Match Table */
        .match-table { width: 100%; border-collapse: collapse; }
        .match-table th {
            text-align: left; padding: 10px 12px; font-size: 12px; color: var(--text-dim);
            border-bottom: 1px solid var(--border); font-weight: 600; position: sticky; top: 0; background: var(--bg);
        }
        .match-table td { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid var(--border); }
        .match-table tr:hover td { background: var(--card); }
        .match-score {
            display: inline-block; padding: 2px 10px; border-radius: 4px; font-weight: 700; font-size: 12px;
        }
        .score-high { background: var(--green-dim); color: var(--green); }
        .score-mid { background: var(--orange-dim); color: var(--orange); }
        .score-low { background: var(--red-dim); color: var(--red); }
        
        /* Progress bar */
        .progress-wrap { background: var(--card); border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none; }
        .progress-bar-outer { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background: var(--yellow); border-radius: 3px; transition: width 0.3s; width: 0%; }
        .progress-text { font-size: 13px; color: var(--text-dim); margin-top: 8px; }
        
        /* Detail Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 200; display: none;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 24px;
        }
        .modal h2 { font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }
        .modal-close { background: none; border: none; color: var(--text-dim); font-size: 24px; cursor: pointer; }
        .modal-field { margin-bottom: 12px; }
        .modal-field label { font-size: 12px; color: var(--text-dim); display: block; margin-bottom: 4px; }
        .modal-field .val { font-size: 14px; font-weight: 500; }
        .modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        select, input[type="text"], input[type="search"] {
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 8px; font-size: 14px; font-family: inherit;
        }
        select:focus, input:focus { outline: none; border-color: var(--yellow); }
        
        .status-select { min-width: 180px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 12px; }
            .tabs { width: 100%; overflow-x: auto; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .main { padding: 16px; }
            .pipeline-col { min-width: 240px; }
            .match-table { font-size: 12px; }
            .match-table th, .match-table td { padding: 8px 6px; }
            .modal-row { grid-template-columns: 1fr; }
            .match-controls { flex-direction: column; align-items: stretch; }
        }
        @media (max-width: 480px) {
            .stats-row { grid-template-columns: 1fr 1fr; }
            .tab { padding: 8px 12px; font-size: 12px; }
        }
        
        /* Loading spinner */
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--yellow); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Table wrapper for scroll */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); }
        
        /* Filter bar */
        .filter-bar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .search-input { min-width: 240px; flex: 1; }
        
        /* Empty state */
        .empty { text-align: center; padding: 40px; color: var(--text-dim); }
        .empty .icon { font-size: 48px; margin-bottom: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1><img src="https://bee-doo-tools.vercel.app/bee-doo-Logo-white.svg" style="height:26px;vertical-align:middle;margin-right:8px" alt="bee-doo">Pipeline</h1>
        <div class="tabs">
            <button class="tab active" onclick="showTab('pipeline')">Pipeline</button>
            <button class="tab" onclick="showTab('matching')">EFS Matching</button>
            <button class="tab" onclick="showTab('liste')">Alle Projekte</button>
            <button class="tab" onclick="showTab('robot')">EFS Roboter</button>
        </div>
    </div>
    
    <div class="main">
        <!-- Stats -->
        <div class="stats-row" id="stats-row"></div>
        
        <!-- Tab: Pipeline -->
        <div id="tab-pipeline">
            <div class="pipeline-board" id="pipeline-board"></div>
        </div>
        
        <!-- Tab: EFS Matching -->
        <div id="tab-matching" style="display:none">
            <div class="match-section">
                <h2>EFS ‚Üî Kunden Matching</h2>
                <div class="match-controls">
                    <button class="btn btn-primary" onclick="runMatching()" id="btn-match">
                        ‚ö° Auto-Matching starten
                    </button>
                    <button class="btn btn-secondary" onclick="loadExistingMatches()">
                        Bestehende Matches laden
                    </button>
                    <span id="match-status" style="font-size:13px;color:var(--text-dim)"></span>
                </div>
                
                <div class="progress-wrap" id="progress-wrap">
                    <div class="progress-bar-outer"><div class="progress-bar-inner" id="progress-bar"></div></div>
                    <div class="progress-text" id="progress-text">Wird geladen...</div>
                </div>
                
                <div id="match-stats" style="margin-bottom:16px"></div>
                
                <div class="table-wrap">
                    <table class="match-table">
                        <thead>
                            <tr>
                                <th>Score</th>
                                <th>Kunde (bee-doo)</th>
                                <th>PLZ / Ort</th>
                                <th>EFS Kunde</th>
                                <th>EFS PLZ</th>
                                <th>EFS Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="match-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab: Alle Projekte Liste -->
        <div id="tab-liste" style="display:none">
            <div class="filter-bar">
                <input type="search" class="search-input" placeholder="üîç Suche nach Name, PLZ, Auftragsnr..." id="search-input" oninput="filterList()">
                <select class="status-select" id="filter-status" onchange="filterList()">
                    <option value="">Alle Status</option>
                </select>
                <select id="filter-efs" onchange="filterList()">
                    <option value="">EFS: Alle</option>
                    <option value="linked">‚úÖ EFS verkn√ºpft</option>
                    <option value="unlinked">‚ùå Kein EFS</option>
                </select>
            </div>
            <div class="table-wrap">
                <table class="match-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Auftrag</th>
                            <th>PLZ / Ort</th>
                            <th>kWp</th>
                            <th>Status</th>
                            <th>EFS</th>
                            <th>Datum</th>
                        </tr>
                    </thead>
                    <tbody id="list-body"></tbody>
                </table>
            </div>
        </div>
        <!-- Tab: EFS Roboter Mapping -->
        <div id="tab-robot" style="display:none">
            <div class="match-section">
                <h2>ü§ñ EFS √úbergabe-Mapping</h2>
                <p style="color:var(--text-dim);font-size:14px;margin-bottom:20px;max-width:700px;line-height:1.6">
                    Definiert welche Felder aus der bee-doo Datenbank an das EFS-Portal √ºbergeben werden. 
                    Heute: Manuelle Doppelerfassung. Morgen: Roboter (Playwright) √ºbertr√§gt automatisch.<br>
                    <strong>Flow:</strong> Field App / Leveto ‚Üí customers-Tabelle ‚Üí Roboter ‚Üí EFS Portal
                </p>
                
                <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap">
                    <button class="btn btn-primary" onclick="loadMapping()">Mapping laden</button>
                    <button class="btn btn-secondary" onclick="checkReadiness()">üîç EFS-Readiness pr√ºfen</button>
                </div>
                
                <div id="readiness-result" style="margin-bottom:20px"></div>
                
                <div class="table-wrap">
                    <table class="match-table">
                        <thead>
                            <tr>
                                <th>bee-doo Feld</th>
                                <th>Tabelle</th>
                                <th>‚Üí EFS Feld</th>
                                <th>EFS Seite</th>
                                <th>Pflicht</th>
                                <th>Transformation</th>
                            </tr>
                        </thead>
                        <tbody id="mapping-body">
                            <tr><td colspan="6" class="empty">Klicke "Mapping laden" ‚Äì wird nach Migration verf√ºgbar</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top:24px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius)">
                    <h3 style="font-size:14px;margin-bottom:12px">üìä √úbergabe-Status √úbersicht</h3>
                    <div id="uebergabe-stats" style="font-size:13px;color:var(--text-dim)">
                        Wird nach Datenladung angezeigt...
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Detail Modal -->
    <div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
        <div class="modal" id="modal-content"></div>
    </div>

    <script>
    const SB_URL = 'https://hqzpemfaljxcysyqssng.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
    
    const HEADERS = { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json' };
    
    // Pipeline status definitions
    const PIPELINE_STAGES = [
        { key: 'lead', label: 'Lead', color: '#888' },
        { key: 'termin_gelegt', label: 'Termin gelegt', color: '#3b82f6' },
        { key: 'auftrag_erstellt', label: 'Auftrag', color: '#F5C500' },
        { key: 'quality_call', label: 'Quality Call', color: '#a855f7' },
        { key: 'finanzierung', label: 'Finanzierung', color: '#f97316' },
        { key: 'montage_geplant', label: 'Montage geplant', color: '#22c55e' },
        { key: 'montage_abgeschlossen', label: 'Fertig', color: '#10b981' },
        { key: 'storniert', label: 'Storniert', color: '#ef4444' }
    ];
    
    let allCustomers = [];
    let allEfs = [];
    let matchResults = [];
    
    // =================== API HELPERS ===================
    async function sbGet(table, params = '') {
        const res = await fetch(`${SB_URL}/rest/v1/${table}?${params}`, { headers: HEADERS });
        return res.json();
    }
    
    async function sbPatch(table, id, data) {
        return fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`, {
            method: 'PATCH', headers: { ...HEADERS, 'Prefer': 'return=minimal' },
            body: JSON.stringify(data)
        });
    }
    
    async function sbInsert(table, data) {
        return fetch(`${SB_URL}/rest/v1/${table}`, {
            method: 'POST', headers: { ...HEADERS, 'Prefer': 'return=representation' },
            body: JSON.stringify(data)
        });
    }
    
    // =================== DATA LOADING ===================
    async function loadAll() {
        try {
            const [customers, efs, payAuftraege] = await Promise.all([
                sbGet('customers', 'select=*&order=erstellt_am.desc&limit=2000'),
                sbGet('efs_projekte', 'select=*&order=erstellt_am.desc&limit=2000'),
                sbGet('pay_auftraege', 'select=id,auftrag_nr,efs_projekt_id,storniert,beedoo_fortschritt&limit=2000')
            ]);
            
            allCustomers = customers || [];
            allEfs = efs || [];
            
            // Enrich customers with EFS data from pay_auftraege
            const payMap = {};
            (payAuftraege || []).forEach(p => { if(p.efs_projekt_id) payMap[p.id] = p.efs_projekt_id; });
            
            const efsMap = {};
            allEfs.forEach(e => { efsMap[e.efs_id] = e; });
            
            allCustomers.forEach(c => {
                if (!c.efs_projekt_id && c.pay_auftrag_id && payMap[c.pay_auftrag_id]) {
                    c._efs_from_pay = payMap[c.pay_auftrag_id];
                }
                const efsId = c.efs_projekt_id || c._efs_from_pay;
                if (efsId) {
                    c._efs = efsMap[efsId] || null;
                }
            });
            
            renderStats();
            renderPipeline();
            renderList();
            populateFilterStatus();
        } catch(e) {
            console.error('Load error:', e);
        }
    }
    
    // =================== STATS ===================
    function renderStats() {
        const total = allCustomers.length;
        const efsLinked = allCustomers.filter(c => c.efs_projekt_id || c._efs_from_pay).length;
        const barzahler = allCustomers.filter(c => c.zahlungsart === 'bar').length;
        const finanzierung = total - barzahler;
        const efsMissing = allCustomers.filter(c => c.zahlungsart !== 'bar' && !c.efs_projekt_id && !c._efs_from_pay).length;
        const efsTotal = allEfs.length;
        const storniert = allCustomers.filter(c => c.status === 'storniert' || c.pipeline_status === 'storniert').length;
        
        document.getElementById('stats-row').innerHTML = `
            <div class="stat-card">
                <div class="value" style="color:var(--yellow)">${total}</div>
                <div class="label">Kunden gesamt</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color:var(--green)">${efsLinked}</div>
                <div class="label">EFS verkn√ºpft</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color:var(--orange)">${efsMissing}</div>
                <div class="label">EFS fehlt (Finanz.)</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color:var(--yellow)">${barzahler}</div>
                <div class="label">üí∞ Barzahler</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color:var(--blue)">${efsTotal}</div>
                <div class="label">EFS Projekte</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color:var(--red)">${storniert}</div>
                <div class="label">Storniert</div>
            </div>
        `;
    }
    
    // =================== PIPELINE VIEW ===================
    function renderPipeline() {
        const board = document.getElementById('pipeline-board');
        
        // Group customers by pipeline_status (fall back to status)
        const grouped = {};
        PIPELINE_STAGES.forEach(s => grouped[s.key] = []);
        
        allCustomers.forEach(c => {
            let st = c.pipeline_status || c.status || 'lead';
            // Map existing status values
            if (st === 'auftrag') st = 'auftrag_erstellt';
            if (!grouped[st]) st = 'lead'; // fallback
            grouped[st].push(c);
        });
        
        board.innerHTML = PIPELINE_STAGES.map(stage => {
            const items = grouped[stage.key] || [];
            return `
                <div class="pipeline-col">
                    <div class="pipeline-col-header">
                        <h3 style="color:${stage.color}">${stage.label}</h3>
                        <span class="count">${items.length}</span>
                    </div>
                    <div class="pipeline-col-body">
                        ${items.length === 0 ? '<div class="empty" style="padding:20px;font-size:12px">Keine Eintr√§ge</div>' : ''}
                        ${items.slice(0, 50).map(c => {
                            const hasEfs = !!(c.efs_projekt_id || c._efs_from_pay);
                            const efsStatus = c._efs ? c._efs.simplified_status : null;
                            const isBarzahler = c.zahlungsart === 'bar';
                            return `
                                <div class="pipeline-card" onclick="showDetail('${c.id}')">
                                    <div class="name">${c.vorname || ''} ${c.nachname || ''}</div>
                                    <div class="detail">${c.plz || ''} ${c.ort || ''} ¬∑ ${c.auftrag_nr || '-'}</div>
                                    <div class="badges">
                                        ${c.kwp ? `<span class="badge badge-kwp">${c.kwp} kWp</span>` : ''}
                                        ${isBarzahler 
                                            ? '<span class="badge" style="background:var(--yellow-dim);color:var(--yellow)">üí∞ Bar</span>'
                                            : hasEfs 
                                                ? `<span class="badge badge-efs">EFS ‚úì</span>` 
                                                : `<span class="badge badge-no-efs">EFS fehlt</span>`
                                        }
                                        ${efsStatus ? `<span class="badge" style="background:var(--blue-dim);color:var(--blue)">${efsStatus}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${items.length > 50 ? `<div class="empty" style="padding:10px;font-size:12px">+${items.length - 50} weitere</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // =================== EFS MATCHING ===================
    function normalize(str) {
        if (!str) return '';
        return str.toLowerCase()
            .replace(/√§/g, 'ae').replace(/√∂/g, 'oe').replace(/√º/g, 'ue').replace(/√ü/g, 'ss')
            .replace(/[^a-z0-9]/g, '');
    }
    
    function levenshtein(a, b) {
        const m = a.length, n = b.length;
        if (m === 0) return n;
        if (n === 0) return m;
        const d = Array.from({length: m + 1}, (_, i) => [i, ...Array(n).fill(0)]);
        for (let j = 1; j <= n; j++) d[0][j] = j;
        for (let i = 1; i <= m; i++) {
            for (let j = 1; j <= n; j++) {
                d[i][j] = a[i-1] === b[j-1] ? d[i-1][j-1] 
                    : Math.min(d[i-1][j-1] + 1, d[i][j-1] + 1, d[i-1][j] + 1);
            }
        }
        return d[m][n];
    }
    
    function similarity(a, b) {
        const na = normalize(a), nb = normalize(b);
        if (!na || !nb) return 0;
        if (na === nb) return 100;
        const maxLen = Math.max(na.length, nb.length);
        const dist = levenshtein(na, nb);
        return Math.round((1 - dist / maxLen) * 100);
    }
    
    async function runMatching() {
        const btn = document.getElementById('btn-match');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Matching l√§uft...';
        
        const pw = document.getElementById('progress-wrap');
        pw.style.display = 'block';
        
        // Get unlinked customers
        const unlinked = allCustomers.filter(c => !c.efs_projekt_id && !c._efs_from_pay);
        
        // Get unmatched EFS projects (not already linked via pay_auftraege)
        const linkedEfsIds = new Set();
        allCustomers.forEach(c => {
            if (c.efs_projekt_id) linkedEfsIds.add(c.efs_projekt_id);
            if (c._efs_from_pay) linkedEfsIds.add(c._efs_from_pay);
        });
        const unlinkedEfs = allEfs.filter(e => !linkedEfsIds.has(e.efs_id));
        
        matchResults = [];
        const total = unlinked.length;
        
        for (let i = 0; i < unlinked.length; i++) {
            const cust = unlinked[i];
            
            // Update progress
            if (i % 10 === 0) {
                const pct = Math.round((i / total) * 100);
                document.getElementById('progress-bar').style.width = pct + '%';
                document.getElementById('progress-text').textContent = `${i}/${total} Kunden gepr√ºft... (${matchResults.length} Treffer)`;
                await new Promise(r => setTimeout(r, 0)); // yield for UI
            }
            
            let bestMatch = null;
            let bestScore = 0;
            
            for (const efs of unlinkedEfs) {
                // Score components
                let score = 0;
                let fields = {};
                
                // PLZ match (30 points)
                const custPlz = (cust.plz || '').trim();
                const efsPlz = (efs.kunde_plz || efs.projekt_plz || '').trim();
                if (custPlz && efsPlz && custPlz === efsPlz) {
                    score += 30;
                    fields.plz = 30;
                }
                
                // Nachname match (40 points)
                const nachnSim = similarity(cust.nachname, efs.kunde_nachname);
                const nachnScore = Math.round(nachnSim * 0.4);
                score += nachnScore;
                fields.nachname = nachnScore;
                
                // Vorname match (15 points)
                const vornSim = similarity(cust.vorname, (efs.kunde_vorname || '').split(' ')[0]);
                const vornScore = Math.round(vornSim * 0.15);
                score += vornScore;
                fields.vorname = vornScore;
                
                // Stra√üe match (15 points)
                const strSim = similarity(
                    (cust.strasse || '').replace(/\d+/g, ''),
                    (efs.kunde_strasse || efs.projekt_strasse || '').replace(/\d+/g, '')
                );
                const strScore = Math.round(strSim * 0.15);
                score += strScore;
                fields.strasse = strScore;
                
                if (score > bestScore && score >= 50) {
                    bestScore = score;
                    bestMatch = { efs, score, fields };
                }
            }
            
            if (bestMatch) {
                matchResults.push({ customer: cust, ...bestMatch });
            }
        }
        
        // Sort by score descending
        matchResults.sort((a, b) => b.score - a.score);
        
        document.getElementById('progress-bar').style.width = '100%';
        document.getElementById('progress-text').textContent = `Fertig! ${matchResults.length} potenzielle Matches gefunden.`;
        
        renderMatchResults();
        
        btn.disabled = false;
        btn.innerHTML = '‚ö° Auto-Matching starten';
    }
    
    function renderMatchResults() {
        const body = document.getElementById('match-body');
        
        if (matchResults.length === 0) {
            body.innerHTML = '<tr><td colspan="7" class="empty">Keine Matches gefunden. Starte das Matching mit dem Button oben.</td></tr>';
            return;
        }
        
        const high = matchResults.filter(m => m.score >= 80).length;
        const mid = matchResults.filter(m => m.score >= 60 && m.score < 80).length;
        const low = matchResults.filter(m => m.score < 60).length;
        
        document.getElementById('match-stats').innerHTML = `
            <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:13px">
                <span style="color:var(--green)">üü¢ ${high} sichere Matches (‚â•80)</span>
                <span style="color:var(--orange)">üü° ${mid} wahrscheinlich (60-79)</span>
                <span style="color:var(--red)">üî¥ ${low} unsicher (<60)</span>
            </div>
        `;
        
        body.innerHTML = matchResults.map((m, idx) => {
            const scoreClass = m.score >= 80 ? 'score-high' : m.score >= 60 ? 'score-mid' : 'score-low';
            const efs = m.efs;
            const c = m.customer;
            return `
                <tr>
                    <td><span class="match-score ${scoreClass}">${m.score}%</span></td>
                    <td><strong>${c.vorname || ''} ${c.nachname || ''}</strong><br><span style="color:var(--text-dim);font-size:11px">${c.auftrag_nr || '-'}</span></td>
                    <td>${c.plz || ''} ${c.ort || ''}<br><span style="color:var(--text-dim);font-size:11px">${c.strasse || ''}</span></td>
                    <td><strong>${efs.kunde_vorname || ''} ${efs.kunde_nachname || ''}</strong></td>
                    <td>${efs.kunde_plz || efs.projekt_plz || ''} ${efs.kunde_stadt || efs.projekt_stadt || ''}<br><span style="color:var(--text-dim);font-size:11px">${efs.kunde_strasse || efs.projekt_strasse || ''}</span></td>
                    <td><span class="badge" style="background:var(--blue-dim);color:var(--blue)">${efs.simplified_status || '-'}</span></td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="confirmMatch(${idx})">‚úì</button>
                        <button class="btn btn-danger btn-sm" onclick="rejectMatch(${idx})" style="margin-left:4px">‚úó</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async function confirmMatch(idx) {
        const m = matchResults[idx];
        if (!m) return;
        
        try {
            // Update customer with efs_projekt_id
            await sbPatch('customers', m.customer.id, {
                efs_projekt_id: m.efs.efs_id,
                efs_match_score: m.score,
                efs_match_methode: 'auto_match'
            });
            
            // Log the match
            await sbInsert('efs_match_log', {
                customer_id: m.customer.id,
                efs_projekt_id: m.efs.id,
                match_score: m.score,
                match_felder: m.fields,
                status: 'bestaetigt'
            });
            
            // Update local data
            m.customer.efs_projekt_id = m.efs.efs_id;
            m.customer._efs = m.efs;
            
            // Remove from results
            matchResults.splice(idx, 1);
            renderMatchResults();
            renderStats();
            renderPipeline();
            
            document.getElementById('match-status').textContent = `‚úÖ Match best√§tigt: ${m.customer.vorname} ${m.customer.nachname}`;
        } catch(e) {
            console.error('Confirm error:', e);
            document.getElementById('match-status').textContent = '‚ùå Fehler beim Speichern';
        }
    }
    
    async function rejectMatch(idx) {
        const m = matchResults[idx];
        if (!m) return;
        
        try {
            await sbInsert('efs_match_log', {
                customer_id: m.customer.id,
                efs_projekt_id: m.efs.id,
                match_score: m.score,
                match_felder: m.fields,
                status: 'abgelehnt'
            });
        } catch(e) { /* ignore if table doesn't exist yet */ }
        
        matchResults.splice(idx, 1);
        renderMatchResults();
        document.getElementById('match-status').textContent = `Match abgelehnt.`;
    }
    
    async function loadExistingMatches() {
        // Show which customers already have EFS via pay_auftraege but not directly
        const indirect = allCustomers.filter(c => !c.efs_projekt_id && c._efs_from_pay);
        
        matchResults = indirect.map(c => ({
            customer: c,
            efs: c._efs || {},
            score: 100,
            fields: { pay_auftrag: 100 }
        }));
        
        document.getElementById('match-stats').innerHTML = `
            <div style="font-size:13px;color:var(--text-dim)">
                ${indirect.length} Kunden haben EFS-Verkn√ºpfung √ºber pay_auftraege aber noch nicht direkt in customers.
            </div>
        `;
        renderMatchResults();
    }
    
    // =================== LIST VIEW ===================
    function renderList() {
        const body = document.getElementById('list-body');
        body.innerHTML = allCustomers.map(c => {
            const hasEfs = !!(c.efs_projekt_id || c._efs_from_pay);
            const efsStatus = c._efs ? c._efs.simplified_status : '';
            const st = c.pipeline_status || c.status || 'lead';
            const stage = PIPELINE_STAGES.find(s => s.key === st) || PIPELINE_STAGES.find(s => s.key === 'lead');
            return `
                <tr class="list-row" data-name="${(c.vorname||'').toLowerCase()} ${(c.nachname||'').toLowerCase()}" 
                    data-plz="${c.plz||''}" data-nr="${(c.auftrag_nr||'').toLowerCase()}" 
                    data-status="${st}" data-efs="${hasEfs ? 'linked' : 'unlinked'}"
                    onclick="showDetail('${c.id}')" style="cursor:pointer">
                    <td><strong>${c.vorname || ''} ${c.nachname || ''}</strong></td>
                    <td style="color:var(--text-dim)">${c.auftrag_nr || '-'}</td>
                    <td>${c.plz || ''} ${c.ort || ''}</td>
                    <td>${c.kwp || '-'}</td>
                    <td><span style="color:${stage ? stage.color : '#888'}">${stage ? stage.label : st}</span></td>
                    <td>${hasEfs ? `<span class="badge badge-efs">‚úì ${efsStatus || 'verkn√ºpft'}</span>` 
                        : c.zahlungsart === 'bar' ? '<span class="badge" style="background:var(--yellow-dim);color:var(--yellow)">üí∞ Bar</span>' 
                        : '<span class="badge badge-no-efs">EFS fehlt</span>'}</td>
                    <td style="color:var(--text-dim);font-size:12px">${c.auftrags_datum || '-'}</td>
                </tr>
            `;
        }).join('');
    }
    
    function populateFilterStatus() {
        const sel = document.getElementById('filter-status');
        PIPELINE_STAGES.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.key;
            opt.textContent = s.label;
            sel.appendChild(opt);
        });
        // add 'auftrag' for legacy
        const opt = document.createElement('option');
        opt.value = 'auftrag'; opt.textContent = 'Auftrag (legacy)';
        sel.appendChild(opt);
    }
    
    function filterList() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const status = document.getElementById('filter-status').value;
        const efs = document.getElementById('filter-efs').value;
        
        document.querySelectorAll('.list-row').forEach(row => {
            const name = row.dataset.name;
            const plz = row.dataset.plz;
            const nr = row.dataset.nr;
            const rowStatus = row.dataset.status;
            const rowEfs = row.dataset.efs;
            
            let show = true;
            if (search && !name.includes(search) && !plz.includes(search) && !nr.includes(search)) show = false;
            if (status && rowStatus !== status) show = false;
            if (efs && rowEfs !== efs) show = false;
            
            row.style.display = show ? '' : 'none';
        });
    }
    
    // =================== DETAIL MODAL ===================
    function showDetail(customerId) {
        const c = allCustomers.find(x => x.id === customerId);
        if (!c) return;
        
        const efs = c._efs;
        const stage = PIPELINE_STAGES.find(s => s.key === (c.pipeline_status || c.status)) || {};
        const isBarzahler = c.zahlungsart === 'bar';
        const hasEfs = !!(c.efs_projekt_id || c._efs_from_pay);
        
        document.getElementById('modal-content').innerHTML = `
            <h2>
                ${c.vorname || ''} ${c.nachname || ''}
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </h2>
            <div class="modal-row">
                <div class="modal-field"><label>Auftragsnummer</label><div class="val">${c.auftrag_nr || '-'}</div></div>
                <div class="modal-field"><label>Auftragsdatum</label><div class="val">${c.auftrags_datum || '-'}</div></div>
            </div>
            <div class="modal-row">
                <div class="modal-field"><label>Adresse</label><div class="val">${c.strasse || ''}, ${c.plz || ''} ${c.ort || ''}</div></div>
                <div class="modal-field"><label>Telefon</label><div class="val">${c.mobil || c.telefon || '-'}</div></div>
            </div>
            <div class="modal-row">
                <div class="modal-field"><label>kWp</label><div class="val">${c.kwp || '-'}</div></div>
                <div class="modal-field"><label>Vertragssumme</label><div class="val">${c.vertragssumme ? (c.vertragssumme / 100).toLocaleString('de-DE', {style:'currency',currency:'EUR'}) : '-'}</div></div>
            </div>
            
            <!-- Zahlungsart -->
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                <h3 style="font-size:14px;margin-bottom:12px">Zahlungsart</h3>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-sm ${!isBarzahler ? 'btn-primary' : 'btn-secondary'}" 
                            onclick="setZahlungsart('${c.id}', 'finanzierung')">
                        üè¶ Finanzierung (EFS)
                    </button>
                    <button class="btn btn-sm ${isBarzahler ? 'btn-primary' : 'btn-secondary'}" 
                            onclick="setZahlungsart('${c.id}', 'bar')">
                        üí∞ Barzahler
                    </button>
                </div>
                ${isBarzahler ? '<p style="font-size:12px;color:var(--text-dim);margin-top:8px">Barzahler ‚Äì keine EFS-Finanzierung n√∂tig</p>' : ''}
            </div>
            
            <!-- Pipeline Status -->
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                <h3 style="font-size:14px;margin-bottom:12px">Pipeline Status</h3>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
                    ${PIPELINE_STAGES.map(s => `
                        <button class="btn btn-sm ${(c.pipeline_status || c.status) === s.key || (s.key === 'auftrag_erstellt' && c.status === 'auftrag') ? 'btn-primary' : 'btn-secondary'}" 
                                onclick="changeStatus('${c.id}', '${s.key}')"
                                style="font-size:11px">${s.label}</button>
                    `).join('')}
                </div>
            </div>
            
            <!-- EFS Section - only relevant for Finanzierung -->
            ${!isBarzahler ? (efs ? `
                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                    <h3 style="font-size:14px;margin-bottom:12px;color:var(--green)">‚úì EFS Finanzierung</h3>
                    <div class="modal-row">
                        <div class="modal-field"><label>EFS Status</label><div class="val">${efs.simplified_status || '-'}</div></div>
                        <div class="modal-field"><label>Vertragsstatus</label><div class="val">${efs.contract_status || '-'}</div></div>
                    </div>
                    <div class="modal-row">
                        <div class="modal-field"><label>Gesamtpreis</label><div class="val">${efs.gesamtpreis_eur ? Number(efs.gesamtpreis_eur).toLocaleString('de-DE', {style:'currency',currency:'EUR'}) : '-'}</div></div>
                        <div class="modal-field"><label>Monatl. Rate</label><div class="val">${efs.monatl_rate_eur ? Number(efs.monatl_rate_eur).toLocaleString('de-DE', {style:'currency',currency:'EUR'}) : '-'}</div></div>
                    </div>
                    <div class="modal-row">
                        <div class="modal-field"><label>PV</label><div class="val">${efs.pv_anzahl || '-'}√ó ${efs.pv_hersteller || '-'} (${efs.pv_kwp || '-'} kWp)</div></div>
                        <div class="modal-field"><label>Batterie</label><div class="val">${efs.bat_hersteller || '-'} ${efs.bat_kwh || '-'} kWh</div></div>
                    </div>
                </div>
            ` : `
                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                    <h3 style="font-size:14px;margin-bottom:8px;color:var(--orange)">‚ö† EFS Finanzierung fehlt</h3>
                    <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">
                        Dieser Kunde braucht eine EFS-Finanzierung. Nutze das EFS-Matching Tab oder erfasse manuell im EFS-Portal.
                    </p>
                    <div style="font-size:12px;color:var(--text-dim)">
                        √úbergabe-Status: <span style="color:var(--yellow)">${c.efs_uebergabe_status || 'offen'}</span>
                    </div>
                </div>
            `) : `
                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                    <h3 style="font-size:14px;margin-bottom:8px;color:var(--yellow)">üí∞ Barzahler</h3>
                    <p style="font-size:13px;color:var(--text-dim)">Keine EFS-Finanzierung n√∂tig.</p>
                </div>
            `}
            
            <!-- Datenquelle -->
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                <div class="modal-row">
                    <div class="modal-field"><label>Leveto Lead ID</label><div class="val">${c.leveto_lead_id || '-'}</div></div>
                    <div class="modal-field"><label>Datenquelle</label><div class="val">${c.datenquelle || 'leveto'}</div></div>
                </div>
            </div>
        `;
        
        document.getElementById('modal').classList.add('active');
    }
    
    function closeModal() {
        document.getElementById('modal').classList.remove('active');
    }
    
    async function changeStatus(customerId, newStatus) {
        try {
            await sbPatch('customers', customerId, { pipeline_status: newStatus });
            
            const c = allCustomers.find(x => x.id === customerId);
            if (c) c.pipeline_status = newStatus;
            
            renderPipeline();
            renderStats();
            showDetail(customerId);
        } catch(e) {
            console.error('Status change error:', e);
        }
    }
    
    async function setZahlungsart(customerId, art) {
        try {
            await sbPatch('customers', customerId, { zahlungsart: art });
            
            const c = allCustomers.find(x => x.id === customerId);
            if (c) c.zahlungsart = art;
            
            renderPipeline();
            renderStats();
            renderList();
            showDetail(customerId);
        } catch(e) {
            console.error('Zahlungsart error:', e);
        }
    }
    
    // =================== EFS ROBOT MAPPING ===================
    async function loadMapping() {
        try {
            const data = await sbGet('efs_feld_mapping', 'select=*&order=efs_seite,bee_doo_feld&aktiv=eq.true');
            const body = document.getElementById('mapping-body');
            
            if (!data || data.length === 0) {
                body.innerHTML = `<tr><td colspan="6" class="empty">
                    Keine Mappings gefunden. F√ºhre zuerst die SQL-Migration aus, die erstellt die initiale Mapping-Tabelle.
                </td></tr>`;
                return;
            }
            
            body.innerHTML = data.map(m => `
                <tr>
                    <td><strong>${m.bee_doo_feld}</strong></td>
                    <td style="color:var(--text-dim)">${m.bee_doo_tabelle}</td>
                    <td style="color:var(--yellow)">‚Üí ${m.efs_feld}</td>
                    <td>${m.efs_seite || '-'}</td>
                    <td>${m.pflicht ? '<span style="color:var(--red)">Pflicht</span>' : '<span style="color:var(--text-dim)">Optional</span>'}</td>
                    <td style="font-size:12px;color:var(--text-dim)">${m.transformation || '-'}</td>
                </tr>
            `).join('');
        } catch(e) {
            document.getElementById('mapping-body').innerHTML = '<tr><td colspan="6" class="empty">Tabelle existiert noch nicht. Migration zuerst ausf√ºhren.</td></tr>';
        }
    }
    
    async function checkReadiness() {
        // Check which customers have all required fields for EFS √ºbergabe
        const finanzKunden = allCustomers.filter(c => c.zahlungsart !== 'bar' && !c.efs_projekt_id && !c._efs_from_pay);
        
        let ready = 0;
        let missing = [];
        
        finanzKunden.forEach(c => {
            const missingFields = [];
            if (!c.vorname) missingFields.push('Vorname');
            if (!c.nachname) missingFields.push('Nachname');
            if (!c.email && !c.mobil) missingFields.push('Email/Telefon');
            if (!c.strasse) missingFields.push('Stra√üe');
            if (!c.plz) missingFields.push('PLZ');
            if (!c.ort) missingFields.push('Ort');
            if (!c.kwp) missingFields.push('kWp');
            if (!c.vertragssumme) missingFields.push('Vertragssumme');
            
            if (missingFields.length === 0) {
                ready++;
            } else {
                missing.push({ kunde: `${c.vorname || ''} ${c.nachname || ''} (${c.auftrag_nr || '-'})`, felder: missingFields });
            }
        });
        
        const el = document.getElementById('readiness-result');
        el.innerHTML = `
            <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px">
                <div style="display:flex;gap:24px;margin-bottom:16px;flex-wrap:wrap">
                    <div>
                        <span style="font-size:24px;font-weight:700;color:var(--green)">${ready}</span>
                        <span style="font-size:13px;color:var(--text-dim)"> bereit f√ºr EFS</span>
                    </div>
                    <div>
                        <span style="font-size:24px;font-weight:700;color:var(--orange)">${missing.length}</span>
                        <span style="font-size:13px;color:var(--text-dim)"> unvollst√§ndig</span>
                    </div>
                    <div>
                        <span style="font-size:24px;font-weight:700;color:var(--text-dim)">${allCustomers.filter(c=>c.zahlungsart==='bar').length}</span>
                        <span style="font-size:13px;color:var(--text-dim)"> Barzahler (kein EFS)</span>
                    </div>
                </div>
                ${missing.length > 0 ? `
                    <details>
                        <summary style="cursor:pointer;font-size:13px;color:var(--orange)">‚ö† ${missing.length} Kunden mit fehlenden Daten anzeigen</summary>
                        <div style="margin-top:12px;max-height:300px;overflow-y:auto">
                            ${missing.slice(0, 30).map(m => `
                                <div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
                                    <strong>${m.kunde}</strong> ‚Äì fehlt: <span style="color:var(--red)">${m.felder.join(', ')}</span>
                                </div>
                            `).join('')}
                            ${missing.length > 30 ? `<div style="padding:8px;color:var(--text-dim);font-size:12px">+${missing.length - 30} weitere...</div>` : ''}
                        </div>
                    </details>
                ` : ''}
            </div>
        `;
        
        // Update √úbergabe-stats
        document.getElementById('uebergabe-stats').innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
                <div>üìä <strong>${allCustomers.length}</strong> Kunden total</div>
                <div>üè¶ <strong>${finanzKunden.length + allCustomers.filter(c=>c.efs_projekt_id||c._efs_from_pay).length}</strong> Finanzierung</div>
                <div>üí∞ <strong>${allCustomers.filter(c=>c.zahlungsart==='bar').length}</strong> Barzahler</div>
                <div>‚úÖ <strong>${ready}</strong> EFS-ready</div>
                <div>‚ö† <strong>${missing.length}</strong> Daten unvollst√§ndig</div>
                <div>üîó <strong>${allCustomers.filter(c=>c.efs_projekt_id||c._efs_from_pay).length}</strong> bereits in EFS</div>
            </div>
        `;
    }
    
    // =================== TAB SWITCHING ===================
    function showTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('tab-pipeline').style.display = tab === 'pipeline' ? '' : 'none';
        document.getElementById('tab-matching').style.display = tab === 'matching' ? '' : 'none';
        document.getElementById('tab-liste').style.display = tab === 'liste' ? '' : 'none';
        document.getElementById('tab-robot').style.display = tab === 'robot' ? '' : 'none';
    }
    
    // ESC to close modal
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    
    // Init
    loadAll();
    </script>
</body>
</html>
