<!-- v1772054128 -->
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo | Probeabrechnung</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#0a0a0f;color:#c9d1d9;min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#161b22}::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}
.app-header{background:#0d1117;border-bottom:1px solid #21262d;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo-area{display:flex;align-items:center;gap:12px}
.logo-text{font-size:22px;font-weight:800;letter-spacing:-0.5px}.logo-text span{color:#F5C500}
.logo-sub{font-size:11px;color:#8b949e;letter-spacing:1px;text-transform:uppercase}
.controls-bar{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.sel-period{background:#161b22;border:1px solid #30363d;color:#c9d1d9;padding:8px 14px;border-radius:8px;font-family:'DM Sans';font-size:14px;cursor:pointer}
.sel-period:focus{outline:none;border-color:#F5C500}
.btn{padding:8px 16px;border-radius:8px;font-family:'DM Sans';font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:#F5C500;color:#0a0a0f}.btn-primary:hover{background:#e6b800}
.btn-secondary{background:#21262d;color:#c9d1d9;border:1px solid #30363d}.btn-secondary:hover{background:#30363d}
.btn-success{background:#238636;color:#fff}.btn-success:hover{background:#2ea043}
.btn-danger{background:#da3633;color:#fff}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}
.stats-row{display:flex;gap:16px;padding:16px 24px;flex-wrap:wrap}
.stat-card{background:#161b22;border:1px solid #21262d;border-radius:10px;padding:14px 18px;flex:1;min-width:140px}
.stat-label{font-size:11px;color:#8b949e;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.stat-value{font-size:22px;font-weight:700;color:#e6edf3}.stat-value.gold{color:#F5C500}.stat-value.green{color:#3fb950}
.main-grid{padding:0 24px 24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.vt-card{background:#161b22;border:1px solid #21262d;border-radius:12px;padding:16px;cursor:pointer;transition:all .2s}
.vt-card:hover{border-color:#F5C500;transform:translateY(-2px)}
.vt-card.hgb{border-left:3px solid #F5C500}
.vt-card.angestellt{border-left:3px solid #58a6ff}
.vt-card.scouter{border-left:3px solid #a78bfa;background:linear-gradient(135deg,#0d1117 0%,#1a1040 100%)}
.kat-bar{display:flex;gap:8px;padding:0 24px 12px;flex-wrap:wrap}
.kat-btn{padding:6px 16px;border-radius:20px;border:1px solid #30363d;background:transparent;color:#8b949e;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif}
.kat-btn:hover{border-color:#484f58;color:#c9d1d9}
.kat-btn.active{background:#F5C50018;border-color:#F5C500;color:#F5C500}
.kat-btn.active-sc{background:#a78bfa18;border-color:#a78bfa;color:#a78bfa}
.vt-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.vt-name{font-size:15px;font-weight:700;color:#e6edf3}
.vt-kuerzel{font-size:11px;color:#8b949e;background:#21262d;padding:2px 8px;border-radius:4px}
.vt-sales{font-size:12px;color:#8b949e;margin-bottom:6px}
.vt-betrag{font-size:20px;font-weight:800;color:#F5C500}
.vt-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:8px;border-top:1px solid #21262d}
.badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:0.3px}
.badge-entwurf{background:#30363d;color:#8b949e}
.badge-probe{background:#1f2d1f;color:#F5C500;border:1px solid #F5C50040}
.badge-freigegeben{background:#0d2818;color:#3fb950;border:1px solid #3fb95040}
.badge-ausgezahlt{background:#0d1d2d;color:#58a6ff;border:1px solid #58a6ff40}
.detail-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;display:flex;justify-content:center;align-items:stretch}
.detail-container{background:#0d1117;width:100%;max-width:1400px;display:flex;flex-direction:column;overflow:hidden}
.detail-header{background:#161b22;border-bottom:1px solid #21262d;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.detail-body{display:flex;flex:1;overflow:hidden}
.edit-panel{width:420px;min-width:380px;background:#0d1117;border-right:1px solid #21262d;overflow-y:auto;padding:16px;flex-shrink:0}
.preview-panel{flex:1;overflow-y:auto;background:#2d2d2d;padding:20px;display:flex;justify-content:center}
.edit-section{margin-bottom:16px}
.edit-section-title{font-size:12px;font-weight:700;color:#F5C500;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #21262d}
.pos-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#161b22;border:1px solid #21262d;border-radius:8px;margin-bottom:6px;font-size:12px;transition:all .2s}
.pos-row.inactive{opacity:.4;background:#0d1117}
.pos-row .pos-kunde{flex:1;color:#c9d1d9;font-weight:500}
.pos-row .pos-betrag{font-weight:700;color:#e6edf3;min-width:80px;text-align:right}
.toggle-btn{width:28px;height:16px;border-radius:8px;border:none;cursor:pointer;position:relative;transition:background .2s}
.toggle-btn.active{background:#238636}.toggle-btn.inactive-toggle{background:#484f58}
.toggle-btn::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:#fff;top:2px;transition:left .2s}
.toggle-btn.active::after{left:14px}.toggle-btn.inactive-toggle::after{left:2px}
.override-input{background:#21262d;border:1px solid #30363d;color:#F5C500;padding:4px 8px;border-radius:4px;width:80px;text-align:right;font-family:'DM Sans';font-size:12px;font-weight:600}
.override-input:focus{outline:none;border-color:#F5C500}
.extra-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.extra-input{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:6px 10px;border-radius:6px;font-family:'DM Sans';font-size:12px;flex:1}
.extra-input:focus{outline:none;border-color:#F5C500}
.extra-amount{width:100px}
.notes-area{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:10px;border-radius:8px;font-family:'DM Sans';font-size:12px;width:100%;min-height:60px;resize:vertical}
.notes-area:focus{outline:none;border-color:#F5C500}
/* PDF Page */
.gs-page{background:#fff;width:210mm;min-height:297mm;padding:0;position:relative;color:#111;font-family:Arial,sans-serif;font-size:11px;box-shadow:0 4px 24px rgba(0,0,0,.4);display:flex;flex-direction:column}
.gs-page *{color:#111}
.gs-watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-35deg);font-size:82px;font-weight:900;color:rgba(200,0,0,0.18);letter-spacing:10px;text-transform:uppercase;pointer-events:none;z-index:1;white-space:nowrap;text-shadow:0 0 2px rgba(200,0,0,0.1)}
.gs-branded-header{background:#2d2d2d;padding:18mm 16mm 12mm;color:#fff!important;position:relative;overflow:hidden}
.gs-branded-header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:4px;background:#F5C500}
.gs-branded-header *{color:#fff!important}
.gs-body{padding:8mm 16mm 6mm;position:relative;z-index:2;flex:1;display:flex;flex-direction:column}
.gs-footer{margin-top:auto;padding:8px 16mm 6px 16mm;border-top:3px solid #2d2d2d;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0;flex-shrink:0}
.gs-footer-col{font-size:7px;color:#888!important;line-height:1.5;padding:0 6px}
.gs-footer-col:first-child{padding-left:0}.gs-footer-col:last-child{padding-right:0}
.gs-footer-col b{font-size:7.5px;color:#2d2d2d!important;display:block;margin-bottom:1px;text-transform:uppercase;letter-spacing:0.3px}
/* Bereinigung */
.ber-banner{display:flex;align-items:center;gap:12px;padding:10px 24px;cursor:pointer;transition:all .2s;flex-wrap:wrap}
.ber-banner:hover{filter:brightness(1.1)}
.ber-banner-warn{background:linear-gradient(90deg,#2d1600,#1a0f00);border-bottom:1px solid #78350f}
.ber-banner-info{background:linear-gradient(90deg,#0d1d2d,#0d1117);border-bottom:1px solid #1f6feb40}
.ber-pill{font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;display:flex;align-items:center;gap:5px;white-space:nowrap}
.ber-pill-warn{background:#78350f40;color:#fbbf24;border:1px solid #78350f}
.ber-pill-ok{background:#0d281840;color:#3fb950;border:1px solid #23863640}
.ber-pill-danger{background:#3d050840;color:#f85149;border:1px solid #da363340}
.ber-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:150;display:flex;justify-content:center;align-items:center;padding:20px}
.ber-modal{background:#0d1117;border:1px solid #30363d;border-radius:16px;width:100%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
.ber-modal-header{padding:16px 20px;border-bottom:1px solid #21262d;display:flex;justify-content:space-between;align-items:center}
.ber-tabs{display:flex;gap:4px;padding:0 20px;background:#161b22;border-bottom:1px solid #21262d}
.ber-tab{padding:10px 16px;font-size:12px;font-weight:600;color:#8b949e;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;display:flex;align-items:center;gap:6px}
.ber-tab:hover{color:#c9d1d9}.ber-tab.active{color:#F5C500;border-bottom-color:#F5C500}
.ber-tab .ber-count{font-size:10px;background:#30363d;color:#8b949e;padding:2px 6px;border-radius:10px}
.ber-tab.active .ber-count{background:#F5C50030;color:#F5C500}
.ber-body{flex:1;overflow-y:auto;padding:16px 20px}
.ber-item{background:#161b22;border:1px solid #21262d;border-radius:10px;padding:14px;margin-bottom:10px;transition:all .2s}
.ber-item:hover{border-color:#30363d}
.ber-item-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px}
.ber-item-title{font-size:13px;font-weight:700;color:#e6edf3}
.ber-item-sub{font-size:11px;color:#8b949e;margin-top:2px}
.ber-item-badge{font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600;white-space:nowrap}
.ber-item-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.ber-action{padding:6px 14px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid;transition:all .2s;font-family:'DM Sans'}
.ber-action:hover{filter:brightness(1.2)}
.ber-action-keep{background:#23863620;color:#3fb950;border-color:#23863640}
.ber-action-release{background:#F5C50010;color:#F5C500;border-color:#F5C50030}
.ber-action-danger{background:#da363310;color:#f85149;border-color:#da363330}
.ber-action-neutral{background:#21262d;color:#8b949e;border-color:#30363d}
.ber-resolved{opacity:.5;border-color:#21262d}
.ber-resolved-badge{font-size:10px;background:#0d2818;color:#3fb950;padding:3px 8px;border-radius:4px;font-weight:600}
@media(max-width:768px){.ber-modal{max-width:100%;max-height:100%;border-radius:0}.ber-banner{padding:8px 16px}.ber-pill{font-size:10px;padding:3px 8px}.ber-tabs{overflow-x:auto}.ber-item-actions{flex-direction:column}}
.empty-state{text-align:center;padding:60px 20px;color:#484f58}
.empty-state .icon{font-size:48px;margin-bottom:12px}
.empty-state h3{font-size:16px;color:#8b949e;margin-bottom:6px}
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#8b949e}
.spinner{width:20px;height:20px;border:2px solid #30363d;border-top-color:#F5C500;border-radius:50%;animation:spin .6s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;background:#161b22;border:1px solid #21262d;border-radius:10px;padding:12px 20px;font-size:13px;color:#c9d1d9;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideUp .3s ease}
.toast.success{border-color:#238636;color:#3fb950}.toast.error{border-color:#da3633;color:#f85149}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:768px){.app-header{padding:12px 16px}.stats-row{padding:12px 16px;gap:10px}.stat-card{min-width:120px;padding:10px 14px}.stat-value{font-size:18px}.main-grid{padding:0 16px 16px;grid-template-columns:1fr}.detail-body{flex-direction:column}.edit-panel{width:100%;min-width:unset;max-height:50vh;border-right:none;border-bottom:1px solid #21262d}.preview-panel{padding:10px}.gs-page{width:100%;min-height:auto}.controls-bar{width:100%;justify-content:flex-end}}
@media(max-width:480px){.stats-row{flex-direction:column}.stat-card{min-width:unset}.detail-header{flex-direction:column;gap:8px;align-items:flex-start}.edit-panel{padding:12px}.pos-row{flex-wrap:wrap}}
@media print{body{background:#fff}.app-header,.stats-row,.main-grid,.edit-panel,.detail-header,.detail-overlay{display:none!important}.preview-panel{background:#fff;padding:0}.gs-page{box-shadow:none;page-break-after:always}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, useMemo } = React;
const SB_URL = 'https://hqzpemfaljxcysyqssng.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
const HDR = { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

const fmt = (n) => new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0);
const fmtE = (n) => fmt(n)+'\u00a0â‚¬';
const pLabel = (p) => {if(!p)return'â€”';const[y,m]=p.split('/');const mo=['','Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];return `${mo[parseInt(m)]} ${y}`;};
const gK = (name) => {const p=name.trim().split(/\s+/);return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():name.slice(0,2).toUpperCase();};
const gBN = (per,k,nr) => `GS-${per.replace('/','-')}-${k}-${String(nr||1).padStart(3,'0')}`;

const sbG = async(t,q='')=>{const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{headers:HDR});if(!r.ok)throw new Error(`GET ${t}:${r.status}`);return r.json();};
const sbP = async(t,d)=>{const r=await fetch(`${SB_URL}/rest/v1/${t}`,{method:'POST',headers:{...HDR,'Prefer':'return=representation'},body:JSON.stringify(d)});if(!r.ok){const x=await r.text();throw new Error(`POST ${t}:${x}`);}return r.json();};
const sbU = async(t,q,d)=>{const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{method:'PATCH',headers:{...HDR,'Prefer':'return=representation'},body:JSON.stringify(d)});if(!r.ok)throw new Error(`PATCH ${t}:${r.status}`);return r.json();};
const sbD = async(t,q)=>{const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{method:'DELETE',headers:HDR});if(!r.ok)throw new Error(`DEL ${t}:${r.status}`);};

// â•â•â• KI-Gesundheitscheck â•â•â•
async function runHealthCheck(periode) {
  const warnings = [];
  const allOrders = await sbG('pay_auftraege',`produkt_typ=not.in.(lead_count,termin_count,zero_count,sonderzulage)&limit=1000`);
  const mitarbeiter = await sbG('pay_mitarbeiter','aktiv=eq.true&select=id,vorname,nachname,typ');
  const vtMap = {}; mitarbeiter.forEach(m => vtMap[m.id] = `${m.vorname} ${m.nachname}`);
  const now = new Date();

  // 1. On-Hold + bereits bezahlt
  const paidOH = allOrders.filter(o => (o.notiz||'').includes('on_hold') && o.abgerechnet_monat);
  if(paidOH.length) warnings.push({typ:'kritisch',icon:'ðŸ”´',titel:`${paidOH.length} On-Hold bereits bezahlt`,details:paidOH.map(o=>`${o.auftrag_nr} ${o.kunde_name} (${vtMap[o.vertriebler_id]||'?'})`)});

  // 2. On-Hold + storniert
  const stornoOH = allOrders.filter(o => (o.notiz||'').includes('on_hold') && o.storniert);
  if(stornoOH.length) warnings.push({typ:'kritisch',icon:'ðŸ”´',titel:`${stornoOH.length} On-Hold aber storniert`,details:stornoOH.map(o=>`${o.auftrag_nr} ${o.kunde_name}`)});

  // 3. AuftrÃ¤ge ohne Vertriebler
  const noVT = allOrders.filter(o => !o.vertriebler_id && !o.storniert);
  if(noVT.length) warnings.push({typ:'warnung',icon:'ðŸŸ¡',titel:`${noVT.length} AuftrÃ¤ge ohne Vertriebler`,details:noVT.slice(0,8).map(o=>`${o.auftrag_nr} ${o.kunde_name}`)});

  // 4. Duplikate
  const byK = {}; allOrders.filter(o=>!o.storniert).forEach(o=>{const k=(o.kunde_name||'').trim().toLowerCase();if(k){if(!byK[k])byK[k]=[];byK[k].push(o);}});
  const dupes = Object.entries(byK).filter(([k,v])=>v.length>1);
  if(dupes.length) warnings.push({typ:'info',icon:'ðŸ”µ',titel:`${dupes.length} mÃ¶gliche Duplikate`,details:dupes.slice(0,8).map(([k,v])=>`${v[0].kunde_name}: ${v.map(o=>o.auftrag_nr).join(', ')}`)});

  // 5. On-Hold >60 Tage
  const oldOH = allOrders.filter(o=>(o.notiz||'').includes('on_hold')&&!o.storniert&&!o.abgerechnet_monat&&(now-new Date(o.auftrags_datum))/864e5>60);
  if(oldOH.length) warnings.push({typ:'warnung',icon:'ðŸŸ¡',titel:`${oldOH.length} On-Hold seit >60 Tagen`,details:oldOH.map(o=>`${o.auftrag_nr} ${o.kunde_name} â€“ ${Math.round((now-new Date(o.auftrags_datum))/864e5)}d (${vtMap[o.vertriebler_id]||'?'})`)});

  // 6. Storno-Quote >35%
  const stByVT={},toByVT={}; allOrders.forEach(o=>{if(!o.vertriebler_id)return;toByVT[o.vertriebler_id]=(toByVT[o.vertriebler_id]||0)+1;if(o.storniert)stByVT[o.vertriebler_id]=(stByVT[o.vertriebler_id]||0)+1;});
  const hiSt=Object.entries(toByVT).filter(([v,t])=>t>=5&&(stByVT[v]||0)/t>.35).map(([v,t])=>({n:vtMap[v]||'?',s:stByVT[v]||0,t,p:Math.round((stByVT[v]||0)/t*100)}));
  if(hiSt.length) warnings.push({typ:'info',icon:'ðŸ“Š',titel:`${hiSt.length} VTs mit Storno >35%`,details:hiSt.map(h=>`${h.n}: ${h.s}/${h.t} = ${h.p}%`)});

  // 7. Finanzierung abgelehnt, nicht storniert
  const finAbg = allOrders.filter(o=>(o.beedoo_fortschritt||'').includes('Finanzierung abgelehnt')&&!o.storniert&&!o.abgerechnet_monat);
  if(finAbg.length) warnings.push({typ:'warnung',icon:'ðŸŸ¡',titel:`${finAbg.length}Ã— Finanz. abgelehnt (nicht storniert)`,details:finAbg.map(o=>`${o.auftrag_nr} ${o.kunde_name} (${vtMap[o.vertriebler_id]||'?'})`)});

  // 8. Abrechnungen mit 0â‚¬
  const abrs = await sbG('pay_abrechnungen',`periode=eq.${periode}&archiviert_am=is.null&select=id,mitarbeiter_name,brutto_provisionen`);
  const zeroA = abrs.filter(a=>a.brutto_provisionen===0);
  if(zeroA.length) warnings.push({typ:'info',icon:'ðŸ’¡',titel:`${zeroA.length} Abrechnungen mit 0â‚¬`,details:zeroA.map(a=>a.mitarbeiter_name)});

  return warnings;
}

async function generateAbrechnungen(periode, onProgress){
  const [y,m] = periode.split('/');
  const log = (msg) => onProgress?.(msg);
  log('Lade Daten...');
  const periodeStart = `${y}-${m}-01`;
  const lzDate = new Date(parseInt(y), parseInt(m)-2, 1);
  const lzY = lzDate.getFullYear();
  const lzM = String(lzDate.getMonth()+1).padStart(2,'0');
  const leistungsStart = `${lzY}-${lzM}-01`;
  const leistungsEnd = periodeStart;
  log(`Leistungszeitraum: ${lzM}/${lzY}, NachzÃ¼gler vor ${lzM}/${lzY}`);
  const [regeln, stufen, mitarbeiter, sgArr, auftrLZ, auftrNZ, stornoLZ, offenAll, sonderProv, teamBonus, sperrlisten, stornoAbzuege, staffelHistoryFreigegeben, efsZeroProjekte, efsBlockedProjekte, szAuftraege
  ] = await Promise.all([
    sbG('provisions_regeln','aktiv=eq.true'),
    sbG('pay_stufenbonus','aktiv=eq.true&order=min_anlagen.asc'),
    sbG('pay_mitarbeiter','aktiv=eq.true&select=id,vorname,nachname,kuerzel,typ,provisions_regel_id,strasse,plz,ort,steuernummer,kleinunternehmer,mwst_pflichtig,auto_zuschuss,firmenname,ustid,hausnr'),
    sbG('pay_systemgebuehr','aktiv=eq.true&limit=1'),
    sbG('pay_auftraege',`storniert=eq.false&zahlungsstatus=eq.anzahlung_eingegangen&abgerechnet_monat=is.null&auftrags_datum=gte.${leistungsStart}&auftrags_datum=lt.${leistungsEnd}&select=*`),
    sbG('pay_auftraege',`storniert=eq.false&zahlungsstatus=eq.anzahlung_eingegangen&abgerechnet_monat=is.null&auftrags_datum=lt.${leistungsStart}&select=*`),
    sbG('pay_auftraege',`storniert=eq.true&auftrags_datum=gte.${leistungsStart}&auftrags_datum=lt.${leistungsEnd}&select=vertriebler_id,scouter_id,auftrag_nr,kunde_name,kwp,auftrags_datum`),
    sbG('pay_auftraege',`zahlungsstatus=eq.offen&storniert=eq.false&auftrags_datum=gte.${leistungsStart}&auftrags_datum=lt.${leistungsEnd}&select=vertriebler_id,scouter_id,auftrag_nr,kunde_name,kwp,auftrags_datum`),
    sbG('pay_sonderprovisionen','aktiv=eq.true'),
    sbG('pay_team_bonus','aktiv=eq.true'),
    sbG('pay_sperrlisten','select=*'),
    sbG('pay_auftraege',`storniert=eq.true&abgerechnet_monat=not.is.null&select=vertriebler_id,auftrag_nr,kunde_name,kwp,auftrags_datum,abgerechnet_monat,abgerechnet_jahr,storno_provision_zurueck`),
    sbG('pay_staffel_history',`monat=eq.${parseInt(m)}&jahr=eq.${parseInt(y)}&freigegeben=eq.true`),
    sbG('efs_projekte','preismodell=eq.Zero&select=efs_id'),
    sbG('efs_projekte','simplified_status=in.(LAND_REGISTRY_CHECK,REVOKED,MISSING_PROPERTY_OWNERS)&select=efs_id,simplified_status,kunde_name'),
    sbG('pay_auftraege','produkt_typ=eq.sonderzulage&storniert=eq.false&abgerechnet_monat=is.null&select=*'),
  ]);
  // Sperrlisten: gesperrte AN-Nummern â†’ nicht provisionieren
  const gesperrteANs = new Set();
  const rueckforderungANs = new Map(); // ANâ†’{kunde,typ,notiz}
  sperrlisten.forEach(s => {
    const an = String(s.auftrag_nr||'');
    if(s.status==='gesperrt') gesperrteANs.add(an);
    if(s.status==='ausgezahlt') rueckforderungANs.set(an, {kunde:s.kunde_name,typ:s.typ,notiz:s.notiz});
  });
  log(`Sperrliste: ${gesperrteANs.size} gesperrt, ${rueckforderungANs.size} RÃ¼ckforderungen`);
  // Freigegebene Staffel-Korrekturen nach VP-ID indexieren
  const staffelByVP = {};
  (staffelHistoryFreigegeben||[]).forEach(sh => { staffelByVP[sh.mitarbeiter_id] = sh; });
  log(`ðŸ“ˆ Staffel-History: ${Object.keys(staffelByVP).length} freigegebene Korrekturen fÃ¼r ${m}/${y}`);
  // Sonderprovisionen nach VP-ID indexieren
  const sonderByVP = {};
  sonderProv.forEach(sp => {
    if(sp.typ === 'skip_abrechnung' || sp.typ === 'scout_umleitung' || sp.typ === 'scout_eigenlead') return; // nicht als Sonder-Rate
    if(sp.gueltig_ab && sp.gueltig_ab > leistungsEnd) return; // noch nicht gÃ¼ltig
    if(sp.gueltig_bis && sp.gueltig_bis < leistungsStart) return; // abgelaufen
    sonderByVP[sp.mitarbeiter_id] = sp;
  });
  // Scout-Umleitung Regeln parsen
  const scoutUmleitungen = [];
  sonderProv.filter(sp => sp.typ === 'scout_umleitung' && sp.aktiv).forEach(sp => {
    try { const cfg = JSON.parse(sp.beschreibung); scoutUmleitungen.push({ziel_id:sp.mitarbeiter_id, scout_id:cfg.scout_id, betrag_extra:sp.betrag, scout_name:cfg.scout_name}); } catch(e) {}
  });
  if(scoutUmleitungen.length) log(`ðŸ”„ ${scoutUmleitungen.length} Scout-Umleitung(en) geladen`);
  // Scout-Eigenlead Regeln: wenn bestimmter Scout â†’ Eigenlead-Bonus fÃ¼r VT
  const scoutEigenleadRegeln = [];
  sonderProv.filter(sp => sp.typ === 'scout_eigenlead' && sp.aktiv).forEach(sp => {
    try { const cfg = JSON.parse(sp.beschreibung); scoutEigenleadRegeln.push({vt_id:sp.mitarbeiter_id, scout_id:cfg.scout_id, betrag:sp.betrag, scout_name:cfg.scout_name}); } catch(e) {}
  });
  if(scoutEigenleadRegeln.length) log(`ðŸŽ¯ ${scoutEigenleadRegeln.length} Scout-Eigenlead-Regel(n) geladen`);
  // Skip-Abrechnung: VPs die Ã¼bersprungen werden sollen
  const skipVPIds = new Set(sonderProv.filter(sp => sp.typ === 'skip_abrechnung' && sp.aktiv).map(sp => sp.mitarbeiter_id));
  if(skipVPIds.size) log(`â¸ï¸ ${skipVPIds.size} Mitarbeiter Ã¼bersprungen (skip_abrechnung)`);
  // Team-Bonus indexieren
  const teamBonusByVP = {};
  teamBonus.forEach(tb => {
    if(tb.gueltig_ab && tb.gueltig_ab > leistungsEnd) return;
    teamBonusByVP[tb.mitarbeiter_id] = tb;
  });
  // Merge auszahlbar
  auftrNZ.forEach(a => a._nachzuegler = true);
  const auftraege = [...auftrLZ, ...auftrNZ];
  // Filter gesperrte AuftrÃ¤ge raus
  const auftraegeClean = auftraege.filter(a => !gesperrteANs.has(String(a.auftrag_nr||'')) && a.produkt_typ !== 'lead_count' && a.produkt_typ !== 'termin_count' && a.produkt_typ !== 'zero_count' && a.produkt_typ !== 'sonderzulage');
  // Finanzierung abgelehnt â†’ ausschlieÃŸen, es sei denn Barzahler
  const finAbgelehnt = auftraegeClean.filter(a => {const f=(a.beedoo_fortschritt||'').toLowerCase(); return f.includes('finanzierung abgelehnt') && !f.includes('barzahler');});
  const finAbgelehntANs = new Set(finAbgelehnt.map(a=>a.auftrag_nr));
  if(finAbgelehnt.length) log(`ðŸš« ${finAbgelehnt.length} AuftrÃ¤ge mit "Finanzierung abgelehnt" ausgeschlossen: ${finAbgelehnt.map(a=>`${a.auftrag_nr} (${a.kunde_name})`).join(', ')}`);
  // Sonderzulagen aus DB (produkt_typ=sonderzulage) â€“ separater Fetch da kein zahlungsstatus
  const sonderzulagen = szAuftraege || [];
  const szByVP = {};
  sonderzulagen.forEach(a => { const vid=a.vertriebler_id; if(!szByVP[vid])szByVP[vid]=[]; szByVP[vid].push(a); });
  if(sonderzulagen.length) log(`ðŸ“ ${sonderzulagen.length} Sonderzulagen fÃ¼r ${Object.keys(szByVP).length} Mitarbeiter`);
  // EFS-Status: LAND_REGISTRY_CHECK/MISSING_PROPERTY_OWNERS â†’ offen (GrundbuchprÃ¼fung), REVOKED â†’ Storno
  const efsBlockedIds = {}; // efs_id â†’ {status, kunde_name}
  (efsBlockedProjekte||[]).forEach(e => { efsBlockedIds[e.efs_id] = { status: e.simplified_status, kunde: e.kunde_name }; });
  const grundbuchOrders = auftraegeClean.filter(a => a.efs_projekt_id && efsBlockedIds[a.efs_projekt_id] && ['LAND_REGISTRY_CHECK','MISSING_PROPERTY_OWNERS'].includes(efsBlockedIds[a.efs_projekt_id].status));
  const efsRevokedOrders = auftraegeClean.filter(a => a.efs_projekt_id && efsBlockedIds[a.efs_projekt_id] && efsBlockedIds[a.efs_projekt_id].status === 'REVOKED');
  const afterEFS = auftraegeClean.filter(a => !grundbuchOrders.includes(a) && !efsRevokedOrders.includes(a) && !finAbgelehntANs.has(a.auftrag_nr));
  if(grundbuchOrders.length) log(`ðŸ“‹ ${grundbuchOrders.length} AuftrÃ¤ge in GrundbuchprÃ¼fung (LAND_REGISTRY_CHECK) â€“ stehen als offen`);
  if(efsRevokedOrders.length) log(`ðŸš« ${efsRevokedOrders.length} AuftrÃ¤ge REVOKED in EFS â€“ werden als Storno behandelt`);
  // On Hold: AuftrÃ¤ge mit "on_hold" in notiz â†’ nicht auszahlen, separat ausweisen
  const onHoldOrders = afterEFS.filter(a => (a.notiz||'').includes('on_hold'));
  const auftraegePayable = afterEFS.filter(a => !(a.notiz||'').includes('on_hold'));
  if(onHoldOrders.length) log(`â¸ï¸ ${onHoldOrders.length} AuftrÃ¤ge on hold (Montage > On hold) â€“ werden nicht ausgezahlt`);
  const onHoldByVP = {}; const onHoldBySC = {};
  onHoldOrders.forEach(a => { if(a.vertriebler_id){if(!onHoldByVP[a.vertriebler_id])onHoldByVP[a.vertriebler_id]=[];onHoldByVP[a.vertriebler_id].push(a);} if(a.scouter_id){if(!onHoldBySC[a.scouter_id])onHoldBySC[a.scouter_id]=[];onHoldBySC[a.scouter_id].push(a);} });
  // Lead-Count Records separat extrahieren
  const leadCountRecords = auftraege.filter(a => a.produkt_typ === 'lead_count');
  const leadByScout = {};
  leadCountRecords.forEach(a => { if(a.scouter_id) leadByScout[a.scouter_id] = parseInt(a.kwp) || 0; });
  if(Object.keys(leadByScout).length) log(`ðŸ“‹ Lead-Daten: ${Object.keys(leadByScout).length} Scouter, ${Object.values(leadByScout).reduce((s,v)=>s+v,0)} Leads gesamt`);
  // Termin-Count Records separat extrahieren
  const terminCountRecords = auftraege.filter(a => a.produkt_typ === 'termin_count');
  const terminByScout = {};
  terminCountRecords.forEach(a => { if(a.scouter_id) terminByScout[a.scouter_id] = parseInt(a.kwp) || 0; });
  if(Object.keys(terminByScout).length) log(`ðŸ“… Termin-Daten: ${Object.keys(terminByScout).length} Scouter, ${Object.values(terminByScout).reduce((s,v)=>s+v,0)} Termine gesamt`);
  // Zero-Count Records separat extrahieren
  const zeroCountRecords = auftraege.filter(a => a.produkt_typ === 'zero_count');
  const zeroByVP = {};
  zeroCountRecords.forEach(a => { if(a.vertriebler_id) zeroByVP[a.vertriebler_id] = parseInt(a.kwp) || 0; });
  // Zero aus EFS-Projekten erkennen (preismodell=Zero + efs_projekt_id verknÃ¼pft)
  const zeroEFSIds = new Set((efsZeroProjekte||[]).map(e => e.efs_id));
  if(zeroEFSIds.size) log(`âš¡ EFS Zero-Projekte: ${zeroEFSIds.size} in efs_projekte`);
  const zeroFromEFS = {};
  auftraegeClean.forEach(a => {
    if(a.efs_projekt_id && zeroEFSIds.has(a.efs_projekt_id)){
      const vid = a.vertriebler_id;
      if(vid){ zeroFromEFS[vid] = (zeroFromEFS[vid]||0) + 1; }
    }
  });
  // Merge: EFS-Daten Ã¼berschreiben manuell wenn vorhanden
  for(const [vid, cnt] of Object.entries(zeroFromEFS)){
    if(!zeroByVP[vid] || zeroByVP[vid] < cnt) zeroByVP[vid] = cnt;
  }
  if(Object.keys(zeroByVP).length) log(`âš¡ Zero-Daten: ${Object.keys(zeroByVP).length} Vertriebler, ${Object.values(zeroByVP).reduce((s,v)=>s+v,0)} Zero-AbschlÃ¼sse gesamt (${Object.keys(zeroFromEFS).length} aus EFS)`);
  const gesperrteGefunden = auftraege.length - auftraegeClean.length;
  if(gesperrteGefunden>0) log(`âš ï¸ ${gesperrteGefunden} gesperrte AuftrÃ¤ge Ã¼bersprungen`);
  // NZ-Duplikate auto-erkennen: gleicher Kunde + gleicher VT â†’ in pay_duplikate schreiben
  const nzClean = auftraegePayable.filter(a=>a._nachzuegler);
  const nzByKey = {};
  nzClean.forEach(a=>{const k=`${(a.kunde_name||'').trim().toLowerCase()}__${a.vertriebler_id}`;if(!nzByKey[k])nzByKey[k]=[];nzByKey[k].push(a);});
  for(const [k,arr] of Object.entries(nzByKey)){
    if(arr.length<2)continue;
    // Check if already in pay_duplikate
    const an1=String(arr[0].auftrag_nr).replace('AN-','');const an2=String(arr[1].auftrag_nr).replace('AN-','');
    const existing=await sbG('pay_duplikate',`or=(and(auftrag_nr_1.eq.${an1},auftrag_nr_2.eq.${an2}),and(auftrag_nr_1.eq.${an2},auftrag_nr_2.eq.${an1}))`).catch(()=>[]);
    if(existing.length===0){
      const vp=mitarbeiter.find(m=>m.id===arr[0].vertriebler_id);
      await sbP('pay_duplikate',{kunde_name:arr[0].kunde_name,auftrag_nr_1:an1,auftrag_nr_2:an2,vertriebler:vp?`${vp.vorname} ${vp.nachname}`:'',status:'entscheidung_noetig',notiz:`NZ-Duplikat erkannt: ${arr.length}Ã— gleicher Kunde`}).catch(()=>{});
      log(`âš ï¸ NZ-Duplikat erkannt: ${arr[0].kunde_name} (AN-${an1} / AN-${an2})`);
    }
  }
  // Storno: nur Leistungsmonat
  const stornoAuftr = stornoLZ;
  // Storno-AbzÃ¼ge: nach VP groupieren
  const stornoAbzByVP = {};
  stornoAbzuege.forEach(a => { if(!a.vertriebler_id) return; if(!stornoAbzByVP[a.vertriebler_id]) stornoAbzByVP[a.vertriebler_id]=[]; stornoAbzByVP[a.vertriebler_id].push(a); });
  // Offen: LZ vs VM markieren
  const offeneAuftr = offenAll.filter(a => !finAbgelehntANs.has(a.auftrag_nr));
  const stornoLZn = stornoLZ.length;
  const offenLZn = offeneAuftr.length;
  log(`${auftrLZ.length} LZ + ${auftrNZ.length} NZ | ${stornoLZn} Stornos | ${stornoAbzuege.length} Storno-AbzÃ¼ge | ${offenLZn} Offen | ${onHoldOrders.length} On Hold | ${sonderProv.length} Sonder | ${teamBonus.length} Team`);
  const sgConfig = sgArr[0] || {prozent:3, max_netto:200, ust_satz:19};
  const regelMap = {}; regeln.forEach(r => regelMap[r.mitarbeiter_typ] = r);
  const typMap = {hgb_vertriebler_haupt:'hgb_vertriebler_haupt',hgb84:'hgb_vertriebler_haupt',angestellt_vt:'angestellt_vertriebler',angestellt_vertriebler:'angestellt_vertriebler',hgb_vertriebler_agentur:'hgb_vertriebler_agentur',vertriebler:'vertriebler',hgb_scouter:'hgb_scouter',angestellt_scouter:'angestellt_scouter'};
  const vpById = {}; mitarbeiter.forEach(v => { vpById[v.id] = v; });
  const byVP = {};
  auftraegePayable.forEach(a => { if(!a.vertriebler_id) return; if(!byVP[a.vertriebler_id]) byVP[a.vertriebler_id] = []; byVP[a.vertriebler_id].push(a); });
  // Scout grouping: by scouter_id
  const byScout = {};
  auftraegePayable.forEach(a => { if(!a.scouter_id) return; if(!byScout[a.scouter_id]) byScout[a.scouter_id] = []; byScout[a.scouter_id].push(a); });
  const stornoByScout = {};
  stornoAuftr.forEach(a => { if(!a.scouter_id) return; if(!stornoByScout[a.scouter_id]) stornoByScout[a.scouter_id] = []; stornoByScout[a.scouter_id].push(a); });
  const offenByScout = {};
  offeneAuftr.forEach(a => { if(!a.scouter_id) return; if(!offenByScout[a.scouter_id]) offenByScout[a.scouter_id] = []; offenByScout[a.scouter_id].push(a); });
  // Scout-Umleitung: Fremd-AuftrÃ¤ge zÃ¤hlen (nur LZ!) â†’ Ziel-VT bekommt Extra-Bonus
  const umleitungOrders = {};
  scoutUmleitungen.forEach(u => {
    const scOrdsLZ = (byScout[u.scout_id] || []).filter(o => !o._nachzuegler);
    const fremd = scOrdsLZ.filter(o => o.vertriebler_id !== u.ziel_id);
    if(fremd.length > 0){
      if(!umleitungOrders[u.ziel_id]) umleitungOrders[u.ziel_id] = [];
      fremd.forEach(o => umleitungOrders[u.ziel_id].push({order:o, betrag_extra:u.betrag_extra, scout_name:u.scout_name}));
      log(`ðŸ”„ Scout-Umleitung: ${fremd.length} Fremd-AuftrÃ¤ge von ${u.scout_name} â†’ ${vpById[u.ziel_id]?.vorname||''} ${vpById[u.ziel_id]?.nachname||''} (je ${u.betrag_extra}â‚¬)`);
    }
  });
  const stornoByVP = {};
  stornoAuftr.forEach(a => { if(!a.vertriebler_id) return; if(!stornoByVP[a.vertriebler_id]) stornoByVP[a.vertriebler_id] = []; stornoByVP[a.vertriebler_id].push(a); });
  const offenByVP = {};
  offeneAuftr.forEach(a => { if(!a.vertriebler_id) return; if(!offenByVP[a.vertriebler_id]) offenByVP[a.vertriebler_id] = []; offenByVP[a.vertriebler_id].push(a); });
  // Grundbuch-AuftrÃ¤ge â†’ als offen anzeigen (mit Kennzeichnung)
  grundbuchOrders.forEach(a => { a._grundbuch = true; if(a.vertriebler_id){if(!offenByVP[a.vertriebler_id])offenByVP[a.vertriebler_id]=[];offenByVP[a.vertriebler_id].push(a);} });
  grundbuchOrders.forEach(a => { if(a.scouter_id){if(!offenByScout[a.scouter_id])offenByScout[a.scouter_id]=[];offenByScout[a.scouter_id].push(a);} });
  // REVOKED EFS â†’ als Storno behandeln
  efsRevokedOrders.forEach(a => { a._efsRevoked = true; if(a.vertriebler_id){if(!stornoByVP[a.vertriebler_id])stornoByVP[a.vertriebler_id]=[];stornoByVP[a.vertriebler_id].push(a);} });
  efsRevokedOrders.forEach(a => { if(a.scouter_id){if(!stornoByScout[a.scouter_id])stornoByScout[a.scouter_id]=[];stornoByScout[a.scouter_id].push(a);} });
  const allRelevant = await sbG('pay_auftraege','storniert=eq.false&zahlungsstatus=eq.anzahlung_eingegangen&produkt_typ=not.in.(lead_count,termin_count,zero_count)&select=vertriebler_id,scouter_id,auftrags_datum,auftrag_nr,notiz');
  // Paid active orders per VP per month â†’ fÃ¼r rÃ¼ckwirkende Staffel-Korrektur
  const paidActiveOrders = await sbG('pay_auftraege','storniert=eq.false&abgerechnet_monat=not.is.null&produkt_typ=not.in.(lead_count,termin_count,zero_count)&select=vertriebler_id,auftrags_datum,auftrag_nr,kunde_name,kwp,notiz,efs_projekt_id,abgerechnet_monat,abgerechnet_jahr,storno_provision_zurueck');
  // EFS RÃ¼ckforderung: bereits ausgezahlte AuftrÃ¤ge die jetzt LAND_REGISTRY_CHECK/REVOKED sind
  const efsRueckforderungen = [];
  paidActiveOrders.forEach(a => {
    if(!a.efs_projekt_id || !efsBlockedIds[a.efs_projekt_id]) return;
    if(a.storno_provision_zurueck && a.storno_provision_zurueck > 0) return; // bereits zurÃ¼ckgefordert
    const info = efsBlockedIds[a.efs_projekt_id];
    efsRueckforderungen.push({...a, _efsStatus: info.status});
  });
  if(efsRueckforderungen.length) log(`âš ï¸ ${efsRueckforderungen.length} ausgezahlte AuftrÃ¤ge jetzt EFS-blockiert â†’ RÃ¼ckforderung!`);
  const efsRueckByVP = {};
  efsRueckforderungen.forEach(a => { if(a.vertriebler_id){ if(!efsRueckByVP[a.vertriebler_id]) efsRueckByVP[a.vertriebler_id]=[]; efsRueckByVP[a.vertriebler_id].push(a); }});
  // Filter on_hold from all counting
  const allRelevantClean = allRelevant.filter(a => !(a.notiz||'').includes('on_hold'));
  const paidActiveClean = paidActiveOrders.filter(a => !(a.notiz||'').includes('on_hold'));
  const paidPerVPMonth = {};
  const paidDetailsByVPMonth = {};
  paidActiveClean.forEach(a => {
    if(!a.vertriebler_id||!a.auftrags_datum) return;
    const om=a.auftrags_datum.substring(0,4)+'/'+a.auftrags_datum.substring(5,7);
    const key=a.vertriebler_id+'_'+om;
    paidPerVPMonth[key]=(paidPerVPMonth[key]||0)+1;
    if(!paidDetailsByVPMonth[key]) paidDetailsByVPMonth[key]=[];
    paidDetailsByVPMonth[key].push(a);
  });
  log(`ðŸ“Š Staffel-Basis: ${paidActiveOrders.length} bezahlte AuftrÃ¤ge geladen`);
  const salesPerVPMonth = {};
  allRelevantClean.forEach(a => { if(!a.vertriebler_id||!a.auftrags_datum) return; const om=a.auftrags_datum.substring(0,4)+'/'+a.auftrags_datum.substring(5,7); const key=a.vertriebler_id+'_'+om; salesPerVPMonth[key]=(salesPerVPMonth[key]||0)+1; });
  // Scout sales per month
  const salesPerScoutMonth = {};
  allRelevantClean.forEach(a => { if(!a.scouter_id||!a.auftrags_datum) return; const om=a.auftrags_datum.substring(0,4)+'/'+a.auftrags_datum.substring(5,7); const key=a.scouter_id+'_'+om; salesPerScoutMonth[key]=(salesPerScoutMonth[key]||0)+1; });
  // Total sales per VP (alle Monate) for Team-Bonus â€“ mit Kunden-Details
  const totalSalesByVP = {};
  const totalSalesDetailByVP = {};
  auftraegePayable.forEach(a => { if(!a.vertriebler_id) return; totalSalesByVP[a.vertriebler_id]=(totalSalesByVP[a.vertriebler_id]||0)+1; if(!totalSalesDetailByVP[a.vertriebler_id]) totalSalesDetailByVP[a.vertriebler_id]=[]; totalSalesDetailByVP[a.vertriebler_id].push({kunde:a.kunde_name,an:a.auftrag_nr,kwp:a.kwp,datum:a.auftrags_datum}); });
  log('Archiviere alte Abrechnungen fÃ¼r Periode...');
  const oldAbr = await sbG('pay_abrechnungen',`periode=eq.${periode}&archiviert_am=is.null&select=id,status,mitarbeiter_name,brutto_provisionen`);
  const now = new Date().toISOString();
  for(const oa of oldAbr){ try{await sbD('pay_abrechnungen_positionen',`abrechnung_id=eq.${oa.id}`);}catch(e){} try{await sbD('pay_abrechnungen',`id=eq.${oa.id}`);}catch(e){log(`âš ï¸ LÃ¶sch-Fehler ${oa.mitarbeiter_name}: ${e.message}`);} }
  if(oldAbr.length) log(`ðŸ—‘ï¸ ${oldAbr.length} alte Abrechnungen + Positionen gelÃ¶scht`);
  // === ALL1211: Nur fÃ¼r Storno-RÃ¼ckforderungs-Lookup (bezahlt ja/nein + Betrag) ===
  const SHEET_ID='1NP2uP1lctwkaqS5ChNNJ12ps8fz7ra66p_akpxLkTX0';
  log('ðŸ” Lade ALL1211 Zahlungsdaten aus Google Sheet...');
  const all1211Url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=ALL1211`;
  const all1211Raw = await fetch(all1211Url).then(r=>r.text()).catch(e=>{log('âš ï¸ ALL1211 Fehler: '+e);return '';});
  const bezahltSheet = {}; // AN-Nummer (ohne Prefix) â†’ bezahlter Betrag
  if(all1211Raw){
    const parseCsvLine = line => { const f=[]; let c='',q=false; for(let i=0;i<line.length;i++){const ch=line[i]; if(ch==='"')q=!q; else if(ch===','&&!q){f.push(c.trim());c='';} else c+=ch;} f.push(c.trim()); return f; };
    all1211Raw.split('\n').filter(l=>l.trim()).forEach(line=>{
      const cols=parseCsvLine(line); const an=(cols[0]||'').trim(); const br=(cols[7]||'').trim();
      if(!an||!br)return; const b=parseFloat(br.replace(',','.').replace('â‚¬',''));
      if(!isNaN(b)&&b>0) bezahltSheet[an]=b;
    });
    log(`  ðŸ“Š ALL1211: ${Object.keys(bezahltSheet).length} bezahlte AuftrÃ¤ge geladen`);
  } else { log('  âš ï¸ ALL1211 konnte nicht geladen werden'); }
  // === STORNO-RÃœCKFORDERUNG: bezahlte + jetzt stornierte AuftrÃ¤ge aus ALL1211 ===
  const staffelKorrekturen = {};
  if(Object.keys(bezahltSheet).length){
    const alleAuftrKorr = await sbG('pay_auftraege','storniert=eq.true&produkt_typ=not.in.(lead_count,termin_count,zero_count,sonderzulage)&select=vertriebler_id,auftrag_nr,kunde_name,auftrags_datum');
    // Fake-Storno-Erkennung: Storno mit Ersatzauftrag (gleicher Kunde, hÃ¶here AN) â†’ kein RÃ¼ckforderung
    const alleAuftr = await sbG('pay_auftraege','storniert=eq.false&produkt_typ=not.in.(lead_count,termin_count,zero_count,sonderzulage)&select=auftrag_nr,kunde_name');
    const aktivByKunde = {};
    alleAuftr.forEach(a=>{ const kn=(a.kunde_name||'').trim().toLowerCase(); if(kn){ const an=parseInt((a.auftrag_nr||'').replace('AN-',''))||0; if(!aktivByKunde[kn])aktivByKunde[kn]=[]; aktivByKunde[kn].push(an); }});
    const isFakeStorno = (kundeName, anNr) => { const kn=(kundeName||'').trim().toLowerCase(); const myAN=parseInt((anNr||'').replace('AN-',''))||0; return (aktivByKunde[kn]||[]).some(an=>an>myAN); };
    let stornoCount=0;
    alleAuftrKorr.forEach(a=>{
      if(!a.vertriebler_id||!a.auftrag_nr) return;
      const anNum=(a.auftrag_nr||'').replace('AN-','');
      const shBetrag=bezahltSheet[anNum]||0;
      if(shBetrag<=0) return; // Nicht in ALL1211 = nicht bezahlt
      if(isFakeStorno(a.kunde_name, a.auftrag_nr)){ log(`  â­ï¸ Fake-Storno ${a.auftrag_nr} (${(a.kunde_name||'').substring(0,20)}) â€“ Ersatzauftrag vorhanden`); return; }
      const vpId=a.vertriebler_id;
      if(!staffelKorrekturen[vpId]) staffelKorrekturen[vpId]=[];
      const om=a.auftrags_datum?a.auftrags_datum.substring(0,4)+'/'+a.auftrags_datum.substring(5,7):'?';
      staffelKorrekturen[vpId].push({typ:'storno_rueckforderung',monat:om,betrag:-shBetrag,desc:`Storno ${a.auftrag_nr} (${(a.kunde_name||'').substring(0,25)}) = -${shBetrag}â‚¬`,stornierte:[`${a.auftrag_nr} (${(a.kunde_name||'').substring(0,20)}, ${shBetrag}â‚¬)`]});
      stornoCount++;
      const vp=vpById[vpId]; const vpN=vp?`${vp.vorname} ${vp.nachname}`:vpId;
      log(`  âŒ ${vpN}: Storno-RÃ¼ck ${a.auftrag_nr} (${(a.kunde_name||'').substring(0,20)}) = -${shBetrag}â‚¬`);
    });
    if(stornoCount) log(`ðŸ“Š ${stornoCount} Storno-RÃ¼ckforderungen`); else log('âœ… Keine Storno-RÃ¼ckforderungen');
  } else { log('âš ï¸ ALL1211 nicht geladen â€“ Storno-RÃ¼ckforderungen Ã¼bersprungen'); }
  log('â„¹ï¸ Staffel/Stufen-Korrekturen deaktiviert â€“ Daten werden manuell geliefert');

  // === ZUSÃ„TZLICHE SHEET-DATEN: PV-Blatt AbzÃ¼ge, VS VorschÃ¼sse, Stnr Auszahlungen ===
  log('ðŸ“‹ Lade Sheet-Daten (PV-Blatt, VS, Stnr)...');
  const csvPL = line => { const f=[]; let c='',q=false; for(let i=0;i<line.length;i++){const ch=line[i]; if(ch==='"')q=!q; else if(ch===','&&!q){f.push(c.trim());c='';} else c+=ch;} f.push(c.trim()); return f; };
  const [pvAnlagenRaw, pvBlattRaw, vsRaw, stnrRaw] = await Promise.all([
    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=PV%20Anlagen`).then(r=>r.text()).catch(()=>''),
    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${lzY}%2F${lzM}`).then(r=>r.text()).catch(()=>''),
    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=VS`).then(r=>r.text()).catch(()=>''),
    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Stnr`).then(r=>r.text()).catch(()=>'')
  ]);
  // PV Anlagen: payer_id â†’ name
  const payerToName = {};
  if(pvAnlagenRaw){ pvAnlagenRaw.split('\n').slice(1).filter(l=>l.trim()).forEach(line=>{ const cols=csvPL(line); const nm=(cols[0]||'').trim(); const pid=(cols[3]||'').trim(); if(nm&&pid) payerToName[pid]=nm; }); log(`  ðŸ“Š PV Anlagen: ${Object.keys(payerToName).length} Zuordnungen`); }
  // Nameâ†’vpId
  const nmToVpId = {};
  mitarbeiter.forEach(v => { nmToVpId[`${v.vorname} ${v.nachname}`.toLowerCase()] = v.id; nmToVpId[`${v.nachname}, ${v.vorname}`.toLowerCase()] = v.id; const nn=v.nachname.toLowerCase(); if(!nmToVpId['_n_'+nn]) nmToVpId['_n_'+nn]=v.id; else nmToVpId['_n_'+nn]='X'; });
  const resolveVpId = (name) => { if(!name) return null; const n=name.trim().toLowerCase(); if(nmToVpId[n]) return nmToVpId[n]; if(n.includes(',')){ const rev=n.split(',').map(s=>s.trim()).reverse().join(' '); if(nmToVpId[rev]) return nmToVpId[rev]; } for(const p of n.split(/[\s,]+/)){ const k='_n_'+p; if(nmToVpId[k]&&nmToVpId[k]!=='X') return nmToVpId[k]; } /* Fuzzy: Vorname+Nachname als Teilstring */ for(const v of mitarbeiter){ if(n.includes(v.vorname.toLowerCase())&&n.includes(v.nachname.toLowerCase())) return v.id; } return null; };
  const payerToVpId = {};
  for(const [pid,nm] of Object.entries(payerToName)){ const vid=resolveVpId(nm); if(vid) payerToVpId[pid]=vid; }
  log(`  ðŸ”— Payerâ†’VP: ${Object.keys(payerToVpId).length} Zuordnungen`);

  // PV-Blatt: AbzÃ¼ge/Nachzahlungen
  const sheetAbzByVP = {};
  if(pvBlattRaw){ let cnt=0; pvBlattRaw.split('\n').slice(1).filter(l=>l.trim()).forEach(line=>{ const cols=csvPL(line); const vtN=(cols[3]||'').trim(); const kunde=(cols[4]||'').trim(); const prod=(cols[6]||'').trim(); const bs=(cols[7]||'').trim(); if(!vtN||!bs) return; const b=parseFloat(bs.replace(',','.').replace('â‚¬','')); if(isNaN(b)||b===0) return; const vid=resolveVpId(vtN); if(!vid){ log(`  âš ï¸ PV-Blatt: ${vtN} nicht gefunden`); return; } if(!sheetAbzByVP[vid]) sheetAbzByVP[vid]=[]; sheetAbzByVP[vid].push({betrag:b,produkt:prod||kunde,kunde}); cnt++; }); log(`  ðŸ“‹ PV-Blatt ${lzY}/${lzM}: ${cnt} EintrÃ¤ge`); }

  // VS: VorschÃ¼sse/Rechnungen
  const sheetVSByVP = {};
  if(vsRaw){ let cnt=0; vsRaw.split('\n').slice(1).filter(l=>l.trim()).forEach(line=>{ const cols=csvPL(line); const pid=(cols[1]||'').trim(); const ref=(cols[2]||'').trim(); const refE=(cols[3]||'').trim(); const cat=(cols[4]||'').trim(); const nt=parseFloat((cols[8]||'0').replace(',','.')); if(!pid||isNaN(nt)||nt===0) return; const vid=payerToVpId[pid]; if(!vid) return; if(!sheetVSByVP[vid]) sheetVSByVP[vid]=[]; const rn=ref!=='NULL'?ref:(refE!=='NULL'?refE:''); sheetVSByVP[vid].push({betrag:nt,referenz:rn,kategorie:cat}); cnt++; }); log(`  ðŸ“‹ VS: ${cnt} EintrÃ¤ge`); }

  // Stnr: Stornokonto â€“ DIESEN MONAT DEAKTIVIERT
  const sheetStnrByVP = {};
  log('â„¹ï¸ Stnr-Auszahlung diesen Monat deaktiviert');

  let count = 0;
  // ALL VP IDs incl. team bonus recipients + sonderprov
  const allVPIds = new Set([...Object.keys(byVP), ...Object.keys(stornoByVP), ...Object.keys(offenByVP), ...Object.keys(sonderByVP), ...Object.keys(teamBonusByVP), ...Object.keys(stornoAbzByVP), ...Object.keys(zeroByVP), ...Object.keys(umleitungOrders), ...Object.keys(szByVP), ...Object.keys(sheetAbzByVP), ...Object.keys(sheetVSByVP), ...Object.keys(sheetStnrByVP)]);
  for(const vpId of allVPIds){
    const vp = vpById[vpId]; if(!vp) continue;
    if((vp.typ||'').includes('scouter')) continue; // Scouter werden im Scouter-Loop verarbeitet
    if(skipVPIds.has(vpId)){ log(`â¸ï¸ ${vp.vorname} ${vp.nachname} Ã¼bersprungen (skip_abrechnung)`); continue; }
    try{
    const orders = byVP[vpId] || [];
    const vpStornos2 = stornoByVP[vpId] || [];
    const vpOffen2 = offenByVP[vpId] || [];
    const hasSonder = !!sonderByVP[vpId];
    const hasTeamB = !!teamBonusByVP[vpId];
    const hasSheetData = !!(sheetAbzByVP[vpId]||[]).length || !!(sheetVSByVP[vpId]||[]).length || !!sheetStnrByVP[vpId];
    if(!orders.length && !vpStornos2.length && !vpOffen2.length && !(onHoldByVP[vpId]||[]).length && !hasTeamB && !(szByVP[vpId]||[]).length && !hasSheetData) continue;
    const ruleTyp = typMap[vp.typ] || vp.typ;
    const regel = regelMap[ruleTyp];
    if(!regel){ log(`âš ï¸ ${vp.vorname} ${vp.nachname}: keine Regel fÃ¼r ${ruleTyp}`); continue; }
    const isHGB = (vp.typ||'').includes('hgb');
    const vpName = `${vp.vorname} ${vp.nachname}`;
    log(`Berechne ${vpName}...`);
    // Sonderprovision: override Basisbetrag
    const sonder = sonderByVP[vpId];
    const sonderFlat = sonder?.typ==='flat_rate' ? sonder.betrag : null;
    const sonderNoEigenlead = sonder?.beschreibung?.toLowerCase().includes('kein eigenlead');
    const sonderNoEmpfehlung = sonder?.beschreibung?.toLowerCase().includes('kein empfehlung');
    // NZ-Override: "NZ:2000" in Beschreibung â†’ eigene Basis fÃ¼r NachzÃ¼gler, alle Boni aktiv
    const nzMatch = sonder?.beschreibung?.match(/NZ:(\d+)/);
    const sonderNZBetrag = nzMatch ? parseFloat(nzMatch[1]) : null;
    const ordersLZ = orders.filter(o => !o._nachzuegler);
    const ordersNZ = orders.filter(o => o._nachzuegler);
    const positionen = []; let bruttoTotal = 0;
    // Helper: process orders for a month group
    const processOrders = (monthOrders, om, isNZ) => {
      const monthKey=vpId+'_'+om; const monthTotal=salesPerVPMonth[monthKey]||monthOrders.length;
      const staffel=monthTotal>=regel.staffel_schwelle;
      // NZ mit eigenem Betrag â†’ NZ-Rate, alle Boni; sonst Sonder-Flat oder Staffel/Basis
      const useNZOverride = isNZ && sonderNZBetrag;
      const baseBetrag = useNZOverride ? sonderNZBetrag : (sonderFlat || (staffel ? regel.staffel_betrag_sale : regel.basis_betrag_sale));
      const nzTag = isNZ ? ' â˜…NZ' : '';
      const staffelTag = useNZOverride ? ' (NZ-Sonder)' : (sonderFlat ? ' (Sonder)' : (staffel ? ' (Staffel)' : ''));
      for(const o of monthOrders){
        positionen.push({typ:'provision',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`Solar ${o.kwp||0} kWp`,original_betrag:baseBetrag,aktiv:true,zurueckgestellt:false,notiz:`${om}${staffelTag}${nzTag}`});
        bruttoTotal+=baseBetrag;
        const q=(o.lead_quelle||'').toLowerCase();
        // Eigenlead-Bonus: bei NZ-Override immer aktiv, sonst nicht bei "kein Eigenlead"
        if(q.includes('eigenlead')&&regel.betrag_eigenlead>0&&(useNZOverride||!sonderNoEigenlead)){positionen.push({typ:'eigenlead',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Eigenlead-Bonus',original_betrag:regel.betrag_eigenlead,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=regel.betrag_eigenlead;}
        // Scout-Eigenlead: bestimmter Scout â†’ Eigenlead-Sonderprovision
        const seRule = scoutEigenleadRegeln.find(r => r.vt_id === vpId && o.scouter_id === r.scout_id);
        if(seRule){positionen.push({typ:'eigenlead',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`Eigenlead-Sonder (Scout: ${seRule.scout_name})`,original_betrag:seRule.betrag,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=seRule.betrag;}
        // Empfehlungs-Bonus: bei NZ-Override immer aktiv, sonst nicht bei "kein Empfehlung"
        if(q.includes('empfehlung')&&regel.betrag_empfehlung>0&&(useNZOverride||!sonderNoEmpfehlung)){positionen.push({typ:'empfehlung',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Empfehlungs-Bonus',original_betrag:regel.betrag_empfehlung,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=regel.betrag_empfehlung;}
        if(o.speichererweiterung&&regel.betrag_speicher>0){const sxM=(o.notiz||'').match(/speicher_x(\d+)/);const sxAnz=sxM?parseInt(sxM[1]):1;const spBetrag=regel.betrag_speicher*sxAnz;positionen.push({typ:'speicher',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`Speicher-Bonus${sxAnz>1?' ('+sxAnz+'Ã—)':''}`,original_betrag:spBetrag,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=spBetrag;}
        // Zero-Bonus: EFS preismodell=Zero â†’ pro Auftrag
        if(o.efs_projekt_id&&zeroEFSIds.has(o.efs_projekt_id)&&regel.betrag_zero>0){positionen.push({typ:'zero_bonus',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Zero-Bonus',original_betrag:regel.betrag_zero,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=regel.betrag_zero;}

      }
    };
    // LZ
    const ordersByMonthLZ = {};
    ordersLZ.forEach(o => { const d=o.auftrags_datum||''; const om=d.substring(0,4)+'/'+d.substring(5,7); if(!ordersByMonthLZ[om])ordersByMonthLZ[om]=[]; ordersByMonthLZ[om].push(o); });
    for(const [om, mo] of Object.entries(ordersByMonthLZ)) processOrders(mo, om, false);
    // NZ
    if(ordersNZ.length > 0){
      const ordersByMonthNZ = {};
      ordersNZ.forEach(o => { const d=o.auftrags_datum||''; const om=d.substring(0,4)+'/'+d.substring(5,7); if(!ordersByMonthNZ[om])ordersByMonthNZ[om]=[]; ordersByMonthNZ[om].push(o); });
      for(const [om, mo] of Object.entries(ordersByMonthNZ)) processOrders(mo, om, true);
    }
    // Stufenbonus (nicht bei "kein Stufenbonus" in Sonder-Beschreibung)
    // REGEL: Stufenbonus zÃ¤hlt NUR LZ-AuftrÃ¤ge des aktuellen Leistungszeitraums
    const sonderNoStufen = sonder?.beschreibung?.toLowerCase().includes('kein stufenbonus');
    let stufenBonus=0;
    if(!sonderNoStufen){
      // Nur aktuelle LZ-Monate zÃ¤hlen (nicht bereits abgerechnete Vormonate)
      const lzMonthKeys = new Set();
      ordersLZ.forEach(o=>{ const om=(o.auftrags_datum||'').substring(0,4)+'/'+(o.auftrags_datum||'').substring(5,7); lzMonthKeys.add(vpId+'_'+om); });
      for(const s of stufen){ if(s.gilt_fuer!==ruleTyp) continue; for(const k of lzMonthKeys){ const cnt=salesPerVPMonth[k]||0; if(cnt>=s.min_anlagen&&s.bonus_betrag>stufenBonus) stufenBonus=s.bonus_betrag; } }
    }
    if(stufenBonus>0){ positionen.push({typ:'einmalzahlung',auftrag_nr:null,kunde:null,produkt:'Stufenbonus',original_betrag:stufenBonus,aktiv:true,zurueckgestellt:false,notiz:'Stufenbonus'}); bruttoTotal+=stufenBonus; }
    // === RÃœCKWIRKENDE STAFFEL-KORREKTUR (Freigabe-basiert aus Matrix) ===
    const shEntry = staffelByVP[vpId];
    if(shEntry && shEntry.korrektur_betrag && +shEntry.korrektur_betrag !== 0){
      const isNZ = shEntry.korrektur_typ === 'nachzahlung';
      const betrag = +shEntry.korrektur_betrag;
      const typ = isNZ ? 'staffel_nachzahlung' : 'staffel_rueckforderung';
      const vorzeichen = isNZ ? betrag : -Math.abs(betrag);
      positionen.push({
        typ: typ,
        auftrag_nr: null,
        kunde: shEntry.korrektur_grund || (isNZ ? 'Staffel-Nachzahlung' : 'Staffel-RÃ¼ckforderung'),
        produkt: `${isNZ ? 'Staffel-Nachzahlung' : 'Staffel-RÃ¼ckforderung'} (freigegeben)`,
        original_betrag: vorzeichen,
        aktiv: true,
        zurueckgestellt: false,
        notiz: `Vormonat: ${shEntry.bezahlte_auftraege} AuftrÃ¤ge, Staffel: ${shEntry.staffel_erreicht?'ja':'nein'}, Stufenbonus: ${fmt(shEntry.stufenbonus_betrag||0)}â‚¬ â€“ ${shEntry.korrektur_grund||''}`
      });
      if(isNZ) bruttoTotal += betrag; else bruttoTotal -= Math.abs(betrag);
      log(`  ${isNZ ? 'ðŸ“ˆ' : 'ðŸ“‰'} ${vpName}: Staffel-Korrektur (FREIGEGEBEN): ${isNZ?'+':''}${fmt(vorzeichen)}â‚¬ â€“ ${shEntry.korrektur_grund||''}`);
    }
    // Team-Bonus: Christoph Held â†’ 200â‚¬ pro Sale ALLER VTs, Tayfun â†’ 300â‚¬ pro Sale seines Teams
    const tb = teamBonusByVP[vpId];
    if(tb){
      let teamSales = 0;
      const teamDetail = []; // [{name, sales, orders:[{kunde,an,kwp,datum}]}]
      if(tb.bezugsgruppe==='alle_vt'){
        for(const [vid, cnt] of Object.entries(totalSalesByVP)){ if(vid!==vpId){ teamSales+=cnt; const tvp=vpById[vid]; if(tvp&&cnt>0) teamDetail.push({name:`${tvp.vorname} ${tvp.nachname}`,sales:cnt,orders:totalSalesDetailByVP[vid]||[]}); } }
      } else if(tb.bezugsgruppe==='eigenes_team' && tb.team_mitglieder){
        const teamNames = (tb.team_mitglieder||[]).map(n=>n.toLowerCase());
        for(const [vid, cnt] of Object.entries(totalSalesByVP)){
          const tvp = vpById[vid];
          if(tvp && teamNames.includes(`${tvp.vorname} ${tvp.nachname}`.toLowerCase())){ teamSales+=cnt; if(cnt>0) teamDetail.push({name:`${tvp.vorname} ${tvp.nachname}`,sales:cnt,orders:totalSalesDetailByVP[vid]||[]}); }
        }
      }
      teamDetail.sort((a,b)=>b.sales-a.sales);
      if(teamSales>0){
        const tbBetrag = teamSales * tb.betrag_pro_sale;
        positionen.push({typ:'team_bonus',auftrag_nr:null,kunde:null,produkt:`Team-Bonus (${teamSales} Team-Sales Ã— ${fmt(tb.betrag_pro_sale)}â‚¬)`,original_betrag:tbBetrag,aktiv:true,zurueckgestellt:false,notiz:JSON.stringify({td:teamDetail,bps:tb.betrag_pro_sale}),_teamDetail:teamDetail,_betragProSale:tb.betrag_pro_sale});
        bruttoTotal+=tbBetrag;
      }
    }
    // RÃ¼ckforderungen (gesperrte ausgezahlte)
    for(const [an, info] of rueckforderungANs){
      // Check if this AN belongs to this VP (check orders from allRelevant)
      const matchOrder = allRelevant.find(a => String(a.auftrag_nr||'')===an && a.vertriebler_id===vpId);
      // Fallback: check sperrliste vertriebler_name
      const sperrEntry = sperrlisten.find(s => String(s.auftrag_nr||'')===an && s.status==='ausgezahlt');
      if(matchOrder || (sperrEntry && sperrEntry.vertriebler_name && sperrEntry.vertriebler_name.includes(vp.nachname))){
        positionen.push({typ:'abzug',auftrag_nr:an,kunde:info.kunde,produkt:`RÃ¼ckforderung â€“ ${info.typ||'Sperre'}`,original_betrag:0,aktiv:true,zurueckgestellt:false,notiz:info.notiz||'RÃ¼ckforderung prÃ¼fen'});
      }
    }
    // EFS-RÃ¼ckforderung: ausgezahlte AuftrÃ¤ge die jetzt LAND_REGISTRY_CHECK/REVOKED sind
    const vpEfsRueck = efsRueckforderungen.filter(a => a.vertriebler_id === vpId);
    vpEfsRueck.forEach(a => {
      const statusLabel = a._efsStatus === 'REVOKED' ? 'Widerruf (REVOKED)' : 'GrundbuchprÃ¼fung';
      positionen.push({typ:'abzug',auftrag_nr:String(a.auftrag_nr),kunde:a.kunde_name,produkt:`RÃ¼ckforderung â€“ EFS ${statusLabel}`,original_betrag:0,aktiv:true,zurueckgestellt:false,notiz:`Ausgezahlt ${a.abgerechnet_monat}/${a.abgerechnet_jahr}, jetzt EFS: ${a._efsStatus}`});
      log(`  âš ï¸ ${vpName}: EFS-RÃ¼ckforderung ${a.auftrag_nr} (${a.kunde_name}) â€“ ${a._efsStatus}`);
    });
    // Scout-Umleitung: nur Extra-Bonus (800â‚¬), Scout behÃ¤lt seine Provision
    const umlOrds = umleitungOrders[vpId] || [];
    if(umlOrds.length > 0){
      umlOrds.forEach(u => {
        positionen.push({typ:'sondereinsatz',auftrag_nr:u.order.auftrag_nr,kunde:u.order.kunde_name,produkt:`Scout-Umleitung (${u.scout_name})`,original_betrag:u.betrag_extra,aktiv:true,zurueckgestellt:false,notiz:`Umleitung-Bonus`});
        bruttoTotal += u.betrag_extra;
      });
      log(`  ðŸ”„ ${vpName}: ${umlOrds.length} Scout-Umleitung(en) Ã— ${umlOrds[0].betrag_extra}â‚¬ = ${umlOrds.length * umlOrds[0].betrag_extra}â‚¬`);
    }
    // Storno-Info (nur Leistungsmonat)
    const vpStornos = stornoByVP[vpId] || [];
    vpStornos.forEach(s => { positionen.push({typ:'storno_info',auftrag_nr:s.auftrag_nr,kunde:s.kunde_name,produkt:`Storno â€“ Solar ${s.kwp||0} kWp`,original_betrag:0,aktiv:true,zurueckgestellt:false,notiz:(s.auftrags_datum||'').substring(0,7)}); });
    // Storno-AbzÃ¼ge: werden Ã¼ber ALL1211-Korrektur-System abgewickelt (siehe AUTO KORREKTUREN unten)
    // Offen-Info (LZ + VM getrennt)
    // Sonderzulagen aus Sheet (Zugaben/AbzÃ¼ge)
    const vpSZ = szByVP[vpId] || [];
    vpSZ.forEach(sz => {
      const parts = (sz.notiz||'').split('|');
      const vorzeichen = parts[0]?.startsWith('-') ? -1 : 1;
      const betrag = parseFloat(parts[0]?.replace(/[^0-9.]/g,'')) || 0;
      const beschreibung = parts[1] || sz.kunde_name || 'Sonderzulage';
      const realBetrag = vorzeichen * betrag;
      const typ = realBetrag >= 0 ? 'sondereinsatz' : 'abzug';
      positionen.push({typ,auftrag_nr:sz.auftrag_nr,kunde:sz.kunde_name,produkt:beschreibung,original_betrag:realBetrag,aktiv:true,zurueckgestellt:false,notiz:'Sonderzulage 2026/01'});
      bruttoTotal += realBetrag;
    });
    // Fahrzeugzuschuss (monatlich, aus pay_mitarbeiter.auto_zuschuss)
    if(vp.auto_zuschuss && +vp.auto_zuschuss > 0){
      positionen.push({typ:'sondereinsatz',auftrag_nr:null,kunde:null,produkt:'Fahrzeugzuschuss',original_betrag:+vp.auto_zuschuss,aktiv:true,zurueckgestellt:false,notiz:'monatlich'});
      bruttoTotal += +vp.auto_zuschuss;
    }
    const vpOffen = offenByVP[vpId] || [];
    vpOffen.forEach(o => { positionen.push({typ:'offen_info',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`Offen â€“ Solar ${o.kwp||0} kWp`,original_betrag:0,aktiv:true,zurueckgestellt:false,notiz:(o.auftrags_datum||'').substring(0,7)}); });
    // On Hold Info
    const vpOnHold = onHoldByVP[vpId] || [];
    vpOnHold.forEach(o => { positionen.push({typ:'on_hold_info',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`On Hold â€“ Solar ${o.kwp||0} kWp`,original_betrag:0,aktiv:true,zurueckgestellt:false,notiz:(o.auftrags_datum||'').substring(0,7)}); });
    // === SHEET-DATEN: PV-Blatt AbzÃ¼ge/Nachzahlungen ===
    const vpShAbz = sheetAbzByVP[vpId] || [];
    vpShAbz.forEach(sa => {
      const isDupe = positionen.some(p => Math.abs(p.original_betrag - sa.betrag) < 0.01 && (p.produkt||'').includes((sa.produkt||'').substring(0,12)));
      if(isDupe){ log(`  âš ï¸ ${vpName}: PV-Blatt Duplikat: ${sa.produkt} ${sa.betrag}â‚¬`); return; }
      positionen.push({typ:sa.betrag>=0?'sondereinsatz':'abzug', auftrag_nr:null, kunde:sa.kunde, produkt:sa.kunde&&sa.produkt?`${sa.produkt} (${sa.kunde})`:sa.produkt||sa.kunde, original_betrag:sa.betrag, aktiv:true, zurueckgestellt:false, notiz:`PV-Blatt ${lzY}/${lzM}`});
      bruttoTotal += sa.betrag;
    });
    if(vpShAbz.length) log(`  ðŸ“‹ ${vpName}: ${vpShAbz.length} PV-Blatt (${vpShAbz.reduce((s,a)=>s+a.betrag,0)}â‚¬)`);
    // === SHEET-DATEN: VS VorschÃ¼sse/Rechnungen (ABZUG von brutto) ===
    const vpVSh = sheetVSByVP[vpId] || [];
    vpVSh.forEach(vs => {
      const isDupe = positionen.some(p => p.notiz && vs.referenz && p.notiz.includes(vs.referenz));
      if(isDupe) return;
      const vsBetrag = -Math.abs(vs.betrag);
      positionen.push({typ:'vorschuss_rechnung', auftrag_nr:null, kunde:vs.referenz, produkt:`${vs.kategorie==='VS'?'Vorschuss':vs.kategorie==='RE'?'Rechnung':'Beleg'} ${vs.referenz}`, original_betrag:vsBetrag, aktiv:true, zurueckgestellt:false, notiz:`VS ${vs.referenz}`});
      bruttoTotal += vsBetrag;
    });
    if(vpVSh.length) log(`  ðŸ“‹ ${vpName}: ${vpVSh.length} VS-EintrÃ¤ge`);
    // === SHEET-DATEN: Stnr Steuerberater ===
    const vpStnrSh = sheetStnrByVP[vpId];
    if(vpStnrSh){
      positionen.push({typ:'stnr_auszahlung', auftrag_nr:null, kunde:null, produkt:'Stornokonto-Auszahlung', original_betrag:Math.abs(vpStnrSh.betrag), aktiv:true, zurueckgestellt:false, notiz:`Stnr ${vpStnrSh.payerId}`});
      log(`  ðŸ“‹ ${vpName}: Stnr ${vpStnrSh.betrag}â‚¬`);
    }
    // === AUTO KORREKTUREN (Storno + Staffel + Stufen aus ALL1211) ===
    const vpKorr = staffelKorrekturen[vpId] || [];
    vpKorr.forEach(k => {
      const labels = {
        'storno_rueckforderung': `Storno-RÃ¼ckford. ${k.monat}`,
        'staffel_rueckforderung': `Staffel-RÃ¼ckford. ${k.monat}`,
        'staffel_nachzahlung': `Staffel-Nachzahlung ${k.monat}`,
        'stufen_rueckforderung': `Stufen-RÃ¼ckford. ${k.monat}`,
        'stufen_nachzahlung': `Stufen-Nachzahlung ${k.monat}`
      };
      positionen.push({
        typ: k.typ, auftrag_nr: null,
        kunde: k.desc,
        produkt: labels[k.typ] || k.typ,
        original_betrag: k.betrag, aktiv: true, zurueckgestellt: false,
        notiz: k.stornierte ? `Stornos: ${k.stornierte.join(', ')}` : k.desc
      });
      bruttoTotal += k.betrag;
    });
    const sgNetto=isHGB?Math.min(bruttoTotal*(sgConfig.prozent/100),sgConfig.max_netto):0;
    const sgUst=sgNetto*(sgConfig.ust_satz/100);
    const ustSatz=isHGB&&vp.mwst_pflichtig?19:0;
    const ustBetrag=bruttoTotal*(ustSatz/100);
    const sgBrutto=sgNetto+sgUst;
    const abr=await sbP('pay_abrechnungen',{periode,mitarbeiter_name:vpName,kuerzel:vp.kuerzel||gK(vpName),beschaeftigungsart:isHGB?'hgb':'angestellt',status:'entwurf',anzahl_sales:orders.length,brutto_provisionen:Math.round(bruttoTotal*100)/100,systemgebuehr_netto:Math.round(sgNetto*100)/100,systemgebuehr_ust:Math.round(sgUst*100)/100,nettobetrag:Math.round(bruttoTotal*100)/100,ust_satz:ustSatz,ust_betrag:Math.round(ustBetrag*100)/100,auszahlungssumme:Math.round((bruttoTotal+ustBetrag-sgBrutto)*100)/100});
    const abrId=Array.isArray(abr)?abr[0].id:abr.id;
    const posData=positionen.map(p=>{const {_teamDetail,_betragProSale,_leadDetails,_betragProLead,_terminDetails,_betragProTermin,...rest}=p;return{...rest,abrechnung_id:abrId};});
    for(let i=0;i<posData.length;i+=50){await sbP('pay_abrechnungen_positionen',posData.slice(i,i+50));}
    count++;
    }catch(e){log(`âŒ Fehler bei ${vp.vorname} ${vp.nachname}: ${e.message}`,'error');}
  }
  // â•â•â• SCOUTER ABRECHNUNGEN â•â•â•
  log('Berechne Scouter...');
  // Lead/Termin Einzeldaten aus Google Sheet laden
  const leadDetailByName={}, terminDetailByName={};
  try{
    const csvParse=(txt)=>{const rows=[];let row=[],cell='',inQ=false;for(let i=0;i<txt.length;i++){const c=txt[i];if(c==='"'){if(inQ&&txt[i+1]==='"'){cell+='"';i++;}else inQ=!inQ;}else if(c===','&&!inQ){row.push(cell);cell='';}else if(c==='\n'&&!inQ){row.push(cell);rows.push(row);row=[];cell='';}else cell+=c;}if(cell||row.length){row.push(cell);rows.push(row);}return rows;};
    const [leadCsv,terminCsv]=await Promise.all([
      fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Leads ${lzY}/${lzM}`).then(r=>r.text()).catch(()=>''),
      fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Termine ${lzY}/${lzM}`).then(r=>r.text()).catch(()=>'')
    ]);
    if(leadCsv){const rows=csvParse(leadCsv);rows.slice(1).forEach(r=>{const scout=(r[0]||'').trim();if(!scout)return;if(!leadDetailByName[scout])leadDetailByName[scout]=[];leadDetailByName[scout].push({kunde:`${(r[5]||'')} ${(r[6]||'')}`.trim(),strasse:`${(r[7]||'')} ${(r[8]||'')}`.trim(),plz:r[9]||'',ort:r[10]||'',datum:(r[3]||'').substring(0,10)});});log(`ðŸ“‹ Lead-Details: ${Object.values(leadDetailByName).reduce((s,a)=>s+a.length,0)} Leads fÃ¼r ${Object.keys(leadDetailByName).length} Scouter`);}
    if(terminCsv){const rows=csvParse(terminCsv);rows.slice(1).forEach(r=>{const scout=(r[4]||'').trim();const status=(r[15]||'').trim();if(!scout||scout==='-')return;if(!status.includes('SCOUT'))return;if(!terminDetailByName[scout])terminDetailByName[scout]=[];terminDetailByName[scout].push({kunde:(r[6]||'').trim(),adresse:(r[7]||'').trim(),datum:(r[13]||'').trim(),status});});log(`ðŸ“… Termin-Details: ${Object.values(terminDetailByName).reduce((s,a)=>s+a.length,0)} Termine fÃ¼r ${Object.keys(terminDetailByName).length} Scouter`);}
  }catch(e){log(`âš ï¸ Lead/Termin-Details konnten nicht geladen werden: ${e.message}`);}
  const allScoutIds = new Set([...Object.keys(byScout), ...Object.keys(stornoByScout), ...Object.keys(offenByScout), ...Object.keys(leadByScout), ...Object.keys(terminByScout), ...Object.keys(szByVP)]);
  for(const scId of allScoutIds){
    const sc = vpById[scId]; if(!sc) continue;
    if(skipVPIds.has(scId)){ log(`â¸ï¸ ${sc.vorname} ${sc.nachname} Ã¼bersprungen (skip_abrechnung)`); continue; }
    if(!sc.typ.includes('scouter')) continue; // safety
    try{
    const orders = byScout[scId] || [];
    const scStornos = stornoByScout[scId] || [];
    const scOffen = offenByScout[scId] || [];
    if(!orders.length && !scStornos.length && !scOffen.length && !(leadByScout[scId]>0 && !(sc.typ||'').includes('hgb')) && !(terminByScout[scId]>0) && !(szByVP[scId]||[]).length) continue;
    const ruleTyp = typMap[sc.typ] || sc.typ;
    const regel = regelMap[ruleTyp];
    if(!regel){ log(`âš ï¸ Scout ${sc.vorname} ${sc.nachname}: keine Regel fÃ¼r ${ruleTyp}`); continue; }
    const isHGB = (sc.typ||'').includes('hgb');
    const scName = `${sc.vorname} ${sc.nachname}`;
    log(`Berechne Scout ${scName}...`);
    const ordersLZ = orders.filter(o => !o._nachzuegler);
    const ordersNZ = orders.filter(o => o._nachzuegler);
    const positionen = []; let bruttoTotal = 0;
    const processScoutOrders = (monthOrders, om, isNZ) => {
      const monthKey=scId+'_'+om; const monthTotal=salesPerScoutMonth[monthKey]||monthOrders.length;
      const staffel=monthTotal>=regel.staffel_schwelle;
      const baseBetrag = staffel ? regel.staffel_betrag_sale : regel.basis_betrag_sale;
      const nzTag = isNZ ? ' â˜…NZ' : '';
      const staffelTag = staffel ? ' (Staffel)' : '';
      for(const o of monthOrders){
        positionen.push({typ:'provision',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`Scout â€“ Solar ${o.kwp||0} kWp`,original_betrag:baseBetrag,aktiv:true,zurueckgestellt:false,notiz:`${om}${staffelTag}${nzTag}`});
        bruttoTotal+=baseBetrag;
        const q=(o.lead_quelle||'').toLowerCase();
        if(q.includes('eigenlead')&&regel.betrag_eigenlead>0){positionen.push({typ:'eigenlead',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Eigenlead-Bonus',original_betrag:regel.betrag_eigenlead,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=regel.betrag_eigenlead;}
        if(q.includes('empfehlung')&&regel.betrag_empfehlung>0){positionen.push({typ:'empfehlung',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Empfehlungs-Bonus',original_betrag:regel.betrag_empfehlung,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=regel.betrag_empfehlung;}
        if(o.speichererweiterung&&regel.betrag_speicher>0){const sxM=(o.notiz||'').match(/speicher_x(\d+)/);const sxAnz=sxM?parseInt(sxM[1]):1;const spBetrag=regel.betrag_speicher*sxAnz;positionen.push({typ:'speicher',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`Speicher-Bonus${sxAnz>1?' ('+sxAnz+'Ã—)':''}`,original_betrag:spBetrag,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=spBetrag;}
        // Zero-Bonus: EFS preismodell=Zero â†’ pro Auftrag
        if(o.efs_projekt_id&&zeroEFSIds.has(o.efs_projekt_id)&&regel.betrag_zero>0){positionen.push({typ:'zero_bonus',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Zero-Bonus',original_betrag:regel.betrag_zero,aktiv:true,zurueckgestellt:false,notiz:`${om}${nzTag}`}); bruttoTotal+=regel.betrag_zero;}
      }
    };
    const scByMonthLZ = {};
    ordersLZ.forEach(o => { const d=o.auftrags_datum||''; const om=d.substring(0,4)+'/'+d.substring(5,7); if(!scByMonthLZ[om])scByMonthLZ[om]=[]; scByMonthLZ[om].push(o); });
    for(const [om, mo] of Object.entries(scByMonthLZ)) processScoutOrders(mo, om, false);
    if(ordersNZ.length > 0){
      const scByMonthNZ = {};
      ordersNZ.forEach(o => { const d=o.auftrags_datum||''; const om=d.substring(0,4)+'/'+d.substring(5,7); if(!scByMonthNZ[om])scByMonthNZ[om]=[]; scByMonthNZ[om].push(o); });
      for(const [om, mo] of Object.entries(scByMonthNZ)) processScoutOrders(mo, om, true);
    }
    // Storno-Info
    scStornos.forEach(s => { positionen.push({typ:'storno_info',auftrag_nr:s.auftrag_nr,kunde:s.kunde_name,produkt:`Storno â€“ Solar ${s.kwp||0} kWp`,original_betrag:0,aktiv:true,zurueckgestellt:false,notiz:(s.auftrags_datum||'').substring(0,7)}); });
    // Offen-Info
    scOffen.forEach(o => { positionen.push({typ:'offen_info',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`Offen â€“ Solar ${o.kwp||0} kWp`,original_betrag:0,aktiv:true,zurueckgestellt:false,notiz:(o.auftrags_datum||'').substring(0,7)}); });
    // On Hold Info (Scout)
    const scOnHold = onHoldBySC[scId] || [];
    scOnHold.forEach(o => { positionen.push({typ:'on_hold_info',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`On Hold â€“ Solar ${o.kwp||0} kWp`,original_betrag:0,aktiv:true,zurueckgestellt:false,notiz:(o.auftrags_datum||'').substring(0,7)}); });
    // Lead-Bonus fÃ¼r Angestellt-Scouter
    if(!isHGB && regel.betrag_lead > 0){
      const leadCount = leadByScout[scId] || 0;
      if(leadCount > 0){
        const leadBetrag = leadCount * regel.betrag_lead;
        const leadDetails = leadDetailByName[scName] || [];
        positionen.push({typ:'lead_bonus',auftrag_nr:`LEADS-${lzY}-${lzM}`,kunde:`${leadCount} Leads`,produkt:`Lead-Bonus (${leadCount}Ã— ${regel.betrag_lead}â‚¬)`,original_betrag:leadBetrag,aktiv:true,zurueckgestellt:false,notiz:JSON.stringify({ld:leadDetails,bpl:regel.betrag_lead,per:`${lzY}/${lzM}`}),_leadDetails:leadDetails,_betragProLead:regel.betrag_lead});
        bruttoTotal += leadBetrag;
        log(`  ðŸ“‹ ${scName}: ${leadCount} Leads Ã— ${regel.betrag_lead}â‚¬ = ${leadBetrag}â‚¬ (${leadDetails.length} Details)`);
      }
    }
    // Termin-Bonus (betrag_termin_sf)
    if(regel.betrag_termin_sf > 0){
      const terminCount = terminByScout[scId] || 0;
      if(terminCount > 0){
        const terminBetrag = terminCount * regel.betrag_termin_sf;
        const terminDetails = terminDetailByName[scName] || [];
        positionen.push({typ:'termin_bonus',auftrag_nr:`TERMINE-${lzY}-${lzM}`,kunde:`${terminCount} Termine`,produkt:`Termin-Bonus (${terminCount}Ã— ${regel.betrag_termin_sf}â‚¬)`,original_betrag:terminBetrag,aktiv:true,zurueckgestellt:false,notiz:JSON.stringify({td:terminDetails,bpt:regel.betrag_termin_sf,per:`${lzY}/${lzM}`}),_terminDetails:terminDetails,_betragProTermin:regel.betrag_termin_sf});
        bruttoTotal += terminBetrag;
        log(`  ðŸ“… ${scName}: ${terminCount} Termine Ã— ${regel.betrag_termin_sf}â‚¬ = ${terminBetrag}â‚¬ (${terminDetails.length} Details)`);
      }
    }
    // Sonderzulagen aus Sheet (Zugaben/AbzÃ¼ge) â€“ auch fÃ¼r Scouter
    const scSZ = szByVP[scId] || [];
    scSZ.forEach(sz => {
      const parts = (sz.notiz||'').split('|');
      const vorzeichen = parts[0]?.startsWith('-') ? -1 : 1;
      const betrag = parseFloat(parts[0]?.replace(/[^0-9.]/g,'')) || 0;
      const beschreibung = parts[1] || sz.kunde_name || 'Sonderzulage';
      const realBetrag = vorzeichen * betrag;
      const typ = realBetrag >= 0 ? 'sondereinsatz' : 'abzug';
      positionen.push({typ,auftrag_nr:sz.auftrag_nr,kunde:sz.kunde_name,produkt:beschreibung,original_betrag:realBetrag,aktiv:true,zurueckgestellt:false,notiz:'Sonderzulage 2026/01'});
      bruttoTotal += realBetrag;
    });
    // Fahrzeugzuschuss (monatlich, aus pay_mitarbeiter.auto_zuschuss)
    if(sc.auto_zuschuss && +sc.auto_zuschuss > 0){
      positionen.push({typ:'sondereinsatz',auftrag_nr:null,kunde:null,produkt:'Fahrzeugzuschuss',original_betrag:+sc.auto_zuschuss,aktiv:true,zurueckgestellt:false,notiz:'monatlich'});
      bruttoTotal += +sc.auto_zuschuss;
    }
    const sgNetto=isHGB?Math.min(bruttoTotal*(sgConfig.prozent/100),sgConfig.max_netto):0;
    const sgUst=sgNetto*(sgConfig.ust_satz/100);
    const ustSatz=isHGB&&sc.mwst_pflichtig?19:0;
    const ustBetrag=bruttoTotal*(ustSatz/100);
    const sgBrutto=sgNetto+sgUst;
    const abr=await sbP('pay_abrechnungen',{periode,mitarbeiter_name:scName,kuerzel:sc.kuerzel||gK(scName),beschaeftigungsart:isHGB?'hgb_scouter':'angestellt_scouter',status:'entwurf',anzahl_sales:orders.length,brutto_provisionen:Math.round(bruttoTotal*100)/100,systemgebuehr_netto:Math.round(sgNetto*100)/100,systemgebuehr_ust:Math.round(sgUst*100)/100,nettobetrag:Math.round(bruttoTotal*100)/100,ust_satz:ustSatz,ust_betrag:Math.round(ustBetrag*100)/100,auszahlungssumme:Math.round((bruttoTotal+ustBetrag-sgBrutto)*100)/100});
    const abrId=Array.isArray(abr)?abr[0].id:abr.id;
    const posData=positionen.map(p=>{const {_leadDetails,_betragProLead,_terminDetails,_betragProTermin,...rest}=p;return{...rest,abrechnung_id:abrId};});
    for(let i=0;i<posData.length;i+=50){await sbP('pay_abrechnungen_positionen',posData.slice(i,i+50));}
    count++;
    }catch(e){log(`âŒ Fehler bei Scout ${sc.vorname} ${sc.nachname}: ${e.message}`,'error');}
  }
  log(`âœ… ${count} Abrechnungen generiert!`);
  // Sonderzulagen als abgerechnet markieren, damit sie nicht doppelt kommen
  if(sonderzulagen.length){
    const szIds = sonderzulagen.map(s=>s.id).filter(Boolean);
    for(let i=0;i<szIds.length;i+=20){
      const batch=szIds.slice(i,i+20);
      await sbU('pay_auftraege',`id=in.(${batch.join(',')})`,{abgerechnet_monat:parseInt(m),abgerechnet_jahr:parseInt(y)});
    }
    log(`ðŸ“ ${szIds.length} Sonderzulagen als abgerechnet markiert`);
  }
  return count;
}

function calc(pos,sg,hgb){
  const ak=pos.filter(p=>p.aktiv&&!p.zurueckgestellt);
  const prov=ak.filter(p=>['provision','eigenlead','empfehlung','speicher','sondereinsatz','lead_bonus','termin_bonus','zero_bonus'].includes(p.typ));
  const extra=ak.filter(p=>['einmalzahlung','abzug','sonstiges','team_bonus','staffel_nachzahlung','staffel_rueckforderung','stufen_nachzahlung','stufen_rueckforderung','storno_rueckforderung','vorschuss_rechnung','stnr_auszahlung'].includes(p.typ));
  const bp=prov.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const es=extra.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  let sgN=0,sgU=0;if(hgb&&sg){sgN=Math.min((bp+es)*(sg.prozent/100),sg.max_netto);sgU=sgN*(sg.ust_satz/100);}
  const net=bp+es;const uS=hgb?19:0;const uB=net*(uS/100);const sgB=sgN+sgU;
  return{sales:prov.filter(p=>p.typ==='provision').length,bp,sgN:Math.round(sgN*100)/100,sgU:Math.round(sgU*100)/100,es,net:Math.round(net*100)/100,uS,uB:Math.round(uB*100)/100,aus:Math.round((net+uB-sgB)*100)/100,sgB:Math.round(sgB*100)/100};
}

let tt=null;
function Toast({children}){const[t,setT]=useState(null);window.__t=(m,ty='success')=>{clearTimeout(tt);setT({m,ty});tt=setTimeout(()=>setT(null),3000);};return<>{children}{t&&<div className={`toast ${t.ty}`}>{t.m}</div>}</>;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BEREINIGUNG PANEL â€“ Gesperrte, Duplikate, Storno-AbzÃ¼ge lÃ¶sen
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function BereinigungBanner({onClick}){
  const[data,setData]=useState(null);
  const load=useCallback(async()=>{
    try{
      const[sp,dp]=await Promise.all([
        sbG('pay_sperrlisten','select=id,status'),
        sbG('pay_duplikate','select=id,status')
      ]);
      const gesperrt=sp.filter(s=>s.status==='gesperrt').length;
      const stornos=sp.filter(s=>s.status==='ausgezahlt').length;
      const dupOffen=dp.filter(d=>d.status==='entscheidung_noetig').length;
      const dupGeloest=dp.filter(d=>d.status!=='entscheidung_noetig').length;
      const autoApplied=sp.filter(s=>s.status==='freigegeben').length+dupGeloest;
      setData({gesperrt,stornos,dupOffen,autoApplied,total:gesperrt+stornos+dupOffen});
    }catch(e){console.error('BerBanner',e);}
  },[]);
  useEffect(()=>{load();window.__berRefresh=load;},[load]);
  if(!data||data.total===0&&data.autoApplied===0)return null;
  
  return <div>
    {data.total>0&&<div className="ber-banner ber-banner-warn" onClick={onClick}>
      <span style={{fontSize:14}}>âš ï¸</span>
      <span style={{fontSize:12,fontWeight:600,color:'#fbbf24'}}>Datenbereinigung nÃ¶tig:</span>
      {data.gesperrt>0&&<span className="ber-pill ber-pill-warn">ðŸ”’ {data.gesperrt} Gesperrte</span>}
      {data.dupOffen>0&&<span className="ber-pill ber-pill-warn">âš ï¸ {data.dupOffen} Duplikate</span>}
      {data.stornos>0&&<span className="ber-pill ber-pill-danger">ðŸ’° {data.stornos} Storno-AbzÃ¼ge</span>}
      <span style={{marginLeft:'auto',fontSize:11,color:'#78350f'}}>Klicken zum LÃ¶sen â†’</span>
    </div>}
    {data.autoApplied>0&&<div className="ber-banner ber-banner-info" onClick={onClick}>
      <span style={{fontSize:14}}>â„¹ï¸</span>
      <span className="ber-pill ber-pill-ok">âœ… {data.autoApplied} frÃ¼here Entscheidungen automatisch angewendet</span>
      <span style={{fontSize:11,color:'#8b949e'}}>Klicken fÃ¼r Details</span>
    </div>}
  </div>;
}

function BereinigungPanel({onClose}){
  const[tab,setTab]=useState('gesperrt');
  const[sperr,setSperr]=useState([]);
  const[dup,setDup]=useState([]);
  const[ld,setLd]=useState(true);
  const[busy,setBusy]=useState(null);

  const load=useCallback(async()=>{
    setLd(true);
    try{
      const[sp,dp]=await Promise.all([
        sbG('pay_sperrlisten','order=status.asc,erstellt_am.desc'),
        sbG('pay_duplikate','order=status.asc,erstellt_am.desc'),
      ]);
      // Auto-enrich: fehlende Kundennamen aus pay_auftraege nachschlagen
      const missing=sp.filter(s=>!s.kunde_name||s.kunde_name.includes('Abbruch')||s.kunde_name.includes('nicht gefunden'));
      if(missing.length>0){
        const ans=missing.map(s=>'AN-'+s.auftrag_nr);
        const auftr=await sbG('pay_auftraege',`auftrag_nr=in.(${ans.join(',')})&select=auftrag_nr,kunde_name,vertriebler_id`).catch(()=>[]);
        const mitarb=await sbG('pay_mitarbeiter','aktiv=eq.true&select=id,vorname,nachname').catch(()=>[]);
        const vtMap=Object.fromEntries(mitarb.map(m=>[m.id,`${m.vorname} ${m.nachname}`]));
        for(const s of missing){
          const a=auftr.find(x=>x.auftrag_nr==='AN-'+s.auftrag_nr);
          if(a){
            const patch={kunde_name:a.kunde_name,vertriebler:vtMap[a.vertriebler_id]||s.vertriebler||''};
            s.kunde_name=patch.kunde_name;s.vertriebler=patch.vertriebler;
            sbU('pay_sperrlisten',`id=eq.${s.id}`,patch).catch(()=>{});
          }
        }
      }
      setSperr(sp);
      // Enrich duplikate with beedoo_fortschritt
      if(dp.length>0){
        const allANs=[...new Set(dp.flatMap(d=>['AN-'+d.auftrag_nr_1,'AN-'+d.auftrag_nr_2]))];
        const aufFort=await sbG('pay_auftraege',`auftrag_nr=in.(${allANs.join(',')})&select=auftrag_nr,beedoo_fortschritt,auftrags_datum,kwp`).catch(()=>[]);
        const fortMap=Object.fromEntries(aufFort.map(a=>[a.auftrag_nr,a]));
        dp.forEach(d=>{d._fort1=fortMap['AN-'+d.auftrag_nr_1];d._fort2=fortMap['AN-'+d.auftrag_nr_2];});
      }
      setDup(dp);
    }catch(e){window.__t?.('Fehler: '+e.message,'error');}
    setLd(false);
  },[]);
  useEffect(()=>{load();},[load]);

  const gesperrte=sperr.filter(s=>s.status==='gesperrt');
  const stornos=sperr.filter(s=>s.status==='ausgezahlt');
  const freigegebene=sperr.filter(s=>s.status==='freigegeben');
  const dupOffen=dup.filter(d=>d.status==='entscheidung_noetig');
  const dupGeloest=dup.filter(d=>d.status!=='entscheidung_noetig');

  const doSperrAction=async(id,newStatus,label)=>{
    if(!confirm(`${label}?`))return;
    setBusy(id);
    try{
      await sbU('pay_sperrlisten',`id=eq.${id}`,{status:newStatus,geaendert_am:new Date().toISOString()});
      window.__t?.(`âœ… ${label}`);
      await load();window.__berRefresh?.();
    }catch(e){window.__t?.('Fehler: '+e.message,'error');}
    setBusy(null);
  };

  const doDupAction=async(id,aktion,label)=>{
    if(!confirm(`${label}?`))return;
    setBusy(id);
    try{
      const newStatus=aktion==='kein_duplikat'?'kein_duplikat':'geloest';
      await sbU('pay_duplikate',`id=eq.${id}`,{status:newStatus,aktion,geaendert_am:new Date().toISOString()});
      // If 'behalten_1' â†’ sperr auftrag_nr_2, if 'behalten_2' â†’ sperr auftrag_nr_1
      if(aktion==='behalten_1'||aktion==='behalten_2'){
        const d=dup.find(x=>x.id===id);
        if(d){
          const sperrAN=aktion==='behalten_1'?d.auftrag_nr_2:d.auftrag_nr_1;
          try{await sbP('pay_sperrlisten',{auftrag_nr:sperrAN,kunde_name:d.kunde_name,vertriebler:d.vertriebler,typ:'duplikat',status:'gesperrt',notiz:`Duplikat von AN ${aktion==='behalten_1'?d.auftrag_nr_1:d.auftrag_nr_2}`});}catch(e){console.warn('Sperr-Duplikat',e);}
        }
      }
      window.__t?.(`âœ… ${label}`);
      await load();window.__berRefresh?.();
    }catch(e){window.__t?.('Fehler: '+e.message,'error');}
    setBusy(null);
  };

  const doStornoAction=async(id,aktion,label)=>{
    if(!confirm(`${label}?`))return;
    setBusy(id);
    try{
      const newStatus=aktion==='abzug_bestaetigt'?'abzug_bestaetigt':'kein_abzug';
      await sbU('pay_sperrlisten',`id=eq.${id}`,{status:newStatus,geaendert_am:new Date().toISOString()});
      window.__t?.(`âœ… ${label}`);
      await load();window.__berRefresh?.();
    }catch(e){window.__t?.('Fehler: '+e.message,'error');}
    setBusy(null);
  };

  const typLabel={'grundbuch':'ðŸ“‹ Grundbuch','montage_abbruch':'ðŸ”§ Montage-Abbruch','crm_storno':'âŒ CRM-Storno','duplikat':'ðŸ”„ Duplikat'};

  return <div className="ber-overlay" onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
    <div className="ber-modal">
      <div className="ber-modal-header">
        <div><div style={{fontSize:16,fontWeight:800,color:'#e6edf3'}}>ðŸ”§ Datenbereinigung</div>
        <div style={{fontSize:11,color:'#8b949e',marginTop:2}}>Entscheidungen werden gespeichert und beim nÃ¤chsten Import automatisch angewendet</div></div>
        <button onClick={onClose} className="btn btn-secondary btn-sm">âœ• SchlieÃŸen</button>
      </div>

      <div className="ber-tabs">
        <div className={`ber-tab ${tab==='gesperrt'?'active':''}`} onClick={()=>setTab('gesperrt')}>
          ðŸ”’ Gesperrte<span className="ber-count">{gesperrte.length}</span>
        </div>
        <div className={`ber-tab ${tab==='duplikate'?'active':''}`} onClick={()=>setTab('duplikate')}>
          âš ï¸ Duplikate<span className="ber-count">{dupOffen.length}</span>
        </div>
        <div className={`ber-tab ${tab==='stornos'?'active':''}`} onClick={()=>setTab('stornos')}>
          ðŸ’° Storno-AbzÃ¼ge<span className="ber-count">{stornos.length}</span>
        </div>
        <div className={`ber-tab ${tab==='geloest'?'active':''}`} onClick={()=>setTab('geloest')}>
          âœ… GelÃ¶st<span className="ber-count">{freigegebene.length+dupGeloest.length}</span>
        </div>
      </div>

      <div className="ber-body">
        {ld?<div className="loading"><div className="spinner"/>Lade...</div>:<>

        {/* === GESPERRTE === */}
        {tab==='gesperrt'&&<>
          {gesperrte.length===0?<div style={{textAlign:'center',padding:40,color:'#484f58'}}>
            <div style={{fontSize:32,marginBottom:8}}>âœ…</div>Keine gesperrten AuftrÃ¤ge
          </div>:gesperrte.map(s=><div key={s.id} className="ber-item">
            <div className="ber-item-header">
              <div>
                <div className="ber-item-title">AN {s.auftrag_nr} Â· {s.kunde_name}</div>
                <div className="ber-item-sub">VT: {s.vertriebler} Â· {typLabel[s.typ]||s.typ}</div>
              </div>
              <span className="ber-item-badge" style={{background:'#78350f30',color:'#fbbf24'}}>Gesperrt</span>
            </div>
            {s.notiz&&<div style={{fontSize:11,color:'#8b949e',padding:'6px 8px',background:'#21262d',borderRadius:6,marginBottom:8}}>{s.notiz}</div>}
            <div className="ber-item-actions">
              <button className="ber-action ber-action-keep" disabled={busy===s.id} 
                onClick={()=>doSperrAction(s.id,'gesperrt_bestaetigt','Dauerhaft gesperrt')}>
                ðŸ”’ Dauerhaft sperren
              </button>
              <button className="ber-action ber-action-release" disabled={busy===s.id}
                onClick={()=>doSperrAction(s.id,'freigegeben','Freigegeben fÃ¼r Abrechnung')}>
                ðŸ”“ Freigeben
              </button>
            </div>
          </div>)}
        </>}

        {/* === DUPLIKATE === */}
        {tab==='duplikate'&&<>
          {dupOffen.length===0?<div style={{textAlign:'center',padding:40,color:'#484f58'}}>
            <div style={{fontSize:32,marginBottom:8}}>âœ…</div>Keine offenen Duplikate
          </div>:dupOffen.map(d=><div key={d.id} className="ber-item">
            <div className="ber-item-header">
              <div>
                <div className="ber-item-title">{d.kunde_name}</div>
                <div className="ber-item-sub">PLZ {d.plz} Â· {d.kwp} kWp Â· VT: {d.vertriebler}</div>
              </div>
              <span className="ber-item-badge" style={{background:'#78350f30',color:'#fbbf24'}}>Entscheidung nÃ¶tig</span>
            </div>
            <div style={{display:'flex',gap:12,marginBottom:10,flexWrap:'wrap'}}>
              <div style={{flex:1,minWidth:150,padding:'8px 12px',background:'#21262d',borderRadius:8,border:'1px solid #30363d'}}>
                <div style={{fontSize:10,color:'#8b949e',marginBottom:2}}>Auftrag 1{d._fort1?.auftrags_datum?` Â· ${d._fort1.auftrags_datum.substring(0,10)}`:''}{d._fort1?.kwp?` Â· ${d._fort1.kwp} kWp`:''}</div>
                <div style={{fontSize:13,fontWeight:700,color:'#e6edf3'}}>AN {d.auftrag_nr_1}</div>
                {d._fort1?.beedoo_fortschritt&&<div style={{fontSize:10,marginTop:4,padding:'2px 8px',background:'#1c2333',borderRadius:4,color:'#7dd3fc',display:'inline-block'}}>{d._fort1.beedoo_fortschritt}</div>}
              </div>
              <div style={{flex:1,minWidth:150,padding:'8px 12px',background:'#21262d',borderRadius:8,border:'1px solid #30363d'}}>
                <div style={{fontSize:10,color:'#8b949e',marginBottom:2}}>Auftrag 2{d._fort2?.auftrags_datum?` Â· ${d._fort2.auftrags_datum.substring(0,10)}`:''}{d._fort2?.kwp?` Â· ${d._fort2.kwp} kWp`:''}</div>
                <div style={{fontSize:13,fontWeight:700,color:'#e6edf3'}}>AN {d.auftrag_nr_2}</div>
                {d._fort2?.beedoo_fortschritt&&<div style={{fontSize:10,marginTop:4,padding:'2px 8px',background:'#1c2333',borderRadius:4,color:'#7dd3fc',display:'inline-block'}}>{d._fort2.beedoo_fortschritt}</div>}
              </div>
            </div>
            <div className="ber-item-actions">
              <button className="ber-action ber-action-keep" disabled={busy===d.id}
                onClick={()=>doDupAction(d.id,'behalten_1',`AN ${d.auftrag_nr_1} behalten, AN ${d.auftrag_nr_2} sperren`)}>
                âœ“ AN {d.auftrag_nr_1} behalten
              </button>
              <button className="ber-action ber-action-release" disabled={busy===d.id}
                onClick={()=>doDupAction(d.id,'behalten_2',`AN ${d.auftrag_nr_2} behalten, AN ${d.auftrag_nr_1} sperren`)}>
                âœ“ AN {d.auftrag_nr_2} behalten
              </button>
              <button className="ber-action ber-action-neutral" disabled={busy===d.id}
                onClick={()=>doDupAction(d.id,'kein_duplikat','Kein Duplikat â€“ beide behalten')}>
                â‰  Kein Duplikat
              </button>
            </div>
          </div>)}
        </>}

        {/* === STORNO-ABZÃœGE === */}
        {tab==='stornos'&&<>
          {stornos.length===0?<div style={{textAlign:'center',padding:40,color:'#484f58'}}>
            <div style={{fontSize:32,marginBottom:8}}>âœ…</div>Keine offenen Storno-AbzÃ¼ge
          </div>:stornos.map(s=><div key={s.id} className="ber-item">
            <div className="ber-item-header">
              <div>
                <div className="ber-item-title">AN {s.auftrag_nr} Â· {s.kunde_name}</div>
                <div className="ber-item-sub">VT: {s.vertriebler} Â· {typLabel[s.typ]||s.typ} Â· Bereits ausgezahlt</div>
              </div>
              <span className="ber-item-badge" style={{background:'#3d050830',color:'#f85149'}}>Abzug nÃ¶tig</span>
            </div>
            {s.betrag>0&&<div style={{fontSize:12,color:'#f85149',fontWeight:700,marginBottom:8}}>
              Ausgezahlter Betrag: {fmtE(s.betrag)}
            </div>}
            {s.ausgezahlt_am&&<div style={{fontSize:11,color:'#8b949e',marginBottom:8}}>
              Ausgezahlt am: {new Date(s.ausgezahlt_am).toLocaleDateString('de-DE')}
            </div>}
            <div className="ber-item-actions">
              <button className="ber-action ber-action-danger" disabled={busy===s.id}
                onClick={()=>doStornoAction(s.id,'abzug_bestaetigt','Storno-Abzug auf nÃ¤chster Abrechnung')}>
                ðŸ’° Abzug bestÃ¤tigen
              </button>
              <button className="ber-action ber-action-neutral" disabled={busy===s.id}
                onClick={()=>doStornoAction(s.id,'kein_abzug','Kein Abzug â€“ Storno ignorieren')}>
                âœ• Kein Abzug
              </button>
            </div>
          </div>)}
        </>}

        {/* === GELÃ–ST === */}
        {tab==='geloest'&&<>
          {freigegebene.length===0&&dupGeloest.length===0?<div style={{textAlign:'center',padding:40,color:'#484f58'}}>
            <div style={{fontSize:32,marginBottom:8}}>ðŸ“­</div>Noch keine gelÃ¶sten EintrÃ¤ge
          </div>:<>
            {freigegebene.map(s=><div key={s.id} className="ber-item ber-resolved">
              <div className="ber-item-header">
                <div>
                  <div className="ber-item-title">AN {s.auftrag_nr} Â· {s.kunde_name}</div>
                  <div className="ber-item-sub">VT: {s.vertriebler} Â· {typLabel[s.typ]||s.typ}</div>
                </div>
                <span className="ber-resolved-badge">âœ… Freigegeben</span>
              </div>
            </div>)}
            {sperr.filter(s=>s.status==='gesperrt_bestaetigt').map(s=><div key={s.id} className="ber-item ber-resolved">
              <div className="ber-item-header">
                <div>
                  <div className="ber-item-title">AN {s.auftrag_nr} Â· {s.kunde_name}</div>
                  <div className="ber-item-sub">VT: {s.vertriebler} Â· {typLabel[s.typ]||s.typ}</div>
                </div>
                <span className="ber-resolved-badge" style={{background:'#78350f20',color:'#fbbf24'}}>ðŸ”’ BestÃ¤tigt gesperrt</span>
              </div>
            </div>)}
            {sperr.filter(s=>s.status==='abzug_bestaetigt'||s.status==='kein_abzug').map(s=><div key={s.id} className="ber-item ber-resolved">
              <div className="ber-item-header">
                <div>
                  <div className="ber-item-title">AN {s.auftrag_nr} Â· {s.kunde_name}</div>
                  <div className="ber-item-sub">VT: {s.vertriebler} Â· Storno-Abzug</div>
                </div>
                <span className="ber-resolved-badge">{s.status==='abzug_bestaetigt'?'ðŸ’° Abzug bestÃ¤tigt':'âœ• Kein Abzug'}</span>
              </div>
            </div>)}
            {dupGeloest.map(d=><div key={d.id} className="ber-item ber-resolved">
              <div className="ber-item-header">
                <div>
                  <div className="ber-item-title">{d.kunde_name} Â· AN {d.auftrag_nr_1} / {d.auftrag_nr_2}</div>
                  <div className="ber-item-sub">VT: {d.vertriebler} Â· {d.aktion==='kein_duplikat'?'Kein Duplikat':d.aktion==='behalten_1'?`Behalten: AN ${d.auftrag_nr_1}`:`Behalten: AN ${d.auftrag_nr_2}`}</div>
                </div>
                <span className="ber-resolved-badge">{d.aktion==='kein_duplikat'?'â‰  Kein Duplikat':'âœ… GelÃ¶st'}</span>
              </div>
            </div>)}
          </>}
        </>}

        </>}
      </div>
    </div>
  </div>;
}

function GutschriftPreview({ab,pos,sg}){
  const b=calc(pos,sg,(ab.beschaeftigungsart||'').includes('hgb'));
  const aP=pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&['provision','eigenlead','empfehlung','speicher','lead_bonus','termin_bonus','zero_bonus'].includes(p.typ));
  const aE=pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&['einmalzahlung','abzug','sonstiges','sondereinsatz','vorschuss_rechnung','stnr_auszahlung'].includes(p.typ));
  const aTB=pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&p.typ==='team_bonus');
  const provSum=aP.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const sondereinsatzSum=aE.filter(p=>['sondereinsatz','stnr_auszahlung'].includes(p.typ)).reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const aSt=pos.filter(p=>p.typ==='storno_info');
  const aOf=pos.filter(p=>p.typ==='offen_info');
  const aOH=pos.filter(p=>p.typ==='on_hold_info');
  const aSKN=pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&['staffel_nachzahlung','stufen_nachzahlung'].includes(p.typ));
  const aSKR=pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&['staffel_rueckforderung','stufen_rueckforderung','storno_rueckforderung'].includes(p.typ));
  const aSK=[...aSKN,...aSKR];
  const skTotal=aSK.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const aStLZ=aSt;
  const aStVM=[];
  const aOfLZ=aOf;
  const aOfVM=[];
  const isNZPos = p => (p.notiz||'').includes('â˜…NZ');
  const aPLZ = aP.filter(p => !isNZPos(p) && p.typ!=='lead_bonus' && p.typ!=='termin_bonus');
  const aPNZ = aP.filter(p => isNZPos(p) && p.typ!=='lead_bonus' && p.typ!=='termin_bonus');
  const aLeadBonus = aP.filter(p => p.typ==='lead_bonus');
  const leadBonusTotal = aLeadBonus.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const aTerminBonus = aP.filter(p => p.typ==='termin_bonus');
  const terminBonusTotal = aTerminBonus.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const aZeroBonus = aP.filter(p => p.typ==='zero_bonus');
  const zeroBonusTotal = aZeroBonus.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const k=ab.kuerzel||gK(ab.mitarbeiter_name),bn=gBN(ab.periode,k,1),hgb=(ab.beschaeftigungsart||'').includes('hgb');
  const heute=new Date().toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'});
  const isE=ab.status==='entwurf'||ab.status==='probeabrechnung';
  const isF=ab.status==='freigegeben'||ab.status==='ausgezahlt';
  // Leistungszeitraum = Vormonat der Periode
  const lzPer = (()=>{if(!ab.periode)return'â€”';const[py,pm]=ab.periode.split('/');const d=new Date(parseInt(py),parseInt(pm)-2,1);return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}`;})();
  const lzLabel = pLabel(lzPer);
  const salesLZ=aPLZ.filter(p=>p.typ==='provision').length;
  const staffel=8,pct=Math.min((salesLZ/staffel)*100,100),hatS=salesLZ>=staffel;
  const verifyData=JSON.stringify({typ:'gutschrift',nr:bn,vt:ab.mitarbeiter_name,brutto:b.aus,netto:b.net,ust:b.uB,datum:heute,per:ab.periode});
  const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=54x54&data=${encodeURIComponent(`https://bee-doo-tools.vercel.app/verify.html?d=${btoa(verifyData)}`)}&bgcolor=ffffff&color=1a1a2e&margin=1`;
  const giroIBAN='DE90254501100031039985';
  const giroBIC='NOLADE21SWB';
  const giroSgBrutto=(b.sgN+b.sgU).toFixed(2);
  const giroRef=`SG ${bn}`;
  const giroPayload=`BCD\n002\n1\nSCT\n${giroBIC}\nbee-doo GmbH\n${giroIBAN}\nEUR${giroSgBrutto}\n\n${giroRef}\nSystemgebuehr ${ab.periode} ${ab.mitarbeiter_name}`;
  const giroQrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(giroPayload)}&bgcolor=ffffff&color=1a1a2e&margin=1`;

  const FooterBlock = () => <div className="gs-footer">
    <div className="gs-footer-col"><b>Firmensitz</b>bee-doo GmbH<br/>Am Stadtholz 39<br/>D-33609 Bielefeld</div>
    <div className="gs-footer-col"><b>Kontakt</b>www.bee-doo.de<br/>info@bee-doo.de<br/>Fon: 0800 22 33 664</div>
    <div className="gs-footer-col"><b>Bankverbindung</b>IBAN DE90 2545 0110 0031 0399 85<br/>BIC NOLADE21SWB<br/>Sparkasse Bielefeld</div>
    <div className="gs-footer-col"><b>Handelsregister</b>HRB 46243 AG Bielefeld<br/>GF: Patrick Grabowski, Olaf Schader<br/>StNr: 44/214/0394 Â· USt-Id: DE323940446</div>
  </div>;

  return <div style={{display:'flex',flexDirection:'column',gap:20}}>
    {/* === SEITE 1 === */}
    <div className="gs-page">
      {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
      <div className="gs-branded-header">
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
          <div>
            <div style={{fontFamily:"'Arial Black',Arial",fontSize:28,fontWeight:900,letterSpacing:-1,color:'#fff'}}>bee<span style={{color:'#fff'}}>-doo</span></div>
            <div style={{fontSize:8,color:'rgba(26,18,0,.45)',letterSpacing:2,textTransform:'uppercase',marginTop:2}}>Energy for you</div>
          </div>
          <div style={{display:'flex',alignItems:'flex-start',gap:12}}>
            <div style={{textAlign:'right',fontSize:11}}>
              <div><span style={{color:'rgba(26,18,0,.5)',fontSize:9}}>Datum</span><br/><b>{heute}</b></div>
              <div style={{marginTop:4}}><span style={{color:'rgba(26,18,0,.5)',fontSize:9}}>Leistungszeitraum</span><br/><b>{lzLabel}</b></div>
            </div>
            <div style={{width:48,height:48,background:'#fff',borderRadius:5,padding:2,boxShadow:'0 2px 8px rgba(0,0,0,.15)',flexShrink:0}}>
              <img src={qrUrl} width={44} height={44} style={{display:'block',borderRadius:2}} alt="QR"/>
            </div>
          </div>
        </div>
        <div style={{fontSize:16,fontWeight:700,marginTop:10,letterSpacing:.5,color:'#fff'}}>{hgb?'Gutschrift':'Entgeltabrechnung'} {bn}</div>
        <div style={{fontSize:10,color:'rgba(26,18,0,.5)',marginTop:2}}>{ab.mitarbeiter_name} Â· {pLabel(ab.periode)}</div>
      </div>

      <div className="gs-body">
        <div style={{fontSize:8.5,color:'#888',borderBottom:'1px dotted #ccc',paddingBottom:4,marginBottom:8}}>bee-doo GmbH Â· Am Stadtholz 39 Â· D-33609 Bielefeld</div>
        {window.__vpData?.firmenname&&<div style={{fontSize:12,fontWeight:700,marginBottom:1}}>{window.__vpData.firmenname}</div>}
        <div style={{fontSize:window.__vpData?.firmenname?10.5:12,fontWeight:window.__vpData?.firmenname?400:700,marginBottom:2}}>{ab.mitarbeiter_name}</div>
        <div style={{fontSize:11,color:'#444',lineHeight:1.7,marginBottom:2}}>{window.__vpData?.strasse?`${window.__vpData.strasse} ${window.__vpData.hausnr||''}`:'â€”'}<br/>{window.__vpData?.plz?`${window.__vpData.plz} ${window.__vpData.ort||''}`:'â€”'}</div>
        <div style={{fontSize:9.5,color:'#888',marginBottom:12}}>{(()=>{const vp=window.__vpData;const stnr=vp?.steuernummer&&vp.steuernummer.length>4&&/\d/.test(vp.steuernummer)?vp.steuernummer:null;const uid=vp?.ustid&&/^DE\d{9}$/.test(vp.ustid)?vp.ustid:null;if(stnr||uid)return(stnr?`Steuernr.: ${stnr}`:'')+(stnr&&uid?' Â· ':'')+(uid?`USt-IdNr.: ${uid}`:'');return hgb?'HGB Â§84 Handelsvertreter â€“ âš ï¸ Steuerdaten unvollstÃ¤ndig':'Angestellt';})()}</div>
        <div style={{borderTop:'1px solid #eee',marginBottom:10}}></div>

        <div style={{display:'grid',gridTemplateColumns:'56% 42%',gap:'2%'}}>
          <div>
            <table style={{width:'100%',borderCollapse:'collapse',fontSize:11}}><tbody>
              <tr><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',color:'#E07800'}}>Provisionen ({salesLZ} LZ{aPNZ.filter(p=>p.typ==='provision').length>0?` + ${aPNZ.filter(p=>p.typ==='provision').length} NZ`:''} Sales â€“ Vermittlung Solar/WP)</td><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtE(provSum)}</td></tr>
              {aE.map((p,i)=><tr key={i}><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',color:(p.override_betrag!=null?p.override_betrag:p.original_betrag)>=0?'#E07800':'#9a3412'}}>{p.kunde||p.notiz||p.typ}</td><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
              {aSKN.length>0&&<tr style={{background:'#f0fdf4'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #dcfce7',color:'#166534'}}>ðŸ“ˆ Nachzahlungen ({aSKN.length})</td><td style={{padding:'6px 10px',borderBottom:'1px solid #dcfce7',textAlign:'right',color:'#166534',fontWeight:600}}>+ {fmtE(aSKN.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0))}</td></tr>}
              {aSKR.length>0&&<tr style={{background:'#fef2f2'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #fecaca',color:'#991b1b'}}>ðŸ“‰ RÃ¼ckforderungen ({aSKR.length})</td><td style={{padding:'6px 10px',borderBottom:'1px solid #fecaca',textAlign:'right',color:'#991b1b',fontWeight:600}}>{fmtE(aSKR.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0))}</td></tr>}
              {aTB.length>0&&<tr style={{background:'#eff6ff'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #dbeafe',color:'#1e40af'}}>ðŸ… Team-Bonus ({aTB.length})</td><td style={{padding:'6px 10px',borderBottom:'1px solid #dbeafe',textAlign:'right',color:'#1e40af',fontWeight:600}}>+ {fmtE(aTB.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0))}</td></tr>}
              <tr><td style={{padding:'6px 10px',borderBottom:'2px solid #aaa',fontWeight:700}}>Brutto-Provisionen</td><td style={{padding:'6px 10px',borderBottom:'2px solid #aaa',textAlign:'right',fontWeight:700}}>{fmtE(b.bp+b.es)}</td></tr>
              <tr><td style={{padding:'6px 10px',borderTop:'2px solid #111',borderBottom:'1px solid #eee',color:'#555'}}>Nettobetrag</td><td style={{padding:'6px 10px',borderTop:'2px solid #111',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtE(b.net)}</td></tr>
              {hgb&&<tr style={{background:'#fffbeb'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #fde68a',color:'#92400e',fontWeight:600}}>+ Umsatzsteuer 19%</td><td style={{padding:'6px 10px',borderBottom:'1px solid #fde68a',textAlign:'right',color:'#92400e',fontWeight:600}}>+ {fmtE(b.uB)}</td></tr>}
              {hgb&&b.sgN>0&&<tr style={{background:'#fff7ed'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #fed7aa',color:'#9a3412',fontWeight:600}}>â€“ SystemgebÃ¼hr (verrechnet)</td><td style={{padding:'6px 10px',borderBottom:'1px solid #fed7aa',textAlign:'right',color:'#9a3412',fontWeight:600}}>â€“ {fmtE(b.sgB)}</td></tr>}
              <tr style={{background:'linear-gradient(135deg,#f0fdf4,#dcfce7)'}}><td style={{padding:'9px 10px',fontWeight:800,fontSize:13}}>AUSZAHLUNGSSUMME</td><td style={{padding:'9px 10px',textAlign:'right',fontWeight:800,fontSize:13,color:'#166534',whiteSpace:'nowrap'}}>{fmtE(b.aus)}</td></tr>
            </tbody></table>
          </div>
          <div>
            <div style={{fontSize:10,fontWeight:700,color:'#E07800',marginBottom:5,paddingBottom:3,borderBottom:'1px solid #eee'}}>Sales {lzLabel}</div>
            <table style={{width:'100%',borderCollapse:'collapse',fontSize:10}}><tbody>
              <tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#555'}}>Abgerechnete Sales (LZ)</td><td style={{padding:'4px 7px',textAlign:'right',fontWeight:700}}>{aPLZ.filter(p=>p.typ==='provision').length}</td></tr>
              {aPLZ.filter(p=>p.typ==='provision').length>0&&<tr><td colSpan={2} style={{padding:'2px 7px 6px',borderBottom:'1px solid #eee'}}><div style={{fontSize:8,color:'#666',lineHeight:1.5}}>{aPLZ.filter(p=>p.typ==='provision').map(p=>p.kunde||'â€”').join(' Â· ')}</div></td></tr>}
              {aPNZ.filter(p=>p.typ==='provision').length>0&&<tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#B45309'}}>+ NachzÃ¼gler (Vormonate)</td><td style={{padding:'4px 7px',textAlign:'right',color:'#B45309',fontWeight:600}}>{aPNZ.filter(p=>p.typ==='provision').length}</td></tr>}
              {aPNZ.filter(p=>p.typ==='provision').length>0&&<tr><td colSpan={2} style={{padding:'2px 7px 6px',borderBottom:'1px solid #eee'}}><div style={{fontSize:8,color:'#B45309',lineHeight:1.5}}>{aPNZ.filter(p=>p.typ==='provision').map(p=>p.kunde||'â€”').join(' Â· ')}</div></td></tr>}
              {aStLZ.length>0&&<tr><td style={{padding:'4px 7px',borderBottom:'none',color:'#da3633'}}>Storniert ({lzLabel})</td><td style={{padding:'4px 7px',textAlign:'right',color:'#da3633'}}>{aStLZ.length}</td></tr>}
              {aStLZ.length>0&&<tr><td colSpan={2} style={{padding:'2px 7px 6px',borderBottom:'1px solid #eee'}}><div style={{fontSize:8,color:'#da3633',lineHeight:1.5}}>{aStLZ.map(p=>p.kunde||'â€”').join(' Â· ')}</div></td></tr>}
              {aStVM.length>0&&<tr><td style={{padding:'4px 7px',borderBottom:'none',color:'#da3633'}}>Storniert (Vormonate)</td><td style={{padding:'4px 7px',textAlign:'right',color:'#da3633'}}>{aStVM.length}</td></tr>}
              {aStVM.length>0&&<tr><td colSpan={2} style={{padding:'2px 7px 6px',borderBottom:'1px solid #eee'}}><div style={{fontSize:8,color:'#da3633',lineHeight:1.5}}>{aStVM.map(p=>p.kunde||'â€”').join(' Â· ')}</div></td></tr>}
              {aOfLZ.length>0&&<tr><td style={{padding:'4px 7px',borderBottom:'none',color:'#8b949e'}}>Offen ({lzLabel})</td><td style={{padding:'4px 7px',textAlign:'right',color:'#8b949e'}}>{aOfLZ.length}</td></tr>}
              {aOfLZ.length>0&&<tr><td colSpan={2} style={{padding:'2px 7px 6px',borderBottom:'1px solid #eee'}}><div style={{fontSize:8,color:'#8b949e',lineHeight:1.5}}>{aOfLZ.map(p=>p.kunde||'â€”').join(' Â· ')}</div></td></tr>}
              {aOfVM.length>0&&<tr><td style={{padding:'4px 7px',borderBottom:'none',color:'#8b949e'}}>Offen (Vormonate)</td><td style={{padding:'4px 7px',textAlign:'right',color:'#8b949e'}}>{aOfVM.length}</td></tr>}
              {aOfVM.length>0&&<tr><td colSpan={2} style={{padding:'2px 7px 6px',borderBottom:'1px solid #eee'}}><div style={{fontSize:8,color:'#8b949e',lineHeight:1.5}}>{aOfVM.map(p=>p.kunde||'â€”').join(' Â· ')}</div></td></tr>}
              {aOH.length>0&&<tr><td style={{padding:'4px 7px',borderBottom:'none',color:'#6366f1'}}>â¸ï¸ On Hold (Montage)</td><td style={{padding:'4px 7px',textAlign:'right',color:'#6366f1'}}>{aOH.length}</td></tr>}
              {aOH.length>0&&<tr><td colSpan={2} style={{padding:'2px 7px 6px',borderBottom:'1px solid #eee'}}><div style={{fontSize:8,color:'#6366f1',lineHeight:1.5}}>{aOH.map(p=>p.kunde||'â€”').join(' Â· ')}</div></td></tr>}
              {aSKN.length>0&&<tr style={{background:'#f0fdf4'}}><td style={{padding:'4px 7px',borderBottom:'1px solid #dcfce7',color:'#166534'}}>ðŸ“ˆ Nachzahlungen</td><td style={{padding:'4px 7px',textAlign:'right',color:'#166534',fontWeight:600}}>+{fmtE(aSKN.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0))}</td></tr>}
              {aSKR.length>0&&<tr style={{background:'#fef2f2'}}><td style={{padding:'4px 7px',borderBottom:'1px solid #fecaca',color:'#991b1b'}}>ðŸ“‰ RÃ¼ckforderungen</td><td style={{padding:'4px 7px',textAlign:'right',color:'#991b1b',fontWeight:600}}>{fmtE(aSKR.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0))}</td></tr>}
              {leadBonusTotal>0&&<tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#059669'}}>ðŸ“‹ Lead-Bonus ({aLeadBonus.length>0?aLeadBonus[0].kunde:''})</td><td style={{padding:'4px 7px',textAlign:'right',color:'#059669',fontWeight:600}}>+ {fmtE(leadBonusTotal)}</td></tr>}
              {terminBonusTotal>0&&<tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#2563eb'}}>ðŸ“… Termin-Bonus ({aTerminBonus.length>0?aTerminBonus[0].kunde:''})</td><td style={{padding:'4px 7px',textAlign:'right',color:'#2563eb',fontWeight:600}}>+ {fmtE(terminBonusTotal)}</td></tr>}
              
              <tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#555'}}>Provisionen Netto</td><td style={{padding:'4px 7px',textAlign:'right'}}>{fmtE(b.net)}</td></tr>
              {hgb&&<tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#92400e'}}>+ USt 19%</td><td style={{padding:'4px 7px',textAlign:'right',color:'#92400e'}}>+ {fmtE(b.uB)}</td></tr>}
              {hgb&&b.sgN>0&&<tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#9a3412'}}>â€“ SystemgebÃ¼hr (verrechnet)</td><td style={{padding:'4px 7px',textAlign:'right',color:'#9a3412'}}>â€“ {fmtE(b.sgB)}</td></tr>}
              <tr style={{background:'#f0fdf4'}}><td style={{padding:'4px 7px',fontWeight:700}}>Auszahlung</td><td style={{padding:'4px 7px',textAlign:'right',fontWeight:700,color:'#166534'}}>{fmtE(b.aus)}</td></tr>
            </tbody></table>

            {hgb&&b.sgN>0&&<div style={{marginTop:12,background:'#fff7ed',border:'1px solid #fed7aa',borderRadius:6,padding:'8px 10px',fontSize:9}}>
              <b style={{color:'#9a3412'}}>ðŸ“„ SystemgebÃ¼hr:</b> <span style={{color:'#78350f'}}>Wird diesen Monat direkt verrechnet ({fmtE(b.sgN)} netto + {fmtE(b.sgU)} USt = {fmtE(b.sgB)} brutto)</span>
            </div>}

            {hatS&&<div style={{marginTop:12,background:'linear-gradient(135deg,#fffbeb,#fef3c7)',border:'1px solid #f59e0b',borderRadius:6,padding:'8px 10px'}}>
              <div style={{fontSize:9,fontWeight:700,color:'#92400e',textTransform:'uppercase',letterSpacing:.5,marginBottom:4}}>â­ Staffel-Bonus erreicht!</div>
              <div style={{fontSize:10,color:'#78350f',fontWeight:600}}>{salesLZ} LZ-Sales â‰¥ {staffel} â†’ ErhÃ¶hte Rate aktiv</div>
            </div>}

            <div style={{marginTop:10,background:'#f8fafc',border:'1px solid #e2e8f0',borderRadius:6,padding:'8px 10px'}}>
              <div style={{fontSize:9,color:'#475569',marginBottom:4,display:'flex',justifyContent:'space-between'}}>
                <span>Staffel-Fortschritt</span>
                <span style={{fontWeight:700,color:hatS?'#16a34a':'#475569'}}>{salesLZ} / {staffel}</span>
              </div>
              <div style={{height:8,background:'#e2e8f0',borderRadius:4,overflow:'hidden'}}>
                <div style={{height:'100%',borderRadius:4,width:`${pct}%`,background:hatS?'linear-gradient(90deg,#22c55e,#16a34a)':'linear-gradient(90deg,#F5C500,#E07800)'}}></div>
              </div>
              {!hatS&&<div style={{fontSize:8,color:'#94a3b8',marginTop:3,textAlign:'right'}}>Noch {staffel-salesLZ} LZ-Sales bis zur nÃ¤chsten Stufe</div>}
            </div>

            <div style={{marginTop:10,background:'#fff7ed',border:'1px solid #fed7aa',borderRadius:6,padding:'8px 10px',fontSize:9}}>
              <b style={{color:'#9a3412'}}>ðŸ“‹ Stornoreserve:</b> <span style={{color:'#78350f'}}>Derzeit keine Stornoreserve einbehalten.</span>
            </div>
          </div>
        </div>

        <div style={{marginTop:14,fontSize:9.5,color:'#555',lineHeight:1.6,borderTop:'1px solid #eee',paddingTop:8}}>
          {hgb?`Diese Gutschrift gem. Â§14 Abs. 2 UStG ersetzt die Rechnung des Leistungserbringers (gem. Gutschriftvereinbarung HVV). Nettobetrag: ${fmtE(b.net)} Â· zzgl. 19% USt: ${fmtE(b.uB)} Â· Brutto: ${fmtE(b.net+b.uB)}${b.sgN>0?` Â· abzgl. SystemgebÃ¼hr: ${fmtE(b.sgB)}`:''} Â· Auszahlung: ${fmtE(b.aus)}. Die SystemgebÃ¼hr gem. Ziff. 4.2 HVV wird diesen Monat direkt mit der Gutschrift verrechnet. EmpfÃ¤nger: ${ab.mitarbeiter_name}${window.__vpData?.ustid&&/^DE\d{9}$/.test(window.__vpData.ustid)?', USt-IdNr.: '+window.__vpData.ustid:''}${window.__vpData?.steuernummer&&window.__vpData.steuernummer.length>4?', StNr.: '+window.__vpData.steuernummer:''}. Aussteller: bee-doo GmbH, USt-IdNr. DE323940446, StNr. 44/214/0394.`
          :`Entgeltabrechnung ${ab.mitarbeiter_name}. Nettobetrag: ${fmtE(b.net)}.`}
        </div>
        <FooterBlock/>
      </div>
    </div>

    {/* === SEITE 2+ (Einzelpositionen, paginiert) === */}
    {(()=>{
      /* Group positions by auftrag_nr for tree structure */
      // Separate LZ and NZ positions
      const isNZPos = p => (p.notiz||'').includes('â˜…NZ');
      const aPLZ = aP.filter(p => !isNZPos(p));
      const aPNZ = aP.filter(p => isNZPos(p));
      // Lead-Bonus als eigene Gruppe
      const aPLeads = aP.filter(p => p.typ==='lead_bonus');
      
      const makeGroups = (arr) => {
        const groups = []; const byAN = {};
        arr.forEach(p => {
          const an = p.auftrag_nr || 'â€”';
          if(!byAN[an]) { byAN[an] = {main:null,boni:[]}; groups.push(an); }
          if(p.typ==='provision'||p.typ==='lead_bonus'||p.typ==='termin_bonus') byAN[an].main = p;
          else byAN[an].boni.push(p);
        });
        return {groups, byAN};
      };
      const lzG = makeGroups(aPLZ);
      const nzG = makeGroups(aPNZ);
      // Combine: LZ first, then NZ with a separator marker
      const allGroups = [...lzG.groups.map(an=>({an,src:'lz'}))];
      if(nzG.groups.length>0){
        allGroups.push({an:'__NZ_HEADER__',src:'sep'});
        allGroups.push(...nzG.groups.map(an=>({an,src:'nz'})));
      }
      const getG = (item) => item.src==='lz'?lzG.byAN[item.an]:nzG.byAN[item.an];
      
      // NZ-Duplikate erkennen: gleicher Kundenname â†’ Warnung
      const nzKundeCount = {};
      nzG.groups.forEach(an => { const g=nzG.byAN[an]; if(g?.main?.kunde){ const k=g.main.kunde.trim().toLowerCase(); nzKundeCount[k]=(nzKundeCount[k]||0)+1; } });
      const isNZDupe = (kunde) => kunde && nzKundeCount[kunde.trim().toLowerCase()] > 1;
      
      // Dynamic page break: count actual rows per group, max ~38 rows per page
      const MAX_ROWS = 38;
      const hasExtras = aE.length > 0 || aTB.length > 0;
      // Extras (AbzÃ¼ge, Sonderzulagen, Team-Bonus) IMMER auf eigene Seite wenn vorhanden
      const extrasOnOwnPage = hasExtras;
      const SUMMEN_ROWS = extrasOnOwnPage ? 2 : 8; // nur Zwischensumme vs. volle Summen+Unterschrift
      const pages = []; let currentPage = []; let rowCount = 0;
      allGroups.forEach((item, gi) => {
        if(item.src==='sep'){
          // NZ header â†’ immer neue Seite
          if(currentPage.length > 0){
            pages.push(currentPage); currentPage = []; rowCount = 0;
          }
          currentPage.push(item); rowCount += 2;
          return;
        }
        const g = getG(item);
        const rows = 1 + (g.boni.length > 0 ? g.boni.length + 2 : 0);
        const remainingItems = allGroups.slice(gi).filter(x=>x.src!=='sep');
        const remainingRows = remainingItems.reduce((s,x) => {const gg=getG(x); return s + 1 + (gg&&gg.boni.length > 0 ? gg.boni.length + 2 : 0);}, 0);
        const isNearEnd = remainingRows <= (MAX_ROWS - SUMMEN_ROWS);
        const limit = isNearEnd ? (MAX_ROWS - SUMMEN_ROWS) : MAX_ROWS;
        if(rowCount + rows > limit && currentPage.length > 0){
          pages.push(currentPage); currentPage = []; rowCount = 0;
        }
        currentPage.push(item); rowCount += rows;
      });
      if(currentPage.length > 0) pages.push(currentPage);
      if(pages.length===0) pages.push([]);
      
      let globalNr = 0;
      
      const THead = () => <thead><tr style={{background:'#f5f5f5'}}><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888',width:24}}>Nr</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888'}}>Kunde / Position</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888',width:80}}>Quelle</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'right',fontSize:8,textTransform:'uppercase',color:'#888',width:80}}>Betrag</th></tr></thead>;
      
      const PosRow = ({item, nr}) => {
        if(item.src==='sep') return <tr><td colSpan={4} style={{padding:'12px 6px 4px',fontWeight:700,color:'#B45309',fontSize:10,borderBottom:'2px solid #f59e0b',background:'#fffbeb',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ“‹ NachzÃ¼gler aus Vormonaten ({nzG.groups.length})</td></tr>;
        const g = getG(item); if(!g||!g.main) return null;
        const m = g.main; const boni = g.boni;
        const isNZ = item.src==='nz';
        const posSum = (m.override_betrag!=null?m.override_betrag:m.original_betrag) + boni.reduce((s,b)=>s+(b.override_betrag!=null?b.override_betrag:b.original_betrag),0);
        const hasBoni = boni.length > 0;
        // Clean notiz: remove â˜…NZ marker for display
        const cleanNotiz = (m.notiz||'').replace(' â˜…NZ','');
        return <React.Fragment>
          <tr style={{borderBottom:hasBoni?'none':'1px solid #eee',background:isNZ?'#fffbeb':'transparent'}}>
            <td style={{padding:'5px 6px',color:'#aaa',fontSize:9,verticalAlign:'top'}}>{nr}.</td>
            <td style={{padding:'5px 6px'}}><div style={{fontWeight:600}}>{m.kunde||'â€”'}{isNZ&&<span style={{fontSize:7,color:'#B45309',marginLeft:4,padding:'1px 4px',background:'#fef3c7',borderRadius:3}}>NZ</span>}{isNZ&&isNZDupe(m.kunde)&&<span style={{fontSize:7,color:'#dc2626',marginLeft:4,padding:'1px 4px',background:'#fef2f2',borderRadius:3,border:'1px solid #fecaca'}}>âš ï¸ Duplikat?</span>}</div><div style={{fontSize:8.5,color:'#888'}}>{m.produkt}{cleanNotiz&&!cleanNotiz.startsWith('{')&&!cleanNotiz.startsWith('[')?` Â· ${cleanNotiz}`:''}</div></td>
            <td style={{padding:'5px 6px',color:'#888',fontSize:9,verticalAlign:'top'}}>{item.an}</td>
            <td style={{padding:'5px 6px',textAlign:'right',verticalAlign:'top'}}>{hasBoni?'':<span style={{fontWeight:600,whiteSpace:'nowrap'}}>{fmtE(m.override_betrag!=null?m.override_betrag:m.original_betrag)}</span>}</td>
          </tr>
          {hasBoni && <>
            <tr><td></td><td colSpan={2} style={{padding:'1px 6px 1px 16px',fontSize:9,color:'#666'}}>â”œâ”€ Grundprovision</td><td style={{padding:'1px 6px',textAlign:'right',fontSize:9,color:'#666',whiteSpace:'nowrap'}}>{fmtE(m.override_betrag!=null?m.override_betrag:m.original_betrag)}</td></tr>
            {boni.map((bb,bi) => <tr key={bi}><td></td><td colSpan={2} style={{padding:'1px 6px 1px 16px',fontSize:9,color:bb.typ==='eigenlead'?'#B45309':bb.typ==='empfehlung'?'#7C3AED':bb.typ==='sondereinsatz'?'#0f766e':bb.typ==='lead_bonus'?'#059669':bb.typ==='termin_bonus'?'#2563eb':bb.typ==='zero_bonus'?'#d97706':'#0369a1'}}>{bi===boni.length-1?'â””â”€':'â”œâ”€'} {bb.produkt}</td><td style={{padding:'1px 6px',textAlign:'right',fontSize:9,color:bb.typ==='eigenlead'?'#B45309':bb.typ==='empfehlung'?'#7C3AED':bb.typ==='sondereinsatz'?'#0f766e':bb.typ==='lead_bonus'?'#059669':bb.typ==='termin_bonus'?'#2563eb':bb.typ==='zero_bonus'?'#d97706':'#0369a1',whiteSpace:'nowrap'}}>+ {fmtE(bb.override_betrag!=null?bb.override_betrag:bb.original_betrag)}</td></tr>)}
            <tr style={{borderBottom:'1px solid #eee'}}><td></td><td colSpan={2} style={{padding:'2px 6px 5px 16px',fontSize:9,fontWeight:700,color:'#333'}}>Summe Pos. {nr}</td><td style={{padding:'2px 6px 5px',textAlign:'right',fontWeight:700,fontSize:10,whiteSpace:'nowrap'}}>{fmtE(posSum)}</td></tr>
          </>}
        </React.Fragment>;
      };
      
      return pages.map((pageGroups, pi) => {
        const isLastPage = pi === pages.length - 1;
        const pageNum = pi + 2; // Seite 1 = Deckblatt
        const startNr = globalNr;
        
        return <div key={`pos-page-${pi}`} className="gs-page" style={{padding:0,display:'flex',flexDirection:'column'}}>
          {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
          <div style={{padding:'14mm 16mm 0',flex:1}}>
            <div style={{fontSize:8.5,color:'#555',borderBottom:'1px solid #ddd',paddingBottom:5,marginBottom:12,display:'flex',justifyContent:'space-between'}}>
              <span>{pageGroups[0]?.src==='sep'?`NachzÃ¼gler aus Vormonaten`:`Provisionen ${lzLabel}`}</span><span style={{color:'#aaa'}}>{bn} Â· Seite {pageNum}</span>
            </div>
            {pi===0&&<div style={{fontSize:17,fontWeight:700,marginBottom:14}}>{ab.mitarbeiter_name} <span style={{fontSize:11,color:'#888',fontWeight:400}}>({k})</span></div>}
            {pi===0&&<div style={{color:'#E07800',fontWeight:700,fontSize:11,marginBottom:7,borderBottom:'1px solid #eee',paddingBottom:3}}>Einzelpositionen â€“ Leistungszeitraum {lzLabel}</div>}
            {pi>0&&<div style={{color:'#888',fontSize:9,marginBottom:8}}>Fortsetzung Einzelpositionen</div>}
            
            <table style={{width:'100%',borderCollapse:'collapse',fontSize:10}}>
              <THead/>
              <tbody>
              {pageGroups.map((item,gi) => { if(item.src==='sep') return <PosRow key="nz-hdr" item={item} nr={0}/>; globalNr = startNr + gi + 1 - pageGroups.slice(0,gi+1).filter(x=>x.src==='sep').length; return <PosRow key={item.an} item={item} nr={globalNr}/>; })}
              
              {isLastPage && <>{/* Wenn Extras auf eigene Seite â†’ nur Summen hier */}
                {!extrasOnOwnPage && aE.filter(p=>['abzug','vorschuss_rechnung'].includes(p.typ)).length>0 && <tr><td colSpan={4} style={{padding:'10px 6px 4px',fontWeight:700,color:'#dc2626',fontSize:10,borderBottom:'2px solid #fecaca',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ”» AbzÃ¼ge ({aE.filter(p=>['abzug','vorschuss_rechnung'].includes(p.typ)).length})</td></tr>}
                {!extrasOnOwnPage && aE.filter(p=>['abzug','vorschuss_rechnung'].includes(p.typ)).map((p,i)=><tr key={`abz${i}`} style={{background:'#fef2f2',borderBottom:'1px solid #fecaca'}}><td style={{padding:'4px 6px',color:'#aaa',fontSize:9}}>â€”</td><td colSpan={2} style={{padding:'4px 6px',fontSize:10,color:'#dc2626'}}>{p.produkt||p.kunde||'Abzug'}</td><td style={{padding:'4px 6px',textAlign:'right',fontWeight:600,color:'#dc2626',whiteSpace:'nowrap'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
                {!extrasOnOwnPage && aE.filter(p=>!['abzug','vorschuss_rechnung'].includes(p.typ)&&p.typ!=='sondereinsatz').length>0 && <tr><td colSpan={4} style={{padding:'10px 6px 4px',fontWeight:700,color:'#334155',fontSize:10,borderBottom:'2px solid #334155',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ“Ž Einmalzahlungen ({aE.filter(p=>!['abzug','vorschuss_rechnung'].includes(p.typ)&&p.typ!=='sondereinsatz').length})</td></tr>}
                {!extrasOnOwnPage && aE.filter(p=>!['abzug','vorschuss_rechnung'].includes(p.typ)&&p.typ!=='sondereinsatz').map((p,i)=><tr key={`e${i}`} style={{background:'#fffbeb',borderBottom:'1px solid #eee'}}><td style={{padding:'4px 6px',color:'#aaa',fontSize:9}}>â€”</td><td colSpan={2} style={{padding:'4px 6px',fontSize:10}}>{p.produkt||p.kunde||p.notiz||p.typ}</td><td style={{padding:'4px 6px',textAlign:'right',fontWeight:600,whiteSpace:'nowrap'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
                {!extrasOnOwnPage && aTB.length>0 && <tr><td colSpan={4} style={{padding:'10px 6px 4px',fontWeight:700,color:'#1e40af',fontSize:10,borderBottom:'2px solid #93c5fd',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ… Team-Bonus ({aTB.length})</td></tr>}
                {!extrasOnOwnPage && aTB.map((p,i)=><tr key={`tb${i}`} style={{background:'#eff6ff',borderBottom:'1px solid #dbeafe'}}><td style={{padding:'4px 6px',color:'#aaa',fontSize:9}}>â€”</td><td colSpan={2} style={{padding:'4px 6px',fontSize:10,color:'#1e40af'}}>{p.produkt} <span style={{fontSize:8,color:'#6b7280'}}>(Details s. Anlage)</span></td><td style={{padding:'4px 6px',textAlign:'right',fontWeight:700,color:'#1e40af',whiteSpace:'nowrap'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
                {!extrasOnOwnPage && <tr style={{fontWeight:700,borderTop:'2px solid #333',background:'#f9f9f9'}}><td></td><td colSpan={2} style={{padding:'6px 6px'}}>Netto-Summe</td><td style={{padding:'6px 6px',textAlign:'right',whiteSpace:'nowrap'}}>{fmtE(b.bp+b.es)}</td></tr>}
                {extrasOnOwnPage && <tr style={{fontWeight:700,borderTop:'2px solid #333',background:'#f9f9f9'}}><td></td><td colSpan={2} style={{padding:'6px 6px'}}>Zwischensumme Provisionen</td><td style={{padding:'6px 6px',textAlign:'right',whiteSpace:'nowrap'}}>{fmtE(provSum)}</td></tr>}
                {extrasOnOwnPage && <tr><td></td><td colSpan={2} style={{padding:'4px 6px',color:'#888',fontSize:9,fontStyle:'italic'}}>Sonderpositionen & Summen â†’ nÃ¤chste Seite</td><td></td></tr>}
                {!extrasOnOwnPage && <tr><td></td><td colSpan={2} style={{padding:'4px 6px',color:'#555',borderTop:'1px solid #ddd'}}>Nettobetrag</td><td style={{padding:'4px 6px',textAlign:'right',borderTop:'1px solid #ddd',whiteSpace:'nowrap'}}>{fmtE(b.net)}</td></tr>}
                {!extrasOnOwnPage && hgb&&<tr style={{background:'#fffbeb'}}><td></td><td colSpan={2} style={{padding:'4px 6px',color:'#92400e'}}>+ USt 19%</td><td style={{padding:'4px 6px',textAlign:'right',color:'#92400e',fontWeight:700,whiteSpace:'nowrap'}}>+ {fmtE(b.uB)}</td></tr>}
                {!extrasOnOwnPage && <tr style={{background:'linear-gradient(135deg,#f0fdf4,#dcfce7)',borderTop:'2px solid #166534'}}><td></td><td colSpan={2} style={{padding:'7px 6px',fontWeight:800,fontSize:12}}>BRUTTO-AUSZAHLUNG</td><td style={{padding:'7px 6px',textAlign:'right',fontWeight:900,fontSize:13,color:'#166534',whiteSpace:'nowrap'}}>{fmtE(b.aus)}</td></tr>}
              </>}
              </tbody>
            </table>
            
            {isLastPage && !extrasOnOwnPage && ab.stb_kommentar&&<div style={{marginTop:16,padding:10,background:'#fff8e1',border:'1px solid #fde68a',borderRadius:4,fontSize:10}}><b style={{color:'#92400e'}}>ðŸ“Ž Kommentar Steuerberater:</b><br/>{ab.stb_kommentar}</div>}
            
            {isLastPage && !extrasOnOwnPage && <div style={{marginTop:20,display:'grid',gridTemplateColumns:'1fr 1fr',gap:30}}>
              <div style={{textAlign:'center'}}><div style={{borderBottom:'1px solid #333',height:50,marginBottom:6}}></div><div style={{fontSize:9,color:'#888'}}>Datum, Unterschrift GeschÃ¤ftsfÃ¼hrer</div><div style={{fontSize:9,color:'#555',fontWeight:600}}>bee-doo GmbH</div></div>
              <div style={{textAlign:'center'}}>
                {isF&&<div style={{display:'inline-block',border:'2px solid #166534',color:'#166534',padding:'4px 12px',borderRadius:4,fontWeight:700,fontSize:11,transform:'rotate(-3deg)',marginTop:8}}>âœ“ FREIGEGEBEN</div>}
                {isF&&<div style={{fontSize:9,color:'#166534',marginTop:4}}>{ab.freigegeben_von||'Patrick Grabowski'}<br/>{ab.freigegeben_am?new Date(ab.freigegeben_am).toLocaleDateString('de-DE'):heute}</div>}
                {!isF&&<div style={{height:50,display:'flex',alignItems:'center',justifyContent:'center',color:'#ccc',fontSize:10,fontStyle:'italic'}}>Ausstehend</div>}
                <div style={{fontSize:9,color:'#888'}}>Freigabe-Vermerk</div>
              </div>
            </div>}
          </div>
          <FooterBlock/>
        </div>;
      });
    })()}

    {/* === EXTRAS-SEITE (AbzÃ¼ge, Sonderzulagen, Summen â€“ eigene Seite) === */}
    {(()=>{
      const hasExtrasPage = aE.length > 0 || aTB.length > 0;
      if(!hasExtrasPage) return null;
      return <div className="gs-page" style={{padding:0,display:'flex',flexDirection:'column'}}>
        {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
        <div style={{padding:'14mm 16mm 0',flex:1}}>
          <div style={{fontSize:8.5,color:'#555',borderBottom:'1px solid #ddd',paddingBottom:5,marginBottom:12,display:'flex',justifyContent:'space-between'}}>
            <span>Sonderpositionen & Zusammenfassung</span><span style={{color:'#aaa'}}>{bn}</span>
          </div>
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:10}}>
            <thead><tr style={{background:'#f5f5f5'}}><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888',width:24}}>Nr</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888'}}>Position</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888',width:80}}>Details</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'right',fontSize:8,textTransform:'uppercase',color:'#888',width:80}}>Betrag</th></tr></thead>
            <tbody>
              {/* Ãœbertrag von Provisionsseite */}
              <tr style={{background:'#f9f9f9',borderBottom:'2px solid #ddd'}}><td style={{padding:'6px 6px',color:'#aaa',fontSize:9}}>â‡</td><td colSpan={2} style={{padding:'6px 6px',fontWeight:600,fontSize:10}}>Ãœbertrag Provisionen</td><td style={{padding:'6px 6px',textAlign:'right',fontWeight:700,whiteSpace:'nowrap'}}>{fmtE(provSum)}</td></tr>
              {/* Sonderzulagen (positive) */}
              {aE.filter(p=>['sondereinsatz','stnr_auszahlung'].includes(p.typ)).length>0 && <tr><td colSpan={4} style={{padding:'10px 6px 4px',fontWeight:700,color:'#166534',fontSize:10,borderBottom:'2px solid #bbf7d0',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ’° Sonderzulagen ({aE.filter(p=>['sondereinsatz','stnr_auszahlung'].includes(p.typ)).length})</td></tr>}
              {aE.filter(p=>['sondereinsatz','stnr_auszahlung'].includes(p.typ)).map((p,i)=><tr key={`sz${i}`} style={{background:'#f0fdf4',borderBottom:'1px solid #bbf7d0'}}><td style={{padding:'4px 6px',color:'#aaa',fontSize:9}}>â€”</td><td colSpan={2} style={{padding:'4px 6px',fontSize:10,color:'#166534'}}>{p.produkt||p.kunde||'Sonderzulage'}</td><td style={{padding:'4px 6px',textAlign:'right',fontWeight:700,color:'#166534',whiteSpace:'nowrap'}}>+ {fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
              {/* AbzÃ¼ge (negative) */}
              {aE.filter(p=>['abzug','vorschuss_rechnung'].includes(p.typ)).length>0 && <tr><td colSpan={4} style={{padding:'10px 6px 4px',fontWeight:700,color:'#dc2626',fontSize:10,borderBottom:'2px solid #fecaca',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ”» AbzÃ¼ge ({aE.filter(p=>['abzug','vorschuss_rechnung'].includes(p.typ)).length})</td></tr>}
              {aE.filter(p=>['abzug','vorschuss_rechnung'].includes(p.typ)).map((p,i)=><tr key={`abz${i}`} style={{background:'#fef2f2',borderBottom:'1px solid #fecaca'}}><td style={{padding:'4px 6px',color:'#aaa',fontSize:9}}>â€”</td><td colSpan={2} style={{padding:'4px 6px',fontSize:10,color:'#dc2626'}}>{p.produkt||p.kunde||'Abzug'}</td><td style={{padding:'4px 6px',textAlign:'right',fontWeight:600,color:'#dc2626',whiteSpace:'nowrap'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
              {/* Sonstige Einmalzahlungen */}
              {aE.filter(p=>!['abzug','vorschuss_rechnung'].includes(p.typ)&&p.typ!=='sondereinsatz').length>0 && <tr><td colSpan={4} style={{padding:'10px 6px 4px',fontWeight:700,color:'#334155',fontSize:10,borderBottom:'2px solid #334155',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ“Ž Einmalzahlungen ({aE.filter(p=>!['abzug','vorschuss_rechnung'].includes(p.typ)&&p.typ!=='sondereinsatz').length})</td></tr>}
              {aE.filter(p=>!['abzug','vorschuss_rechnung'].includes(p.typ)&&p.typ!=='sondereinsatz').map((p,i)=><tr key={`e${i}`} style={{background:'#fffbeb',borderBottom:'1px solid #eee'}}><td style={{padding:'4px 6px',color:'#aaa',fontSize:9}}>â€”</td><td colSpan={2} style={{padding:'4px 6px',fontSize:10}}>{p.produkt||p.kunde||p.typ}</td><td style={{padding:'4px 6px',textAlign:'right',fontWeight:600,whiteSpace:'nowrap'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
              {aTB.length>0 && <tr><td colSpan={4} style={{padding:'10px 6px 4px',fontWeight:700,color:'#1e40af',fontSize:10,borderBottom:'2px solid #93c5fd',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ… Team-Bonus ({aTB.length})</td></tr>}
              {aTB.map((p,i)=><tr key={`tb${i}`} style={{background:'#eff6ff',borderBottom:'1px solid #dbeafe'}}><td style={{padding:'4px 6px',color:'#aaa',fontSize:9}}>â€”</td><td colSpan={2} style={{padding:'4px 6px',fontSize:10,color:'#1e40af'}}>{p.produkt} <span style={{fontSize:8,color:'#6b7280'}}>(Details s. Anlage)</span></td><td style={{padding:'4px 6px',textAlign:'right',fontWeight:700,color:'#1e40af',whiteSpace:'nowrap'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
              <tr style={{fontWeight:700,borderTop:'2px solid #333',background:'#f9f9f9'}}><td></td><td colSpan={2} style={{padding:'6px 6px'}}>Netto-Summe</td><td style={{padding:'6px 6px',textAlign:'right',whiteSpace:'nowrap'}}>{fmtE(b.bp+b.es)}</td></tr>
              <tr><td></td><td colSpan={2} style={{padding:'4px 6px',color:'#555',borderTop:'1px solid #ddd'}}>Nettobetrag</td><td style={{padding:'4px 6px',textAlign:'right',borderTop:'1px solid #ddd',whiteSpace:'nowrap'}}>{fmtE(b.net)}</td></tr>
              {hgb&&<tr style={{background:'#fffbeb'}}><td></td><td colSpan={2} style={{padding:'4px 6px',color:'#92400e'}}>+ USt 19%</td><td style={{padding:'4px 6px',textAlign:'right',color:'#92400e',fontWeight:700,whiteSpace:'nowrap'}}>+ {fmtE(b.uB)}</td></tr>}
              <tr style={{background:'linear-gradient(135deg,#f0fdf4,#dcfce7)',borderTop:'2px solid #166534'}}><td></td><td colSpan={2} style={{padding:'7px 6px',fontWeight:800,fontSize:12}}>BRUTTO-AUSZAHLUNG</td><td style={{padding:'7px 6px',textAlign:'right',fontWeight:900,fontSize:13,color:'#166534',whiteSpace:'nowrap'}}>{fmtE(b.aus)}</td></tr>
            </tbody>
          </table>
          {ab.stb_kommentar&&<div style={{marginTop:16,padding:10,background:'#fff8e1',border:'1px solid #fde68a',borderRadius:4,fontSize:10}}><b style={{color:'#92400e'}}>ðŸ“Ž Kommentar Steuerberater:</b><br/>{ab.stb_kommentar}</div>}
          <div style={{marginTop:20,display:'grid',gridTemplateColumns:'1fr 1fr',gap:30}}>
            <div style={{textAlign:'center'}}><div style={{borderBottom:'1px solid #333',height:50,marginBottom:6}}></div><div style={{fontSize:9,color:'#888'}}>Datum, Unterschrift GeschÃ¤ftsfÃ¼hrer</div><div style={{fontSize:9,color:'#555',fontWeight:600}}>bee-doo GmbH</div></div>
            <div style={{textAlign:'center'}}>
              {isF&&<div style={{display:'inline-block',border:'2px solid #166534',color:'#166534',padding:'4px 12px',borderRadius:4,fontWeight:700,fontSize:11,transform:'rotate(-3deg)',marginTop:8}}>âœ“ FREIGEGEBEN</div>}
              {isF&&<div style={{fontSize:9,color:'#166534',marginTop:4}}>{ab.freigegeben_von||'Patrick Grabowski'}<br/>{ab.freigegeben_am?new Date(ab.freigegeben_am).toLocaleDateString('de-DE'):heute}</div>}
              {!isF&&<div style={{height:50,display:'flex',alignItems:'center',justifyContent:'center',color:'#ccc',fontSize:10,fontStyle:'italic'}}>Ausstehend</div>}
              <div style={{fontSize:9,color:'#888'}}>Freigabe-Vermerk</div>
            </div>
          </div>
        </div>
        <FooterBlock/>
      </div>;
    })()}

    {/* === TEAM-BONUS DETAIL (eigene Seite) === */}
    {aTB.length>0&&aTB.map((tbp,tbi)=>{
      let detail=tbp._teamDetail||[];
      let bps=tbp._betragProSale||0;
      if(!detail.length&&tbp.notiz){try{const nd=JSON.parse(tbp.notiz);detail=nd.td||[];bps=nd.bps||0;}catch(e){}}
      return <div key={`tb-page-${tbi}`} className="gs-page" style={{padding:0,display:'flex',flexDirection:'column'}}>
        {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
        <div style={{padding:'14mm 16mm 0',flex:1}}>
          <div style={{fontSize:8.5,color:'#555',borderBottom:'1px solid #ddd',paddingBottom:5,marginBottom:12,display:'flex',justifyContent:'space-between'}}>
            <span>Team-Bonus Detail {lzLabel}</span><span style={{color:'#aaa'}}>{bn} Â· Anlage</span>
          </div>
          <div style={{fontSize:14,fontWeight:700,marginBottom:6}}>ðŸ… Team-Bonus â€“ {ab.mitarbeiter_name}</div>
          <div style={{fontSize:10,color:'#555',marginBottom:16}}>Leistungszeitraum: {lzLabel} Â· {fmtE(bps)} pro Team-Sale</div>
          
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:10}}>
            <thead><tr style={{background:'#eff6ff'}}>
              <th style={{padding:'6px 8px',borderBottom:'2px solid #93c5fd',textAlign:'left',fontSize:9,textTransform:'uppercase',color:'#1e40af',width:30}}>Nr</th>
              <th style={{padding:'6px 8px',borderBottom:'2px solid #93c5fd',textAlign:'left',fontSize:9,textTransform:'uppercase',color:'#1e40af'}}>Team-Mitglied / Kunde</th>
              <th style={{padding:'6px 8px',borderBottom:'2px solid #93c5fd',textAlign:'right',fontSize:9,textTransform:'uppercase',color:'#1e40af',width:80}}>Sales</th>
              <th style={{padding:'6px 8px',borderBottom:'2px solid #93c5fd',textAlign:'right',fontSize:9,textTransform:'uppercase',color:'#1e40af',width:100}}>Bonus</th>
            </tr></thead>
            <tbody>
              {detail.map((d,di)=><React.Fragment key={di}>
                <tr style={{background:'#f8fafc',borderBottom:'1px solid #dbeafe'}}>
                  <td style={{padding:'5px 8px',color:'#1e40af',fontSize:9,fontWeight:700}}>{di+1}.</td>
                  <td style={{padding:'5px 8px',fontWeight:700,color:'#1e40af'}}>{d.name}</td>
                  <td style={{padding:'5px 8px',textAlign:'right',fontWeight:600}}>{d.sales} Sales</td>
                  <td style={{padding:'5px 8px',textAlign:'right',fontWeight:700,color:'#1e40af'}}>{fmtE(d.sales*bps)}</td>
                </tr>
                {(d.orders||[]).map((o,oi)=><tr key={oi} style={{borderBottom:'1px solid #f0f0f0'}}>
                  <td style={{padding:'2px 8px 2px 20px',color:'#9ca3af',fontSize:8}}>Â·</td>
                  <td style={{padding:'2px 8px',fontSize:9,color:'#555'}}>{o.kunde||'â€”'} <span style={{color:'#9ca3af',fontSize:8}}>({o.an||''}{o.kwp?` Â· ${o.kwp} kWp`:''})</span></td>
                  <td></td>
                  <td style={{padding:'2px 8px',textAlign:'right',fontSize:8,color:'#6b7280'}}>{fmtE(bps)}</td>
                </tr>)}
              </React.Fragment>)}
              <tr style={{fontWeight:700,borderTop:'2px solid #1e40af',background:'#eff6ff'}}>
                <td></td>
                <td style={{padding:'6px 8px'}}>Gesamt</td>
                <td style={{padding:'6px 8px',textAlign:'right'}}>{detail.reduce((s,d)=>s+d.sales,0)}</td>
                <td style={{padding:'6px 8px',textAlign:'right',color:'#1e40af',fontSize:12}}>{fmtE(tbp.override_betrag!=null?tbp.override_betrag:tbp.original_betrag)}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <FooterBlock/>
      </div>;
    })}

    {/* === LEAD-BONUS DETAIL (eigene Seiten, paginiert) === */}
    {aLeadBonus.map((lbp,lbi)=>{
      let details=lbp._leadDetails||[];
      let bpl=lbp._betragProLead||0;
      if(!details.length&&lbp.notiz){try{const nd=JSON.parse(lbp.notiz);details=nd.ld||[];bpl=nd.bpl||0;}catch(e){}}
      if(!details.length)return null;
      const MAX_PER_PAGE=40;
      const pages=[];for(let i=0;i<details.length;i+=MAX_PER_PAGE)pages.push(details.slice(i,i+MAX_PER_PAGE));
      if(!pages.length)pages.push([]);
      return pages.map((pageDetails,pi)=><div key={`lead-page-${lbi}-${pi}`} className="gs-page" style={{padding:0,display:'flex',flexDirection:'column'}}>
        {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
        <div style={{padding:'14mm 16mm 0',flex:1}}>
          <div style={{fontSize:8.5,color:'#555',borderBottom:'1px solid #ddd',paddingBottom:5,marginBottom:12,display:'flex',justifyContent:'space-between'}}>
            <span>Lead-Bonus Detail {lzLabel}{pages.length>1?` (${pi+1}/${pages.length})`:''}</span><span style={{color:'#aaa'}}>{bn} Â· Anlage</span>
          </div>
          {pi===0&&<div style={{fontSize:14,fontWeight:700,marginBottom:6}}>ðŸ“‹ Lead-Bonus â€“ {ab.mitarbeiter_name}</div>}
          {pi===0&&<div style={{fontSize:10,color:'#555',marginBottom:12}}>Leistungszeitraum: {lzLabel} Â· {details.length} Leads Ã— {fmtE(bpl)} = {fmtE(lbp.override_betrag!=null?lbp.override_betrag:lbp.original_betrag)}</div>}
          {pi>0&&<div style={{color:'#888',fontSize:9,marginBottom:8}}>Fortsetzung Lead-Liste</div>}
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:9}}>
            <thead><tr style={{background:'#ecfdf5'}}>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #6ee7b7',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#059669',width:24}}>Nr</th>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #6ee7b7',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#059669'}}>Kunde</th>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #6ee7b7',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#059669'}}>Adresse</th>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #6ee7b7',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#059669',width:70}}>Datum</th>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #6ee7b7',textAlign:'right',fontSize:8,textTransform:'uppercase',color:'#059669',width:60}}>Betrag</th>
            </tr></thead>
            <tbody>
              {pageDetails.map((d,di)=><tr key={di} style={{borderBottom:'1px solid #e5e7eb',background:di%2===0?'#f0fdf4':'transparent'}}>
                <td style={{padding:'3px 6px',color:'#9ca3af',fontSize:8}}>{pi*MAX_PER_PAGE+di+1}.</td>
                <td style={{padding:'3px 6px',fontWeight:500,fontSize:9}}>{d.kunde||'â€”'}</td>
                <td style={{padding:'3px 6px',fontSize:8.5,color:'#555'}}>{d.strasse}{d.plz?`, ${d.plz} ${d.ort}`:''}</td>
                <td style={{padding:'3px 6px',fontSize:8.5,color:'#666'}}>{d.datum||'â€”'}</td>
                <td style={{padding:'3px 6px',textAlign:'right',fontSize:8.5,color:'#059669'}}>{fmtE(bpl)}</td>
              </tr>)}
              {pi===pages.length-1&&<tr style={{fontWeight:700,borderTop:'2px solid #059669',background:'#ecfdf5'}}>
                <td></td><td colSpan={3} style={{padding:'5px 6px'}}>Gesamt ({details.length} Leads)</td>
                <td style={{padding:'5px 6px',textAlign:'right',color:'#059669',fontSize:11}}>{fmtE(lbp.override_betrag!=null?lbp.override_betrag:lbp.original_betrag)}</td>
              </tr>}
            </tbody>
          </table>
        </div>
        <FooterBlock/>
      </div>);
    })}

    {/* === TERMIN-BONUS DETAIL (eigene Seiten, paginiert) === */}
    {aTerminBonus.map((tbp2,tbi)=>{
      let details=tbp2._terminDetails||[];
      let bpt=tbp2._betragProTermin||0;
      if(!details.length&&tbp2.notiz){try{const nd=JSON.parse(tbp2.notiz);details=nd.td||[];bpt=nd.bpt||0;}catch(e){}}
      if(!details.length)return null;
      const MAX_PER_PAGE=40;
      const pages=[];for(let i=0;i<details.length;i+=MAX_PER_PAGE)pages.push(details.slice(i,i+MAX_PER_PAGE));
      if(!pages.length)pages.push([]);
      return pages.map((pageDetails,pi)=><div key={`termin-page-${tbi}-${pi}`} className="gs-page" style={{padding:0,display:'flex',flexDirection:'column'}}>
        {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
        <div style={{padding:'14mm 16mm 0',flex:1}}>
          <div style={{fontSize:8.5,color:'#555',borderBottom:'1px solid #ddd',paddingBottom:5,marginBottom:12,display:'flex',justifyContent:'space-between'}}>
            <span>Termin-Bonus Detail {lzLabel}{pages.length>1?` (${pi+1}/${pages.length})`:''}</span><span style={{color:'#aaa'}}>{bn} Â· Anlage</span>
          </div>
          {pi===0&&<div style={{fontSize:14,fontWeight:700,marginBottom:6}}>ðŸ“… Termin-Bonus â€“ {ab.mitarbeiter_name}</div>}
          {pi===0&&<div style={{fontSize:10,color:'#555',marginBottom:12}}>Leistungszeitraum: {lzLabel} Â· {details.length} Termine Ã— {fmtE(bpt)} = {fmtE(tbp2.override_betrag!=null?tbp2.override_betrag:tbp2.original_betrag)}</div>}
          {pi>0&&<div style={{color:'#888',fontSize:9,marginBottom:8}}>Fortsetzung Termin-Liste</div>}
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:9}}>
            <thead><tr style={{background:'#eff6ff'}}>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #93c5fd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#2563eb',width:24}}>Nr</th>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #93c5fd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#2563eb'}}>Kunde</th>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #93c5fd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#2563eb'}}>Adresse</th>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #93c5fd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#2563eb',width:90}}>Datum</th>
              <th style={{padding:'4px 6px',borderBottom:'2px solid #93c5fd',textAlign:'right',fontSize:8,textTransform:'uppercase',color:'#2563eb',width:60}}>Betrag</th>
            </tr></thead>
            <tbody>
              {pageDetails.map((d,di)=><tr key={di} style={{borderBottom:'1px solid #e5e7eb',background:di%2===0?'#eff6ff':'transparent'}}>
                <td style={{padding:'3px 6px',color:'#9ca3af',fontSize:8}}>{pi*MAX_PER_PAGE+di+1}.</td>
                <td style={{padding:'3px 6px',fontWeight:500,fontSize:9}}>{d.kunde||'â€”'}</td>
                <td style={{padding:'3px 6px',fontSize:8.5,color:'#555'}}>{d.adresse||'â€”'}</td>
                <td style={{padding:'3px 6px',fontSize:8.5,color:'#666'}}>{d.datum||'â€”'}</td>
                <td style={{padding:'3px 6px',textAlign:'right',fontSize:8.5,color:'#2563eb'}}>{fmtE(bpt)}</td>
              </tr>)}
              {pi===pages.length-1&&<tr style={{fontWeight:700,borderTop:'2px solid #2563eb',background:'#eff6ff'}}>
                <td></td><td colSpan={3} style={{padding:'5px 6px'}}>Gesamt ({details.length} Termine)</td>
                <td style={{padding:'5px 6px',textAlign:'right',color:'#2563eb',fontSize:11}}>{fmtE(tbp2.override_betrag!=null?tbp2.override_betrag:tbp2.original_betrag)}</td>
              </tr>}
            </tbody>
          </table>
        </div>
        <FooterBlock/>
      </div>);
    })}

    {/* === STAFFEL-KORREKTUR (eigene Seite) === */}
    {aSK.length>0&&<div className="gs-page" style={{padding:0,display:'flex',flexDirection:'column'}}>
      {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
      <div style={{padding:'14mm 16mm 0',flex:1}}>
        <div style={{fontSize:8.5,color:'#555',borderBottom:'1px solid #ddd',paddingBottom:5,marginBottom:12,display:'flex',justifyContent:'space-between'}}>
          <span>Staffel-Korrektur</span><span style={{color:'#aaa'}}>{bn} Â· Anlage</span>
        </div>
        <div style={{fontSize:14,fontWeight:700,marginBottom:10}}>{ab.mitarbeiter_name} â€“ RÃ¼ckwirkende Staffel-Korrektur</div>
        <div style={{fontSize:9.5,color:'#555',marginBottom:14,padding:8,background:'#f8fafc',borderRadius:6,border:'1px solid #e2e8f0'}}>
          Durch NachzÃ¼gler oder Stornos aus Vormonaten hat sich die Staffel-/Stufenzuordnung fÃ¼r bereits abgerechnete Monate geÃ¤ndert. Die folgenden Korrekturen gleichen die Differenz aus.
        </div>

        {aSKN.length>0&&<>
          <div style={{fontWeight:700,color:'#166534',fontSize:11,marginBottom:6,paddingBottom:3,borderBottom:'2px solid #bbf7d0',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ“ˆ Nachzahlungen â€“ Staffel/Stufen rÃ¼ckwirkend ({aSKN.length})</div>
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:9.5,marginBottom:16}}>
            <thead><tr style={{background:'#f0fdf4'}}><th style={{padding:'5px 6px',textAlign:'left',fontSize:8,color:'#166534',borderBottom:'1px solid #bbf7d0'}}>Korrektur</th><th style={{padding:'5px 6px',textAlign:'left',fontSize:8,color:'#166534',borderBottom:'1px solid #bbf7d0'}}>Betroffene AuftrÃ¤ge</th><th style={{padding:'5px 6px',textAlign:'right',fontSize:8,color:'#166534',borderBottom:'1px solid #bbf7d0',width:80}}>Betrag</th></tr></thead>
            <tbody>
            {aSKN.map((p,i) => <tr key={i} style={{background:i%2===0?'#f0fdf4':'transparent',borderBottom:'1px solid #dcfce7'}}>
              <td style={{padding:'5px 6px',color:'#166534',fontWeight:600}}>{p.produkt}</td>
              <td style={{padding:'5px 6px',color:'#555',fontSize:8.5}}>{p.notiz}</td>
              <td style={{padding:'5px 6px',textAlign:'right',fontWeight:700,color:'#166534',whiteSpace:'nowrap'}}>+ {fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td>
            </tr>)}
            <tr style={{borderTop:'2px solid #166534',background:'#dcfce7'}}><td colSpan={2} style={{padding:'6px',fontWeight:700,color:'#166534'}}>Summe Nachzahlungen</td><td style={{padding:'6px',textAlign:'right',fontWeight:800,color:'#166534',whiteSpace:'nowrap'}}>+ {fmtE(aSKN.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0))}</td></tr>
            </tbody>
          </table>
        </>}

        {aSKR.length>0&&<>
          <div style={{fontWeight:700,color:'#991b1b',fontSize:11,marginBottom:6,paddingBottom:3,borderBottom:'2px solid #fecaca',textTransform:'uppercase',letterSpacing:'.5px'}}>ðŸ“‰ RÃ¼ckforderungen â€“ Storno/Staffel/Stufen ({aSKR.length})</div>
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:9.5,marginBottom:16}}>
            <thead><tr style={{background:'#fef2f2'}}><th style={{padding:'5px 6px',textAlign:'left',fontSize:8,color:'#991b1b',borderBottom:'1px solid #fecaca'}}>Korrektur</th><th style={{padding:'5px 6px',textAlign:'left',fontSize:8,color:'#991b1b',borderBottom:'1px solid #fecaca'}}>Betroffene AuftrÃ¤ge</th><th style={{padding:'5px 6px',textAlign:'right',fontSize:8,color:'#991b1b',borderBottom:'1px solid #fecaca',width:80}}>Betrag</th></tr></thead>
            <tbody>
            {aSKR.map((p,i) => <tr key={i} style={{background:i%2===0?'#fef2f2':'transparent',borderBottom:'1px solid #fecaca'}}>
              <td style={{padding:'5px 6px',color:'#991b1b',fontWeight:600}}>{p.produkt}</td>
              <td style={{padding:'5px 6px',color:'#555',fontSize:8.5}}>{p.notiz}</td>
              <td style={{padding:'5px 6px',textAlign:'right',fontWeight:700,color:'#991b1b',whiteSpace:'nowrap'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td>
            </tr>)}
            <tr style={{borderTop:'2px solid #991b1b',background:'#fecaca'}}><td colSpan={2} style={{padding:'6px',fontWeight:700,color:'#991b1b'}}>Summe RÃ¼ckforderungen</td><td style={{padding:'6px',textAlign:'right',fontWeight:800,color:'#991b1b',whiteSpace:'nowrap'}}>{fmtE(aSKR.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0))}</td></tr>
            </tbody>
          </table>
        </>}

        <div style={{marginTop:12,padding:10,background:skTotal>=0?'#f0fdf4':'#fef2f2',borderRadius:6,border:`1px solid ${skTotal>=0?'#bbf7d0':'#fecaca'}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span style={{fontWeight:700,fontSize:11,color:skTotal>=0?'#166534':'#991b1b'}}>Netto-Auswirkung Staffel-Korrektur</span>
          <span style={{fontWeight:800,fontSize:14,color:skTotal>=0?'#166534':'#991b1b'}}>{skTotal>=0?'+ ':''}  {fmtE(skTotal)}</span>
        </div>
      </div>
      <FooterBlock/>
    </div>}

    {/* === STORNIERTE + OFFENE AUFTRÃ„GE (eigene Seite(n)) === */}
    {(aSt.length>0||aOf.length>0||aOH.length>0)&&(()=>{
      const items = [];
      if(aStLZ.length>0) items.push({title:`âŒ Stornierte AuftrÃ¤ge â€“ ${lzLabel}`,color:'#da3633',bg:'#fef2f2',border:'#fecaca',data:aStLZ});
      if(aOfLZ.length>0) items.push({title:`â³ Offene AuftrÃ¤ge â€“ ${lzLabel}`,color:'#6b7280',bg:'#f9fafb',border:'#e5e7eb',data:aOfLZ});
      if(aOfVM.length>0) items.push({title:`â³ Offene AuftrÃ¤ge â€“ Vormonate`,color:'#4b5563',bg:'#f9fafb',border:'#e5e7eb',data:aOfVM});
      if(aOH.length>0) items.push({title:`â¸ï¸ On Hold â€“ Montage gestoppt`,color:'#6366f1',bg:'#eef2ff',border:'#c7d2fe',data:aOH});
      // Paginate: ~35 rows per page
      const allRows = [];
      items.forEach(cat => { allRows.push({type:'header',cat}); cat.data.forEach(p => allRows.push({type:'row',cat,p})); });
      const ROWS_PER = 35;
      const infoPages = [];
      for(let i=0;i<allRows.length;i+=ROWS_PER) infoPages.push(allRows.slice(i,i+ROWS_PER));
      return infoPages.map((pageRows,pi) => <div key={`info-${pi}`} className="gs-page" style={{padding:0,display:'flex',flexDirection:'column'}}>
        {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
        <div style={{padding:'14mm 16mm 0',flex:1}}>
          <div style={{fontSize:8.5,color:'#555',borderBottom:'1px solid #ddd',paddingBottom:5,marginBottom:12,display:'flex',justifyContent:'space-between'}}>
            <span>AuftragsÃ¼bersicht {lzLabel}</span><span style={{color:'#aaa'}}>{bn} Â· Anlage</span>
          </div>
          {pi===0&&<div style={{fontSize:14,fontWeight:700,marginBottom:10}}>{ab.mitarbeiter_name} â€“ AuftragsÃ¼bersicht</div>}
          {pi>0&&<div style={{fontSize:9,color:'#888',marginBottom:8}}>Fortsetzung AuftragsÃ¼bersicht</div>}
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:9.5}}>
            <tbody>
            {pageRows.map((row,ri) => {
              if(row.type==='header') return <tr key={ri}><td colSpan={4} style={{padding:'10px 6px 4px',fontWeight:700,color:row.cat.color,fontSize:10,borderBottom:`2px solid ${row.cat.border}`,textTransform:'uppercase',letterSpacing:'0.5px'}}>{row.cat.title} ({row.cat.data.length})</td></tr>;
              const p = row.p;
              return <tr key={ri} style={{background:row.cat.bg,borderBottom:`1px solid ${row.cat.border}`}}>
                <td style={{padding:'4px 6px',color:row.cat.color,fontSize:9,width:70}}>{p.auftrag_nr}</td>
                <td style={{padding:'4px 6px',color:row.cat.color}}>{p.kunde||'â€”'}</td>
                <td style={{padding:'4px 6px',color:row.cat.color,fontSize:8.5,width:90}}>{p.produkt?.replace('Storno â€“ ','').replace('Offen â€“ ','').replace('On Hold â€“ ','')}</td>
                <td style={{padding:'4px 6px',color:row.cat.color,fontSize:8.5,width:70,textAlign:'right'}}>{(p.notiz||'').replace(' â˜…VM','').replace(' â˜…NZ','')}</td>
              </tr>;
            })}
            </tbody>
          </table>
          {pi===infoPages.length-1&&<div style={{marginTop:14,padding:8,background:'#f0f0f0',borderRadius:4,fontSize:8.5,color:'#666'}}>
            <b>Hinweis:</b> Stornierte, offene und on-hold AuftrÃ¤ge werden nicht ausgezahlt und flieÃŸen nicht in die Staffelberechnung ein. On-Hold-AuftrÃ¤ge werden bei Wiederaufnahme der Montage (Baustelle gestartet) in der nÃ¤chsten Abrechnung nachgeholt.
          </div>}
        </div>
        <FooterBlock/>
      </div>);
    })()}

    {/* === SYSTEMGEBÃœHR-RECHNUNG (nur HGB) === */}
    {hgb&&b.sgN>0&&<div className="gs-page" style={{padding:'14mm 16mm 28mm'}}>
      <div className="gs-branded-header" style={{background:'#2d2d2d'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
          <div>
            <div style={{fontFamily:"'Arial Black',Arial",fontSize:28,fontWeight:900,letterSpacing:-1,color:'#fff'}}>bee<span style={{color:'#fff'}}>-doo</span></div>
            <div style={{fontSize:8,color:'rgba(26,18,0,.45)',letterSpacing:2,textTransform:'uppercase',marginTop:2}}>Energy for you</div>
          </div>
          <div style={{textAlign:'right',fontSize:11}}>
            <div><span style={{color:'rgba(26,18,0,.5)',fontSize:9}}>Rechnungsdatum</span><br/><b>{heute}</b></div>
          </div>
        </div>
        <div style={{fontSize:16,fontWeight:700,marginTop:10,letterSpacing:.5,color:'#fff'}}>Rechnung SystemgebÃ¼hr â€“ verrechnet</div>
        <div style={{fontSize:10,color:'rgba(26,18,0,.5)',marginTop:2}}>Rechnungsnr.: SG-{bn} Â· {pLabel(ab.periode)}</div>
      </div>

      <div className="gs-body">
        <div style={{fontSize:8.5,color:'#888',borderBottom:'1px dotted #ccc',paddingBottom:4,marginBottom:8}}>bee-doo GmbH Â· Am Stadtholz 39 Â· D-33609 Bielefeld</div>
        <div style={{fontSize:11,color:'#888',marginBottom:4}}>Rechnung an:</div>
        <div style={{fontSize:12,fontWeight:700,marginBottom:2}}>{ab.mitarbeiter_name}</div>
        <div style={{fontSize:11,color:'#444',lineHeight:1.7,marginBottom:2}}>{window.__vpData?.strasse?`${window.__vpData.strasse} ${window.__vpData.hausnr||''}`:'â€”'}<br/>{window.__vpData?.plz?`${window.__vpData.plz} ${window.__vpData.ort||''}`:'â€”'}</div>
        <div style={{fontSize:9.5,color:'#888',marginBottom:14}}>{(()=>{const vp=window.__vpData;const uid=vp?.ustid&&/^DE\d{9}$/.test(vp.ustid)?vp.ustid:null;return uid?`USt-IdNr.: ${uid}`:'';})()}</div>
        <div style={{borderTop:'1px solid #eee',marginBottom:12}}></div>

        <div style={{fontSize:13,fontWeight:700,marginBottom:4}}>Rechnung: SystemgebÃ¼hr gem. Ziff. 4.2 HVV</div>
        <div style={{fontSize:10,color:'#666',marginBottom:14}}>Leistungszeitraum: {lzLabel} Â· Bezug: Gutschrift {bn}</div>

        <table style={{width:'100%',borderCollapse:'collapse',fontSize:11,marginBottom:20}}>
          <thead><tr style={{background:'#f5f5f5'}}><th style={{padding:'8px 10px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:9,textTransform:'uppercase',color:'#888'}}>Beschreibung</th><th style={{padding:'8px 10px',borderBottom:'2px solid #ddd',textAlign:'right',fontSize:9,textTransform:'uppercase',color:'#888'}}>Betrag</th></tr></thead>
          <tbody>
            <tr><td style={{padding:'8px 10px',borderBottom:'1px solid #eee'}}>SystemgebÃ¼hr fÃ¼r Nutzung der bee-doo Vertriebsplattform<br/><span style={{fontSize:9,color:'#888'}}>3% auf Gesamtumsatz ({fmtE(b.net)}), max. 200,00 â‚¬ netto</span></td><td style={{padding:'8px 10px',borderBottom:'1px solid #eee',textAlign:'right',fontWeight:600,whiteSpace:'nowrap'}}>{fmtE(b.sgN)}</td></tr>
            <tr><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',color:'#555'}}>Nettobetrag</td><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtE(b.sgN)}</td></tr>
            <tr style={{background:'#fffbeb'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #fde68a',color:'#92400e',fontWeight:600}}>+ Umsatzsteuer 19%</td><td style={{padding:'6px 10px',borderBottom:'1px solid #fde68a',textAlign:'right',color:'#92400e',fontWeight:600}}>+ {fmtE(b.sgU)}</td></tr>
            <tr style={{background:'linear-gradient(135deg,#fff7ed,#ffedd5)'}}><td style={{padding:'9px 10px',fontWeight:800,fontSize:13,color:'#9a3412'}}>RECHNUNGSBETRAG</td><td style={{padding:'9px 10px',textAlign:'right',fontWeight:800,fontSize:13,color:'#9a3412'}}>{fmtE(b.sgN+b.sgU)}</td></tr>
          </tbody>
        </table>

        <div style={{background:'#f0fdf4',border:'1px solid #bbf7d0',borderRadius:6,padding:'8px 12px',fontSize:10,marginBottom:16}}>
          <b style={{color:'#166534'}}>âœ… Verrechnung:</b> <span style={{color:'#15803d'}}>Dieser Betrag wurde mit der Gutschrift {bn} verrechnet und ist bereits in der Auszahlungssumme berÃ¼cksichtigt.</span>
        </div>

        <div style={{fontSize:10,color:'#555',lineHeight:1.6,borderTop:'1px solid #eee',paddingTop:10,marginBottom:10}}>
          Der Rechnungsbetrag ({fmtE(b.sgN+b.sgU)}) wurde mit der Gutschrift {bn} verrechnet. Keine separate Zahlung erforderlich.
        </div>
        <div style={{fontSize:9,color:'#888',lineHeight:1.5}}>
          Rechnungsaussteller: bee-doo GmbH, Am Stadtholz 39, 33609 Bielefeld, StNr. 44/214/0394, USt-IdNr. DE323940446.
          GeschÃ¤ftsfÃ¼hrer: Patrick Grabowski, Olaf Schader. HRB 46243 AG Bielefeld.
        </div>
        <FooterBlock/>
      </div>
    </div>}
  </div>;
}

function EditPanel({ab,pos,setPos,sg,onSave,onFrei,onPdf,onClose,setAb}){
  const b=calc(pos,sg,(ab.beschaeftigungsart||'').includes('hgb'));
  const prov=pos.filter(p=>['provision','eigenlead','empfehlung','speicher','sondereinsatz','lead_bonus','termin_bonus','zero_bonus'].includes(p.typ));
  const extra=pos.filter(p=>['einmalzahlung','abzug','sonstiges','team_bonus'].includes(p.typ));
  const lo=ab.status==='freigegeben'||ab.status==='ausgezahlt';
  const tgl=(i)=>{if(lo)return;const n=[...pos];n[i]={...n[i],aktiv:!n[i].aktiv};setPos(n);};
  const ovr=(i,v)=>{if(lo)return;const n=[...pos];n[i]={...n[i],override_betrag:v===''?null:parseFloat(v.replace(',','.'))||0};setPos(n);};
  const zur=(i)=>{if(lo)return;const n=[...pos];n[i]={...n[i],zurueckgestellt:!n[i].zurueckgestellt,aktiv:n[i].zurueckgestellt};setPos(n);};
  const addE=(t)=>setPos([...pos,{typ:t,auftrag_nr:'',kunde:'',produkt:'',original_betrag:0,override_betrag:null,aktiv:true,zurueckgestellt:false,notiz:'',isNew:true}]);
  const rmE=(i)=>{const n=[...pos];n.splice(i,1);setPos(n);};
  const upE=(i,f,v)=>{const n=[...pos];n[i]={...n[i],[f]:f==='original_betrag'?(parseFloat(v.replace(',','.'))||0):v};setPos(n);};

  return <div className="edit-panel">
    <div className="edit-section">
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
        <span className={`badge badge-${ab.status==='probeabrechnung'?'probe':ab.status}`}>{ab.status==='entwurf'?'ðŸ“ Entwurf':ab.status==='probeabrechnung'?'ðŸ” Probe':ab.status==='freigegeben'?'âœ… Freigegeben':'ðŸ’¸ Ausgezahlt'}</span>
        <span style={{fontSize:11,color:'#8b949e'}}>{ab.mitarbeiter_name}</span>
      </div>
      <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
        <button className="btn btn-primary btn-sm" onClick={onSave} disabled={lo}>ðŸ’¾ Speichern</button>
        {!lo&&<button className="btn btn-success btn-sm" onClick={onFrei}>âœ… Freigeben</button>}
        {ab.status==='freigegeben'&&<button className="btn btn-sm" style={{background:'#1f6feb',color:'#fff'}} onClick={()=>{setAb(p=>({...p,status:'ausgezahlt',ausgezahlt_am:new Date().toISOString()}));setTimeout(onSave,100);}}>ðŸ’¸ Ausgezahlt</button>}
        <button className="btn btn-secondary btn-sm" onClick={onPdf}>ðŸ“„ PDF</button>
      </div>
    </div>
    <div className="edit-section">
      <div className="edit-section-title">ðŸ’° Zusammenfassung</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}><div style={{fontSize:10,color:'#8b949e'}}>Sales</div><div style={{fontSize:18,fontWeight:700,color:'#F5C500'}}>{b.sales}</div></div>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}><div style={{fontSize:10,color:'#8b949e'}}>Auszahlung</div><div style={{fontSize:16,fontWeight:700,color:'#3fb950'}}>{fmtE(b.aus)}</div></div>
      </div>
    </div>
    <div className="edit-section">
      <div className="edit-section-title">ðŸ“‹ Provisionen ({prov.filter(p=>p.aktiv&&!p.zurueckgestellt).length}/{prov.length})</div>
      {prov.map((p,i)=>{const gi=pos.indexOf(p);return <div key={i} className={`pos-row ${!p.aktiv?'inactive':''}`}>
        <button className={`toggle-btn ${p.aktiv?'active':'inactive-toggle'}`} onClick={()=>tgl(gi)} disabled={lo}/>
        <div className="pos-kunde" style={{fontSize:11}}>{p.kunde||'â€”'}{p.zurueckgestellt&&<span style={{fontSize:9,background:'#30363d',color:'#8b949e',padding:'1px 6px',borderRadius:3,marginLeft:6}}>â¸</span>}</div>
        <div className="pos-betrag" style={p.override_betrag!=null?{color:'#F5C500'}:{}}>{!lo?<input className="override-input" value={p.override_betrag!=null?p.override_betrag:p.original_betrag} onChange={e=>ovr(gi,e.target.value)}/>:<span>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</span>}</div>
        {!lo&&<button className="btn btn-sm" style={{padding:'2px 6px',fontSize:10,background:p.zurueckgestellt?'#238636':'#30363d',color:p.zurueckgestellt?'#fff':'#8b949e'}} onClick={()=>zur(gi)}>â¸</button>}
      </div>;})}
    </div>
    <div className="edit-section">
      <div className="edit-section-title">âž• Einmalzahlungen / AbzÃ¼ge</div>
      {extra.map((p,i)=>{const gi=pos.indexOf(p);return <div key={i} className="extra-row">
        <input className="extra-input" placeholder="Bezeichnung" value={p.kunde||p.notiz||''} onChange={e=>upE(gi,'kunde',e.target.value)} disabled={lo}/>
        <input className="extra-input extra-amount" placeholder="Betrag" value={p.original_betrag||''} onChange={e=>upE(gi,'original_betrag',e.target.value)} disabled={lo}/>
        <select className="extra-input" style={{width:90}} value={p.typ} onChange={e=>upE(gi,'typ',e.target.value)} disabled={lo}><option value="einmalzahlung">+ Zahlung</option><option value="abzug">âˆ’ Abzug</option><option value="sonstiges">Sonstiges</option></select>
        {!lo&&<button className="btn btn-danger btn-sm btn-icon" onClick={()=>rmE(gi)}>âœ•</button>}
      </div>;})}
      {!lo&&<div style={{display:'flex',gap:6}}><button className="btn btn-secondary btn-sm" onClick={()=>addE('einmalzahlung')}>+ Zahlung</button><button className="btn btn-secondary btn-sm" onClick={()=>addE('abzug')}>âˆ’ Abzug</button></div>}
    </div>
    <div className="edit-section"><div className="edit-section-title">ðŸ“ Notizen</div><textarea className="notes-area" placeholder="Notizen..." value={ab.notizen||''} onChange={e=>setAb(p=>({...p,notizen:e.target.value}))} disabled={lo}/></div>
    <div className="edit-section"><div className="edit-section-title">ðŸ“Ž Steuerberater</div><textarea className="notes-area" placeholder="Kommentar..." value={ab.stb_kommentar||''} onChange={e=>setAb(p=>({...p,stb_kommentar:e.target.value}))} disabled={lo}/></div>
  </div>;
}

function DetailView({aId,per,vtN,vtD,sg,onClose,onRef}){
  const[ab,setAb]=useState(null);const[pos,setPos]=useState([]);const[ld,setLd]=useState(true);const ref=useRef(null);
  useEffect(()=>{load();},[aId]);
  const load=async()=>{setLd(true);try{
    // VP-Stammdaten laden
    const nameParts=vtN.trim().split(/\s+/);const vn=nameParts[0];const nn=nameParts.slice(1).join(' ');
    const vpArr=await sbG('pay_mitarbeiter',`vorname=eq.${encodeURIComponent(vn)}&nachname=eq.${encodeURIComponent(nn)}&limit=1`).catch(()=>[]);
    const vp=vpArr[0]||null;if(vp)window.__vpData=vp;
    if(aId){const[a,p]=await Promise.all([sbG('pay_abrechnungen',`id=eq.${aId}`),sbG('pay_abrechnungen_positionen',`abrechnung_id=eq.${aId}&order=erstellt_am.asc`)]);if(a.length){setAb(a[0]);setPos(p);}}else{setAb({periode:per,mitarbeiter_name:vtN,kuerzel:vp?.kuerzel||gK(vtN),beschaeftigungsart:vp?.typ?.startsWith('hgb')?'hgb':'angestellt',status:'entwurf',notizen:'',stb_kommentar:''});setPos((vtD||[]).map(d=>({typ:'provision',auftrag_nr:'',kunde:d.kunde,produkt:d.produkt,original_betrag:d.netto,override_betrag:null,aktiv:true,zurueckgestellt:false,notiz:'',isNew:true})));}}catch(e){window.__t?.('Fehler: '+e.message,'error');}setLd(false);};

  const save=async()=>{try{const b=calc(pos,sg,(ab.beschaeftigungsart||'').includes('hgb'));const d={...ab,anzahl_sales:b.sales,brutto_provisionen:b.bp,systemgebuehr_netto:b.sgN,systemgebuehr_ust:b.sgU,einmalzahlungen_summe:b.es,nettobetrag:b.net,ust_satz:b.uS,ust_betrag:b.uB,auszahlungssumme:b.aus,belegnummer:gBN(ab.periode,ab.kuerzel||gK(ab.mitarbeiter_name),1),geaendert_am:new Date().toISOString()};
  let s;if(ab.id){const{id,erstellt_am,...u}=d;s=(await sbU('pay_abrechnungen',`id=eq.${ab.id}`,u))[0];await sbD('pay_abrechnungen_positionen',`abrechnung_id=eq.${ab.id}`);}else{const{id,...ins}=d;s=(await sbP('pay_abrechnungen',ins))[0];}
  const pd=pos.map(p=>({abrechnung_id:s.id,typ:p.typ,auftrag_nr:p.auftrag_nr,kunde:p.kunde,produkt:p.produkt,original_betrag:p.original_betrag,override_betrag:p.override_betrag,aktiv:p.aktiv,zurueckgestellt:p.zurueckgestellt,notiz:p.notiz}));
  if(pd.length){const sp=await sbP('pay_abrechnungen_positionen',pd);setPos(sp);}setAb(s);window.__t?.('âœ… Gespeichert');onRef?.();}catch(e){window.__t?.('Fehler: '+e.message,'error');}};

  const frei=async()=>{if(!confirm(`${ab.mitarbeiter_name} (${ab.periode}) freigeben?\n\nDanach keine Ã„nderungen mehr mÃ¶glich!`))return;setAb(p=>({...p,status:'freigegeben',freigegeben_am:new Date().toISOString(),freigegeben_von:'Patrick Grabowski'}));setTimeout(save,100);};
  const pdf=async()=>{
    const pages=ref.current?.querySelectorAll('.gs-page');
    if(!pages?.length)return;
    window.__t?.('PDF wird erstellt...');
    try{
      const c=document.createElement('div');
      pages.forEach((p,i)=>{const cl=p.cloneNode(true);cl.style.boxShadow='none';cl.style.margin='0';cl.style.gap='0';if(i>0)cl.style.pageBreakBefore='always';c.appendChild(cl);});
      // Dateiname: "Abrechnung Januar 2026 Max Mustermann.pdf"
      const monate=['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
      const lzParts=ab.periode?ab.periode.split('/'):[];
      let lzMonat='',lzJahr='';
      if(lzParts.length===2){const pY=parseInt(lzParts[0]),pM=parseInt(lzParts[1])-2;const lzD=new Date(pY,pM,1);lzMonat=monate[lzD.getMonth()];lzJahr=lzD.getFullYear();}
      const safeName=(ab.mitarbeiter_name||'Unbekannt').replace(/[^a-zA-ZÃ¤Ã¶Ã¼Ã„Ã–ÃœÃŸ\s-]/g,'').trim();
      const fname=`Abrechnung ${lzMonat} ${lzJahr} ${safeName}.pdf`;
      await html2pdf().set({margin:0,filename:fname,image:{type:'jpeg',quality:.95},html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff'},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},pagebreak:{mode:['css']}}).from(c).save();
      window.__t?.('âœ… PDF heruntergeladen');
    }catch(e){console.error('PDF Error:',e);window.__t?.('PDF-Fehler: '+e.message,'error');}
  };

  if(ld)return<div className="detail-overlay"><div className="detail-container"><div className="loading"><div className="spinner"/>Lade...</div></div></div>;
  if(!ab)return null;
  return<div className="detail-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
    <div className="detail-container">
      <div className="detail-header"><div style={{display:'flex',alignItems:'center',gap:12}}><button className="btn btn-secondary btn-sm" onClick={onClose}>â† ZurÃ¼ck</button><span style={{fontWeight:700,fontSize:15}}>{ab.mitarbeiter_name}</span><span className={`badge badge-${ab.status==='probeabrechnung'?'probe':ab.status}`}>{ab.status}</span></div><div style={{fontSize:12,color:'#8b949e'}}>{pLabel(ab.periode)}</div></div>
      <div className="detail-body">
        <EditPanel ab={ab} pos={pos} setPos={setPos} sg={sg} onSave={save} onFrei={frei} onPdf={pdf} onClose={onClose} setAb={setAb}/>
        <div className="preview-panel" ref={ref}><GutschriftPreview ab={ab} pos={pos} sg={sg}/></div>
      </div>
    </div>
  </div>;
}

function App(){
  const[per,setPer]=useState('');const[pers,setPers]=useState([]);const[abrs,setAbrs]=useState([]);const[ausz,setAusz]=useState([]);const[sg,setSg]=useState(null);const[ld,setLd]=useState(true);const[sel,setSel]=useState(null);const[genMsg,setGenMsg]=useState('');const[genBusy,setGenBusy]=useState(false);const[berOpen,setBerOpen]=useState(false);const[katFilter,setKatFilter]=useState('alle');const[maArr,setMaArr]=useState([]);const[hcWarnings,setHcWarnings]=useState([]);const[hcOpen,setHcOpen]=useState(false);const[hcBusy,setHcBusy]=useState(false);

  useEffect(()=>{(async()=>{try{const d=await sbG('pay_auszahlungen_historie','select=periode&order=periode.desc');const u=[...new Set(d.map(x=>x.periode))];const now=new Date();const cp=`${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}`;if(!u.includes(cp))u.unshift(cp);const sorted=u.sort().reverse();setPers(sorted);setPer(sorted[0]||cp);}catch(e){const now=new Date();const p=`${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}`;setPers([p]);setPer(p);}})();},[]);

  const loadP=useCallback(async()=>{if(!per)return;setLd(true);try{const[a,z,s,ma]=await Promise.all([sbG('pay_abrechnungen',`periode=eq.${per}&archiviert_am=is.null&order=mitarbeiter_name.asc`),sbG('pay_auszahlungen_historie',`periode=eq.${per}&order=vertriebler.asc`),sbG('pay_systemgebuehr','aktiv=eq.true&limit=1'),sbG('pay_mitarbeiter','aktiv=eq.true&select=id,vorname,nachname,strasse,plz,ort,steuernummer,typ,mwst_pflichtig,iban,bic,kuerzel,firmenname,ustid,hausnr')]);setAbrs(a);setAusz(z);setSg(s[0]||null);setMaArr(ma);}catch(e){window.__t?.('Fehler: '+e.message,'error');}setLd(false);},[per]);
  useEffect(()=>{loadP();},[loadP]);

  // Partner-Daten Lookup
  const maByName=useMemo(()=>{const m={};maArr.forEach(v=>{m[`${v.vorname} ${v.nachname}`]=v;});return m;},[maArr]);
  const getMissing=(name)=>{
    const v=maByName[name]; if(!v) return['Kein Mitarbeiter-Datensatz'];
    const f=[];const isHGB=(v.typ||'').includes('hgb');
    if(!v.strasse||v.strasse.trim().length<3) f.push('StraÃŸe');
    if(!v.plz||v.plz.trim().length<4) f.push('PLZ');
    if(!v.ort||v.ort.trim().length<2) f.push('Ort');
    if(isHGB&&(!v.steuernummer||v.steuernummer.trim().length<5)&&!(v.steuernummer||'').match(/\d/)) f.push('Steuernr.');
    if(!v.iban||v.iban.trim().length<15) f.push('IBAN');
    return f;
  };

  const vtG=useMemo(()=>{const g={};ausz.forEach(a=>{const n=a.vertriebler;if(!g[n])g[n]={name:n,items:[],total:0};g[n].items.push(a);g[n].total+=parseFloat(a.netto)||0;});abrs.forEach(ab=>{if(!g[ab.mitarbeiter_name])g[ab.mitarbeiter_name]={name:ab.mitarbeiter_name,items:[],total:ab.brutto_provisionen||0};g[ab.mitarbeiter_name].abrechnung=ab;g[ab.mitarbeiter_name].kategorie=(ab.beschaeftigungsart||'').includes('scouter')?'scouter':'vertriebler';});return Object.values(g).sort((a,b)=>b.total-a.total);},[ausz,abrs]);
  const vtGFiltered=useMemo(()=>katFilter==='alle'?vtG:vtG.filter(g=>g.kategorie===katFilter),[vtG,katFilter]);
  const vtCount=vtG.filter(g=>g.kategorie==='vertriebler').length;
  const scCount=vtG.filter(g=>g.kategorie==='scouter').length;
  const totA=abrs.reduce((s,a)=>s+(parseFloat(a.auszahlungssumme)||0),0);const frg=abrs.filter(a=>a.status==='freigegeben'||a.status==='ausgezahlt').length;
  const incompleteCount=vtG.filter(g=>getMissing(g.name).length>0).length;

  const alleErstellen=async()=>{const tc=vtG.filter(g=>!g.abrechnung);if(!confirm(`Probeabrechnungen fÃ¼r ${tc.length} VTs erstellen?`))return;window.__t?.('Erstelle...');let c=0;
  for(const g of tc){try{const k=gK(g.name);const pd=g.items.map(item=>({typ:'provision',kunde:item.kunde||'â€”',produkt:item.produkt||'Solar/WP',original_betrag:parseFloat(item.netto)||0,aktiv:true,zurueckgestellt:false}));const b=calc(pd.map(p=>({...p,override_betrag:null})),sg,true);const s=await sbP('pay_abrechnungen',{periode:per,mitarbeiter_name:g.name,kuerzel:k,beschaeftigungsart:'hgb',status:'entwurf',anzahl_sales:b.sales,brutto_provisionen:b.bp,systemgebuehr_netto:b.sgN,systemgebuehr_ust:b.sgU,nettobetrag:b.net,ust_satz:b.uS,ust_betrag:b.uB,auszahlungssumme:b.aus,belegnummer:gBN(per,k,c+1)});if(pd.length&&s[0])await sbP('pay_abrechnungen_positionen',pd.map(p=>({...p,abrechnung_id:s[0].id})));c++;}catch(e){console.error(g.name,e);}}
  window.__t?.(`âœ… ${c} Abrechnungen erstellt`);loadP();};

  const doGenerate=async()=>{if(!per)return;if(!confirm(`Abrechnungen fÃ¼r ${pLabel(per)} generieren?\n\nBerechnet Provisionen aus allen offenen AuftrÃ¤gen.\nVorhandene EntwÃ¼rfe werden Ã¼berschrieben.`))return;
    setGenBusy(true);setGenMsg('Starte...');
    try{const cnt=await generateAbrechnungen(per,(msg)=>setGenMsg(msg));setGenMsg('ðŸ” Gesundheitscheck...');const w=await runHealthCheck(per);setHcWarnings(w);if(w.length)setHcOpen(true);window.__t?.(`âœ… ${cnt} Abrechnungen generiert` + (w.length ? ` | âš ï¸ ${w.length} Hinweise` : ''));await loadP();}catch(e){window.__t?.('Fehler: '+e.message,'error');console.error(e);}
    setGenBusy(false);setGenMsg('');};
  const doHealthCheck=async()=>{if(!per)return;setHcBusy(true);try{const w=await runHealthCheck(per);setHcWarnings(w);setHcOpen(true);window.__t?.(w.length?`âš ï¸ ${w.length} Hinweise gefunden`:'âœ… Alles sauber!');}catch(e){window.__t?.('Fehler: '+e.message,'error');}setHcBusy(false);};

  return<Toast>
    <div className="app-header"><div className="logo-area"><div><div className="logo-text">bee<span>-doo</span> PAY</div><div className="logo-sub">Probeabrechnung</div></div></div>
    <div className="controls-bar">{pers.length>0&&<select className="sel-period" value={per} onChange={e=>setPer(e.target.value)}>{pers.map(p=><option key={p} value={p}>{pLabel(p)}</option>)}</select>}<button className="btn btn-primary" onClick={doGenerate} disabled={genBusy} style={{opacity:genBusy?.6:1}}>{genBusy?'â³ Generiere...':'ðŸ”„ Abrechnungen generieren'}</button><button className="btn btn-secondary" onClick={doHealthCheck} disabled={hcBusy} title="KI-Gesundheitscheck" style={{position:'relative'}}>{hcBusy?'â³':'ðŸ©º'}{hcWarnings.length>0&&!hcBusy&&<span style={{position:'absolute',top:-4,right:-4,background:'#da3633',color:'#fff',borderRadius:'50%',width:16,height:16,fontSize:9,display:'flex',alignItems:'center',justifyContent:'center',fontWeight:700}}>{hcWarnings.length}</span>}</button><button className="btn btn-secondary" onClick={()=>setBerOpen(true)} title="Datenbereinigung">ðŸ”§</button><a href="https://bee-doo-tools.vercel.app/" className="btn btn-secondary btn-sm" style={{textDecoration:'none'}}>ðŸ </a></div></div>
    <BereinigungBanner onClick={()=>setBerOpen(true)}/>
    {genMsg&&<div style={{padding:'8px 24px',background:'#161b22',borderBottom:'1px solid #21262d',fontSize:13,color:'#F5C500'}}>â³ {genMsg}</div>}
    {hcOpen&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.7)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={e=>e.target===e.currentTarget&&setHcOpen(false)}>
      <div style={{background:'#161b22',border:'1px solid #30363d',borderRadius:12,width:'90%',maxWidth:700,maxHeight:'80vh',overflow:'auto',padding:24}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
          <div style={{fontSize:18,fontWeight:700,color:'#e6edf3'}}>ðŸ©º Gesundheitscheck</div>
          <button onClick={()=>setHcOpen(false)} style={{background:'none',border:'none',color:'#8b949e',fontSize:20,cursor:'pointer'}}>âœ•</button>
        </div>
        {hcWarnings.length===0&&<div style={{padding:24,textAlign:'center',color:'#3fb950',fontSize:16}}>âœ… Alles sauber â€“ keine Probleme gefunden!</div>}
        {hcWarnings.map((w,i)=><div key={i} style={{marginBottom:12,padding:12,background:w.typ==='kritisch'?'#1c0a0a':w.typ==='warnung'?'#1c1a0a':'#0a1a1c',border:`1px solid ${w.typ==='kritisch'?'#da363360':w.typ==='warnung'?'#d2992160':'#30363d'}`,borderRadius:8}}>
          <div style={{fontWeight:700,color:w.typ==='kritisch'?'#f85149':w.typ==='warnung'?'#d29921':'#8b949e',marginBottom:6}}>{w.icon} {w.titel}</div>
          <div style={{fontSize:12,color:'#8b949e',lineHeight:1.6}}>{w.details.map((d,j)=><div key={j} style={{padding:'2px 0'}}>â€¢ {d}</div>)}</div>
        </div>)}
        <div style={{marginTop:16,display:'flex',gap:8,justifyContent:'flex-end'}}>
          <button className="btn btn-secondary btn-sm" onClick={()=>setHcOpen(false)}>SchlieÃŸen</button>
          <button className="btn btn-primary btn-sm" onClick={()=>{doHealthCheck();}} disabled={hcBusy}>{hcBusy?'â³ PrÃ¼fe...':'ðŸ”„ Erneut prÃ¼fen'}</button>
        </div>
      </div>
    </div>}
    <div className="stats-row">
      <div className="stat-card"><div className="stat-label">Periode</div><div className="stat-value">{per?pLabel(per):'â€”'}</div></div>
      <div className="stat-card"><div className="stat-label">Vertriebler</div><div className="stat-value gold">{vtCount}</div></div>
      <div className="stat-card"><div className="stat-label">Scouter</div><div className="stat-value" style={{color:'#a78bfa'}}>{scCount}</div></div>
      <div className="stat-card"><div className="stat-label">Abrechnungen</div><div className="stat-value">{abrs.length}</div></div>
      <div className="stat-card"><div className="stat-label">Freigegeben</div><div className="stat-value green">{frg}</div></div>
      <div className="stat-card"><div className="stat-label">Gesamtsumme</div><div className="stat-value gold">{fmtE(totA)}</div></div>
      {incompleteCount>0&&<div className="stat-card" style={{borderColor:'#da363380'}}><div className="stat-label" style={{color:'#f85149'}}>âš ï¸ Daten unvollst.</div><div className="stat-value" style={{color:'#f85149'}}>{incompleteCount}</div></div>}
    </div>
    <div className="kat-bar">
      <button className={`kat-btn${katFilter==='alle'?' active':''}`} onClick={()=>setKatFilter('alle')}>Alle ({vtG.length})</button>
      <button className={`kat-btn${katFilter==='vertriebler'?' active':''}`} onClick={()=>setKatFilter('vertriebler')}>ðŸŸ¡ Vertriebler ({vtCount})</button>
      <button className={`kat-btn${katFilter==='scouter'?' active-sc':''}`} onClick={()=>setKatFilter('scouter')}>ðŸ”µ Scouter ({scCount})</button>
    </div>
    {ld?<div className="loading"><div className="spinner"/>Lade...</div>:vtGFiltered.length===0?<div className="empty-state"><div className="icon">ðŸ“­</div><h3>Keine Daten fÃ¼r {per?pLabel(per):'â€”'}{katFilter!=='alle'?` (${katFilter})`:''}</h3><p>FÃ¼r diese Periode liegen noch keine Daten vor.</p></div>:
    <div className="main-grid">{vtGFiltered.map(g=>{const ab=g.abrechnung;const k=ab?.kuerzel||gK(g.name);const st=ab?.status||'neu';const isScouter=g.kategorie==='scouter';const isHGB=ab?.beschaeftigungsart?.includes('hgb');const typClass=isScouter?'scouter':(isHGB?'hgb':'angestellt');const missing=getMissing(g.name);return<div key={g.name} className={`vt-card ${typClass}`} onClick={()=>setSel({name:g.name,abrechnungId:ab?.id,data:g.items})} style={missing.length>0?{borderColor:'#da363360'}:{}}>
      <div className="vt-card-header"><span className="vt-name">{g.name}</span><div style={{display:'flex',gap:6,alignItems:'center'}}><span style={{fontSize:9,padding:'2px 6px',borderRadius:3,background:isScouter?'#a78bfa20':(isHGB?'#F5C50020':'#58a6ff20'),color:isScouter?'#a78bfa':(isHGB?'#F5C500':'#58a6ff'),fontWeight:600}}>{isScouter?'Scout':(isHGB?'HGB Â§84':'Angestellt')}</span><span className="vt-kuerzel">{k}</span></div></div>
      {missing.length>0&&<div style={{fontSize:10,color:'#f85149',background:'#da363315',border:'1px solid #da363330',borderRadius:6,padding:'4px 8px',marginBottom:6,display:'flex',alignItems:'center',gap:4}}>âš ï¸ Fehlt: {missing.join(', ')}</div>}
      <div className="vt-sales">{ab?.anzahl_sales||0} Sales Â· {(ab?.brutto_provisionen||0).toLocaleString('de-DE')}&nbsp;â‚¬ Netto</div>
      <div className="vt-betrag">{fmtE(ab?ab.auszahlungssumme:g.total)}</div>
      <div className="vt-card-footer"><span className={`badge ${st==='neu'?'badge-entwurf':st==='entwurf'?'badge-entwurf':st==='probeabrechnung'?'badge-probe':st==='freigegeben'?'badge-freigegeben':'badge-ausgezahlt'}`}>{st==='neu'?'â¬œ Neu':st==='entwurf'?'ðŸ“ Entwurf':st==='probeabrechnung'?'ðŸ” Probe':st==='freigegeben'?'âœ… Freigegeben':'ðŸ’¸ Ausgezahlt'}</span><span style={{fontSize:11,color:'#484f58'}}>{ab?`${ab.anzahl_sales||0} Sales`:''}</span></div>
    </div>;})}</div>}
    {sel&&<DetailView aId={sel.abrechnungId} per={per} vtN={sel.name} vtD={sel.data} sg={sg} onClose={()=>setSel(null)} onRef={loadP}/>}
    {berOpen&&<BereinigungPanel onClose={()=>{setBerOpen(false);loadP();}}/>}
  </Toast>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>




