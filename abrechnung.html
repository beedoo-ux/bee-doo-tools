<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo | Probeabrechnung</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#0a0a0f;color:#c9d1d9;min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#161b22}::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}
.app-header{background:#0d1117;border-bottom:1px solid #21262d;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo-area{display:flex;align-items:center;gap:12px}
.logo-text{font-size:22px;font-weight:800;letter-spacing:-0.5px}.logo-text span{color:#F5C500}
.logo-sub{font-size:11px;color:#8b949e;letter-spacing:1px;text-transform:uppercase}
.controls-bar{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.sel-period{background:#161b22;border:1px solid #30363d;color:#c9d1d9;padding:8px 14px;border-radius:8px;font-family:'DM Sans';font-size:14px;cursor:pointer}
.sel-period:focus{outline:none;border-color:#F5C500}
.btn{padding:8px 16px;border-radius:8px;font-family:'DM Sans';font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:#F5C500;color:#0a0a0f}.btn-primary:hover{background:#e6b800}
.btn-secondary{background:#21262d;color:#c9d1d9;border:1px solid #30363d}.btn-secondary:hover{background:#30363d}
.btn-success{background:#238636;color:#fff}.btn-success:hover{background:#2ea043}
.btn-danger{background:#da3633;color:#fff}.btn-danger:hover{background:#f85149}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}
.stats-row{display:flex;gap:16px;padding:16px 24px;flex-wrap:wrap}
.stat-card{background:#161b22;border:1px solid #21262d;border-radius:10px;padding:14px 18px;flex:1;min-width:140px}
.stat-label{font-size:11px;color:#8b949e;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.stat-value{font-size:22px;font-weight:700;color:#e6edf3}.stat-value.gold{color:#F5C500}.stat-value.green{color:#3fb950}
.main-grid{padding:0 24px 24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.vt-card{background:#161b22;border:1px solid #21262d;border-radius:12px;padding:16px;cursor:pointer;transition:all .2s}
.vt-card:hover{border-color:#F5C500;transform:translateY(-2px)}
.vt-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.vt-name{font-size:15px;font-weight:700;color:#e6edf3}
.vt-kuerzel{font-size:11px;color:#8b949e;background:#21262d;padding:2px 8px;border-radius:4px}
.vt-sales{font-size:12px;color:#8b949e;margin-bottom:6px}
.vt-betrag{font-size:20px;font-weight:800;color:#F5C500}
.vt-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:8px;border-top:1px solid #21262d}
.badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:0.3px}
.badge-entwurf{background:#30363d;color:#8b949e}.badge-probe{background:#1f2d1f;color:#F5C500;border:1px solid #F5C50040}
.badge-freigegeben{background:#0d2818;color:#3fb950;border:1px solid #3fb95040}.badge-ausgezahlt{background:#0d1d2d;color:#58a6ff;border:1px solid #58a6ff40}
.detail-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;display:flex;justify-content:center;align-items:stretch}
.detail-container{background:#0d1117;width:100%;max-width:1400px;display:flex;flex-direction:column;overflow:hidden}
.detail-header{background:#161b22;border-bottom:1px solid #21262d;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.detail-body{display:flex;flex:1;overflow:hidden}
.edit-panel{width:420px;min-width:380px;background:#0d1117;border-right:1px solid #21262d;overflow-y:auto;padding:16px;flex-shrink:0}
.preview-panel{flex:1;overflow-y:auto;background:#2d2d2d;padding:20px;display:flex;justify-content:center}
.edit-section{margin-bottom:16px}
.edit-section-title{font-size:12px;font-weight:700;color:#F5C500;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #21262d}
.pos-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#161b22;border:1px solid #21262d;border-radius:8px;margin-bottom:6px;font-size:12px;transition:all .2s}
.pos-row.inactive{opacity:.4;background:#0d1117}
.pos-row .pos-kunde{flex:1;color:#c9d1d9;font-weight:500}
.pos-row .pos-betrag{font-weight:700;color:#e6edf3;min-width:80px;text-align:right}
.override-input{background:#21262d;border:1px solid #30363d;color:#F5C500;padding:4px 8px;border-radius:4px;width:80px;text-align:right;font-family:'DM Sans';font-size:12px;font-weight:600}
.override-input:focus{outline:none;border-color:#F5C500}
.toggle-btn{width:28px;height:16px;border-radius:8px;border:none;cursor:pointer;position:relative;transition:background .2s}
.toggle-btn.active{background:#238636}.toggle-btn.inactive-toggle{background:#484f58}
.toggle-btn::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:#fff;top:2px;transition:left .2s}
.toggle-btn.active::after{left:14px}.toggle-btn.inactive-toggle::after{left:2px}
.extra-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.extra-input{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:6px 10px;border-radius:6px;font-family:'DM Sans';font-size:12px;flex:1}
.extra-input:focus{outline:none;border-color:#F5C500}.extra-amount{width:100px}
.notes-area{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:10px;border-radius:8px;font-family:'DM Sans';font-size:12px;width:100%;min-height:60px;resize:vertical}
.notes-area:focus{outline:none;border-color:#F5C500}
.empty-state{text-align:center;padding:60px 20px;color:#484f58}.empty-state .icon{font-size:48px;margin-bottom:12px}.empty-state h3{font-size:16px;color:#8b949e;margin-bottom:6px}
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#8b949e}
.spinner{width:20px;height:20px;border:2px solid #30363d;border-top-color:#F5C500;border-radius:50%;animation:spin .6s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;background:#161b22;border:1px solid #21262d;border-radius:10px;padding:12px 20px;font-size:13px;color:#c9d1d9;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideUp .3s ease}
.toast.success{border-color:#238636;color:#3fb950}.toast.error{border-color:#da3633;color:#f85149}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* === PREMIUM PDF === */
.gs-page{background:#fff;width:210mm;min-height:297mm;position:relative;color:#111;font-family:Arial,sans-serif;font-size:11px;box-shadow:0 4px 24px rgba(0,0,0,.4);overflow:hidden}
.gs-page *{color:#111}
.gs-watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-35deg);font-size:72px;font-weight:900;color:rgba(245,197,0,.08);letter-spacing:8px;white-space:nowrap;z-index:1;pointer-events:none;text-transform:uppercase}
.gs-brand-bar{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);padding:20px 24px 16px;display:flex;justify-content:space-between;align-items:flex-start}
.gs-brand-logo{font-family:'Arial Black',Arial,sans-serif;font-size:32px;font-weight:900;color:#fff!important;letter-spacing:-1px}
.gs-brand-logo span{color:#F5C500!important}
.gs-brand-sub{font-size:9px;color:rgba(255,255,255,.5)!important;letter-spacing:2px;text-transform:uppercase;margin-top:2px}
.gs-brand-right{text-align:right}
.gs-brand-date{font-size:11px;color:rgba(255,255,255,.8)!important;line-height:1.8}
.gs-brand-date b{color:#fff!important}.gs-brand-date .lbl{color:rgba(255,255,255,.5)!important}
.gs-brand-qr{margin-top:8px;display:flex;justify-content:flex-end}
.gs-gold-line{height:3px;background:linear-gradient(90deg,#F5C500,#e6b800,#F5C500)}
.gs-content{padding:16px 24px 28mm;position:relative;z-index:2}
.gs-sender-line{font-size:8px;color:#999!important;border-bottom:1px dotted #ddd;padding-bottom:3px;margin-bottom:8px}
.gs-empf-name{font-size:13px;font-weight:700;margin-bottom:1px}
.gs-empf-addr{font-size:10.5px;color:#555!important;line-height:1.6;margin-bottom:1px}
.gs-empf-steuer{font-size:9px;color:#999!important;margin-bottom:12px}
.gs-beleg-nr{font-size:17px;font-weight:800;margin-bottom:1px;color:#1a1a2e!important}
.gs-beleg-sub{font-size:10.5px;color:#777!important;margin-bottom:10px}
.gs-fin-table{width:100%;border-collapse:collapse;font-size:10.5px;margin-bottom:12px}
.gs-fin-table td{padding:5px 10px;vertical-align:top}.gs-fin-table .r{text-align:right}
.gs-fin-table .row-prov td{border-bottom:1px solid #eee}.gs-fin-table .row-prov td:first-child{color:#0f3460!important;font-weight:600}
.gs-fin-table .row-brutto td{border-bottom:2px solid #aaa;font-weight:700;padding-top:8px}
.gs-fin-table .row-sg td{background:#f8f8f2;border-bottom:1px solid #e5e5e5;color:#666!important;font-weight:500;font-size:10px}
.gs-fin-table .row-sg-ust td{background:#f8f8f2;color:#9a3412!important;font-size:9.5px}
.gs-fin-table .row-sg-hint td{background:#f8f8f2;color:#aaa!important;font-size:8px;padding:1px 10px 5px}
.gs-fin-table .row-netto td{border-top:2px solid #1a1a2e;color:#555!important;padding-top:8px}
.gs-fin-table .row-ust td{background:#fffbeb;border-bottom:1px solid #fde68a;color:#92400e!important;font-weight:600}
.gs-fin-table .row-ausz td{background:linear-gradient(90deg,#f0fdf4,#dcfce7);font-weight:800;font-size:13px;padding:8px 10px;border-radius:4px}
.gs-fin-table .row-ausz td:last-child{color:#166534!important}
.gs-sidebar{display:flex;flex-direction:column;gap:10px}
.gs-box{border:1px solid #eee;border-radius:6px;padding:10px;background:#fafafa}
.gs-box-title{font-size:9px;font-weight:700;color:#0f3460!important;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid #eee}
.gs-box table{width:100%;border-collapse:collapse;font-size:9.5px}
.gs-box td{padding:3px 6px}.gs-box .lbl{color:#777!important}
.gs-box .total td{background:#f0fdf4;font-weight:700;border-radius:3px}.gs-box .total td:last-child{color:#166534!important}
.gs-box .sg-total td{background:#fff7ed;font-weight:700;color:#92400e!important}
.gs-chart-box{border:1px solid #eee;border-radius:6px;padding:10px;background:#fafafa;margin-top:10px}
.gs-chart-title{font-size:9px;font-weight:700;color:#0f3460!important;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.gs-chart-bars{display:flex;align-items:flex-end;gap:12px;height:50px;padding:0 20px}
.gs-bar{flex:1;border-radius:3px 3px 0 0;position:relative;min-width:0}
.gs-bar-label{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);font-size:7px;color:#999!important;white-space:nowrap}
.gs-bar-value{position:absolute;top:-12px;left:50%;transform:translateX(-50%);font-size:7px;font-weight:700;color:#333!important}
.gs-progress-box{border:1px solid #eee;border-radius:6px;padding:10px;background:#fafafa;margin-top:10px}
.gs-progress-title{font-size:9px;font-weight:700;color:#0f3460!important;margin-bottom:6px}
.gs-progress-track{height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden}
.gs-progress-fill{height:100%;border-radius:4px}
.gs-progress-info{display:flex;justify-content:space-between;font-size:8px;color:#777!important;margin-top:3px}
.gs-sig{margin-top:16px;padding-top:12px;border-top:1px solid #eee;display:flex;gap:40px}
.gs-sig-block{flex:1}.gs-sig-line{border-bottom:1px solid #333;height:30px;margin-bottom:3px}
.gs-sig-label{font-size:8px;color:#999!important}
.gs-legal{margin-top:10px;font-size:8.5px;color:#777!important;line-height:1.5;padding:8px;background:#f9f9f9;border-radius:4px}
.gs-footer{position:absolute;bottom:8mm;left:16mm;right:16mm;border-top:1px solid #ddd;padding-top:5px;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px}
.gs-footer-col{font-size:7.5px;color:#888!important;line-height:1.5}.gs-footer-col b{font-size:8px;color:#333!important;display:block;margin-bottom:1px}
.gs-dtable{width:100%;border-collapse:collapse;font-size:10px}
.gs-dtable th{padding:5px 8px;border-bottom:2px solid #1a1a2e;text-align:left;font-size:8px;text-transform:uppercase;color:#0f3460!important;background:#f0f4ff;letter-spacing:0.5px}
.gs-dtable th:last-child{text-align:right}
.gs-dtable td{padding:4px 8px;border-bottom:1px solid #f0f0f0;font-size:9.5px}
.gs-dtable td:first-child{color:#777!important;font-size:9px}.gs-dtable td:last-child{text-align:right;font-weight:600}
.gs-dtable tr:nth-child(even){background:#fafbff}
.gs-dtable .sum-row td{font-weight:700;border-top:2px solid #333;background:#f5f5f5;padding:6px 8px}
.gs-dtable .sg-row td{background:#f8f8f2;color:#666!important}.gs-dtable .sg-row td:last-child{color:#9a3412!important}
.gs-dtable .netto-row td{border-top:1px solid #ddd;color:#555!important}
.gs-dtable .ust-row td{background:#fffbeb;color:#92400e!important}.gs-dtable .ust-row td:last-child{font-weight:700}
.gs-dtable .brutto-row td{background:linear-gradient(90deg,#f0fdf4,#dcfce7);border-top:2px solid #166534;font-weight:800;font-size:11px;padding:7px 8px}
.gs-dtable .brutto-row td:last-child{font-size:12px;font-weight:900;color:#166534!important}
.gs-dtable .zurueck td{opacity:.5;text-decoration:line-through}
.gs-brand-meta-bar{padding:4px 24px;background:#f8f9fa;font-size:7.5px;color:#999!important;display:flex;justify-content:space-between}
@media(max-width:768px){.app-header{padding:12px 16px}.stats-row{padding:12px 16px;gap:10px}.stat-card{min-width:120px;padding:10px 14px}.stat-value{font-size:18px}.main-grid{padding:0 16px 16px;grid-template-columns:1fr}.detail-body{flex-direction:column}.edit-panel{width:100%;min-width:unset;max-height:50vh;border-right:none;border-bottom:1px solid #21262d}.preview-panel{padding:10px}.gs-page{width:100%;min-height:auto;transform-origin:top left}.controls-bar{width:100%;justify-content:flex-end}}
@media(max-width:480px){.stats-row{flex-direction:column}.stat-card{min-width:unset}.detail-header{flex-direction:column;gap:8px;align-items:flex-start}.edit-panel{padding:12px}.pos-row{flex-wrap:wrap}}
@media print{body{background:#fff}.app-header,.stats-row,.main-grid,.edit-panel,.detail-header,.detail-overlay{display:none!important}.preview-panel{background:#fff;padding:0}.gs-page{box-shadow:none;page-break-after:always}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, useMemo } = React;
const SUPA_URL = 'https://hqzpemfaljxcysyqssng.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
const HDR = { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

const fmt = (n) => new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0);
const fmtEur = (n) => fmt(n) + ' \u20ac';
const periodenLabel = (p) => { if(!p) return '\u2014'; const [y,m]=p.split('/'); const mon=['','Januar','Februar','M\u00e4rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember']; return `${mon[parseInt(m)]} ${y}`; };
const genKuerzel = (name) => { const p=name.trim().split(/\s+/); return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():name.slice(0,2).toUpperCase(); };
const genBelegnr = (periode, kuerzel, nr) => { const [y,m]=periode.split('/'); return `GS-${y}${m}-${String(nr||1).padStart(3,'0')}-${kuerzel}`; };

const sbGet = async (t,q='') => { const r=await fetch(`${SUPA_URL}/rest/v1/${t}?${q}`,{headers:HDR}); if(!r.ok) throw new Error(`GET ${t}: ${r.status}`); return r.json(); };
const sbPost = async (t,d) => { const r=await fetch(`${SUPA_URL}/rest/v1/${t}`,{method:'POST',headers:{...HDR,'Prefer':'return=representation'},body:JSON.stringify(d)}); if(!r.ok){const x=await r.text();throw new Error(`POST ${t}: ${x}`);}return r.json(); };
const sbPatch = async (t,q,d) => { const r=await fetch(`${SUPA_URL}/rest/v1/${t}?${q}`,{method:'PATCH',headers:{...HDR,'Prefer':'return=representation'},body:JSON.stringify(d)}); if(!r.ok) throw new Error(`PATCH ${t}: ${r.status}`); return r.json(); };
const sbDelete = async (t,q) => { await fetch(`${SUPA_URL}/rest/v1/${t}?${q}`,{method:'DELETE',headers:HDR}); };

function berechneAbrechnung(positionen, sg, istHgb) {
  const aktiv = positionen.filter(p=>p.aktiv && !p.zurueckgestellt);
  const prov = aktiv.filter(p=>['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const extra = aktiv.filter(p=>['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const bruttoProv = prov.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const einmalSum = extra.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  let sgN=0,sgU=0;
  if(istHgb && sg){sgN=Math.min(bruttoProv*(sg.prozent/100),sg.max_netto);sgU=sgN*(sg.ust_satz/100);}
  const netto = bruttoProv - sgN + einmalSum;
  const ustS = istHgb?19:0;
  const ustB = netto*(ustS/100);
  return { anzSales:prov.filter(p=>p.typ==='provision').length, bruttoProv, sgN:Math.round(sgN*100)/100, sgU:Math.round(sgU*100)/100, einmalSum, netto:Math.round(netto*100)/100, ustS, ustB:Math.round(ustB*100)/100, ausz:Math.round((netto+netto*(ustS/100))*100)/100 };
}

function generateQR(text) { try { const qr=qrcode(0,'M'); qr.addData(text); qr.make(); return qr.createDataURL(3,0); } catch(e){ return null; } }

let toastT=null;
function ToastProvider({children}){const[t,setT]=useState(null);window.__toast=(m,ty='success')=>{clearTimeout(toastT);setT({m,ty});toastT=setTimeout(()=>setT(null),3000);};return <>{children}{t&&<div className={`toast ${t.ty}`}>{t.m}</div>}</>;}

function GutschriftPreview({ ab, pos, sg, vmSales }) {
  const ber = berechneAbrechnung(pos, sg, ab.beschaeftigungsart==='hgb');
  const aktivProv = pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const aktivExtra = pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const zurueckPos = pos.filter(p=>p.zurueckgestellt);
  const kuerzel = ab.kuerzel || genKuerzel(ab.mitarbeiter_name);
  const istHgb = ab.beschaeftigungsart==='hgb';
  const heute = new Date().toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'});
  const belegnr = ab.belegnummer || genBelegnr(ab.periode, kuerzel, 1);
  const isDraft = ab.status==='entwurf' || ab.status==='probeabrechnung';
  const qrImg = generateQR(`bee-doo:${belegnr}:${ber.ausz}:${ab.mitarbeiter_name}`);
  const staffelSchwelle = 8;
  const salesProgress = Math.min(ber.anzSales / staffelSchwelle * 100, 100);
  const hatStaffel = ber.anzSales >= staffelSchwelle;
  const maxBar = Math.max(ber.anzSales, vmSales||0, 1);

  return <div style={{display:'flex',flexDirection:'column',gap:'20px',alignItems:'center'}}>
    {/* === SEITE 1 === */}
    <div className="gs-page">
      {isDraft && <div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
      <div className="gs-brand-bar">
        <div><div className="gs-brand-logo">bee<span>-doo</span></div><div className="gs-brand-sub">Energy for you</div></div>
        <div className="gs-brand-right">
          <div className="gs-brand-date"><div><span className="lbl">Datum:&nbsp;</span><b>{heute}</b></div><div><span className="lbl">Leistungszeitraum:&nbsp;</span><b>{ab.periode}</b></div></div>
          {qrImg && <div className="gs-brand-qr"><img src={qrImg} alt="QR" style={{width:52,height:52,borderRadius:3}} /></div>}
        </div>
      </div>
      <div className="gs-gold-line" />
      <div className="gs-brand-meta-bar"><span>USt-IdNr.: DE363829401 \u00b7 Steuernummer: 320/5706/4015</span><span>Telecommunication \u00b7 eBusiness \u00b7 Solar & W\u00e4rmepumpe</span></div>

      <div className="gs-content">
        <div className="gs-sender-line">bee-doo GmbH \u00b7 Am Stadtholz 39 \u00b7 D-33609 Bielefeld</div>
        <div className="gs-empf-name">{ab.mitarbeiter_name}</div>
        <div className="gs-empf-addr">\u2014<br/>\u2014</div>
        <div className="gs-empf-steuer">{istHgb?'HGB \u00a784 Handelsvertreter':'Angestellt'}</div>
        <div className="gs-beleg-nr">{istHgb?'Gutschrift':'Entgeltabrechnung'} {belegnr}</div>
        <div className="gs-beleg-sub">{ab.mitarbeiter_name} \u00b7 Leistungszeitraum {periodenLabel(ab.periode)}</div>

        <div style={{display:'grid',gridTemplateColumns:'58% 40%',gap:'2%',marginTop:8}}>
          <div>
            <table className="gs-fin-table"><tbody>
              <tr className="row-prov"><td>Provisionen ({ber.anzSales} Sales \u2013 Vermittlung Solar/WP)</td><td className="r">{fmtEur(ber.bruttoProv)}</td></tr>
              {aktivExtra.map((p,i)=><tr key={i} className="row-prov"><td style={{color:(p.override_betrag!=null?p.override_betrag:p.original_betrag)>=0?'#0f3460':'#9a3412'}}>{p.kunde||p.notiz||p.typ}</td><td className="r">{fmtEur(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
              <tr className="row-brutto"><td>Brutto-Provisionen</td><td className="r">{fmtEur(ber.bruttoProv+ber.einmalSum)}</td></tr>
              {istHgb&&<><tr className="row-sg"><td>\ud83d\udda5\ufe0f ./. Systemgeb\u00fchr Netto ({sg?.prozent||3}% \u00b7 max. {fmtEur(sg?.max_netto||200)})</td><td className="r">-{fmtEur(ber.sgN)}</td></tr>
              <tr className="row-sg-ust"><td>\ud83d\udda5\ufe0f ./. USt 19% auf Systemgeb\u00fchr</td><td className="r">-{fmtEur(ber.sgU)}</td></tr>
              <tr className="row-sg-hint"><td colSpan={2}>Netto {fmtEur(ber.sgN)} + 19% MwSt {fmtEur(ber.sgU)} = Brutto {fmtEur(ber.sgN+ber.sgU)} \u00b7 sep. Rechnung bee-doo GmbH \u00b7 Ziff. 4.2 HVV</td></tr></>}
              <tr className="row-netto"><td>Nettobetrag</td><td className="r">{fmtEur(ber.netto)}</td></tr>
              {istHgb&&<tr className="row-ust"><td>+ Umsatzsteuer 19% (Provisionen)</td><td className="r">+ {fmtEur(ber.ustB)}</td></tr>}
              <tr className="row-ausz"><td>AUSZAHLUNGSSUMME {istHgb?'(Brutto)':'(Netto)'}</td><td className="r">{fmtEur(ber.ausz)}</td></tr>
            </tbody></table>
          </div>
          <div className="gs-sidebar">
            <div className="gs-box">
              <div className="gs-box-title">\ud83d\udcca Sales {periodenLabel(ab.periode)}</div>
              <table><tbody>
                <tr><td className="lbl">Abgerechnete Sales</td><td style={{textAlign:'right',fontWeight:700}}>{ber.anzSales}</td></tr>
                <tr><td className="lbl">Provisionen Netto</td><td style={{textAlign:'right'}}>{fmtEur(ber.netto)}</td></tr>
                {istHgb&&<tr><td className="lbl" style={{color:'#92400e'}}>+ USt 19%</td><td style={{textAlign:'right',color:'#92400e'}}>+ {fmtEur(ber.ustB)}</td></tr>}
                <tr className="total"><td>Auszahlung</td><td style={{textAlign:'right'}}>{fmtEur(ber.ausz)}</td></tr>
              </tbody></table>
            </div>
            {istHgb && ber.sgN>0 && <div className="gs-box">
              <div className="gs-box-title">\ud83d\udda5\ufe0f Systemgeb\u00fchr (sep. Rechnung)</div>
              <table><tbody>
                <tr><td className="lbl">Netto</td><td style={{textAlign:'right'}}>{fmtEur(ber.sgN)}</td></tr>
                <tr><td className="lbl" style={{color:'#9a3412'}}>+ USt 19%</td><td style={{textAlign:'right',color:'#9a3412'}}>+ {fmtEur(ber.sgU)}</td></tr>
                <tr className="sg-total"><td>Brutto</td><td style={{textAlign:'right'}}>{fmtEur(ber.sgN+ber.sgU)}</td></tr>
              </tbody></table>
            </div>}
            <div className="gs-chart-box">
              <div className="gs-chart-title">\ud83d\udcc8 Performance-Vergleich</div>
              <div className="gs-chart-bars">
                <div className="gs-bar" style={{height:`${((vmSales||0)/maxBar)*100}%`,background:'#cbd5e1',minHeight:(vmSales||0)>0?4:2}}><div className="gs-bar-value">{vmSales||0}</div><div className="gs-bar-label">Vormonat</div></div>
                <div className="gs-bar" style={{height:`${(ber.anzSales/maxBar)*100}%`,background:ber.anzSales>=(vmSales||0)?'linear-gradient(180deg,#F5C500,#e6b800)':'linear-gradient(180deg,#f87171,#dc2626)',minHeight:ber.anzSales>0?4:2}}><div className="gs-bar-value" style={{fontWeight:800}}>{ber.anzSales}</div><div className="gs-bar-label">Aktuell</div></div>
              </div>
              <div style={{textAlign:'center',marginTop:16,fontSize:8,color:ber.anzSales>=(vmSales||0)?'#166534':'#dc2626',fontWeight:700}}>
                {(vmSales||0)>0 ? (ber.anzSales>=(vmSales||0) ? `\u25b2 +${Math.round((ber.anzSales-(vmSales||0))/(vmSales||1)*100)}% vs. Vormonat` : `\u25bc ${Math.round((ber.anzSales-(vmSales||0))/(vmSales||1)*100)}% vs. Vormonat`) : 'Kein Vormonat vorhanden'}
              </div>
            </div>
            <div className="gs-progress-box">
              <div className="gs-progress-title">{hatStaffel ? '\u2b50 Staffel-Bonus erreicht!' : `\ud83c\udfaf Staffel-Fortschritt (${staffelSchwelle} Sales)`}</div>
              <div className="gs-progress-track"><div className="gs-progress-fill" style={{width:`${salesProgress}%`,background:hatStaffel?'linear-gradient(90deg,#F5C500,#22c55e)':'linear-gradient(90deg,#3b82f6,#6366f1)'}} /></div>
              <div className="gs-progress-info"><span>{ber.anzSales} / {staffelSchwelle} Sales</span><span>{hatStaffel?'\u2705 1.700 \u20ac Rate aktiv':'Noch '+(staffelSchwelle-ber.anzSales)+' Sales'}</span></div>
            </div>
          </div>
        </div>
        <div className="gs-sig">
          <div className="gs-sig-block"><div className="gs-sig-line" /><div className="gs-sig-label">Datum, Unterschrift Gesch\u00e4ftsf\u00fchrung bee-doo GmbH</div>
            {ab.status==='freigegeben'&&<div style={{fontSize:8,color:'#166534',marginTop:2}}>\u2705 Digital freigegeben: {ab.freigegeben_von||'Patrick Grabowski'} \u00b7 {ab.freigegeben_am?new Date(ab.freigegeben_am).toLocaleDateString('de-DE'):heute}</div>}
          </div>
          <div className="gs-sig-block"><div className="gs-sig-line" /><div className="gs-sig-label">Kenntnisnahme Vertriebspartner</div></div>
        </div>
        <div className="gs-legal">{istHgb?`Diese Gutschrift gem. \u00a714 Abs. 2 UStG ersetzt die Rechnung des Leistungserbringers. Nettobetrag Provisionen: ${fmtEur(ber.netto)} \u00b7 zzgl. 19% USt: ${fmtEur(ber.ustB)} \u00b7 Bruttobetrag: ${fmtEur(ber.ausz)}. Die Systemgeb\u00fchr (Netto ${fmtEur(ber.sgN)} + 19% USt ${fmtEur(ber.sgU)} = Brutto ${fmtEur(ber.sgN+ber.sgU)}) wird gesondert per Rechnung der bee-doo GmbH abgerechnet.`:`Entgeltabrechnung f\u00fcr ${ab.mitarbeiter_name}. Nettobetrag: ${fmtEur(ber.netto)}.`}</div>
      </div>
      <div className="gs-footer">
        <div className="gs-footer-col"><b>Firmensitz</b>bee-doo GmbH<br/>Am Stadtholz 39<br/>D-33609 Bielefeld</div>
        <div className="gs-footer-col"><b>Kontakt</b>www.bee-doo.de<br/>info@bee-doo.de<br/>Fon: 0800 22 33 664</div>
        <div className="gs-footer-col"><b>Bankverbindung</b>IBAN DE90 2545 0110<br/>0031 0399 85<br/>BIC NOLADE21SWB</div>
        <div className="gs-footer-col"><b>Gesch\u00e4ftsf\u00fchrer</b>Patrick Grabowski<br/>Olaf Schader<br/>HRB 43210 Bielefeld</div>
      </div>
    </div>
    {/* === SEITE 2 === */}
    <div className="gs-page">
      {isDraft && <div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
      <div className="gs-brand-bar" style={{padding:'12px 24px 10px'}}>
        <div style={{display:'flex',alignItems:'center',gap:12}}><div className="gs-brand-logo" style={{fontSize:20}}>bee<span>-doo</span></div><div style={{color:'rgba(255,255,255,.6)',fontSize:10}}>Einzelpositionen \u00b7 {periodenLabel(ab.periode)}</div></div>
        <div style={{color:'#fff',fontSize:11,fontWeight:700}}>{ab.mitarbeiter_name} <span style={{color:'rgba(255,255,255,.5)',fontWeight:400}}>({kuerzel})</span></div>
      </div>
      <div className="gs-gold-line" />
      <div className="gs-content" style={{paddingTop:12}}>
        <div style={{color:'#0f3460',fontWeight:700,fontSize:11,marginBottom:6,borderBottom:'1px solid #e5e7eb',paddingBottom:3}}>\ud83d\udccb Abgerechnete Positionen</div>
        <table className="gs-dtable">
          <thead><tr><th style={{width:'14%'}}>Auftrag</th><th style={{width:'28%'}}>Kunde</th><th style={{width:'30%'}}>Produkt / Art</th><th style={{width:'13%'}}>Typ</th><th>Netto</th></tr></thead>
          <tbody>
            {aktivProv.map((p,i)=><tr key={i}><td>{p.auftrag_nr||'\u2014'}</td><td style={{fontWeight:500,color:'#333'}}>{p.kunde||'\u2014'}</td><td>{p.produkt||'Solar/WP'}</td><td><span style={{background:'#e0f2fe',color:'#0369a1',padding:'1px 5px',borderRadius:3,fontSize:8,fontWeight:600}}>{p.typ==='provision'?'SALE':p.typ.toUpperCase()}</span></td><td style={{color:p.override_betrag!=null?'#B45309':undefined}}>{fmtEur(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
            {aktivExtra.map((p,i)=><tr key={`e${i}`} style={{background:'#fffbeb'}}><td>\u2014</td><td>{p.kunde||p.notiz||p.typ}</td><td>\u2014</td><td><span style={{background:p.typ==='einmalzahlung'?'#d1fae5':'#fee2e2',color:p.typ==='einmalzahlung'?'#065f46':'#991b1b',padding:'1px 5px',borderRadius:3,fontSize:8,fontWeight:600}}>{p.typ==='einmalzahlung'?'BONUS':'ABZUG'}</span></td><td>{fmtEur(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
            {zurueckPos.length>0&&<><tr><td colSpan={5} style={{padding:'8px 8px 4px',fontSize:9,color:'#999',fontWeight:600,borderBottom:'none'}}>\u23f8 Zur\u00fcckgestellt (n\u00e4chste Periode)</td></tr>{zurueckPos.map((p,i)=><tr key={`z${i}`} className="zurueck"><td>{p.auftrag_nr||'\u2014'}</td><td>{p.kunde||'\u2014'}</td><td>{p.produkt||'\u2014'}</td><td>\u2014</td><td>{fmtEur(p.original_betrag)}</td></tr>)}</>}
            <tr className="sum-row"><td colSpan={4}>Netto-Summe Provisionen</td><td>{fmtEur(ber.bruttoProv+ber.einmalSum)}</td></tr>
            {istHgb&&<tr className="sg-row"><td colSpan={4}>./. Systemgeb\u00fchr + USt ({fmtEur(ber.sgN)} + {fmtEur(ber.sgU)})</td><td>-{fmtEur(ber.sgN+ber.sgU)}</td></tr>}
            <tr className="netto-row"><td colSpan={4}>Nettobetrag (Auszahlungsbasis)</td><td>{fmtEur(ber.netto)}</td></tr>
            {istHgb&&<tr className="ust-row"><td colSpan={4}>+ USt 19% auf Provisionen</td><td>+ {fmtEur(ber.ustB)}</td></tr>}
            <tr className="brutto-row"><td colSpan={4}>BRUTTO-AUSZAHLUNG</td><td>{fmtEur(ber.ausz)}</td></tr>
          </tbody>
        </table>
        {ab.stb_kommentar&&<div style={{marginTop:12,padding:8,background:'#fff8e1',border:'1px solid #fde68a',borderRadius:4,fontSize:9}}><b style={{color:'#92400e'}}>\ud83d\udcce Kommentar Steuerberater:</b><br/><span style={{color:'#78350f'}}>{ab.stb_kommentar}</span></div>}
      </div>
      <div className="gs-footer">
        <div className="gs-footer-col"><b>Firmensitz</b>bee-doo GmbH<br/>Am Stadtholz 39<br/>D-33609 Bielefeld</div>
        <div className="gs-footer-col"><b>Kontakt</b>www.bee-doo.de<br/>info@bee-doo.de<br/>Fon: 0800 22 33 664</div>
        <div className="gs-footer-col"><b>Bankverbindung</b>IBAN DE90 2545 0110<br/>0031 0399 85<br/>BIC NOLADE21SWB</div>
        <div className="gs-footer-col"><b>Gesch\u00e4ftsf\u00fchrer</b>Patrick Grabowski<br/>Olaf Schader<br/>HRB 43210 Bielefeld</div>
      </div>
    </div>
  </div>;
}

function EditPanel({ ab, pos, setPos, sg, onSave, onFreigeben, onPdf, setAb }) {
  const ber = berechneAbrechnung(pos, sg, ab.beschaeftigungsart==='hgb');
  const provP = pos.filter(p=>['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const extraP = pos.filter(p=>['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const isLocked = ab.status==='freigegeben'||ab.status==='ausgezahlt';
  const togglePos=(idx)=>{if(isLocked)return;const n=[...pos];n[idx]={...n[idx],aktiv:!n[idx].aktiv};setPos(n);};
  const setOverride=(idx,v)=>{if(isLocked)return;const n=[...pos];n[idx]={...n[idx],override_betrag:v===''?null:parseFloat(v.replace(',','.'))||0};setPos(n);};
  const zurueck=(idx)=>{if(isLocked)return;const n=[...pos];n[idx]={...n[idx],zurueckgestellt:!n[idx].zurueckgestellt,aktiv:n[idx].zurueckgestellt};setPos(n);};
  const addExtra=(typ)=>setPos([...pos,{typ,auftrag_nr:'',kunde:'',produkt:'',original_betrag:0,override_betrag:null,aktiv:true,zurueckgestellt:false,notiz:'',isNew:true}]);
  const removeExtra=(idx)=>{const n=[...pos];n.splice(idx,1);setPos(n);};
  const updateExtra=(idx,f,v)=>{const n=[...pos];n[idx]={...n[idx],[f]:f==='original_betrag'?(parseFloat(v.replace(',','.'))||0):v};setPos(n);};

  return <div className="edit-panel">
    <div className="edit-section">
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
        <span className={`badge badge-${ab.status==='probeabrechnung'?'probe':ab.status}`}>{ab.status==='entwurf'?'\ud83d\udcdd Entwurf':ab.status==='probeabrechnung'?'\ud83d\udd0d Probe':ab.status==='freigegeben'?'\u2705 Freigegeben':'\ud83d\udcb8 Ausgezahlt'}</span>
        <span style={{fontSize:11,color:'#8b949e'}}>{ab.mitarbeiter_name}</span>
      </div>
      <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
        <button className="btn btn-primary btn-sm" onClick={onSave} disabled={isLocked}>\ud83d\udcbe Speichern</button>
        {!isLocked&&<button className="btn btn-success btn-sm" onClick={onFreigeben}>\u2705 Freigeben</button>}
        {ab.status==='freigegeben'&&<button className="btn btn-sm" style={{background:'#1f6feb',color:'#fff'}} onClick={()=>{setAb(p=>({...p,status:'ausgezahlt',ausgezahlt_am:new Date().toISOString()}));setTimeout(onSave,100);}}>\ud83d\udcb8 Ausgezahlt</button>}
        <button className="btn btn-secondary btn-sm" onClick={onPdf}>\ud83d\udcc4 PDF</button>
      </div>
    </div>
    <div className="edit-section">
      <div className="edit-section-title">\ud83d\udcb0 Zusammenfassung</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}><div style={{fontSize:10,color:'#8b949e'}}>Sales</div><div style={{fontSize:18,fontWeight:700,color:'#F5C500'}}>{ber.anzSales}</div></div>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}><div style={{fontSize:10,color:'#8b949e'}}>Auszahlung</div><div style={{fontSize:16,fontWeight:700,color:'#3fb950'}}>{fmtEur(ber.ausz)}</div></div>
      </div>
    </div>
    <div className="edit-section">
      <div className="edit-section-title">\ud83d\udccb Provisionen ({provP.filter(p=>p.aktiv&&!p.zurueckgestellt).length}/{provP.length})</div>
      {provP.map((p,i)=>{const gi=pos.indexOf(p);return <div key={i} className={`pos-row ${!p.aktiv?'inactive':''}`}>
        <button className={`toggle-btn ${p.aktiv?'active':'inactive-toggle'}`} onClick={()=>togglePos(gi)} disabled={isLocked} />
        <div className="pos-kunde" style={{fontSize:11}}>{p.kunde||'\u2014'}{p.zurueckgestellt&&<span style={{fontSize:9,background:'#30363d',color:'#8b949e',padding:'1px 6px',borderRadius:3,marginLeft:6}}>\u23f8</span>}</div>
        <div className="pos-betrag">{!isLocked?<input className="override-input" value={p.override_betrag!=null?p.override_betrag:p.original_betrag} onChange={e=>setOverride(gi,e.target.value)} />:<span>{fmtEur(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</span>}</div>
        {!isLocked&&<button className="btn btn-sm" style={{padding:'2px 6px',fontSize:10,background:p.zurueckgestellt?'#238636':'#30363d',color:p.zurueckgestellt?'#fff':'#8b949e'}} onClick={()=>zurueck(gi)}>\u23f8</button>}
      </div>;})}
    </div>
    <div className="edit-section">
      <div className="edit-section-title">\u2795 Einmalzahlungen / Abz\u00fcge</div>
      {extraP.map((p,i)=>{const gi=pos.indexOf(p);return <div key={i} className="extra-row">
        <input className="extra-input" placeholder="Bezeichnung" value={p.kunde||p.notiz||''} onChange={e=>updateExtra(gi,'kunde',e.target.value)} disabled={isLocked} />
        <input className="extra-input extra-amount" placeholder="Betrag" value={p.original_betrag||''} onChange={e=>updateExtra(gi,'original_betrag',e.target.value)} disabled={isLocked} />
        <select className="extra-input" style={{width:90}} value={p.typ} onChange={e=>updateExtra(gi,'typ',e.target.value)} disabled={isLocked}>
          <option value="einmalzahlung">+ Zahlung</option><option value="abzug">\u2212 Abzug</option><option value="sonstiges">Sonstiges</option>
        </select>
        {!isLocked&&<button className="btn btn-danger btn-sm btn-icon" onClick={()=>removeExtra(gi)}>\u2715</button>}
      </div>;})}
      {!isLocked&&<div style={{display:'flex',gap:6}}><button className="btn btn-secondary btn-sm" onClick={()=>addExtra('einmalzahlung')}>+ Zahlung</button><button className="btn btn-secondary btn-sm" onClick={()=>addExtra('abzug')}>\u2212 Abzug</button></div>}
    </div>
    <div className="edit-section"><div className="edit-section-title">\ud83d\udcdd Interne Notizen</div><textarea className="notes-area" placeholder="Notizen..." value={ab.notizen||''} onChange={e=>setAb(p=>({...p,notizen:e.target.value}))} disabled={isLocked} /></div>
    <div className="edit-section"><div className="edit-section-title">\ud83d\udcce Steuerberater-Kommentar</div><textarea className="notes-area" placeholder="Kommentar f\u00fcr StB..." value={ab.stb_kommentar||''} onChange={e=>setAb(p=>({...p,stb_kommentar:e.target.value}))} disabled={isLocked} /></div>
  </div>;
}

function DetailView({ abrId, periode, vtName, vtData, sg, onClose, onRefresh }) {
  const [ab, setAb] = useState(null);
  const [pos, setPos] = useState([]);
  const [loading, setLoading] = useState(true);
  const prevRef = useRef(null);

  useEffect(()=>{(async()=>{
    setLoading(true);
    try {
      if(abrId){const [a,p]=await Promise.all([sbGet('pay_abrechnungen',`id=eq.${abrId}`),sbGet('pay_abrechnungen_positionen',`abrechnung_id=eq.${abrId}&order=erstellt_am.asc`)]);if(a.length){setAb(a[0]);setPos(p);}}
      else{setAb({periode,mitarbeiter_name:vtName,kuerzel:genKuerzel(vtName),beschaeftigungsart:'hgb',status:'entwurf',notizen:'',stb_kommentar:''});
      setPos((vtData||[]).map(d=>({typ:'provision',auftrag_nr:'',kunde:d.kunde,produkt:d.produkt,original_betrag:parseFloat(d.netto)||0,override_betrag:null,aktiv:true,zurueckgestellt:false,notiz:'',isNew:true})));}
    } catch(e){window.__toast?.('Fehler: '+e.message,'error');}
    setLoading(false);
  })();}, [abrId]);

  const handleSave = async () => {
    try{const ber=berechneAbrechnung(pos,sg,ab.beschaeftigungsart==='hgb');
    const d={...ab,anzahl_sales:ber.anzSales,brutto_provisionen:ber.bruttoProv,systemgebuehr_netto:ber.sgN,systemgebuehr_ust:ber.sgU,einmalzahlungen_summe:ber.einmalSum,nettobetrag:ber.netto,ust_satz:ber.ustS,ust_betrag:ber.ustB,auszahlungssumme:ber.ausz,belegnummer:ab.belegnummer||genBelegnr(ab.periode,ab.kuerzel||genKuerzel(ab.mitarbeiter_name),1),geaendert_am:new Date().toISOString()};
    let saved;if(ab.id){const{id,erstellt_am,...u}=d;saved=(await sbPatch('pay_abrechnungen',`id=eq.${ab.id}`,u))[0];await sbDelete('pay_abrechnungen_positionen',`abrechnung_id=eq.${ab.id}`);}
    else{const{id,...ins}=d;saved=(await sbPost('pay_abrechnungen',ins))[0];}
    const pData=pos.map(p=>({abrechnung_id:saved.id,typ:p.typ,auftrag_nr:p.auftrag_nr,kunde:p.kunde,produkt:p.produkt,original_betrag:p.original_betrag,override_betrag:p.override_betrag,aktiv:p.aktiv,zurueckgestellt:p.zurueckgestellt,notiz:p.notiz}));
    if(pData.length)setPos(await sbPost('pay_abrechnungen_positionen',pData));setAb(saved);window.__toast?.('\u2705 Gespeichert');onRefresh?.();
    }catch(e){window.__toast?.('Fehler: '+e.message,'error');}
  };
  const handleFreigeben = async () => {if(!confirm(`${ab.mitarbeiter_name} (${ab.periode}) freigeben?\nDanach keine \u00c4nderungen mehr m\u00f6glich!`))return;setAb(p=>({...p,status:'freigegeben',freigegeben_am:new Date().toISOString(),freigegeben_von:'Patrick Grabowski'}));setTimeout(handleSave,100);};
  const handlePdf = async () => {const pages=prevRef.current?.querySelectorAll('.gs-page');if(!pages?.length)return;window.__toast?.('PDF wird erstellt...');
    try{const k=ab.kuerzel||genKuerzel(ab.mitarbeiter_name);const fn=`Gutschrift_${ab.periode.replace('/','-')}_${k}.pdf`;const c=document.createElement('div');pages.forEach(p=>c.appendChild(p.cloneNode(true)));
    await html2pdf().set({margin:0,filename:fn,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},pagebreak:{mode:['css','legacy'],before:'.gs-page'}}).from(c).save();window.__toast?.('\u2705 PDF heruntergeladen');
    }catch(e){window.__toast?.('PDF-Fehler: '+e.message,'error');}};

  if(loading)return<div className="detail-overlay"><div className="detail-container"><div className="loading"><div className="spinner"/>Lade...</div></div></div>;
  if(!ab)return null;
  return <div className="detail-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
    <div className="detail-container">
      <div className="detail-header">
        <div style={{display:'flex',alignItems:'center',gap:12}}><button className="btn btn-secondary btn-sm" onClick={onClose}>\u2190 Zur\u00fcck</button><span style={{fontWeight:700,fontSize:15}}>{ab.mitarbeiter_name}</span><span className={`badge badge-${ab.status==='probeabrechnung'?'probe':ab.status}`}>{ab.status}</span></div>
        <div style={{fontSize:12,color:'#8b949e'}}>{periodenLabel(ab.periode)}</div>
      </div>
      <div className="detail-body">
        <EditPanel ab={ab} pos={pos} setPos={setPos} sg={sg} onSave={handleSave} onFreigeben={handleFreigeben} onPdf={handlePdf} setAb={setAb} />
        <div className="preview-panel" ref={prevRef}><GutschriftPreview ab={ab} pos={pos} sg={sg} vmSales={0} /></div>
      </div>
    </div>
  </div>;
}

function App(){
  const[periode,setPeriode]=useState('');const[perioden,setPerioden]=useState([]);const[abrechnungen,setAbr]=useState([]);const[auszahlungen,setAusz]=useState([]);const[sg,setSg]=useState(null);const[loading,setLoading]=useState(true);const[selVt,setSelVt]=useState(null);

  useEffect(()=>{(async()=>{try{const data=await sbGet('pay_auszahlungen_historie','select=periode&order=periode.desc');const unique=[...new Set(data.map(d=>d.periode))];const now=new Date();const cur=`${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}`;if(!unique.includes(cur))unique.unshift(cur);unique.sort().reverse();setPerioden(unique);if(unique.length)setPeriode(unique[0]);}catch(e){setPerioden(['2025/11','2025/12']);setPeriode('2025/12');}})();},[]);

  const loadPeriode=useCallback(async()=>{if(!periode)return;setLoading(true);try{const[a,au,s]=await Promise.all([sbGet('pay_abrechnungen',`periode=eq.${periode}&order=mitarbeiter_name.asc`),sbGet('pay_auszahlungen_historie',`periode=eq.${periode}&order=vertriebler.asc`),sbGet('pay_systemgebuehr','aktiv=eq.true&limit=1')]);setAbr(a);setAusz(au);setSg(s[0]||null);}catch(e){window.__toast?.(e.message,'error');}setLoading(false);},[periode]);
  useEffect(()=>{loadPeriode();},[loadPeriode]);

  const vtGroups=useMemo(()=>{const g={};auszahlungen.forEach(a=>{const n=a.vertriebler;if(!g[n])g[n]={name:n,items:[],total:0};g[n].items.push(a);g[n].total+=parseFloat(a.netto)||0;});abrechnungen.forEach(a=>{if(!g[a.mitarbeiter_name])g[a.mitarbeiter_name]={name:a.mitarbeiter_name,items:[],total:a.brutto_provisionen||0};g[a.mitarbeiter_name].abrechnung=a;});return Object.values(g).sort((a,b)=>b.total-a.total);},[auszahlungen,abrechnungen]);

  const totalAusz=abrechnungen.reduce((s,a)=>s+(parseFloat(a.auszahlungssumme)||0),0);
  const freig=abrechnungen.filter(a=>a.status==='freigegeben'||a.status==='ausgezahlt').length;

  const handleAlleErstellen=async()=>{const todo=vtGroups.filter(g=>!g.abrechnung);if(!confirm(`${todo.length} Probeabrechnungen erstellen?`))return;window.__toast?.('Erstelle...');let c=0;
  for(const g of todo){try{const k=genKuerzel(g.name);const pD=g.items.map(i=>({typ:'provision',kunde:i.kunde||'\u2014',produkt:i.produkt||'Solar/WP',original_betrag:parseFloat(i.netto)||0,aktiv:true,zurueckgestellt:false}));
  const b=berechneAbrechnung(pD.map(p=>({...p,override_betrag:null})),sg,true);const s=await sbPost('pay_abrechnungen',{periode,mitarbeiter_name:g.name,kuerzel:k,beschaeftigungsart:'hgb',status:'entwurf',anzahl_sales:b.anzSales,brutto_provisionen:b.bruttoProv,systemgebuehr_netto:b.sgN,systemgebuehr_ust:b.sgU,nettobetrag:b.netto,ust_satz:b.ustS,ust_betrag:b.ustB,auszahlungssumme:b.ausz,belegnummer:genBelegnr(periode,k,c+1)});
  if(pD.length&&s[0])await sbPost('pay_abrechnungen_positionen',pD.map(p=>({...p,abrechnung_id:s[0].id})));c++;}catch(e){console.error(g.name,e);}}window.__toast?.(`\u2705 ${c} Abrechnungen erstellt`);loadPeriode();};

  return <ToastProvider>
    <div className="app-header">
      <div className="logo-area"><div><div className="logo-text">bee<span>-doo</span> PAY</div><div className="logo-sub">Probeabrechnung</div></div></div>
      <div className="controls-bar">
        {perioden.length>0&&<select className="sel-period" value={periode} onChange={e=>setPeriode(e.target.value)}>{perioden.map(p=><option key={p} value={p}>{periodenLabel(p)}</option>)}</select>}
        {vtGroups.filter(g=>!g.abrechnung).length>0&&<button className="btn btn-primary" onClick={handleAlleErstellen}>\u26a1 Alle erstellen ({vtGroups.filter(g=>!g.abrechnung).length})</button>}
        <a href="https://bee-doo-tools.vercel.app/" className="btn btn-secondary btn-sm" style={{textDecoration:'none'}}>\ud83c\udfe0</a>
      </div>
    </div>
    <div className="stats-row">
      <div className="stat-card"><div className="stat-label">Periode</div><div className="stat-value">{periode?periodenLabel(periode):'\u2014'}</div></div>
      <div className="stat-card"><div className="stat-label">Vertriebler</div><div className="stat-value gold">{vtGroups.length}</div></div>
      <div className="stat-card"><div className="stat-label">Abrechnungen</div><div className="stat-value">{abrechnungen.length} <span style={{fontSize:12,color:'#8b949e'}}>/ {vtGroups.length}</span></div></div>
      <div className="stat-card"><div className="stat-label">Freigegeben</div><div className="stat-value green">{freig}</div></div>
      <div className="stat-card"><div className="stat-label">Gesamtsumme</div><div className="stat-value gold">{fmtEur(totalAusz)}</div></div>
    </div>
    {loading?<div className="loading"><div className="spinner"/>Lade...</div>:
    vtGroups.length===0?<div className="empty-state"><div className="icon">\ud83d\udced</div><h3>Keine Daten f\u00fcr {periode?periodenLabel(periode):'\u2014'}</h3><p>F\u00fcr diese Periode liegen noch keine Auszahlungsdaten vor.</p></div>:
    <div className="main-grid">{vtGroups.map(g=>{const a=g.abrechnung;const k=a?.kuerzel||genKuerzel(g.name);const st=a?.status||'neu';
    return <div key={g.name} className="vt-card" onClick={()=>setSelVt({name:g.name,abrId:a?.id,data:g.items})}>
      <div className="vt-card-header"><span className="vt-name">{g.name}</span><span className="vt-kuerzel">{k}</span></div>
      <div className="vt-sales">{g.items.length} Positionen</div>
      <div className="vt-betrag">{fmtEur(a?a.auszahlungssumme:g.total)}</div>
      <div className="vt-card-footer"><span className={`badge ${st==='neu'?'badge-entwurf':st==='entwurf'?'badge-entwurf':st==='probeabrechnung'?'badge-probe':st==='freigegeben'?'badge-freigegeben':'badge-ausgezahlt'}`}>{st==='neu'?'\u2b1c Neu':st==='entwurf'?'\ud83d\udcdd Entwurf':st==='probeabrechnung'?'\ud83d\udd0d Probe':st==='freigegeben'?'\u2705 Freigegeben':'\ud83d\udcb8 Ausgezahlt'}</span><span style={{fontSize:11,color:'#484f58'}}>{a?`${a.anzahl_sales||0} Sales`:''}</span></div>
    </div>;})}</div>}
    {selVt&&<DetailView abrId={selVt.abrId} periode={periode} vtName={selVt.name} vtData={selVt.data} sg={sg} onClose={()=>setSelVt(null)} onRefresh={loadPeriode} />}
  </ToastProvider>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script></body></html>
