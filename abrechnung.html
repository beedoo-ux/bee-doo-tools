<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo | Probeabrechnung</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#0a0a0f;color:#c9d1d9;min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#161b22}::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}

.app-header{background:#0d1117;border-bottom:1px solid #21262d;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo-area{display:flex;align-items:center;gap:12px}
.logo-text{font-size:22px;font-weight:800;letter-spacing:-0.5px}
.logo-text span{color:#F5C500}
.logo-sub{font-size:11px;color:#8b949e;letter-spacing:1px;text-transform:uppercase}

.controls-bar{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.sel-period{background:#161b22;border:1px solid #30363d;color:#c9d1d9;padding:8px 14px;border-radius:8px;font-family:'DM Sans';font-size:14px;cursor:pointer}
.sel-period:focus{outline:none;border-color:#F5C500}
.btn{padding:8px 16px;border-radius:8px;font-family:'DM Sans';font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:#F5C500;color:#0a0a0f}.btn-primary:hover{background:#e6b800}
.btn-secondary{background:#21262d;color:#c9d1d9;border:1px solid #30363d}.btn-secondary:hover{background:#30363d}
.btn-success{background:#238636;color:#fff}.btn-success:hover{background:#2ea043}
.btn-danger{background:#da3633;color:#fff}.btn-danger:hover{background:#f85149}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}

.stats-row{display:flex;gap:16px;padding:16px 24px;flex-wrap:wrap}
.stat-card{background:#161b22;border:1px solid #21262d;border-radius:10px;padding:14px 18px;flex:1;min-width:140px}
.stat-label{font-size:11px;color:#8b949e;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.stat-value{font-size:22px;font-weight:700;color:#e6edf3}
.stat-value.gold{color:#F5C500}
.stat-value.green{color:#3fb950}

.main-grid{padding:0 24px 24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}

.vt-card{background:#161b22;border:1px solid #21262d;border-radius:12px;padding:16px;cursor:pointer;transition:all .2s}
.vt-card:hover{border-color:#F5C500;transform:translateY(-2px)}
.vt-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.vt-name{font-size:15px;font-weight:700;color:#e6edf3}
.vt-kuerzel{font-size:11px;color:#8b949e;background:#21262d;padding:2px 8px;border-radius:4px}
.vt-sales{font-size:12px;color:#8b949e;margin-bottom:6px}
.vt-betrag{font-size:20px;font-weight:800;color:#F5C500}
.vt-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:8px;border-top:1px solid #21262d}

.badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:0.3px}
.badge-entwurf{background:#30363d;color:#8b949e}
.badge-probe{background:#1f2d1f;color:#F5C500;border:1px solid #F5C50040}
.badge-freigegeben{background:#0d2818;color:#3fb950;border:1px solid #3fb95040}
.badge-ausgezahlt{background:#0d1d2d;color:#58a6ff;border:1px solid #58a6ff40}

/* ‚îÄ‚îÄ Detail View ‚îÄ‚îÄ */
.detail-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;display:flex;justify-content:center;align-items:stretch}
.detail-container{background:#0d1117;width:100%;max-width:1400px;display:flex;flex-direction:column;overflow:hidden}
.detail-header{background:#161b22;border-bottom:1px solid #21262d;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.detail-body{display:flex;flex:1;overflow:hidden}
.edit-panel{width:420px;min-width:380px;background:#0d1117;border-right:1px solid #21262d;overflow-y:auto;padding:16px;flex-shrink:0}
.preview-panel{flex:1;overflow-y:auto;background:#2d2d2d;padding:20px;display:flex;justify-content:center}

.edit-section{margin-bottom:16px}
.edit-section-title{font-size:12px;font-weight:700;color:#F5C500;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #21262d}

.pos-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#161b22;border:1px solid #21262d;border-radius:8px;margin-bottom:6px;font-size:12px;transition:all .2s}
.pos-row.inactive{opacity:.4;background:#0d1117}
.pos-row .pos-kunde{flex:1;color:#c9d1d9;font-weight:500}
.pos-row .pos-art{flex:1;color:#8b949e;font-size:11px}
.pos-row .pos-betrag{font-weight:700;color:#e6edf3;min-width:80px;text-align:right}
.pos-row .pos-betrag.overridden{color:#F5C500}

.override-input{background:#21262d;border:1px solid #30363d;color:#F5C500;padding:4px 8px;border-radius:4px;width:80px;text-align:right;font-family:'DM Sans';font-size:12px;font-weight:600}
.override-input:focus{outline:none;border-color:#F5C500}

.toggle-btn{width:28px;height:16px;border-radius:8px;border:none;cursor:pointer;position:relative;transition:background .2s}
.toggle-btn.active{background:#238636}
.toggle-btn.inactive-toggle{background:#484f58}
.toggle-btn::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:#fff;top:2px;transition:left .2s}
.toggle-btn.active::after{left:14px}
.toggle-btn.inactive-toggle::after{left:2px}

.extra-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.extra-input{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:6px 10px;border-radius:6px;font-family:'DM Sans';font-size:12px;flex:1}
.extra-input:focus{outline:none;border-color:#F5C500}
.extra-amount{width:100px}

.notes-area{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:10px;border-radius:8px;font-family:'DM Sans';font-size:12px;width:100%;min-height:60px;resize:vertical}
.notes-area:focus{outline:none;border-color:#F5C500}

/* ‚îÄ‚îÄ Preview (White PDF Look) ‚îÄ‚îÄ */
.gutschrift-page{background:#fff;width:210mm;min-height:297mm;padding:14mm 16mm 28mm;position:relative;color:#111;font-family:Arial,sans-serif;font-size:11px;box-shadow:0 4px 24px rgba(0,0,0,.4)}
.gutschrift-page *{color:#111}

.gs-topline{font-size:8.5px;color:#555!important;border-bottom:1px solid #ddd;padding-bottom:5px;margin-bottom:12px}
.gs-topline span{float:right;color:#555!important}
.gs-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.gs-logo{font-family:'Arial Black',Arial,sans-serif;font-size:26px;font-weight:900;letter-spacing:-1px}
.gs-logo span{color:#FDE154!important}
.gs-logo-sub{font-size:8.5px;color:#888!important;letter-spacing:1px;text-transform:uppercase;margin-top:1px}
.gs-dates{text-align:right;font-size:11px;line-height:1.8}
.gs-dates .lbl{color:#888!important}
.gs-sender{font-size:8.5px;color:#888!important;border-bottom:1px dotted #ccc;padding-bottom:4px;margin-bottom:10px}
.gs-empf-name{font-size:12px;font-weight:700;margin-bottom:2px}
.gs-empf-addr{font-size:11px;color:#444!important;line-height:1.7;margin-bottom:2px}
.gs-empf-steuer{font-size:9.5px;color:#888!important;margin-bottom:14px}
.gs-beleg-title{font-size:19px;font-weight:700;margin-bottom:2px}
.gs-beleg-sub{font-size:11px;color:#666!important;margin-bottom:12px}

.gs-table{width:100%;border-collapse:collapse;font-size:11px}
.gs-table td{padding:6px 10px}
.gs-table .row-prov td{border-bottom:1px solid #eee}
.gs-table .row-prov td:first-child{color:#E07800!important}
.gs-table .row-brutto td{border-bottom:2px solid #aaa;font-weight:700}
.gs-table .row-sg td{background:#f8f8f2;border-bottom:1px solid #e5e5e5;color:#555!important;font-weight:600}
.gs-table .row-sg-ust td{background:#f8f8f2;color:#9a3412!important;font-weight:600;font-size:10px}
.gs-table .row-sg-hint td{background:#f8f8f2;color:#888!important;font-size:9px;padding:2px 10px 6px}
.gs-table .row-netto td{border-top:2px solid #111;border-bottom:1px solid #eee;color:#555!important}
.gs-table .row-ust td{background:#fffbeb;border-bottom:1px solid #fde68a;color:#92400e!important;font-weight:600}
.gs-table .row-auszahlung td{background:#f0fdf4;font-weight:800;font-size:13px}
.gs-table .row-auszahlung td:last-child{color:#166534!important}
.gs-table .right{text-align:right}

.gs-sidebar-title{font-size:10px;font-weight:700;color:#E07800!important;margin-bottom:5px;padding-bottom:3px;border-bottom:1px solid #eee}
.gs-sidebar-table{width:100%;border-collapse:collapse;font-size:10px}
.gs-sidebar-table td{padding:4px 7px}
.gs-sidebar-table .lbl{border-bottom:1px solid #eee;color:#555!important}
.gs-sidebar-table .ust{color:#92400e!important}
.gs-sidebar-table .total td{background:#f0fdf4;font-weight:700}
.gs-sidebar-table .total td:last-child{color:#166534!important}
.gs-sidebar-table .sg-total td{background:#fff7ed;font-weight:700;color:#92400e!important}

.gs-footer{position:absolute;bottom:10mm;left:16mm;right:16mm;border-top:1px solid #ddd;padding-top:6px;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
.gs-footer-col{font-size:8px;color:#666!important;line-height:1.6}
.gs-footer-col b{font-size:9px;color:#111!important;display:block;margin-bottom:2px}

.gs-hinweis{margin-top:16px;font-size:10px;color:#555!important;line-height:1.6;border-top:1px solid #eee;padding-top:10px}

/* Page 2 */
.gs-p2-header{font-size:8.5px;color:#555!important;border-bottom:1px solid #ddd;padding-bottom:5px;margin-bottom:12px}
.gs-p2-name{font-size:17px;font-weight:700;margin-bottom:14px}
.gs-p2-name span{font-size:11px;color:#888!important;font-weight:400}
.gs-p2-section{color:#E07800!important;font-weight:700;font-size:11px;margin-bottom:7px;border-bottom:1px solid #eee;padding-bottom:3px}

.gs-detail-table{width:100%;border-collapse:collapse;font-size:10.5px}
.gs-detail-table th{padding:5px 8px;border-bottom:2px solid #ddd;text-align:left;font-size:9px;text-transform:uppercase;color:#888!important;background:#f5f5f5}
.gs-detail-table th:last-child{text-align:right}
.gs-detail-table td{padding:5px 8px;border-bottom:1px solid #eee;font-size:10px}
.gs-detail-table td:first-child{color:#555!important}
.gs-detail-table td:last-child{text-align:right;font-weight:600}
.gs-detail-table .sum-row td{font-weight:700;border-top:2px solid #333;background:#f9f9f9}
.gs-detail-table .sg-row td{background:#f8f8f2;color:#555!important}
.gs-detail-table .sg-row td:last-child{color:#9a3412!important}
.gs-detail-table .netto-row td{border-top:1px solid #ddd;color:#555!important}
.gs-detail-table .ust-row td{background:#fffbeb;color:#92400e!important}
.gs-detail-table .ust-row td:last-child{font-weight:700}
.gs-detail-table .brutto-row td{background:#f0fdf4;border-top:2px solid #166534;font-weight:800;font-size:12px}
.gs-detail-table .brutto-row td:last-child{font-size:13px;font-weight:900;color:#166534!important}

.zur√ºckgestellt-badge{font-size:9px;background:#30363d;color:#8b949e;padding:1px 6px;border-radius:3px;margin-left:6px}

.empty-state{text-align:center;padding:60px 20px;color:#484f58}
.empty-state .icon{font-size:48px;margin-bottom:12px}
.empty-state h3{font-size:16px;color:#8b949e;margin-bottom:6px}
.empty-state p{font-size:13px}

.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#8b949e}
.spinner{width:20px;height:20px;border:2px solid #30363d;border-top-color:#F5C500;border-radius:50%;animation:spin .6s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}

.toast{position:fixed;bottom:24px;right:24px;background:#161b22;border:1px solid #21262d;border-radius:10px;padding:12px 20px;font-size:13px;color:#c9d1d9;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideUp .3s ease}
.toast.success{border-color:#238636;color:#3fb950}
.toast.error{border-color:#da3633;color:#f85149}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* Responsive */
@media(max-width:768px){
  .app-header{padding:12px 16px}
  .stats-row{padding:12px 16px;gap:10px}
  .stat-card{min-width:120px;padding:10px 14px}
  .stat-value{font-size:18px}
  .main-grid{padding:0 16px 16px;grid-template-columns:1fr}
  .detail-body{flex-direction:column}
  .edit-panel{width:100%;min-width:unset;max-height:50vh;border-right:none;border-bottom:1px solid #21262d}
  .preview-panel{padding:10px}
  .gutschrift-page{width:100%;min-height:auto;padding:8mm;transform-origin:top left}
  .controls-bar{width:100%;justify-content:flex-end}
}
@media(max-width:480px){
  .stats-row{flex-direction:column}
  .stat-card{min-width:unset}
  .detail-header{flex-direction:column;gap:8px;align-items:flex-start}
  .edit-panel{padding:12px}
  .pos-row{flex-wrap:wrap}
}

@media print{
  body{background:#fff}
  .app-header,.stats-row,.main-grid,.edit-panel,.detail-header,.detail-overlay{display:none!important}
  .preview-panel{background:#fff;padding:0}
  .gutschrift-page{box-shadow:none;page-break-after:always}
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, useMemo } = React;

// ‚îÄ‚îÄ Config ‚îÄ‚îÄ
const SUPABASE_URL = 'https://hqzpemfaljxcysyqssng.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
const HEADERS = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
const fmt = (n) => new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
const fmtEur = (n) => fmt(n) + ' ‚Ç¨';
const periodenLabel = (p) => { const [y, m] = p.split('/'); const mon = ['','Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember']; return `${mon[parseInt(m)]} ${y}`; };
const genKuerzel = (name) => { const parts = name.trim().split(/\s+/); if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase(); return name.slice(0,2).toUpperCase(); };
const genBelegnummer = (periode, kuerzel) => `${periode.replace('/', '-')}-${kuerzel}`;

// ‚îÄ‚îÄ Supabase helpers ‚îÄ‚îÄ
const sbGet = async (table, query = '') => {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, { headers: HEADERS });
  if (!r.ok) throw new Error(`GET ${table}: ${r.status}`);
  return r.json();
};
const sbPost = async (table, data) => {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, { method: 'POST', headers: { ...HEADERS, 'Prefer': 'return=representation' }, body: JSON.stringify(data) });
  if (!r.ok) { const t = await r.text(); throw new Error(`POST ${table}: ${t}`); }
  return r.json();
};
const sbPatch = async (table, query, data) => {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, { method: 'PATCH', headers: { ...HEADERS, 'Prefer': 'return=representation' }, body: JSON.stringify(data) });
  if (!r.ok) throw new Error(`PATCH ${table}: ${r.status}`);
  return r.json();
};
const sbDelete = async (table, query) => {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, { method: 'DELETE', headers: HEADERS });
  if (!r.ok) throw new Error(`DELETE ${table}: ${r.status}`);
};

// ‚îÄ‚îÄ Berechnungs-Engine ‚îÄ‚îÄ
function berechneAbrechnung(positionen, systemgebuehr, istHgb) {
  const aktivePos = positionen.filter(p => p.aktiv && !p.zurueckgestellt);
  const provPos = aktivePos.filter(p => ['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const extraPos = aktivePos.filter(p => ['einmalzahlung','abzug','sonstiges'].includes(p.typ));

  const bruttoProvisionen = provPos.reduce((s, p) => s + (p.override_betrag != null ? p.override_betrag : p.original_betrag), 0);
  const einmalSumme = extraPos.reduce((s, p) => s + (p.override_betrag != null ? p.override_betrag : p.original_betrag), 0);

  let sgNetto = 0, sgUst = 0;
  if (istHgb && systemgebuehr) {
    sgNetto = Math.min(bruttoProvisionen * (systemgebuehr.prozent / 100), systemgebuehr.max_netto);
    sgUst = sgNetto * (systemgebuehr.ust_satz / 100);
  }

  const nettobetrag = bruttoProvisionen - sgNetto + einmalSumme;
  const ustSatz = istHgb ? 19.0 : 0;
  const ustBetrag = nettobetrag * (ustSatz / 100);
  const auszahlung = nettobetrag + ustBetrag;

  return {
    anzahlSales: provPos.filter(p => p.typ === 'provision').length,
    bruttoProvisionen,
    sgNetto: Math.round(sgNetto * 100) / 100,
    sgUst: Math.round(sgUst * 100) / 100,
    einmalSumme,
    nettobetrag: Math.round(nettobetrag * 100) / 100,
    ustSatz,
    ustBetrag: Math.round(ustBetrag * 100) / 100,
    auszahlung: Math.round(auszahlung * 100) / 100
  };
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
let toastTimer = null;
function ToastProvider({ children }) {
  const [toast, setToast] = useState(null);
  window.__showToast = (msg, type = 'success') => {
    clearTimeout(toastTimer);
    setToast({ msg, type });
    toastTimer = setTimeout(() => setToast(null), 3000);
  };
  return <>
    {children}
    {toast && <div className={`toast ${toast.type}`}>{toast.msg}</div>}
  </>;
}

// ‚îÄ‚îÄ Gutschrift Preview Component ‚îÄ‚îÄ
function GutschriftPreview({ abrechnung, positionen, systemgebuehr }) {
  const ab = abrechnung;
  const ber = berechneAbrechnung(positionen, systemgebuehr, ab.beschaeftigungsart === 'hgb');
  const aktiveProvPos = positionen.filter(p => p.aktiv && !p.zurueckgestellt && ['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const aktiveExtraPos = positionen.filter(p => p.aktiv && !p.zurueckgestellt && ['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const kuerzel = ab.kuerzel || genKuerzel(ab.mitarbeiter_name);
  const belegnr = genBelegnummer(ab.periode, kuerzel);
  const istHgb = ab.beschaeftigungsart === 'hgb';
  const heute = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });

  return <div style={{display:'flex',flexDirection:'column',gap:'20px'}}>
    {/* SEITE 1 */}
    <div className="gutschrift-page" id={`gs-page1-${ab.id || 'new'}`}>
      <div className="gs-topline">
        Telecommunication ¬∑ eBusiness ¬∑ Solar &amp; W√§rmepumpe ¬∑ Sales-Promotion
        <span>USt-IdNr.: DE363829401 ¬∑ Steuernummer: 320/5706/4015</span>
      </div>
      <div className="gs-header">
        <div>
          <img src="data:image/png;base64,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" alt="bee-doo" style={{width:"160px",height:"auto"}}/>
        </div>
        <div className="gs-dates">
          <div><span className="lbl">Datum:&nbsp;</span><b>{heute}</b></div>
          <div><span className="lbl">Leistungszeitraum:&nbsp;</span><b>{ab.periode}</b></div>
        </div>
      </div>
      <div className="gs-sender">bee-doo GmbH ¬∑ Am Stadtholz 39 ¬∑ D-33609 Bielefeld</div>
      <div className="gs-empf-name">{ab.mitarbeiter_name}</div>
      <div className="gs-empf-addr">‚Äî<br/>‚Äî</div>
      <div className="gs-empf-steuer">{istHgb ? 'HGB ¬ß84 Handelsvertreter' : 'Angestellt'}</div>

      <div className="gs-beleg-title">{istHgb ? 'Gutschrift' : 'Entgeltabrechnung'}-Belegnummer: {belegnr}</div>
      <div className="gs-beleg-sub">{ab.mitarbeiter_name} ¬∑ Leistungszeitraum {periodenLabel(ab.periode)}</div>
      <div style={{borderTop:'1px solid #eee',marginBottom:'12px'}}></div>

      <div style={{display:'grid',gridTemplateColumns:'56% 42%',gap:'2%'}}>
        <div>
          <table className="gs-table"><tbody>
            <tr className="row-prov"><td style={{color:'#E07800'}}>Provisionen ({ber.anzahlSales} Sales ‚Äì Vermittlung Solar/WP)</td><td className="right">{fmtEur(ber.bruttoProvisionen)}</td></tr>
            {aktiveExtraPos.map((p, i) => <tr key={i} className="row-prov"><td style={{color: (p.override_betrag != null ? p.override_betrag : p.original_betrag) >= 0 ? '#E07800' : '#9a3412'}}>{p.kunde || p.notiz || p.typ}</td><td className="right">{fmtEur(p.override_betrag != null ? p.override_betrag : p.original_betrag)}</td></tr>)}
            <tr className="row-brutto"><td>Brutto-Provisionen</td><td className="right">{fmtEur(ber.bruttoProvisionen + ber.einmalSumme)}</td></tr>
            {istHgb && <>
              <tr className="row-sg"><td>üñ•Ô∏è ./. Systemgeb√ºhr Netto (3% ¬∑ max. 200 ‚Ç¨)</td><td className="right">-{fmtEur(ber.sgNetto)}</td></tr>
              <tr className="row-sg-ust"><td>üñ•Ô∏è ./. USt 19% auf Systemgeb√ºhr (Rechnung bee-doo)</td><td className="right">-{fmtEur(ber.sgUst)}</td></tr>
              <tr className="row-sg-hint"><td colSpan={2}>Netto {fmtEur(ber.sgNetto)} + 19% MwSt {fmtEur(ber.sgUst)} = Brutto {fmtEur(ber.sgNetto + ber.sgUst)} ¬∑ bee-doo GmbH stellt separate Rechnung aus ¬∑ Ziff. 4.2 HVV</td></tr>
            </>}
            <tr className="row-netto"><td>Nettobetrag</td><td className="right">{fmtEur(ber.nettobetrag)}</td></tr>
            {istHgb && <tr className="row-ust"><td>+ Umsatzsteuer 19% (Provisionen)</td><td className="right">+ {fmtEur(ber.ustBetrag)}</td></tr>}
            <tr className="row-auszahlung"><td>AUSZAHLUNGSSUMME {istHgb ? '(Brutto)' : '(Netto)'}</td><td className="right">{fmtEur(ber.auszahlung)}</td></tr>
          </tbody></table>
        </div>
        <div>
          <div className="gs-sidebar-title">Sales {periodenLabel(ab.periode)}</div>
          <table className="gs-sidebar-table"><tbody>
            <tr><td className="lbl">Abgerechnete Sales</td><td style={{textAlign:'right',fontWeight:700}}>{ber.anzahlSales}</td></tr>
            <tr><td className="lbl">Provisionen Netto</td><td style={{textAlign:'right'}}>{fmtEur(ber.nettobetrag)}</td></tr>
            {istHgb && <tr><td className="lbl ust">+ USt 19%</td><td style={{textAlign:'right',color:'#92400e'}}>+ {fmtEur(ber.ustBetrag)}</td></tr>}
            <tr className="total"><td>Auszahlung</td><td style={{textAlign:'right'}}>{fmtEur(ber.auszahlung)}</td></tr>
          </tbody></table>

          {istHgb && ber.sgNetto > 0 && <>
            <div className="gs-sidebar-title" style={{marginTop:'14px'}}>Systemgeb√ºhr (sep. Rechnung)</div>
            <table className="gs-sidebar-table"><tbody>
              <tr><td className="lbl">Netto</td><td style={{textAlign:'right'}}>{fmtEur(ber.sgNetto)}</td></tr>
              <tr><td className="lbl ust">+ USt 19%</td><td style={{textAlign:'right',color:'#9a3412'}}>+ {fmtEur(ber.sgUst)}</td></tr>
              <tr className="sg-total"><td>Brutto Systemgeb√ºhr</td><td style={{textAlign:'right'}}>{fmtEur(ber.sgNetto + ber.sgUst)}</td></tr>
            </tbody></table>
          </>}
        </div>
      </div>

      <div className="gs-hinweis">
        {istHgb
          ? `Diese Gutschrift gem. ¬ß14 Abs. 2 UStG ersetzt die Rechnung des Leistungserbringers. Nettobetrag Provisionen: ${fmtEur(ber.nettobetrag)} ¬∑ zzgl. 19% USt: ${fmtEur(ber.ustBetrag)} ¬∑ Bruttobetrag: ${fmtEur(ber.auszahlung)}. Die Systemgeb√ºhr (Netto ${fmtEur(ber.sgNetto)} + 19% USt ${fmtEur(ber.sgUst)} = Brutto ${fmtEur(ber.sgNetto + ber.sgUst)}) wird gesondert per Rechnung der bee-doo GmbH abgerechnet.`
          : `Entgeltabrechnung f√ºr ${ab.mitarbeiter_name}. Nettobetrag Provisionen: ${fmtEur(ber.nettobetrag)}.`
        }
      </div>

      <div className="gs-footer">
        <div className="gs-footer-col"><b>Firmensitz</b>bee-doo GmbH<br/>Am Stadtholz 39<br/>D-33609 Bielefeld</div>
        <div className="gs-footer-col"><b>Kontakt</b>www.bee-doo.de<br/>info@bee-doo.de<br/>Fon: 0800 22 33 664</div>
        <div className="gs-footer-col"><b>Bankverbindung</b>IBAN DE90 2545 0110<br/>0031 0399 85<br/>BIC NOLADE21SWB</div>
        <div className="gs-footer-col"><b>Gesch√§ftsf√ºhrer</b>Patrick Grabowski<br/>Olaf Schader<br/>HRB 43210 Bielefeld</div>
      </div>
    </div>

    {/* SEITE 2 ‚Äì Einzelpositionen */}
    <div className="gutschrift-page" id={`gs-page2-${ab.id || 'new'}`}>
      <div className="gs-p2-header">Provisionen {periodenLabel(ab.periode)}</div>
      <div className="gs-p2-name">{ab.mitarbeiter_name} <span>({kuerzel})</span></div>
      <div className="gs-p2-section">Einzelpositionen</div>
      <table className="gs-detail-table">
        <thead><tr><th>Auftrag</th><th>Kunde</th><th>Art</th><th>Anlagengr√∂√üe</th><th>Netto</th></tr></thead>
        <tbody>
          {aktiveProvPos.map((p, i) => <tr key={i}>
            <td>{p.auftrag_nr || '‚Äî'}</td>
            <td style={{fontWeight: p.override_betrag != null ? 600 : 400}}>{p.kunde || '‚Äî'}</td>
            <td>{p.produkt || p.typ}</td>
            <td>{p.anlagengroesse || '‚Äî'}</td>
            <td style={{color: p.override_betrag != null ? '#B45309' : undefined}}>{fmtEur(p.override_betrag != null ? p.override_betrag : p.original_betrag)}</td>
          </tr>)}
          {aktiveExtraPos.map((p, i) => <tr key={`e${i}`} style={{background:'#fffbeb'}}>
            <td>‚Äî</td>
            <td>{p.kunde || p.notiz || p.typ}</td>
            <td>{p.typ === 'einmalzahlung' ? 'Einmalzahlung' : p.typ === 'abzug' ? 'Abzug' : 'Sonstiges'}</td>
            <td>‚Äî</td>
            <td>{fmtEur(p.override_betrag != null ? p.override_betrag : p.original_betrag)}</td>
          </tr>)}
          <tr className="sum-row"><td colSpan={4}>Netto-Summe Provisionen</td><td>{fmtEur(ber.bruttoProvisionen + ber.einmalSumme)}</td></tr>
          {istHgb && <tr className="sg-row"><td colSpan={4}>./. Systemgeb√ºhr Netto + USt ({fmtEur(ber.sgNetto)} + {fmtEur(ber.sgUst)})</td><td>-{fmtEur(ber.sgNetto + ber.sgUst)}</td></tr>}
          <tr className="netto-row"><td colSpan={4}>Nettobetrag (Auszahlungsbasis)</td><td>{fmtEur(ber.nettobetrag)}</td></tr>
          {istHgb && <tr className="ust-row"><td colSpan={4}>+ USt 19% auf Provisionen</td><td>+ {fmtEur(ber.ustBetrag)}</td></tr>}
          <tr className="brutto-row"><td colSpan={4}>BRUTTO-AUSZAHLUNG</td><td>{fmtEur(ber.auszahlung)}</td></tr>
        </tbody>
      </table>

      {ab.stb_kommentar && <div style={{marginTop:16,padding:10,background:'#fff8e1',border:'1px solid #fde68a',borderRadius:4,fontSize:10}}>
        <b style={{color:'#92400e'}}>Kommentar Steuerberater:</b><br/>{ab.stb_kommentar}
      </div>}

      <div className="gs-footer">
        <div className="gs-footer-col"><b>Firmensitz</b>bee-doo GmbH<br/>Am Stadtholz 39<br/>D-33609 Bielefeld</div>
        <div className="gs-footer-col"><b>Kontakt</b>www.bee-doo.de<br/>info@bee-doo.de<br/>Fon: 0800 22 33 664</div>
        <div className="gs-footer-col"><b>Bankverbindung</b>IBAN DE90 2545 0110<br/>0031 0399 85<br/>BIC NOLADE21SWB</div>
        <div className="gs-footer-col"><b>Gesch√§ftsf√ºhrer</b>Patrick Grabowski<br/>Olaf Schader<br/>HRB 43210 Bielefeld</div>
      </div>
    </div>
  </div>;
}

// ‚îÄ‚îÄ Edit Panel ‚îÄ‚îÄ
function EditPanel({ abrechnung, positionen, setPositionen, systemgebuehr, onSave, onFreigeben, onPdf, onClose, setAbrechnung }) {
  const ab = abrechnung;
  const ber = berechneAbrechnung(positionen, systemgebuehr, ab.beschaeftigungsart === 'hgb');
  const provPos = positionen.filter(p => ['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const extraPos = positionen.filter(p => ['einmalzahlung','abzug','sonstiges'].includes(p.typ));

  const togglePos = (idx) => {
    if (ab.status === 'freigegeben' || ab.status === 'ausgezahlt') return;
    const np = [...positionen]; np[idx] = { ...np[idx], aktiv: !np[idx].aktiv }; setPositionen(np);
  };
  const setOverride = (idx, val) => {
    if (ab.status === 'freigegeben' || ab.status === 'ausgezahlt') return;
    const np = [...positionen]; np[idx] = { ...np[idx], override_betrag: val === '' ? null : parseFloat(val.replace(',', '.')) || 0 }; setPositionen(np);
  };
  const zurueckstellen = (idx) => {
    if (ab.status === 'freigegeben' || ab.status === 'ausgezahlt') return;
    const np = [...positionen]; np[idx] = { ...np[idx], zurueckgestellt: !np[idx].zurueckgestellt, aktiv: np[idx].zurueckgestellt ? true : false }; setPositionen(np);
  };

  const addExtra = (typ) => {
    setPositionen([...positionen, { typ, auftrag_nr: '', kunde: '', produkt: '', original_betrag: 0, override_betrag: null, aktiv: true, zurueckgestellt: false, notiz: '', isNew: true }]);
  };
  const removeExtra = (idx) => {
    const np = [...positionen]; np.splice(idx, 1); setPositionen(np);
  };
  const updateExtra = (idx, field, val) => {
    const np = [...positionen]; np[idx] = { ...np[idx], [field]: field === 'original_betrag' ? (parseFloat(val.replace(',','.')) || 0) : val }; setPositionen(np);
  };

  const isLocked = ab.status === 'freigegeben' || ab.status === 'ausgezahlt';

  return <div className="edit-panel">
    {/* Status Bar */}
    <div className="edit-section">
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
        <span className={`badge badge-${ab.status === 'probeabrechnung' ? 'probe' : ab.status}`}>{
          ab.status === 'entwurf' ? 'üìù Entwurf' : ab.status === 'probeabrechnung' ? 'üîç Probeabrechnung' : ab.status === 'freigegeben' ? '‚úÖ Freigegeben' : 'üí∏ Ausgezahlt'
        }</span>
        <span style={{fontSize:11,color:'#8b949e'}}>{ab.mitarbeiter_name}</span>
      </div>

      <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
        <button className="btn btn-primary btn-sm" onClick={onSave} disabled={isLocked}>üíæ Speichern</button>
        {ab.status !== 'freigegeben' && ab.status !== 'ausgezahlt' && <button className="btn btn-success btn-sm" onClick={onFreigeben}>‚úÖ Freigeben</button>}
        {ab.status === 'freigegeben' && <button className="btn btn-sm" style={{background:'#1f6feb',color:'#fff'}} onClick={() => {
          setAbrechnung(prev => ({...prev, status: 'ausgezahlt', ausgezahlt_am: new Date().toISOString()}));
          setTimeout(onSave, 100);
        }}>üí∏ Als ausgezahlt markieren</button>}
        <button className="btn btn-secondary btn-sm" onClick={onPdf}>üìÑ PDF</button>
      </div>
    </div>

    {/* Zusammenfassung */}
    <div className="edit-section">
      <div className="edit-section-title">üí∞ Zusammenfassung</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}>
          <div style={{fontSize:10,color:'#8b949e'}}>Sales</div>
          <div style={{fontSize:18,fontWeight:700,color:'#F5C500'}}>{ber.anzahlSales}</div>
        </div>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}>
          <div style={{fontSize:10,color:'#8b949e'}}>Auszahlung</div>
          <div style={{fontSize:16,fontWeight:700,color:'#3fb950'}}>{fmtEur(ber.auszahlung)}</div>
        </div>
      </div>
    </div>

    {/* Provisionen */}
    <div className="edit-section">
      <div className="edit-section-title">üìã Provisionen ({provPos.filter(p=>p.aktiv && !p.zurueckgestellt).length}/{provPos.length})</div>
      {provPos.map((p, i) => {
        const globalIdx = positionen.indexOf(p);
        return <div key={i} className={`pos-row ${!p.aktiv ? 'inactive' : ''}`}>
          <button className={`toggle-btn ${p.aktiv ? 'active' : 'inactive-toggle'}`} onClick={() => togglePos(globalIdx)} disabled={isLocked} title={p.aktiv ? 'Deaktivieren' : 'Aktivieren'} />
          <div className="pos-kunde" style={{fontSize:11}}>
            {p.kunde || '‚Äî'}
            {p.zurueckgestellt && <span className="zur√ºckgestellt-badge">zur√ºckgestellt</span>}
          </div>
          <div className="pos-betrag" style={p.override_betrag != null ? {color:'#F5C500'} : {}}>
            {!isLocked ? <input className="override-input" value={p.override_betrag != null ? p.override_betrag : p.original_betrag} onChange={(e) => setOverride(globalIdx, e.target.value)} title="Betrag √ºberschreiben" />
              : <span>{fmtEur(p.override_betrag != null ? p.override_betrag : p.original_betrag)}</span>}
          </div>
          {!isLocked && <button className="btn btn-sm" style={{padding:'2px 6px',fontSize:10,background:p.zurueckgestellt?'#238636':'#30363d',color:p.zurueckgestellt?'#fff':'#8b949e'}} onClick={() => zurueckstellen(globalIdx)} title="Zur√ºckstellen/Wiederherstellen">‚è∏</button>}
        </div>;
      })}
    </div>

    {/* Einmalzahlungen / Abz√ºge */}
    <div className="edit-section">
      <div className="edit-section-title">‚ûï Einmalzahlungen / Abz√ºge</div>
      {extraPos.map((p, i) => {
        const globalIdx = positionen.indexOf(p);
        return <div key={i} className="extra-row">
          <input className="extra-input" placeholder="Bezeichnung" value={p.kunde || p.notiz || ''} onChange={(e) => updateExtra(globalIdx, 'kunde', e.target.value)} disabled={isLocked} />
          <input className="extra-input extra-amount" placeholder="Betrag" value={p.original_betrag || ''} onChange={(e) => updateExtra(globalIdx, 'original_betrag', e.target.value)} disabled={isLocked} />
          <select className="extra-input" style={{width:90}} value={p.typ} onChange={(e) => updateExtra(globalIdx, 'typ', e.target.value)} disabled={isLocked}>
            <option value="einmalzahlung">+ Zahlung</option>
            <option value="abzug">‚àí Abzug</option>
            <option value="sonstiges">Sonstiges</option>
          </select>
          {!isLocked && <button className="btn btn-danger btn-sm btn-icon" onClick={() => removeExtra(globalIdx)}>‚úï</button>}
        </div>;
      })}
      {!isLocked && <div style={{display:'flex',gap:6}}>
        <button className="btn btn-secondary btn-sm" onClick={() => addExtra('einmalzahlung')}>+ Zahlung</button>
        <button className="btn btn-secondary btn-sm" onClick={() => addExtra('abzug')}>‚àí Abzug</button>
      </div>}
    </div>

    {/* Notizen */}
    <div className="edit-section">
      <div className="edit-section-title">üìù Interne Notizen</div>
      <textarea className="notes-area" placeholder="Notizen zur Abrechnung..." value={ab.notizen || ''} onChange={(e) => setAbrechnung(prev => ({...prev, notizen: e.target.value}))} disabled={isLocked} />
    </div>
    <div className="edit-section">
      <div className="edit-section-title">üìé Kommentar f√ºr Steuerberater</div>
      <textarea className="notes-area" placeholder="Kommentar f√ºr den Steuerberater..." value={ab.stb_kommentar || ''} onChange={(e) => setAbrechnung(prev => ({...prev, stb_kommentar: e.target.value}))} disabled={isLocked} />
    </div>
  </div>;
}

// ‚îÄ‚îÄ Detail View (Modal) ‚îÄ‚îÄ
function DetailView({ abrechnungId, periode, vtName, vtData, systemgebuehr, onClose, onRefresh }) {
  const [abrechnung, setAbrechnung] = useState(null);
  const [positionen, setPositionen] = useState([]);
  const [loading, setLoading] = useState(true);
  const previewRef = useRef(null);

  useEffect(() => { loadData(); }, [abrechnungId]);

  const loadData = async () => {
    setLoading(true);
    try {
      if (abrechnungId) {
        const [abrArr, posArr] = await Promise.all([
          sbGet('pay_abrechnungen', `id=eq.${abrechnungId}`),
          sbGet('pay_abrechnungen_positionen', `abrechnung_id=eq.${abrechnungId}&order=erstellt_am.asc`)
        ]);
        if (abrArr.length) { setAbrechnung(abrArr[0]); setPositionen(posArr); }
      } else {
        // Create new from vtData
        const kuerzel = genKuerzel(vtName);
        const newAbr = { periode, mitarbeiter_name: vtName, kuerzel, beschaeftigungsart: 'hgb', status: 'entwurf', notizen: '', stb_kommentar: '' };
        const newPos = (vtData || []).map(d => ({
          typ: 'provision', auftrag_nr: '', kunde: d.kunde, produkt: d.produkt, anlagengroesse: d.anlagengroesse || '', original_betrag: d.netto, override_betrag: null, aktiv: true, zurueckgestellt: false, notiz: '', isNew: true
        }));
        setAbrechnung(newAbr);
        setPositionen(newPos);
      }
    } catch (e) { console.error(e); window.__showToast?.('Fehler beim Laden: ' + e.message, 'error'); }
    setLoading(false);
  };

  const handleSave = async () => {
    try {
      const ber = berechneAbrechnung(positionen, systemgebuehr, abrechnung.beschaeftigungsart === 'hgb');
      const abrData = {
        ...abrechnung,
        anzahl_sales: ber.anzahlSales,
        brutto_provisionen: ber.bruttoProvisionen,
        systemgebuehr_netto: ber.sgNetto,
        systemgebuehr_ust: ber.sgUst,
        einmalzahlungen_summe: ber.einmalSumme,
        nettobetrag: ber.nettobetrag,
        ust_satz: ber.ustSatz,
        ust_betrag: ber.ustBetrag,
        auszahlungssumme: ber.auszahlung,
        belegnummer: genBelegnummer(abrechnung.periode, abrechnung.kuerzel || genKuerzel(abrechnung.mitarbeiter_name)),
        geaendert_am: new Date().toISOString()
      };

      let savedAbr;
      if (abrechnung.id) {
        const { id, erstellt_am, ...updateData } = abrData;
        savedAbr = await sbPatch('pay_abrechnungen', `id=eq.${abrechnung.id}`, updateData);
        savedAbr = savedAbr[0];
        // Delete old positions and recreate
        await sbDelete('pay_abrechnungen_positionen', `abrechnung_id=eq.${abrechnung.id}`);
      } else {
        const { id, ...insertData } = abrData;
        savedAbr = await sbPost('pay_abrechnungen', insertData);
        savedAbr = savedAbr[0];
      }

      // Save positions
      const posData = positionen.map(p => ({
        abrechnung_id: savedAbr.id,
        typ: p.typ, auftrag_nr: p.auftrag_nr, kunde: p.kunde, produkt: p.produkt, anlagengroesse: p.anlagengroesse || '',
        original_betrag: p.original_betrag, override_betrag: p.override_betrag,
        aktiv: p.aktiv, zurueckgestellt: p.zurueckgestellt, notiz: p.notiz
      }));
      if (posData.length) {
        const savedPos = await sbPost('pay_abrechnungen_positionen', posData);
        setPositionen(savedPos);
      }

      setAbrechnung(savedAbr);
      window.__showToast?.('‚úÖ Abrechnung gespeichert');
      onRefresh?.();
    } catch (e) { console.error(e); window.__showToast?.('Fehler: ' + e.message, 'error'); }
  };

  const handleFreigeben = async () => {
    if (!confirm(`Abrechnung f√ºr ${abrechnung.mitarbeiter_name} (${abrechnung.periode}) freigeben?\n\nDanach sind keine √Ñnderungen mehr m√∂glich!`)) return;
    setAbrechnung(prev => ({ ...prev, status: 'freigegeben', freigegeben_am: new Date().toISOString(), freigegeben_von: 'Patrick Grabowski' }));
    setTimeout(handleSave, 100);
  };

  const handlePdf = async () => {
    const pages = previewRef.current?.querySelectorAll('.gutschrift-page');
    if (!pages?.length) return;
    window.__showToast?.('PDF wird erstellt...');
    try {
      const kuerzel = abrechnung.kuerzel || genKuerzel(abrechnung.mitarbeiter_name);
      const filename = `Gutschrift_${abrechnung.periode.replace('/','-')}_${kuerzel}.pdf`;
      const container = document.createElement('div');
      pages.forEach(p => { const clone = p.cloneNode(true); container.appendChild(clone); });
      await html2pdf().set({
        margin: 0, filename, image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'], before: '.gutschrift-page' }
      }).from(container).save();
      window.__showToast?.('‚úÖ PDF heruntergeladen');
    } catch (e) { console.error(e); window.__showToast?.('PDF-Fehler: ' + e.message, 'error'); }
  };

  if (loading) return <div className="detail-overlay"><div className="detail-container"><div className="loading"><div className="spinner"/>Lade Abrechnung...</div></div></div>;
  if (!abrechnung) return null;

  return <div className="detail-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
    <div className="detail-container">
      <div className="detail-header">
        <div style={{display:'flex',alignItems:'center',gap:12}}>
          <button className="btn btn-secondary btn-sm" onClick={onClose}>‚Üê Zur√ºck</button>
          <span style={{fontWeight:700,fontSize:15}}>{abrechnung.mitarbeiter_name}</span>
          <span className={`badge badge-${abrechnung.status === 'probeabrechnung' ? 'probe' : abrechnung.status}`}>{abrechnung.status}</span>
        </div>
        <div style={{fontSize:12,color:'#8b949e'}}>Periode: {periodenLabel(abrechnung.periode)}</div>
      </div>
      <div className="detail-body">
        <EditPanel abrechnung={abrechnung} positionen={positionen} setPositionen={setPositionen} systemgebuehr={systemgebuehr} onSave={handleSave} onFreigeben={handleFreigeben} onPdf={handlePdf} onClose={onClose} setAbrechnung={setAbrechnung} />
        <div className="preview-panel" ref={previewRef}>
          <GutschriftPreview abrechnung={abrechnung} positionen={positionen} systemgebuehr={systemgebuehr} />
        </div>
      </div>
    </div>
  </div>;
}

// ‚îÄ‚îÄ Main App ‚îÄ‚îÄ
function App() {
  const [periode, setPeriode] = useState('2025/11');
  const [perioden] = useState(['2025/11','2025/12','2026/01','2026/02']);
  const [abrechnungen, setAbrechnungen] = useState([]);
  const [auszahlungen, setAuszahlungen] = useState([]);
  const [systemgebuehr, setSystemgebuehr] = useState(null);
  const [loading, setLoading] = useState(true);
  const [selectedVt, setSelectedVt] = useState(null);

  const loadPeriode = useCallback(async () => {
    setLoading(true);
    try {
      const [abrArr, auszArr, sgArr] = await Promise.all([
        sbGet('pay_abrechnungen', `periode=eq.${periode}&order=mitarbeiter_name.asc`),
        sbGet('pay_auszahlungen_historie', `periode=eq.${periode}&order=vertriebler.asc`),
        sbGet('pay_systemgebuehr', 'aktiv=eq.true&limit=1')
      ]);
      setAbrechnungen(abrArr);
      setAuszahlungen(auszArr);
      setSystemgebuehr(sgArr[0] || null);
    } catch (e) { console.error(e); window.__showToast?.('Fehler: ' + e.message, 'error'); }
    setLoading(false);
  }, [periode]);

  useEffect(() => { loadPeriode(); }, [loadPeriode]);

  // Group auszahlungen by VT
  const vtGroups = useMemo(() => {
    const groups = {};
    auszahlungen.forEach(a => {
      const name = a.vertriebler;
      if (!groups[name]) groups[name] = { name, items: [], total: 0 };
      groups[name].items.push(a);
      groups[name].total += parseFloat(a.netto) || 0;
    });
    // Merge with existing abrechnungen
    abrechnungen.forEach(ab => {
      if (!groups[ab.mitarbeiter_name]) {
        groups[ab.mitarbeiter_name] = { name: ab.mitarbeiter_name, items: [], total: ab.brutto_provisionen || 0 };
      }
      groups[ab.mitarbeiter_name].abrechnung = ab;
    });
    return Object.values(groups).sort((a, b) => b.total - a.total);
  }, [auszahlungen, abrechnungen]);

  const totalAuszahlung = abrechnungen.reduce((s, a) => s + (parseFloat(a.auszahlungssumme) || 0), 0);
  const freigegebene = abrechnungen.filter(a => a.status === 'freigegeben' || a.status === 'ausgezahlt').length;

  const handleAlleErstellen = async () => {
    if (!confirm(`Probeabrechnungen f√ºr alle ${vtGroups.filter(g => !g.abrechnung).length} VTs erstellen?`)) return;
    window.__showToast?.('Erstelle Abrechnungen...');
    let count = 0;
    for (const g of vtGroups) {
      if (g.abrechnung) continue;
      try {
        const kuerzel = genKuerzel(g.name);
        const posData = g.items.map(item => ({
          typ: 'provision', kunde: item.kunde || '‚Äî', produkt: item.produkt || 'Solar/WP', anlagengroesse: item.anlagengroesse || '',
          original_betrag: parseFloat(item.netto) || 0, aktiv: true, zurueckgestellt: false
        }));
        const ber = berechneAbrechnung(posData.map(p => ({...p, override_betrag: null})), systemgebuehr, true);
        const abrData = {
          periode, mitarbeiter_name: g.name, kuerzel, beschaeftigungsart: 'hgb', status: 'entwurf',
          anzahl_sales: ber.anzahlSales, brutto_provisionen: ber.bruttoProvisionen,
          systemgebuehr_netto: ber.sgNetto, systemgebuehr_ust: ber.sgUst,
          nettobetrag: ber.nettobetrag, ust_satz: ber.ustSatz, ust_betrag: ber.ustBetrag,
          auszahlungssumme: ber.auszahlung, belegnummer: genBelegnummer(periode, kuerzel)
        };
        const saved = await sbPost('pay_abrechnungen', abrData);
        if (posData.length && saved[0]) {
          await sbPost('pay_abrechnungen_positionen', posData.map(p => ({ ...p, abrechnung_id: saved[0].id })));
        }
        count++;
      } catch (e) { console.error(g.name, e); }
    }
    window.__showToast?.(`‚úÖ ${count} Abrechnungen erstellt`);
    loadPeriode();
  };

  return <ToastProvider>
    <div className="app-header">
      <div className="logo-area">
        <div>
          <div className="logo-text">bee<span>-doo</span> PAY</div>
          <div className="logo-sub">Probeabrechnung</div>
        </div>
      </div>
      <div className="controls-bar">
        <select className="sel-period" value={periode} onChange={(e) => setPeriode(e.target.value)}>
          {perioden.map(p => <option key={p} value={p}>{periodenLabel(p)}</option>)}
        </select>
        {vtGroups.filter(g => !g.abrechnung).length > 0 && <button className="btn btn-primary" onClick={handleAlleErstellen}>‚ö° Alle erstellen ({vtGroups.filter(g => !g.abrechnung).length})</button>}
        <a href="https://bee-doo-tools.vercel.app/" className="btn btn-secondary btn-sm" style={{textDecoration:'none'}}>üè†</a>
      </div>
    </div>

    <div className="stats-row">
      <div className="stat-card">
        <div className="stat-label">Periode</div>
        <div className="stat-value">{periodenLabel(periode)}</div>
      </div>
      <div className="stat-card">
        <div className="stat-label">Vertriebler</div>
        <div className="stat-value gold">{vtGroups.length}</div>
      </div>
      <div className="stat-card">
        <div className="stat-label">Abrechnungen</div>
        <div className="stat-value">{abrechnungen.length} <span style={{fontSize:12,color:'#8b949e'}}>/ {vtGroups.length}</span></div>
      </div>
      <div className="stat-card">
        <div className="stat-label">Freigegeben</div>
        <div className="stat-value green">{freigegebene}</div>
      </div>
      <div className="stat-card">
        <div className="stat-label">Gesamtsumme</div>
        <div className="stat-value gold">{fmtEur(totalAuszahlung)}</div>
      </div>
    </div>

    {loading ? <div className="loading"><div className="spinner"/>Lade Daten...</div> :
      vtGroups.length === 0 ? <div className="empty-state"><div className="icon">üì≠</div><h3>Keine Daten f√ºr {periodenLabel(periode)}</h3><p>F√ºr diese Periode liegen noch keine Auszahlungsdaten vor.</p></div> :
      <div className="main-grid">
        {vtGroups.map(g => {
          const ab = g.abrechnung;
          const kuerzel = ab?.kuerzel || genKuerzel(g.name);
          const status = ab?.status || 'neu';
          return <div key={g.name} className="vt-card" onClick={() => setSelectedVt({ name: g.name, abrechnungId: ab?.id, data: g.items })}>
            <div className="vt-card-header">
              <span className="vt-name">{g.name}</span>
              <span className="vt-kuerzel">{kuerzel}</span>
            </div>
            <div className="vt-sales">{g.items.length} Positionen</div>
            <div className="vt-betrag">{fmtEur(ab ? ab.auszahlungssumme : g.total)}</div>
            <div className="vt-card-footer">
              <span className={`badge ${status === 'neu' ? 'badge-entwurf' : status === 'entwurf' ? 'badge-entwurf' : status === 'probeabrechnung' ? 'badge-probe' : status === 'freigegeben' ? 'badge-freigegeben' : 'badge-ausgezahlt'}`}>
                {status === 'neu' ? '‚¨ú Neu' : status === 'entwurf' ? 'üìù Entwurf' : status === 'probeabrechnung' ? 'üîç Probe' : status === 'freigegeben' ? '‚úÖ Freigegeben' : 'üí∏ Ausgezahlt'}
              </span>
              <span style={{fontSize:11,color:'#484f58'}}>{ab ? `${ab.anzahl_sales || 0} Sales` : ''}</span>
            </div>
          </div>;
        })}
      </div>
    }

    {selectedVt && <DetailView
      abrechnungId={selectedVt.abrechnungId}
      periode={periode}
      vtName={selectedVt.name}
      vtData={selectedVt.data}
      systemgebuehr={systemgebuehr}
      onClose={() => setSelectedVt(null)}
      onRefresh={loadPeriode}
    />}
  </ToastProvider>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
