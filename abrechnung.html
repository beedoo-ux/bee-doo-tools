<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo | Probeabrechnung</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#0a0a0f;color:#c9d1d9;min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#161b22}::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}
.app-header{background:#0d1117;border-bottom:1px solid #21262d;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo-area{display:flex;align-items:center;gap:12px}
.logo-text{font-size:22px;font-weight:800;letter-spacing:-0.5px}.logo-text span{color:#F5C500}
.logo-sub{font-size:11px;color:#8b949e;letter-spacing:1px;text-transform:uppercase}
.controls-bar{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.sel-period{background:#161b22;border:1px solid #30363d;color:#c9d1d9;padding:8px 14px;border-radius:8px;font-family:'DM Sans';font-size:14px;cursor:pointer}
.sel-period:focus{outline:none;border-color:#F5C500}
.btn{padding:8px 16px;border-radius:8px;font-family:'DM Sans';font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:#F5C500;color:#0a0a0f}.btn-primary:hover{background:#e6b800}
.btn-secondary{background:#21262d;color:#c9d1d9;border:1px solid #30363d}.btn-secondary:hover{background:#30363d}
.btn-success{background:#238636;color:#fff}.btn-success:hover{background:#2ea043}
.btn-danger{background:#da3633;color:#fff}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}
.stats-row{display:flex;gap:16px;padding:16px 24px;flex-wrap:wrap}
.stat-card{background:#161b22;border:1px solid #21262d;border-radius:10px;padding:14px 18px;flex:1;min-width:140px}
.stat-label{font-size:11px;color:#8b949e;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.stat-value{font-size:22px;font-weight:700;color:#e6edf3}.stat-value.gold{color:#F5C500}.stat-value.green{color:#3fb950}
.main-grid{padding:0 24px 24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.vt-card{background:#161b22;border:1px solid #21262d;border-radius:12px;padding:16px;cursor:pointer;transition:all .2s}
.vt-card:hover{border-color:#F5C500;transform:translateY(-2px)}
.vt-card.hgb{border-left:3px solid #F5C500}
.vt-card.angestellt{border-left:3px solid #58a6ff}
.vt-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.vt-name{font-size:15px;font-weight:700;color:#e6edf3}
.vt-kuerzel{font-size:11px;color:#8b949e;background:#21262d;padding:2px 8px;border-radius:4px}
.vt-sales{font-size:12px;color:#8b949e;margin-bottom:6px}
.vt-betrag{font-size:20px;font-weight:800;color:#F5C500}
.vt-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:8px;border-top:1px solid #21262d}
.badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:0.3px}
.badge-entwurf{background:#30363d;color:#8b949e}
.badge-probe{background:#1f2d1f;color:#F5C500;border:1px solid #F5C50040}
.badge-freigegeben{background:#0d2818;color:#3fb950;border:1px solid #3fb95040}
.badge-ausgezahlt{background:#0d1d2d;color:#58a6ff;border:1px solid #58a6ff40}
.detail-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;display:flex;justify-content:center;align-items:stretch}
.detail-container{background:#0d1117;width:100%;max-width:1400px;display:flex;flex-direction:column;overflow:hidden}
.detail-header{background:#161b22;border-bottom:1px solid #21262d;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.detail-body{display:flex;flex:1;overflow:hidden}
.edit-panel{width:420px;min-width:380px;background:#0d1117;border-right:1px solid #21262d;overflow-y:auto;padding:16px;flex-shrink:0}
.preview-panel{flex:1;overflow-y:auto;background:#2d2d2d;padding:20px;display:flex;justify-content:center}
.edit-section{margin-bottom:16px}
.edit-section-title{font-size:12px;font-weight:700;color:#F5C500;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #21262d}
.pos-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#161b22;border:1px solid #21262d;border-radius:8px;margin-bottom:6px;font-size:12px;transition:all .2s}
.pos-row.inactive{opacity:.4;background:#0d1117}
.pos-row .pos-kunde{flex:1;color:#c9d1d9;font-weight:500}
.pos-row .pos-betrag{font-weight:700;color:#e6edf3;min-width:80px;text-align:right}
.toggle-btn{width:28px;height:16px;border-radius:8px;border:none;cursor:pointer;position:relative;transition:background .2s}
.toggle-btn.active{background:#238636}.toggle-btn.inactive-toggle{background:#484f58}
.toggle-btn::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:#fff;top:2px;transition:left .2s}
.toggle-btn.active::after{left:14px}.toggle-btn.inactive-toggle::after{left:2px}
.override-input{background:#21262d;border:1px solid #30363d;color:#F5C500;padding:4px 8px;border-radius:4px;width:80px;text-align:right;font-family:'DM Sans';font-size:12px;font-weight:600}
.override-input:focus{outline:none;border-color:#F5C500}
.extra-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.extra-input{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:6px 10px;border-radius:6px;font-family:'DM Sans';font-size:12px;flex:1}
.extra-input:focus{outline:none;border-color:#F5C500}
.extra-amount{width:100px}
.notes-area{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:10px;border-radius:8px;font-family:'DM Sans';font-size:12px;width:100%;min-height:60px;resize:vertical}
.notes-area:focus{outline:none;border-color:#F5C500}
/* PDF Page */
.gs-page{background:#fff;width:210mm;min-height:297mm;padding:0;position:relative;color:#111;font-family:Arial,sans-serif;font-size:11px;box-shadow:0 4px 24px rgba(0,0,0,.4);overflow:hidden;display:flex;flex-direction:column}
.gs-page *{color:#111}
.gs-watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-35deg);font-size:82px;font-weight:900;color:rgba(200,0,0,0.18);letter-spacing:10px;text-transform:uppercase;pointer-events:none;z-index:1;white-space:nowrap;text-shadow:0 0 2px rgba(200,0,0,0.1)}
.gs-branded-header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);padding:18mm 16mm 12mm;color:#fff!important;position:relative;overflow:hidden}
.gs-branded-header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#F5C500,#E07800,#F5C500)}
.gs-branded-header *{color:#fff!important}
.gs-body{padding:8mm 16mm 12mm;position:relative;z-index:2;flex:1;display:flex;flex-direction:column}
.gs-footer{margin-top:auto;padding:10px 16mm 8px 16mm;border-top:1.5px solid #ccc;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0}
.gs-footer-col{font-size:7px;color:#888!important;line-height:1.5;padding:0 6px}
.gs-footer-col:first-child{padding-left:0}.gs-footer-col:last-child{padding-right:0}
.gs-footer-col b{font-size:7.5px;color:#444!important;display:block;margin-bottom:1px;text-transform:uppercase;letter-spacing:0.3px}
.empty-state{text-align:center;padding:60px 20px;color:#484f58}
.empty-state .icon{font-size:48px;margin-bottom:12px}
.empty-state h3{font-size:16px;color:#8b949e;margin-bottom:6px}
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#8b949e}
.spinner{width:20px;height:20px;border:2px solid #30363d;border-top-color:#F5C500;border-radius:50%;animation:spin .6s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;background:#161b22;border:1px solid #21262d;border-radius:10px;padding:12px 20px;font-size:13px;color:#c9d1d9;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideUp .3s ease}
.toast.success{border-color:#238636;color:#3fb950}.toast.error{border-color:#da3633;color:#f85149}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:768px){.app-header{padding:12px 16px}.stats-row{padding:12px 16px;gap:10px}.stat-card{min-width:120px;padding:10px 14px}.stat-value{font-size:18px}.main-grid{padding:0 16px 16px;grid-template-columns:1fr}.detail-body{flex-direction:column}.edit-panel{width:100%;min-width:unset;max-height:50vh;border-right:none;border-bottom:1px solid #21262d}.preview-panel{padding:10px}.gs-page{width:100%;min-height:auto}.controls-bar{width:100%;justify-content:flex-end}}
@media(max-width:480px){.stats-row{flex-direction:column}.stat-card{min-width:unset}.detail-header{flex-direction:column;gap:8px;align-items:flex-start}.edit-panel{padding:12px}.pos-row{flex-wrap:wrap}}
@media print{body{background:#fff}.app-header,.stats-row,.main-grid,.edit-panel,.detail-header,.detail-overlay{display:none!important}.preview-panel{background:#fff;padding:0}.gs-page{box-shadow:none;page-break-after:always}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, useMemo } = React;
const SB_URL = 'https://hqzpemfaljxcysyqssng.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
const HDR = { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

const fmt = (n) => new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0);
const fmtE = (n) => fmt(n)+'\u00a0‚Ç¨';
const pLabel = (p) => {if(!p)return'‚Äî';const[y,m]=p.split('/');const mo=['','Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];return `${mo[parseInt(m)]} ${y}`;};
const gK = (name) => {const p=name.trim().split(/\s+/);return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():name.slice(0,2).toUpperCase();};
const gBN = (per,k,nr) => `GS-${per.replace('/','-')}-${k}-${String(nr||1).padStart(3,'0')}`;

const sbG = async(t,q='')=>{const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{headers:HDR});if(!r.ok)throw new Error(`GET ${t}:${r.status}`);return r.json();};
const sbP = async(t,d)=>{const r=await fetch(`${SB_URL}/rest/v1/${t}`,{method:'POST',headers:{...HDR,'Prefer':'return=representation'},body:JSON.stringify(d)});if(!r.ok){const x=await r.text();throw new Error(`POST ${t}:${x}`);}return r.json();};
const sbU = async(t,q,d)=>{const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{method:'PATCH',headers:{...HDR,'Prefer':'return=representation'},body:JSON.stringify(d)});if(!r.ok)throw new Error(`PATCH ${t}:${r.status}`);return r.json();};
const sbD = async(t,q)=>{const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{method:'DELETE',headers:HDR});if(!r.ok)throw new Error(`DEL ${t}:${r.status}`);};

async function generateAbrechnungen(periode, onProgress){
  const [y,m] = periode.split('/');
  const log = (msg) => onProgress?.(msg);
  log('Lade Daten...');
  const [regeln, stufen, mitarbeiter, auftraege, sgArr] = await Promise.all([
    sbG('provisions_regeln','aktiv=eq.true'),
    sbG('pay_stufenbonus','aktiv=eq.true&order=min_anlagen.asc'),
    sbG('pay_mitarbeiter','aktiv=eq.true&select=id,vorname,nachname,kuerzel,typ,provisions_regel_id,strasse,plz,ort,steuernummer,kleinunternehmer,mwst_pflichtig'),
    sbG('pay_auftraege','storniert=eq.false&zahlungsstatus=eq.anzahlung_eingegangen&abgerechnet_monat=is.null&select=*'),
    sbG('pay_systemgebuehr','aktiv=eq.true&limit=1'),
  ]);
  const sgConfig = sgArr[0] || {prozent:3, max_netto:200, ust_satz:19};
  const regelMap = {}; regeln.forEach(r => regelMap[r.mitarbeiter_typ] = r);
  const typMap = {hgb_vertriebler_haupt:'hgb_vertriebler_haupt',hgb84:'hgb_vertriebler_haupt',angestellt_vt:'angestellt_vertriebler',angestellt_vertriebler:'angestellt_vertriebler',hgb_vertriebler_agentur:'hgb_vertriebler_agentur',vertriebler:'vertriebler',hgb_scouter:'hgb_scouter',angestellt_scouter:'angestellt_scouter'};
  const vpById = {}; mitarbeiter.forEach(v => { vpById[v.id] = v; });
  const byVP = {};
  auftraege.forEach(a => { if(!a.vertriebler_id) return; if(!byVP[a.vertriebler_id]) byVP[a.vertriebler_id] = []; byVP[a.vertriebler_id].push(a); });
  const allRelevant = await sbG('pay_auftraege','storniert=eq.false&zahlungsstatus=eq.anzahlung_eingegangen&select=vertriebler_id,auftrags_datum');
  const salesPerVPMonth = {};
  allRelevant.forEach(a => { if(!a.vertriebler_id||!a.auftrags_datum) return; const om=a.auftrags_datum.substring(0,4)+'/'+a.auftrags_datum.substring(5,7); const key=a.vertriebler_id+'_'+om; salesPerVPMonth[key]=(salesPerVPMonth[key]||0)+1; });
  log('L√∂sche alte Entw√ºrfe...');
  const oldAbr = await sbG('pay_abrechnungen',`periode=eq.${periode}&status=in.(entwurf,probeabrechnung)&select=id`);
  for(const oa of oldAbr){ try{await sbD('pay_abrechnungen_positionen',`abrechnung_id=eq.${oa.id}`);}catch(e){} try{await sbD('pay_abrechnungen',`id=eq.${oa.id}`);}catch(e){} }
  let count = 0;
  for(const vpId of Object.keys(byVP)){
    const vp = vpById[vpId]; if(!vp) continue;
    const orders = byVP[vpId]; if(!orders.length) continue;
    const ruleTyp = typMap[vp.typ] || vp.typ;
    const regel = regelMap[ruleTyp];
    if(!regel){ log(`‚ö†Ô∏è ${vp.vorname} ${vp.nachname}: keine Regel f√ºr ${ruleTyp}`); continue; }
    const isHGB = (vp.typ||'').includes('hgb');
    const vpName = `${vp.vorname} ${vp.nachname}`;
    log(`Berechne ${vpName}...`);
    const ordersByMonth = {};
    orders.forEach(o => { const d=o.auftrags_datum||''; const om=d.substring(0,4)+'/'+d.substring(5,7); if(!ordersByMonth[om])ordersByMonth[om]=[]; ordersByMonth[om].push(o); });
    const positionen = []; let bruttoTotal = 0;
    for(const [om, monthOrders] of Object.entries(ordersByMonth)){
      const monthKey=vpId+'_'+om; const monthTotal=salesPerVPMonth[monthKey]||monthOrders.length;
      const staffel=monthTotal>=regel.staffel_schwelle;
      const baseBetrag=staffel?regel.staffel_betrag_sale:regel.basis_betrag_sale;
      for(const o of monthOrders){
        positionen.push({typ:'provision',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:`Solar ${o.kwp||0} kWp`,original_betrag:baseBetrag,aktiv:true,zurueckgestellt:false,notiz:`${om}${staffel?' (Staffel)':''}`});
        bruttoTotal+=baseBetrag;
        const q=(o.lead_quelle||'').toLowerCase();
        if(q.includes('eigenlead')&&regel.betrag_eigenlead>0){positionen.push({typ:'eigenlead',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Eigenlead-Bonus',original_betrag:regel.betrag_eigenlead,aktiv:true,zurueckgestellt:false,notiz:om}); bruttoTotal+=regel.betrag_eigenlead;}
        if(q.includes('empfehlung')&&regel.betrag_empfehlung>0){positionen.push({typ:'empfehlung',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Empfehlungs-Bonus',original_betrag:regel.betrag_empfehlung,aktiv:true,zurueckgestellt:false,notiz:om}); bruttoTotal+=regel.betrag_empfehlung;}
        if(o.speichererweiterung&&regel.betrag_speicher>0){positionen.push({typ:'speicher',auftrag_nr:o.auftrag_nr,kunde:o.kunde_name,produkt:'Speicher-Bonus',original_betrag:regel.betrag_speicher,aktiv:true,zurueckgestellt:false,notiz:om}); bruttoTotal+=regel.betrag_speicher;}
      }
    }
    let stufenBonus=0;
    for(const s of stufen){ if(s.gilt_fuer!==ruleTyp) continue; for(const [k,cnt] of Object.entries(salesPerVPMonth)){ if(!k.startsWith(vpId+'_')) continue; if(cnt>=s.min_anlagen&&s.bonus_betrag>stufenBonus) stufenBonus=s.bonus_betrag; } }
    if(stufenBonus>0){ positionen.push({typ:'einmalzahlung',auftrag_nr:null,kunde:null,produkt:'Stufenbonus',original_betrag:stufenBonus,aktiv:true,zurueckgestellt:false,notiz:'Stufenbonus'}); bruttoTotal+=stufenBonus; }
    const sgNetto=isHGB?Math.min(bruttoTotal*(sgConfig.prozent/100),sgConfig.max_netto):0;
    const sgUst=sgNetto*(sgConfig.ust_satz/100);
    const ustSatz=isHGB&&vp.mwst_pflichtig?19:0;
    const ustBetrag=bruttoTotal*(ustSatz/100);
    const abr=await sbP('pay_abrechnungen',{periode,mitarbeiter_name:vpName,kuerzel:vp.kuerzel||gK(vpName),beschaeftigungsart:isHGB?'hgb':'angestellt',status:'entwurf',anzahl_sales:orders.length,brutto_provisionen:Math.round(bruttoTotal*100)/100,systemgebuehr_netto:Math.round(sgNetto*100)/100,systemgebuehr_ust:Math.round(sgUst*100)/100,nettobetrag:Math.round(bruttoTotal*100)/100,ust_satz:ustSatz,ust_betrag:Math.round(ustBetrag*100)/100,auszahlungssumme:Math.round((bruttoTotal+ustBetrag)*100)/100});
    const abrId=Array.isArray(abr)?abr[0].id:abr.id;
    const posData=positionen.map(p=>({...p,abrechnung_id:abrId}));
    for(let i=0;i<posData.length;i+=50){await sbP('pay_abrechnungen_positionen',posData.slice(i,i+50));}
    count++;
  }
  log(`‚úÖ ${count} Abrechnungen generiert!`);
  return count;
}

function calc(pos,sg,hgb){
  const ak=pos.filter(p=>p.aktiv&&!p.zurueckgestellt);
  const prov=ak.filter(p=>['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const extra=ak.filter(p=>['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const bp=prov.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  const es=extra.reduce((s,p)=>s+(p.override_betrag!=null?p.override_betrag:p.original_betrag),0);
  let sgN=0,sgU=0;if(hgb&&sg){sgN=Math.min(bp*(sg.prozent/100),sg.max_netto);sgU=sgN*(sg.ust_satz/100);}
  const net=bp+es;const uS=hgb?19:0;const uB=net*(uS/100);
  return{sales:prov.filter(p=>p.typ==='provision').length,bp,sgN:Math.round(sgN*100)/100,sgU:Math.round(sgU*100)/100,es,net:Math.round(net*100)/100,uS,uB:Math.round(uB*100)/100,aus:Math.round((net+uB)*100)/100};
}

let tt=null;
function Toast({children}){const[t,setT]=useState(null);window.__t=(m,ty='success')=>{clearTimeout(tt);setT({m,ty});tt=setTimeout(()=>setT(null),3000);};return<>{children}{t&&<div className={`toast ${t.ty}`}>{t.m}</div>}</>;}

function GutschriftPreview({ab,pos,sg}){
  const b=calc(pos,sg,ab.beschaeftigungsart==='hgb');
  const aP=pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const aE=pos.filter(p=>p.aktiv&&!p.zurueckgestellt&&['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const k=ab.kuerzel||gK(ab.mitarbeiter_name),bn=gBN(ab.periode,k,1),hgb=ab.beschaeftigungsart==='hgb';
  const heute=new Date().toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'});
  const isE=ab.status==='entwurf'||ab.status==='probeabrechnung';
  const isF=ab.status==='freigegeben'||ab.status==='ausgezahlt';
  const staffel=8,pct=Math.min((b.sales/staffel)*100,100),hatS=b.sales>=staffel;
  const verifyData=JSON.stringify({typ:'gutschrift',nr:bn,vt:ab.mitarbeiter_name,brutto:b.aus,netto:b.net,ust:b.uB,datum:heute,per:ab.periode});
  const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=54x54&data=${encodeURIComponent(`https://bee-doo-tools.vercel.app/verify.html?d=${btoa(verifyData)}`)}&bgcolor=ffffff&color=1a1a2e&margin=1`;
  const giroIBAN='DE90254501100031039985';
  const giroBIC='NOLADE21SWB';
  const giroSgBrutto=(b.sgN+b.sgU).toFixed(2);
  const giroRef=`SG ${bn}`;
  const giroPayload=`BCD\n002\n1\nSCT\n${giroBIC}\nbee-doo GmbH\n${giroIBAN}\nEUR${giroSgBrutto}\n\n${giroRef}\nSystemgebuehr ${ab.periode} ${ab.mitarbeiter_name}`;
  const giroQrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(giroPayload)}&bgcolor=ffffff&color=1a1a2e&margin=1`;

  const FooterBlock = () => <div className="gs-footer">
    <div className="gs-footer-col"><b>Firmensitz</b>bee-doo GmbH<br/>Am Stadtholz 39<br/>D-33609 Bielefeld</div>
    <div className="gs-footer-col"><b>Kontakt</b>www.bee-doo.de<br/>info@bee-doo.de<br/>Fon: 0800 22 33 664</div>
    <div className="gs-footer-col"><b>Bankverbindung</b>IBAN DE90 2545 0110 0031 0399 85<br/>BIC NOLADE21SWB<br/>Sparkasse Bielefeld</div>
    <div className="gs-footer-col"><b>Handelsregister</b>HRB 46243 AG Bielefeld<br/>GF: Patrick Grabowski, Olaf Schader<br/>StNr: 44/214/0394 ¬∑ USt-Id: DE323940446</div>
  </div>;

  return <div style={{display:'flex',flexDirection:'column',gap:20}}>
    {/* === SEITE 1 === */}
    <div className="gs-page">
      {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
      <div className="gs-branded-header">
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
          <div>
            <div style={{fontFamily:"'Arial Black',Arial",fontSize:28,fontWeight:900,letterSpacing:-1}}>bee<span style={{color:'#F5C500'}}>-doo</span></div>
            <div style={{fontSize:8,color:'rgba(255,255,255,.5)',letterSpacing:2,textTransform:'uppercase',marginTop:2}}>Energy for you</div>
          </div>
          <div style={{display:'flex',alignItems:'flex-start',gap:12}}>
            <div style={{textAlign:'right',fontSize:11}}>
              <div><span style={{color:'rgba(255,255,255,.5)',fontSize:9}}>Datum</span><br/><b>{heute}</b></div>
              <div style={{marginTop:4}}><span style={{color:'rgba(255,255,255,.5)',fontSize:9}}>Leistungszeitraum</span><br/><b>{pLabel(ab.periode)}</b></div>
            </div>
            <div style={{width:48,height:48,background:'#fff',borderRadius:5,padding:2,boxShadow:'0 2px 8px rgba(0,0,0,.3)',flexShrink:0}}>
              <img src={qrUrl} width={44} height={44} style={{display:'block',borderRadius:2}} alt="QR"/>
            </div>
          </div>
        </div>
        <div style={{fontSize:16,fontWeight:700,marginTop:10,letterSpacing:.5}}>{hgb?'Gutschrift':'Entgeltabrechnung'} {bn}</div>
        <div style={{fontSize:10,color:'rgba(255,255,255,.6)',marginTop:2}}>{ab.mitarbeiter_name} ¬∑ {pLabel(ab.periode)}</div>
      </div>

      <div className="gs-body">
        <div style={{fontSize:8.5,color:'#888',borderBottom:'1px dotted #ccc',paddingBottom:4,marginBottom:8}}>bee-doo GmbH ¬∑ Am Stadtholz 39 ¬∑ D-33609 Bielefeld ¬∑ StNr: 44/214/0394 ¬∑ USt-IdNr.: DE323940446</div>
        <div style={{fontSize:12,fontWeight:700,marginBottom:2}}>{ab.mitarbeiter_name}</div>
        <div style={{fontSize:11,color:'#444',lineHeight:1.7,marginBottom:2}}>{window.__vpData?.strasse?`${window.__vpData.strasse} ${window.__vpData.hausnr||''}`:'‚Äî'}<br/>{window.__vpData?.plz?`${window.__vpData.plz} ${window.__vpData.ort||''}`:'‚Äî'}</div>
        <div style={{fontSize:9.5,color:'#888',marginBottom:12}}>{(()=>{const vp=window.__vpData;const stnr=vp?.steuernummer&&vp.steuernummer.length>4&&/\d/.test(vp.steuernummer)?vp.steuernummer:null;const uid=vp?.ustid&&/^DE\d{9}$/.test(vp.ustid)?vp.ustid:null;if(stnr||uid)return(stnr?`Steuernr.: ${stnr}`:'')+(stnr&&uid?' ¬∑ ':'')+(uid?`USt-IdNr.: ${uid}`:'');return hgb?'HGB ¬ß84 Handelsvertreter ‚Äì ‚ö†Ô∏è Steuerdaten unvollst√§ndig':'Angestellt';})()}</div>
        <div style={{borderTop:'1px solid #eee',marginBottom:10}}></div>

        <div style={{display:'grid',gridTemplateColumns:'56% 42%',gap:'2%'}}>
          <div>
            <table style={{width:'100%',borderCollapse:'collapse',fontSize:11}}><tbody>
              <tr><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',color:'#E07800'}}>Provisionen ({b.sales} Sales ‚Äì Vermittlung Solar/WP)</td><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtE(b.bp)}</td></tr>
              {aE.map((p,i)=><tr key={i}><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',color:(p.override_betrag!=null?p.override_betrag:p.original_betrag)>=0?'#E07800':'#9a3412'}}>{p.kunde||p.notiz||p.typ}</td><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
              <tr><td style={{padding:'6px 10px',borderBottom:'2px solid #aaa',fontWeight:700}}>Brutto-Provisionen</td><td style={{padding:'6px 10px',borderBottom:'2px solid #aaa',textAlign:'right',fontWeight:700}}>{fmtE(b.bp+b.es)}</td></tr>
              <tr><td style={{padding:'6px 10px',borderTop:'2px solid #111',borderBottom:'1px solid #eee',color:'#555'}}>Nettobetrag</td><td style={{padding:'6px 10px',borderTop:'2px solid #111',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtE(b.net)}</td></tr>
              {hgb&&<tr style={{background:'#fffbeb'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #fde68a',color:'#92400e',fontWeight:600}}>+ Umsatzsteuer 19%</td><td style={{padding:'6px 10px',borderBottom:'1px solid #fde68a',textAlign:'right',color:'#92400e',fontWeight:600}}>+ {fmtE(b.uB)}</td></tr>}
              <tr style={{background:'linear-gradient(135deg,#f0fdf4,#dcfce7)'}}><td style={{padding:'9px 10px',fontWeight:800,fontSize:13}}>AUSZAHLUNGSSUMME</td><td style={{padding:'9px 10px',textAlign:'right',fontWeight:800,fontSize:13,color:'#166534',whiteSpace:'nowrap'}}>{fmtE(b.aus)}</td></tr>
            </tbody></table>
          </div>
          <div>
            <div style={{fontSize:10,fontWeight:700,color:'#E07800',marginBottom:5,paddingBottom:3,borderBottom:'1px solid #eee'}}>Sales {pLabel(ab.periode)}</div>
            <table style={{width:'100%',borderCollapse:'collapse',fontSize:10}}><tbody>
              <tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#555'}}>Abgerechnete Sales</td><td style={{padding:'4px 7px',textAlign:'right',fontWeight:700}}>{b.sales}</td></tr>
              <tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#555'}}>Provisionen Netto</td><td style={{padding:'4px 7px',textAlign:'right'}}>{fmtE(b.net)}</td></tr>
              {hgb&&<tr><td style={{padding:'4px 7px',borderBottom:'1px solid #eee',color:'#92400e'}}>+ USt 19%</td><td style={{padding:'4px 7px',textAlign:'right',color:'#92400e'}}>+ {fmtE(b.uB)}</td></tr>}
              <tr style={{background:'#f0fdf4'}}><td style={{padding:'4px 7px',fontWeight:700}}>Auszahlung</td><td style={{padding:'4px 7px',textAlign:'right',fontWeight:700,color:'#166534'}}>{fmtE(b.aus)}</td></tr>
            </tbody></table>

            {hgb&&b.sgN>0&&<div style={{marginTop:12,background:'#fff7ed',border:'1px solid #fed7aa',borderRadius:6,padding:'8px 10px',fontSize:9}}>
              <b style={{color:'#9a3412'}}>üìÑ Systemgeb√ºhr:</b> <span style={{color:'#78350f'}}>Separate Rechnung anbei ({fmtE(b.sgN+b.sgU)} brutto)</span>
            </div>}

            {hatS&&<div style={{marginTop:12,background:'linear-gradient(135deg,#fffbeb,#fef3c7)',border:'1px solid #f59e0b',borderRadius:6,padding:'8px 10px'}}>
              <div style={{fontSize:9,fontWeight:700,color:'#92400e',textTransform:'uppercase',letterSpacing:.5,marginBottom:4}}>‚≠ê Staffel-Bonus erreicht!</div>
              <div style={{fontSize:10,color:'#78350f',fontWeight:600}}>{b.sales} Sales ‚â• {staffel} ‚Üí Erh√∂hte Rate aktiv</div>
            </div>}

            <div style={{marginTop:10,background:'#f8fafc',border:'1px solid #e2e8f0',borderRadius:6,padding:'8px 10px'}}>
              <div style={{fontSize:9,color:'#475569',marginBottom:4,display:'flex',justifyContent:'space-between'}}>
                <span>Staffel-Fortschritt</span>
                <span style={{fontWeight:700,color:hatS?'#16a34a':'#475569'}}>{b.sales} / {staffel}</span>
              </div>
              <div style={{height:8,background:'#e2e8f0',borderRadius:4,overflow:'hidden'}}>
                <div style={{height:'100%',borderRadius:4,width:`${pct}%`,background:hatS?'linear-gradient(90deg,#22c55e,#16a34a)':'linear-gradient(90deg,#F5C500,#E07800)'}}></div>
              </div>
              {!hatS&&<div style={{fontSize:8,color:'#94a3b8',marginTop:3,textAlign:'right'}}>Noch {staffel-b.sales} Sales bis zur n√§chsten Stufe</div>}
            </div>

            <div style={{marginTop:10,background:'#fff7ed',border:'1px solid #fed7aa',borderRadius:6,padding:'8px 10px',fontSize:9}}>
              <b style={{color:'#9a3412'}}>üìã Stornoreserve:</b> <span style={{color:'#78350f'}}>Derzeit keine Stornoreserve einbehalten.</span>
            </div>
          </div>
        </div>

        <div style={{marginTop:14,fontSize:9.5,color:'#555',lineHeight:1.6,borderTop:'1px solid #eee',paddingTop:8}}>
          {hgb?`Diese Gutschrift gem. ¬ß14 Abs. 2 UStG ersetzt die Rechnung des Leistungserbringers (gem. Gutschriftvereinbarung HVV). Nettobetrag: ${fmtE(b.net)} ¬∑ zzgl. 19% USt: ${fmtE(b.uB)} ¬∑ Brutto: ${fmtE(b.aus)}. Die Systemgeb√ºhr gem. Ziff. 4.2 HVV wird separat per Rechnung der bee-doo GmbH abgerechnet. Empf√§nger: ${ab.mitarbeiter_name}${window.__vpData?.ustid&&/^DE\d{9}$/.test(window.__vpData.ustid)?', USt-IdNr.: '+window.__vpData.ustid:''}${window.__vpData?.steuernummer&&window.__vpData.steuernummer.length>4?', StNr.: '+window.__vpData.steuernummer:''}. Aussteller: bee-doo GmbH, USt-IdNr. DE323940446, StNr. 44/214/0394.`
          :`Entgeltabrechnung ${ab.mitarbeiter_name}. Nettobetrag: ${fmtE(b.net)}.`}
        </div>
        <FooterBlock/>
      </div>
    </div>

    {/* === SEITE 2 === */}
    <div className="gs-page" style={{padding:'14mm 16mm 28mm'}}>
      {isE&&<div className="gs-watermark">{ab.status==='probeabrechnung'?'PROBEABRECHNUNG':'ENTWURF'}</div>}
      <div style={{fontSize:8.5,color:'#555',borderBottom:'1px solid #ddd',paddingBottom:5,marginBottom:12,display:'flex',justifyContent:'space-between'}}>
        <span>Provisionen {pLabel(ab.periode)}</span><span style={{color:'#aaa'}}>{bn} ¬∑ Seite 2</span>
      </div>
      <div style={{fontSize:17,fontWeight:700,marginBottom:14}}>{ab.mitarbeiter_name} <span style={{fontSize:11,color:'#888',fontWeight:400}}>({k})</span></div>
      <div style={{color:'#E07800',fontWeight:700,fontSize:11,marginBottom:7,borderBottom:'1px solid #eee',paddingBottom:3}}>Einzelpositionen</div>
      {(()=>{
        /* Group positions by auftrag_nr for tree structure */
        const groups = [];
        const byAN = {};
        aP.forEach(p => {
          const an = p.auftrag_nr || '‚Äî';
          if(!byAN[an]) { byAN[an] = {main:null,boni:[]}; groups.push(an); }
          if(p.typ==='provision') byAN[an].main = p;
          else byAN[an].boni.push(p);
        });
        let posNr = 0;
        return <table style={{width:'100%',borderCollapse:'collapse',fontSize:10}}>
          <thead><tr style={{background:'#f5f5f5'}}><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888',width:24}}>Nr</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888'}}>Kunde / Position</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:8,textTransform:'uppercase',color:'#888',width:80}}>Quelle</th><th style={{padding:'4px 6px',borderBottom:'2px solid #ddd',textAlign:'right',fontSize:8,textTransform:'uppercase',color:'#888',width:80}}>Betrag</th></tr></thead>
          <tbody>
          {groups.map(an => {
            const g = byAN[an]; posNr++;
            const m = g.main; if(!m) return null;
            const boni = g.boni;
            const posSum = (m.override_betrag!=null?m.override_betrag:m.original_betrag) + boni.reduce((s,b)=>s+(b.override_betrag!=null?b.override_betrag:b.original_betrag),0);
            const hasBoni = boni.length > 0;
            return <React.Fragment key={an}>
              <tr style={{borderBottom:hasBoni?'none':'1px solid #eee'}}>
                <td style={{padding:'5px 6px',color:'#aaa',fontSize:9,verticalAlign:'top'}}>{posNr}.</td>
                <td style={{padding:'5px 6px'}} colSpan={hasBoni?1:1}>
                  <div style={{fontWeight:600}}>{m.kunde||'‚Äî'}</div>
                  <div style={{fontSize:8.5,color:'#888'}}>{m.produkt} ¬∑ {m.notiz||''}</div>
                </td>
                <td style={{padding:'5px 6px',color:'#888',fontSize:9,verticalAlign:'top'}}>{an}</td>
                <td style={{padding:'5px 6px',textAlign:'right',verticalAlign:'top'}}>{hasBoni?'':<span style={{fontWeight:600,whiteSpace:'nowrap'}}>{fmtE(m.override_betrag!=null?m.override_betrag:m.original_betrag)}</span>}</td>
              </tr>
              {hasBoni && <>
                <tr><td></td><td colSpan={2} style={{padding:'1px 6px 1px 16px',fontSize:9,color:'#666'}}>‚îú‚îÄ Grundprovision</td><td style={{padding:'1px 6px',textAlign:'right',fontSize:9,color:'#666',whiteSpace:'nowrap'}}>{fmtE(m.override_betrag!=null?m.override_betrag:m.original_betrag)}</td></tr>
                {boni.map((b,bi) => <tr key={bi}><td></td><td colSpan={2} style={{padding:'1px 6px 1px 16px',fontSize:9,color:b.typ==='eigenlead'?'#B45309':b.typ==='empfehlung'?'#7C3AED':'#0369a1'}}>{bi===boni.length-1?'‚îî‚îÄ':'‚îú‚îÄ'} {b.produkt}</td><td style={{padding:'1px 6px',textAlign:'right',fontSize:9,color:b.typ==='eigenlead'?'#B45309':b.typ==='empfehlung'?'#7C3AED':'#0369a1',whiteSpace:'nowrap'}}>+ {fmtE(b.override_betrag!=null?b.override_betrag:b.original_betrag)}</td></tr>)}
                <tr style={{borderBottom:'1px solid #eee'}}><td></td><td colSpan={2} style={{padding:'2px 6px 5px 16px',fontSize:9,fontWeight:700,color:'#333'}}>Summe Pos. {posNr}</td><td style={{padding:'2px 6px 5px',textAlign:'right',fontWeight:700,fontSize:10,whiteSpace:'nowrap'}}>{fmtE(posSum)}</td></tr>
              </>}
            </React.Fragment>;
          })}
          {aE.map((p,i)=><tr key={`e${i}`} style={{background:'#fffbeb',borderBottom:'1px solid #eee'}}><td style={{padding:'4px 6px',color:'#aaa',fontSize:9}}>‚Äî</td><td colSpan={2} style={{padding:'4px 6px',fontSize:10}}>{p.kunde||p.notiz||p.typ} <span style={{fontSize:9,color:'#888'}}>({p.typ==='einmalzahlung'?'Einmalzahlung':p.typ==='abzug'?'Abzug':'Sonstiges'})</span></td><td style={{padding:'4px 6px',textAlign:'right',fontWeight:600,whiteSpace:'nowrap'}}>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
          <tr style={{fontWeight:700,borderTop:'2px solid #333',background:'#f9f9f9'}}><td></td><td colSpan={2} style={{padding:'6px 6px'}}>Netto-Summe</td><td style={{padding:'6px 6px',textAlign:'right',whiteSpace:'nowrap'}}>{fmtE(b.bp+b.es)}</td></tr>
          <tr><td></td><td colSpan={2} style={{padding:'4px 6px',color:'#555',borderTop:'1px solid #ddd'}}>Nettobetrag</td><td style={{padding:'4px 6px',textAlign:'right',borderTop:'1px solid #ddd',whiteSpace:'nowrap'}}>{fmtE(b.net)}</td></tr>
          {hgb&&<tr style={{background:'#fffbeb'}}><td></td><td colSpan={2} style={{padding:'4px 6px',color:'#92400e'}}>+ USt 19%</td><td style={{padding:'4px 6px',textAlign:'right',color:'#92400e',fontWeight:700,whiteSpace:'nowrap'}}>+ {fmtE(b.uB)}</td></tr>}
          <tr style={{background:'linear-gradient(135deg,#f0fdf4,#dcfce7)',borderTop:'2px solid #166534'}}><td></td><td colSpan={2} style={{padding:'7px 6px',fontWeight:800,fontSize:12}}>BRUTTO-AUSZAHLUNG</td><td style={{padding:'7px 6px',textAlign:'right',fontWeight:900,fontSize:13,color:'#166534',whiteSpace:'nowrap'}}>{fmtE(b.aus)}</td></tr>
        </tbody>
      </table>;
      })()}

      {ab.stb_kommentar&&<div style={{marginTop:16,padding:10,background:'#fff8e1',border:'1px solid #fde68a',borderRadius:4,fontSize:10}}><b style={{color:'#92400e'}}>üìé Kommentar Steuerberater:</b><br/>{ab.stb_kommentar}</div>}

      <div style={{marginTop:20,display:'grid',gridTemplateColumns:'1fr 1fr',gap:30}}>
        <div style={{textAlign:'center'}}><div style={{borderBottom:'1px solid #333',height:50,marginBottom:6}}></div><div style={{fontSize:9,color:'#888'}}>Datum, Unterschrift Gesch√§ftsf√ºhrer</div><div style={{fontSize:9,color:'#555',fontWeight:600}}>bee-doo GmbH</div></div>
        <div style={{textAlign:'center'}}>
          {isF&&<div style={{display:'inline-block',border:'2px solid #166534',color:'#166534',padding:'4px 12px',borderRadius:4,fontWeight:700,fontSize:11,transform:'rotate(-3deg)',marginTop:8}}>‚úì FREIGEGEBEN</div>}
          {isF&&<div style={{fontSize:9,color:'#166534',marginTop:4}}>{ab.freigegeben_von||'Patrick Grabowski'}<br/>{ab.freigegeben_am?new Date(ab.freigegeben_am).toLocaleDateString('de-DE'):heute}</div>}
          {!isF&&<div style={{height:50,display:'flex',alignItems:'center',justifyContent:'center',color:'#ccc',fontSize:10,fontStyle:'italic'}}>Ausstehend</div>}
          <div style={{fontSize:9,color:'#888'}}>Freigabe-Vermerk</div>
        </div>
      </div>
      <FooterBlock/>
    </div>

    {/* === SEITE 3: SYSTEMGEB√úHR-RECHNUNG (nur HGB) === */}
    {hgb&&b.sgN>0&&<div className="gs-page" style={{padding:'14mm 16mm 28mm'}}>
      <div className="gs-branded-header" style={{background:'linear-gradient(135deg,#1a1a2e 0%,#2d1810 100%)'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
          <div>
            <div style={{fontFamily:"'Arial Black',Arial",fontSize:28,fontWeight:900,letterSpacing:-1}}>bee<span style={{color:'#F5C500'}}>-doo</span></div>
            <div style={{fontSize:8,color:'rgba(255,255,255,.5)',letterSpacing:2,textTransform:'uppercase',marginTop:2}}>Energy for you</div>
          </div>
          <div style={{textAlign:'right',fontSize:11}}>
            <div><span style={{color:'rgba(255,255,255,.5)',fontSize:9}}>Rechnungsdatum</span><br/><b>{heute}</b></div>
          </div>
        </div>
        <div style={{fontSize:16,fontWeight:700,marginTop:10,letterSpacing:.5}}>Rechnung Systemgeb√ºhr</div>
        <div style={{fontSize:10,color:'rgba(255,255,255,.6)',marginTop:2}}>Rechnungsnr.: SG-{bn} ¬∑ {pLabel(ab.periode)}</div>
      </div>

      <div className="gs-body">
        <div style={{fontSize:8.5,color:'#888',borderBottom:'1px dotted #ccc',paddingBottom:4,marginBottom:8}}>bee-doo GmbH ¬∑ Am Stadtholz 39 ¬∑ D-33609 Bielefeld ¬∑ StNr: 44/214/0394 ¬∑ USt-IdNr.: DE323940446</div>
        <div style={{fontSize:11,color:'#888',marginBottom:4}}>Rechnung an:</div>
        <div style={{fontSize:12,fontWeight:700,marginBottom:2}}>{ab.mitarbeiter_name}</div>
        <div style={{fontSize:11,color:'#444',lineHeight:1.7,marginBottom:2}}>{window.__vpData?.strasse?`${window.__vpData.strasse} ${window.__vpData.hausnr||''}`:'‚Äî'}<br/>{window.__vpData?.plz?`${window.__vpData.plz} ${window.__vpData.ort||''}`:'‚Äî'}</div>
        <div style={{fontSize:9.5,color:'#888',marginBottom:14}}>{(()=>{const vp=window.__vpData;const uid=vp?.ustid&&/^DE\d{9}$/.test(vp.ustid)?vp.ustid:null;return uid?`USt-IdNr.: ${uid}`:'';})()}</div>
        <div style={{borderTop:'1px solid #eee',marginBottom:12}}></div>

        <div style={{fontSize:13,fontWeight:700,marginBottom:4}}>Rechnung: Systemgeb√ºhr gem. Ziff. 4.2 HVV</div>
        <div style={{fontSize:10,color:'#666',marginBottom:14}}>Leistungszeitraum: {pLabel(ab.periode)} ¬∑ Bezug: Gutschrift {bn}</div>

        <table style={{width:'100%',borderCollapse:'collapse',fontSize:11,marginBottom:20}}>
          <thead><tr style={{background:'#f5f5f5'}}><th style={{padding:'8px 10px',borderBottom:'2px solid #ddd',textAlign:'left',fontSize:9,textTransform:'uppercase',color:'#888'}}>Beschreibung</th><th style={{padding:'8px 10px',borderBottom:'2px solid #ddd',textAlign:'right',fontSize:9,textTransform:'uppercase',color:'#888'}}>Betrag</th></tr></thead>
          <tbody>
            <tr><td style={{padding:'8px 10px',borderBottom:'1px solid #eee'}}>Systemgeb√ºhr f√ºr Nutzung der bee-doo Vertriebsplattform<br/><span style={{fontSize:9,color:'#888'}}>3% auf Brutto-Provisionen ({fmtE(b.bp)}), max. 200,00 ‚Ç¨ netto</span></td><td style={{padding:'8px 10px',borderBottom:'1px solid #eee',textAlign:'right',fontWeight:600,whiteSpace:'nowrap'}}>{fmtE(b.sgN)}</td></tr>
            <tr><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',color:'#555'}}>Nettobetrag</td><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtE(b.sgN)}</td></tr>
            <tr style={{background:'#fffbeb'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #fde68a',color:'#92400e',fontWeight:600}}>+ Umsatzsteuer 19%</td><td style={{padding:'6px 10px',borderBottom:'1px solid #fde68a',textAlign:'right',color:'#92400e',fontWeight:600}}>+ {fmtE(b.sgU)}</td></tr>
            <tr style={{background:'linear-gradient(135deg,#fff7ed,#ffedd5)'}}><td style={{padding:'9px 10px',fontWeight:800,fontSize:13,color:'#9a3412'}}>RECHNUNGSBETRAG</td><td style={{padding:'9px 10px',textAlign:'right',fontWeight:800,fontSize:13,color:'#9a3412'}}>{fmtE(b.sgN+b.sgU)}</td></tr>
          </tbody>
        </table>

        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20,marginBottom:20}}>
          <div style={{background:'#f8fafc',border:'1px solid #e2e8f0',borderRadius:8,padding:14}}>
            <div style={{fontSize:10,fontWeight:700,color:'#475569',marginBottom:8}}>üì± Jetzt per QR bezahlen</div>
            <div style={{display:'flex',gap:12,alignItems:'center'}}>
              <div style={{background:'#fff',borderRadius:6,padding:4,border:'1px solid #e2e8f0'}}><img src={giroQrUrl} width={80} height={80} style={{display:'block'}} alt="GiroCode"/></div>
              <div style={{fontSize:9,color:'#64748b',lineHeight:1.5}}>
                Scannen Sie diesen EPC-QR-Code mit Ihrer Banking-App.<br/>
                <b style={{color:'#334155'}}>Betrag: {fmtE(b.sgN+b.sgU)}</b><br/>
                IBAN, Empf√§nger und Verwendungszweck werden automatisch eingetragen.
              </div>
            </div>
          </div>
          <div style={{background:'#f8fafc',border:'1px solid #e2e8f0',borderRadius:8,padding:14}}>
            <div style={{fontSize:10,fontWeight:700,color:'#475569',marginBottom:8}}>üè¶ Bankverbindung</div>
            <div style={{fontSize:10,color:'#475569',lineHeight:1.8}}>
              <b>Empf√§nger:</b> bee-doo GmbH<br/>
              <b>IBAN:</b> DE90 2545 0110 0031 0399 85<br/>
              <b>BIC:</b> NOLADE21SWB<br/>
              <b>Verwendung:</b> SG-{bn}<br/>
              <b>Betrag:</b> {fmtE(b.sgN+b.sgU)}
            </div>
          </div>
        </div>

        <div style={{fontSize:10,color:'#555',lineHeight:1.6,borderTop:'1px solid #eee',paddingTop:10,marginBottom:10}}>
          Zahlbar innerhalb von 14 Tagen nach Rechnungsdatum ohne Abzug. Der Rechnungsbetrag ({fmtE(b.sgN+b.sgU)}) wird alternativ mit der n√§chsten Gutschrift verrechnet.
        </div>
        <div style={{fontSize:9,color:'#888',lineHeight:1.5}}>
          Rechnungsaussteller: bee-doo GmbH, Am Stadtholz 39, 33609 Bielefeld, StNr. 44/214/0394, USt-IdNr. DE323940446.
          Gesch√§ftsf√ºhrer: Patrick Grabowski, Olaf Schader. HRB 46243 AG Bielefeld.
        </div>
        <FooterBlock/>
      </div>
    </div>}
  </div>;
}

function EditPanel({ab,pos,setPos,sg,onSave,onFrei,onPdf,onClose,setAb}){
  const b=calc(pos,sg,ab.beschaeftigungsart==='hgb');
  const prov=pos.filter(p=>['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const extra=pos.filter(p=>['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const lo=ab.status==='freigegeben'||ab.status==='ausgezahlt';
  const tgl=(i)=>{if(lo)return;const n=[...pos];n[i]={...n[i],aktiv:!n[i].aktiv};setPos(n);};
  const ovr=(i,v)=>{if(lo)return;const n=[...pos];n[i]={...n[i],override_betrag:v===''?null:parseFloat(v.replace(',','.'))||0};setPos(n);};
  const zur=(i)=>{if(lo)return;const n=[...pos];n[i]={...n[i],zurueckgestellt:!n[i].zurueckgestellt,aktiv:n[i].zurueckgestellt};setPos(n);};
  const addE=(t)=>setPos([...pos,{typ:t,auftrag_nr:'',kunde:'',produkt:'',original_betrag:0,override_betrag:null,aktiv:true,zurueckgestellt:false,notiz:'',isNew:true}]);
  const rmE=(i)=>{const n=[...pos];n.splice(i,1);setPos(n);};
  const upE=(i,f,v)=>{const n=[...pos];n[i]={...n[i],[f]:f==='original_betrag'?(parseFloat(v.replace(',','.'))||0):v};setPos(n);};

  return <div className="edit-panel">
    <div className="edit-section">
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
        <span className={`badge badge-${ab.status==='probeabrechnung'?'probe':ab.status}`}>{ab.status==='entwurf'?'üìù Entwurf':ab.status==='probeabrechnung'?'üîç Probe':ab.status==='freigegeben'?'‚úÖ Freigegeben':'üí∏ Ausgezahlt'}</span>
        <span style={{fontSize:11,color:'#8b949e'}}>{ab.mitarbeiter_name}</span>
      </div>
      <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
        <button className="btn btn-primary btn-sm" onClick={onSave} disabled={lo}>üíæ Speichern</button>
        {!lo&&<button className="btn btn-success btn-sm" onClick={onFrei}>‚úÖ Freigeben</button>}
        {ab.status==='freigegeben'&&<button className="btn btn-sm" style={{background:'#1f6feb',color:'#fff'}} onClick={()=>{setAb(p=>({...p,status:'ausgezahlt',ausgezahlt_am:new Date().toISOString()}));setTimeout(onSave,100);}}>üí∏ Ausgezahlt</button>}
        <button className="btn btn-secondary btn-sm" onClick={onPdf}>üìÑ PDF</button>
      </div>
    </div>
    <div className="edit-section">
      <div className="edit-section-title">üí∞ Zusammenfassung</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}><div style={{fontSize:10,color:'#8b949e'}}>Sales</div><div style={{fontSize:18,fontWeight:700,color:'#F5C500'}}>{b.sales}</div></div>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}><div style={{fontSize:10,color:'#8b949e'}}>Auszahlung</div><div style={{fontSize:16,fontWeight:700,color:'#3fb950'}}>{fmtE(b.aus)}</div></div>
      </div>
    </div>
    <div className="edit-section">
      <div className="edit-section-title">üìã Provisionen ({prov.filter(p=>p.aktiv&&!p.zurueckgestellt).length}/{prov.length})</div>
      {prov.map((p,i)=>{const gi=pos.indexOf(p);return <div key={i} className={`pos-row ${!p.aktiv?'inactive':''}`}>
        <button className={`toggle-btn ${p.aktiv?'active':'inactive-toggle'}`} onClick={()=>tgl(gi)} disabled={lo}/>
        <div className="pos-kunde" style={{fontSize:11}}>{p.kunde||'‚Äî'}{p.zurueckgestellt&&<span style={{fontSize:9,background:'#30363d',color:'#8b949e',padding:'1px 6px',borderRadius:3,marginLeft:6}}>‚è∏</span>}</div>
        <div className="pos-betrag" style={p.override_betrag!=null?{color:'#F5C500'}:{}}>{!lo?<input className="override-input" value={p.override_betrag!=null?p.override_betrag:p.original_betrag} onChange={e=>ovr(gi,e.target.value)}/>:<span>{fmtE(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</span>}</div>
        {!lo&&<button className="btn btn-sm" style={{padding:'2px 6px',fontSize:10,background:p.zurueckgestellt?'#238636':'#30363d',color:p.zurueckgestellt?'#fff':'#8b949e'}} onClick={()=>zur(gi)}>‚è∏</button>}
      </div>;})}
    </div>
    <div className="edit-section">
      <div className="edit-section-title">‚ûï Einmalzahlungen / Abz√ºge</div>
      {extra.map((p,i)=>{const gi=pos.indexOf(p);return <div key={i} className="extra-row">
        <input className="extra-input" placeholder="Bezeichnung" value={p.kunde||p.notiz||''} onChange={e=>upE(gi,'kunde',e.target.value)} disabled={lo}/>
        <input className="extra-input extra-amount" placeholder="Betrag" value={p.original_betrag||''} onChange={e=>upE(gi,'original_betrag',e.target.value)} disabled={lo}/>
        <select className="extra-input" style={{width:90}} value={p.typ} onChange={e=>upE(gi,'typ',e.target.value)} disabled={lo}><option value="einmalzahlung">+ Zahlung</option><option value="abzug">‚àí Abzug</option><option value="sonstiges">Sonstiges</option></select>
        {!lo&&<button className="btn btn-danger btn-sm btn-icon" onClick={()=>rmE(gi)}>‚úï</button>}
      </div>;})}
      {!lo&&<div style={{display:'flex',gap:6}}><button className="btn btn-secondary btn-sm" onClick={()=>addE('einmalzahlung')}>+ Zahlung</button><button className="btn btn-secondary btn-sm" onClick={()=>addE('abzug')}>‚àí Abzug</button></div>}
    </div>
    <div className="edit-section"><div className="edit-section-title">üìù Notizen</div><textarea className="notes-area" placeholder="Notizen..." value={ab.notizen||''} onChange={e=>setAb(p=>({...p,notizen:e.target.value}))} disabled={lo}/></div>
    <div className="edit-section"><div className="edit-section-title">üìé Steuerberater</div><textarea className="notes-area" placeholder="Kommentar..." value={ab.stb_kommentar||''} onChange={e=>setAb(p=>({...p,stb_kommentar:e.target.value}))} disabled={lo}/></div>
  </div>;
}

function DetailView({aId,per,vtN,vtD,sg,onClose,onRef}){
  const[ab,setAb]=useState(null);const[pos,setPos]=useState([]);const[ld,setLd]=useState(true);const ref=useRef(null);
  useEffect(()=>{load();},[aId]);
  const load=async()=>{setLd(true);try{
    // VP-Stammdaten laden
    const nameParts=vtN.trim().split(/\s+/);const vn=nameParts[0];const nn=nameParts.slice(1).join(' ');
    const vpArr=await sbG('pay_mitarbeiter',`vorname=eq.${encodeURIComponent(vn)}&nachname=eq.${encodeURIComponent(nn)}&limit=1`).catch(()=>[]);
    const vp=vpArr[0]||null;if(vp)window.__vpData=vp;
    if(aId){const[a,p]=await Promise.all([sbG('pay_abrechnungen',`id=eq.${aId}`),sbG('pay_abrechnungen_positionen',`abrechnung_id=eq.${aId}&order=erstellt_am.asc`)]);if(a.length){setAb(a[0]);setPos(p);}}else{setAb({periode:per,mitarbeiter_name:vtN,kuerzel:vp?.kuerzel||gK(vtN),beschaeftigungsart:vp?.typ?.startsWith('hgb')?'hgb':'angestellt',status:'entwurf',notizen:'',stb_kommentar:''});setPos((vtD||[]).map(d=>({typ:'provision',auftrag_nr:'',kunde:d.kunde,produkt:d.produkt,original_betrag:d.netto,override_betrag:null,aktiv:true,zurueckgestellt:false,notiz:'',isNew:true})));}}catch(e){window.__t?.('Fehler: '+e.message,'error');}setLd(false);};

  const save=async()=>{try{const b=calc(pos,sg,ab.beschaeftigungsart==='hgb');const d={...ab,anzahl_sales:b.sales,brutto_provisionen:b.bp,systemgebuehr_netto:b.sgN,systemgebuehr_ust:b.sgU,einmalzahlungen_summe:b.es,nettobetrag:b.net,ust_satz:b.uS,ust_betrag:b.uB,auszahlungssumme:b.aus,belegnummer:gBN(ab.periode,ab.kuerzel||gK(ab.mitarbeiter_name),1),geaendert_am:new Date().toISOString()};
  let s;if(ab.id){const{id,erstellt_am,...u}=d;s=(await sbU('pay_abrechnungen',`id=eq.${ab.id}`,u))[0];await sbD('pay_abrechnungen_positionen',`abrechnung_id=eq.${ab.id}`);}else{const{id,...ins}=d;s=(await sbP('pay_abrechnungen',ins))[0];}
  const pd=pos.map(p=>({abrechnung_id:s.id,typ:p.typ,auftrag_nr:p.auftrag_nr,kunde:p.kunde,produkt:p.produkt,original_betrag:p.original_betrag,override_betrag:p.override_betrag,aktiv:p.aktiv,zurueckgestellt:p.zurueckgestellt,notiz:p.notiz}));
  if(pd.length){const sp=await sbP('pay_abrechnungen_positionen',pd);setPos(sp);}setAb(s);window.__t?.('‚úÖ Gespeichert');onRef?.();}catch(e){window.__t?.('Fehler: '+e.message,'error');}};

  const frei=async()=>{if(!confirm(`${ab.mitarbeiter_name} (${ab.periode}) freigeben?\n\nDanach keine √Ñnderungen mehr m√∂glich!`))return;setAb(p=>({...p,status:'freigegeben',freigegeben_am:new Date().toISOString(),freigegeben_von:'Patrick Grabowski'}));setTimeout(save,100);};
  const pdf=async()=>{const pages=ref.current?.querySelectorAll('.gs-page');if(!pages?.length)return;window.__t?.('PDF wird erstellt...');try{const c=document.createElement('div');pages.forEach(p=>c.appendChild(p.cloneNode(true)));await html2pdf().set({margin:0,filename:`Gutschrift_${ab.periode.replace('/','-')}_${ab.kuerzel||gK(ab.mitarbeiter_name)}.pdf`,image:{type:'jpeg',quality:.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},pagebreak:{mode:['css','legacy'],before:'.gs-page'}}).from(c).save();window.__t?.('‚úÖ PDF heruntergeladen');}catch(e){window.__t?.('PDF-Fehler: '+e.message,'error');}};

  if(ld)return<div className="detail-overlay"><div className="detail-container"><div className="loading"><div className="spinner"/>Lade...</div></div></div>;
  if(!ab)return null;
  return<div className="detail-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
    <div className="detail-container">
      <div className="detail-header"><div style={{display:'flex',alignItems:'center',gap:12}}><button className="btn btn-secondary btn-sm" onClick={onClose}>‚Üê Zur√ºck</button><span style={{fontWeight:700,fontSize:15}}>{ab.mitarbeiter_name}</span><span className={`badge badge-${ab.status==='probeabrechnung'?'probe':ab.status}`}>{ab.status}</span></div><div style={{fontSize:12,color:'#8b949e'}}>{pLabel(ab.periode)}</div></div>
      <div className="detail-body">
        <EditPanel ab={ab} pos={pos} setPos={setPos} sg={sg} onSave={save} onFrei={frei} onPdf={pdf} onClose={onClose} setAb={setAb}/>
        <div className="preview-panel" ref={ref}><GutschriftPreview ab={ab} pos={pos} sg={sg}/></div>
      </div>
    </div>
  </div>;
}

function App(){
  const[per,setPer]=useState('');const[pers,setPers]=useState([]);const[abrs,setAbrs]=useState([]);const[ausz,setAusz]=useState([]);const[sg,setSg]=useState(null);const[ld,setLd]=useState(true);const[sel,setSel]=useState(null);const[genMsg,setGenMsg]=useState('');const[genBusy,setGenBusy]=useState(false);

  useEffect(()=>{(async()=>{try{const d=await sbG('pay_auszahlungen_historie','select=periode&order=periode.desc');const u=[...new Set(d.map(x=>x.periode))];const now=new Date();const cp=`${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}`;if(!u.includes(cp))u.unshift(cp);const sorted=u.sort().reverse();setPers(sorted);setPer(sorted[0]||cp);}catch(e){const now=new Date();const p=`${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}`;setPers([p]);setPer(p);}})();},[]);

  const loadP=useCallback(async()=>{if(!per)return;setLd(true);try{const[a,z,s]=await Promise.all([sbG('pay_abrechnungen',`periode=eq.${per}&order=mitarbeiter_name.asc`),sbG('pay_auszahlungen_historie',`periode=eq.${per}&order=vertriebler.asc`),sbG('pay_systemgebuehr','aktiv=eq.true&limit=1')]);setAbrs(a);setAusz(z);setSg(s[0]||null);}catch(e){window.__t?.('Fehler: '+e.message,'error');}setLd(false);},[per]);
  useEffect(()=>{loadP();},[loadP]);

  const vtG=useMemo(()=>{const g={};ausz.forEach(a=>{const n=a.vertriebler;if(!g[n])g[n]={name:n,items:[],total:0};g[n].items.push(a);g[n].total+=parseFloat(a.netto)||0;});abrs.forEach(ab=>{if(!g[ab.mitarbeiter_name])g[ab.mitarbeiter_name]={name:ab.mitarbeiter_name,items:[],total:ab.brutto_provisionen||0};g[ab.mitarbeiter_name].abrechnung=ab;});return Object.values(g).sort((a,b)=>b.total-a.total);},[ausz,abrs]);
  const totA=abrs.reduce((s,a)=>s+(parseFloat(a.auszahlungssumme)||0),0);const frg=abrs.filter(a=>a.status==='freigegeben'||a.status==='ausgezahlt').length;

  const alleErstellen=async()=>{const tc=vtG.filter(g=>!g.abrechnung);if(!confirm(`Probeabrechnungen f√ºr ${tc.length} VTs erstellen?`))return;window.__t?.('Erstelle...');let c=0;
  for(const g of tc){try{const k=gK(g.name);const pd=g.items.map(item=>({typ:'provision',kunde:item.kunde||'‚Äî',produkt:item.produkt||'Solar/WP',original_betrag:parseFloat(item.netto)||0,aktiv:true,zurueckgestellt:false}));const b=calc(pd.map(p=>({...p,override_betrag:null})),sg,true);const s=await sbP('pay_abrechnungen',{periode:per,mitarbeiter_name:g.name,kuerzel:k,beschaeftigungsart:'hgb',status:'entwurf',anzahl_sales:b.sales,brutto_provisionen:b.bp,systemgebuehr_netto:b.sgN,systemgebuehr_ust:b.sgU,nettobetrag:b.net,ust_satz:b.uS,ust_betrag:b.uB,auszahlungssumme:b.aus,belegnummer:gBN(per,k,c+1)});if(pd.length&&s[0])await sbP('pay_abrechnungen_positionen',pd.map(p=>({...p,abrechnung_id:s[0].id})));c++;}catch(e){console.error(g.name,e);}}
  window.__t?.(`‚úÖ ${c} Abrechnungen erstellt`);loadP();};

  const doGenerate=async()=>{if(!per)return;if(!confirm(`Abrechnungen f√ºr ${pLabel(per)} generieren?\n\nBerechnet Provisionen aus allen offenen Auftr√§gen.\nVorhandene Entw√ºrfe werden √ºberschrieben.`))return;
    setGenBusy(true);setGenMsg('Starte...');
    try{const cnt=await generateAbrechnungen(per,(msg)=>setGenMsg(msg));window.__t?.(`‚úÖ ${cnt} Abrechnungen generiert`);await loadP();}catch(e){window.__t?.('Fehler: '+e.message,'error');console.error(e);}
    setGenBusy(false);setGenMsg('');};

  return<Toast>
    <div className="app-header"><div className="logo-area"><div><div className="logo-text">bee<span>-doo</span> PAY</div><div className="logo-sub">Probeabrechnung</div></div></div>
    <div className="controls-bar">{pers.length>0&&<select className="sel-period" value={per} onChange={e=>setPer(e.target.value)}>{pers.map(p=><option key={p} value={p}>{pLabel(p)}</option>)}</select>}<button className="btn btn-primary" onClick={doGenerate} disabled={genBusy} style={{opacity:genBusy?.6:1}}>{genBusy?'‚è≥ Generiere...':'üîÑ Abrechnungen generieren'}</button><a href="https://bee-doo-tools.vercel.app/" className="btn btn-secondary btn-sm" style={{textDecoration:'none'}}>üè†</a></div></div>
    {genMsg&&<div style={{padding:'8px 24px',background:'#161b22',borderBottom:'1px solid #21262d',fontSize:13,color:'#F5C500'}}>‚è≥ {genMsg}</div>}
    <div className="stats-row">
      <div className="stat-card"><div className="stat-label">Periode</div><div className="stat-value">{per?pLabel(per):'‚Äî'}</div></div>
      <div className="stat-card"><div className="stat-label">Vertriebler</div><div className="stat-value gold">{vtG.length}</div></div>
      <div className="stat-card"><div className="stat-label">Abrechnungen</div><div className="stat-value">{abrs.length} <span style={{fontSize:12,color:'#8b949e'}}>/ {vtG.length}</span></div></div>
      <div className="stat-card"><div className="stat-label">Freigegeben</div><div className="stat-value green">{frg}</div></div>
      <div className="stat-card"><div className="stat-label">Gesamtsumme</div><div className="stat-value gold">{fmtE(totA)}</div></div>
    </div>
    {ld?<div className="loading"><div className="spinner"/>Lade...</div>:vtG.length===0?<div className="empty-state"><div className="icon">üì≠</div><h3>Keine Daten f√ºr {per?pLabel(per):'‚Äî'}</h3><p>F√ºr diese Periode liegen noch keine Daten vor.</p></div>:
    <div className="main-grid">{vtG.map(g=>{const ab=g.abrechnung;const k=ab?.kuerzel||gK(g.name);const st=ab?.status||'neu';const isHGB=ab?.beschaeftigungsart==='hgb';const typClass=isHGB?'hgb':'angestellt';return<div key={g.name} className={`vt-card ${typClass}`} onClick={()=>setSel({name:g.name,abrechnungId:ab?.id,data:g.items})}>
      <div className="vt-card-header"><span className="vt-name">{g.name}</span><div style={{display:'flex',gap:6,alignItems:'center'}}><span style={{fontSize:9,padding:'2px 6px',borderRadius:3,background:isHGB?'#F5C50020':'#58a6ff20',color:isHGB?'#F5C500':'#58a6ff',fontWeight:600}}>{isHGB?'HGB ¬ß84':'Angestellt'}</span><span className="vt-kuerzel">{k}</span></div></div>
      <div className="vt-sales">{ab?.anzahl_sales||0} Sales ¬∑ {(ab?.brutto_provisionen||0).toLocaleString('de-DE')}&nbsp;‚Ç¨ Brutto</div>
      <div className="vt-betrag">{fmtE(ab?ab.auszahlungssumme:g.total)}</div>
      <div className="vt-card-footer"><span className={`badge ${st==='neu'?'badge-entwurf':st==='entwurf'?'badge-entwurf':st==='probeabrechnung'?'badge-probe':st==='freigegeben'?'badge-freigegeben':'badge-ausgezahlt'}`}>{st==='neu'?'‚¨ú Neu':st==='entwurf'?'üìù Entwurf':st==='probeabrechnung'?'üîç Probe':st==='freigegeben'?'‚úÖ Freigegeben':'üí∏ Ausgezahlt'}</span><span style={{fontSize:11,color:'#484f58'}}>{ab?`${ab.anzahl_sales||0} Sales`:''}</span></div>
    </div>;})}</div>}
    {sel&&<DetailView aId={sel.abrechnungId} per={per} vtN={sel.name} vtD={sel.data} sg={sg} onClose={()=>setSel(null)} onRef={loadP}/>}
  </Toast>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>