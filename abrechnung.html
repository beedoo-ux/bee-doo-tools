<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo | Probeabrechnung</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#0a0a0f;color:#c9d1d9;min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#161b22}::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}
.app-header{background:#0d1117;border-bottom:1px solid #21262d;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo-area{display:flex;align-items:center;gap:12px}
.logo-text{font-size:22px;font-weight:800;letter-spacing:-0.5px}.logo-text span{color:#F5C500}
.logo-sub{font-size:11px;color:#8b949e;letter-spacing:1px;text-transform:uppercase}
.controls-bar{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.sel-period{background:#161b22;border:1px solid #30363d;color:#c9d1d9;padding:8px 14px;border-radius:8px;font-family:'DM Sans';font-size:14px;cursor:pointer}
.sel-period:focus{outline:none;border-color:#F5C500}
.btn{padding:8px 16px;border-radius:8px;font-family:'DM Sans';font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:#F5C500;color:#0a0a0f}.btn-primary:hover{background:#e6b800}
.btn-secondary{background:#21262d;color:#c9d1d9;border:1px solid #30363d}.btn-secondary:hover{background:#30363d}
.btn-success{background:#238636;color:#fff}.btn-success:hover{background:#2ea043}
.btn-danger{background:#da3633;color:#fff}.btn-danger:hover{background:#f85149}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}
.stats-row{display:flex;gap:16px;padding:16px 24px;flex-wrap:wrap}
.stat-card{background:#161b22;border:1px solid #21262d;border-radius:10px;padding:14px 18px;flex:1;min-width:140px}
.stat-label{font-size:11px;color:#8b949e;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.stat-value{font-size:22px;font-weight:700;color:#e6edf3}.stat-value.gold{color:#F5C500}.stat-value.green{color:#3fb950}
.main-grid{padding:0 24px 24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.vt-card{background:#161b22;border:1px solid #21262d;border-radius:12px;padding:16px;cursor:pointer;transition:all .2s}
.vt-card:hover{border-color:#F5C500;transform:translateY(-2px)}
.vt-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.vt-name{font-size:15px;font-weight:700;color:#e6edf3}
.vt-kuerzel{font-size:11px;color:#8b949e;background:#21262d;padding:2px 8px;border-radius:4px}
.vt-sales{font-size:12px;color:#8b949e;margin-bottom:6px}
.vt-betrag{font-size:20px;font-weight:800;color:#F5C500}
.vt-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:8px;border-top:1px solid #21262d}
.badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:0.3px}
.badge-entwurf{background:#30363d;color:#8b949e}.badge-probe{background:#1f2d1f;color:#F5C500;border:1px solid #F5C50040}
.badge-freigegeben{background:#0d2818;color:#3fb950;border:1px solid #3fb95040}.badge-ausgezahlt{background:#0d1d2d;color:#58a6ff;border:1px solid #58a6ff40}
.detail-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;display:flex;justify-content:center;align-items:stretch}
.detail-container{background:#0d1117;width:100%;max-width:1400px;display:flex;flex-direction:column;overflow:hidden}
.detail-header{background:#161b22;border-bottom:1px solid #21262d;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.detail-body{display:flex;flex:1;overflow:hidden}
.edit-panel{width:420px;min-width:380px;background:#0d1117;border-right:1px solid #21262d;overflow-y:auto;padding:16px;flex-shrink:0}
.preview-panel{flex:1;overflow-y:auto;background:#2d2d2d;padding:20px;display:flex;justify-content:center}
.edit-section{margin-bottom:16px}
.edit-section-title{font-size:12px;font-weight:700;color:#F5C500;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #21262d}
.pos-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#161b22;border:1px solid #21262d;border-radius:8px;margin-bottom:6px;font-size:12px;transition:all .2s}
.pos-row.inactive{opacity:.4;background:#0d1117}
.pos-row .pos-kunde{flex:1;color:#c9d1d9;font-weight:500}
.pos-row .pos-betrag{font-weight:700;color:#e6edf3;min-width:80px;text-align:right}
.override-input{background:#21262d;border:1px solid #30363d;color:#F5C500;padding:4px 8px;border-radius:4px;width:80px;text-align:right;font-family:'DM Sans';font-size:12px;font-weight:600}
.override-input:focus{outline:none;border-color:#F5C500}
.toggle-btn{width:28px;height:16px;border-radius:8px;border:none;cursor:pointer;position:relative;transition:background .2s}
.toggle-btn.active{background:#238636}.toggle-btn.inactive-toggle{background:#484f58}
.toggle-btn::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:#fff;top:2px;transition:left .2s}
.toggle-btn.active::after{left:14px}.toggle-btn.inactive-toggle::after{left:2px}
.extra-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.extra-input{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:6px 10px;border-radius:6px;font-family:'DM Sans';font-size:12px;flex:1}
.extra-input:focus{outline:none;border-color:#F5C500}.extra-amount{width:100px}
.notes-area{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:10px;border-radius:8px;font-family:'DM Sans';font-size:12px;width:100%;min-height:60px;resize:vertical}
.notes-area:focus{outline:none;border-color:#F5C500}
.empty-state{text-align:center;padding:60px 20px;color:#484f58}
.empty-state .icon{font-size:48px;margin-bottom:12px}
.empty-state h3{font-size:16px;color:#8b949e;margin-bottom:6px}
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#8b949e}
.spinner{width:20px;height:20px;border:2px solid #30363d;border-top-color:#F5C500;border-radius:50%;animation:spin .6s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;background:#161b22;border:1px solid #21262d;border-radius:10px;padding:12px 20px;font-size:13px;color:#c9d1d9;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideUp .3s ease}
.toast.success{border-color:#238636;color:#3fb950}.toast.error{border-color:#da3633;color:#f85149}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:768px){.app-header{padding:12px 16px}.stats-row{padding:12px 16px;gap:10px}.stat-card{min-width:120px;padding:10px 14px}.stat-value{font-size:18px}.main-grid{padding:0 16px 16px;grid-template-columns:1fr}.detail-body{flex-direction:column}.edit-panel{width:100%;min-width:unset;max-height:50vh;border-right:none;border-bottom:1px solid #21262d}.preview-panel{padding:10px}.controls-bar{width:100%;justify-content:flex-end}}
@media(max-width:480px){.stats-row{flex-direction:column}.stat-card{min-width:unset}.detail-header{flex-direction:column;gap:8px;align-items:flex-start}.edit-panel{padding:12px}.pos-row{flex-wrap:wrap}}
@media print{body{background:#fff}.app-header,.stats-row,.main-grid,.edit-panel,.detail-header,.detail-overlay{display:none!important}.preview-panel{background:#fff;padding:0}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, useMemo } = React;
const SUPABASE_URL = 'https://hqzpemfaljxcysyqssng.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
const HEADERS = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };
const fmt = (n) => new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
const fmtEur = (n) => fmt(n) + ' \u20ac';
const periodenLabel = (p) => { if (!p) return '\u2014'; const [y, m] = p.split('/'); const mon = ['','Januar','Februar','M\u00e4rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember']; return `${mon[parseInt(m)]} ${y}`; };
const genKuerzel = (name) => { const parts = name.trim().split(/\s+/); return parts.length >= 2 ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase() : name.slice(0,2).toUpperCase(); };
const genBelegnummer = (periode, kuerzel) => `${periode.replace('/', '-')}-${kuerzel}`;
const sbGet = async (table, query = '') => { const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, { headers: HEADERS }); if (!r.ok) throw new Error(`GET ${table}: ${r.status}`); return r.json(); };
const sbPost = async (table, data) => { const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, { method: 'POST', headers: { ...HEADERS, 'Prefer': 'return=representation' }, body: JSON.stringify(data) }); if (!r.ok) { const t = await r.text(); throw new Error(`POST ${table}: ${t}`); } return r.json(); };
const sbPatch = async (table, query, data) => { const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, { method: 'PATCH', headers: { ...HEADERS, 'Prefer': 'return=representation' }, body: JSON.stringify(data) }); if (!r.ok) throw new Error(`PATCH ${table}: ${r.status}`); return r.json(); };
const sbDelete = async (table, query) => { const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, { method: 'DELETE', headers: HEADERS }); if (!r.ok) throw new Error(`DELETE ${table}: ${r.status}`); };

function berechneAbrechnung(positionen, systemgebuehr, istHgb) {
  const aktivePos = positionen.filter(p => p.aktiv && !p.zurueckgestellt);
  const provPos = aktivePos.filter(p => ['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const extraPos = aktivePos.filter(p => ['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const bruttoProvisionen = provPos.reduce((s, p) => s + (p.override_betrag != null ? p.override_betrag : p.original_betrag), 0);
  const einmalSumme = extraPos.reduce((s, p) => s + (p.override_betrag != null ? p.override_betrag : p.original_betrag), 0);
  let sgNetto = 0, sgUst = 0;
  if (istHgb && systemgebuehr) { sgNetto = Math.min(bruttoProvisionen * (systemgebuehr.prozent / 100), systemgebuehr.max_netto); sgUst = sgNetto * (systemgebuehr.ust_satz / 100); }
  const nettobetrag = bruttoProvisionen - sgNetto + einmalSumme;
  const ustSatz = istHgb ? 19.0 : 0;
  const ustBetrag = nettobetrag * (ustSatz / 100);
  return { anzahlSales: provPos.filter(p => p.typ === 'provision').length, bruttoProvisionen, sgNetto: Math.round(sgNetto*100)/100, sgUst: Math.round(sgUst*100)/100, einmalSumme, nettobetrag: Math.round(nettobetrag*100)/100, ustSatz, ustBetrag: Math.round(ustBetrag*100)/100, auszahlung: Math.round((nettobetrag + ustBetrag)*100)/100 };
}

let toastTimer = null;
function ToastProvider({ children }) {
  const [toastState, setToastState] = useState(null);
  window.__showToast = (msg, type = 'success') => { clearTimeout(toastTimer); setToastState({ msg, type }); toastTimer = setTimeout(() => setToastState(null), 3000); };
  return <>{children}{toastState && <div className={`toast ${toastState.type}`}>{toastState.msg}</div>}</>;
}

function GutschriftPreview({ abrechnung, positionen, systemgebuehr, vormonatData }) {
  const ab = abrechnung;
  const ber = berechneAbrechnung(positionen, systemgebuehr, ab.beschaeftigungsart === 'hgb');
  const aktiveProvPos = positionen.filter(p => p.aktiv && !p.zurueckgestellt && ['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const aktiveExtraPos = positionen.filter(p => p.aktiv && !p.zurueckgestellt && ['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const kuerzel = ab.kuerzel || genKuerzel(ab.mitarbeiter_name);
  const belegnr = genBelegnummer(ab.periode, kuerzel);
  const istHgb = ab.beschaeftigungsart === 'hgb';
  const heute = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
  const isEntwurf = ab.status === 'entwurf' || ab.status === 'probeabrechnung';
  const vmSales = vormonatData?.anzahl || 0;
  const vmBetrag = vormonatData?.betrag || 0;
  const trendSales = vmSales > 0 ? ((ber.anzahlSales - vmSales) / vmSales * 100).toFixed(0) : null;
  const trendBetrag = vmBetrag > 0 ? ((ber.auszahlung - vmBetrag) / vmBetrag * 100).toFixed(0) : null;
  const qrDataUrl = useMemo(() => { try { if (typeof qrcode === 'undefined') return null; const qr = qrcode(0, 'M'); qr.addData(`bee-doo:${belegnr}:${ber.auszahlung}`); qr.make(); return qr.createDataURL(3, 0); } catch(e) { return null; } }, [belegnr, ber.auszahlung]);
  const pageStyle = { background: '#fff', width: '210mm', minHeight: '297mm', padding: '0', position: 'relative', color: '#111', fontFamily: 'Arial, sans-serif', fontSize: '11px', boxShadow: '0 4px 24px rgba(0,0,0,.4)', overflow: 'hidden' };

  return <div style={{display:'flex',flexDirection:'column',gap:'20px',alignItems:'center'}}>
    {/* SEITE 1 */}
    <div style={pageStyle} id={`gs-page1-${ab.id||'new'}`}>
      {isEntwurf && <div style={{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%) rotate(-35deg)',fontSize:'72px',fontWeight:900,color:'rgba(245,197,0,0.06)',letterSpacing:'8px',whiteSpace:'nowrap',zIndex:1,pointerEvents:'none',fontFamily:'Arial Black'}}>ENTWURF</div>}
      <div style={{background:'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)',padding:'20px 24px 16px',color:'#fff',position:'relative'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
          <div>
            <div style={{fontFamily:'Arial Black,Arial',fontSize:'28px',fontWeight:900,letterSpacing:'-1px',color:'#fff'}}>bee<span style={{color:'#FDE154'}}>-doo</span></div>
            <div style={{fontSize:'9px',color:'rgba(255,255,255,.5)',letterSpacing:'2px',textTransform:'uppercase',marginTop:'2px'}}>Energy for you</div>
          </div>
          <div style={{textAlign:'right',lineHeight:'1.8'}}>
            <div style={{fontSize:'11px',color:'rgba(255,255,255,.6)'}}>Datum: <b style={{color:'#fff'}}>{heute}</b></div>
            <div style={{fontSize:'11px',color:'rgba(255,255,255,.6)'}}>Leistungszeitraum: <b style={{color:'#FDE154'}}>{ab.periode}</b></div>
          </div>
        </div>
        <div style={{position:'absolute',bottom:0,left:0,right:0,height:'3px',background:'linear-gradient(90deg, #F5C500, #FDE154, #F5C500)'}} />
      </div>
      <div style={{padding:'0 24px 28mm'}}>
        <div style={{fontSize:'8px',color:'#999',padding:'8px 0 6px',borderBottom:'1px dotted #ddd',marginBottom:'10px'}}>bee-doo GmbH &middot; Am Stadtholz 39 &middot; D-33609 Bielefeld &middot; USt-IdNr.: DE363829401 &middot; Steuernummer: 320/5706/4015</div>
        <div style={{fontSize:'13px',fontWeight:700,marginBottom:'2px',color:'#111'}}>{ab.mitarbeiter_name}</div>
        <div style={{fontSize:'11px',color:'#555',lineHeight:'1.7',marginBottom:'2px'}}>&mdash;<br/>&mdash;</div>
        <div style={{fontSize:'9px',color:'#999',marginBottom:'16px'}}>{istHgb ? 'Handelsvertreter gem. HGB \u00a784' : 'Angestellte/r'}</div>
        <div style={{display:'flex',alignItems:'center',gap:'12px',marginBottom:'4px'}}>
          <div style={{fontSize:'18px',fontWeight:800,color:'#111'}}>{istHgb ? 'Gutschrift' : 'Entgeltabrechnung'}: {belegnr}</div>
          {isEntwurf && <span style={{background:'#FEF3C7',color:'#92400E',fontSize:'9px',fontWeight:700,padding:'3px 8px',borderRadius:'4px',textTransform:'uppercase'}}>Entwurf</span>}
        </div>
        <div style={{fontSize:'11px',color:'#777',marginBottom:'14px'}}>{ab.mitarbeiter_name} &middot; Leistungszeitraum {periodenLabel(ab.periode)}</div>
        <div style={{background:'linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%)',border:'2px solid #86efac',borderRadius:'12px',padding:'16px 20px',marginBottom:'16px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <div>
            <div style={{fontSize:'10px',color:'#166534',fontWeight:600,textTransform:'uppercase',letterSpacing:'0.5px',marginBottom:'2px'}}>Auszahlungssumme {istHgb ? '(Brutto)' : '(Netto)'}</div>
            <div style={{fontSize:'28px',fontWeight:900,color:'#166534',letterSpacing:'-1px'}}>{fmtEur(ber.auszahlung)}</div>
          </div>
          <div style={{textAlign:'right'}}>
            <div style={{fontSize:'22px',fontWeight:800,color:'#166534'}}>{ber.anzahlSales}</div>
            <div style={{fontSize:'10px',color:'#15803d'}}>Sales</div>
            {trendSales != null && <div style={{fontSize:'11px',fontWeight:700,color: parseInt(trendSales) >= 0 ? '#16a34a' : '#dc2626',marginTop:'2px'}}>{parseInt(trendSales) >= 0 ? '\u25b2' : '\u25bc'} {Math.abs(trendSales)}% vs. Vormonat</div>}
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'58% 40%',gap:'2%'}}>
          <div>
            <table style={{width:'100%',borderCollapse:'collapse',fontSize:'11px'}}><tbody>
              <tr><td style={{padding:'7px 10px',borderBottom:'1px solid #eee',color:'#E07800',fontWeight:600}}>Provisionen ({ber.anzahlSales} Sales)</td><td style={{padding:'7px 10px',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtEur(ber.bruttoProvisionen)}</td></tr>
              {aktiveExtraPos.map((p, i) => <tr key={i}><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',color:(p.override_betrag!=null?p.override_betrag:p.original_betrag)>=0?'#E07800':'#9a3412',fontSize:'10px'}}>{p.kunde||p.notiz||p.typ}</td><td style={{padding:'6px 10px',borderBottom:'1px solid #eee',textAlign:'right',fontSize:'10px'}}>{fmtEur(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td></tr>)}
              <tr><td style={{padding:'7px 10px',borderTop:'2px solid #ddd',borderBottom:'2px solid #999',fontWeight:700}}>Brutto-Provisionen</td><td style={{padding:'7px 10px',borderTop:'2px solid #ddd',borderBottom:'2px solid #999',textAlign:'right',fontWeight:700}}>{fmtEur(ber.bruttoProvisionen + ber.einmalSumme)}</td></tr>
              {istHgb && <React.Fragment>
                <tr style={{background:'#faf5eb'}}><td style={{padding:'6px 10px',borderBottom:'1px solid #e5e5d5',color:'#78350f',fontWeight:600,fontSize:'10px'}}>./. Systemgeb&uuml;hr Netto (3% &middot; max 200 &euro;)</td><td style={{padding:'6px 10px',borderBottom:'1px solid #e5e5d5',textAlign:'right',color:'#78350f',fontWeight:600}}>-{fmtEur(ber.sgNetto)}</td></tr>
                <tr style={{background:'#faf5eb'}}><td style={{padding:'5px 10px',borderBottom:'1px solid #e5e5d5',color:'#9a3412',fontSize:'9.5px',fontWeight:600}}>./. USt 19% auf Systemgeb&uuml;hr</td><td style={{padding:'5px 10px',borderBottom:'1px solid #e5e5d5',textAlign:'right',color:'#9a3412',fontWeight:600,fontSize:'10px'}}>-{fmtEur(ber.sgUst)}</td></tr>
                <tr style={{background:'#faf5eb'}}><td colSpan={2} style={{padding:'2px 10px 5px',color:'#a1a1aa',fontSize:'8px'}}>Netto {fmtEur(ber.sgNetto)} + 19% MwSt {fmtEur(ber.sgUst)} = Brutto {fmtEur(ber.sgNetto+ber.sgUst)} &middot; sep. Rechnung bee-doo GmbH &middot; Ziff. 4.2 HVV</td></tr>
              </React.Fragment>}
              <tr><td style={{padding:'7px 10px',borderTop:'2px solid #111',borderBottom:'1px solid #eee',color:'#555'}}>Nettobetrag</td><td style={{padding:'7px 10px',borderTop:'2px solid #111',borderBottom:'1px solid #eee',textAlign:'right'}}>{fmtEur(ber.nettobetrag)}</td></tr>
              {istHgb && <tr style={{background:'#fffbeb'}}><td style={{padding:'7px 10px',borderBottom:'1px solid #fde68a',color:'#92400e',fontWeight:600}}>+ Umsatzsteuer 19%</td><td style={{padding:'7px 10px',borderBottom:'1px solid #fde68a',textAlign:'right',color:'#92400e',fontWeight:600}}>+ {fmtEur(ber.ustBetrag)}</td></tr>}
              <tr style={{background:'linear-gradient(90deg,#f0fdf4,#ecfdf5)'}}><td style={{padding:'9px 10px',fontWeight:800,fontSize:'13px'}}>AUSZAHLUNG</td><td style={{padding:'9px 10px',textAlign:'right',fontWeight:900,fontSize:'14px',color:'#166534'}}>{fmtEur(ber.auszahlung)}</td></tr>
            </tbody></table>
          </div>
          <div>
            <div style={{background:'#f8fafc',borderRadius:'8px',border:'1px solid #e2e8f0',padding:'12px',marginBottom:'10px'}}>
              <div style={{fontSize:'10px',fontWeight:700,color:'#E07800',marginBottom:'6px',borderBottom:'1px solid #f1f5f9',paddingBottom:'4px'}}>Sales {periodenLabel(ab.periode)}</div>
              <table style={{width:'100%',borderCollapse:'collapse',fontSize:'10px'}}><tbody>
                <tr><td style={{padding:'3px 0',color:'#64748b'}}>Abgerechnete Sales</td><td style={{textAlign:'right',fontWeight:700}}>{ber.anzahlSales}</td></tr>
                <tr><td style={{padding:'3px 0',color:'#64748b'}}>Netto-Provisionen</td><td style={{textAlign:'right'}}>{fmtEur(ber.nettobetrag)}</td></tr>
                {istHgb && <tr><td style={{padding:'3px 0',color:'#92400e'}}>+ USt 19%</td><td style={{textAlign:'right',color:'#92400e'}}>+ {fmtEur(ber.ustBetrag)}</td></tr>}
                <tr style={{borderTop:'1px solid #e2e8f0'}}><td style={{padding:'5px 0 0',fontWeight:700,color:'#166534'}}>Auszahlung</td><td style={{padding:'5px 0 0',textAlign:'right',fontWeight:800,color:'#166534'}}>{fmtEur(ber.auszahlung)}</td></tr>
              </tbody></table>
            </div>
            {istHgb && ber.sgNetto > 0 && <div style={{background:'#fefce8',borderRadius:'8px',border:'1px solid #fde68a',padding:'12px',marginBottom:'10px'}}>
              <div style={{fontSize:'10px',fontWeight:700,color:'#92400e',marginBottom:'6px'}}>Systemgeb&uuml;hr</div>
              <table style={{width:'100%',borderCollapse:'collapse',fontSize:'10px'}}><tbody>
                <tr><td style={{padding:'2px 0',color:'#78350f'}}>Netto</td><td style={{textAlign:'right'}}>{fmtEur(ber.sgNetto)}</td></tr>
                <tr><td style={{padding:'2px 0',color:'#9a3412'}}>+ USt 19%</td><td style={{textAlign:'right',color:'#9a3412'}}>+ {fmtEur(ber.sgUst)}</td></tr>
                <tr style={{borderTop:'1px solid #fde68a'}}><td style={{padding:'4px 0 0',fontWeight:700,color:'#92400e'}}>Brutto</td><td style={{padding:'4px 0 0',textAlign:'right',fontWeight:700,color:'#92400e'}}>{fmtEur(ber.sgNetto+ber.sgUst)}</td></tr>
              </tbody></table>
            </div>}
            {vmBetrag > 0 && <div style={{background:'#f0f9ff',borderRadius:'8px',border:'1px solid #bae6fd',padding:'12px'}}>
              <div style={{fontSize:'10px',fontWeight:700,color:'#0369a1',marginBottom:'6px'}}>Vormonat</div>
              <table style={{width:'100%',borderCollapse:'collapse',fontSize:'10px'}}><tbody>
                <tr><td style={{padding:'2px 0',color:'#64748b'}}>Sales</td><td style={{textAlign:'right'}}>{vmSales} <span style={{color:parseInt(trendSales)>=0?'#16a34a':'#dc2626',fontWeight:700,fontSize:'9px'}}>{parseInt(trendSales)>=0?'\u25b2':'\u25bc'}{Math.abs(trendSales)}%</span></td></tr>
                <tr><td style={{padding:'2px 0',color:'#64748b'}}>Betrag</td><td style={{textAlign:'right'}}>{fmtEur(vmBetrag)}</td></tr>
              </tbody></table>
            </div>}
          </div>
        </div>
        <div style={{marginTop:'14px',fontSize:'9.5px',color:'#6b7280',lineHeight:'1.6',borderTop:'1px solid #e5e7eb',paddingTop:'8px'}}>
          {istHgb ? `Diese Gutschrift gem. \u00a714 Abs. 2 UStG ersetzt die Rechnung des Leistungserbringers. Nettobetrag: ${fmtEur(ber.nettobetrag)} \u00b7 zzgl. 19% USt: ${fmtEur(ber.ustBetrag)} \u00b7 Bruttobetrag: ${fmtEur(ber.auszahlung)}. Systemgeb\u00fchr (Brutto ${fmtEur(ber.sgNetto+ber.sgUst)}) wird gesondert abgerechnet.` : `Entgeltabrechnung f\u00fcr ${ab.mitarbeiter_name}. Nettobetrag: ${fmtEur(ber.nettobetrag)}.`}
        </div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-end',marginTop:'12px',paddingTop:'10px',borderTop:'1px solid #e5e7eb'}}>
          <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
            {qrDataUrl && <img src={qrDataUrl} alt="QR" style={{width:'48px',height:'48px',borderRadius:'4px'}} />}
            <div style={{fontSize:'8px',color:'#9ca3af',lineHeight:'1.5'}}>Beleg: {belegnr}<br/>Pr&uuml;fsumme: {(ber.auszahlung * 17 % 9973).toFixed(0).padStart(4,'0')}<br/>Erstellt: {heute}</div>
          </div>
          <div style={{textAlign:'right'}}>
            {(ab.status === 'freigegeben' || ab.status === 'ausgezahlt')
              ? <div><div style={{fontSize:'9px',color:'#16a34a',fontWeight:700}}>&check; Freigegeben</div><div style={{fontSize:'8px',color:'#6b7280'}}>{ab.freigegeben_von || 'bee-doo GmbH'}</div><div style={{fontSize:'8px',color:'#6b7280'}}>{ab.freigegeben_am ? new Date(ab.freigegeben_am).toLocaleDateString('de-DE') : heute}</div></div>
              : <div style={{borderBottom:'1px solid #d1d5db',width:'120px',paddingBottom:'2px',marginBottom:'2px'}}></div>}
            <div style={{fontSize:'8px',color:'#9ca3af'}}>Gesch&auml;ftsf&uuml;hrung bee-doo GmbH</div>
          </div>
        </div>
      </div>
      <div style={{position:'absolute',bottom:'0',left:'0',right:'0',background:'#f8fafc',borderTop:'1px solid #e2e8f0',padding:'8px 24px',display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:'8px'}}>
        <div style={{fontSize:'7.5px',color:'#6b7280',lineHeight:'1.6'}}><b style={{fontSize:'8.5px',color:'#374151',display:'block',marginBottom:'1px'}}>Firmensitz</b>bee-doo GmbH<br/>Am Stadtholz 39<br/>D-33609 Bielefeld</div>
        <div style={{fontSize:'7.5px',color:'#6b7280',lineHeight:'1.6'}}><b style={{fontSize:'8.5px',color:'#374151',display:'block',marginBottom:'1px'}}>Kontakt</b>www.bee-doo.de<br/>info@bee-doo.de<br/>Fon: 0800 22 33 664</div>
        <div style={{fontSize:'7.5px',color:'#6b7280',lineHeight:'1.6'}}><b style={{fontSize:'8.5px',color:'#374151',display:'block',marginBottom:'1px'}}>Bankverbindung</b>IBAN DE90 2545 0110<br/>0031 0399 85<br/>BIC NOLADE21SWB</div>
        <div style={{fontSize:'7.5px',color:'#6b7280',lineHeight:'1.6'}}><b style={{fontSize:'8.5px',color:'#374151',display:'block',marginBottom:'1px'}}>Gesch&auml;ftsf&uuml;hrer</b>Patrick Grabowski<br/>Olaf Schader<br/>HRB 43210 Bielefeld</div>
      </div>
    </div>

    {/* SEITE 2 */}
    <div style={pageStyle} id={`gs-page2-${ab.id||'new'}`}>
      {isEntwurf && <div style={{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%) rotate(-35deg)',fontSize:'72px',fontWeight:900,color:'rgba(245,197,0,0.06)',letterSpacing:'8px',whiteSpace:'nowrap',zIndex:1,pointerEvents:'none',fontFamily:'Arial Black'}}>ENTWURF</div>}
      <div style={{background:'linear-gradient(135deg, #1a1a2e, #16213e)',padding:'12px 24px',color:'#fff',display:'flex',justifyContent:'space-between',alignItems:'center',position:'relative'}}>
        <div style={{fontSize:'12px',fontWeight:700}}>Einzelpositionen &ndash; {periodenLabel(ab.periode)}</div>
        <div style={{fontSize:'11px',color:'rgba(255,255,255,.6)'}}>Beleg: {belegnr}</div>
        <div style={{position:'absolute',bottom:0,left:0,right:0,height:'2px',background:'linear-gradient(90deg, #F5C500, #FDE154, #F5C500)'}} />
      </div>
      <div style={{padding:'16px 24px 28mm'}}>
        <div style={{fontSize:'16px',fontWeight:700,marginBottom:'12px',color:'#111'}}>{ab.mitarbeiter_name} <span style={{fontSize:'11px',color:'#9ca3af',fontWeight:400}}>({kuerzel})</span></div>
        <div style={{color:'#E07800',fontWeight:700,fontSize:'11px',marginBottom:'6px',borderBottom:'2px solid #E07800',paddingBottom:'3px',display:'inline-block'}}>Einzelpositionen</div>
        <table style={{width:'100%',borderCollapse:'collapse',fontSize:'10.5px',marginTop:'6px'}}>
          <thead><tr style={{background:'#f8fafc'}}>
            <th style={{padding:'6px 8px',borderBottom:'2px solid #e2e8f0',textAlign:'left',fontSize:'8.5px',textTransform:'uppercase',color:'#64748b',fontWeight:700}}>Nr.</th>
            <th style={{padding:'6px 8px',borderBottom:'2px solid #e2e8f0',textAlign:'left',fontSize:'8.5px',textTransform:'uppercase',color:'#64748b',fontWeight:700}}>Auftrag</th>
            <th style={{padding:'6px 8px',borderBottom:'2px solid #e2e8f0',textAlign:'left',fontSize:'8.5px',textTransform:'uppercase',color:'#64748b',fontWeight:700}}>Kunde</th>
            <th style={{padding:'6px 8px',borderBottom:'2px solid #e2e8f0',textAlign:'left',fontSize:'8.5px',textTransform:'uppercase',color:'#64748b',fontWeight:700}}>Art</th>
            <th style={{padding:'6px 8px',borderBottom:'2px solid #e2e8f0',textAlign:'right',fontSize:'8.5px',textTransform:'uppercase',color:'#64748b',fontWeight:700}}>Netto</th>
          </tr></thead>
          <tbody>
            {aktiveProvPos.map((p, i) => <tr key={i} style={{background:i%2===0?'#fff':'#fafafa'}}>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #f1f5f9',color:'#94a3b8',fontSize:'9px'}}>{String(i+1).padStart(2,'0')}</td>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #f1f5f9',color:'#475569',fontSize:'10px'}}>{p.auftrag_nr || '\u2014'}</td>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #f1f5f9',fontSize:'10px',fontWeight:500}}>{p.kunde || '\u2014'}</td>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #f1f5f9',color:'#64748b',fontSize:'9.5px'}}>{p.produkt || p.typ}</td>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #f1f5f9',textAlign:'right',fontWeight:600,color:p.override_betrag!=null?'#B45309':'#111'}}>{fmtEur(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td>
            </tr>)}
            {aktiveExtraPos.map((p, i) => <tr key={`e${i}`} style={{background:'#fffbeb'}}>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #fef3c7',color:'#94a3b8',fontSize:'9px'}}>&mdash;</td>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #fef3c7'}} colSpan={2}>{p.kunde||p.notiz||p.typ}</td>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #fef3c7',color:'#92400e',fontSize:'9px'}}>{p.typ==='einmalzahlung'?'Einmalzahlung':p.typ==='abzug'?'Abzug':'Sonstiges'}</td>
              <td style={{padding:'5px 8px',borderBottom:'1px solid #fef3c7',textAlign:'right',fontWeight:600}}>{fmtEur(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</td>
            </tr>)}
          </tbody>
        </table>
        <div style={{marginTop:'12px',borderTop:'2px solid #1e293b'}}>
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:'11px'}}><tbody>
            <tr style={{background:'#f8fafc'}}><td style={{padding:'7px 10px',fontWeight:700}}>Netto-Summe Provisionen</td><td style={{padding:'7px 10px',textAlign:'right',fontWeight:700}}>{fmtEur(ber.bruttoProvisionen+ber.einmalSumme)}</td></tr>
            {istHgb && <tr style={{background:'#fefce8'}}><td style={{padding:'6px 10px',color:'#78350f',fontSize:'10px'}}>./. Systemgeb&uuml;hr + USt ({fmtEur(ber.sgNetto)} + {fmtEur(ber.sgUst)})</td><td style={{padding:'6px 10px',textAlign:'right',color:'#9a3412'}}>-{fmtEur(ber.sgNetto+ber.sgUst)}</td></tr>}
            <tr><td style={{padding:'6px 10px',color:'#64748b'}}>Nettobetrag (Auszahlungsbasis)</td><td style={{padding:'6px 10px',textAlign:'right'}}>{fmtEur(ber.nettobetrag)}</td></tr>
            {istHgb && <tr style={{background:'#fffbeb'}}><td style={{padding:'6px 10px',color:'#92400e',fontWeight:600}}>+ USt 19%</td><td style={{padding:'6px 10px',textAlign:'right',color:'#92400e',fontWeight:700}}>+ {fmtEur(ber.ustBetrag)}</td></tr>}
            <tr style={{background:'linear-gradient(90deg,#f0fdf4,#ecfdf5)',borderTop:'2px solid #166534'}}><td style={{padding:'9px 10px',fontWeight:800,fontSize:'13px'}}>BRUTTO-AUSZAHLUNG</td><td style={{padding:'9px 10px',textAlign:'right',fontWeight:900,fontSize:'14px',color:'#166534'}}>{fmtEur(ber.auszahlung)}</td></tr>
          </tbody></table>
        </div>
        {ab.stb_kommentar && <div style={{marginTop:'14px',padding:'10px',background:'#fefce8',border:'1px solid #fde68a',borderRadius:'6px',fontSize:'10px'}}><b style={{color:'#92400e'}}>Kommentar Steuerberater:</b><br/><span style={{color:'#78350f'}}>{ab.stb_kommentar}</span></div>}
      </div>
      <div style={{position:'absolute',bottom:'0',left:'0',right:'0',background:'#f8fafc',borderTop:'1px solid #e2e8f0',padding:'8px 24px',display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:'8px'}}>
        <div style={{fontSize:'7.5px',color:'#6b7280',lineHeight:'1.6'}}><b style={{fontSize:'8.5px',color:'#374151',display:'block',marginBottom:'1px'}}>Firmensitz</b>bee-doo GmbH<br/>Am Stadtholz 39<br/>D-33609 Bielefeld</div>
        <div style={{fontSize:'7.5px',color:'#6b7280',lineHeight:'1.6'}}><b style={{fontSize:'8.5px',color:'#374151',display:'block',marginBottom:'1px'}}>Kontakt</b>www.bee-doo.de<br/>info@bee-doo.de<br/>Fon: 0800 22 33 664</div>
        <div style={{fontSize:'7.5px',color:'#6b7280',lineHeight:'1.6'}}><b style={{fontSize:'8.5px',color:'#374151',display:'block',marginBottom:'1px'}}>Bankverbindung</b>IBAN DE90 2545 0110<br/>0031 0399 85<br/>BIC NOLADE21SWB</div>
        <div style={{fontSize:'7.5px',color:'#6b7280',lineHeight:'1.6'}}><b style={{fontSize:'8.5px',color:'#374151',display:'block',marginBottom:'1px'}}>Gesch&auml;ftsf&uuml;hrer</b>Patrick Grabowski<br/>Olaf Schader<br/>HRB 43210 Bielefeld</div>
      </div>
    </div>
  </div>;
}

function EditPanel({ abrechnung, positionen, setPositionen, systemgebuehr, onSave, onFreigeben, onPdf, setAbrechnung }) {
  const ab = abrechnung;
  const ber = berechneAbrechnung(positionen, systemgebuehr, ab.beschaeftigungsart === 'hgb');
  const provPos = positionen.filter(p => ['provision','eigenlead','empfehlung','speicher'].includes(p.typ));
  const extraPos = positionen.filter(p => ['einmalzahlung','abzug','sonstiges'].includes(p.typ));
  const isLocked = ab.status === 'freigegeben' || ab.status === 'ausgezahlt';
  const togglePos = (idx) => { if (isLocked) return; const np = [...positionen]; np[idx] = { ...np[idx], aktiv: !np[idx].aktiv }; setPositionen(np); };
  const setOverride = (idx, val) => { if (isLocked) return; const np = [...positionen]; np[idx] = { ...np[idx], override_betrag: val === '' ? null : parseFloat(val.replace(',','.')) || 0 }; setPositionen(np); };
  const zurueckstellen = (idx) => { if (isLocked) return; const np = [...positionen]; np[idx] = { ...np[idx], zurueckgestellt: !np[idx].zurueckgestellt, aktiv: np[idx].zurueckgestellt }; setPositionen(np); };
  const addExtra = (typ) => { setPositionen([...positionen, { typ, auftrag_nr:'', kunde:'', produkt:'', original_betrag:0, override_betrag:null, aktiv:true, zurueckgestellt:false, notiz:'', isNew:true }]); };
  const removeExtra = (idx) => { const np = [...positionen]; np.splice(idx,1); setPositionen(np); };
  const updateExtra = (idx, field, val) => { const np = [...positionen]; np[idx] = { ...np[idx], [field]: field==='original_betrag'?(parseFloat(val.replace(',','.'))||0):val }; setPositionen(np); };

  return <div className="edit-panel">
    <div className="edit-section">
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
        <span className={`badge badge-${ab.status==='probeabrechnung'?'probe':ab.status}`}>{ab.status==='entwurf'?'\ud83d\udcdd Entwurf':ab.status==='probeabrechnung'?'\ud83d\udd0d Probe':ab.status==='freigegeben'?'\u2705 Freigegeben':'\ud83d\udcb8 Ausgezahlt'}</span>
        <span style={{fontSize:11,color:'#8b949e'}}>{ab.mitarbeiter_name}</span>
      </div>
      <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
        <button className="btn btn-primary btn-sm" onClick={onSave} disabled={isLocked}>{'\ud83d\udcbe'} Speichern</button>
        {!isLocked && <button className="btn btn-success btn-sm" onClick={onFreigeben}>{'\u2705'} Freigeben</button>}
        {ab.status==='freigegeben' && <button className="btn btn-sm" style={{background:'#1f6feb',color:'#fff'}} onClick={() => { setAbrechnung(prev=>({...prev,status:'ausgezahlt',ausgezahlt_am:new Date().toISOString()})); setTimeout(onSave,100); }}>{'\ud83d\udcb8'} Ausgezahlt</button>}
        <button className="btn btn-secondary btn-sm" onClick={onPdf}>{'\ud83d\udcc4'} PDF</button>
      </div>
    </div>
    <div className="edit-section">
      <div className="edit-section-title">{'\ud83d\udcb0'} Zusammenfassung</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}><div style={{fontSize:10,color:'#8b949e'}}>Sales</div><div style={{fontSize:18,fontWeight:700,color:'#F5C500'}}>{ber.anzahlSales}</div></div>
        <div style={{background:'#161b22',padding:8,borderRadius:6,border:'1px solid #21262d'}}><div style={{fontSize:10,color:'#8b949e'}}>Auszahlung</div><div style={{fontSize:16,fontWeight:700,color:'#3fb950'}}>{fmtEur(ber.auszahlung)}</div></div>
      </div>
    </div>
    <div className="edit-section">
      <div className="edit-section-title">{'\ud83d\udccb'} Provisionen ({provPos.filter(p=>p.aktiv&&!p.zurueckgestellt).length}/{provPos.length})</div>
      {provPos.map((p, i) => { const gi = positionen.indexOf(p); return <div key={i} className={`pos-row ${!p.aktiv?'inactive':''}`}>
        <button className={`toggle-btn ${p.aktiv?'active':'inactive-toggle'}`} onClick={()=>togglePos(gi)} disabled={isLocked} />
        <div className="pos-kunde" style={{fontSize:11}}>{p.kunde||'\u2014'}{p.zurueckgestellt && <span style={{fontSize:9,background:'#30363d',color:'#8b949e',padding:'1px 6px',borderRadius:3,marginLeft:6}}>{'\u23f8'}</span>}</div>
        <div className="pos-betrag">{!isLocked ? <input className="override-input" value={p.override_betrag!=null?p.override_betrag:p.original_betrag} onChange={e=>setOverride(gi,e.target.value)} /> : <span>{fmtEur(p.override_betrag!=null?p.override_betrag:p.original_betrag)}</span>}</div>
        {!isLocked && <button className="btn btn-sm" style={{padding:'2px 6px',fontSize:10,background:p.zurueckgestellt?'#238636':'#30363d',color:p.zurueckgestellt?'#fff':'#8b949e'}} onClick={()=>zurueckstellen(gi)}>{'\u23f8'}</button>}
      </div>; })}
    </div>
    <div className="edit-section">
      <div className="edit-section-title">{'\u2795'} Einmalzahlungen / Abz&uuml;ge</div>
      {extraPos.map((p, i) => { const gi = positionen.indexOf(p); return <div key={i} className="extra-row">
        <input className="extra-input" placeholder="Bezeichnung" value={p.kunde||p.notiz||''} onChange={e=>updateExtra(gi,'kunde',e.target.value)} disabled={isLocked} />
        <input className="extra-input extra-amount" placeholder="Betrag" value={p.original_betrag||''} onChange={e=>updateExtra(gi,'original_betrag',e.target.value)} disabled={isLocked} />
        <select className="extra-input" style={{width:90}} value={p.typ} onChange={e=>updateExtra(gi,'typ',e.target.value)} disabled={isLocked}><option value="einmalzahlung">+ Zahlung</option><option value="abzug">- Abzug</option><option value="sonstiges">Sonstiges</option></select>
        {!isLocked && <button className="btn btn-danger btn-sm btn-icon" onClick={()=>removeExtra(gi)}>{'\u2715'}</button>}
      </div>; })}
      {!isLocked && <div style={{display:'flex',gap:6}}><button className="btn btn-secondary btn-sm" onClick={()=>addExtra('einmalzahlung')}>+ Zahlung</button><button className="btn btn-secondary btn-sm" onClick={()=>addExtra('abzug')}>- Abzug</button></div>}
    </div>
    <div className="edit-section"><div className="edit-section-title">{'\ud83d\udcdd'} Interne Notizen</div><textarea className="notes-area" placeholder="Notizen..." value={ab.notizen||''} onChange={e=>setAbrechnung(prev=>({...prev,notizen:e.target.value}))} disabled={isLocked} /></div>
    <div className="edit-section"><div className="edit-section-title">{'\ud83d\udcce'} Steuerberater-Kommentar</div><textarea className="notes-area" placeholder="Kommentar..." value={ab.stb_kommentar||''} onChange={e=>setAbrechnung(prev=>({...prev,stb_kommentar:e.target.value}))} disabled={isLocked} /></div>
  </div>;
}

function DetailView({ abrechnungId, periode, vtName, vtData, systemgebuehr, vormonatData, onClose, onRefresh }) {
  const [localAbrechnung, setLocalAbrechnung] = useState(null);
  const [localPositionen, setLocalPositionen] = useState([]);
  const [detailLoading, setDetailLoading] = useState(true);
  const previewRef = useRef(null);

  useEffect(() => {
    (async () => {
      setDetailLoading(true);
      try {
        if (abrechnungId) {
          const [abrArr, posArr] = await Promise.all([sbGet('pay_abrechnungen',`id=eq.${abrechnungId}`), sbGet('pay_abrechnungen_positionen',`abrechnung_id=eq.${abrechnungId}&order=erstellt_am.asc`)]);
          if (abrArr.length) { setLocalAbrechnung(abrArr[0]); setLocalPositionen(posArr); }
        } else {
          setLocalAbrechnung({ periode, mitarbeiter_name:vtName, kuerzel:genKuerzel(vtName), beschaeftigungsart:'hgb', status:'entwurf', notizen:'', stb_kommentar:'' });
          setLocalPositionen((vtData||[]).map(d => ({ typ:'provision', auftrag_nr:'', kunde:d.kunde, produkt:d.produkt, original_betrag:d.netto, override_betrag:null, aktiv:true, zurueckgestellt:false, notiz:'', isNew:true })));
        }
      } catch(e) { window.__showToast?.('Fehler: '+e.message,'error'); }
      setDetailLoading(false);
    })();
  }, [abrechnungId]);

  const handleSave = async () => {
    try {
      const ber = berechneAbrechnung(localPositionen, systemgebuehr, localAbrechnung.beschaeftigungsart==='hgb');
      const abrData = { ...localAbrechnung, anzahl_sales:ber.anzahlSales, brutto_provisionen:ber.bruttoProvisionen, systemgebuehr_netto:ber.sgNetto, systemgebuehr_ust:ber.sgUst, einmalzahlungen_summe:ber.einmalSumme, nettobetrag:ber.nettobetrag, ust_satz:ber.ustSatz, ust_betrag:ber.ustBetrag, auszahlungssumme:ber.auszahlung, belegnummer:genBelegnummer(localAbrechnung.periode, localAbrechnung.kuerzel||genKuerzel(localAbrechnung.mitarbeiter_name)), geaendert_am:new Date().toISOString() };
      let savedAbr;
      if (localAbrechnung.id) {
        const { id, erstellt_am, ...upd } = abrData;
        savedAbr = (await sbPatch('pay_abrechnungen',`id=eq.${localAbrechnung.id}`,upd))[0];
        await sbDelete('pay_abrechnungen_positionen',`abrechnung_id=eq.${localAbrechnung.id}`);
      } else {
        const { id, ...ins } = abrData;
        savedAbr = (await sbPost('pay_abrechnungen',ins))[0];
      }
      const posData = localPositionen.map(p => ({ abrechnung_id:savedAbr.id, typ:p.typ, auftrag_nr:p.auftrag_nr, kunde:p.kunde, produkt:p.produkt, original_betrag:p.original_betrag, override_betrag:p.override_betrag, aktiv:p.aktiv, zurueckgestellt:p.zurueckgestellt, notiz:p.notiz }));
      if (posData.length) setLocalPositionen(await sbPost('pay_abrechnungen_positionen',posData));
      setLocalAbrechnung(savedAbr);
      window.__showToast?.('\u2705 Gespeichert');
      onRefresh?.();
    } catch(e) { window.__showToast?.('Fehler: '+e.message,'error'); }
  };

  const handleFreigeben = async () => {
    if (!confirm(`${localAbrechnung.mitarbeiter_name} (${localAbrechnung.periode}) freigeben?\nDanach keine \u00c4nderungen mehr m\u00f6glich!`)) return;
    setLocalAbrechnung(prev => ({ ...prev, status:'freigegeben', freigegeben_am:new Date().toISOString(), freigegeben_von:'Patrick Grabowski' }));
    setTimeout(handleSave, 100);
  };

  const handlePdf = async () => {
    const pages = previewRef.current?.querySelectorAll('[id^="gs-page"]');
    if (!pages?.length) return;
    window.__showToast?.('PDF wird erstellt...');
    try {
      const kuerzel = localAbrechnung.kuerzel || genKuerzel(localAbrechnung.mitarbeiter_name);
      const container = document.createElement('div');
      pages.forEach(p => container.appendChild(p.cloneNode(true)));
      await html2pdf().set({ margin:0, filename:`Gutschrift_${localAbrechnung.periode.replace('/','-')}_${kuerzel}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}, pagebreak:{mode:['css','legacy'],before:'[id^="gs-page"]'} }).from(container).save();
      window.__showToast?.('\u2705 PDF heruntergeladen');
    } catch(e) { window.__showToast?.('PDF-Fehler: '+e.message,'error'); }
  };

  if (detailLoading) return <div className="detail-overlay"><div className="detail-container"><div className="loading"><div className="spinner"/>Lade...</div></div></div>;
  if (!localAbrechnung) return null;

  return <div className="detail-overlay" onClick={e => e.target===e.currentTarget && onClose()}>
    <div className="detail-container">
      <div className="detail-header">
        <div style={{display:'flex',alignItems:'center',gap:12}}>
          <button className="btn btn-secondary btn-sm" onClick={onClose}>{'\u2190'} Zur&uuml;ck</button>
          <span style={{fontWeight:700,fontSize:15}}>{localAbrechnung.mitarbeiter_name}</span>
          <span className={`badge badge-${localAbrechnung.status==='probeabrechnung'?'probe':localAbrechnung.status}`}>{localAbrechnung.status}</span>
        </div>
        <div style={{fontSize:12,color:'#8b949e'}}>{periodenLabel(localAbrechnung.periode)}</div>
      </div>
      <div className="detail-body">
        <EditPanel abrechnung={localAbrechnung} positionen={localPositionen} setPositionen={setLocalPositionen} systemgebuehr={systemgebuehr} onSave={handleSave} onFreigeben={handleFreigeben} onPdf={handlePdf} setAbrechnung={setLocalAbrechnung} />
        <div className="preview-panel" ref={previewRef}>
          <GutschriftPreview abrechnung={localAbrechnung} positionen={localPositionen} systemgebuehr={systemgebuehr} vormonatData={vormonatData} />
        </div>
      </div>
    </div>
  </div>;
}

function App() {
  const [appPerioden, setAppPerioden] = useState([]);
  const [appPeriode, setAppPeriode] = useState('');
  const [appAbrechnungen, setAppAbrechnungen] = useState([]);
  const [appAuszahlungen, setAppAuszahlungen] = useState([]);
  const [vmAuszahlungen, setVmAuszahlungen] = useState([]);
  const [appSystemgebuehr, setAppSystemgebuehr] = useState(null);
  const [appLoading, setAppLoading] = useState(true);
  const [appSelectedVt, setAppSelectedVt] = useState(null);

  useEffect(() => {
    (async () => {
      try {
        const all = await sbGet('pay_auszahlungen_historie', 'select=periode&order=periode.desc');
        const unique = [...new Set(all.map(a => a.periode))];
        const now = new Date();
        const curP = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}`;
        if (!unique.includes(curP)) unique.unshift(curP);
        const sorted = unique.sort().reverse();
        setAppPerioden(sorted);
        setAppPeriode(sorted[0] || curP);
      } catch(e) { const now=new Date(); const cp=`${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}`; setAppPerioden([cp]); setAppPeriode(cp); }
    })();
  }, []);

  const loadPeriode = useCallback(async () => {
    if (!appPeriode) return;
    setAppLoading(true);
    try {
      const [y, m] = appPeriode.split('/').map(Number);
      const vmM = m === 1 ? 12 : m - 1;
      const vmY = m === 1 ? y - 1 : y;
      const vmP = `${vmY}/${String(vmM).padStart(2,'0')}`;
      const [abrArr, auszArr, vmArr, sgArr] = await Promise.all([
        sbGet('pay_abrechnungen', `periode=eq.${appPeriode}&order=mitarbeiter_name.asc`),
        sbGet('pay_auszahlungen_historie', `periode=eq.${appPeriode}&order=vertriebler.asc`),
        sbGet('pay_auszahlungen_historie', `periode=eq.${vmP}&order=vertriebler.asc`).catch(()=>[]),
        sbGet('pay_systemgebuehr', 'aktiv=eq.true&limit=1')
      ]);
      setAppAbrechnungen(abrArr); setAppAuszahlungen(auszArr); setVmAuszahlungen(vmArr); setAppSystemgebuehr(sgArr[0]||null);
    } catch(e) { window.__showToast?.('Fehler: '+e.message,'error'); }
    setAppLoading(false);
  }, [appPeriode]);

  useEffect(() => { loadPeriode(); }, [loadPeriode]);

  const vtGroups = useMemo(() => {
    const groups = {};
    appAuszahlungen.forEach(a => {
      if (!groups[a.vertriebler]) groups[a.vertriebler] = { name:a.vertriebler, items:[], total:0 };
      groups[a.vertriebler].items.push(a);
      groups[a.vertriebler].total += parseFloat(a.netto)||0;
    });
    appAbrechnungen.forEach(ab => {
      if (!groups[ab.mitarbeiter_name]) groups[ab.mitarbeiter_name] = { name:ab.mitarbeiter_name, items:[], total:ab.brutto_provisionen||0 };
      groups[ab.mitarbeiter_name].abrechnung = ab;
    });
    return Object.values(groups).sort((a,b) => b.total - a.total);
  }, [appAuszahlungen, appAbrechnungen]);

  const vmGroupsMap = useMemo(() => {
    const g = {};
    vmAuszahlungen.forEach(a => { if (!g[a.vertriebler]) g[a.vertriebler] = { anzahl:0, betrag:0 }; g[a.vertriebler].anzahl++; g[a.vertriebler].betrag += parseFloat(a.netto)||0; });
    return g;
  }, [vmAuszahlungen]);

  const totalAusz = appAbrechnungen.reduce((s,a) => s+(parseFloat(a.auszahlungssumme)||0), 0);
  const freiCount = appAbrechnungen.filter(a => a.status==='freigegeben'||a.status==='ausgezahlt').length;

  const handleAlleErstellen = async () => {
    const toCreate = vtGroups.filter(g => !g.abrechnung);
    if (!confirm(`${toCreate.length} Probeabrechnungen erstellen?`)) return;
    window.__showToast?.('Erstelle...');
    let count = 0;
    for (const g of toCreate) {
      try {
        const kuerzel = genKuerzel(g.name);
        const posData = g.items.map(item => ({ typ:'provision', kunde:item.kunde||'\u2014', produkt:item.produkt||'Solar/WP', original_betrag:parseFloat(item.netto)||0, aktiv:true, zurueckgestellt:false }));
        const ber = berechneAbrechnung(posData.map(p=>({...p,override_betrag:null})), appSystemgebuehr, true);
        const saved = await sbPost('pay_abrechnungen', { periode:appPeriode, mitarbeiter_name:g.name, kuerzel, beschaeftigungsart:'hgb', status:'entwurf', anzahl_sales:ber.anzahlSales, brutto_provisionen:ber.bruttoProvisionen, systemgebuehr_netto:ber.sgNetto, systemgebuehr_ust:ber.sgUst, nettobetrag:ber.nettobetrag, ust_satz:ber.ustSatz, ust_betrag:ber.ustBetrag, auszahlungssumme:ber.auszahlung, belegnummer:genBelegnummer(appPeriode,kuerzel) });
        if (posData.length && saved[0]) await sbPost('pay_abrechnungen_positionen', posData.map(p=>({...p,abrechnung_id:saved[0].id})));
        count++;
      } catch(e) { console.error(g.name,e); }
    }
    window.__showToast?.(`\u2705 ${count} Abrechnungen erstellt`);
    loadPeriode();
  };

  return <ToastProvider>
    <div className="app-header">
      <div className="logo-area"><div><div className="logo-text">bee<span>-doo</span> PAY</div><div className="logo-sub">Probeabrechnung</div></div></div>
      <div className="controls-bar">
        <select className="sel-period" value={appPeriode} onChange={e=>setAppPeriode(e.target.value)}>
          {appPerioden.map(p => <option key={p} value={p}>{periodenLabel(p)}</option>)}
        </select>
        {vtGroups.filter(g=>!g.abrechnung).length > 0 && <button className="btn btn-primary" onClick={handleAlleErstellen}>{'\u26a1'} Alle erstellen ({vtGroups.filter(g=>!g.abrechnung).length})</button>}
        <a href="https://bee-doo-tools.vercel.app/" className="btn btn-secondary btn-sm" style={{textDecoration:'none'}}>{'\ud83c\udfe0'}</a>
      </div>
    </div>
    <div className="stats-row">
      <div className="stat-card"><div className="stat-label">Periode</div><div className="stat-value">{periodenLabel(appPeriode)}</div></div>
      <div className="stat-card"><div className="stat-label">Vertriebler</div><div className="stat-value gold">{vtGroups.length}</div></div>
      <div className="stat-card"><div className="stat-label">Abrechnungen</div><div className="stat-value">{appAbrechnungen.length} <span style={{fontSize:12,color:'#8b949e'}}>/ {vtGroups.length}</span></div></div>
      <div className="stat-card"><div className="stat-label">Freigegeben</div><div className="stat-value green">{freiCount}</div></div>
      <div className="stat-card"><div className="stat-label">Gesamtsumme</div><div className="stat-value gold">{fmtEur(totalAusz)}</div></div>
    </div>
    {appLoading ? <div className="loading"><div className="spinner"/>Lade...</div> :
      vtGroups.length === 0 ? <div className="empty-state"><div className="icon">{'\ud83d\udced'}</div><h3>Keine Daten f&uuml;r {periodenLabel(appPeriode)}</h3><p>F&uuml;r diese Periode liegen noch keine Auszahlungsdaten vor.</p></div> :
      <div className="main-grid">
        {vtGroups.map(g => { const ab = g.abrechnung; const kuerzel = ab?.kuerzel||genKuerzel(g.name); const status = ab?.status||'neu'; const vm = vmGroupsMap[g.name];
          return <div key={g.name} className="vt-card" onClick={()=>setAppSelectedVt({name:g.name,abrechnungId:ab?.id,data:g.items})}>
            <div className="vt-card-header"><span className="vt-name">{g.name}</span><span className="vt-kuerzel">{kuerzel}</span></div>
            <div className="vt-sales">{g.items.length} Positionen {vm && <span style={{color:g.items.length>=vm.anzahl?'#3fb950':'#f85149',fontSize:11}}>{g.items.length>=vm.anzahl?'\u25b2':'\u25bc'} vs. {vm.anzahl} VM</span>}</div>
            <div className="vt-betrag">{fmtEur(ab ? ab.auszahlungssumme : g.total)}</div>
            <div className="vt-card-footer">
              <span className={`badge ${status==='neu'?'badge-entwurf':status==='entwurf'?'badge-entwurf':status==='probeabrechnung'?'badge-probe':status==='freigegeben'?'badge-freigegeben':'badge-ausgezahlt'}`}>
                {status==='neu'?'\u2b1c Neu':status==='entwurf'?'\ud83d\udcdd Entwurf':status==='probeabrechnung'?'\ud83d\udd0d Probe':status==='freigegeben'?'\u2705 Freigegeben':'\ud83d\udcb8 Ausgezahlt'}
              </span>
              {ab && <span style={{fontSize:11,color:'#484f58'}}>{ab.anzahl_sales||0} Sales</span>}
            </div>
          </div>; })}
      </div>}
    {appSelectedVt && <DetailView abrechnungId={appSelectedVt.abrechnungId} periode={appPeriode} vtName={appSelectedVt.name} vtData={appSelectedVt.data} systemgebuehr={appSystemgebuehr} vormonatData={vmGroupsMap[appSelectedVt.name]} onClose={()=>setAppSelectedVt(null)} onRefresh={loadPeriode} />}
  </ToastProvider>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
