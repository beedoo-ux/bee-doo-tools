name: Build bee-doo Scout APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Accept licenses
      run: yes | sdkmanager --licenses || true

    - name: Install SDK packages
      run: |
        sdkmanager "platforms;android-34" "build-tools;34.0.0"

    - name: Create project structure
      run: |
        mkdir -p app/src/main/java/de/beedoo/scout
        mkdir -p app/src/main/res/{values,drawable,xml}
        mkdir -p app/src/main/res/{mipmap-mdpi,mipmap-hdpi,mipmap-xhdpi,mipmap-xxhdpi,mipmap-xxxhdpi}
        mkdir -p gradle/wrapper

    - name: Download icons
      run: |
        for SIZE in 48 72 96 144 192; do
          curl -sf -o icon-${SIZE}.png "https://bee-doo-tools.vercel.app/icons/icon-${SIZE}x${SIZE}.png" || echo "Icon $SIZE not found, using placeholder"
        done
        # Fallback: create simple placeholder if icons not available
        for SIZE in 48 72 96 144 192; do
          if [ ! -f "icon-${SIZE}.png" ]; then
            convert -size ${SIZE}x${SIZE} xc:'#1A1A2E' icon-${SIZE}.png 2>/dev/null || touch icon-${SIZE}.png
          fi
        done
        cp icon-48.png app/src/main/res/mipmap-mdpi/ic_launcher.png
        cp icon-72.png app/src/main/res/mipmap-hdpi/ic_launcher.png
        cp icon-96.png app/src/main/res/mipmap-xhdpi/ic_launcher.png
        cp icon-144.png app/src/main/res/mipmap-xxhdpi/ic_launcher.png
        cp icon-192.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

    - name: Create Gradle wrapper
      run: |
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF

    - name: Create settings.gradle
      run: |
        cat > settings.gradle << 'SETTINGS'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "bee-doo-scout"
        include ':app'
        SETTINGS

    - name: Create root build.gradle
      run: |
        cat > build.gradle << 'GRADLE'
        plugins {
            id 'com.android.application' version '8.2.0' apply false
        }
        GRADLE

    - name: Create gradle.properties
      run: |
        cat > gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.nonTransitiveRClass=true
        EOF

    - name: Create app/build.gradle
      run: |
        cat > app/build.gradle << 'GRADLE'
        plugins {
            id 'com.android.application'
        }
        android {
            namespace 'de.beedoo.scout'
            compileSdk 34
            defaultConfig {
                applicationId "de.beedoo.scout"
                minSdk 23
                targetSdk 34
                versionCode 1
                versionName "1.0.0"
            }
            buildTypes {
                debug {
                    applicationIdSuffix ".debug"
                    debuggable true
                }
                release {
                    minifyEnabled false
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_11
                targetCompatibility JavaVersion.VERSION_11
            }
        }
        dependencies {
            implementation 'androidx.browser:browser:1.7.0'
            implementation 'androidx.core:core:1.12.0'
            implementation 'androidx.appcompat:appcompat:1.6.1'
        }
        GRADLE

    - name: Create AndroidManifest.xml
      run: |
        cat > app/src/main/AndroidManifest.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
            <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
            <uses-permission android:name="android.permission.CAMERA" />
            <uses-permission android:name="android.permission.VIBRATE" />
            <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
            <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
            <uses-feature android:name="android.hardware.camera" android:required="false" />
            <uses-feature android:name="android.hardware.location.gps" android:required="true" />
            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="bee-doo Scout"
                android:theme="@style/Theme.BeeDoScout"
                android:networkSecurityConfig="@xml/network_security_config">
                <activity
                    android:name="de.beedoo.scout.LauncherActivity"
                    android:exported="true"
                    android:launchMode="singleTask"
                    android:screenOrientation="portrait">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                    <intent-filter android:autoVerify="true">
                        <action android:name="android.intent.action.VIEW" />
                        <category android:name="android.intent.category.DEFAULT" />
                        <category android:name="android.intent.category.BROWSABLE" />
                        <data android:scheme="https" android:host="bee-doo-tools.vercel.app" />
                    </intent-filter>
                </activity>
                <receiver android:name="de.beedoo.scout.BootReceiver" android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.BOOT_COMPLETED" />
                    </intent-filter>
                </receiver>
            </application>
        </manifest>
        XML

    - name: Create Java sources
      run: |
        cat > app/src/main/java/de/beedoo/scout/LauncherActivity.java << 'JAVA'
        package de.beedoo.scout;
        
        import android.Manifest;
        import android.app.Activity;
        import android.content.Intent;
        import android.content.pm.PackageManager;
        import android.net.Uri;
        import android.os.Build;
        import android.os.Bundle;
        import android.util.Log;
        import androidx.browser.customtabs.CustomTabsIntent;
        import androidx.core.app.ActivityCompat;
        import androidx.core.content.ContextCompat;
        import java.util.ArrayList;
        import java.util.List;
        
        public class LauncherActivity extends Activity {
            private static final String URL = "https://bee-doo-tools.vercel.app/scouting.html";
            private static final int PERM_CODE = 100;
        
            @Override
            protected void onCreate(Bundle state) {
                super.onCreate(state);
                List<String> perms = new ArrayList<>();
                if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED)
                    perms.add(Manifest.permission.ACCESS_FINE_LOCATION);
                if (ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED)
                    perms.add(Manifest.permission.CAMERA);
                if (Build.VERSION.SDK_INT >= 33 && ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED)
                    perms.add(Manifest.permission.POST_NOTIFICATIONS);
                if (!perms.isEmpty()) {
                    ActivityCompat.requestPermissions(this, perms.toArray(new String[0]), PERM_CODE);
                } else { launch(); }
            }
        
            @Override
            public void onRequestPermissionsResult(int c, String[] p, int[] r) {
                super.onRequestPermissionsResult(c, p, r);
                launch();
            }
        
            private void launch() {
                try {
                    CustomTabsIntent.Builder b = new CustomTabsIntent.Builder();
                    b.setShowTitle(false);
                    b.setUrlBarHidingEnabled(true);
                    CustomTabsIntent i = b.build();
                    i.intent.setPackage("com.android.chrome");
                    i.launchUrl(this, Uri.parse(URL));
                } catch (Exception e) {
                    startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(URL)));
                }
            }
        }
        JAVA
        
        cat > app/src/main/java/de/beedoo/scout/BootReceiver.java << 'JAVA'
        package de.beedoo.scout;
        import android.content.BroadcastReceiver;
        import android.content.Context;
        import android.content.Intent;
        public class BootReceiver extends BroadcastReceiver {
            @Override
            public void onReceive(Context ctx, Intent intent) {
                if (Intent.ACTION_BOOT_COMPLETED.equals(intent.getAction())) {
                    Intent l = new Intent(ctx, LauncherActivity.class);
                    l.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    ctx.startActivity(l);
                }
            }
        }
        JAVA

    - name: Create resources
      run: |
        cat > app/src/main/res/values/colors.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <color name="colorPrimary">#1A1A2E</color>
            <color name="colorPrimaryDark">#0D0D1A</color>
            <color name="colorAccent">#F5C500</color>
            <color name="backgroundColor">#0D0D1A</color>
        </resources>
        XML
        cat > app/src/main/res/values/styles.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <style name="Theme.BeeDoScout" parent="@android:style/Theme.NoTitleBar">
                <item name="android:windowBackground">@color/backgroundColor</item>
                <item name="android:statusBarColor">@color/colorPrimary</item>
                <item name="android:navigationBarColor">@color/colorPrimaryDark</item>
            </style>
        </resources>
        XML
        cat > app/src/main/res/values/strings.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <resources><string name="app_name">bee-doo Scout</string></resources>
        XML
        cat > app/src/main/res/xml/network_security_config.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <network-security-config>
            <domain-config cleartextTrafficPermitted="false">
                <domain includeSubdomains="true">bee-doo-tools.vercel.app</domain>
                <domain includeSubdomains="true">hqzpemfaljxcysyqssng.supabase.co</domain>
            </domain-config>
        </network-security-config>
        XML
        cat > app/src/main/res/drawable/splash.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
            <item android:drawable="@color/backgroundColor" />
        </layer-list>
        XML

    - name: Build APK
      run: |
        # Use Gradle wrapper with pinned version
        gradle wrapper --gradle-version 8.5
        chmod +x gradlew
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          ./gradlew assembleRelease --no-daemon
        else
          ./gradlew assembleDebug --no-daemon
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: bee-doo-scout-${{ github.event.inputs.build_type }}
        path: app/build/outputs/apk/**/*.apk
        retention-days: 30
