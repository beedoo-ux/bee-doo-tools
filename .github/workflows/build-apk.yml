name: Build bee-doo Scout APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Accept licenses
      run: yes | sdkmanager --licenses || true

    - name: Create Android TWA Project
      run: |
        mkdir -p app/src/main/java/de/beedoo/scout
        mkdir -p app/src/main/res/values
        mkdir -p app/src/main/res/drawable
        mkdir -p app/src/main/res/xml
        mkdir -p app/src/main/res/mipmap-mdpi
        mkdir -p app/src/main/res/mipmap-hdpi
        mkdir -p app/src/main/res/mipmap-xhdpi
        mkdir -p app/src/main/res/mipmap-xxhdpi
        mkdir -p app/src/main/res/mipmap-xxxhdpi
        mkdir -p gradle/wrapper

    - name: Generate Icons from URL
      run: |
        # Download icons from deployed site
        for SIZE in 48 72 96 144 192; do
          curl -s -o icon-${SIZE}.png "https://bee-doo-tools.vercel.app/icons/icon-${SIZE}x${SIZE}.png" || true
        done
        cp icon-48.png app/src/main/res/mipmap-mdpi/ic_launcher.png
        cp icon-72.png app/src/main/res/mipmap-hdpi/ic_launcher.png
        cp icon-96.png app/src/main/res/mipmap-xhdpi/ic_launcher.png
        cp icon-144.png app/src/main/res/mipmap-xxhdpi/ic_launcher.png
        cp icon-192.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

    - name: Create settings.gradle
      run: |
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "bee-doo-scout"
        include ':app'
        EOF

    - name: Create build.gradle (root)
      run: |
        cat > build.gradle << 'EOF'
        buildscript {
            repositories { google(); mavenCentral() }
            dependencies { classpath 'com.android.tools.build:gradle:8.2.0' }
        }
        allprojects {
            repositories { google(); mavenCentral() }
        }
        EOF

    - name: Create gradle.properties
      run: |
        cat > gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.nonTransitiveRClass=true
        EOF

    - name: Create gradle wrapper properties
      run: |
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF

    - name: Create app/build.gradle
      run: |
        cat > app/build.gradle << 'GRADLE'
        plugins { id 'com.android.application' }
        android {
            namespace 'de.beedoo.scout'
            compileSdk 34
            defaultConfig {
                applicationId "de.beedoo.scout"
                minSdk 23
                targetSdk 34
                versionCode 1
                versionName "1.0.0"
            }
            buildTypes {
                debug { applicationIdSuffix ".debug" }
                release {
                    minifyEnabled false
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_11
                targetCompatibility JavaVersion.VERSION_11
            }
        }
        dependencies {
            implementation 'androidx.browser:browser:1.7.0'
            implementation 'androidx.core:core:1.12.0'
            implementation 'androidx.appcompat:appcompat:1.6.1'
        }
        GRADLE

    - name: Create AndroidManifest.xml
      run: |
        cat > app/src/main/AndroidManifest.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
            <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
            <uses-permission android:name="android.permission.CAMERA" />
            <uses-permission android:name="android.permission.VIBRATE" />
            <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
            <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
            <uses-feature android:name="android.hardware.camera" android:required="false" />
            <uses-feature android:name="android.hardware.location.gps" android:required="true" />
            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="bee-doo Scout"
                android:theme="@style/Theme.BeeDoScout"
                android:networkSecurityConfig="@xml/network_security_config">
                <activity
                    android:name="de.beedoo.scout.LauncherActivity"
                    android:exported="true"
                    android:launchMode="singleTask"
                    android:screenOrientation="portrait">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                    <intent-filter android:autoVerify="true">
                        <action android:name="android.intent.action.VIEW" />
                        <category android:name="android.intent.category.DEFAULT" />
                        <category android:name="android.intent.category.BROWSABLE" />
                        <data android:scheme="https" android:host="bee-doo-tools.vercel.app" />
                    </intent-filter>
                    <meta-data android:name="android.support.customtabs.trusted.DEFAULT_URL"
                        android:value="https://bee-doo-tools.vercel.app/scouting.html" />
                </activity>
                <receiver android:name="de.beedoo.scout.BootReceiver" android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.BOOT_COMPLETED" />
                    </intent-filter>
                </receiver>
            </application>
        </manifest>
        XML

    - name: Create LauncherActivity.java
      run: |
        cat > app/src/main/java/de/beedoo/scout/LauncherActivity.java << 'JAVA'
        package de.beedoo.scout;
        import android.Manifest;
        import android.app.Activity;
        import android.content.Intent;
        import android.content.pm.PackageManager;
        import android.net.Uri;
        import android.os.Build;
        import android.os.Bundle;
        import android.util.Log;
        import android.widget.Toast;
        import androidx.browser.customtabs.CustomTabsIntent;
        import androidx.core.app.ActivityCompat;
        import androidx.core.content.ContextCompat;
        import java.util.ArrayList;
        import java.util.List;
        
        public class LauncherActivity extends Activity {
            private static final String TAG = "BeeDoScout";
            private static final String URL = "https://bee-doo-tools.vercel.app/scouting.html";
            private static final int PERM_REQ = 100;
        
            @Override
            protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                checkPermissions();
            }
        
            private void checkPermissions() {
                List<String> needed = new ArrayList<>();
                if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED)
                    needed.add(Manifest.permission.ACCESS_FINE_LOCATION);
                if (ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED)
                    needed.add(Manifest.permission.CAMERA);
                if (Build.VERSION.SDK_INT >= 33 && ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED)
                    needed.add(Manifest.permission.POST_NOTIFICATIONS);
                if (!needed.isEmpty()) {
                    ActivityCompat.requestPermissions(this, needed.toArray(new String[0]), PERM_REQ);
                } else {
                    launchApp();
                }
            }
        
            @Override
            public void onRequestPermissionsResult(int code, String[] perms, int[] results) {
                super.onRequestPermissionsResult(code, perms, results);
                launchApp();
            }
        
            private void launchApp() {
                try {
                    CustomTabsIntent.Builder builder = new CustomTabsIntent.Builder();
                    builder.setShowTitle(false);
                    builder.setUrlBarHidingEnabled(true);
                    CustomTabsIntent intent = builder.build();
                    intent.intent.setPackage("com.android.chrome");
                    intent.launchUrl(this, Uri.parse(URL));
                } catch (Exception e) {
                    Log.e(TAG, "Fallback to browser", e);
                    startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(URL)));
                }
            }
        }
        JAVA

    - name: Create BootReceiver.java
      run: |
        cat > app/src/main/java/de/beedoo/scout/BootReceiver.java << 'JAVA'
        package de.beedoo.scout;
        import android.content.BroadcastReceiver;
        import android.content.Context;
        import android.content.Intent;
        public class BootReceiver extends BroadcastReceiver {
            @Override
            public void onReceive(Context ctx, Intent intent) {
                if (Intent.ACTION_BOOT_COMPLETED.equals(intent.getAction())) {
                    Intent launch = new Intent(ctx, LauncherActivity.class);
                    launch.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    ctx.startActivity(launch);
                }
            }
        }
        JAVA

    - name: Create resources
      run: |
        cat > app/src/main/res/values/colors.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <color name="colorPrimary">#1A1A2E</color>
            <color name="colorPrimaryDark">#0D0D1A</color>
            <color name="colorAccent">#F5C500</color>
            <color name="backgroundColor">#0D0D1A</color>
        </resources>
        XML
        
        cat > app/src/main/res/values/styles.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <style name="Theme.BeeDoScout" parent="@android:style/Theme.NoTitleBar">
                <item name="android:windowBackground">@color/backgroundColor</item>
                <item name="android:statusBarColor">@color/colorPrimary</item>
                <item name="android:navigationBarColor">@color/colorPrimaryDark</item>
            </style>
        </resources>
        XML
        
        cat > app/src/main/res/values/strings.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <string name="app_name">bee-doo Scout</string>
        </resources>
        XML
        
        cat > app/src/main/res/xml/network_security_config.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <network-security-config>
            <domain-config cleartextTrafficPermitted="false">
                <domain includeSubdomains="true">bee-doo-tools.vercel.app</domain>
                <domain includeSubdomains="true">hqzpemfaljxcysyqssng.supabase.co</domain>
            </domain-config>
        </network-security-config>
        XML
        
        cat > app/src/main/res/drawable/splash.xml << 'XML'
        <?xml version="1.0" encoding="utf-8"?>
        <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
            <item android:drawable="@color/backgroundColor" />
            <item android:gravity="center" android:width="144dp" android:height="144dp">
                <bitmap android:gravity="center" android:src="@mipmap/ic_launcher" />
            </item>
        </layer-list>
        XML

    - name: Setup Gradle Wrapper
      uses: gradle/actions/setup-gradle@v3

    - name: Build APK
      run: |
        gradle wrapper --gradle-version 8.5
        chmod +x gradlew
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          ./gradlew assembleRelease
        else
          ./gradlew assembleDebug
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: bee-doo-scout-${{ github.event.inputs.build_type }}
        path: app/build/outputs/apk/**/*.apk
        retention-days: 30
