name: DB Migration

on:
  workflow_dispatch:
  push:
    paths:
      - 'migrations/*.sql'

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run all SQL migrations
        env:
          MGMT_TOKEN: ${{ secrets.SUPABASE_MGMT_TOKEN }}
        run: |
          for SQLFILE in migrations/*.sql; do
            echo "üì¶ Running: $SQLFILE"
            SQL=$(cat "$SQLFILE")
            
            RESPONSE=$(curl -s -w "
%{http_code}" -X POST \
              "https://api.supabase.com/v1/projects/hqzpemfaljxcysyqssng/database/query" \
              -H "Authorization: Bearer $MGMT_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(echo "$SQL" | python3 -c "import json,sys; print(json.dumps({'query': sys.stdin.read()}))")")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            echo "HTTP: $HTTP_CODE"
            echo "Response: $BODY"
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
              echo "‚úÖ $SQLFILE erfolgreich"
            else
              echo "‚ùå $SQLFILE fehlgeschlagen: $BODY"
              exit 1
            fi
          done
