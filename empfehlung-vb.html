<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo | Empfehlungs-Ãœbersicht</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', system-ui, sans-serif; background: #080C14; color: #e1e7ef; min-height: 100vh; }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: rgba(245,197,0,0.3); border-radius: 4px; }
  @media (max-width: 768px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr) !important; }
    .tbl-wrap { overflow-x: auto; }
    .tbl-wrap table { min-width: 620px; }
    .top-bar { flex-direction: column; gap: 10px !important; align-items: flex-start !important; }
  }
  @media (max-width: 480px) {
    .kpi-grid { grid-template-columns: 1fr !important; }
    .lead-row { flex-direction: column; align-items: flex-start !important; gap: 6px !important; }
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback } = React;

const SB = "https://hqzpemfaljxcysyqssng.supabase.co";
const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik";
const H = { apikey: KEY, Authorization: `Bearer ${KEY}`, "Content-Type": "application/json" };
const get = async (t, q) => { const r = await fetch(`${SB}/rest/v1/${t}?${q || "select=*"}`, { headers: H }); return r.ok ? r.json() : []; };
const patch = async (t, m, d) => { await fetch(`${SB}/rest/v1/${t}?${m}`, { method: "PATCH", headers: { ...H, Prefer: "return=minimal" }, body: JSON.stringify(d) }); };

const Y = "#F5C500", G = "#22c55e", B = "#3b82f6", P = "#a855f7", O = "#f97316", R = "#ef4444";
const BD = "#1e293b", C1 = "#111927", C2 = "#1a2236", DIM = "#4b5563", SEC = "#8b95a5", TXT = "#e1e7ef";

const STATUS = [
  { key: "eingegangen", label: "Eingegangen", icon: "ğŸ“¥", color: B },
  { key: "angerufen", label: "Angerufen", icon: "ğŸ“", color: P },
  { key: "termin_vereinbart", label: "Termin", icon: "ğŸ“…", color: O },
  { key: "termin_stattgefunden", label: "Stattgef.", icon: "âœ…", color: Y },
  { key: "sale", label: "Sale", icon: "ğŸ‰", color: G },
  { key: "kein_sale", label: "Kein Sale", icon: "âŒ", color: R },
  { key: "storno", label: "Storno", icon: "ğŸš«", color: R },
];
const getStatus = (k) => STATUS.find(s => s.key === k) || STATUS[0];
const getPraemie = (n) => n <= 0 ? 0 : n === 1 ? 700 : n === 2 ? 800 : n === 3 ? 900 : 1000;
const getTotalPraemie = (s) => { let t = 0; for (let i = 1; i <= s; i++) t += getPraemie(i); return t; };

function App() {
  const [werber, setWerber] = useState([]);
  const [leads, setLeads] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [expanded, setExpanded] = useState(null);
  const [modal, setModal] = useState(null);
  const berater = new URLSearchParams(window.location.search).get("b") || "Bernd Schulz";

  const load = useCallback(async () => {
    try {
      const [w, l] = await Promise.all([
        get("referral_customers", `select=*&berater_name=eq.${encodeURIComponent(berater)}&order=created_at.desc`),
        get("referral_leads", `select=*&order=created_at.desc`),
      ]);
      setWerber(w || []);
      setLeads(l || []);
    } catch (e) { console.error(e); }
    setLoading(false);
  }, [berater]);

  useEffect(() => { load(); }, [load]);

  const changeStatus = async (lead, newStatus) => {
    const hist = [...(lead.pipeline_history || []), { status: newStatus, timestamp: new Date().toISOString(), by: berater }];
    await patch("referral_leads", `id=eq.${lead.id}`, {
      pipeline_status: newStatus,
      pipeline_history: hist,
      status: newStatus === "sale" ? "sale" : newStatus === "storno" ? "storno" : newStatus === "angerufen" ? "kontaktiert" : newStatus === "termin_vereinbart" ? "termin" : "neu",
      updated_at: new Date().toISOString()
    });
    setModal(null);
    load();
  };

  // Per-Kunde Stats
  const rows = werber.map(w => {
    const wl = leads.filter(l => l.werber_code === w.code);
    const sales = wl.filter(l => l.pipeline_status === "sale").length;
    const pending = wl.filter(l => !["sale", "kein_sale", "storno"].includes(l.pipeline_status || "")).length;
    return { ...w, leads: wl, empf: wl.length, sales, pending, praemie: getTotalPraemie(sales), klicks: w.link_clicks || 0 };
  });

  const filtered = rows.filter(w => {
    if (!search) return true;
    const s = search.toLowerCase();
    return `${w.vorname} ${w.nachname}`.toLowerCase().includes(s) || w.code?.toLowerCase().includes(s) || (w.ort || "").toLowerCase().includes(s);
  });

  const tot = { kunden: rows.length, empf: rows.reduce((a,w) => a+w.empf, 0), sales: rows.reduce((a,w) => a+w.sales, 0), pending: rows.reduce((a,w) => a+w.pending, 0), klicks: rows.reduce((a,w) => a+w.klicks, 0), praemie: rows.reduce((a,w) => a+w.praemie, 0) };

  const Badge = ({ text, color }) => (
    <span style={{ display: "inline-block", padding: "2px 8px", borderRadius: 6, background: `${color}15`, border: `1px solid ${color}30`, fontSize: 11, fontWeight: 700, color }}>{text}</span>
  );

  if (loading) return <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", color: SEC }}>Laden...</div>;

  return (
    <div style={{ maxWidth: 960, margin: "0 auto", padding: "0 16px 60px" }}>

      {/* â”€â”€ Status-Modal â”€â”€ */}
      {modal && (
        <div style={{ position: "fixed", inset: 0, zIndex: 9999, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "center", justifyContent: "center", padding: 16 }} onClick={() => setModal(null)}>
          <div onClick={e => e.stopPropagation()} style={{ width: "100%", maxWidth: 420, background: C1, borderRadius: 16, border: `1px solid ${BD}`, padding: 24 }}>
            <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 2 }}>{modal.lead.vorname} {modal.lead.nachname}</div>
            <div style={{ fontSize: 12, color: SEC, marginBottom: 16 }}>
              via {modal.werber?.vorname} {modal.werber?.nachname} Â· {modal.lead.telefon}
            </div>
            <div style={{ fontSize: 10, fontWeight: 700, color: DIM, textTransform: "uppercase", letterSpacing: 1.2, marginBottom: 8 }}>Status Ã¤ndern</div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
              {STATUS.map(st => {
                const active = modal.lead.pipeline_status === st.key;
                return (
                  <button key={st.key} onClick={() => !active && changeStatus(modal.lead, st.key)}
                    style={{ padding: "8px 14px", borderRadius: 8, border: `1.5px solid ${active ? st.color : BD}`, background: active ? `${st.color}18` : "transparent", color: active ? st.color : SEC, fontSize: 12, fontWeight: 700, fontFamily: "'DM Sans',sans-serif", cursor: active ? "default" : "pointer", opacity: active ? 1 : 0.8 }}>
                    {st.icon} {st.label}
                  </button>
                );
              })}
            </div>
            <div style={{ display: "flex", gap: 8, marginTop: 16 }}>
              <a href={`tel:${modal.lead.telefon}`} style={{ flex: 1, padding: 10, borderRadius: 8, background: G, color: "#fff", fontSize: 12, fontWeight: 700, textDecoration: "none", textAlign: "center" }}>ğŸ“ Anrufen</a>
              <button onClick={() => { window.open(`https://wa.me/${(modal.lead.telefon||"").replace(/[^0-9+]/g, "")}?text=${encodeURIComponent(`Hallo ${modal.lead.vorname}, hier ist Ihr bee-doo Berater.`)}`); }} style={{ flex: 1, padding: 10, borderRadius: 8, background: "#25D366", color: "#fff", fontSize: 12, fontWeight: 700, border: "none", cursor: "pointer", fontFamily: "'DM Sans',sans-serif" }}>ğŸ’¬ WhatsApp</button>
              <button onClick={() => setModal(null)} style={{ padding: "10px 16px", borderRadius: 8, background: C2, color: SEC, fontSize: 12, fontWeight: 700, border: `1px solid ${BD}`, cursor: "pointer", fontFamily: "'DM Sans',sans-serif" }}>SchlieÃŸen</button>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ Header â”€â”€ */}
      <div className="top-bar" style={{ padding: "20px 0 16px", display: "flex", alignItems: "center", justifyContent: "space-between", gap: 12 }}>
        <div>
          <div style={{ fontSize: 20, fontWeight: 900 }}>ğŸ¤ Empfehlungs-Ãœbersicht</div>
          <div style={{ fontSize: 12, color: SEC }}>{berater} Â· {rows.length} Kunden</div>
        </div>
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={load} style={{ padding: "8px 14px", borderRadius: 8, background: C1, border: `1px solid ${BD}`, color: SEC, fontSize: 12, fontWeight: 700, fontFamily: "'DM Sans',sans-serif", cursor: "pointer" }}>ğŸ”„</button>
          <a href="field.html" style={{ padding: "8px 14px", borderRadius: 8, background: C1, border: `1px solid ${BD}`, color: SEC, fontSize: 12, fontWeight: 700, textDecoration: "none" }}>â† Field</a>
        </div>
      </div>

      {/* â”€â”€ KPIs â”€â”€ */}
      <div className="kpi-grid" style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 10, marginBottom: 20 }}>
        {[
          { label: "Kunden", val: tot.kunden, color: B },
          { label: "Empfehlungen", val: tot.empf, sub: `${tot.pending} in Bearbeitung`, color: P },
          { label: "Sales", val: tot.sales, sub: tot.empf > 0 ? `${Math.round((tot.sales/tot.empf)*100)}% Abschlussrate` : "", color: G },
          { label: "Link-Klicks", val: tot.klicks, color: Y },
        ].map(k => (
          <div key={k.label} style={{ background: C1, border: `1px solid ${BD}`, borderRadius: 12, padding: "14px 16px" }}>
            <div style={{ fontSize: 10, fontWeight: 700, color: DIM, textTransform: "uppercase", letterSpacing: 1 }}>{k.label}</div>
            <div style={{ fontSize: 28, fontWeight: 900, color: k.color, marginTop: 2 }}>{k.val.toLocaleString("de-DE")}</div>
            {k.sub && <div style={{ fontSize: 11, color: DIM, marginTop: 1 }}>{k.sub}</div>}
          </div>
        ))}
      </div>

      {/* â”€â”€ Suche â”€â”€ */}
      <input value={search} onChange={e => setSearch(e.target.value)} placeholder="ğŸ” Kunde suchenâ€¦"
        style={{ width: "100%", padding: "11px 16px", borderRadius: 10, border: `1px solid ${BD}`, background: C1, color: TXT, fontSize: 14, fontFamily: "'DM Sans',sans-serif", outline: "none", marginBottom: 16 }} />

      {/* â”€â”€ Tabelle â”€â”€ */}
      <div className="tbl-wrap" style={{ background: C1, border: `1px solid ${BD}`, borderRadius: 14, overflow: "hidden" }}>
        <table style={{ width: "100%", borderCollapse: "collapse" }}>
          <thead>
            <tr style={{ borderBottom: `1px solid ${BD}` }}>
              {["Kunde", "Code", "Klicks", "Empfehlungen", "Offen", "Sales", "PrÃ¤mie", ""].map(h => (
                <th key={h} style={{ padding: "12px 14px", fontSize: 10, fontWeight: 700, color: DIM, textTransform: "uppercase", letterSpacing: 1.2, textAlign: "left", whiteSpace: "nowrap" }}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {filtered.map(w => (
              <React.Fragment key={w.id}>
                {/* â”€â”€ Zeile â”€â”€ */}
                <tr onClick={() => setExpanded(expanded === w.id ? null : w.id)}
                  style={{ borderBottom: `1px solid ${BD}`, cursor: "pointer", background: expanded === w.id ? `${Y}06` : "transparent" }}>
                  <td style={{ padding: "12px 14px" }}>
                    <div style={{ fontSize: 14, fontWeight: 700 }}>{w.vorname} {w.nachname}</div>
                    <div style={{ fontSize: 11, color: DIM }}>{w.plz} {w.ort}</div>
                  </td>
                  <td style={{ padding: "12px 14px" }}>
                    <span style={{ fontFamily: "monospace", fontSize: 12, fontWeight: 700, color: Y, background: `${Y}10`, padding: "3px 8px", borderRadius: 6 }}>{w.code}</span>
                  </td>
                  <td style={{ padding: "12px 14px", fontSize: 15, fontWeight: 700, color: w.klicks > 0 ? Y : DIM }}>{w.klicks}</td>
                  <td style={{ padding: "12px 14px", fontSize: 15, fontWeight: 700, color: w.empf > 0 ? P : DIM }}>{w.empf}</td>
                  <td style={{ padding: "12px 14px" }}>
                    {w.pending > 0 ? <Badge text={`${w.pending} offen`} color={O} /> : <span style={{ color: DIM }}>0</span>}
                  </td>
                  <td style={{ padding: "12px 14px", fontSize: 15, fontWeight: 700, color: w.sales > 0 ? G : DIM }}>{w.sales}</td>
                  <td style={{ padding: "12px 14px", fontSize: 15, fontWeight: 800, color: w.praemie > 0 ? G : DIM }}>
                    {w.praemie > 0 ? `${w.praemie.toLocaleString("de-DE")}â‚¬` : "â€“"}
                  </td>
                  <td style={{ padding: "12px 14px", textAlign: "center", color: DIM, fontSize: 14 }}>{expanded === w.id ? "â–²" : "â–¼"}</td>
                </tr>

                {/* â”€â”€ Aufgeklappt: Leads â”€â”€ */}
                {expanded === w.id && (
                  <tr><td colSpan={8} style={{ padding: "0 14px 14px", background: `${Y}03` }}>
                    {w.leads.length > 0 ? (
                      <div style={{ display: "flex", flexDirection: "column", gap: 6, paddingTop: 10 }}>
                        <div style={{ fontSize: 10, fontWeight: 700, color: DIM, textTransform: "uppercase", letterSpacing: 1, marginBottom: 2 }}>Empfehlungen von {w.vorname}</div>
                        {w.leads.map(l => {
                          const st = getStatus(l.pipeline_status || "eingegangen");
                          const days = Math.round((Date.now() - new Date(l.created_at).getTime()) / 86400000);
                          return (
                            <div key={l.id} className="lead-row" onClick={e => { e.stopPropagation(); setModal({ lead: l, werber: w }); }}
                              style={{ display: "flex", alignItems: "center", gap: 12, padding: "10px 12px", borderRadius: 10, background: C2, cursor: "pointer" }}>
                              <div style={{ width: 30, height: 30, borderRadius: "50%", background: `${st.color}15`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, flexShrink: 0 }}>{st.icon}</div>
                              <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{ fontSize: 13, fontWeight: 700 }}>{l.vorname} {l.nachname}</div>
                                <div style={{ fontSize: 11, color: DIM }}>{l.telefon} Â· vor {days}d</div>
                              </div>
                              <Badge text={st.label} color={st.color} />
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <div style={{ padding: "14px 0", fontSize: 12, color: DIM }}>Noch keine Empfehlungen Ã¼ber {w.vorname}</div>
                    )}
                    {/* Quick Actions */}
                    <div style={{ display: "flex", gap: 8, marginTop: 10, paddingTop: 10, borderTop: `1px solid ${BD}` }}>
                      <button onClick={e => { e.stopPropagation();
                        const link = `https://bee-doo-tools.vercel.app/empfehlung-r.html?c=${w.code}&s=whatsapp`;
                        const txt = `Hallo ${w.vorname}! Hier ist dein Empfehlungslink fÃ¼r bee-doo Solar:\n${link}\n\nTeile ihn mit Freunden â€“ fÃ¼r jeden Abschluss gibt's eine PrÃ¤mie! ğŸª™`;
                        window.open(`https://wa.me/${(w.telefon||"").replace(/[^0-9+]/g, "")}?text=${encodeURIComponent(txt)}`);
                      }} style={{ padding: "8px 14px", borderRadius: 8, background: "#25D366", color: "#fff", fontSize: 11, fontWeight: 700, border: "none", cursor: "pointer", fontFamily: "'DM Sans',sans-serif" }}>
                        ğŸ’¬ Link an {w.vorname} senden
                      </button>
                      <button onClick={e => { e.stopPropagation();
                        navigator.clipboard.writeText(`https://bee-doo-tools.vercel.app/empfehlung-r.html?c=${w.code}`);
                      }} style={{ padding: "8px 14px", borderRadius: 8, background: C2, color: SEC, fontSize: 11, fontWeight: 700, border: `1px solid ${BD}`, cursor: "pointer", fontFamily: "'DM Sans',sans-serif" }}>
                        ğŸ“‹ Link kopieren
                      </button>
                    </div>
                  </td></tr>
                )}
              </React.Fragment>
            ))}
          </tbody>
        </table>
        {filtered.length === 0 && (
          <div style={{ padding: 40, textAlign: "center", color: DIM }}>
            {search ? "Kein Kunde gefunden" : "Noch keine Kunden registriert"}
          </div>
        )}
      </div>

      {/* â”€â”€ PrÃ¤mien-Footer â”€â”€ */}
      {tot.praemie > 0 && (
        <div style={{ marginTop: 16, padding: "14px 20px", background: C1, border: `1px solid ${BD}`, borderRadius: 12, display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: 8 }}>
          <div style={{ fontSize: 12, color: SEC }}>Gesamt-PrÃ¤mien (700 â†’ 800 â†’ 900 â†’ 1.000â‚¬ je Sale)</div>
          <div style={{ fontSize: 22, fontWeight: 900, color: G }}>{tot.praemie.toLocaleString("de-DE")}â‚¬</div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
