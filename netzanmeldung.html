<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo Â· Netzanmeldung</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.2/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0C0D0F; color: #F1F2F4; font-family: 'IBM Plex Sans', system-ui, sans-serif; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: #141618; }
  ::-webkit-scrollbar-thumb { background: #2A2D31; border-radius: 3px; }
  input, select, textarea {
    outline: none; background: #141618; border: 1px solid #2A2D31;
    border-radius: 8px; color: #F1F2F4; font-family: inherit;
    padding: 10px 14px; font-size: 14px; width: 100%; transition: border-color 0.15s;
  }
  input:focus, select:focus, textarea:focus { border-color: #F9D71C; }
  textarea { resize: vertical; line-height: 1.6; }
  button { cursor: pointer; font-family: inherit; transition: all 0.15s; }
  table { border-collapse: collapse; width: 100%; }
  .fade-in { animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
</style>

<style>

/* â•â•â• bee-doo Responsive + Lesbarkeit Fix â•â•â• */

/* === LESBARKEIT: Schriften aufhellen === */
/* Zu dunkle GrautÃ¶ne auf Dark Theme aufhellen */
body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

/* === TABLET (768px) === */
@media (max-width: 768px) {
  /* Grid â†’ weniger Spalten */
  [style*="grid-template-columns"][style*="repeat"] { 
    grid-template-columns: repeat(2, 1fr) !important; 
  }
  [style*="gridTemplateColumns"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* Flex-Container wrappen */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'], [style*="display:'flex'"] {
    flex-wrap: wrap !important;
  }
  /* Ausnahme: Nav-Items und kleine Icon-Rows nicht wrappen */
  [style*="align-items:center"][style*="gap:4px"],
  [style*="alignItems:"center""][style*="gap:"4px""] {
    flex-wrap: nowrap !important;
  }
  
  /* Sidebar verkleinern */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'] {
    width: 200px !important;
    min-width: 200px !important;
  }
  
  /* Modals nicht breiter als Screen */
  .modal, [style*="width:480px"], [style*="width:520px"], [style*="width:560px"],
  [style*="width:600px"], [style*="width:640px"], [style*="width:700px"] {
    width: 95vw !important;
    max-width: 95vw !important;
  }
  
  /* Padding reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"] {
    padding: 20px !important;
  }
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"] {
    padding: 20px !important;
  }
  
  /* Tabellen scrollbar */
  table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  
  /* Font-Size Minimum */
  * { min-height: 0; }
}

/* === MOBILE (480px) === */
@media (max-width: 480px) {
  /* Grid â†’ 1 Spalte */
  [style*="grid-template-columns"], [style*="gridTemplateColumns"] { 
    grid-template-columns: 1fr !important; 
  }
  .grid { grid-template-columns: 1fr !important; }
  
  /* Sidebar ausblenden oder collapsieren */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*="width:200px"], [style*="width: 200px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'],
  [style*='width:"200px"'] {
    position: fixed !important;
    left: -300px !important;
    z-index: 999 !important;
    transition: left 0.3s ease !important;
    width: 260px !important;
    height: 100vh !important;
    top: 0 !important;
  }
  
  /* Alle Flex-Container stacken */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'] {
    flex-wrap: wrap !important;
  }
  [style*="flex-direction:row"], [style*="flexDirection:"row""],
  [style*="flex-direction: row"] {
    flex-direction: column !important;
  }
  
  /* Form-Elemente full width */
  input, select, textarea, .input-field {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    font-size: 16px !important; /* Prevents iOS zoom */
  }
  
  /* Buttons touch-friendly */
  button, .btn-primary, .btn-secondary, [role="button"] {
    min-height: 44px !important;
    min-width: 44px !important;
    font-size: 14px !important;
  }
  
  /* Padding stark reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"],
  [style*="padding:28px"], [style*="padding:24px"],
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"],
  [style*="padding: 28px"], [style*="padding: 24px"] {
    padding: 12px !important;
  }
  
  /* Gap reduzieren */
  [style*="gap:24px"], [style*="gap:20px"], [style*="gap:28px"],
  [style*="gap: 24px"], [style*="gap: 20px"], [style*="gap: 28px"] {
    gap: 12px !important;
  }
  
  /* Font sizes - minimum 12px */
  [style*="font-size:8px"], [style*="font-size:9px"], [style*="font-size:10px"],
  [style*="font-size: 8px"], [style*="font-size: 9px"], [style*="font-size: 10px"],
  [style*="fontSize:8px"], [style*="fontSize:9px"], [style*="fontSize:10px"],
  [style*='fontSize:"8px"'], [style*='fontSize:"9px"'], [style*='fontSize:"10px"'] {
    font-size: 12px !important;
  }
  
  /* Bilder responsive */
  img { max-width: 100% !important; height: auto !important; }
  
  /* Fixed elements repositionieren */
  [style*="position:fixed"][style*="top:12px"][style*="left:12px"],
  [style*="position: fixed"][style*="top: 12px"][style*="left: 12px"] {
    top: 6px !important;
    left: 6px !important;
    font-size: 11px !important;
    padding: 4px 8px !important;
  }
  
  /* Logo kleiner */
  .logo { font-size: 32px !important; }
  
  /* Text wrap erzwingen */
  * { word-wrap: break-word !important; overflow-wrap: break-word !important; }
  [style*="white-space:nowrap"], [style*="white-space: nowrap"],
  [style*='whiteSpace:"nowrap"'] {
    white-space: normal !important;
  }
  
  /* Modals full width */
  .modal, [class*="modal"], [style*="width:480px"], [style*="width:520px"],
  [style*="width:560px"], [style*="width:600px"] {
    width: 96vw !important;
    max-width: 96vw !important;
    padding: 16px !important;
    margin: 8px !important;
  }
  
  /* Map containers */
  #map, .leaflet-container, [style*="height:100vh"] {
    height: calc(100vh - 60px) !important;
  }
  .map-toolbar {
    flex-direction: column !important;
    top: 6px !important;
    left: 6px !important;
    right: 6px !important;
  }
  .map-tool-btn {
    font-size: 11px !important;
    padding: 5px 10px !important;
  }
}

/* â•â•â• Lesbarkeit: Zu dunkle Farben aufhellen â•â•â• */
/* #0c1222 backgrounds â†’ Schrift mindestens #8b95a5 */
[style*="color:#0c1222"], [style*="color: #0c1222"] { color: #8b95a5 !important; }
[style*="color:#151d30"], [style*="color: #151d30"] { color: #8b95a5 !important; }
[style*="color:#263354"], [style*="color: #263354"] { color: #7a8baa !important; }
[style*="color:#1c2640"], [style*="color: #1c2640"] { color: #8b95a5 !important; }
[style*="color:#334155"], [style*="color: #334155"] { color: #8b95a5 !important; }
[style*="color:#252530"], [style*="color: #252530"] { color: #8b95a5 !important; }
[style*='color:"#0c1222"'] { color: #8b95a5 !important; }
[style*='color:"#151d30"'] { color: #8b95a5 !important; }
[style*='color:"#263354"'] { color: #7a8baa !important; }
[style*='color:"#1c2640"'] { color: #8b95a5 !important; }
[style*='color:"#334155"'] { color: #8b95a5 !important; }
[style*='color:"#252530"'] { color: #8b95a5 !important; }

/* GrÃ¼ntÃ¶ne auf Dark besser lesbar machen */
[style*="color:#166534"], [style*="color: #166534"] { color: #34d399 !important; }
[style*='color:"#166534"'] { color: #34d399 !important; }

/* Generell: Alle font-sizes unter 10px auf mindestens 11px */
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPA_URL = "https://hqzpemfaljxcysyqssng.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczOTQ1MzYyOCwiZXhwIjoyMDU1MDI5NjI4fQ.LSlMAp-LxNGMj4r8wNPTSgKFMIexZg-Y4p1YLRKqLdc";

const H = { apikey: SUPA_KEY, Authorization: `Bearer ${SUPA_KEY}`, "Content-Type": "application/json" };

const db = {
  async get(t, q = "") {
    const r = await fetch(`${SUPA_URL}/rest/v1/${t}${q}`, { headers: H });
    return r.json();
  },
  async post(t, body) {
    const r = await fetch(`${SUPA_URL}/rest/v1/${t}`, {
      method: "POST", headers: { ...H, Prefer: "return=representation" }, body: JSON.stringify(body)
    });
    return r.json();
  },
  async patch(t, id, body) {
    const r = await fetch(`${SUPA_URL}/rest/v1/${t}?id=eq.${id}`, {
      method: "PATCH", headers: { ...H, Prefer: "return=representation" }, body: JSON.stringify(body)
    });
    return r.json();
  },
  async del(t, id) {
    await fetch(`${SUPA_URL}/rest/v1/${t}?id=eq.${id}`, { method: "DELETE", headers: H });
  }
};

// â”€â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATUS = {
  erfasst:                  { label: "Erfasst",                  color: "#9CA3AF", bg: "#1f2937", icon: "ğŸ“‹" },
  unterlagen_angefordert:   { label: "Unterlagen angefordert",   color: "#F59E0B", bg: "#451a03", icon: "ğŸ“„" },
  eingereicht:              { label: "Eingereicht",              color: "#3B82F6", bg: "#1e3a5f", icon: "ğŸ“¤" },
  in_pruefung:              { label: "In PrÃ¼fung",               color: "#A78BFA", bg: "#2e1065", icon: "ğŸ”" },
  genehmigt:                { label: "Genehmigt",                color: "#10B981", bg: "#064e3b", icon: "âœ…" },
  abgelehnt:                { label: "Abgelehnt",                color: "#EF4444", bg: "#450a0a", icon: "âŒ" },
  inbetrieb:                { label: "In Betrieb",               color: "#F9D71C", bg: "#1a1400", icon: "âš¡" },
};
const FLOW = ["erfasst","unterlagen_angefordert","eingereicht","in_pruefung","genehmigt","inbetrieb"];

// â”€â”€â”€ PLZ â†’ NETZBETREIBER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PLZ â†’ Netzbetreiber: dynamisch aus DB-Tabelle netzbetreiber_plz_mapping
let NB_CACHE = null;
async function loadNbMapping() {
  if (NB_CACHE) return;
  try {
    const r = await db.get('netzbetreiber_plz_mapping', 'select=plz_prefix,netzbetreiber,portal_url&order=plz_prefix.desc');
    NB_CACHE = r || [];
  } catch(e) { NB_CACHE = []; }
}
function nb(plz) {
  if (!plz || plz.length < 3) return "";
  if (!NB_CACHE) return "";
  for (const len of [5, 4, 3]) {
    const prefix = plz.substring(0, len);
    const match = NB_CACHE.find(m => m.plz_prefix === prefix);
    if (match) return match.netzbetreiber;
  }
  return "";
}

// â”€â”€â”€ UNTERLAGEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UL_TEMPLATE = [
  { id: "lageplan",          name: "Lageplan / Ãœbersichtsplan" },
  { id: "einlinie",          name: "Einlinienschaltplan PV-Anlage" },
  { id: "wechselrichter",    name: "Datenblatt Wechselrichter" },
  { id: "module",            name: "Datenblatt PV-Module" },
  { id: "konformitaet",      name: "KonformitÃ¤tserklÃ¤rung / VDE" },
  { id: "vollmacht",         name: "Vollmacht Netzanmeldung" },
  { id: "eigentuemer",       name: "EigentÃ¼merzustimmung" },
  { id: "zaehlerfotos",      name: "Fotos ZÃ¤hlerkasten / ZÃ¤hlernummer" },
  { id: "mastr",             name: "MaStR-Registrierung bestÃ¤tigt" },
].map(u => ({ ...u, erhalten: false, datum: null }));

// â”€â”€â”€ DESIGN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const C = {
  bg: "#0C0D0F", surface: "#141618", card: "#1C1E21",
  border: "#2A2D31", text: "#F1F2F4", sec: "#9CA3AF", dim: "#6B7280",
  yellow: "#F9D71C", yellowBg: "rgba(249,215,28,0.07)",
  green: "#10B981", red: "#EF4444", mono: "'JetBrains Mono', monospace",
};

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = (d) => d ? new Date(d).toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" }) : "â€“";
const daysSince = (d) => d ? Math.floor((Date.now() - new Date(d)) / 86400000) : null;
const extractPLZ = (addr) => { const m = (addr||"").match(/(\d{5})/); return m ? m[1] : ""; };

// â”€â”€â”€ COMPONENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function StatusBadge({ status, lg }) {
  const s = STATUS[status] || STATUS.erfasst;
  return (
    <span style={{
      display: "inline-flex", alignItems: "center", gap: 5,
      padding: lg ? "7px 14px" : "3px 9px",
      borderRadius: 6, fontSize: lg ? 13 : 11, fontWeight: 600,
      background: s.bg, color: s.color, border: `1px solid ${s.color}25`,
      whiteSpace: "nowrap",
    }}>{s.icon} {s.label}</span>
  );
}

function Label({ children }) {
  return <div style={{ fontSize: 11, color: C.sec, fontWeight: 600, letterSpacing: 0.9, textTransform: "uppercase", marginBottom: 5 }}>{children}</div>;
}

function SectionHead({ icon, title }) {
  return (
    <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 14 }}>
      <span style={{ fontSize: 14 }}>{icon}</span>
      <span style={{ fontSize: 11, fontWeight: 700, color: C.sec, letterSpacing: 1, textTransform: "uppercase" }}>{title}</span>
    </div>
  );
}

function Card({ children, style = {}, onClick }) {
  const [h, setH] = useState(false);
  return (
    <div onClick={onClick} onMouseEnter={() => setH(true)} onMouseLeave={() => setH(false)}
      className="fade-in"
      style={{
        background: C.card, border: `1px solid ${h && onClick ? "#3D4147" : C.border}`,
        borderRadius: 12, padding: 20, transition: "all 0.15s",
        cursor: onClick ? "pointer" : "default",
        transform: h && onClick ? "translateY(-1px)" : "none",
        ...style
      }}>
      {children}
    </div>
  );
}

function Btn({ children, primary, danger, full, disabled, onClick, small }) {
  const [h, setH] = useState(false);
  const base = {
    padding: small ? "7px 14px" : "10px 20px", borderRadius: 8,
    fontSize: small ? 12 : 13, fontWeight: 700, border: "none",
    width: full ? "100%" : "auto", opacity: disabled ? 0.5 : 1,
    display: "inline-flex", alignItems: "center", justifyContent: "center", gap: 6,
  };
  const styles = primary
    ? { ...base, background: h ? "#ffe733" : C.yellow, color: "#0C0D0F" }
    : danger
    ? { ...base, background: h ? "#450a0a" : "transparent", color: C.red, border: `1px solid ${C.red}35` }
    : { ...base, background: h ? "#23262B" : C.card, color: C.sec, border: `1px solid ${C.border}` };
  return (
    <button style={styles} disabled={disabled} onClick={onClick}
      onMouseEnter={() => setH(true)} onMouseLeave={() => setH(false)}>
      {children}
    </button>
  );
}

function Checklist({ items, onChange }) {
  const done = items.filter(i => i.erhalten).length;
  const pct = items.length ? (done / items.length) * 100 : 0;
  const toggle = (id) => {
    onChange(items.map(i => i.id === id
      ? { ...i, erhalten: !i.erhalten, datum: !i.erhalten ? new Date().toISOString().split("T")[0] : null }
      : i
    ));
  };
  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 10, alignItems: "center" }}>
        <span style={{ fontSize: 12, color: C.sec }}>{done}/{items.length} Unterlagen</span>
        <div style={{ height: 5, width: 100, background: C.border, borderRadius: 3 }}>
          <div style={{ height: "100%", width: `${pct}%`, background: pct === 100 ? C.green : C.yellow, borderRadius: 3, transition: "width 0.3s" }} />
        </div>
      </div>
      <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
        {items.map(item => (
          <div key={item.id} onClick={() => toggle(item.id)} style={{
            display: "flex", alignItems: "center", gap: 10, padding: "9px 12px",
            borderRadius: 8, cursor: "pointer",
            background: item.erhalten ? "rgba(16,185,129,0.06)" : "transparent",
            border: `1px solid ${item.erhalten ? C.green + "30" : C.border}`,
          }}>
            <div style={{
              width: 18, height: 18, borderRadius: 4, flexShrink: 0,
              border: `2px solid ${item.erhalten ? C.green : C.border}`,
              background: item.erhalten ? C.green : "transparent",
              display: "flex", alignItems: "center", justifyContent: "center",
            }}>
              {item.erhalten && <span style={{ color: "#000", fontSize: 10, fontWeight: 900 }}>âœ“</span>}
            </div>
            <span style={{ flex: 1, fontSize: 13, color: item.erhalten ? C.text : C.sec }}>{item.name}</span>
            {item.erhalten && item.datum && <span style={{ fontSize: 11, color: C.dim, fontFamily: C.mono }}>{item.datum}</span>}
          </div>
        ))}
      </div>
    </div>
  );
}

function Timeline({ history = [], current }) {
  const entries = history.length > 0 ? history : [{ status: current, datum: new Date().toISOString(), notiz: "Erstellt" }];
  return (
    <div style={{ display: "flex", flexDirection: "column" }}>
      {entries.map((e, i) => {
        const s = STATUS[e.status] || STATUS.erfasst;
        const isLast = i === entries.length - 1;
        return (
          <div key={i} style={{ display: "flex", gap: 12, position: "relative" }}>
            <div style={{ display: "flex", flexDirection: "column", alignItems: "center", width: 28 }}>
              <div style={{
                width: 26, height: 26, borderRadius: "50%", flexShrink: 0,
                background: s.bg, border: `2px solid ${s.color}`,
                display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12,
              }}>{s.icon}</div>
              {!isLast && <div style={{ width: 2, flex: 1, background: C.border, margin: "2px 0", minHeight: 16 }} />}
            </div>
            <div style={{ paddingBottom: isLast ? 0 : 14, paddingTop: 3 }}>
              <div style={{ fontSize: 13, fontWeight: 600, color: s.color }}>{s.label}</div>
              <div style={{ fontSize: 11, color: C.dim, marginTop: 2, fontFamily: C.mono }}>
                {e.datum ? new Date(e.datum).toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "2-digit", hour: "2-digit", minute: "2-digit" }) : "â€“"}
                {e.notiz && ` Â· ${e.notiz}`}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}

// â”€â”€â”€ PIPELINE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PipelineView({ list, onSelect, onNew }) {
  const grouped = Object.keys(STATUS).reduce((acc, s) => { acc[s] = list.filter(a => a.status === s); return acc; }, {});
  const active = list.filter(a => !["inbetrieb","abgelehnt"].includes(a.status)).length;
  const done = grouped.inbetrieb?.length || 0;

  return (
    <div>
      {/* KPIs */}
      <div style={{ display: "flex", gap: 12, marginBottom: 24, flexWrap: "wrap" }}>
        {[
          { v: list.length, l: "Gesamt", c: C.sec },
          { v: active, l: "In Bearbeitung", c: C.yellow },
          { v: grouped.in_pruefung?.length || 0, l: "Beim Netzbetreiber", c: "#A78BFA" },
          { v: done, l: "In Betrieb", c: C.green },
        ].map(k => (
          <div key={k.l} style={{ flex: "1 1 130px", background: C.card, border: `1px solid ${C.border}`, borderRadius: 10, padding: "14px 18px" }}>
            <div style={{ fontSize: 24, fontWeight: 700, color: k.c, fontFamily: C.mono }}>{k.v}</div>
            <div style={{ fontSize: 11, color: C.dim, marginTop: 2 }}>{k.l}</div>
          </div>
        ))}
      </div>

      {/* Status Bar */}
      <div style={{ display: "flex", gap: 4, marginBottom: 20, overflowX: "auto", paddingBottom: 4, alignItems: "center" }}>
        {FLOW.map((s, i) => {
          const info = STATUS[s]; const cnt = grouped[s]?.length || 0;
          return (
            <React.Fragment key={s}>
              <div style={{
                padding: "5px 12px", borderRadius: 20, fontSize: 11, fontWeight: 600, whiteSpace: "nowrap",
                background: cnt > 0 ? info.bg : C.surface,
                color: cnt > 0 ? info.color : C.dim,
                border: `1px solid ${cnt > 0 ? info.color + "40" : C.border}`,
              }}>
                {info.icon} {info.label}{cnt > 0 && <span style={{ marginLeft: 6, background: info.color + "25", padding: "0 5px", borderRadius: 8 }}>{cnt}</span>}
              </div>
              {i < FLOW.length - 1 && <span style={{ color: C.border, fontSize: 16, flexShrink: 0 }}>â€º</span>}
            </React.Fragment>
          );
        })}
      </div>

      {/* Table */}
      {list.length === 0 ? (
        <div style={{ textAlign: "center", padding: "70px 0", color: C.dim }}>
          <div style={{ fontSize: 44, marginBottom: 14 }}>âš¡</div>
          <div style={{ fontSize: 16, marginBottom: 6, color: C.sec }}>Noch keine Netzanmeldungen</div>
          <div style={{ fontSize: 13, marginBottom: 20 }}>Alle AuftrÃ¤ge nach Montage hier eintragen</div>
          <Btn primary onClick={onNew}>+ Erste Anmeldung erstellen</Btn>
        </div>
      ) : (
        <div style={{ border: `1px solid ${C.border}`, borderRadius: 12, overflow: "hidden" }}>
          <table>
            <thead>
              <tr style={{ background: C.surface }}>
                {["Auftrag","Kunde / Adresse","Netzbetreiber","kWp","Anmeldung","Genehmigung","Status",""].map(h => (
                  <th key={h} style={{
                    padding: "10px 16px", textAlign: "left", fontSize: 10,
                    color: C.dim, fontWeight: 700, letterSpacing: 0.8, textTransform: "uppercase",
                    borderBottom: `1px solid ${C.border}`,
                  }}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {list.map((a, i) => (
                <tr key={a.id} onClick={() => onSelect(a)} className="fade-in"
                  style={{ cursor: "pointer", borderBottom: i < list.length - 1 ? `1px solid ${C.border}` : "none" }}
                  onMouseEnter={e => e.currentTarget.style.background = C.surface}
                  onMouseLeave={e => e.currentTarget.style.background = "transparent"}
                >
                  <td style={{ padding: "12px 16px", fontSize: 13, color: C.yellow, fontWeight: 700, fontFamily: C.mono }}>{a.auftrag_nr||"â€“"}</td>
                  <td style={{ padding: "12px 16px" }}>
                    <div style={{ fontSize: 13, color: C.text, fontWeight: 500 }}>{a.kunde_name}</div>
                    <div style={{ fontSize: 11, color: C.dim, marginTop: 2 }}>{a.plz} {a.ort}</div>
                  </td>
                  <td style={{ padding: "12px 16px", fontSize: 12, color: C.sec }}>{a.netzbetreiber||<span style={{color:C.dim}}>â€“</span>}</td>
                  <td style={{ padding: "12px 16px", fontSize: 13, color: C.text, fontFamily: C.mono }}>{a.kwp ? `${a.kwp}` : "â€“"}</td>
                  <td style={{ padding: "12px 16px", fontSize: 12, color: C.sec, fontFamily: C.mono }}>{fmt(a.anmeldung_datum)}</td>
                  <td style={{ padding: "12px 16px", fontSize: 12, fontFamily: C.mono }}>
                    {a.genehmigung_datum
                      ? <span style={{ color: C.green }}>{fmt(a.genehmigung_datum)}</span>
                      : <span style={{ color: C.dim }}>ausstehend</span>}
                  </td>
                  <td style={{ padding: "12px 16px" }}><StatusBadge status={a.status} /></td>
                  <td style={{ padding: "12px 16px", color: C.dim, textAlign: "right" }}>â€º</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ NEW FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function NewForm({ auftraege, onSave, onCancel }) {
  const [step, setStep] = useState(1);
  const [search, setSearch] = useState("");
  const [auftrag, setAuftrag] = useState(null);
  const [saving, setSaving] = useState(false);
  const [form, setForm] = useState({
    zaehler_nr: "", netzbetreiber: "", malo_id: "", mastr_nr: "",
    anmeldung_datum: new Date().toISOString().split("T")[0],
    verantwortlich: "", notizen: "",
    unterlagen: UL_TEMPLATE.map(u => ({...u})),
  });
  const u = (k, v) => setForm(f => ({...f, [k]: v}));

  const filtered = search
    ? auftraege.filter(a => a.kunde_name?.toLowerCase().includes(search.toLowerCase()) || a.auftrag_nr?.includes(search))
    : auftraege.slice(0, 20);

  const selectAuftrag = (a) => {
    setAuftrag(a);
    const plz = extractPLZ(a.kunde_adresse);
    u("netzbetreiber", nb(plz));
    setStep(2);
  };

  const save = async () => {
    if (!auftrag) return;
    setSaving(true);
    const plz = extractPLZ(auftrag.kunde_adresse);
    const addrParts = (auftrag.kunde_adresse || "").split(/\d{5}/);
    const ort = addrParts[1]?.trim() || "";
    const payload = {
      auftrag_id: auftrag.id, auftrag_nr: auftrag.auftrag_nr,
      kunde_name: auftrag.kunde_name, kunde_adresse: auftrag.kunde_adresse,
      plz, ort, kwp: auftrag.kwp,
      status: "erfasst",
      status_history: [{ status: "erfasst", datum: new Date().toISOString(), notiz: "Anmeldung angelegt" }],
      ...form,
      unterlagen_vollstaendig: form.unterlagen.every(u => u.erhalten),
    };
    const res = await db.post("netzanmeldungen", payload);
    setSaving(false);
    if (Array.isArray(res) && res[0]) onSave(res[0]);
    else alert("Fehler beim Speichern. Tabellen-Migration ausgefÃ¼hrt?");
  };

  return (
    <div className="fade-in">
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 24 }}>
        <Btn onClick={onCancel}>â† ZurÃ¼ck</Btn>
        <h2 style={{ fontSize: 20, fontWeight: 700 }}>Neue Netzanmeldung</h2>
      </div>

      {/* Steps */}
      <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 24 }}>
        {[{n:1,l:"Auftrag wÃ¤hlen"},{n:2,l:"Details erfassen"}].map((s,i) => (
          <React.Fragment key={s.n}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <div style={{
                width: 26, height: 26, borderRadius: "50%",
                background: step >= s.n ? C.yellow : C.surface,
                color: step >= s.n ? "#000" : C.dim,
                display: "flex", alignItems: "center", justifyContent: "center",
                fontSize: 12, fontWeight: 700, border: `2px solid ${step >= s.n ? C.yellow : C.border}`,
              }}>{s.n}</div>
              <span style={{ fontSize: 13, color: step >= s.n ? C.text : C.dim }}>{s.l}</span>
            </div>
            {i < 1 && <span style={{ color: C.border, margin: "0 4px" }}>â€º</span>}
          </React.Fragment>
        ))}
      </div>

      {step === 1 && (
        <Card>
          <Label>Auftrag suchen</Label>
          <input autoFocus placeholder="Name oder Auftragsnummer..." value={search}
            onChange={e => setSearch(e.target.value)} style={{ marginBottom: 14, fontSize: 15 }} />
          <div style={{ display: "flex", flexDirection: "column", gap: 6, maxHeight: 400, overflowY: "auto" }}>
            {filtered.map(a => (
              <div key={a.id} onClick={() => selectAuftrag(a)}
                style={{ padding: "12px 16px", borderRadius: 10, cursor: "pointer", border: `1px solid ${C.border}`, background: C.surface, display: "flex", justifyContent: "space-between" }}
                onMouseEnter={e => { e.currentTarget.style.borderColor = C.yellow; e.currentTarget.style.background = C.yellowBg; }}
                onMouseLeave={e => { e.currentTarget.style.borderColor = C.border; e.currentTarget.style.background = C.surface; }}
              >
                <div>
                  <div style={{ fontSize: 13, fontWeight: 700, color: C.yellow, fontFamily: C.mono }}>{a.auftrag_nr}</div>
                  <div style={{ fontSize: 14, color: C.text, marginTop: 2 }}>{a.kunde_name}</div>
                  <div style={{ fontSize: 12, color: C.sec, marginTop: 1 }}>{a.kunde_adresse}</div>
                </div>
                <div style={{ fontSize: 13, color: C.sec, fontFamily: C.mono, alignSelf: "center" }}>{a.kwp} kWp</div>
              </div>
            ))}
            {filtered.length === 0 && <div style={{ textAlign: "center", padding: 30, color: C.dim }}>Keine AuftrÃ¤ge gefunden</div>}
          </div>
        </Card>
      )}

      {step === 2 && auftrag && (
        <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          {/* Auftrag Info */}
          <Card style={{ background: C.yellowBg, borderColor: C.yellow + "35" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <div style={{ fontSize: 10, color: C.yellow, fontWeight: 700, letterSpacing: 1 }}>AUSGEWÃ„HLTER AUFTRAG</div>
                <div style={{ fontSize: 16, fontWeight: 700, color: C.text, marginTop: 4 }}>{auftrag.kunde_name}</div>
                <div style={{ fontSize: 13, color: C.sec }}>{auftrag.kunde_adresse} Â· {auftrag.kwp} kWp</div>
              </div>
              <div style={{ fontSize: 22, fontWeight: 700, color: C.yellow, fontFamily: C.mono }}>{auftrag.auftrag_nr}</div>
            </div>
          </Card>

          {/* Netztechnik */}
          <Card>
            <SectionHead icon="âš¡" title="Netztechnische Daten" />
            <div style={{ display: "flex", flexWrap: "wrap", gap: 12 }}>
              {[
                { l: "Netzbetreiber", k: "netzbetreiber", p: "z.B. Stadtwerke Bielefeld Netz", full: true },
                { l: "ZÃ¤hlernummer", k: "zaehler_nr", p: "z.B. 1ESL12345678" },
                { l: "MaLo-ID (11-stellig)", k: "malo_id", p: "52836..." },
                { l: "MaStR-Nummer", k: "mastr_nr", p: "SEE900000..." },
                { l: "Anmeldedatum", k: "anmeldung_datum", t: "date" },
                { l: "Verantwortlich", k: "verantwortlich", p: "Sachbearbeiter/in" },
              ].map(f => (
                <div key={f.k} style={{ flex: f.full ? "1 1 100%" : "1 1 calc(50% - 6px)", minWidth: 160 }}>
                  <Label>{f.l}</Label>
                  <input type={f.t || "text"} value={form[f.k] || ""} placeholder={f.p}
                    onChange={e => u(f.k, e.target.value)} />
                  {f.k === "netzbetreiber" && form.netzbetreiber && nb(extractPLZ(auftrag.kunde_adresse)) === form.netzbetreiber &&
                    <div style={{ fontSize: 11, color: C.green, marginTop: 4 }}>âœ“ Automatisch per PLZ erkannt</div>}
                </div>
              ))}
            </div>
          </Card>

          {/* Unterlagen */}
          <Card>
            <SectionHead icon="ğŸ“„" title="Unterlagen-Checkliste" />
            <Checklist items={form.unterlagen} onChange={v => u("unterlagen", v)} />
          </Card>

          {/* Notizen */}
          <Card>
            <SectionHead icon="ğŸ’¬" title="Notizen" />
            <textarea value={form.notizen} onChange={e => u("notizen", e.target.value)}
              placeholder="Besonderheiten, Ansprechpartner beim Netzbetreiber..." rows={3} />
          </Card>

          <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
            <Btn onClick={() => setStep(1)}>â† ZurÃ¼ck</Btn>
            <Btn primary disabled={saving} onClick={save}>
              {saving ? "â³ Speichern..." : "âœ“ Netzanmeldung erstellen"}
            </Btn>
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ DETAIL VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DetailView({ a: initial, onBack, onUpdate }) {
  const [a, setA] = useState(initial);
  const [editing, setEditing] = useState(false);
  const [ef, setEF] = useState({});
  const [saving, setSaving] = useState(false);
  const [note, setNote] = useState("");
  const [showNext, setShowNext] = useState(false);
  const e = (k, v) => setEF(f => ({...f, [k]: v}));

  const curIdx = FLOW.indexOf(a.status);
  const nextS = FLOW[curIdx + 1];
  const s = STATUS[a.status] || STATUS.erfasst;

  const pushStatus = async (newS) => {
    setSaving(true);
    const hist = [...(a.status_history || []), { status: newS, datum: new Date().toISOString(), notiz: note || STATUS[newS].label }];
    const patch = {
      status: newS, status_history: hist,
      ...(newS === "genehmigt" && !a.genehmigung_datum ? { genehmigung_datum: new Date().toISOString().split("T")[0] } : {}),
      ...(newS === "inbetrieb" && !a.inbetriebnahme_datum ? { inbetriebnahme_datum: new Date().toISOString().split("T")[0] } : {}),
    };
    await db.patch("netzanmeldungen", a.id, patch);
    const upd = { ...a, ...patch };
    setA(upd); onUpdate(upd); setNote(""); setShowNext(false); setSaving(false);
  };

  const saveEdits = async () => {
    setSaving(true);
    const patch = { ...ef, unterlagen_vollstaendig: ef.unterlagen?.every(u => u.erhalten) || false };
    await db.patch("netzanmeldungen", a.id, patch);
    const upd = { ...a, ...patch };
    setA(upd); onUpdate(upd); setEditing(false); setSaving(false);
  };

  const startEdit = () => {
    setEF({
      zaehler_nr: a.zaehler_nr || "", netzbetreiber: a.netzbetreiber || "",
      malo_id: a.malo_id || "", mastr_nr: a.mastr_nr || "",
      anmeldung_datum: a.anmeldung_datum || "", genehmigung_datum: a.genehmigung_datum || "",
      inbetriebnahme_datum: a.inbetriebnahme_datum || "",
      einspeisevergÃ¼tung_beantragt: a.einspeisevergÃ¼tung_beantragt || false,
      einspeisevergÃ¼tung_datum: a.einspeisevergÃ¼tung_datum || "",
      verantwortlich: a.verantwortlich || "", notizen: a.notizen || "",
      unterlagen: a.unterlagen?.length > 0 ? a.unterlagen : UL_TEMPLATE.map(u => ({...u})),
    });
    setEditing(true);
  };

  const updateChecklist = async (updated) => {
    const patch = { unterlagen: updated, unterlagen_vollstaendig: updated.every(u => u.erhalten) };
    await db.patch("netzanmeldungen", a.id, patch);
    const upd = { ...a, ...patch };
    setA(upd); onUpdate(upd);
  };

  return (
    <div className="fade-in">
      {/* Header */}
      <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between", marginBottom: 24, flexWrap: "wrap", gap: 12 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <Btn onClick={onBack}>â† ZurÃ¼ck</Btn>
          <div>
            <div style={{ fontSize: 12, color: C.yellow, fontFamily: C.mono, marginBottom: 2 }}>{a.auftrag_nr}</div>
            <h2 style={{ fontSize: 22, fontWeight: 700 }}>{a.kunde_name}</h2>
            <div style={{ fontSize: 13, color: C.sec, marginTop: 2 }}>{a.kunde_adresse}</div>
          </div>
        </div>
        <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
          <StatusBadge status={a.status} lg />
          {!editing && <Btn onClick={startEdit}>âœï¸ Bearbeiten</Btn>}
        </div>
      </div>

      <div style={{ display: "flex", gap: 16, flexWrap: "wrap", alignItems: "flex-start" }}>
        {/* LEFT */}
        <div style={{ flex: "1 1 380px", display: "flex", flexDirection: "column", gap: 16 }}>

          {/* Kerndaten */}
          <Card>
            <SectionHead icon="ğŸ“Š" title="Kerndaten" />
            {editing ? (
              <div style={{ display: "flex", flexWrap: "wrap", gap: 12 }}>
                {[
                  { l: "Netzbetreiber", k: "netzbetreiber", full: true },
                  { l: "ZÃ¤hlernummer", k: "zaehler_nr" }, { l: "MaLo-ID", k: "malo_id" },
                  { l: "MaStR-Nummer", k: "mastr_nr" }, { l: "Verantwortlich", k: "verantwortlich" },
                  { l: "Anmeldedatum", k: "anmeldung_datum", t: "date" },
                  { l: "Genehmigung", k: "genehmigung_datum", t: "date" },
                  { l: "Inbetriebnahme", k: "inbetriebnahme_datum", t: "date" },
                ].map(f => (
                  <div key={f.k} style={{ flex: f.full ? "1 1 100%" : "1 1 calc(50% - 6px)", minWidth: 140 }}>
                    <Label>{f.l}</Label>
                    <input type={f.t || "text"} value={ef[f.k] || ""} onChange={ev => e(f.k, ev.target.value)} />
                  </div>
                ))}
                <div style={{ flex: "1 1 100%", display: "flex", alignItems: "center", gap: 10 }}>
                  <input type="checkbox" id="eev" checked={ef.einspeisevergÃ¼tung_beantragt||false}
                    onChange={ev => e("einspeisevergÃ¼tung_beantragt", ev.target.checked)} style={{ width: 16, height: 16 }} />
                  <label htmlFor="eev" style={{ fontSize: 13, cursor: "pointer" }}>EinspeisevergÃ¼tung beantragt</label>
                  {ef.einspeisevergÃ¼tung_beantragt && (
                    <input type="date" value={ef.einspeisevergÃ¼tung_datum||""} onChange={ev => e("einspeisevergÃ¼tung_datum", ev.target.value)}
                      style={{ width: 160, flex: "none" }} />
                  )}
                </div>
              </div>
            ) : (
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px 20px" }}>
                {[
                  { l: "kWp", v: a.kwp ? `${a.kwp} kWp` : "â€“", mono: true },
                  { l: "Netzbetreiber", v: a.netzbetreiber },
                  { l: "ZÃ¤hlernummer", v: a.zaehler_nr, mono: true },
                  { l: "MaLo-ID", v: a.malo_id, mono: true },
                  { l: "MaStR-Nummer", v: a.mastr_nr, mono: true },
                  { l: "Verantwortlich", v: a.verantwortlich },
                ].map(r => (
                  <div key={r.l}>
                    <div style={{ fontSize: 11, color: C.dim, marginBottom: 2 }}>{r.l}</div>
                    <div style={{ fontSize: 13, color: r.v ? C.text : C.dim, fontFamily: r.mono && r.v ? C.mono : "inherit" }}>{r.v || "â€“"}</div>
                  </div>
                ))}
              </div>
            )}
          </Card>

          {/* Zeitplan */}
          <Card>
            <SectionHead icon="ğŸ“…" title="Zeitplan" />
            <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
              {[
                { l: "Anmeldung eingereicht", d: a.anmeldung_datum, c: C.sec },
                { l: "Genehmigung erhalten", d: a.genehmigung_datum, c: C.green },
                { l: "Inbetriebnahme", d: a.inbetriebnahme_datum, c: C.yellow },
                ...(a.einspeisevergÃ¼tung_beantragt ? [{ l: "EinspeisevergÃ¼tung", d: a.einspeisevergÃ¼tung_datum, c: "#A78BFA" }] : []),
              ].map(r => (
                <div key={r.l} style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <span style={{ fontSize: 13, color: C.sec }}>{r.l}</span>
                  <div style={{ textAlign: "right" }}>
                    <span style={{ fontSize: 13, fontFamily: C.mono, color: r.d ? r.c : C.dim }}>
                      {r.d ? fmt(r.d) : "ausstehend"}
                    </span>
                    {r.d && daysSince(r.d) !== null && (
                      <span style={{ fontSize: 11, color: C.dim, marginLeft: 6 }}>({daysSince(r.d)}d)</span>
                    )}
                  </div>
                </div>
              ))}
              {a.anmeldung_datum && !a.genehmigung_datum && (
                <div style={{ marginTop: 4, padding: "8px 12px", borderRadius: 8, background: STATUS.in_pruefung.bg, border: `1px solid ${STATUS.in_pruefung.color}30` }}>
                  <span style={{ fontSize: 12, color: STATUS.in_pruefung.color }}>
                    â± Wartet seit {daysSince(a.anmeldung_datum)} Tagen auf Genehmigung
                  </span>
                </div>
              )}
            </div>
          </Card>

          {/* Notizen */}
          <Card>
            <SectionHead icon="ğŸ’¬" title="Notizen" />
            {editing
              ? <textarea value={ef.notizen||""} onChange={ev => e("notizen", ev.target.value)} rows={4} />
              : <p style={{ fontSize: 13, color: a.notizen ? C.text : C.dim, lineHeight: 1.7, whiteSpace: "pre-wrap" }}>{a.notizen || "Keine Notizen"}</p>
            }
          </Card>

          {editing && (
            <div style={{ display: "flex", gap: 10 }}>
              <Btn onClick={() => setEditing(false)}>Abbrechen</Btn>
              <Btn primary full disabled={saving} onClick={saveEdits}>
                {saving ? "â³ Speichern..." : "âœ“ Ã„nderungen speichern"}
              </Btn>
            </div>
          )}
        </div>

        {/* RIGHT */}
        <div style={{ flex: "1 1 300px", display: "flex", flexDirection: "column", gap: 16 }}>

          {/* Status-Action */}
          <Card>
            <SectionHead icon="ğŸ”„" title="Status Ã¤ndern" />
            {nextS && a.status !== "abgelehnt" && (
              <div>
                <button onClick={() => setShowNext(!showNext)} style={{
                  width: "100%", padding: "12px 16px", borderRadius: 10,
                  background: STATUS[nextS].bg, color: STATUS[nextS].color,
                  border: `1.5px solid ${STATUS[nextS].color}45`,
                  fontSize: 14, fontWeight: 700, cursor: "pointer",
                  display: "flex", alignItems: "center", justifyContent: "space-between",
                }}>
                  <span>{STATUS[nextS].icon} Weiter: {STATUS[nextS].label}</span>
                  <span style={{ fontSize: 18 }}>{showNext ? "âˆ§" : "â€º"}</span>
                </button>
                {showNext && (
                  <div style={{ marginTop: 10 }}>
                    <Label>Notiz (optional)</Label>
                    <input value={note} onChange={e => setNote(e.target.value)}
                      placeholder="z.B. Unterlagen vollstÃ¤ndig, eingereicht per Portal..."
                      style={{ marginBottom: 10 }} />
                    <div style={{ display: "flex", gap: 8 }}>
                      <Btn onClick={() => setShowNext(false)}>Abbrechen</Btn>
                      <Btn primary full disabled={saving} onClick={() => pushStatus(nextS)}>
                        {saving ? "..." : `âœ“ Auf â€${STATUS[nextS].label}" setzen`}
                      </Btn>
                    </div>
                  </div>
                )}
              </div>
            )}
            {a.status === "inbetrieb" && (
              <div style={{ textAlign: "center", padding: 20 }}>
                <div style={{ fontSize: 40 }}>âš¡</div>
                <div style={{ color: C.yellow, fontWeight: 700, marginTop: 8 }}>Anlage in Betrieb!</div>
              </div>
            )}
            {a.status !== "inbetrieb" && a.status !== "abgelehnt" && (
              <Btn danger full onClick={() => pushStatus("abgelehnt")} style={{ marginTop: 10 }}>
                âœ— Als abgelehnt markieren
              </Btn>
            )}
            {a.status === "abgelehnt" && (
              <Btn full onClick={() => pushStatus("erfasst")} style={{ marginTop: 0 }}>
                â†º Neu einreichen
              </Btn>
            )}
          </Card>

          {/* Timeline */}
          <Card>
            <SectionHead icon="ğŸ“œ" title="Verlauf" />
            <Timeline history={a.status_history || []} current={a.status} />
          </Card>

          {/* Unterlagen */}
          <Card>
            <SectionHead icon="ğŸ“„" title="Unterlagen" />
            <Checklist
              items={editing ? ef.unterlagen || [] : (a.unterlagen?.length > 0 ? a.unterlagen : UL_TEMPLATE.map(u=>({...u})))}
              onChange={editing ? (v => e("unterlagen", v)) : updateChecklist}
            />
          </Card>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ ROOT APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [list, setList] = useState([]);
  const [auftraege, setAuftraege] = useState([]);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState("list"); // list | new | detail
  const [selected, setSelected] = useState(null);
  const [filterStatus, setFilterStatus] = useState("all");
  const [error, setError] = useState(null);
  const [migrating, setMigrating] = useState(false);
  const [migrateResult, setMigrateResult] = useState(null);

  const runMigration = async () => {
    setMigrating(true);
    try {
      const r = await fetch("/api/migrate", {
        headers: { "x-migrate-token": "EtQkiOCgyug_ZY8aeY01" }
      });
      const data = await r.json();
      if (data.success || (data.results && data.results.some(x => x.ok))) {
        setMigrateResult({ success: true, message: "âœ“ Tabelle erstellt! Seite neu laden..." });
        setTimeout(() => window.location.reload(), 2000);
      } else {
        setMigrateResult({ success: false, message: "Fehler: " + JSON.stringify(data).slice(0, 200) });
      }
    } catch(e) {
      setMigrateResult({ success: false, message: "Netzwerkfehler: " + e.message });
    }
    setMigrating(false);
  };

  const load = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const [nm, at] = await Promise.all([
        db.get("netzanmeldungen", "?order=erstellt_am.desc"),
        loadNbMapping(),
        db.get("pay_auftraege", "?select=id,auftrag_nr,kunde_name,kunde_adresse,kwp&order=auftrag_nr.asc"),
      ]);
      if (nm?.code === "PGRST205" || nm?.message?.includes("netzanmeldungen")) {
        setError("âš ï¸ Tabelle 'netzanmeldungen' fehlt. Bitte die SQL-Migration im Supabase SQL Editor ausfÃ¼hren.");
        setList([]); setAuftraege(Array.isArray(at) ? at : []);
      } else {
        setList(Array.isArray(nm) ? nm : []);
        setAuftraege(Array.isArray(at) ? at : []);
      }
    } catch(err) { setError("Verbindungsfehler: " + err.message); }
    setLoading(false);
  }, []);

  useEffect(() => { load(); }, [load]);

  const displayed = filterStatus === "all" ? list : list.filter(a => a.status === filterStatus);

  return (
    <div style={{ minHeight: "100vh", background: C.bg }}>
      {/* NAVBAR */}
      <div style={{ borderBottom: `1px solid ${C.border}`, background: C.surface, position: "sticky", top: 0, zIndex: 100 }}>
        <div style={{ maxWidth: 1300, margin: "0 auto", padding: "0 24px", display: "flex", alignItems: "center", justifyContent: "space-between", height: 54 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 14 }}>
            <span style={{ fontSize: 18, fontWeight: 900, color: C.yellow, fontFamily: C.mono }}>bee-doo.</span>
            <div style={{ width: 1, height: 18, background: C.border }} />
            <span style={{ fontSize: 14, fontWeight: 600, color: C.sec }}>Netzanmeldung</span>
            {!loading && list.length > 0 && (
              <span style={{ fontSize: 11, background: C.card, border: `1px solid ${C.border}`, borderRadius: 10, padding: "2px 8px", color: C.sec, fontFamily: C.mono }}>
                {list.length}
              </span>
            )}
          </div>
          <div style={{ display: "flex", gap: 8 }}>
            {view !== "list" && <Btn small onClick={() => setView("list")}>â† Ãœbersicht</Btn>}
            <Btn small onClick={load}>â†»</Btn>
            {view === "list" && <Btn primary small onClick={() => setView("new")}>+ Neue Anmeldung</Btn>}
          </div>
        </div>
      </div>

      {/* CONTENT */}
      <div style={{ maxWidth: 1300, margin: "0 auto", padding: "24px 24px 80px" }}>

        {error && (
          <div style={{ background: "#450a0a", border: `1px solid ${C.red}35`, borderRadius: 10, padding: "16px 20px", marginBottom: 20 }}>
            <div style={{ color: C.red, fontSize: 13, marginBottom: 12 }}>{error}</div>
            <button onClick={runMigration} disabled={migrating} style={{
              padding: "10px 20px", background: migrating ? C.surface : C.yellow, color: migrating ? C.sec : "#000",
              border: "none", borderRadius: 8, fontSize: 13, fontWeight: 700, cursor: migrating ? "default" : "pointer"
            }}>
              {migrating ? "â³ Migration lÃ¤uft..." : "âš¡ Tabelle jetzt erstellen (einmalig)"}
            </button>
            {migrateResult && <div style={{ marginTop: 10, fontSize: 12, color: migrateResult.success ? C.green : C.red }}>{migrateResult.message}</div>}
          </div>
        )}

        {loading ? (
          <div style={{ textAlign: "center", padding: "100px 0", color: C.dim }}>
            <div style={{ fontSize: 40, marginBottom: 14 }}>âš¡</div>
            <div style={{ fontFamily: C.mono }}>Lade Daten...</div>
          </div>
        ) : view === "new" ? (
          <NewForm auftraege={auftraege}
            onSave={(nm) => { setList(prev => [nm, ...prev]); setSelected(nm); setView("detail"); }}
            onCancel={() => setView("list")} />
        ) : view === "detail" && selected ? (
          <DetailView a={selected} onBack={() => setView("list")}
            onUpdate={(upd) => { setList(prev => prev.map(a => a.id === upd.id ? upd : a)); setSelected(upd); }} />
        ) : (
          <div>
            {/* Filter pills */}
            {list.length > 0 && (
              <div style={{ display: "flex", gap: 6, marginBottom: 20, flexWrap: "wrap" }}>
                <button onClick={() => setFilterStatus("all")} style={{
                  padding: "5px 14px", borderRadius: 20, fontSize: 12, fontWeight: 600,
                  border: `1px solid ${filterStatus === "all" ? C.yellow : C.border}`,
                  background: filterStatus === "all" ? C.yellowBg : C.surface,
                  color: filterStatus === "all" ? C.yellow : C.sec,
                }}>Alle ({list.length})</button>
                {Object.entries(STATUS).map(([k, info]) => {
                  const cnt = list.filter(a => a.status === k).length;
                  if (!cnt) return null;
                  return (
                    <button key={k} onClick={() => setFilterStatus(k)} style={{
                      padding: "5px 14px", borderRadius: 20, fontSize: 12, fontWeight: 600,
                      border: `1px solid ${filterStatus === k ? info.color : C.border}`,
                      background: filterStatus === k ? info.bg : C.surface,
                      color: filterStatus === k ? info.color : C.sec,
                    }}>{info.icon} {info.label} ({cnt})</button>
                  );
                })}
              </div>
            )}
            <PipelineView list={displayed} onSelect={a => { setSelected(a); setView("detail"); }} onNew={() => setView("new")} />
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

<!-- bee-doo KI-Modul -->
<script>
const BEEDOO_AI = {
  API_URL: 'https://api.anthropic.com/v1/messages',
  API_KEY: atob(['c2stYW50LWFwaTAzLTBy','UThlLUVLZGhhWVhrZEFT','Q0JXWjgwYW0wMHRZWmVn','S0h5dWh3Si1sQnVjMlFt','X1ZBR25LMWlRWThEaXNk','ZHBqUG5JSTVR','WXpDVXFOWG5zck12QUJ3','LU9WNjVwd0FB'].join('')),
  MODEL: 'claude-sonnet-4-5-20250514',
  
  async call(systemPrompt, userMessage, maxTokens = 1500) {
    try {
      const res = await fetch(this.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': this.API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: this.MODEL,
          max_tokens: maxTokens,
          system: systemPrompt,
          messages: [{ role: 'user', content: userMessage }]
        })
      });
      if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'API Fehler'); }
      const data = await res.json();
      return data.content?.[0]?.text || '';
    } catch(e) { console.error('[bee-doo KI]', e); throw e; }
  },
  
  async callWithImage(systemPrompt, userMessage, base64, mediaType = 'image/jpeg', maxTokens = 1500) {
    try {
      const res = await fetch(this.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': this.API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: this.MODEL,
          max_tokens: maxTokens,
          system: systemPrompt,
          messages: [{ role: 'user', content: [
            { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
            { type: 'text', text: userMessage }
          ] }]
        })
      });
      if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'API Fehler'); }
      const data = await res.json();
      return data.content?.[0]?.text || '';
    } catch(e) { console.error('[bee-doo KI]', e); throw e; }
  },
  
  parseJSON(text) {
    try { return JSON.parse(text.replace(/```json|```/g, '').trim()); } catch(e) { return null; }
  }
};
</script>

<script>
window.BEEDOO_KI_NETZ = {
  async autoFill(customerData) {
    const sys = `Du bist Experte fÃ¼r Netzanmeldungen bei Energieversorgern in Deutschland. FÃ¼lle Formulare korrekt aus basierend auf Kundendaten.
Antworte als JSON mit den korrekten Formularfeldern: {"fields":[{"label":"...","value":"...","confidence":"hoch/mittel/niedrig"}],"netzbetreiber":"...","tips":["..."],"missing_data":["..."]}`;
    const result = await BEEDOO_AI.call(sys, `FÃ¼lle die Netzanmeldung aus mit diesen Daten:\n${JSON.stringify(customerData)}`);
    return BEEDOO_AI.parseJSON(result);
  },

  createButton() {
    const btn = document.createElement('button');
    btn.innerHTML = 'ğŸ¤– Auto-Fill';
    btn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;background:linear-gradient(135deg,#F5C500,#E07800);color:#000;border:none;padding:12px 20px;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;box-shadow:0 4px 20px rgba(245,197,0,.3);font-family:inherit;transition:all .2s';
    btn.onclick = async () => {
      btn.innerHTML = 'â³ FÃ¼lle aus...';
      try {
        const inputs = document.querySelectorAll('input, select, textarea');
        const data = {};
        inputs.forEach(i => { if(i.value && i.name) data[i.name] = i.value; });
        const result = await this.autoFill(data);
        if (result?.fields) {
          result.fields.forEach(f => {
            inputs.forEach(i => {
              if (i.placeholder?.includes(f.label) || i.name?.includes(f.label.toLowerCase())) i.value = f.value;
            });
          });
          alert('âœ… ' + result.fields.length + ' Felder ausgefÃ¼llt' + (result.missing_data?.length ? '\nâš ï¸ Fehlend: ' + result.missing_data.join(', ') : ''));
        }
      } catch(e) { alert('Fehler: '+e.message); }
      btn.innerHTML = 'ğŸ¤– Auto-Fill';
    };
    document.body.appendChild(btn);
  }
};
document.addEventListener('DOMContentLoaded', () => setTimeout(() => BEEDOO_KI_NETZ.createButton(), 1000));
</script>

</body>
</html>
