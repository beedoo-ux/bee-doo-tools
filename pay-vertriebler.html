<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bee-doo | Vertriebler Abrechnung</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: #0a0a0f;
            color: #c8cfd8;
            min-height: 100vh;
        }
        #root { min-height: 100vh; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #12131a; }
        ::-webkit-scrollbar-thumb { background: #2a2d3a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #F5C500; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @media (max-width: 768px) {
            .grid-stats { grid-template-columns: 1fr 1fr !important; }
            .grid-vt { grid-template-columns: 1fr !important; }
            .header-row { flex-direction: column; gap: 12px; align-items: flex-start !important; }
            .filter-row { flex-direction: column; gap: 8px; }
            .detail-grid { grid-template-columns: 1fr !important; }
            .detail-header-row { flex-direction: column; gap: 12px; }
        }
        @media (max-width: 480px) {
            .grid-stats { grid-template-columns: 1fr !important; }
            .app-wrap { padding: 12px !important; }
            .month-tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const VT_TYPEN = {
    'Tayfun S√ºleymaniye':'HGB','Janik Vo√ü':'HGB','Martin Bott':'HGB',
    'Philipp-Torben Hannigk':'HGB','Pascal Schallenberg':'HGB','Lukas Kirschner':'HGB',
    'Hartmut Seitz':'HGB','Farshad Nourouzi':'HGB','Gino Ulitzka':'HGB',
    'Maxim Horten':'HGB','Patrick Kalinowski':'HGB','Nino Rimmler':'HGB',
    'Klaus Vollmer':'HGB','Sebastian Mansour':'HGB','Andreas Klee':'HGB',
    'Stefan Hensel':'HGB','Dimitri van Eeuwen':'HGB','Richard Winzent':'HGB',
    'Fabian Hindenberg':'HGB','Marco Bringmann':'HGB','Calogero Iannuzzo':'HGB',
    'Daniel Saweljew':'HGB','Frank Reddig':'HGB','Christian Seifert':'HGB',
    'Christoph Held':'HGB','Kevin Kraus':'HGB',
    'Miguel Schader':'Angestellt','Pascal Meier':'Angestellt','Nils Horn':'Angestellt',
    'Jannis Pfeiffer':'Angestellt','Kadir Danyildiz':'Angestellt',
    'Maximilian Koch':'Angestellt','Bernd Krahwinkel':'Angestellt',
};

const STAFFEL = {
    HGB: { basis:1400, ab8:1700, schwelle:8 },
    Angestellt: { basis:500, ab8:700, schwelle:8 },
};

const BONI = {
    Speichererweiterung: { HGB:200, Angestellt:100 },
    Eigenlead: { HGB:800, Angestellt:400 },
    Empfehlung: { HGB:500, Angestellt:300 },
};

function csvParse(text) {
    const lines = []; let cur = '', inQ = false;
    for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (c === '"') { inQ = !inQ; cur += c; }
        else if (c === '\n' && !inQ) { lines.push(cur); cur = ''; }
        else { cur += c; }
    }
    if (cur.trim()) lines.push(cur);
    function split(line) {
        const f = []; let s = '', q = false;
        for (let i = 0; i < line.length; i++) {
            const c = line[i];
            if (c === '"') q = !q;
            else if (c === ',' && !q) { f.push(s.trim()); s = ''; }
            else s += c;
        }
        f.push(s.trim()); return f;
    }
    const hdr = split(lines[0].replace(/^\uFEFF/, ''));
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const v = split(lines[i]), row = {};
        hdr.forEach((h, j) => { row[h] = v[j] || ''; });
        rows.push(row);
    }
    return rows;
}

function nettoNum(v) {
    if (!v) return 0;
    const n = parseFloat(v.replace(/\s/g,'').replace(/\./g,'').replace(',','.'));
    return isNaN(n) ? 0 : n / 100;
}

function monthKey(ds) {
    if (!ds) return null;
    const p = ds.trim().split('.');
    if (p.length === 3) return p[2] + '-' + p[1].padStart(2,'0');
    if (ds.includes('-')) { const x = ds.split('-'); return x[0] + '-' + x[1].padStart(2,'0'); }
    return null;
}

function monthLabel(k) {
    const [y,m] = k.split('-');
    const mn = ['','Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
    return mn[parseInt(m)] + ' ' + y;
}

function euro(n) {
    if (typeof n !== 'number' || isNaN(n)) return '0 ‚Ç¨';
    return n.toLocaleString('de-DE',{minimumFractionDigits:0,maximumFractionDigits:0}) + ' ‚Ç¨';
}

function calcProv(auftr, name, selectedMonth, allCsv, exclANs) {
    const typ = VT_TYPEN[name]; if (!typ) return null;
    const provRelevant = auftr.filter(a => 
        (a['Auszahlungsrelevant']||'').trim() === 'Ja' && 
        (a['Auftragsstatus']||'').trim() !== 'Storniert' &&
        !(a['Ausgezahlt am']||'').trim() &&
        !(exclANs && exclANs.has((a['AN Nr.']||'').trim()))
    );
    const storniert = auftr.filter(a => (a['Auftragsstatus']||'').trim() === 'Storniert');
    const bereitsAusgezahlt = auftr.filter(a => 
        (a['Auszahlungsrelevant']||'').trim() === 'Ja' && 
        (a['Auftragsstatus']||'').trim() !== 'Storniert' &&
        (a['Ausgezahlt am']||'').trim()
    );
    const nichtRelevant = auftr.filter(a => 
        (a['Auszahlungsrelevant']||'').trim() !== 'Ja' && 
        (a['Auftragsstatus']||'').trim() !== 'Storniert'
    );
    const st = STAFFEL[typ], cnt = provRelevant.length;
    
    // Sonderprovisionen
    let perA, staffGes;
    const isJan26Plus = selectedMonth && selectedMonth >= '2026-01';
    const TAYFUN_TEAM = ['Pascal Schallenberg','Maxim Horten','Patrick Kalinowski','Bernd Krahwinkel','Kadir Danyildiz'];
    if (name === 'Christoph Held' && isJan26Plus) {
        perA = 3000;
        staffGes = cnt * 3000;
    } else if (name === 'Tayfun S√ºleymaniye' && isJan26Plus) {
        perA = 2700;
        staffGes = cnt * 2700;
    } else if (name === 'Stefan Hensel') {
        perA = 2800;
        staffGes = cnt * 2800;
    } else {
        perA = cnt >= st.schwelle ? st.ab8 : st.basis;
        staffGes = cnt * perA;
    }
    
    let spB = 0, elB = 0, emB = 0;
    provRelevant.forEach(a => {
        if (a['Speichererweiterung']?.trim()) spB += BONI.Speichererweiterung[typ];
        if (name === 'Tayfun S√ºleymaniye' && isJan26Plus) return; // nur Speicher
        if (name === 'Stefan Hensel') { // kein Eigenlead, nur Empfehlung
            const q = (a['Quelle']||'').trim();
            if (q === 'Empfehlung') emB += BONI.Empfehlung[typ];
            return;
        }
        const q = (a['Quelle']||'').trim();
        const mvpp = (a['MVPP-Name']||'').trim();
        const isEigenlead = q === 'Eigenlead' || (name === 'Gino Ulitzka' && mvpp.includes('Christian Neukirch'));
        if (isEigenlead) elB += BONI.Eigenlead[typ];
        else if (q === 'Empfehlung') emB += BONI.Empfehlung[typ];
    });
    const boniGes = spB + elB + emB;
    let zeroBonus = 0;
    let teamBonus = 0;
    let teamPrevMonth = '';
    let teamPrevCnt = 0;
    let teamLabel = '';
    if (typ === 'HGB' && !(name === 'Christoph Held' && isJan26Plus) && !(name === 'Tayfun S√ºleymaniye' && isJan26Plus) && name !== 'Stefan Hensel') {
        if (cnt >= 15) zeroBonus = 5000;
        else if (cnt >= 10) zeroBonus = 2000;
    }
    if (name === 'Christoph Held' && allCsv && selectedMonth && selectedMonth >= '2026-01') {
        let curSales = 0;
        allCsv.forEach(r => {
            if (exclANs && exclANs.has(r['AN Nr.']?.trim())) return;
            if ((r['Auszahlungsrelevant']||'').trim() === 'Ja' && (r['Auftragsstatus']||'').trim() !== 'Storniert') {
                if (monthKey(r['DatumErstellt']) === selectedMonth) curSales++;
            }
        });
        teamBonus = curSales * 200;
        teamPrevMonth = selectedMonth;
        teamPrevCnt = curSales;
        teamLabel = 'Team-Bonus ('+curSales+' Sales aller VT √ó200‚Ç¨)';
    }
    if (name === 'Tayfun S√ºleymaniye' && allCsv && selectedMonth && isJan26Plus) {
        let teamSales = 0;
        allCsv.forEach(r => {
            if (exclANs && exclANs.has(r['AN Nr.']?.trim())) return;
            const vt = (r['Kundenberater']||'').trim();
            if (!TAYFUN_TEAM.includes(vt)) return;
            if ((r['Auszahlungsrelevant']||'').trim() !== 'Ja') return;
            if ((r['Auftragsstatus']||'').trim() === 'Storniert') return;
            if ((r['Ausgezahlt am']||'').trim()) return;
            if (monthKey(r['DatumErstellt']) === selectedMonth) teamSales++;
        });
        teamBonus = teamSales * 300;
        teamPrevMonth = selectedMonth;
        teamPrevCnt = teamSales;
        teamLabel = 'Team-Bonus ('+teamSales+' offene Sales Team √ó300‚Ç¨)';
    }
    return { typ, cnt, perA, staffGes, spB, elB, emB, boniGes, zeroBonus, teamBonus, teamPrevMonth, teamPrevCnt, teamLabel, total: staffGes + boniGes + zeroBonus + teamBonus, auftr, provRelevant, storniert, nichtRelevant, bereitsAusgezahlt, storCnt: storniert.length, nrCnt: nichtRelevant.length, paidCnt: bereitsAusgezahlt.length, totalCnt: auftr.length, ab8: !(name === 'Christoph Held' && isJan26Plus) && !(name === 'Tayfun S√ºleymaniye' && isJan26Plus) && name !== 'Stefan Hensel' && cnt >= st.schwelle, isSonder: (name === 'Christoph Held' && isJan26Plus) || (name === 'Tayfun S√ºleymaniye' && isJan26Plus) || name === 'Stefan Hensel' };
}

function App() {
    const [csv, setCsv] = React.useState(null);
    const [selMonth, setSelMonth] = React.useState(null);
    const [fTyp, setFTyp] = React.useState('Alle');
    const [selVT, setSelVT] = React.useState(null);
    const [search, setSearch] = React.useState('');
    const [showDups, setShowDups] = React.useState(false);
    const [excludedANs, setExcludedANs] = React.useState(new Set());

    function onFile(e) {
        const f = e.target.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = ev => {
            const rows = csvParse(ev.target.result);
            setCsv(rows);
            const ms = months(rows);
            if (ms.length) setSelMonth(ms[ms.length-1]);
        };
        r.readAsText(f,'utf-8');
    }

    function months(d) {
        const s = new Set();
        d.forEach(r => { const k = monthKey(r['DatumErstellt']); if (k) s.add(k); });
        return [...s].sort();
    }

    function findDuplicates(data) {
        if (!data) return [];
        const kundenMap = {};
        data.forEach(r => {
            const kunde = (r['Kunde']||'').trim();
            if (!kunde) return;
            if (!kundenMap[kunde]) kundenMap[kunde] = [];
            kundenMap[kunde].push(r);
        });
        const dups = [];
        Object.entries(kundenMap).forEach(([kunde, auftr]) => {
            const aktiv = auftr.filter(a => (a['Auftragsstatus']||'').trim() !== 'Storniert');
            if (aktiv.length < 2) return;
            const combos = {};
            aktiv.forEach(a => {
                const key = (a['Kunde PLZ']||'').trim() + '|' + (a['Angebot KWP']||'').trim();
                if (!combos[key]) combos[key] = [];
                combos[key].push(a);
            });
            Object.values(combos).forEach(group => {
                if (group.length >= 2) {
                    dups.push({ kunde, plz: (group[0]['Kunde PLZ']||'').trim(), kwp: (group[0]['Angebot KWP']||'').trim(), auftraege: group });
                }
            });
        });
        return dups;
    }

    const duplicates = React.useMemo(() => findDuplicates(csv), [csv]);
    const monthDuplicates = React.useMemo(() => {
        if (!selMonth) return [];
        return duplicates.filter(dup => 
            dup.auftraege.some(a => monthKey(a['DatumErstellt']) === selMonth)
        ).map(dup => ({
            ...dup,
            auftraege: dup.auftraege.filter(a => monthKey(a['DatumErstellt']) === selMonth)
        })).filter(dup => dup.auftraege.length >= 2);
    }, [duplicates, selMonth]);
    const dupANSet = React.useMemo(() => {
        const s = new Set();
        monthDuplicates.forEach(d => d.auftraege.forEach(a => s.add(a['AN Nr.'])));
        return s;
    }, [monthDuplicates]);

    function filtered() {
        if (!csv || !selMonth) return [];
        return csv.filter(r => {
            if (monthKey(r['DatumErstellt']) !== selMonth) return false;
            if (!VT_TYPEN[r['Kundenberater']?.trim()]) return false;
            return true;
        });
    }

    function abrechnungen() {
        const d = filtered(), grp = {};
        d.forEach(r => { const n = r['Kundenberater']?.trim(); if (!n) return; if (!grp[n]) grp[n]=[]; grp[n].push(r); });
        const res = [];
        Object.keys(VT_TYPEN).forEach(n => {
            const p = calcProv(grp[n]||[], n, selMonth, csv, excludedANs);
            if (p) res.push({ name:n, ...p });
        });
        return res.filter(r => {
            if (fTyp !== 'Alle' && r.typ !== fTyp) return false;
            if (search && !r.name.toLowerCase().includes(search.toLowerCase())) return false;
            return true;
        }).sort((a,b) => b.total - a.total);
    }

    if (!csv) return (
        <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',minHeight:'100vh',padding:24}}>
            <div style={{width:8,height:8,borderRadius:'50%',background:'#F5C500',marginBottom:12}}></div>
            <h1 style={{fontSize:28,fontWeight:700,color:'#fff',marginBottom:8}}>Vertriebler Abrechnung</h1>
            <p style={{color:'#6b7280',marginBottom:32,fontSize:15}}>CSV-Export hochladen</p>
            <label style={{display:'flex',flexDirection:'column',alignItems:'center',gap:12,padding:'48px 64px',borderRadius:16,border:'2px dashed #2a2d3a',cursor:'pointer',background:'#12131a',transition:'all 0.3s'}}
                onMouseOver={e=>{e.currentTarget.style.borderColor='#F5C500';e.currentTarget.style.background='rgba(245,197,0,0.03)';}}
                onMouseOut={e=>{e.currentTarget.style.borderColor='#2a2d3a';e.currentTarget.style.background='#12131a';}}>
                <div style={{fontSize:40}}>üìä</div>
                <span style={{color:'#F5C500',fontWeight:600,fontSize:15}}>CSV-Datei ausw√§hlen</span>
                <span style={{color:'#6b7280',fontSize:13}}>Auftr√§ge-Export (.csv)</span>
                <input type="file" accept=".csv" onChange={onFile} style={{display:'none'}} />
            </label>
        </div>
    );

    const ms = months(csv);
    const abr = abrechnungen();
    const totProv = abr.reduce((s,a) => s+a.total, 0);
    const totAuftr = abr.reduce((s,a) => s+a.cnt, 0);
    const totPaid = abr.reduce((s,a) => s+a.paidCnt, 0);
    const nHGB = abr.filter(a=>a.typ==='HGB'&&(a.cnt>0||a.paidCnt>0)).length;
    const nAng = abr.filter(a=>a.typ==='Angestellt'&&(a.cnt>0||a.paidCnt>0)).length;
    // Bereits ausgezahlt sch√§tzen (Paid haben eigene Staffel-Berechnung nicht, approximieren)
    const totBereitsAusgezahlt = abr.reduce((s,a) => {
        let paidProv = 0;
        a.bereitsAusgezahlt.forEach(r => {
            paidProv += a.perA; // gleiche Staffel
        });
        return s + paidProv;
    }, 0);

    function exportCSV() {
        const rows = [['Vertriebler','Typ','Anlagen auszahlungsf.','Anlagen ausgezahlt','Anlagen storniert','Staffel/Anlage','Staffel Gesamt','Speichererw.','Eigenlead','Empfehlung','Stufenbonus','Team-Bonus','Gesamt auszuzahlen']];
        abr.filter(a=>a.cnt>0||a.paidCnt>0||a.storCnt>0).forEach(a => {
            rows.push([a.name,a.typ,a.cnt,a.paidCnt,a.storCnt,a.perA,a.staffGes,a.spB,a.elB,a.emB,a.zeroBonus,a.teamBonus,a.total]);
        });
        const csvStr = rows.map(r => r.map(c => typeof c==='string'&&c.includes(',')?'"'+c+'"':c).join(';')).join('\n');
        const blob = new Blob(['\uFEFF'+csvStr], {type:'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'abrechnung_'+selMonth+'.csv';
        link.click();
        URL.revokeObjectURL(url);
    }

    if (selVT) {
        const det = abr.find(a=>a.name===selVT);
        if (!det || (det.cnt === 0 && det.storCnt === 0)) return (
            <div className="app-wrap" style={{maxWidth:1000,margin:'0 auto',padding:'20px 24px'}}>
                <button onClick={()=>setSelVT(null)} style={backBtn}>‚Üê Zur√ºck</button>
                <p style={{color:'#6b7280',marginTop:20}}>Keine Auftr√§ge f√ºr {selVT} in diesem Monat.</p>
            </div>
        );
        return (
            <div className="app-wrap" style={{maxWidth:1000,margin:'0 auto',padding:'20px 24px'}}>
                <button onClick={()=>setSelVT(null)} style={backBtn}>‚Üê Zur√ºck zur √úbersicht</button>
                <div style={{background:'#12131a',borderRadius:16,padding:24,border:'1px solid #1e1f2a',margin:'16px 0 20px'}}>
                    <div className="detail-header-row" style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                        <div>
                            <h2 style={{fontSize:24,fontWeight:700,color:'#fff',marginBottom:6}}>{det.name}</h2>
                            <div style={{display:'flex',gap:8}}>
                                <TypeBadge typ={det.typ}/>
                                <span style={{fontSize:12,color:'#6b7280',padding:'3px 0'}}>{monthLabel(selMonth)}</span>
                            </div>
                        </div>
                        <div style={{textAlign:'right'}}>
                            <div style={{fontSize:32,fontWeight:700,color:'#F5C500'}}>{euro(det.total)}</div>
                            <div style={{fontSize:13,color:'#6b7280'}}>Gesamt-Provision</div>
                        </div>
                    </div>
                </div>

                <div className="detail-grid" style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:20}}>
                    <div style={cardStyle}>
                        <div style={{fontSize:13,color:'#6b7280',marginBottom:12,fontWeight:500}}>{det.isSonder?'‚≠ê Sonder-Provision':'üìä Staffel-Provision'}</div>
                        <div style={{fontSize:14,color:'#c8cfd8',marginBottom:6}}>{det.cnt} Anlage{det.cnt!==1?'n':''} √ó {euro(det.perA)}{det.isSonder?' (Sondersatz)':''}</div>
                        {det.ab8 && <div style={{fontSize:12,color:'#48bb78',marginBottom:6}}>üöÄ Ab 8 Anlagen ‚Äì r√ºckwirkend {euro(det.perA)}</div>}
                        <div style={{fontSize:20,fontWeight:700,color:'#fff',marginTop:8}}>{euro(det.staffGes)}</div>
                    </div>
                    <div style={cardStyle}>
                        <div style={{fontSize:13,color:'#6b7280',marginBottom:12,fontWeight:500}}>üéÅ Boni</div>
                        {det.spB > 0 && <BonusLine label="Speichererweiterung" val={det.spB} color="#a78bfa"/>}
                        {det.elB > 0 && <BonusLine label="Eigenlead" val={det.elB} color="#48bb78"/>}
                        {det.emB > 0 && <BonusLine label="Empfehlung" val={det.emB} color="#63b3ed"/>}
                        {det.zeroBonus > 0 && <BonusLine label={det.cnt>=15?'Stufenbonus (10+15)':'Stufenbonus (10)'} val={det.zeroBonus} color="#f6ad55"/>}
                        {det.teamBonus > 0 && <BonusLine label={det.teamLabel} val={det.teamBonus} color="#fc8181"/>}
                        {det.boniGes === 0 && det.zeroBonus === 0 && det.teamBonus === 0 && <div style={{fontSize:13,color:'#4a5568'}}>Keine Boni</div>}
                        <div style={{fontSize:20,fontWeight:700,color:'#fff',marginTop:8}}>{euro(det.boniGes + det.zeroBonus + det.teamBonus)}</div>
                    </div>
                </div>

                <div style={cardStyle}>
                    <div style={{fontSize:13,color:'#6b7280',marginBottom:14,fontWeight:500}}>üìã Auftr√§ge ({det.cnt} auszahlungsf√§hig{det.paidCnt>0?` ¬∑ ${det.paidCnt} ausgezahlt`:''}{det.storCnt>0?` ¬∑ ${det.storCnt} storniert`:''}{det.nrCnt>0?` ¬∑ ${det.nrCnt} nicht relevant`:''})</div>
                    <div style={{overflowX:'auto'}}>
                        <table style={{width:'100%',borderCollapse:'collapse',fontSize:13}}>
                            <thead><tr style={{borderBottom:'1px solid #1e1f2a'}}>
                                {['AN Nr.','Kunde','kWp','Netto','Quelle','Speicher','Status','AZ','Ausgezahlt','Erstellt'].map(h=>(
                                    <th key={h} style={{padding:'8px 10px',textAlign:'left',color:'#6b7280',fontWeight:500,whiteSpace:'nowrap'}}>{h}</th>
                                ))}
                            </tr></thead>
                            <tbody>
                                {det.auftr.map((a,i)=>{
                                    const isStor = (a['Auftragsstatus']||'').trim() === 'Storniert';
                                    const isNR = (a['Auszahlungsrelevant']||'').trim() !== 'Ja';
                                    const isPaid = !!(a['Ausgezahlt am']||'').trim();
                                    const isDup = dupANSet.has(a['AN Nr.']);
                                    const isExcluded = excludedANs.has((a['AN Nr.']||'').trim());
                                    const dimmed = isStor || isNR || isPaid || isExcluded;
                                    return (
                                    <tr key={i} style={{borderBottom:'1px solid #0f1015',opacity:dimmed?0.4:1,borderLeft:isDup&&!isExcluded?'3px solid #f59e0b':isExcluded?'3px solid #e53e3e':'3px solid transparent'}}>
                                        <td style={{padding:'8px 10px',color:dimmed?'#6b7280':'#F5C500',fontWeight:600}}>{isDup&&!isExcluded&&'‚ö†Ô∏è '}{isExcluded&&'‚ùå '}{a['AN Nr.']}</td>
                                        <td style={{padding:'8px 10px',color:dimmed?'#6b7280':'#c8cfd8'}}>{a['Kunde']||'-'}</td>
                                        <td style={{padding:'8px 10px',color:dimmed?'#6b7280':'#c8cfd8',whiteSpace:'nowrap'}}>{a['Angebot KWP'] ? a['Angebot KWP'].trim()+' kWp' : '-'}</td>
                                        <td style={{padding:'8px 10px',color:dimmed?'#6b7280':'#fff',fontWeight:500,textDecoration:isStor?'line-through':'none'}}>{euro(nettoNum(a['AN-WertNetto']))}</td>
                                        <td style={{padding:'8px 10px'}}><QTag q={a['Quelle']?.trim()} mvpp={a['MVPP-Name']?.trim()} vt={det.name}/></td>
                                        <td style={{padding:'8px 10px',color:a['Speichererweiterung']?.trim()?'#a78bfa':'#3a3d4a'}}>{a['Speichererweiterung']?.trim()?'‚úì':'-'}</td>
                                        <td style={{padding:'8px 10px',color:isStor?'#e53e3e':'#8b95a5',fontSize:12,fontWeight:isStor?600:400}}>{a['Auftragsstatus']?.trim()}</td>
                                        <td style={{padding:'8px 10px'}}><span style={{fontSize:11,padding:'2px 6px',borderRadius:4,background:isNR?'rgba(229,62,62,0.15)':'rgba(72,187,120,0.15)',color:isNR?'#e53e3e':'#48bb78',fontWeight:500}}>{isNR?'Nein':'Ja'}</span></td>
                                        <td style={{padding:'8px 10px'}}>{a['Ausgezahlt am']?.trim() ? <span style={{fontSize:11,padding:'2px 6px',borderRadius:4,background:'rgba(245,197,0,0.15)',color:'#F5C500',fontWeight:500}}>{a['Ausgezahlt am'].trim()}</span> : <span style={{fontSize:11,color:'#4a5568'}}>auszahlungsf√§hig</span>}</td>
                                        <td style={{padding:'8px 10px',color:'#8b95a5',whiteSpace:'nowrap'}}>{a['DatumErstellt']}</td>
                                    </tr>);
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="app-wrap" style={{maxWidth:1400,margin:'0 auto',padding:'20px 24px'}}>
            <div className="header-row" style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
                <div>
                    <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
                        <div style={{width:8,height:8,borderRadius:'50%',background:'#F5C500'}}></div>
                        <span style={{color:'#6b7280',fontSize:13,fontWeight:500,letterSpacing:1}}>BEE-DOO</span>
                    </div>
                    <h1 style={{fontSize:26,fontWeight:700,color:'#fff'}}>Vertriebler Abrechnung</h1>
                </div>
                <label style={{cursor:'pointer',background:'#1a1b25',border:'1px solid #2a2d3a',borderRadius:8,padding:'8px 16px',fontSize:13,color:'#8b95a5',transition:'border-color 0.2s'}}
                    onMouseOver={e=>e.currentTarget.style.borderColor='#F5C500'}
                    onMouseOut={e=>e.currentTarget.style.borderColor='#2a2d3a'}>
                    üìÅ Neue CSV laden
                    <input type="file" accept=".csv" onChange={onFile} style={{display:'none'}} />
                </label>
            </div>

            <div className="month-tabs" style={{display:'flex',gap:4,marginBottom:20,overflowX:'auto',paddingBottom:4}}>
                {ms.map(m=>(
                    <button key={m} onClick={()=>setSelMonth(m)} style={{
                        padding:'8px 16px',borderRadius:8,border:'none',cursor:'pointer',fontSize:13,fontWeight:600,fontFamily:'DM Sans',
                        background:selMonth===m?'#F5C500':'#1a1b25',color:selMonth===m?'#0a0a0f':'#8b95a5',transition:'all 0.2s',whiteSpace:'nowrap',
                    }}>{monthLabel(m)}</button>
                ))}
            </div>

            <div className="filter-row" style={{display:'flex',gap:12,marginBottom:20,alignItems:'center',flexWrap:'wrap'}}>
                <input type="text" placeholder="üîç Vertriebler suchen..." value={search} onChange={e=>setSearch(e.target.value)}
                    style={{background:'#12131a',border:'1px solid #2a2d3a',borderRadius:8,padding:'8px 14px',color:'#c8cfd8',fontSize:14,fontFamily:'DM Sans',outline:'none',flex:'1',minWidth:180}}
                    onFocus={e=>e.target.style.borderColor='#F5C500'} onBlur={e=>e.target.style.borderColor='#2a2d3a'} />
                {['Alle','HGB','Angestellt'].map(t=>(
                    <button key={t} onClick={()=>setFTyp(t)} style={{
                        padding:'8px 14px',borderRadius:8,border:'1px solid',fontFamily:'DM Sans',
                        borderColor:fTyp===t?'#F5C500':'#2a2d3a',background:fTyp===t?'rgba(245,197,0,0.1)':'transparent',
                        color:fTyp===t?'#F5C500':'#8b95a5',fontSize:13,fontWeight:500,cursor:'pointer',
                    }}>{t}</button>
                ))}
            </div>

            {monthDuplicates.length > 0 && (
                <div style={{background:'rgba(245,158,11,0.08)',border:'1px solid rgba(245,158,11,0.3)',borderRadius:12,padding:'14px 20px',marginBottom:20}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer'}} onClick={()=>setShowDups(!showDups)}>
                        <div style={{display:'flex',alignItems:'center',gap:10}}>
                            <span style={{fontSize:18}}>‚ö†Ô∏è</span>
                            <span style={{fontSize:14,fontWeight:600,color:'#f59e0b'}}>{monthDuplicates.length} m√∂gliche Duplikate</span>
                            <span style={{fontSize:12,color:'#8b95a5'}}>{excludedANs.size > 0 ? `(${excludedANs.size} aussortiert)` : 'Bitte pr√ºfen!'}</span>
                        </div>
                        <span style={{fontSize:12,color:'#f59e0b',fontWeight:500}}>{showDups?'‚ñ≤ Ausblenden':'‚ñº Pr√ºfen'}</span>
                    </div>
                    {showDups && (
                        <div style={{marginTop:16,display:'flex',flexDirection:'column',gap:16}}>
                            {monthDuplicates.map((dup,di) => (
                                <div key={di} style={{background:'rgba(0,0,0,0.3)',borderRadius:10,padding:16,border:'1px solid rgba(245,158,11,0.15)'}}>
                                    <div style={{fontSize:14,fontWeight:700,color:'#f59e0b',marginBottom:12}}>{dup.kunde} <span style={{fontSize:12,fontWeight:400,color:'#8b95a5'}}>| PLZ {dup.plz} | {dup.kwp} kWp</span></div>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(300px,1fr))',gap:12}}>
                                        {dup.auftraege.map((a,ai) => {
                                            const an = (a['AN Nr.']||'').trim();
                                            const isExcl = excludedANs.has(an);
                                            const isKept = dup.auftraege.some((other,oi) => oi !== ai && excludedANs.has((other['AN Nr.']||'').trim())) && !isExcl;
                                            const bd = (a['BeeDooFortschritt']||'').trim();
                                            const tb = (a['Termine Berater']||'').trim();
                                            // Extract last meaningful status from Termine Berater
                                            const tbShort = tb.replace(/Termintyp:/g, '\nüîπ').replace(/Termin erstellt:/g, 'üìÖ').replace(/Abgeschlossen am/g, '‚úÖ');
                                            return (
                                                <div key={ai} style={{
                                                    background: isExcl ? 'rgba(229,62,62,0.08)' : isKept ? 'rgba(72,187,120,0.08)' : '#12131a',
                                                    border: isExcl ? '2px solid rgba(229,62,62,0.4)' : isKept ? '2px solid rgba(72,187,120,0.4)' : '1px solid #2a2d3a',
                                                    borderRadius: 10, padding: 14, opacity: isExcl ? 0.5 : 1, position: 'relative'
                                                }}>
                                                    {isExcl && <div style={{position:'absolute',top:8,right:12,fontSize:11,fontWeight:600,color:'#e53e3e',background:'rgba(229,62,62,0.15)',padding:'2px 8px',borderRadius:4}}>‚ùå Entfernt</div>}
                                                    {isKept && <div style={{position:'absolute',top:8,right:12,fontSize:11,fontWeight:600,color:'#48bb78',background:'rgba(72,187,120,0.15)',padding:'2px 8px',borderRadius:4}}>‚úÖ Behalten</div>}
                                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
                                                        <span style={{fontSize:16,fontWeight:700,color:'#F5C500'}}>AN {an}</span>
                                                        <span style={{fontSize:14,fontWeight:600,color:'#fff'}}>{euro(nettoNum(a['AN-WertNetto']))}</span>
                                                    </div>
                                                    <div style={{fontSize:12,color:'#8b95a5',marginBottom:4}}>Erstellt: {a['DatumErstellt']} | Status: {(a['Auftragsstatus']||'').trim()}</div>
                                                    <div style={{fontSize:12,color:'#8b95a5',marginBottom:8}}>VT: {(a['Kundenberater']||'').trim()} | AZ: {(a['Auszahlungsrelevant']||'').trim()}</div>
                                                    <div style={{background:'rgba(255,255,255,0.04)',borderRadius:6,padding:'8px 10px',marginBottom:8}}>
                                                        <div style={{fontSize:11,color:'#6b7280',marginBottom:4,fontWeight:600}}>BeeDoo Fortschritt</div>
                                                        <div style={{fontSize:13,color:bd.includes('Doppelte')?'#f59e0b':bd.includes('Storniert')?'#e53e3e':'#c8cfd8',fontWeight:600}}>{bd || '‚Äì'}</div>
                                                    </div>
                                                    <div style={{background:'rgba(255,255,255,0.04)',borderRadius:6,padding:'8px 10px',marginBottom:10}}>
                                                        <div style={{fontSize:11,color:'#6b7280',marginBottom:4,fontWeight:600}}>Termine Berater</div>
                                                        <div style={{fontSize:11,color:'#8b95a5',lineHeight:1.5,whiteSpace:'pre-wrap'}}>{tbShort || '‚Äì'}</div>
                                                    </div>
                                                    <div style={{display:'flex',gap:8}}>
                                                        {!isExcl && !isKept && (
                                                            <button onClick={() => {const s = new Set(excludedANs); s.add(an); setExcludedANs(s);}}
                                                                style={{flex:1,padding:'8px',borderRadius:6,border:'1px solid rgba(229,62,62,0.4)',background:'rgba(229,62,62,0.1)',color:'#e53e3e',fontSize:12,fontWeight:600,cursor:'pointer',fontFamily:'DM Sans'}}>
                                                                ‚ùå Entfernen
                                                            </button>
                                                        )}
                                                        {isExcl && (
                                                            <button onClick={() => {const s = new Set(excludedANs); s.delete(an); setExcludedANs(s);}}
                                                                style={{flex:1,padding:'8px',borderRadius:6,border:'1px solid rgba(245,158,11,0.4)',background:'rgba(245,158,11,0.1)',color:'#f59e0b',fontSize:12,fontWeight:600,cursor:'pointer',fontFamily:'DM Sans'}}>
                                                                ‚Ü©Ô∏è Wiederherstellen
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            )}

            <div className="grid-stats" style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(180px,1fr))',gap:12,marginBottom:16}}>
                <Stat label="Noch auszuzahlen" value={euro(totProv)} hl />
                <Stat label="Bereits ausgezahlt" value={euro(totBereitsAusgezahlt)} />
                <Stat label="Auszahlungsf√§hig" value={totAuftr} />
                <Stat label="Ausgezahlt" value={totPaid} />
                <Stat label="HGB aktiv" value={nHGB} />
                <Stat label="Angestellt aktiv" value={nAng} />
            </div>

            <div style={{display:'flex',gap:12,marginBottom:20,flexWrap:'wrap',alignItems:'center'}}>
                <button onClick={exportCSV} style={{padding:'8px 16px',borderRadius:8,border:'1px solid #2a2d3a',background:'#1a1b25',color:'#8b95a5',fontSize:13,fontWeight:500,cursor:'pointer',fontFamily:'DM Sans',transition:'all 0.2s'}}
                    onMouseOver={e=>{e.currentTarget.style.borderColor='#F5C500';e.currentTarget.style.color='#F5C500';}}
                    onMouseOut={e=>{e.currentTarget.style.borderColor='#2a2d3a';e.currentTarget.style.color='#8b95a5';}}>
                    üì• CSV Export ({monthLabel(selMonth)})
                </button>
                <div style={{display:'flex',gap:8,flexWrap:'wrap',fontSize:11,color:'#6b7280'}}>
                    <span style={{padding:'4px 10px',borderRadius:6,background:'rgba(252,129,129,0.08)',border:'1px solid rgba(252,129,129,0.2)',color:'#fc8181'}}>‚≠ê Christoph Held: 3.000‚Ç¨/Anlage + 200‚Ç¨√óTeam (ab Jan)</span>
                    <span style={{padding:'4px 10px',borderRadius:6,background:'rgba(252,129,129,0.08)',border:'1px solid rgba(252,129,129,0.2)',color:'#fc8181'}}>‚≠ê Tayfun: 2.700‚Ç¨ + 300‚Ç¨√óTeam (ab Jan)</span>
                    <span style={{padding:'4px 10px',borderRadius:6,background:'rgba(252,129,129,0.08)',border:'1px solid rgba(252,129,129,0.2)',color:'#fc8181'}}>‚≠ê Stefan Hensel: 2.800‚Ç¨, kein Eigenlead</span>
                    <span style={{padding:'4px 10px',borderRadius:6,background:'rgba(72,187,120,0.08)',border:'1px solid rgba(72,187,120,0.2)',color:'#48bb78'}}>üöÄ HGB Staffel: 1-7‚Üí1.400‚Ç¨ | 8+‚Üí1.700‚Ç¨</span>
                    <span style={{padding:'4px 10px',borderRadius:6,background:'rgba(99,179,237,0.08)',border:'1px solid rgba(99,179,237,0.2)',color:'#63b3ed'}}>üìä Stufenbonus: 10‚Üí+2.000‚Ç¨ | 15‚Üí+3.000‚Ç¨</span>
                </div>
            </div>

            <div className="grid-vt" style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(340px,1fr))',gap:12}}>
                {abr.filter(a=>a.cnt>0||a.storCnt>0).map((a,i)=>(
                    <VTCard key={a.name} d={a} idx={i} onClick={()=>setSelVT(a.name)} />
                ))}
            </div>
            {abr.filter(a=>a.cnt>0||a.storCnt>0).length===0 && (
                <div style={{textAlign:'center',padding:60,color:'#6b7280'}}>Keine Auftr√§ge f√ºr diesen Monat.</div>
            )}
        </div>
    );
}

function Stat({label,value,hl}) {
    return (
        <div className="fade-in" style={{background:'#12131a',borderRadius:12,padding:'16px 20px',border:`1px solid ${hl?'rgba(245,197,0,0.3)':'#1e1f2a'}`}}>
            <div style={{fontSize:12,color:'#6b7280',fontWeight:500,marginBottom:6,letterSpacing:0.5}}>{label}</div>
            <div style={{fontSize:22,fontWeight:700,color:hl?'#F5C500':'#fff'}}>{value}</div>
        </div>
    );
}

function VTCard({d,idx,onClick}) {
    return (
        <div onClick={onClick} style={{
            background:'#12131a',borderRadius:12,padding:'16px 20px',border:'1px solid #1e1f2a',
            cursor:'pointer',transition:'all 0.2s',animation:`slideUp 0.3s ease-out ${idx*0.03}s both`,
        }}
            onMouseOver={e=>{e.currentTarget.style.borderColor='#F5C500';e.currentTarget.style.transform='translateY(-2px)';}}
            onMouseOut={e=>{e.currentTarget.style.borderColor='#1e1f2a';e.currentTarget.style.transform='translateY(0)';}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:12}}>
                <div>
                    <div style={{fontSize:15,fontWeight:600,color:'#fff',marginBottom:4}}>{d.name}</div>
                    <div style={{display:'flex',gap:6,alignItems:'center'}}>
                        <TypeBadge typ={d.typ}/>
                        {d.ab8 && <span style={{fontSize:11,fontWeight:600,padding:'2px 8px',borderRadius:4,background:'rgba(72,187,120,0.15)',color:'#48bb78'}}>üöÄ Staffel+</span>}
                        {d.isSonder && <span style={{fontSize:11,fontWeight:600,padding:'2px 8px',borderRadius:4,background:'rgba(252,129,129,0.15)',color:'#fc8181'}}>‚≠ê Sonder</span>}
                    </div>
                </div>
                <div style={{textAlign:'right'}}>
                    <div style={{fontSize:20,fontWeight:700,color:'#F5C500'}}>{euro(d.total)}</div>
                    <div style={{fontSize:12,color:'#6b7280'}}>{d.totalCnt} Anlagen: {d.cnt} auszahlungsf.{d.paidCnt>0?`, ${d.paidCnt} ausgez.`:''}{d.storCnt>0?`, ${d.storCnt} storn.`:''}{d.nrCnt>0?`, ${d.nrCnt} n. rel.`:''}</div>
                </div>
            </div>
            <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
                <MTag label="Staffel" val={euro(d.staffGes)} />
                {d.spB>0 && <MTag label="Speicher" val={'+'+euro(d.spB)} c="#a78bfa"/>}
                {d.elB>0 && <MTag label="Eigenlead" val={'+'+euro(d.elB)} c="#48bb78"/>}
                {d.emB>0 && <MTag label="Empfehlung" val={'+'+euro(d.emB)} c="#63b3ed"/>}
                {d.zeroBonus>0 && <MTag label="Stufenbonus" val={'+'+euro(d.zeroBonus)} c="#f6ad55"/>}
                {d.teamBonus>0 && <MTag label={'Team ('+d.teamPrevCnt+')'} val={'+'+euro(d.teamBonus)} c="#fc8181"/>}
            </div>
        </div>
    );
}

function TypeBadge({typ}) {
    return <span style={{fontSize:11,fontWeight:600,padding:'2px 8px',borderRadius:4,
        background:typ==='HGB'?'rgba(245,197,0,0.15)':'rgba(99,179,237,0.15)',
        color:typ==='HGB'?'#F5C500':'#63b3ed'}}>{typ}</span>;
}

function MTag({label,val,c='#8b95a5'}) {
    return <span style={{fontSize:11,padding:'3px 8px',borderRadius:4,background:'rgba(255,255,255,0.04)',color:c}}>{label}: <strong>{val}</strong></span>;
}

function BonusLine({label,val,color}) {
    return <div style={{display:'flex',justifyContent:'space-between',marginBottom:6,fontSize:14}}>
        <span style={{color}}>{label}</span><span style={{color:'#fff',fontWeight:500}}>{euro(val)}</span>
    </div>;
}

function QTag({q, mvpp, vt}) {
    const isEL = q === 'Eigenlead' || (vt === 'Gino Ulitzka' && mvpp && mvpp.includes('Christian Neukirch'));
    const display = isEL ? 'Eigenlead' : (q || '-');
    const cs = { Eigenlead:{bg:'rgba(72,187,120,0.15)',c:'#48bb78'}, Empfehlung:{bg:'rgba(99,179,237,0.15)',c:'#63b3ed'} };
    const s = cs[display] || {bg:'rgba(255,255,255,0.04)',c:'#6b7280'};
    return <span style={{fontSize:11,padding:'2px 8px',borderRadius:4,background:s.bg,color:s.c,fontWeight:500}}>{display}</span>;
}

const cardStyle = {background:'#12131a',borderRadius:12,padding:20,border:'1px solid #1e1f2a'};
const backBtn = {background:'none',border:'none',color:'#F5C500',cursor:'pointer',fontSize:14,fontWeight:500,fontFamily:'DM Sans',padding:0};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
