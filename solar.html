<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo Solar Analyzer</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0A0F1A; --surface: #111827; --card: #161F2E; --border: #1E2D42;
    --accent: #F5C500; --accent-dim: rgba(245,197,0,0.15);
    --green: #10B981; --text: #E2E8F0; --muted: #64748B; --subtle: #334155;
  }
  body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 60px; }
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 24px; display: flex; align-items: center; gap: 12px; }
  .logo { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: grid; place-items: center; font-size: 16px; flex-shrink: 0; }
  .header h1 { font-size: 15px; font-weight: 700; }
  .header h1 span { color: var(--accent); }
  .header p { font-size: 11px; color: var(--muted); }
  .back-btn { margin-left: auto; background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 7px 14px; font-size: 12px; cursor: pointer; text-decoration: none; }
  .print-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 7px 14px; font-size: 12px; cursor: pointer; margin-left: 8px; display: none; }
  .container { max-width: 700px; margin: 0 auto; padding: 24px 16px; }
  .search-box { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 22px 24px; margin-bottom: 20px; }
  .search-box label { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; display: block; margin-bottom: 12px; }
  .search-row { display: flex; gap: 10px; }
  .search-input { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 11px 14px; color: var(--text); font-size: 14px; outline: none; font-family: inherit; }
  .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
  .analyze-btn { background: var(--accent); border: none; border-radius: 8px; color: #000; padding: 11px 28px; font-size: 14px; font-weight: 700; cursor: pointer; min-width: 150px; font-family: inherit; }
  .analyze-btn:disabled { background: var(--subtle); color: var(--muted); cursor: not-allowed; }
  .debug-log { margin-top: 14px; background: var(--card); border-radius: 8px; padding: 10px 14px; font-size: 11px; color: var(--muted); font-family: monospace; max-height: 100px; overflow-y: auto; display: none; }
  .debug-log.visible { display: block; }
  .error-box { margin-top: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 12px 16px; color: #FCA5A5; font-size: 13px; display: none; }
  .error-box.visible { display: block; }
  .results { display: none; }
  .results.visible { display: block; }
  .addr-banner { background: var(--accent-dim); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 12px 20px; margin-bottom: 18px; display: flex; align-items: center; gap: 10px; }
  .addr-main { font-weight: 600; font-size: 14px; }
  .addr-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .slider-box { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; margin-bottom: 18px; }
  .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .slider-label { font-size: 13px; font-weight: 600; color: var(--muted); }
  .slider-value { font-size: 16px; font-weight: 700; color: var(--accent); }
  input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }
  .slider-minmax { display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: var(--muted); }
  .map-container { position: relative; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 18px; }
  #gmap { width: 100%; height: 400px; }
  .map-badge { position: absolute; top: 10px; left: 50px; z-index: 5; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); border-radius: 8px; padding: 6px 12px; font-size: 12px; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; }
  .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px; }
  .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 18px 20px; }
  .kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }
  .kpi-value { font-size: 28px; font-weight: 700; font-variant-numeric: tabular-nums; margin-top: 4px; }
  .kpi-unit { font-size: 13px; color: var(--muted); font-weight: 400; margin-left: 3px; }
  .kpi-sub { font-size: 12px; color: var(--muted); margin-top: 3px; }
  .table-box { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 18px; }
  .table-title { padding: 13px 20px; border-bottom: 1px solid var(--border); font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { padding: 9px 16px; text-align: left; color: var(--muted); font-weight: 500; font-size: 12px; border-bottom: 1px solid var(--border); }
  td { padding: 9px 16px; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  .dir-badge { background: var(--accent-dim); color: var(--accent); border-radius: 5px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
  .info-box { background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 12px 16px; font-size: 12px; color: var(--muted); }
</style>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>

/* ‚ïê‚ïê‚ïê bee-doo Responsive + Lesbarkeit Fix ‚ïê‚ïê‚ïê */

/* === LESBARKEIT: Schriften aufhellen === */
/* Zu dunkle Graut√∂ne auf Dark Theme aufhellen */
body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

/* === TABLET (768px) === */
@media (max-width: 768px) {
  /* Grid ‚Üí weniger Spalten */
  [style*="grid-template-columns"][style*="repeat"] { 
    grid-template-columns: repeat(2, 1fr) !important; 
  }
  [style*="gridTemplateColumns"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* Flex-Container wrappen */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'], [style*="display:'flex'"] {
    flex-wrap: wrap !important;
  }
  /* Ausnahme: Nav-Items und kleine Icon-Rows nicht wrappen */
  [style*="align-items:center"][style*="gap:4px"],
  [style*="alignItems:"center""][style*="gap:"4px""] {
    flex-wrap: nowrap !important;
  }
  
  /* Sidebar verkleinern */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'] {
    width: 200px !important;
    min-width: 200px !important;
  }
  
  /* Modals nicht breiter als Screen */
  .modal, [style*="width:480px"], [style*="width:520px"], [style*="width:560px"],
  [style*="width:600px"], [style*="width:640px"], [style*="width:700px"] {
    width: 95vw !important;
    max-width: 95vw !important;
  }
  
  /* Padding reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"] {
    padding: 20px !important;
  }
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"] {
    padding: 20px !important;
  }
  
  /* Tabellen scrollbar */
  table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  
  /* Font-Size Minimum */
  * { min-height: 0; }
}

/* === MOBILE (480px) === */
@media (max-width: 480px) {
  /* Grid ‚Üí 1 Spalte */
  [style*="grid-template-columns"], [style*="gridTemplateColumns"] { 
    grid-template-columns: 1fr !important; 
  }
  .grid { grid-template-columns: 1fr !important; }
  
  /* Sidebar ausblenden oder collapsieren */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*="width:200px"], [style*="width: 200px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'],
  [style*='width:"200px"'] {
    position: fixed !important;
    left: -300px !important;
    z-index: 999 !important;
    transition: left 0.3s ease !important;
    width: 260px !important;
    height: 100vh !important;
    top: 0 !important;
  }
  
  /* Alle Flex-Container stacken */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'] {
    flex-wrap: wrap !important;
  }
  [style*="flex-direction:row"], [style*="flexDirection:"row""],
  [style*="flex-direction: row"] {
    flex-direction: column !important;
  }
  
  /* Form-Elemente full width */
  input, select, textarea, .input-field {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    font-size: 16px !important; /* Prevents iOS zoom */
  }
  
  /* Buttons touch-friendly */
  button, .btn-primary, .btn-secondary, [role="button"] {
    min-height: 44px !important;
    min-width: 44px !important;
    font-size: 14px !important;
  }
  
  /* Padding stark reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"],
  [style*="padding:28px"], [style*="padding:24px"],
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"],
  [style*="padding: 28px"], [style*="padding: 24px"] {
    padding: 12px !important;
  }
  
  /* Gap reduzieren */
  [style*="gap:24px"], [style*="gap:20px"], [style*="gap:28px"],
  [style*="gap: 24px"], [style*="gap: 20px"], [style*="gap: 28px"] {
    gap: 12px !important;
  }
  
  /* Font sizes - minimum 12px */
  [style*="font-size:8px"], [style*="font-size:9px"], [style*="font-size:10px"],
  [style*="font-size: 8px"], [style*="font-size: 9px"], [style*="font-size: 10px"],
  [style*="fontSize:8px"], [style*="fontSize:9px"], [style*="fontSize:10px"],
  [style*='fontSize:"8px"'], [style*='fontSize:"9px"'], [style*='fontSize:"10px"'] {
    font-size: 12px !important;
  }
  
  /* Bilder responsive */
  img { max-width: 100% !important; height: auto !important; }
  
  /* Fixed elements repositionieren */
  [style*="position:fixed"][style*="top:12px"][style*="left:12px"],
  [style*="position: fixed"][style*="top: 12px"][style*="left: 12px"] {
    top: 6px !important;
    left: 6px !important;
    font-size: 11px !important;
    padding: 4px 8px !important;
  }
  
  /* Logo kleiner */
  .logo { font-size: 32px !important; }
  
  /* Text wrap erzwingen */
  * { word-wrap: break-word !important; overflow-wrap: break-word !important; }
  [style*="white-space:nowrap"], [style*="white-space: nowrap"],
  [style*='whiteSpace:"nowrap"'] {
    white-space: normal !important;
  }
  
  /* Modals full width */
  .modal, [class*="modal"], [style*="width:480px"], [style*="width:520px"],
  [style*="width:560px"], [style*="width:600px"] {
    width: 96vw !important;
    max-width: 96vw !important;
    padding: 16px !important;
    margin: 8px !important;
  }
  
  /* Map containers */
  #map, .leaflet-container, [style*="height:100vh"] {
    height: calc(100vh - 60px) !important;
  }
  .map-toolbar {
    flex-direction: column !important;
    top: 6px !important;
    left: 6px !important;
    right: 6px !important;
  }
  .map-tool-btn {
    font-size: 11px !important;
    padding: 5px 10px !important;
  }
}

/* ‚ïê‚ïê‚ïê Lesbarkeit: Zu dunkle Farben aufhellen ‚ïê‚ïê‚ïê */
/* #0c1222 backgrounds ‚Üí Schrift mindestens #8b95a5 */
[style*="color:#0c1222"], [style*="color: #0c1222"] { color: #8b95a5 !important; }
[style*="color:#151d30"], [style*="color: #151d30"] { color: #8b95a5 !important; }
[style*="color:#263354"], [style*="color: #263354"] { color: #7a8baa !important; }
[style*="color:#1c2640"], [style*="color: #1c2640"] { color: #8b95a5 !important; }
[style*="color:#334155"], [style*="color: #334155"] { color: #8b95a5 !important; }
[style*="color:#252530"], [style*="color: #252530"] { color: #8b95a5 !important; }
[style*='color:"#0c1222"'] { color: #8b95a5 !important; }
[style*='color:"#151d30"'] { color: #8b95a5 !important; }
[style*='color:"#263354"'] { color: #7a8baa !important; }
[style*='color:"#1c2640"'] { color: #8b95a5 !important; }
[style*='color:"#334155"'] { color: #8b95a5 !important; }
[style*='color:"#252530"'] { color: #8b95a5 !important; }

/* Gr√ºnt√∂ne auf Dark besser lesbar machen */
[style*="color:#166534"], [style*="color: #166534"] { color: #34d399 !important; }
[style*='color:"#166534"'] { color: #34d399 !important; }

/* Generell: Alle font-sizes unter 10px auf mindestens 11px */
</style>
</head>
<body>

<div class="header">
  <div class="logo">‚òÄÔ∏è</div>
  <div>
    <h1><img src="https://bee-doo-tools.vercel.app/bee-doo-Logo-white.svg" style="height:26px;vertical-align:middle;margin-right:8px" alt="bee-doo"><span>Solar Analyzer</span></h1>
    <p>KI-Dachanalyse ¬∑ AIKO Neostar 475W ¬∑ Google Solar API</p>
  </div>
  <a href="/" class="back-btn">‚Üê √úbersicht</a>
  <button class="print-btn" id="printBtn" onclick="window.print()">üñ® Report</button>
</div>

<div class="container">
  <div class="search-box">
    <label>Kundenadresse eingeben</label>
    <div class="search-row">
      <input type="text" class="search-input" id="addressInput"
        placeholder="z.B. Musterstra√üe 12, 33602 Bielefeld"
        value="Stieghorster Stra√üe 200, 33605 Bielefeld" />
      <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">üîç Analysieren</button>
    </div>
    <div class="debug-log" id="debugLog"></div>
    <div class="error-box" id="errorBox"></div>
  </div>

  <div class="results" id="results">
    <div class="addr-banner">
      <span style="font-size:18px">üìç</span>
      <div>
        <div class="addr-main" id="addrMain"></div>
        <div class="addr-sub" id="addrSub"></div>
      </div>
    </div>

    <div class="slider-box">
      <div class="slider-header">
        <span class="slider-label">ANZAHL MODULE</span>
        <span class="slider-value" id="sliderValue">‚Äî</span>
      </div>
      <input type="range" id="panelSlider" min="0" value="0" oninput="onSlider(this.value)">
      <div class="slider-minmax"><span>1 Modul</span><span id="maxLabel">‚Äî</span></div>
    </div>

    <div class="map-container">
      <div id="gmap"></div>
      <div class="map-badge"><span style="color:#3B82F6">‚ñ†</span> <span id="panelCountBadge">0</span> Module</div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;align-items:center;">
      <button id="deleteModeBtn" onclick="toggleDeleteMode()" style="background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:9px 16px;font-size:13px;cursor:pointer;font-family:inherit;flex:1;">üóë L√∂schen</button>
      <div id="moveHint" style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:9px 14px;font-size:12px;color:var(--muted);flex:2;">üëÜ Modul antippen ‚Üí gelb = gew√§hlt ‚Üí neue Stelle tippen</div>
    </div>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Systemgr√∂√üe</div>
        <div><span class="kpi-value" id="kwp" style="color:var(--accent)">‚Äî</span><span class="kpi-unit">kWp</span></div>
        <div class="kpi-sub" id="kwpSub">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Jahresertrag</div>
        <div><span class="kpi-value" id="kwh" style="color:var(--green)">‚Äî</span><span class="kpi-unit">kWh/Jahr</span></div>
        <div class="kpi-sub">inkl. Wechselverlust (94%)</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">CO‚ÇÇ-Einsparung</div>
        <div><span class="kpi-value" id="co2" style="color:#34D399">‚Äî</span><span class="kpi-unit">t/Jahr</span></div>
        <div class="kpi-sub">Bundesschnitt 380g/kWh</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Sonnenstunden</div>
        <div><span class="kpi-value" id="sun" style="color:#60A5FA">‚Äî</span><span class="kpi-unit">h/Jahr</span></div>
        <div class="kpi-sub">Optimale Dachfl√§che</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Nutzfl√§che</div>
        <div><span class="kpi-value" id="area" style="color:var(--muted)">‚Äî</span><span class="kpi-unit">m¬≤</span></div>
        <div class="kpi-sub" id="segCount">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Spez. Ertrag</div>
        <div><span class="kpi-value" id="spez" style="color:var(--accent)">‚Äî</span><span class="kpi-unit">kWh/kWp</span></div>
        <div class="kpi-sub">Jahresspezifischer Ertrag</div>
      </div>
    </div>

    <div class="table-box">
      <div class="table-title">Erkannte Dachfl√§chen</div>
      <table><thead><tr><th>#</th><th>Ausrichtung</th><th>Neigung</th><th>Fl√§che</th><th>Sonnenstunden</th></tr></thead>
      <tbody id="segTable"></tbody></table>
    </div>

    <div class="info-box">
      ‚ÑπÔ∏è AIKO Neostar 3S+54 ¬∑ 475Wp ¬∑ 1762√ó1134mm ¬∑ N-Typ ABC ¬∑ Œ∑=23,8% ¬∑ Qualit√§t: <span id="qualityBadge">‚Äî</span>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script>
const GKEY = 'AIzaSyD1ZYkqURi5upHcIk_uUeZErgf5kZB9Jd8';
const WATT = 475, PW = 1.134, PH = 1.762;
const DIRS = ['N','NO','O','SO','S','SW','W','NW'];
let solarData = null, mapCenter = null, configs = [], currentIdx = 0;
let gmap = null, panelPolygons = [], deleteMode = false, selectedPanel = null;

function log(msg) {
  const el = document.getElementById('debugLog');
  el.classList.add('visible');
  el.innerHTML += '<div>' + msg + '</div>';
  el.scrollTop = el.scrollHeight;
}
function showError(msg) {
  const el = document.getElementById('errorBox');
  el.textContent = '‚ö†Ô∏è ' + msg;
  el.classList.add('visible');
}
function clearState() {
  document.getElementById('debugLog').innerHTML = '';
  document.getElementById('debugLog').classList.remove('visible');
  document.getElementById('errorBox').classList.remove('visible');
  document.getElementById('results').classList.remove('visible');
}

async function analyze() {
  const addr = document.getElementById('addressInput').value.trim();
  if (!addr) return;
  clearState();
  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Analysiere...';
  try {
    log('üìç Geocoding: ' + addr);
    const geoRes = await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=de,at,ch&q=' + encodeURIComponent(addr), { headers: { 'Accept-Language': 'de', 'User-Agent': 'bee-doo-solar/1.0' } });
    const geoJson = await geoRes.json();
    if (!geoJson.length) throw new Error('Adresse nicht gefunden');
    const lat = parseFloat(geoJson[0].lat), lng = parseFloat(geoJson[0].lon);
    mapCenter = { lat, lng, formatted: geoJson[0].display_name };
    log('‚úì ' + lat.toFixed(5) + ', ' + lng.toFixed(5));

    log('‚òÄÔ∏è Solar API...');
    const solarRes = await fetch(`https://solar.googleapis.com/v1/buildingInsights:findClosest?location.latitude=${lat}&location.longitude=${lng}&requiredQuality=MEDIUM&key=${GKEY}`);
    const solarJson = await solarRes.json();
    if (solarJson.error) throw new Error('Solar API: ' + solarJson.error.message);
    solarData = solarJson;
    configs = solarData.solarPotential?.solarPanelConfigs || [];
    currentIdx = configs.length - 1;
    log('‚úÖ ' + configs.length + ' Konfigurationen geladen');
    renderAll();
  } catch(e) { showError(e.message); }
  btn.disabled = false; btn.textContent = 'üîç Analysieren';
}

function renderAll() {
  const sp = solarData.solarPotential;
  const cfg = configs[currentIdx];
  document.getElementById('results').classList.add('visible');
  document.getElementById('printBtn').style.display = 'inline-block';
  document.getElementById('addrMain').textContent = mapCenter.formatted.split(',').slice(0,3).join(',');
  document.getElementById('addrSub').textContent = mapCenter.lat.toFixed(6) + ', ' + mapCenter.lng.toFixed(6) + ' ¬∑ Qualit√§t: ' + (solarData.imageryQuality||'‚Äî') + ' ¬∑ ' + (solarData.imageryDate?.year||'‚Äî');
  document.getElementById('qualityBadge').textContent = solarData.imageryQuality || '‚Äî';
  const slider = document.getElementById('panelSlider');
  slider.max = configs.length - 1;
  slider.value = currentIdx;
  document.getElementById('maxLabel').textContent = 'Max: ' + sp.maxArrayPanelsCount + ' Module';
  updateKpis(cfg);
  renderTable(sp);
  setTimeout(() => initMap(cfg), 300);
}

function updateKpis(cfg) {
  const sp = solarData.solarPotential;
  const count = cfg?.panelsCount || 0;
  const kwp = (count * WATT / 1000).toFixed(2);
  const kwh = Math.round((cfg?.yearlyEnergyDcKwh || 0) * 0.94);
  const co2 = (kwh * 0.00038).toFixed(1);
  const spez = kwp > 0 ? Math.round(kwh / kwp) : 0;
  document.getElementById('sliderValue').textContent = count + ' Module ¬∑ ' + kwp + ' kWp';
  document.getElementById('panelCountBadge').textContent = count;
  document.getElementById('kwp').textContent = kwp;
  document.getElementById('kwpSub').textContent = count + ' √ó AIKO Neostar 475W';
  document.getElementById('kwh').textContent = kwh.toLocaleString('de-DE');
  document.getElementById('co2').textContent = co2;
  document.getElementById('sun').textContent = Math.round(sp.maxSunshineHoursPerYear||0).toLocaleString('de-DE');
  document.getElementById('area').textContent = Math.round(sp.maxArrayAreaMeters2||0);
  document.getElementById('segCount').textContent = (sp.roofSegmentStats?.length||0) + ' Dachfl√§chen';
  document.getElementById('spez').textContent = spez;
}

function initMap(cfg) {
  const { lat, lng } = mapCenter;
  if (!gmap) {
    gmap = new google.maps.Map(document.getElementById('gmap'), {
      center: { lat, lng },
      zoom: 20,
      mapTypeId: 'satellite',
      tilt: 0,
      disableDefaultUI: true,
      zoomControl: true,
    });
  } else {
    gmap.setCenter({ lat, lng });
    gmap.setZoom(20);
  }
  drawPanels(cfg);
}

function drawPanels(cfg) {
  panelPolygons.forEach(p => p.setMap(null));
  panelPolygons = [];
  if (!solarData || !gmap) return;
  const sp = solarData.solarPotential;
  const allPanels = (sp.solarPanels || []).slice(0, cfg?.panelsCount || 0);
  const R = 6378137;

  allPanels.forEach((p, idx) => {
    const seg = sp.roofSegmentStats?.[p.segmentIndex];
    const az = (seg?.azimuthDegrees || 180) * Math.PI / 180;
    const isL = p.orientation === 'LANDSCAPE';
    const GAP = 0.04; // 4cm gap each side
    const hw = (isL ? PH : PW) / 2 - GAP;
    const hh = (isL ? PW : PH) / 2 - GAP;
    const clat = p.center.latitude, clng = p.center.longitude;
    const mPerDegLat = Math.PI * R / 180;
    const mPerDegLng = mPerDegLat * Math.cos(clat * Math.PI / 180);

    const sE = Math.sin(az), sN = Math.cos(az);
    const rE = Math.cos(az), rN = -Math.sin(az);

    const corners = [
      [ hw*rE + hh*sE,  hw*rN + hh*sN],
      [-hw*rE + hh*sE, -hw*rN + hh*sN],
      [-hw*rE - hh*sE, -hw*rN - hh*sN],
      [ hw*rE - hh*sE,  hw*rN - hh*sN],
    ].map(([dE, dN]) => ({
      lat: clat + dN / mPerDegLat,
      lng: clng + dE / mPerDegLng
    }));

    const poly = new google.maps.Polygon({
      paths: corners,
      strokeColor: '#93C5FD',
      strokeOpacity: 0.9,
      strokeWeight: 1,
      fillColor: '#3B82F6',
      fillOpacity: 0.55,
      map: gmap,
      draggable: true,
      zIndex: idx
    });

    poly.panelData = { az, isL, clat: p.center.latitude, clng: p.center.longitude };

    poly.addListener('click', () => {
      if (deleteMode) {
        poly.setMap(null);
        panelPolygons = panelPolygons.filter(x => x !== poly);
        if (selectedPanel === poly) selectedPanel = null;
        updatePanelCount();
      } else {
        selectPanel(poly);
      }
    });

    poly.addListener('mouseover', () => { if (poly !== selectedPanel) poly.setOptions({ fillOpacity: 0.8 }); });
    poly.addListener('mouseout', () => { if (poly !== selectedPanel) poly.setOptions({ fillOpacity: 0.55 }); });

    panelPolygons.push(poly);
  });

  // Map click ‚Üí move selected panel to clicked location
  if (!gmap._moveListener) {
    gmap._moveListener = gmap.addListener('click', (e) => {
      if (selectedPanel && !deleteMode) {
        movePanelTo(selectedPanel, e.latLng.lat(), e.latLng.lng());
        selectPanel(null);
      }
    });
  }
}

function renderTable(sp) {
  const tbody = document.getElementById('segTable');
  tbody.innerHTML = '';
  (sp.roofSegmentStats||[]).forEach((seg,i) => {
    const az = seg.azimuthDegrees;
    const dir = DIRS[Math.round(az/45)%8];
    const tr = document.createElement('tr');
    tr.innerHTML = '<td style="color:var(--muted)">'+(i+1)+'</td><td><span class="dir-badge">'+dir+' ('+Math.round(az)+'¬∞)</span></td><td>'+seg.pitchDegrees?.toFixed(1)+'¬∞</td><td>'+seg.stats?.areaMeters2?.toFixed(0)+' m¬≤</td><td>'+Math.round(seg.stats?.sunshineQuantiles?.[5]||0)+' h</td>';
    tbody.appendChild(tr);
  });
}

function onSlider(val) {
  currentIdx = parseInt(val);
  updateKpis(configs[currentIdx]);
  drawPanels(configs[currentIdx]);
}

function selectPanel(poly) {
  if (selectedPanel && selectedPanel !== poly) {
    selectedPanel.setOptions({ fillColor: '#3B82F6', fillOpacity: 0.55, strokeColor: '#93C5FD', strokeWeight: 1 });
  }
  selectedPanel = poly;
  if (poly) {
    poly.setOptions({ fillColor: '#F5C500', fillOpacity: 0.75, strokeColor: '#F59E0B', strokeWeight: 2 });
    document.getElementById('moveHint').textContent = 'üìç Jetzt auf die gew√ºnschte Stelle tippen';
    document.getElementById('moveHint').style.color = '#F5C500';
  } else {
    document.getElementById('moveHint').textContent = 'üëÜ Modul antippen ‚Üí gelb = gew√§hlt ‚Üí neue Stelle tippen';
    document.getElementById('moveHint').style.color = 'var(--muted)';
  }
}

function movePanelTo(poly, newLat, newLng) {
  const { az, isL } = poly.panelData;
  const GAP = 0.04;
  const hw = (isL ? PH : PW) / 2 - GAP;
  const hh = (isL ? PW : PH) / 2 - GAP;
  const R = 6378137;
  const mPerDegLat = Math.PI * R / 180;
  const mPerDegLng = mPerDegLat * Math.cos(newLat * Math.PI / 180);
  const sE = Math.sin(az), sN = Math.cos(az);
  const rE = Math.cos(az), rN = -Math.sin(az);
  const corners = [
    [ hw*rE + hh*sE,  hw*rN + hh*sN],
    [-hw*rE + hh*sE, -hw*rN + hh*sN],
    [-hw*rE - hh*sE, -hw*rN - hh*sN],
    [ hw*rE - hh*sE,  hw*rN - hh*sN],
  ].map(([dE,dN]) => ({ lat: newLat + dN/mPerDegLat, lng: newLng + dE/mPerDegLng }));
  poly.setPath(corners);
  poly.panelData.clat = newLat;
  poly.panelData.clng = newLng;
  poly.setOptions({ fillColor: '#3B82F6', fillOpacity: 0.55, strokeColor: '#93C5FD', strokeWeight: 1 });
}

function updatePanelCount() {
  const count = panelPolygons.length;
  document.getElementById('panelCountBadge').textContent = count;
  const kwp = (count * WATT / 1000).toFixed(2);
  document.getElementById('sliderValue').textContent = count + ' Module ¬∑ ' + kwp + ' kWp';
  document.getElementById('kwp').textContent = kwp;
  document.getElementById('kwpSub').textContent = count + ' √ó AIKO Neostar 475W';
}

function toggleDeleteMode() {
  deleteMode = !deleteMode;
  const btn = document.getElementById('deleteModeBtn');
  if (deleteMode) {
    btn.style.background = '#EF4444';
    btn.style.color = '#fff';
    btn.textContent = 'üóë L√∂schen aktiv ‚Äì Modul antippen';
    gmap.setOptions({ draggable: false });
  } else {
    btn.style.background = 'var(--card)';
    btn.style.color = 'var(--text)';
    btn.textContent = 'üóë Module l√∂schen';
    gmap.setOptions({ draggable: true });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('addressInput').addEventListener('keydown', e => { if (e.key==='Enter') analyze(); });
});
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1ZYkqURi5upHcIk_uUeZErgf5kZB9Jd8&libraries=&callback=Function.prototype">
</script>
</body>
</html>
