<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo Solar Analyzer</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0A0F1A; --surface: #111827; --card: #161F2E; --border: #1E2D42;
    --accent: #F59E0B; --accent-dim: rgba(245,158,11,0.15);
    --blue: #3B82F6; --blue-dim: rgba(59,130,246,0.5); --blue-edge: rgba(147,197,253,0.9);
    --green: #10B981; --text: #E2E8F0; --muted: #64748B; --subtle: #334155;
  }
  body { font-family: 'IBM Plex Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 60px; }
  
  /* Header */
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 24px; display: flex; align-items: center; gap: 12px; }
  .logo { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: grid; place-items: center; font-size: 16px; flex-shrink: 0; }
  .header h1 { font-size: 15px; font-weight: 700; }
  .header h1 span { color: var(--accent); }
  .header p { font-size: 11px; color: var(--muted); }
  .back-btn { margin-left: auto; background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 7px 14px; font-size: 12px; cursor: pointer; text-decoration: none; }
  .print-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 7px 14px; font-size: 12px; cursor: pointer; margin-left: 8px; }

  /* Layout */
  .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }
  
  /* Search Box */
  .search-box { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 22px 24px; margin-bottom: 20px; }
  .search-box label { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; display: block; margin-bottom: 12px; }
  .search-row { display: flex; gap: 10px; }
  .search-input { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 11px 14px; color: var(--text); font-size: 14px; outline: none; font-family: inherit; transition: border-color 0.15s; }
  .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
  .analyze-btn { background: var(--accent); border: none; border-radius: 8px; color: #000; padding: 11px 28px; font-size: 14px; font-weight: 700; cursor: pointer; min-width: 150px; transition: all 0.15s; font-family: inherit; }
  .analyze-btn:disabled { background: var(--subtle); color: var(--muted); cursor: not-allowed; }
  .debug-log { margin-top: 14px; background: var(--card); border-radius: 8px; padding: 10px 14px; font-size: 11px; color: var(--muted); font-family: monospace; max-height: 120px; overflow-y: auto; display: none; }
  .debug-log.visible { display: block; }
  .error-box { margin-top: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 12px 16px; color: #FCA5A5; font-size: 13px; display: none; }
  .error-box.visible { display: block; }

  /* Address Banner */
  .addr-banner { background: var(--accent-dim); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 12px 20px; margin-bottom: 18px; display: flex; align-items: center; gap: 10px; }
  .addr-banner .addr-main { font-weight: 600; font-size: 14px; }
  .addr-banner .addr-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

  /* Slider */
  .slider-box { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; margin-bottom: 18px; }
  .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .slider-label { font-size: 13px; font-weight: 600; color: var(--muted); }
  .slider-value { font-size: 16px; font-weight: 700; color: var(--accent); }
  input[type=range] { width: 100%; accent-color: var(--accent); height: 4px; cursor: pointer; }
  .slider-minmax { display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: var(--muted); }

  /* Map */
  .map-wrap { position: relative; width: 100%; max-width: 620px; margin-bottom: 18px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); background: #000; }
  .map-wrap img { display: none; }
  .map-wrap svg { display: none; }
  #leafletMap { width: 100%; height: 400px; border-radius: 12px; }
  .map-badge-top { position: absolute; top: 12px; left: 48px; z-index: 1000; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); border-radius: 8px; padding: 7px 12px; font-size: 12px; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; }
  .map-badge-bot { position: absolute; bottom: 28px; right: 12px; z-index: 1000; background: rgba(0,0,0,0.65); border-radius: 6px; padding: 4px 10px; font-size: 11px; color: var(--muted); pointer-events: none; }

  /* KPI Grid */
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(155px, 1fr)); gap: 12px; margin-bottom: 18px; }
  .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 18px 20px; }
  .kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }
  .kpi-value { font-size: 28px; font-weight: 700; font-variant-numeric: tabular-nums; margin-top: 4px; }
  .kpi-unit { font-size: 14px; color: var(--muted); font-weight: 400; margin-left: 4px; }
  .kpi-sub { font-size: 12px; color: var(--muted); margin-top: 3px; }

  /* Table */
  .table-box { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 18px; }
  .table-title { padding: 13px 20px; border-bottom: 1px solid var(--border); font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { padding: 9px 16px; text-align: left; color: var(--muted); font-weight: 500; font-size: 12px; border-bottom: 1px solid var(--border); }
  td { padding: 9px 16px; border-bottom: 1px solid var(--border); }
  tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
  .dir-badge { background: var(--accent-dim); color: var(--accent); border-radius: 5px; padding: 2px 8px; font-size: 12px; font-weight: 600; }

  /* Info */
  .info-box { background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 12px 16px; font-size: 12px; color: var(--muted); }

  /* Results hidden by default */
  .results { display: none; }
  .results.visible { display: block; }

  @media print {
    .header .back-btn, .header .print-btn, .search-box { display: none; }
    body { background: white; color: black; }
    .kpi-card, .table-box, .addr-banner { border-color: #ccc; }
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="header">
  <div class="logo">‚òÄÔ∏è</div>
  <div>
    <h1>bee-doo <span>Solar Analyzer</span></h1>
    <p>KI-Dachanalyse ¬∑ AIKO Neostar 475W ¬∑ Google Solar API</p>
  </div>
  <a href="/" class="back-btn">‚Üê √úbersicht</a>
  <button class="print-btn" onclick="window.print()" id="printBtn" style="display:none">üñ® Report</button>
</div>

<div class="container">
  <div class="search-box">
    <label>Kundenadresse eingeben</label>
    <div class="search-row">
      <input type="text" class="search-input" id="addressInput" placeholder="z.B. Musterstra√üe 12, 33602 Bielefeld" value="Detmolder Stra√üe 120, 33604 Bielefeld" />
      <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">üîç Analysieren</button>
    </div>
    <div class="debug-log" id="debugLog"></div>
    <div class="error-box" id="errorBox"></div>
  </div>

  <div class="results" id="results">
    <!-- Address Banner -->
    <div class="addr-banner">
      <span style="font-size:18px">üìç</span>
      <div>
        <div class="addr-main" id="addrMain"></div>
        <div class="addr-sub" id="addrSub"></div>
      </div>
    </div>

    <!-- Slider -->
    <div class="slider-box" id="sliderBox">
      <div class="slider-header">
        <span class="slider-label">ANZAHL MODULE</span>
        <span class="slider-value" id="sliderValue">‚Äî Module ¬∑ ‚Äî kWp</span>
      </div>
      <input type="range" id="panelSlider" min="0" value="0" oninput="onSlider(this.value)">
      <div class="slider-minmax"><span>1 Modul</span><span id="maxLabel">Max: ‚Äî</span></div>
    </div>

    <!-- Map -->
    <div class="map-wrap" id="mapWrap">
      <div id="leafletMap"></div>
      <div class="map-badge-top"><span style="color:#3B82F6">‚ñ†</span> <span id="panelCountBadge">0</span> Module visualisiert</div>
      <div class="map-badge-bot">Google Solar API ¬∑ Zoom 19</div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Systemgr√∂√üe</div>
        <div><span class="kpi-value" id="kwp" style="color:var(--accent)">‚Äî</span><span class="kpi-unit">kWp</span></div>
        <div class="kpi-sub" id="kwpSub">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Jahresertrag</div>
        <div><span class="kpi-value" id="kwh" style="color:var(--green)">‚Äî</span><span class="kpi-unit">kWh/Jahr</span></div>
        <div class="kpi-sub">inkl. Wechselverlust (94%)</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">CO‚ÇÇ-Einsparung</div>
        <div><span class="kpi-value" id="co2" style="color:#34D399">‚Äî</span><span class="kpi-unit">t CO‚ÇÇ/Jahr</span></div>
        <div class="kpi-sub">Bundesschnitt 380g/kWh</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Sonnenstunden</div>
        <div><span class="kpi-value" id="sun" style="color:#60A5FA">‚Äî</span><span class="kpi-unit">h/Jahr</span></div>
        <div class="kpi-sub">Optimale Dachfl√§che</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Nutzfl√§che</div>
        <div><span class="kpi-value" id="area" style="color:var(--muted)">‚Äî</span><span class="kpi-unit">m¬≤</span></div>
        <div class="kpi-sub" id="segCount">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Spez. Ertrag</div>
        <div><span class="kpi-value" id="spez" style="color:var(--accent)">‚Äî</span><span class="kpi-unit">kWh/kWp</span></div>
        <div class="kpi-sub">Jahresspezifischer Ertrag</div>
      </div>
    </div>

    <!-- Segments Table -->
    <div class="table-box">
      <div class="table-title">Erkannte Dachfl√§chen</div>
      <table><thead><tr><th>#</th><th>Ausrichtung</th><th>Neigung</th><th>Fl√§che m¬≤</th><th>√ò Sonnenstunden</th></tr></thead>
      <tbody id="segTable"></tbody></table>
    </div>

    <div class="info-box">
      ‚ÑπÔ∏è Analyse basiert auf Google Solar API + AIKO Neostar 3S+54 (475Wp, 1762√ó1134mm, N-Typ ABC, Œ∑=23,8%). Alle Werte sind Sch√§tzwerte ‚Äî Vor-Ort-Termin f√ºr pr√§zise Planung erforderlich.
    </div>
  </div>
</div>

<script>
const GKEY = "AIzaSyD1ZYkqURi5upHcIk_uUeZErgf5kZB9Jd8";
const MAP_W = 620, MAP_H = 460, ZOOM = 19;
const WATT = 475, PW = 1.134, PH = 1.762;
const DIRS = ["N","NO","O","SO","S","SW","W","NW"];

let solarData = null, mapCenter = null, configs = [], currentIdx = 0;
let leafletMap = null, panelLayerGroup = null;

function log(msg) {
  const el = document.getElementById('debugLog');
  el.classList.add('visible');
  el.innerHTML += `<div>${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}
function showError(msg) {
  const el = document.getElementById('errorBox');
  el.textContent = '‚ö†Ô∏è ' + msg;
  el.classList.add('visible');
}
function clearState() {
  document.getElementById('debugLog').innerHTML = '';
  document.getElementById('debugLog').classList.remove('visible');
  document.getElementById('errorBox').classList.remove('visible');
  document.getElementById('results').classList.remove('visible');
}

// Mercator math
function toWX(lng, s) { return ((lng + 180) / 360) * s; }
function toWY(lat, s) {
  const sin = Math.sin(lat * Math.PI / 180);
  return (0.5 - Math.log((1 + sin) / (1 - sin)) / (4 * Math.PI)) * s;
}
function latlngToPx(lat, lng, cLat, cLng) {
  const s = 256 * Math.pow(2, ZOOM);
  return { x: MAP_W/2 + (toWX(lng,s) - toWX(cLng,s)), y: MAP_H/2 + (toWY(lat,s) - toWY(cLat,s)) };
}
function mpp(lat) { return 156543.03 * Math.cos(lat * Math.PI / 180) / Math.pow(2, ZOOM); }
function dir(az) { return DIRS[Math.round(az / 45) % 8]; }

async function analyze() {
  const addr = document.getElementById('addressInput').value.trim();
  if (!addr) return;
  clearState();
  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Analysiere...';

  try {
    // Geocoding via Nominatim
    log('üìç Geocoding: ' + addr);
    const geoUrl = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=de,at,ch&q=' + encodeURIComponent(addr);
    const geoRes = await fetch(geoUrl, { headers: { 'Accept-Language': 'de', 'User-Agent': 'bee-doo-solar/1.0' } });
    const geoJson = await geoRes.json();
    log('Nominatim: ' + geoRes.status + ' ¬∑ ' + geoJson.length + ' Treffer');
    if (!geoJson.length) throw new Error('Adresse nicht gefunden ‚Äî bitte vollst√§ndiger eingeben');
    const lat = parseFloat(geoJson[0].lat), lng = parseFloat(geoJson[0].lon);
    mapCenter = { lat, lng, formatted: geoJson[0].display_name };

    // Solar API
    log('‚òÄÔ∏è Solar API: ' + lat.toFixed(6) + ', ' + lng.toFixed(6));
    const solarUrl = `https://solar.googleapis.com/v1/buildingInsights:findClosest?location.latitude=${lat}&location.longitude=${lng}&requiredQuality=MEDIUM&key=${GKEY}`;
    const solarRes = await fetch(solarUrl);
    const solarJson = await solarRes.json();
    log('Solar API: ' + solarRes.status);
    if (solarJson.error) throw new Error('Solar API: ' + solarJson.error.message);
    solarData = solarJson;
    configs = solarData.solarPotential?.solarPanelConfigs || [];
    currentIdx = configs.length - 1;
    log('‚úÖ Fertig! ' + configs.length + ' Konfigurationen');

    renderAll();
  } catch(e) {
    showError(e.message);
  }

  btn.disabled = false; btn.textContent = 'üîç Analysieren';
}

function renderAll() {
  const sp = solarData.solarPotential;
  const cfg = configs[currentIdx];

  // Show results
  document.getElementById('results').classList.add('visible');
  document.getElementById('printBtn').style.display = 'inline-block';
  // Leaflet needs size recalc after container becomes visible
  setTimeout(() => { if (leafletMap) leafletMap.invalidateSize(); }, 100);

  // Address banner
  document.getElementById('addrMain').textContent = mapCenter.formatted.split(',').slice(0,3).join(',');
  document.getElementById('addrSub').textContent =
    mapCenter.lat.toFixed(6) + ', ' + mapCenter.lng.toFixed(6) +
    ' ¬∑ Qualit√§t: ' + (solarData.imageryQuality || '‚Äî') +
    ' ¬∑ ' + (solarData.imageryDate?.year || '‚Äî');

  // Slider
  const slider = document.getElementById('panelSlider');
  slider.max = configs.length - 1;
  slider.value = currentIdx;
  document.getElementById('maxLabel').textContent = 'Max: ' + sp.maxArrayPanelsCount + ' Module';

  updateKpis(cfg);
  renderMap(cfg);
  renderTable(sp);
}

function updateKpis(cfg) {
  const sp = solarData.solarPotential;
  const count = cfg?.panelsCount || 0;
  const kwp = count * WATT / 1000;
  const kwh = Math.round((cfg?.yearlyEnergyDcKwh || 0) * 0.94);
  const co2 = Math.round(kwh * 0.38 / 100) / 10;
  const spez = kwp > 0 ? Math.round(kwh / kwp) : 0;

  document.getElementById('sliderValue').textContent = count + ' Module ¬∑ ' + kwp.toFixed(2) + ' kWp';
  document.getElementById('panelCountBadge').textContent = count;
  document.getElementById('kwp').textContent = kwp.toFixed(2);
  document.getElementById('kwpSub').textContent = count + ' √ó AIKO Neostar 475W';
  document.getElementById('kwh').textContent = kwh.toLocaleString('de-DE');
  document.getElementById('co2').textContent = co2;
  document.getElementById('sun').textContent = Math.round(sp.maxSunshineHoursPerYear || 0).toLocaleString('de-DE');
  document.getElementById('area').textContent = Math.round(sp.maxArrayAreaMeters2 || 0);
  document.getElementById('segCount').textContent = (sp.roofSegmentStats?.length || 0) + ' Dachfl√§chen erkannt';
  document.getElementById('spez').textContent = spez;
}

function renderMap(cfg) {
  const sp = solarData.solarPotential;
  const { lat, lng } = mapCenter;

  // Init Leaflet map once
  if (!leafletMap) {
    leafletMap = L.map('leafletMap', { zoomControl: true, attributionControl: false });
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 21
    }).addTo(leafletMap);
    panelLayerGroup = L.layerGroup().addTo(leafletMap);
  }
  leafletMap.setView([lat, lng], ZOOM);
  panelLayerGroup.clearLayers();

  // Draw panels as Leaflet polygons
  const allPanels = (sp.solarPanels || []).slice(0, cfg?.panelsCount || 0);
  const R = 6378137; // Earth radius meters

  allPanels.forEach(p => {
    const seg = sp.roofSegmentStats?.[p.segmentIndex];
    const az = (seg?.azimuthDegrees || 180) * Math.PI / 180;
    const isL = p.orientation === 'LANDSCAPE';
    const hw = (isL ? PH : PW) / 2; // half-width meters
    const hh = (isL ? PW : PH) / 2; // half-height meters
    const clat = p.center.latitude, clng = p.center.longitude;
    const mPerDegLat = Math.PI * R / 180;
    const mPerDegLng = mPerDegLat * Math.cos(clat * Math.PI / 180);

    // 4 corners rotated by azimuth
    const corners = [[-hw,-hh],[hw,-hh],[hw,hh],[-hw,hh]].map(([x,y]) => {
      const rx = x * Math.cos(az) - y * Math.sin(az);
      const ry = x * Math.sin(az) + y * Math.cos(az);
      return [clat + ry / mPerDegLat, clng + rx / mPerDegLng];
    });

    L.polygon(corners, {
      color: 'rgba(147,197,253,0.9)',
      fillColor: 'rgba(59,130,246,0.55)',
      fillOpacity: 0.55,
      weight: 0.8
    }).addTo(panelLayerGroup);
  });
}

function renderTable(sp) {
  const tbody = document.getElementById('segTable');
  tbody.innerHTML = '';
  (sp.roofSegmentStats || []).forEach((seg, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="color:var(--muted)">${i+1}</td>
      <td><span class="dir-badge">${dir(seg.azimuthDegrees)} (${Math.round(seg.azimuthDegrees)}¬∞)</span></td>
      <td>${seg.pitchDegrees?.toFixed(1)}¬∞</td>
      <td>${seg.stats?.areaMeters2?.toFixed(0)}</td>
      <td>${Math.round(seg.stats?.sunshineQuantiles?.[5] || 0)} h</td>`;
    tbody.appendChild(tr);
  });
}

function onSlider(val) {
  currentIdx = parseInt(val);
  const cfg = configs[currentIdx];
  updateKpis(cfg);
  renderMap(cfg);
}

// Enter key
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('addressInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') analyze();
  });
});
</script>
</body>
</html>
