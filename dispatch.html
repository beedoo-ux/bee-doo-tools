<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>bee-doo DISPATCH</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { background: #0B0D12; font-family: 'DM Sans', system-ui, sans-serif; color: #E4E5EB; -webkit-font-smoothing: antialiased; overflow: hidden; height: 100vh; }
#root { height: 100vh; display: flex; flex-direction: column; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
@keyframes pulse-green { 0%,100%{box-shadow:0 0 8px rgba(34,197,94,0.7),0 0 20px rgba(34,197,94,0.3)} 50%{box-shadow:0 0 3px rgba(34,197,94,0.2)} }
@keyframes pulse-orange { 0%,100%{box-shadow:0 0 8px rgba(251,191,36,0.7),0 0 20px rgba(251,191,36,0.3)} 50%{box-shadow:0 0 3px rgba(251,191,36,0.2)} }
@keyframes pulse-red { 0%,100%{box-shadow:0 0 10px rgba(248,113,113,0.7),0 0 24px rgba(248,113,113,0.3);border-color:rgba(248,113,113,0.8)} 50%{box-shadow:0 0 3px rgba(248,113,113,0.2);border-color:rgba(248,113,113,0.3)} }
@keyframes pulse-red-badge { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.96)} }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: #14171F; }
::-webkit-scrollbar-thumb { background: #232738; border-radius: 3px; }
button, select, input { font-family: 'DM Sans', system-ui, sans-serif; }
.leaflet-container { background: #14171F !important; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// bee-doo DISPATCH v2 â€“ Complete Rewrite
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const { useState, useEffect, useMemo, useCallback, useRef } = React;

// â”€â”€â”€ COLORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const C = {
  brand: '#F5C500', bg: '#0B0D12', panel: '#0F1118', card: '#14171F',
  cardHover: '#1A1D28', border: '#232738', text: '#E4E5EB', dim: '#6E7490',
  muted: '#3A3F55', green: '#22c55e', yellow: '#FBBF24', red: '#F87171',
  blue: '#60A5FA', purple: '#A78BFA', teal: '#2DD4BF', pink: '#F472B6',
  orange: '#FF8C42', dc: '#FBBF24', ac: '#60A5FA',
};

// â”€â”€â”€ PROJECT TYPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROJECT_TYPES = {
  pv_komplett: { label:'PV Komplett', icon:'â˜€ï¸', color:C.brand, twoDay:true, dcTag:'Dach + DC', acTag:'AC + IBN', dcSkill:'pv_dach', acSkill:'pv_elek', dcDur:7, acDur:6 },
  pv_dach:     { label:'PV Dach',     icon:'ğŸ ', color:C.yellow, twoDay:false, dcTag:'Dachmontage', acTag:null, dcSkill:'pv_dach', acSkill:null, dcDur:7, acDur:0 },
  pv_elek:     { label:'PV Elektro',  icon:'âš¡', color:C.blue,   twoDay:false, dcTag:null, acTag:'AC + IBN', dcSkill:null, acSkill:'pv_elek', dcDur:0, acDur:6 },
  wp_komplett: { label:'WÃ¤rmepumpe',  icon:'ğŸŒ¡ï¸', color:C.purple, twoDay:true, dcTag:'Installation', acTag:'IBN + HZ', dcSkill:'wp', acSkill:'wp', dcDur:8, acDur:5 },
  speicher:    { label:'Speicher',    icon:'ğŸ”‹', color:C.green,  twoDay:false, dcTag:'Speicher', acTag:null, dcSkill:'speicher', acSkill:null, dcDur:3, acDur:0 },
  wallbox:     { label:'Wallbox',     icon:'ğŸš—', color:C.teal,   twoDay:false, dcTag:'Wallbox', acTag:null, dcSkill:'pv_elek', acSkill:null, dcDur:2, acDur:0 },
};

// â”€â”€â”€ MONTEURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTEURE = [
  { id:1,  name:'Klaus Maier',    ini:'KM', skills:['pv_dach'],            region:'Bielefeld', cap:1, color:C.yellow },
  { id:2,  name:'Peter Schmidt',  ini:'PS', skills:['wp'],                 region:'OWL',       cap:1, color:C.purple },
  { id:3,  name:'Thomas Weber',   ini:'TW', skills:['pv_dach','wp'],       region:'GÃ¼tersloh', cap:1, color:C.brand },
  { id:4,  name:'Andreas MÃ¼ller', ini:'AM', skills:['pv_elek','wallbox'],  region:'Paderborn', cap:1, color:C.blue },
  { id:5,  name:'Stefan Koch',    ini:'SK', skills:['pv_dach','pv_elek'],  region:'Herford',   cap:2, color:C.green },
  { id:6,  name:'Michael Bauer',  ini:'MB', skills:['wp'],                 region:'Minden',    cap:1, color:C.pink },
  { id:7,  name:'JÃ¶rg Fischer',   ini:'JF', skills:['pv_dach'],            region:'Detmold',   cap:1, color:C.yellow },
  { id:8,  name:'Ralf Zimmermann',ini:'RZ', skills:['pv_elek','speicher'], region:'Bielefeld', cap:1, color:C.blue },
  { id:9,  name:'Frank Schulz',   ini:'FS', skills:['pv_dach','pv_elek'],  region:'GÃ¼tersloh', cap:1, color:C.yellow },
  { id:10, name:'Uwe Braun',      ini:'UB', skills:['wp','speicher'],      region:'Herford',   cap:1, color:C.purple },
  { id:11, name:'Markus Krause',  ini:'MK', skills:['pv_dach','pv_elek'],  region:'Bielefeld', cap:1, color:C.teal },
  { id:12, name:'Dirk Hoffmann',  ini:'DH', skills:['pv_elek','speicher','wallbox'], region:'Paderborn', cap:1, color:C.teal },
  { id:13, name:'SU: Dachtechnik West', ini:'DW', skills:['pv_dach'],      region:'OWL',       cap:3, color:C.yellow, sub:true },
  { id:14, name:'SU: WP Service OWL',   ini:'WO', skills:['wp','speicher'],region:'OWL',       cap:3, color:C.purple, sub:true },
  { id:15, name:'SU: Elektro Nord',     ini:'EN', skills:['pv_elek','wallbox'], region:'Bielefeld', cap:3, color:C.blue, sub:true },
  { id:16, name:'SU: Allround Pro',     ini:'AP', skills:['pv_dach','pv_elek'], region:'Paderborn', cap:2, color:C.green, sub:true },
  { id:17, name:'Lars Neumann',   ini:'LN', skills:['pv_dach','pv_elek'],  region:'Minden',    cap:1, color:C.yellow },
  { id:18, name:'Dennis Wolf',    ini:'DW2',skills:['wp','wallbox'],        region:'Detmold',   cap:1, color:C.pink },
];

// â”€â”€â”€ BAUENGEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BAUENGEL = [
  { id:101, name:'Sandra Vogel',   ini:'SV', region:'Bielefeld', cap:2, color:C.teal },
  { id:102, name:'Marco Heinz',    ini:'MH', region:'GÃ¼tersloh', cap:2, color:C.pink },
  { id:103, name:'Julia Kramer',   ini:'JK', region:'OWL',       cap:2, color:C.purple },
  { id:104, name:'Tobias Lange',   ini:'TL', region:'Paderborn', cap:2, color:C.blue },
  { id:105, name:'Sina Roth',      ini:'SR', region:'Herford',   cap:2, color:C.green },
  { id:106, name:'Ben Schreiber',  ini:'BS', region:'Minden',    cap:2, color:C.yellow },
];

// â”€â”€â”€ DEMO PROJEKTE (volle Kundennamen + PLZ + kWp) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RAW_PROJECTS = [
  ['Axel Reinhardt',      'Hauptstr. 12',    '33602','Bielefeld',  'pv_komplett', 9.8,  51.532, 8.533],
  ['Carmen BÃ¶hm',         'Berliner Str. 45','33604','Bielefeld',  'pv_komplett', 12.5, 51.525, 8.540],
  ['Werner SchÃ¤fer',      'Bahnhofstr. 8',   '33330','GÃ¼tersloh',  'wp_komplett', 0,    51.907, 8.379],
  ['Brigitte Klein',      'Kirchweg 22',     '33098','Paderborn',  'pv_komplett', 8.4,  51.719, 8.754],
  ['Horst Richter',       'Feldstr. 7',      '32049','Herford',    'pv_komplett', 14.7, 52.114, 8.673],
  ['Elke Vogel',          'Gartenstr. 15',   '32423','Minden',     'wallbox',     0,    52.289, 8.917],
  ['Bernd Hartmann',      'Lindenallee 3',   '32756','Detmold',    'pv_komplett', 7.2,  51.936, 8.879],
  ['Monika Braun',        'Am Park 11',      '33602','Bielefeld',  'speicher',    0,    51.530, 8.528],
  ['GÃ¼nter Lehmann',      'Waldweg 19',      '33334','GÃ¼tersloh',  'pv_komplett', 11.3, 51.910, 8.390],
  ['Sabine KÃ¶hler',       'MÃ¼hlenstr. 6',    '33102','Paderborn',  'wp_komplett', 0,    51.715, 8.760],
  ['Rainer Schwarz',      'Bergstr. 28',     '32052','Herford',    'pv_komplett', 6.9,  52.118, 8.680],
  ['Petra Engel',         'Parkstr. 4',      '32427','Minden',     'pv_komplett', 15.2, 52.295, 8.920],
  ['Hans-Georg Pfeiffer', 'Schillerstr. 9',  '33607','Bielefeld',  'wp_komplett', 0,    51.538, 8.520],
  ['Ursula Fuchs',        'Goethestr. 17',   '33334','GÃ¼tersloh',  'speicher',    0,    51.905, 8.385],
  ['Karl-Heinz Mayer',    'Mozartstr. 3',    '33100','Paderborn',  'pv_komplett', 10.5, 51.722, 8.748],
  ['Rosemarie Brandt',    'Rosengasse 5',    '32049','Herford',    'pv_dach',     0,    52.110, 8.670],
  ['Wolfgang Schneider',  'Kaiserstr. 22',   '32423','Minden',     'pv_komplett', 13.8, 52.292, 8.912],
  ['Inge Steinmetz',      'Fichtenweg 8',    '32756','Detmold',    'wp_komplett', 0,    51.940, 8.882],
  ['Manfred Kruse',       'Eichenallee 14',  '33609','Bielefeld',  'pv_komplett', 8.1,  51.542, 8.538],
  ['Hildegard Tietze',    'Birkenstr. 31',   '33330','GÃ¼tersloh',  'wallbox',     0,    51.912, 8.375],
];

const ROOF_TYPES = ['Ziegeldach 38Â°','Blechdach 15Â°','Flachdach EPDM','Biberschwanz 42Â°','Schieferdach 35Â°'];
const PRIORITIES = ['high','high','medium','medium','medium','low'];

function buildProjects() {
  return RAW_PROJECTS.map((p, i) => {
    const kwp = p[5];
    const pt = PROJECT_TYPES[p[4]];
    // >10kW â†’ DC dauert 2 Tage
    const dcDuration = kwp > 10 ? 2 : (pt.dcDur ? 1 : 0);
    return {
      id: `P-2026-${String(i+1).padStart(3,'0')}`,
      type: p[4], customer: p[0], address: p[1], plz: p[2], city: p[3],
      kwp, lat: p[6], lng: p[7],
      priority: PRIORITIES[i % PRIORITIES.length],
      notes: (p[4]==='pv_komplett'||p[4]==='pv_dach') ? ROOF_TYPES[i%ROOF_TYPES.length] : '',
      dcDate:null, dcTechId:null, dcExtraDates:[], dcDuration,
      acDate:null, acTechId:null, acExtraDates:[],
      engelId:null, status:'unplanned',
      // Baustellen-Live-Status
      baustelleStatus: null, // 'gestartet','engel_vor_ort','engel_fehlt','monteur_spaet','beide_da','dc_fertig','ac_fertig','abgenommen'
      montageStartedAt: null,
      engelArrivedAt: null,
      fotoCount: 0,
      letzteAktualisierung: null,
    };
  });
}

// â”€â”€â”€ DEMO-STATUS auf Projekte anwenden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyDemoStatus(projects) {
  const demos = [
    // P-001: Axel Reinhardt â€“ Montage gestartet + Bauengel vor Ort = GRÃœN
    { id:'P-2026-001', dcDate:'2026-02-23', dcTechId:1, acDate:'2026-02-24', acTechId:4,
      engelId:101, status:'fully_planned', baustelleStatus:'beide_da',
      montageStartedAt:'2026-02-23T07:45:00', engelArrivedAt:'2026-02-23T08:02:00',
      fotoCount:4, letzteAktualisierung:'2026-02-23T09:12:00' },
    // P-002: Carmen BÃ¶hm (12.5kWp â†’ 2-Tage DC) â€“ Bauengel vor Ort, Montage NICHT gestartet = ROT
    { id:'P-2026-002', dcDate:'2026-02-23', dcTechId:5, dcDuration:2, acDate:'2026-02-25', acTechId:8,
      engelId:102, status:'fully_planned', baustelleStatus:'engel_vor_ort',
      montageStartedAt:null, engelArrivedAt:'2026-02-23T08:15:00',
      fotoCount:2, letzteAktualisierung:'2026-02-23T08:55:00' },
    // P-003: Werner SchÃ¤fer â€“ Montage gestartet, Bauengel FEHLT = ORANGE
    { id:'P-2026-003', dcDate:'2026-02-23', dcTechId:2, acDate:'2026-02-24', acTechId:10,
      engelId:null, status:'dc_planned', baustelleStatus:'engel_fehlt',
      montageStartedAt:'2026-02-23T07:55:00', engelArrivedAt:null,
      fotoCount:1, letzteAktualisierung:'2026-02-23T08:02:00' },
    // P-004: Brigitte Klein â€“ geplant, noch nicht heute
    { id:'P-2026-004', dcDate:'2026-02-25', dcTechId:3, acDate:'2026-02-26', acTechId:11,
      engelId:104, status:'fully_planned' },
    // P-005: Horst Richter (14.7kWp â†’ 2-Tage DC) â€“ geplant
    { id:'P-2026-005', dcDate:'2026-02-26', dcTechId:7, dcDuration:2, acDate:'2026-02-28', acTechId:9,
      engelId:101, status:'fully_planned' },
    // P-006: Elke Vogel â€“ Monteur verspÃ¤tet = ROT
    { id:'P-2026-006', dcDate:'2026-02-23', dcTechId:13, acDate:'2026-02-25', acTechId:15,
      engelId:102, status:'fully_planned', baustelleStatus:'monteur_nicht_gestartet',
      montageStartedAt:null, engelArrivedAt:null,
      fotoCount:0, letzteAktualisierung:null },
  ];
  return projects.map(p => {
    const d = demos.find(x => x.id === p.id);
    return d ? { ...p, ...d } : p;
  });
}

// â”€â”€â”€ WETTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WEATHER = {
  '2026-02-23': { temp:8, rain:15, icon:'â›…', warn:false, desc:'Leicht bewÃ¶lkt' },
  '2026-02-24': { temp:5, rain:82, icon:'ğŸŒ§ï¸', warn:true, desc:'Starkregen' },
  '2026-02-25': { temp:6, rain:65, icon:'ğŸŒ¦ï¸', warn:true, desc:'Schauer' },
  '2026-02-26': { temp:11, rain:12, icon:'ğŸŒ¤ï¸', warn:false, desc:'Aufheiternd' },
  '2026-02-27': { temp:14, rain:5, icon:'â˜€ï¸', warn:false, desc:'Sonnig' },
  '2026-02-28': { temp:9, rain:40, icon:'ğŸŒ¥ï¸', warn:false, desc:'Bedeckt' },
};
const getWeather = d => WEATHER[d] || { temp:8, rain:25, icon:'ğŸŒ¥ï¸', warn:false, desc:'Wechselhaft' };

// â”€â”€â”€ BAUSTELLENSTATUS KONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BSTATUS = {
  beide_da:              { col:C.green,  animation:'pulse-green',  label:'Montage + Bauengel âœ“' },
  engel_vor_ort:         { col:C.red,    animation:'pulse-red',    label:'âš  Montage NICHT gestartet' },
  engel_fehlt:           { col:C.orange, animation:'pulse-orange', label:'Bauengel FEHLT' },
  monteur_nicht_gestartet:{ col:C.red,   animation:'pulse-red',    label:'Montage NICHT gestartet' },
  gestartet:             { col:C.green,  animation:'pulse-green',  label:'â–¶ Gestartet' },
  dc_fertig:             { col:C.blue,   animation:null,           label:'âœ“ DC fertig' },
  ac_fertig:             { col:C.purple, animation:null,           label:'âœ“ AC fertig' },
  abgenommen:            { col:C.brand,  animation:null,           label:'â˜… Abgenommen' },
};

// â”€â”€â”€ HILFSFUNKTIONEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtDate = d => d instanceof Date ? d.toISOString().split('T')[0] : d;
const fmtDay = d => {
  const dt = typeof d==='string' ? new Date(d+'T12:00:00') : d;
  return dt.toLocaleDateString('de-DE',{weekday:'short',day:'2-digit',month:'2-digit'});
};
const fmtTime = iso => iso ? new Date(iso).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) : null;
const nextWorkday = d => {
  const dt = new Date(d+'T12:00:00'); dt.setDate(dt.getDate()+1);
  if(dt.getDay()===6) dt.setDate(dt.getDate()+2);
  if(dt.getDay()===0) dt.setDate(dt.getDate()+1);
  return fmtDate(dt);
};
const getWeekDays = base => {
  const d = new Date(base);
  const dow = d.getDay();
  const mon = new Date(d); mon.setDate(d.getDate() - dow + (dow===0 ? -6 : 1));
  return Array.from({length:5}, (_,i) => { const x = new Date(mon); x.setDate(mon.getDate()+i); return x; });
};
const getKW = d => { const n=new Date(d.getFullYear(),0,4); return Math.ceil(((d-n)/864e5+n.getDay()+1)/7); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HAUPT-APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DispatchApp() {
  const [baseDate, setBaseDate] = useState(new Date('2026-02-23'));
  const [projekte, setProjekte] = useState(() => applyDemoStatus(buildProjects()));
  const [view, setView] = useState('week'); // week | month | map | capacity
  const [modal, setModal] = useState(null);
  const [monteurFilter, setMonteurFilter] = useState('all');

  const weekDays = useMemo(() => getWeekDays(baseDate), [baseDate]);

  // Tech-Slots berechnen
  const techSlots = useMemo(() => {
    const slots = {};
    const add = (k, v) => { slots[k] = [...(slots[k]||[]), v]; };
    projekte.forEach(p => {
      if(p.dcTechId && p.dcDate) {
        add(`${p.dcTechId}_${p.dcDate}`, { proj:p, phase:'dc' });
        // 2-Tage DC
        if(p.dcDuration >= 2) {
          const day2 = nextWorkday(p.dcDate);
          add(`${p.dcTechId}_${day2}`, { proj:p, phase:'dc_ext' });
        }
      }
      (p.dcExtraDates||[]).forEach(d => add(`${p.dcTechId}_${d}`, { proj:p, phase:'dc_ext' }));
      if(p.acTechId && p.acDate) add(`${p.acTechId}_${p.acDate}`, { proj:p, phase:'ac' });
      (p.acExtraDates||[]).forEach(d => add(`${p.acTechId}_${d}`, { proj:p, phase:'ac_ext' }));
    });
    return slots;
  }, [projekte]);

  // Bauengel-Slots
  const engelSlots = useMemo(() => {
    const slots = {};
    projekte.forEach(p => {
      if(!p.engelId || !p.dcDate) return;
      const k = `${p.engelId}_${p.dcDate}`;
      slots[k] = [...(slots[k]||[]), p];
    });
    return slots;
  }, [projekte]);

  const updateProject = useCallback((id, changes) => {
    setProjekte(prev => prev.map(p => {
      if(p.id !== id) return p;
      const updated = { ...p, ...changes };
      const pt = PROJECT_TYPES[updated.type];
      if(!pt.twoDay) {
        updated.status = (updated.dcDate||updated.acDate) && (updated.dcTechId||updated.acTechId) && updated.engelId
          ? 'fully_planned' : (updated.dcDate||updated.acDate) && (updated.dcTechId||updated.acTechId)
          ? 'dc_planned' : 'unplanned';
      } else {
        const hasDC = updated.dcDate && updated.dcTechId;
        const hasAC = updated.acDate && updated.acTechId;
        updated.status = hasDC && hasAC && updated.engelId ? 'fully_planned'
          : hasDC ? 'dc_planned' : 'unplanned';
      }
      return updated;
    }));
  }, []);

  // Gefilterte Monteure
  const filteredMonteure = useMemo(() =>
    MONTEURE.filter(m => !(monteurFilter==='own'&&m.sub || monteurFilter==='sub'&&!m.sub)),
  [monteurFilter]);

  // Ungeplant / Teilgeplant
  const unplanned = useMemo(() => projekte.filter(p => p.status==='unplanned'), [projekte]);
  const partialPlanned = useMemo(() => projekte.filter(p => p.status==='dc_planned'), [projekte]);

  // Alerts
  const alerts = useMemo(() => {
    const a = [];
    const engelFehlt = projekte.filter(p => p.baustelleStatus==='engel_fehlt').length;
    const monteurFehlt = projekte.filter(p => p.baustelleStatus==='monteur_nicht_gestartet'||p.baustelleStatus==='engel_vor_ort').length;
    const beideDa = projekte.filter(p => p.baustelleStatus==='beide_da').length;
    if(monteurFehlt>0) a.push({ type:'red', msg:`ğŸš¨ ${monteurFehlt} Montage(n) NICHT gestartet!` });
    if(engelFehlt>0) a.push({ type:'orange', msg:`âš  ${engelFehlt} Baustelle(n) OHNE Bauengel!` });
    if(beideDa>0) a.push({ type:'green', msg:`âœ… ${beideDa} Baustelle(n) laufen planmÃ¤ÃŸig` });
    const up = unplanned.length;
    if(up>0) a.push({ type:'dim', msg:`âš¡ ${up} Projekte ungeplant` });
    // Wetter-Warnung
    weekDays.forEach(wd => {
      const ds = fmtDate(wd);
      const w = getWeather(ds);
      if(w.warn) {
        const dach = projekte.filter(p => (p.type==='pv_komplett'||p.type==='pv_dach') && (p.dcDate===ds||(p.dcExtraDates||[]).includes(ds)) && p.dcTechId);
        if(dach.length>0) a.push({ type:'yellow', msg:`${w.icon} ${fmtDay(wd)}: ${w.rain}% Regen â€“ ${dach.length} Dachmontage(n)` });
      }
    });
    return a;
  }, [projekte, weekDays, unplanned]);

  // Header KW Stats
  const weekStats = useMemo(() => {
    const days = weekDays.map(d => fmtDate(d));
    return {
      dc: projekte.filter(p => p.dcDate && days.includes(p.dcDate)).length,
      ac: projekte.filter(p => p.acDate && days.includes(p.acDate)).length,
      engel: projekte.filter(p => p.engelId && p.dcDate && days.includes(p.dcDate)).length,
    };
  }, [weekDays, projekte]);

  return (
    <div style={{minHeight:'100vh', background:C.bg, color:C.text, fontFamily:"'DM Sans',system-ui,sans-serif", display:'flex', flexDirection:'column', overflow:'hidden'}}>
      {/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <header style={{background:C.panel, borderBottom:`1px solid ${C.border}`, height:50, display:'flex', alignItems:'center', padding:'0 14px', gap:8, flexShrink:0, zIndex:100}}>
        <a href="index.html" style={{color:C.dim, fontSize:11, textDecoration:'none', marginRight:4}}>â† Launcher</a>
        <div style={{background:C.brand, color:C.bg, fontWeight:900, fontSize:13, padding:'3px 8px', borderRadius:5}}>bee-doo</div>
        <span style={{color:C.dim, fontSize:12, fontWeight:300, letterSpacing:'0.08em'}}>DISPATCH</span>
        <div style={{width:1, height:16, background:C.border, margin:'0 4px'}}/>

        {[['week','ğŸ“… Woche'],['month','ğŸ“† Monat'],['map','ğŸ—ºï¸ Karte'],['capacity','ğŸ“Š KapazitÃ¤t']].map(([k,l]) =>
          <button key={k} onClick={()=>setView(k)} style={{
            background:view===k?C.brand+'22':'transparent', color:view===k?C.brand:C.dim,
            border:`1px solid ${view===k?C.brand+'44':'transparent'}`, borderRadius:6, padding:'4px 12px', fontSize:12, cursor:'pointer', fontWeight:view===k?600:400
          }}>{l}</button>
        )}

        <div style={{flex:1}}/>

        {view==='week' && <>
          <div style={{display:'flex', alignItems:'center', gap:3, background:C.cardHover, borderRadius:7, padding:'2px 2px', border:`1px solid ${C.border}`}}>
            <SmBtn onClick={()=>setBaseDate(d=>{const n=new Date(d);n.setDate(n.getDate()-7);return n})}>â€¹</SmBtn>
            <span style={{fontSize:12, fontWeight:700, minWidth:62, textAlign:'center'}}>KW {getKW(baseDate)}</span>
            <SmBtn onClick={()=>setBaseDate(d=>{const n=new Date(d);n.setDate(n.getDate()+7);return n})}>â€º</SmBtn>
          </div>
          <button onClick={()=>setBaseDate(new Date('2026-02-23'))} style={{background:'none', border:`1px solid ${C.border}`, color:C.muted, borderRadius:5, padding:'3px 8px', fontSize:11, cursor:'pointer'}}>Heute</button>
        </>}

        <div style={{display:'flex', gap:8, fontSize:11}}>
          <Badge col={C.dc} label={`DC ${weekStats.dc}`}/>
          <Badge col={C.ac} label={`AC ${weekStats.ac}`}/>
          <Badge col={C.teal} label={`ğŸ•Šï¸ ${weekStats.engel}`}/>
        </div>
      </header>

      {/* â”€â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {alerts.length > 0 && (
        <div style={{background:'rgba(248,113,113,0.04)', borderBottom:`1px solid ${C.red}15`, padding:'4px 14px', display:'flex', gap:7, flexWrap:'wrap', alignItems:'center', flexShrink:0}}>
          <span style={{color:C.red, fontSize:10, fontWeight:800, letterSpacing:'0.06em'}}>ALERTS</span>
          {alerts.map((a,i) => {
            const col = a.type==='red'?C.red : a.type==='orange'?C.orange : a.type==='green'?C.green : a.type==='yellow'?C.yellow : C.dim;
            return <span key={i} style={{background:col+'12', color:col, border:`1px solid ${col}44`, borderRadius:4, padding:'1px 8px', fontSize:11}}>{a.msg}</span>;
          })}
        </div>
      )}

      {/* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div style={{flex:1, display:'flex', overflow:'hidden'}}>
        {/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <aside style={{width:240, background:C.panel, borderRight:`1px solid ${C.border}`, display:'flex', flexDirection:'column', flexShrink:0, overflow:'hidden'}}>
          <div style={{padding:'8px 10px', borderBottom:`1px solid ${C.border}`}}>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:4}}>
              <span style={{fontSize:10, fontWeight:800, color:C.dim, textTransform:'uppercase', letterSpacing:'0.08em'}}>Ungeplant</span>
              <CountBadge val={unplanned.length} col={unplanned.length>0?C.red:C.green}/>
            </div>
          </div>
          <div style={{flex:1, overflowY:'auto', padding:'6px 8px'}}>
            {unplanned.length===0 && partialPlanned.length===0 && (
              <div style={{textAlign:'center', color:C.muted, fontSize:12, paddingTop:28}}>âœ… Alle eingeplant!</div>
            )}
            {[...unplanned, ...partialPlanned].map(p => {
              const pt = PROJECT_TYPES[p.type];
              const kwpInfo = p.kwp > 0 ? ` Â· ${p.kwp} kWp` : '';
              const bigDC = p.kwp > 10;
              return (
                <div key={p.id} onClick={()=>setModal({type:'plan',proj:p})} style={{
                  background:C.cardHover, border:`1px solid ${p.priority==='high'?C.red:p.priority==='medium'?C.yellow:C.border}`,
                  borderLeft:`3px solid ${p.priority==='high'?C.red:p.priority==='medium'?C.yellow:C.green}`,
                  borderRadius:7, padding:'7px 9px', marginBottom:4, cursor:'pointer'
                }}>
                  <div style={{display:'flex', justifyContent:'space-between', marginBottom:2}}>
                    <span style={{fontSize:10, color:C.muted, fontWeight:600}}>{p.id}</span>
                    <span style={{fontSize:10, color:pt.color, background:pt.color+'15', borderRadius:3, padding:'0 4px', fontWeight:700}}>
                      {pt.icon} {pt.label}{kwpInfo}
                    </span>
                  </div>
                  <div style={{fontSize:12, fontWeight:700, color:C.text}}>{p.customer}</div>
                  <div style={{fontSize:11, color:C.dim}}>{p.plz} {p.city} Â· {p.address}</div>
                  {bigDC && <div style={{fontSize:9, color:C.orange, fontWeight:700, marginTop:3}}>âš¡ {p.kwp}kWp â†’ DC 2 Tage</div>}
                </div>
              );
            })}
          </div>
          <div style={{padding:'6px 8px', borderTop:`1px solid ${C.border}`}}>
            <div style={{fontSize:10, color:C.muted, marginBottom:4, textTransform:'uppercase', letterSpacing:'0.06em'}}>Monteure</div>
            <div style={{display:'flex', gap:3}}>
              {[['all','Alle'],['own','Eigene'],['sub','Subs']].map(([k,l]) =>
                <button key={k} onClick={()=>setMonteurFilter(k)} style={{
                  flex:1, background:monteurFilter===k?C.brand+'22':'transparent', color:monteurFilter===k?C.brand:C.dim,
                  border:`1px solid ${monteurFilter===k?C.brand+'44':C.border}`, borderRadius:5, padding:'4px 0', fontSize:10, cursor:'pointer', fontWeight:monteurFilter===k?700:400
                }}>{l}</button>
              )}
            </div>
          </div>
        </aside>

        {/* â”€â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <main style={{flex:1, overflow:'auto'}}>
          {view==='week' && <WeekView weekDays={weekDays} techs={filteredMonteure} engel={BAUENGEL}
            techSlots={techSlots} engelSlots={engelSlots} projekte={projekte}
            onCell={p => setModal({type:'plan', proj:p})} updateProject={updateProject}/>}
          {view==='map' && <MapView projekte={projekte}/>}
          {view==='capacity' && <CapacityView weekDays={weekDays} techs={filteredMonteure} engel={BAUENGEL} techSlots={techSlots} engelSlots={engelSlots} projekte={projekte}/>}
        </main>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEEK VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function WeekView({ weekDays, techs, engel, techSlots, engelSlots, projekte, onCell, updateProject }) {
  const colTemplate = '160px repeat(5,1fr)';

  // DCâ†’AC Verbindungslinien zeichnen
  // Wir nutzen SVG-Overlay
  const gridRef = useRef(null);
  const [connections, setConnections] = useState([]);

  // Verbindungen berechnen nach Render
  useEffect(() => {
    if(!gridRef.current) return;
    const timer = setTimeout(() => {
      const lines = [];
      projekte.forEach(p => {
        if(!p.dcDate || !p.acDate || !p.dcTechId || !p.acTechId) return;
        const dcEl = gridRef.current.querySelector(`[data-proj="${p.id}-dc"]`);
        const acEl = gridRef.current.querySelector(`[data-proj="${p.id}-ac"]`);
        if(dcEl && acEl) {
          const gridRect = gridRef.current.getBoundingClientRect();
          const dcRect = dcEl.getBoundingClientRect();
          const acRect = acEl.getBoundingClientRect();
          lines.push({
            id: p.id,
            x1: dcRect.right - gridRect.left,
            y1: dcRect.top + dcRect.height/2 - gridRect.top,
            x2: acRect.left - gridRect.left,
            y2: acRect.top + acRect.height/2 - gridRect.top,
            color: PROJECT_TYPES[p.type]?.color || C.dim,
          });
        }
      });
      setConnections(lines);
    }, 100);
    return () => clearTimeout(timer);
  }, [projekte, weekDays, techs]);

  return (
    <div ref={gridRef} style={{minWidth:820, position:'relative'}}>
      {/* SVG Verbindungslinien */}
      {connections.length > 0 && (
        <svg style={{position:'absolute', top:0, left:0, width:'100%', height:'100%', pointerEvents:'none', zIndex:5}}>
          {connections.map(c => (
            <line key={c.id} x1={c.x1} y1={c.y1} x2={c.x2} y2={c.y2}
              stroke={c.color} strokeWidth={1.5} strokeDasharray="4,3" opacity={0.5}/>
          ))}
        </svg>
      )}

      {/* Header */}
      <div style={{display:'grid', gridTemplateColumns:colTemplate, position:'sticky', top:0, zIndex:30, background:C.bg, height:56}}>
        <div style={{background:C.cardHover, borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'8px 10px'}}>
          <span style={{fontSize:10, color:C.muted, fontWeight:700, textTransform:'uppercase', letterSpacing:'0.06em'}}>Person</span>
        </div>
        {weekDays.map(wd => {
          const ds = fmtDate(wd);
          const w = getWeather(ds);
          const isToday = ds==='2026-02-23';
          return (
            <div key={ds} style={{background:isToday?C.brand+'0D':C.cardHover, borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'7px 10px', textAlign:'center'}}>
              <div style={{fontSize:13, fontWeight:isToday?800:500, color:isToday?C.brand:C.text}}>{fmtDay(wd)}</div>
              <div style={{marginTop:3, display:'flex', alignItems:'center', justifyContent:'center', gap:5}}>
                <span style={{fontSize:13}}>{w.icon}</span>
                <span style={{fontSize:11, fontWeight:600, color:w.warn?C.yellow:C.dim}}>{w.temp}Â°C</span>
                <span style={{fontSize:10, color:C.muted}}>{w.rain}%ğŸ’§</span>
                {w.warn && <span style={{background:C.yellow+'22', color:C.yellow, borderRadius:3, padding:'0 4px', fontSize:9, fontWeight:800}}>âš ï¸</span>}
              </div>
            </div>
          );
        })}
      </div>

      {/* Monteure Section Header */}
      <SectionHeader label="ğŸ‘· Monteure" count={techs.length} colTemplate={colTemplate}/>

      {/* Monteure Rows */}
      {techs.map(tech => (
        <div key={tech.id} style={{display:'grid', gridTemplateColumns:colTemplate}}>
          <PersonCell who={tech}/>
          {weekDays.map(wd => {
            const ds = fmtDate(wd);
            const key = `${tech.id}_${ds}`;
            const items = techSlots[key] || [];
            const full = items.length >= tech.cap;
            return (
              <div key={ds} style={{background:C.panel, borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'3px 3px', minHeight:80, position:'relative'}}>
                {items.map(({proj, phase}) => (
                  <ProjectCard key={`${proj.id}_${phase}`} proj={proj} phase={phase} onClick={()=>onCell(proj)} dataAttr={`${proj.id}-${phase.replace('_ext','')}`}/>
                ))}
                {full && <div style={{fontSize:9, color:C.red, textAlign:'center', fontWeight:700}}>â— VOLL</div>}
              </div>
            );
          })}
        </div>
      ))}

      {/* Bauengel Section Header */}
      <SectionHeader label="ğŸ•Šï¸ Bauengel" count={engel.length} colTemplate={colTemplate} color={C.teal}/>

      {/* Bauengel Rows */}
      {engel.map(e => (
        <div key={e.id} style={{display:'grid', gridTemplateColumns:colTemplate}}>
          <PersonCell who={e} isEngel/>
          {weekDays.map(wd => {
            const ds = fmtDate(wd);
            const key = `${e.id}_${ds}`;
            const items = engelSlots[key] || [];
            return (
              <div key={ds} style={{background:C.teal+'04', borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'3px 3px', minHeight:60, position:'relative'}}>
                {items.map(proj => (
                  <div key={proj.id} onClick={()=>onCell(proj)} style={{
                    background:C.teal+'10', border:`1px solid ${C.teal}44`, borderLeft:`3px solid ${C.teal}`,
                    borderRadius:5, padding:'4px 6px', marginBottom:3, cursor:'pointer'
                  }}>
                    <div style={{fontSize:10, fontWeight:700, color:C.teal}}>ğŸ•Šï¸ QS</div>
                    <div style={{fontSize:11, color:C.text, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{proj.customer}</div>
                    <div style={{fontSize:9, color:C.muted}}>{proj.plz} Â· {proj.id}</div>
                  </div>
                ))}
              </div>
            );
          })}
        </div>
      ))}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECT CARD (in Wochenansicht)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ProjectCard({ proj, phase, onClick, dataAttr }) {
  const pt = PROJECT_TYPES[proj.type];
  const isExt = phase.includes('ext');
  const phaseCol = isExt ? C.orange : phase==='dc' ? C.dc : phase==='ac' ? C.ac : C.teal;
  const phaseLabel = isExt ? `${phase.replace('_ext','').toUpperCase()}+` : phase.toUpperCase();

  // Status-Logik: Rot wenn Montage nicht gestartet, Orange wenn Bauengel fehlt, GrÃ¼n wenn beide da
  const bs = proj.baustelleStatus ? BSTATUS[proj.baustelleStatus] : null;

  // Animation bestimmen
  let cardAnimation = null;
  if(bs?.animation) cardAnimation = `${bs.animation} 1.2s ease-in-out infinite`;

  return (
    <div data-proj={dataAttr} onClick={onClick} style={{
      background:C.cardHover, border:`1px solid ${bs ? bs.col+'66' : phaseCol+'44'}`,
      borderLeft:`3px solid ${bs ? bs.col : phaseCol}`,
      borderRadius:5, padding:'3px 5px', marginBottom:3, cursor:'pointer', userSelect:'none', position:'relative',
      animation: cardAnimation,
    }}>
      {/* Kundenname (VOLL) + PLZ */}
      <div style={{fontSize:11, fontWeight:700, color:C.text, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>
        {proj.customer}
      </div>
      <div style={{display:'flex', gap:4, alignItems:'center', marginTop:1}}>
        <span style={{fontSize:9, color:C.dim}}>{proj.plz}</span>
        <span style={{fontSize:8, color:C.muted}}>Â·</span>
        <span style={{fontSize:8, color:C.muted}}>{proj.id}</span>
        {proj.kwp > 10 && <span style={{fontSize:8, color:C.orange, fontWeight:700}}>{proj.kwp}kWp</span>}
        {proj.fotoCount > 0 && <span style={{fontSize:8, color:C.blue}}>ğŸ“·{proj.fotoCount}</span>}
        <span style={{marginLeft:'auto', background:phaseCol+'22', color:phaseCol, borderRadius:3, padding:'0 4px', fontSize:8, fontWeight:800}}>{phaseLabel}</span>
      </div>

      {/* Baustellen-Status Badge(s) */}
      {bs && (
        <div style={{marginTop:3}}>
          {/* Wenn beide da: Zeige Startzeit + Engel-Ankunft */}
          {proj.baustelleStatus === 'beide_da' && (
            <div style={{display:'flex', gap:4, flexWrap:'wrap'}}>
              <StatusBadge col={C.green} label={`â–¶ Gestartet ${fmtTime(proj.montageStartedAt)||''}`} blink={false}/>
              <StatusBadge col={C.teal} label={`ğŸ•Šï¸ Engel ${fmtTime(proj.engelArrivedAt)||''}`} blink={false}/>
            </div>
          )}
          {/* Engel vor Ort aber Montage NICHT gestartet â†’ ROT blinkend */}
          {proj.baustelleStatus === 'engel_vor_ort' && (
            <div style={{display:'flex', gap:4, flexWrap:'wrap'}}>
              <StatusBadge col={C.red} label={`âš  Montage NICHT gestartet!`} blink/>
              <StatusBadge col={C.teal} label={`ğŸ•Šï¸ Engel ${fmtTime(proj.engelArrivedAt)||''}`} blink={false}/>
            </div>
          )}
          {/* Bauengel FEHLT â†’ ORANGE blinkend */}
          {proj.baustelleStatus === 'engel_fehlt' && (
            <div style={{display:'flex', gap:4, flexWrap:'wrap'}}>
              {proj.montageStartedAt && <StatusBadge col={C.green} label={`â–¶ ${fmtTime(proj.montageStartedAt)}`} blink={false}/>}
              <StatusBadge col={C.orange} label="Bauengel FEHLT!" blink/>
            </div>
          )}
          {/* Monteur nicht gestartet (und kein Engel) â†’ ROT */}
          {proj.baustelleStatus === 'monteur_nicht_gestartet' && (
            <StatusBadge col={C.red} label="Montage NICHT gestartet!" blink/>
          )}
          {/* Einfach gestartet */}
          {proj.baustelleStatus === 'gestartet' && (
            <StatusBadge col={C.green} label={`â–¶ Gestartet ${fmtTime(proj.montageStartedAt)||''}`} blink/>
          )}
        </div>
      )}
    </div>
  );
}

function StatusBadge({ col, label, blink }) {
  return (
    <div style={{
      display:'inline-flex', alignItems:'center', gap:3,
      background:col+'15', borderRadius:3, padding:'1px 5px',
      animation: blink ? `blink 0.8s ease-in-out infinite` : undefined,
    }}>
      <span style={{fontSize:8, color:col, fontWeight:700}}>{label}</span>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MapView({ projekte }) {
  const mapRef = useRef(null);
  const mapInstance = useRef(null);

  useEffect(() => {
    if(mapInstance.current) return;
    const map = L.map(mapRef.current, { zoomControl:true }).setView([51.75, 8.65], 9);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution:'&copy; OSM &copy; CARTO', maxZoom:19
    }).addTo(map);
    mapInstance.current = map;

    // Baustellen-Marker
    const todayProjects = projekte.filter(p => p.dcDate==='2026-02-23' && p.lat && p.lng);
    todayProjects.forEach(p => {
      const bs = p.baustelleStatus ? BSTATUS[p.baustelleStatus] : null;
      const col = bs ? bs.col : C.dim;
      const pulseClass = bs?.animation || '';

      // Custom marker with pulse
      const size = bs ? 18 : 12;
      const html = `<div style="
        width:${size}px;height:${size}px;border-radius:50%;
        background:${col};border:2px solid #fff;
        ${bs?.animation ? `box-shadow:0 0 12px ${col}aa;animation:${bs.animation} 1.2s ease-in-out infinite;` : ''}
      "></div>`;

      const icon = L.divIcon({ html, className:'', iconSize:[size,size], iconAnchor:[size/2,size/2] });
      const marker = L.marker([p.lat, p.lng], { icon }).addTo(map);

      // Popup
      const statusText = bs ? bs.label : 'Geplant';
      const times = [];
      if(p.montageStartedAt) times.push(`â–¶ Montage: ${fmtTime(p.montageStartedAt)}`);
      if(p.engelArrivedAt) times.push(`ğŸ•Šï¸ Engel: ${fmtTime(p.engelArrivedAt)}`);
      marker.bindPopup(`
        <div style="font-family:'DM Sans',sans-serif;color:#222;min-width:200px">
          <strong>${p.customer}</strong><br>
          <span style="color:#666">${p.plz} ${p.city} Â· ${p.address}</span><br>
          <span style="color:#666">${p.id} Â· ${PROJECT_TYPES[p.type]?.icon} ${PROJECT_TYPES[p.type]?.label}</span>
          ${p.kwp > 0 ? `<br><span style="color:#666">${p.kwp} kWp${p.kwp>10?' (2-Tage DC)':''}</span>` : ''}
          <hr style="border:0;border-top:1px solid #eee;margin:6px 0">
          <div style="color:${col};font-weight:700">${statusText}</div>
          ${times.map(t => `<div style="font-size:12px;color:#555">${t}</div>`).join('')}
        </div>
      `);
    });

    // DCâ†’AC Verbindungslinien auf Karte
    projekte.filter(p => p.dcDate && p.acDate && p.lat && p.lng).forEach(p => {
      // Leichte Verschiebung fÃ¼r AC (simuliert verschiedene Standorte - in echt wÃ¤re es gleich)
      // Hier zeigen wir die Verbindung als gestrichelte Linie
      if(p.dcDate !== p.acDate) {
        const pt = PROJECT_TYPES[p.type];
        // Gleicher Ort, aber sinnvoll mit Label
        L.circleMarker([p.lat, p.lng], {
          radius:22, color:pt?.color || C.dim, fillColor:'transparent',
          weight:1, dashArray:'4,4', opacity:0.3
        }).addTo(map).bindTooltip(`${p.customer} Â· DC ${fmtDay(p.dcDate)} â†’ AC ${fmtDay(p.acDate)}`, {className:'dark-tip'});
      }
    });

    // Fit bounds
    if(todayProjects.length > 0) {
      const bounds = todayProjects.map(p => [p.lat, p.lng]);
      map.fitBounds(bounds, { padding:[40,40], maxZoom:11 });
    }
  }, [projekte]);

  return (
    <div style={{height:'100%', position:'relative'}}>
      <div ref={mapRef} style={{height:'100%', width:'100%'}}/>
      {/* Legende */}
      <div style={{position:'absolute', bottom:20, left:20, background:C.panel+'ee', border:`1px solid ${C.border}`, borderRadius:8, padding:'10px 14px', zIndex:1000}}>
        <div style={{fontSize:10, color:C.dim, fontWeight:700, marginBottom:6}}>LIVE STATUS</div>
        {[
          [C.green, 'â— Montage + Engel âœ“'],
          [C.orange, 'â— Bauengel fehlt'],
          [C.red, 'â— Montage nicht gestartet'],
          [C.dim, 'â— Geplant (noch nicht heute)'],
        ].map(([col, label]) => (
          <div key={label} style={{display:'flex', alignItems:'center', gap:6, marginBottom:3}}>
            <div style={{width:10, height:10, borderRadius:'50%', background:col}}/>
            <span style={{fontSize:11, color:C.text}}>{label}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPACITY VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function CapacityView({ weekDays, techs, engel, techSlots, engelSlots, projekte }) {
  const stats = {
    all: projekte.length,
    fully: projekte.filter(p => p.status==='fully_planned').length,
    partial: projekte.filter(p => p.status==='dc_planned').length,
    unplanned: projekte.filter(p => p.status==='unplanned').length,
  };

  return (
    <div style={{padding:16, display:'grid', gridTemplateColumns:'1fr 1fr', gap:14}}>
      <div style={{gridColumn:'1/-1', display:'grid', gridTemplateColumns:'repeat(4,1fr)', gap:10}}>
        {[['Gesamt',stats.all,C.text],['VollstÃ¤ndig',stats.fully,C.green],['Nur DC',stats.partial,C.yellow],['Ungeplant',stats.unplanned,C.red]].map(([l,v,col]) =>
          <div key={l} style={{background:C.panel, border:`1px solid ${C.border}`, borderRadius:9, padding:'12px 14px'}}>
            <div style={{fontSize:11, color:C.dim, marginBottom:4}}>{l}</div>
            <div style={{fontSize:26, fontWeight:800, color:col}}>{v}</div>
          </div>
        )}
      </div>

      <div style={{background:C.panel, border:`1px solid ${C.border}`, borderRadius:10, padding:14}}>
        <div style={{fontSize:13, fontWeight:700, marginBottom:12}}>ğŸ‘· Monteur-Auslastung (KW)</div>
        {techs.map(t => {
          const load = weekDays.reduce((s,wd) => s + (techSlots[`${t.id}_${fmtDate(wd)}`]||[]).length, 0);
          const max = t.cap * weekDays.length;
          const pct = max>0 ? load/max*100 : 0;
          return (
            <div key={t.id} style={{marginBottom:8}}>
              <div style={{display:'flex', gap:6, alignItems:'center', marginBottom:2}}>
                <Avatar ini={t.ini} col={t.color} size={18}/>
                <span style={{fontSize:11, flex:1, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{t.name}</span>
                <span style={{fontSize:11, color:pct>=80?C.red:pct>=40?C.yellow:C.green, fontWeight:600}}>{pct.toFixed(0)}%</span>
              </div>
              <ProgressBar pct={pct}/>
            </div>
          );
        })}
      </div>

      <div style={{background:C.panel, border:`1px solid ${C.border}`, borderRadius:10, padding:14}}>
        <div style={{fontSize:13, fontWeight:700, marginBottom:12, color:C.teal}}>ğŸ•Šï¸ Bauengel-Auslastung (KW)</div>
        {engel.map(e => {
          const load = weekDays.reduce((s,wd) => s + (engelSlots[`${e.id}_${fmtDate(wd)}`]||[]).length, 0);
          const max = e.cap * weekDays.length;
          const pct = max>0 ? load/max*100 : 0;
          return (
            <div key={e.id} style={{marginBottom:8}}>
              <div style={{display:'flex', gap:6, alignItems:'center', marginBottom:2}}>
                <Avatar ini={e.ini} col={C.teal} size={18}/>
                <span style={{fontSize:11, flex:1}}>{e.name}</span>
                <span style={{fontSize:11, color:pct>=80?C.red:pct>=40?C.yellow:C.teal, fontWeight:600}}>{pct.toFixed(0)}%</span>
              </div>
              <ProgressBar pct={pct} color={C.teal}/>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED COMPONENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SectionHeader({ label, count, colTemplate, color=C.dim }) {
  return (
    <div style={{display:'grid', gridTemplateColumns:colTemplate, position:'sticky', top:56, zIndex:20, background:C.bg}}>
      <div style={{borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'4px 10px', display:'flex', gap:6, alignItems:'center', background:'rgba(0,0,0,0.5)'}}>
        <span style={{fontSize:10, fontWeight:800, color, textTransform:'uppercase', letterSpacing:'0.08em'}}>{label}</span>
        <span style={{background:color+'22', color, borderRadius:4, padding:'0 5px', fontSize:10, fontWeight:700}}>{count}</span>
      </div>
      {Array.from({length:5}).map((_,i) =>
        <div key={i} style={{borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, background:'rgba(0,0,0,0.5)'}}/>
      )}
    </div>
  );
}

function PersonCell({ who, isEngel=false }) {
  return (
    <div style={{background:C.cardHover, borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'7px 9px', display:'flex', flexDirection:'column', gap:4}}>
      <div style={{display:'flex', alignItems:'center', gap:6}}>
        <Avatar ini={who.ini} col={who.color || C.dim}/>
        <div style={{minWidth:0}}>
          <div style={{fontSize:11, fontWeight:700, color:C.text, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{who.name}</div>
          <div style={{fontSize:9, color:C.muted}}>{who.region}{who.sub?' Â· SU':''}{isEngel?' Â· ğŸ•Šï¸':''}</div>
        </div>
      </div>
      {!isEngel && who.skills && (
        <div style={{display:'flex', gap:2, flexWrap:'wrap'}}>
          {who.skills.map(s => {
            const pt = Object.values(PROJECT_TYPES).find((_,i) => Object.keys(PROJECT_TYPES)[i]===s) || {};
            const col = PROJECT_TYPES[s]?.color || C.muted;
            return <span key={s} style={{background:col+'18', color:col, borderRadius:3, padding:'1px 3px', fontSize:8, fontWeight:700}}>{s.replace('pv_','').replace('_',' ').toUpperCase()}</span>;
          })}
        </div>
      )}
    </div>
  );
}

function Avatar({ ini, col, size=26 }) {
  return (
    <div style={{width:size, height:size, borderRadius:'50%', flexShrink:0, background:(col||C.dim)+'20', color:col||C.dim, display:'flex', alignItems:'center', justifyContent:'center', fontSize:size*0.35, fontWeight:800, border:`1px solid ${col||C.dim}30`}}>{ini}</div>
  );
}

function Badge({ col, label }) {
  return <div style={{background:col+'15', color:col, borderRadius:4, padding:'2px 8px', fontSize:11, fontWeight:700}}>{label}</div>;
}

function CountBadge({ val, col }) {
  return <div style={{background:col+'25', color:col, borderRadius:4, padding:'0 7px', fontSize:11, fontWeight:700}}>{val}</div>;
}

function SmBtn({ onClick, children }) {
  return <button onClick={onClick} style={{background:'none', border:'none', color:C.dim, cursor:'pointer', padding:'3px 8px', fontSize:14}}>{children}</button>;
}

function ProgressBar({ pct, color }) {
  const col = color || (pct>=80 ? C.red : pct>=40 ? C.yellow : C.green);
  return (
    <div style={{height:4, background:C.cardHover, borderRadius:2, overflow:'hidden'}}>
      <div style={{height:'100%', background:col, width:`${Math.min(pct,100)}%`, borderRadius:2, transition:'width 0.4s'}}/>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rootEl = ReactDOM.createRoot(document.getElementById('root'));
rootEl.render(<DispatchApp/>);
</script>
</body>
</html>
