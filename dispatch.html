<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>bee-doo DISPATCH</title>
<script src="config.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.2/babel.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { background: #0B0D12; font-family: 'DM Sans', system-ui, sans-serif; color: #E4E5EB; -webkit-font-smoothing: antialiased; overflow: hidden; height: 100vh; }
#root { height: 100vh; display: flex; flex-direction: column; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
@keyframes pulse-green { 0%,100%{box-shadow:0 0 8px rgba(34,197,94,0.7),0 0 20px rgba(34,197,94,0.3)} 50%{box-shadow:0 0 3px rgba(34,197,94,0.2)} }
@keyframes pulse-orange { 0%,100%{box-shadow:0 0 8px rgba(251,191,36,0.7),0 0 20px rgba(251,191,36,0.3)} 50%{box-shadow:0 0 3px rgba(251,191,36,0.2)} }
@keyframes pulse-red { 0%,100%{box-shadow:0 0 10px rgba(248,113,113,0.7),0 0 24px rgba(248,113,113,0.3);border-color:rgba(248,113,113,0.8)} 50%{box-shadow:0 0 3px rgba(248,113,113,0.2);border-color:rgba(248,113,113,0.3)} }
@keyframes pulse-red-badge { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.96)} }
@keyframes pulse-incomplete { 0%,100%{box-shadow:0 0 8px rgba(255,140,66,0.6),0 0 18px rgba(255,140,66,0.2);border-color:rgba(255,140,66,0.7)} 50%{box-shadow:0 0 2px rgba(255,140,66,0.15);border-color:rgba(255,140,66,0.25)} }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: #14171F; }
::-webkit-scrollbar-thumb { background: #232738; border-radius: 3px; }
button, select, input { font-family: 'DM Sans', system-ui, sans-serif; }
.leaflet-container { background: #14171F !important; }
</style>

<style>

/* â•â•â• bee-doo Responsive + Lesbarkeit Fix â•â•â• */

/* === LESBARKEIT: Schriften aufhellen === */
/* Zu dunkle GrautÃ¶ne auf Dark Theme aufhellen */
body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

/* === TABLET (768px) === */
@media (max-width: 768px) {
  /* Grid â†’ weniger Spalten */
  [style*="grid-template-columns"][style*="repeat"] { 
    grid-template-columns: repeat(2, 1fr) !important; 
  }
  [style*="gridTemplateColumns"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* Flex-Container wrappen */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'], [style*="display:'flex'"] {
    flex-wrap: wrap !important;
  }
  /* Ausnahme: Nav-Items und kleine Icon-Rows nicht wrappen */
  [style*="align-items:center"][style*="gap:4px"],
  [style*="alignItems:"center""][style*="gap:"4px""] {
    flex-wrap: nowrap !important;
  }
  
  /* Sidebar verkleinern */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'] {
    width: 200px !important;
    min-width: 200px !important;
  }
  
  /* Modals nicht breiter als Screen */
  .modal, [style*="width:480px"], [style*="width:520px"], [style*="width:560px"],
  [style*="width:600px"], [style*="width:640px"], [style*="width:700px"] {
    width: 95vw !important;
    max-width: 95vw !important;
  }
  
  /* Padding reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"] {
    padding: 20px !important;
  }
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"] {
    padding: 20px !important;
  }
  
  /* Tabellen scrollbar */
  table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  
  /* Font-Size Minimum */
  * { min-height: 0; }
}

/* === MOBILE (480px) === */
@media (max-width: 480px) {
  /* Grid â†’ 1 Spalte */
  [style*="grid-template-columns"], [style*="gridTemplateColumns"] { 
    grid-template-columns: 1fr !important; 
  }
  .grid { grid-template-columns: 1fr !important; }
  
  /* Sidebar ausblenden oder collapsieren */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*="width:200px"], [style*="width: 200px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'],
  [style*='width:"200px"'] {
    position: fixed !important;
    left: -300px !important;
    z-index: 999 !important;
    transition: left 0.3s ease !important;
    width: 260px !important;
    height: 100vh !important;
    top: 0 !important;
  }
  
  /* Alle Flex-Container stacken */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'] {
    flex-wrap: wrap !important;
  }
  [style*="flex-direction:row"], [style*="flexDirection:"row""],
  [style*="flex-direction: row"] {
    flex-direction: column !important;
  }
  
  /* Form-Elemente full width */
  input, select, textarea, .input-field {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    font-size: 16px !important; /* Prevents iOS zoom */
  }
  
  /* Buttons touch-friendly */
  button, .btn-primary, .btn-secondary, [role="button"] {
    min-height: 44px !important;
    min-width: 44px !important;
    font-size: 14px !important;
  }
  
  /* Padding stark reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"],
  [style*="padding:28px"], [style*="padding:24px"],
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"],
  [style*="padding: 28px"], [style*="padding: 24px"] {
    padding: 12px !important;
  }
  
  /* Gap reduzieren */
  [style*="gap:24px"], [style*="gap:20px"], [style*="gap:28px"],
  [style*="gap: 24px"], [style*="gap: 20px"], [style*="gap: 28px"] {
    gap: 12px !important;
  }
  
  /* Font sizes - minimum 12px */
  [style*="font-size:8px"], [style*="font-size:9px"], [style*="font-size:10px"],
  [style*="font-size: 8px"], [style*="font-size: 9px"], [style*="font-size: 10px"],
  [style*="fontSize:8px"], [style*="fontSize:9px"], [style*="fontSize:10px"],
  [style*='fontSize:"8px"'], [style*='fontSize:"9px"'], [style*='fontSize:"10px"'] {
    font-size: 12px !important;
  }
  
  /* Bilder responsive */
  img { max-width: 100% !important; height: auto !important; }
  
  /* Fixed elements repositionieren */
  [style*="position:fixed"][style*="top:12px"][style*="left:12px"],
  [style*="position: fixed"][style*="top: 12px"][style*="left: 12px"] {
    top: 6px !important;
    left: 6px !important;
    font-size: 11px !important;
    padding: 4px 8px !important;
  }
  
  /* Logo kleiner */
  .logo { font-size: 32px !important; }
  
  /* Text wrap erzwingen */
  * { word-wrap: break-word !important; overflow-wrap: break-word !important; }
  [style*="white-space:nowrap"], [style*="white-space: nowrap"],
  [style*='whiteSpace:"nowrap"'] {
    white-space: normal !important;
  }
  
  /* Modals full width */
  .modal, [class*="modal"], [style*="width:480px"], [style*="width:520px"],
  [style*="width:560px"], [style*="width:600px"] {
    width: 96vw !important;
    max-width: 96vw !important;
    padding: 16px !important;
    margin: 8px !important;
  }
  
  /* Map containers */
  #map, .leaflet-container, [style*="height:100vh"] {
    height: calc(100vh - 60px) !important;
  }
  .map-toolbar {
    flex-direction: column !important;
    top: 6px !important;
    left: 6px !important;
    right: 6px !important;
  }
  .map-tool-btn {
    font-size: 11px !important;
    padding: 5px 10px !important;
  }
}

/* â•â•â• Lesbarkeit: Zu dunkle Farben aufhellen â•â•â• */
/* #0c1222 backgrounds â†’ Schrift mindestens #8b95a5 */
[style*="color:#0c1222"], [style*="color: #0c1222"] { color: #8b95a5 !important; }
[style*="color:#151d30"], [style*="color: #151d30"] { color: #8b95a5 !important; }
[style*="color:#263354"], [style*="color: #263354"] { color: #7a8baa !important; }
[style*="color:#1c2640"], [style*="color: #1c2640"] { color: #8b95a5 !important; }
[style*="color:#334155"], [style*="color: #334155"] { color: #8b95a5 !important; }
[style*="color:#252530"], [style*="color: #252530"] { color: #8b95a5 !important; }
[style*='color:"#0c1222"'] { color: #8b95a5 !important; }
[style*='color:"#151d30"'] { color: #8b95a5 !important; }
[style*='color:"#263354"'] { color: #7a8baa !important; }
[style*='color:"#1c2640"'] { color: #8b95a5 !important; }
[style*='color:"#334155"'] { color: #8b95a5 !important; }
[style*='color:"#252530"'] { color: #8b95a5 !important; }

/* GrÃ¼ntÃ¶ne auf Dark besser lesbar machen */
[style*="color:#166534"], [style*="color: #166534"] { color: #34d399 !important; }
[style*='color:"#166534"'] { color: #34d399 !important; }

/* Generell: Alle font-sizes unter 10px auf mindestens 11px */

/* dispatch.html specific */
img { max-width: 100%; height: auto; }
@media (max-width: 480px) {
  .leaflet-container { height: 250px !important; }
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// bee-doo DISPATCH v2 â€“ Complete Rewrite
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const { useState, useEffect, useMemo, useCallback, useRef } = React;

// â”€â”€â”€ COLORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const C = {
  brand: '#F5C500', bg: '#0B0D12', panel: '#0F1118', card: '#14171F',
  cardHover: '#1A1D28', border: '#232738', text: '#E4E5EB', dim: '#9BA1B8',
  muted: '#6B7194', green: '#22c55e', yellow: '#FBBF24', red: '#F87171',
  blue: '#60A5FA', purple: '#A78BFA', teal: '#2DD4BF', pink: '#F472B6',
  orange: '#FF8C42', dc: '#FBBF24', ac: '#60A5FA',
};

// â”€â”€â”€ PROJECT TYPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROJECT_TYPES = {
  pv_komplett: { label:'PV Komplett', icon:'â˜€ï¸', color:C.brand, twoDay:true, dcTag:'Dach + DC', acTag:'AC + IBN', dcSkill:'pv_dach', acSkill:'pv_elek', dcDur:7, acDur:6 },
  pv_dach:     { label:'PV Dach',     icon:'ğŸ ', color:C.yellow, twoDay:false, dcTag:'Dachmontage', acTag:null, dcSkill:'pv_dach', acSkill:null, dcDur:7, acDur:0 },
  pv_elek:     { label:'PV Elektro',  icon:'âš¡', color:C.blue,   twoDay:false, dcTag:null, acTag:'AC + IBN', dcSkill:null, acSkill:'pv_elek', dcDur:0, acDur:6 },
  wp_komplett: { label:'WÃ¤rmepumpe',  icon:'ğŸŒ¡ï¸', color:C.purple, twoDay:true, dcTag:'Installation', acTag:'IBN + HZ', dcSkill:'wp', acSkill:'wp', dcDur:8, acDur:5 },
  speicher:    { label:'Speicher',    icon:'ğŸ”‹', color:C.green,  twoDay:false, dcTag:'Speicher', acTag:null, dcSkill:'speicher', acSkill:null, dcDur:3, acDur:0 },
  wallbox:     { label:'Wallbox',     icon:'ğŸš—', color:C.teal,   twoDay:false, dcTag:'Wallbox', acTag:null, dcSkill:'pv_elek', acSkill:null, dcDur:2, acDur:0 },
};

// â”€â”€â”€ MONTEURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTEURE = [
  { id:1,  name:'Klaus Maier',    ini:'KM', skills:['pv_dach'],            region:'Bielefeld', plz:'33602', cap:1, color:C.yellow, foto:'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=80&h=80&fit=crop&crop=face' },
  { id:2,  name:'Peter Schmidt',  ini:'PS', skills:['wp'],                 region:'OWL',       plz:'33330', cap:1, color:C.purple, foto:'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=80&h=80&fit=crop&crop=face' },
  { id:3,  name:'Thomas Weber',   ini:'TW', skills:['pv_dach','wp'],       region:'GÃ¼tersloh', plz:'33330', cap:1, color:C.brand, foto:'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=80&h=80&fit=crop&crop=face' },
  { id:4,  name:'Andreas MÃ¼ller', ini:'AM', skills:['pv_elek','wallbox'],  region:'Paderborn', plz:'33098', cap:1, color:C.blue, foto:'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=80&h=80&fit=crop&crop=face' },
  { id:5,  name:'Stefan Koch',    ini:'SK', skills:['pv_dach','pv_elek'],  region:'Herford',   plz:'32049', cap:2, color:C.green, foto:'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=80&h=80&fit=crop&crop=face' },
  { id:6,  name:'Michael Bauer',  ini:'MB', skills:['wp'],                 region:'Minden',    plz:'32423', cap:1, color:C.pink, foto:'https://images.unsplash.com/photo-1463453091185-61582044d556?w=80&h=80&fit=crop&crop=face' },
  { id:7,  name:'JÃ¶rg Fischer',   ini:'JF', skills:['pv_dach'],            region:'Detmold',   plz:'32756', cap:1, color:C.yellow, foto:'https://images.unsplash.com/photo-1504257432389-52343af06ae3?w=80&h=80&fit=crop&crop=face' },
  { id:8,  name:'Ralf Zimmermann',ini:'RZ', skills:['pv_elek','speicher'], region:'Bielefeld', plz:'33604', cap:1, color:C.blue, foto:'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=80&h=80&fit=crop&crop=face' },
  { id:9,  name:'Frank Schulz',   ini:'FS', skills:['pv_dach','pv_elek'],  region:'GÃ¼tersloh', plz:'33334', cap:1, color:C.yellow, foto:'https://images.unsplash.com/photo-1492562080023-ab3db95bfbce?w=80&h=80&fit=crop&crop=face' },
  { id:10, name:'Uwe Braun',      ini:'UB', skills:['wp','speicher'],      region:'Herford',   plz:'32052', cap:1, color:C.purple, foto:'https://images.unsplash.com/photo-1508341591423-4347099e1f19?w=80&h=80&fit=crop&crop=face' },
  { id:11, name:'Markus Krause',  ini:'MK', skills:['pv_dach','pv_elek'],  region:'Bielefeld', plz:'33607', cap:1, color:C.teal, foto:'https://images.unsplash.com/photo-1548372290-8d01b6c8e78c?w=80&h=80&fit=crop&crop=face' },
  { id:12, name:'Dirk Hoffmann',  ini:'DH', skills:['pv_elek','speicher','wallbox'], region:'Paderborn', plz:'33100', cap:1, color:C.teal, foto:'https://images.unsplash.com/photo-1568602471122-7832951cc4c5?w=80&h=80&fit=crop&crop=face' },
  { id:13, name:'SU: Dachtechnik West', ini:'DW', skills:['pv_dach'],      region:'OWL',       plz:'33602', cap:3, color:C.yellow, sub:true },
  { id:14, name:'SU: WP Service OWL',   ini:'WO', skills:['wp','speicher'],region:'OWL',       plz:'33330', cap:3, color:C.purple, sub:true },
  { id:15, name:'SU: Elektro Nord',     ini:'EN', skills:['pv_elek','wallbox'], region:'Bielefeld', plz:'33602', cap:3, color:C.blue, sub:true },
  { id:16, name:'SU: Allround Pro',     ini:'AP', skills:['pv_dach','pv_elek'], region:'Paderborn', plz:'33098', cap:2, color:C.green, sub:true },
  { id:17, name:'Lars Neumann',   ini:'LN', skills:['pv_dach','pv_elek'],  region:'Minden',    plz:'32427', cap:1, color:C.yellow, foto:'https://images.unsplash.com/photo-1531891437562-4301cf35b7e4?w=80&h=80&fit=crop&crop=face' },
  { id:18, name:'Dennis Wolf',    ini:'DW2',skills:['wp','wallbox'],        region:'Detmold',   plz:'32756', cap:1, color:C.pink, foto:'https://images.unsplash.com/photo-1557862921-37829c790f19?w=80&h=80&fit=crop&crop=face' },
];

// â”€â”€â”€ BAUENGEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BAUENGEL = [
  { id:101, name:'Sandra Vogel',   ini:'SV', region:'Bielefeld', plz:'33602', cap:2, color:C.teal, foto:'https://images.unsplash.com/photo-1580489944761-15a19d654956?w=80&h=80&fit=crop&crop=face' },
  { id:102, name:'Marco Heinz',    ini:'MH', region:'GÃ¼tersloh', plz:'33330', cap:2, color:C.pink, foto:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=80&h=80&fit=crop&crop=face' },
  { id:103, name:'Julia Kramer',   ini:'JK', region:'OWL',       plz:'33604', cap:2, color:C.purple, foto:'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=80&h=80&fit=crop&crop=face' },
  { id:104, name:'Tobias Lange',   ini:'TL', region:'Paderborn', plz:'33098', cap:2, color:C.blue, foto:'https://images.unsplash.com/photo-1507591064344-4c6ce005b128?w=80&h=80&fit=crop&crop=face' },
  { id:105, name:'Sina Roth',      ini:'SR', region:'Herford',   plz:'32049', cap:2, color:C.green, foto:'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=80&h=80&fit=crop&crop=face' },
  { id:106, name:'Ben Schreiber',  ini:'BS', region:'Minden',    plz:'32423', cap:2, color:C.yellow, foto:'https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?w=80&h=80&fit=crop&crop=face' },
];

// â”€â”€â”€ PLZ â†’ Region Mapping fÃ¼r Entfernungsberechnung â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PLZ_COORDS = {
  '33602':[51.532,8.533],'33604':[51.525,8.540],'33607':[51.538,8.520],'33609':[51.542,8.538],
  '33330':[51.907,8.379],'33334':[51.910,8.390],
  '33098':[51.719,8.754],'33100':[51.722,8.748],'33102':[51.715,8.760],
  '32049':[52.114,8.673],'32052':[52.118,8.680],
  '32423':[52.289,8.917],'32427':[52.295,8.920],
  '32756':[51.936,8.879],
};
const plzDist = (a,b) => {
  const ca = PLZ_COORDS[a], cb = PLZ_COORDS[b];
  if(!ca||!cb) return 999;
  const R=6371, dLat=(cb[0]-ca[0])*Math.PI/180, dLon=(cb[1]-ca[1])*Math.PI/180;
  const x = Math.sin(dLat/2)**2 + Math.cos(ca[0]*Math.PI/180)*Math.cos(cb[0]*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
};

// â”€â”€â”€ INNENDIENST-PLANER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PLANER = [
  { id:201, name:'Lisa Meier', ini:'LM', role:'Anlagenplanung' },
  { id:202, name:'Tim Becker', ini:'TB', role:'Anlagenplanung' },
  { id:203, name:'Anna SchrÃ¶der', ini:'AS', role:'WP-Planung' },
];

// â”€â”€â”€ BAUFORTSCHRITT-SCHRITTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DC_STEPS = [
  { key:'geruest', label:'GerÃ¼st aufgebaut', icon:'ğŸ—ï¸' },
  { key:'uk', label:'Unterkonstruktion montiert', icon:'ğŸ”©' },
  { key:'module', label:'Module gelegt', icon:'â—»ï¸' },
  { key:'verkabelung_dc', label:'DC-Verkabelung', icon:'ğŸ”Œ' },
  { key:'dc_fertig', label:'DC fertig', icon:'âœ…' },
];
const AC_STEPS = [
  { key:'wr_montiert', label:'Wechselrichter montiert', icon:'âš¡' },
  { key:'ac_verkabelung', label:'AC-Verkabelung', icon:'ğŸ”Œ' },
  { key:'zaehler', label:'ZÃ¤hlerplatz vorbereitet', icon:'ğŸ“Š' },
  { key:'ibn', label:'Inbetriebnahme', icon:'â–¶ï¸' },
  { key:'ac_fertig', label:'AC fertig', icon:'âœ…' },
];
const WP_DC_STEPS = [
  { key:'fundament', label:'Fundament gegossen', icon:'ğŸ§±' },
  { key:'wp_aufgestellt', label:'WÃ¤rmepumpe aufgestellt', icon:'ğŸŒ¡ï¸' },
  { key:'verrohrung', label:'Verrohrung', icon:'ğŸ”§' },
  { key:'dc_fertig', label:'Installation fertig', icon:'âœ…' },
];
const WP_AC_STEPS = [
  { key:'elek_anschluss', label:'Elektrischer Anschluss', icon:'âš¡' },
  { key:'ibn_hz', label:'IBN + Heizungsabgleich', icon:'ğŸŒ¡ï¸' },
  { key:'ac_fertig', label:'AC fertig', icon:'âœ…' },
];
const RAW_PROJECTS = [
  ['Axel Reinhardt',      'Hauptstr. 12',    '33602','Bielefeld',  'pv_komplett', 9.8,  51.532, 8.533],
  ['Carmen BÃ¶hm',         'Berliner Str. 45','33604','Bielefeld',  'pv_komplett', 12.5, 51.525, 8.540],
  ['Werner SchÃ¤fer',      'Bahnhofstr. 8',   '33330','GÃ¼tersloh',  'wp_komplett', 0,    51.907, 8.379],
  ['Brigitte Klein',      'Kirchweg 22',     '33098','Paderborn',  'pv_komplett', 8.4,  51.719, 8.754],
  ['Horst Richter',       'Feldstr. 7',      '32049','Herford',    'pv_komplett', 14.7, 52.114, 8.673],
  ['Elke Vogel',          'Gartenstr. 15',   '32423','Minden',     'wallbox',     0,    52.289, 8.917],
  ['Bernd Hartmann',      'Lindenallee 3',   '32756','Detmold',    'pv_komplett', 7.2,  51.936, 8.879],
  ['Monika Braun',        'Am Park 11',      '33602','Bielefeld',  'speicher',    0,    51.530, 8.528],
  ['GÃ¼nter Lehmann',      'Waldweg 19',      '33334','GÃ¼tersloh',  'pv_komplett', 11.3, 51.910, 8.390],
  ['Sabine KÃ¶hler',       'MÃ¼hlenstr. 6',    '33102','Paderborn',  'wp_komplett', 0,    51.715, 8.760],
  ['Rainer Schwarz',      'Bergstr. 28',     '32052','Herford',    'pv_komplett', 6.9,  52.118, 8.680],
  ['Petra Engel',         'Parkstr. 4',      '32427','Minden',     'pv_komplett', 15.2, 52.295, 8.920],
  ['Hans-Georg Pfeiffer', 'Schillerstr. 9',  '33607','Bielefeld',  'wp_komplett', 0,    51.538, 8.520],
  ['Ursula Fuchs',        'Goethestr. 17',   '33334','GÃ¼tersloh',  'speicher',    0,    51.905, 8.385],
  ['Karl-Heinz Mayer',    'Mozartstr. 3',    '33100','Paderborn',  'pv_komplett', 10.5, 51.722, 8.748],
  ['Rosemarie Brandt',    'Rosengasse 5',    '32049','Herford',    'pv_dach',     0,    52.110, 8.670],
  ['Wolfgang Schneider',  'Kaiserstr. 22',   '32423','Minden',     'pv_komplett', 13.8, 52.292, 8.912],
  ['Inge Steinmetz',      'Fichtenweg 8',    '32756','Detmold',    'wp_komplett', 0,    51.940, 8.882],
  ['Manfred Kruse',       'Eichenallee 14',  '33609','Bielefeld',  'pv_komplett', 8.1,  51.542, 8.538],
  ['Hildegard Tietze',    'Birkenstr. 31',   '33330','GÃ¼tersloh',  'wallbox',     0,    51.912, 8.375],
];

const ROOF_TYPES = ['Ziegeldach 38Â°','Blechdach 15Â°','Flachdach EPDM','Biberschwanz 42Â°','Schieferdach 35Â°'];
const PRIORITIES = ['high','high','medium','medium','medium','low'];
const BAU_FOTOS = [
  'https://images.unsplash.com/photo-1509391366360-2e959784a276?w=300&h=180&fit=crop',
  'https://images.unsplash.com/photo-1508514177221-188b1cf16e9d?w=300&h=180&fit=crop',
  'https://images.unsplash.com/photo-1559302504-64aae6ca6b6d?w=300&h=180&fit=crop',
  'https://images.unsplash.com/photo-1611365892117-00ac6fb8bc34?w=300&h=180&fit=crop',
  'https://images.unsplash.com/photo-1613665813446-82a78c468a1d?w=300&h=180&fit=crop',
  'https://images.unsplash.com/photo-1558618666-fcd25c85f82e?w=300&h=180&fit=crop',
  'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=300&h=180&fit=crop',
  'https://images.unsplash.com/photo-1497440001374-f26997328c1b?w=300&h=180&fit=crop',
];

function buildProjects() {
  return RAW_PROJECTS.map((p, i) => {
    const kwp = p[5];
    const pt = PROJECT_TYPES[p[4]];
    // >10kW â†’ DC dauert 2 Tage
    const dcDuration = kwp > 10 ? 2 : (pt.dcDur ? 1 : 0);
    return {
      id: `P-2026-${String(i+1).padStart(3,'0')}`,
      type: p[4], customer: p[0], address: p[1], plz: p[2], city: p[3],
      kwp, lat: p[6], lng: p[7],
      priority: PRIORITIES[i % PRIORITIES.length],
      notes: (p[4]==='pv_komplett'||p[4]==='pv_dach') ? ROOF_TYPES[i%ROOF_TYPES.length] : '',
      bauFoto: BAU_FOTOS[i % BAU_FOTOS.length],
      dcDate:null, dcTechId:null, dcExtraDates:[], dcDuration,
      acDate:null, acTechId:null, acExtraDates:[],
      engelId:null, status:'unplanned',
      planerId: PLANER[i % PLANER.length].id,
      // Baufortschritt
      dcProgress: [], // z.B. [{step:'geruest',at:'2026-02-23T08:30:00',foto:true},{step:'uk',at:'...',foto:false}]
      acProgress: [],
      // Baustellen-Live-Status
      baustelleStatus: null, // 'gestartet','engel_vor_ort','engel_fehlt','monteur_spaet','beide_da','dc_fertig','ac_fertig','abgenommen'
      montageStartedAt: null,
      engelArrivedAt: null,
      fotoCount: 0,
      letzteAktualisierung: null,
    };
  });
}

// â”€â”€â”€ DEMO-STATUS auf Projekte anwenden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyDemoStatus(projects) {
  const demos = [
    // P-001: Axel Reinhardt â€“ Montage gestartet + Bauengel vor Ort = GRÃœN
    { id:'P-2026-001', dcDate:'2026-02-23', dcTechId:1, acDate:'2026-02-24', acTechId:4,
      engelId:101, planerId:201, status:'fully_planned', baustelleStatus:'beide_da',
      montageStartedAt:'2026-02-23T07:45:00', engelArrivedAt:'2026-02-23T08:02:00',
      fotoCount:4, letzteAktualisierung:'2026-02-23T09:12:00',
      dcProgress:[
        {step:'geruest',at:'2026-02-23T08:15:00',foto:'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=200&h=120&fit=crop'},
        {step:'uk',at:'2026-02-23T09:00:00',foto:'https://images.unsplash.com/photo-1558618666-fcd25c85f82e?w=200&h=120&fit=crop'},
      ],
      acProgress:[] },
    // P-002: Carmen BÃ¶hm (12.5kWp â†’ 2-Tage DC) â€“ Bauengel vor Ort, Montage NICHT gestartet = ROT
    { id:'P-2026-002', dcDate:'2026-02-23', dcTechId:5, dcDuration:2, acDate:'2026-02-25', acTechId:8,
      engelId:102, planerId:202, status:'fully_planned', baustelleStatus:'engel_vor_ort',
      montageStartedAt:null, engelArrivedAt:'2026-02-23T08:15:00',
      fotoCount:2, letzteAktualisierung:'2026-02-23T08:55:00',
      dcProgress:[],
      acProgress:[] },
    // P-003: Werner SchÃ¤fer â€“ Montage gestartet, Bauengel FEHLT = ORANGE
    { id:'P-2026-003', dcDate:'2026-02-23', dcTechId:2, acDate:'2026-02-24', acTechId:10,
      engelId:null, planerId:203, status:'dc_planned', baustelleStatus:'engel_fehlt',
      montageStartedAt:'2026-02-23T07:55:00', engelArrivedAt:null,
      fotoCount:1, letzteAktualisierung:'2026-02-23T08:02:00',
      dcProgress:[
        {step:'fundament',at:'2026-02-23T08:00:00',foto:'https://images.unsplash.com/photo-1513467535987-fd81bc7d62f8?w=200&h=120&fit=crop'},
      ],
      acProgress:[] },
    // P-004: Brigitte Klein â€“ NUR DC geplant, AC fehlt noch â†’ BLINKT
    { id:'P-2026-004', dcDate:'2026-02-25', dcTechId:3, acDate:null, acTechId:null,
      engelId:104, planerId:201, status:'dc_planned',
      dcProgress:[],
      acProgress:[] },
    // P-005: Horst Richter (14.7kWp â†’ 2-Tage DC) â€“ geplant Do+Fr
    { id:'P-2026-005', dcDate:'2026-02-26', dcTechId:7, dcDuration:2, acDate:'2026-02-28', acTechId:9,
      engelId:101, planerId:202, status:'fully_planned',
      dcProgress:[],
      acProgress:[] },
    // P-006: Elke Vogel â€“ DC lÃ¤uft, AC hat auch schon Fortschritt (WR montiert)
    { id:'P-2026-006', dcDate:'2026-02-23', dcTechId:13, acDate:'2026-02-25', acTechId:15,
      engelId:102, planerId:201, status:'fully_planned', baustelleStatus:'monteur_nicht_gestartet',
      montageStartedAt:null, engelArrivedAt:null,
      fotoCount:0, letzteAktualisierung:null,
      dcProgress:[],
      acProgress:[] },
  ];
  return projects.map(p => {
    const d = demos.find(x => x.id === p.id);
    return d ? { ...p, ...d } : p;
  });
}

// â”€â”€â”€ WETTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WEATHER = {
  '2026-02-23': { temp:8, rain:15, icon:'â›…', warn:false, desc:'Leicht bewÃ¶lkt' },
  '2026-02-24': { temp:5, rain:82, icon:'ğŸŒ§ï¸', warn:true, desc:'Starkregen' },
  '2026-02-25': { temp:6, rain:65, icon:'ğŸŒ¦ï¸', warn:true, desc:'Schauer' },
  '2026-02-26': { temp:11, rain:12, icon:'ğŸŒ¤ï¸', warn:false, desc:'Aufheiternd' },
  '2026-02-27': { temp:14, rain:5, icon:'â˜€ï¸', warn:false, desc:'Sonnig' },
  '2026-02-28': { temp:9, rain:40, icon:'ğŸŒ¥ï¸', warn:false, desc:'Bedeckt' },
};
const getWeather = d => WEATHER[d] || { temp:8, rain:25, icon:'ğŸŒ¥ï¸', warn:false, desc:'Wechselhaft' };

// â”€â”€â”€ BAUSTELLENSTATUS KONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BSTATUS = {
  beide_da:              { col:C.green,  animation:'pulse-green',  label:'Montage + Bauengel âœ“' },
  engel_vor_ort:         { col:C.red,    animation:'pulse-red',    label:'âš  Montage NICHT gestartet' },
  engel_fehlt:           { col:C.orange, animation:'pulse-orange', label:'Bauengel FEHLT' },
  monteur_nicht_gestartet:{ col:C.red,   animation:'pulse-red',    label:'Montage NICHT gestartet' },
  gestartet:             { col:C.green,  animation:'pulse-green',  label:'â–¶ Gestartet' },
  dc_fertig:             { col:C.blue,   animation:null,           label:'âœ“ DC fertig' },
  ac_fertig:             { col:C.purple, animation:null,           label:'âœ“ AC fertig' },
  abgenommen:            { col:C.brand,  animation:null,           label:'â˜… Abgenommen' },
};

// â”€â”€â”€ HILFSFUNKTIONEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtDate = d => d instanceof Date ? d.toISOString().split('T')[0] : d;
const fmtDay = d => {
  const dt = typeof d==='string' ? new Date(d+'T12:00:00') : d;
  return dt.toLocaleDateString('de-DE',{weekday:'short',day:'2-digit',month:'2-digit'});
};
const fmtTime = iso => iso ? new Date(iso).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) : null;
const nextWorkday = d => {
  const dt = new Date(d+'T12:00:00'); dt.setDate(dt.getDate()+1);
  if(dt.getDay()===6) dt.setDate(dt.getDate()+2);
  if(dt.getDay()===0) dt.setDate(dt.getDate()+1);
  return fmtDate(dt);
};
// AC-Datum = 1 Werktag NACH letztem DC-Tag (nie am selben Tag!)
const calcAcDate = (dcDate, dcDuration) => {
  let lastDcDay = dcDate;
  for(let i = 1; i < (dcDuration||1); i++) lastDcDay = nextWorkday(lastDcDay);
  return nextWorkday(lastDcDay);
};
const getDcSteps = type => (type==='wp_komplett') ? WP_DC_STEPS : DC_STEPS;
const getAcSteps = type => (type==='wp_komplett') ? WP_AC_STEPS : AC_STEPS;
const getWeekDays = base => {
  const d = new Date(base);
  const dow = d.getDay();
  const mon = new Date(d); mon.setDate(d.getDate() - dow + (dow===0 ? -6 : 1));
  return Array.from({length:5}, (_,i) => { const x = new Date(mon); x.setDate(mon.getDate()+i); return x; });
};
const getKW = d => { const n=new Date(d.getFullYear(),0,4); return Math.ceil(((d-n)/864e5+n.getDay()+1)/7); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HAUPT-APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DispatchApp() {
  const [baseDate, setBaseDate] = useState(new Date('2026-02-23'));
  const [projekte, setProjekte] = useState(() => applyDemoStatus(buildProjects()));
  const [view, setView] = useState('week'); // week | month | map | capacity
  const [modal, setModal] = useState(null);
  const [monteurFilter, setMonteurFilter] = useState('all');
  const [alertFilter, setAlertFilter] = useState(null);
  const [kiOpen, setKiOpen] = useState(false); // KI-Panel offen/zu

  const weekDays = useMemo(() => getWeekDays(baseDate), [baseDate]);

  // Tech-Slots berechnen
  const techSlots = useMemo(() => {
    const slots = {};
    const add = (k, v) => { slots[k] = [...(slots[k]||[]), v]; };
    projekte.forEach(p => {
      if(p.dcTechId && p.dcDate) {
        // For 2-day DC, mark the span instead of creating separate dc_ext entry
        const span = (p.dcDuration >= 2) ? 2 : 1;
        add(`${p.dcTechId}_${p.dcDate}`, { proj:p, phase:'dc', span });
        // Also mark the second day as occupied (for capacity/conflict checks) but flag as spanned
        if(p.dcDuration >= 2) {
          const day2 = nextWorkday(p.dcDate);
          add(`${p.dcTechId}_${day2}`, { proj:p, phase:'dc_spanned', span:0 });
        }
      }
      (p.dcExtraDates||[]).forEach(d => add(`${p.dcTechId}_${d}`, { proj:p, phase:'dc_ext', span:1 }));
      if(p.acTechId && p.acDate) add(`${p.acTechId}_${p.acDate}`, { proj:p, phase:'ac', span:1 });
      (p.acExtraDates||[]).forEach(d => add(`${p.acTechId}_${d}`, { proj:p, phase:'ac_ext', span:1 }));
    });
    return slots;
  }, [projekte]);

  // Bauengel-Slots
  const engelSlots = useMemo(() => {
    const slots = {};
    projekte.forEach(p => {
      if(!p.engelId || !p.dcDate) return;
      const k = `${p.engelId}_${p.dcDate}`;
      slots[k] = [...(slots[k]||[]), p];
    });
    return slots;
  }, [projekte]);

  const updateProject = useCallback((id, changes) => {
    setProjekte(prev => prev.map(p => {
      if(p.id !== id) return p;
      const updated = { ...p, ...changes };
      const pt = PROJECT_TYPES[updated.type];
      if(!pt.twoDay) {
        updated.status = (updated.dcDate||updated.acDate) && (updated.dcTechId||updated.acTechId) && updated.engelId
          ? 'fully_planned' : (updated.dcDate||updated.acDate) && (updated.dcTechId||updated.acTechId)
          ? 'dc_planned' : 'unplanned';
      } else {
        const hasDC = updated.dcDate && updated.dcTechId;
        const hasAC = updated.acDate && updated.acTechId;
        updated.status = hasDC && hasAC && updated.engelId ? 'fully_planned'
          : hasDC ? 'dc_planned' : 'unplanned';
      }
      return updated;
    }));
  }, []);

  // Gefilterte Monteure
  const filteredMonteure = useMemo(() =>
    MONTEURE.filter(m => !(monteurFilter==='own'&&m.sub || monteurFilter==='sub'&&!m.sub)),
  [monteurFilter]);

  // Ungeplant / Teilgeplant
  const unplanned = useMemo(() => projekte.filter(p => p.status==='unplanned'), [projekte]);
  const partialPlanned = useMemo(() => projekte.filter(p => p.status==='dc_planned'), [projekte]);

  // Alerts
  const alerts = useMemo(() => {
    const a = [];
    const monteurFehltList = projekte.filter(p => p.baustelleStatus==='monteur_nicht_gestartet'||p.baustelleStatus==='engel_vor_ort');
    const engelFehltList = projekte.filter(p => p.baustelleStatus==='engel_fehlt');
    const beideDaList = projekte.filter(p => p.baustelleStatus==='beide_da');
    if(monteurFehltList.length>0) a.push({ type:'red', key:'monteur_fehlt', projects:monteurFehltList, msg:`ğŸš¨ ${monteurFehltList.length} Montage(n) NICHT gestartet!` });
    if(engelFehltList.length>0) a.push({ type:'orange', key:'engel_fehlt', projects:engelFehltList, msg:`âš  ${engelFehltList.length} Baustelle(n) OHNE Bauengel!` });
    if(beideDaList.length>0) a.push({ type:'green', key:'beide_da', projects:beideDaList, msg:`âœ… ${beideDaList.length} Baustelle(n) laufen planmÃ¤ÃŸig` });
    const up = unplanned.length;
    if(up>0) a.push({ type:'dim', key:'ungeplant', projects:unplanned, msg:`âš¡ ${up} Projekte ungeplant` });
    // UnvollstÃ¤ndige Planung: DC geplant aber AC fehlt (oder umgekehrt)
    const incompleteList = projekte.filter(p => {
      const ptype = PROJECT_TYPES[p.type];
      const needsBoth = !!(ptype.dcSkill && ptype.acSkill);
      return needsBoth && ((p.dcDate && !p.acDate) || (p.acDate && !p.dcDate));
    });
    if(incompleteList.length>0) a.push({ type:'orange', key:'incomplete', projects:incompleteList, msg:`âš  ${incompleteList.length} Montage(n) unvollstÃ¤ndig (DC/AC fehlt)` });
    // Wetter-Warnung
    weekDays.forEach(wd => {
      const ds = fmtDate(wd);
      const w = getWeather(ds);
      if(w.warn) {
        const dach = projekte.filter(p => (p.type==='pv_komplett'||p.type==='pv_dach') && (p.dcDate===ds||(p.dcExtraDates||[]).includes(ds)) && p.dcTechId);
        if(dach.length>0) a.push({ type:'yellow', key:`wetter_${ds}`, projects:dach, msg:`${w.icon} ${fmtDay(wd)}: ${w.rain}% Regen â€“ ${dach.length} Dachmontage(n)` });
      }
    });
    return a;
  }, [projekte, weekDays, unplanned]);

  // Header KW Stats
  const weekStats = useMemo(() => {
    const days = weekDays.map(d => fmtDate(d));
    return {
      dc: projekte.filter(p => p.dcDate && days.includes(p.dcDate)).length,
      ac: projekte.filter(p => p.acDate && days.includes(p.acDate)).length,
      engel: projekte.filter(p => p.engelId && p.dcDate && days.includes(p.dcDate)).length,
    };
  }, [weekDays, projekte]);

  return (
    <div style={{minHeight:'100vh', background:C.bg, color:C.text, fontFamily:"'DM Sans',system-ui,sans-serif", display:'flex', flexDirection:'column', overflow:'hidden'}}>
      {/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <header style={{background:C.panel, borderBottom:`1px solid ${C.border}`, height:50, display:'flex', alignItems:'center', padding:'0 14px', gap:8, flexShrink:0, zIndex:100}}>
        <a href="index.html" style={{color:C.dim, fontSize:11, textDecoration:'none', marginRight:4}}>â† Launcher</a>
        <div style={{background:C.brand, color:C.bg, fontWeight:900, fontSize:13, padding:'3px 8px', borderRadius:5}}>bee-doo</div>
        <span style={{color:C.dim, fontSize:12, fontWeight:300, letterSpacing:'0.08em'}}>DISPATCH</span>
        <div style={{width:1, height:16, background:C.border, margin:'0 4px'}}/>

        {[['week','ğŸ“… Woche'],['month','ğŸ“† Monat'],['map','ğŸ—ºï¸ Karte'],['capacity','ğŸ“Š KapazitÃ¤t']].map(([k,l]) =>
          <button key={k} onClick={()=>setView(k)} style={{
            background:view===k?C.brand+'22':'transparent', color:view===k?C.brand:C.dim,
            border:`1px solid ${view===k?C.brand+'44':'transparent'}`, borderRadius:6, padding:'4px 12px', fontSize:12, cursor:'pointer', fontWeight:view===k?600:400
          }}>{l}</button>
        )}

        <div style={{flex:1}}/>

        {view==='week' && <>
          <div style={{display:'flex', alignItems:'center', gap:3, background:C.cardHover, borderRadius:7, padding:'2px 2px', border:`1px solid ${C.border}`}}>
            <SmBtn onClick={()=>setBaseDate(d=>{const n=new Date(d);n.setDate(n.getDate()-7);return n})}>â€¹</SmBtn>
            <span style={{fontSize:12, fontWeight:700, minWidth:62, textAlign:'center'}}>KW {getKW(baseDate)}</span>
            <SmBtn onClick={()=>setBaseDate(d=>{const n=new Date(d);n.setDate(n.getDate()+7);return n})}>â€º</SmBtn>
          </div>
          <button onClick={()=>setBaseDate(new Date('2026-02-23'))} style={{background:'none', border:`1px solid ${C.border}`, color:C.muted, borderRadius:5, padding:'3px 8px', fontSize:11, cursor:'pointer'}}>Heute</button>
        </>}

        {view==='month' && <>
          <div style={{display:'flex', alignItems:'center', gap:3, background:C.cardHover, borderRadius:7, padding:'2px 2px', border:`1px solid ${C.border}`}}>
            <SmBtn onClick={()=>setBaseDate(d=>{const n=new Date(d);n.setMonth(n.getMonth()-1);return n})}>â€¹</SmBtn>
            <span style={{fontSize:12, fontWeight:700, minWidth:90, textAlign:'center'}}>{baseDate.toLocaleDateString('de-DE',{month:'long', year:'numeric'})}</span>
            <SmBtn onClick={()=>setBaseDate(d=>{const n=new Date(d);n.setMonth(n.getMonth()+1);return n})}>â€º</SmBtn>
          </div>
          <button onClick={()=>setBaseDate(new Date('2026-02-23'))} style={{background:'none', border:`1px solid ${C.border}`, color:C.muted, borderRadius:5, padding:'3px 8px', fontSize:11, cursor:'pointer'}}>Heute</button>
        </>}

        <div style={{display:'flex', gap:8, fontSize:11, alignItems:'center'}}>
          <Badge col={C.dc} label={`DC ${weekStats.dc}`}/>
          <Badge col={C.ac} label={`AC ${weekStats.ac}`}/>
          <Badge col={C.teal} label={`ğŸ•Šï¸ ${weekStats.engel}`}/>
          <button onClick={()=>setKiOpen(!kiOpen)} style={{
            background:kiOpen?'linear-gradient(135deg,#A78BFA,#7C3AED)':C.cardHover,
            border:`1px solid ${kiOpen?'#A78BFA':C.border}`, borderRadius:7, padding:'4px 14px',
            color:kiOpen?'#fff':C.purple, fontSize:11, cursor:'pointer', fontWeight:700,
            display:'flex', alignItems:'center', gap:4,
            boxShadow:kiOpen?'0 0 12px rgba(167,139,250,0.3)':'none',
          }}>âœ¦ KI{kiOpen?' âœ•':''}</button>
        </div>
      </header>

      {/* â”€â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {alerts.length > 0 && (
        <div style={{background:'rgba(248,113,113,0.04)', borderBottom:`1px solid ${C.red}15`, padding:'4px 14px', display:'flex', gap:7, flexWrap:'wrap', alignItems:'center', flexShrink:0}}>
          <span style={{color:C.red, fontSize:10, fontWeight:800, letterSpacing:'0.06em'}}>ALERTS</span>
          {alerts.map((a,i) => {
            const col = a.type==='red'?C.red : a.type==='orange'?C.orange : a.type==='green'?C.green : a.type==='yellow'?C.yellow : C.dim;
            const isActive = alertFilter === a.key;
            return <span key={i} onClick={()=>setAlertFilter(isActive ? null : a.key)} style={{
              background:isActive ? col+'30' : col+'12', color:col, border:`1px solid ${isActive ? col : col+'44'}`,
              borderRadius:4, padding:'1px 8px', fontSize:11, cursor:'pointer', fontWeight:isActive?700:400,
              outline: isActive ? `1px solid ${col}` : 'none',
            }}>{a.msg}</span>;
          })}
          {alertFilter && <span onClick={()=>setAlertFilter(null)} style={{fontSize:10, color:C.muted, cursor:'pointer', marginLeft:4}}>âœ• Filter zurÃ¼cksetzen</span>}
        </div>
      )}

      {/* â”€â”€â”€ ALERT DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {alertFilter && (() => {
        const alert = alerts.find(a => a.key === alertFilter);
        if(!alert) return null;
        const col = alert.type==='red'?C.red : alert.type==='orange'?C.orange : alert.type==='green'?C.green : alert.type==='yellow'?C.yellow : C.dim;
        return (
          <div style={{background:col+'08', borderBottom:`1px solid ${col}33`, padding:'8px 14px', flexShrink:0, maxHeight:180, overflowY:'auto'}}>
            <div style={{display:'flex', gap:8, flexWrap:'wrap'}}>
              {alert.projects.map(p => {
                const pt = PROJECT_TYPES[p.type];
                const bs = p.baustelleStatus ? BSTATUS[p.baustelleStatus] : null;
                const dcTech = MONTEURE.find(m => m.id === p.dcTechId);
                return (
                  <div key={p.id} onClick={()=>{setAlertFilter(null); setModal({type:'detail',proj:p});}} style={{
                    background:C.panel, border:`1px solid ${col}44`, borderLeft:`3px solid ${col}`,
                    borderRadius:7, padding:'8px 12px', cursor:'pointer', minWidth:220, flex:'0 0 auto'
                  }}>
                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:3}}>
                      <span style={{fontSize:10, color:C.dim, fontWeight:600}}>{p.id}</span>
                      <span style={{fontSize:10, color:pt.color, fontWeight:700}}>{pt.icon} {pt.label}</span>
                    </div>
                    <div style={{fontSize:13, fontWeight:700, color:C.text}}>{p.customer}</div>
                    <div style={{fontSize:11, color:C.dim}}>{p.plz} {p.city} Â· {p.address}</div>
                    {dcTech && <div style={{fontSize:10, color:C.dim, marginTop:3}}>ğŸ‘· {dcTech.name}</div>}
                    {bs && <div style={{fontSize:10, color:bs.col, fontWeight:700, marginTop:3}}>{bs.label}</div>}
                    {p.montageStartedAt && <div style={{fontSize:10, color:C.green, marginTop:1}}>â–¶ {fmtTime(p.montageStartedAt)}</div>}
                    {p.engelArrivedAt && <div style={{fontSize:10, color:C.teal, marginTop:1}}>ğŸ•Šï¸ {fmtTime(p.engelArrivedAt)}</div>}
                  </div>
                );
              })}
            </div>
          </div>
        );
      })()}

      {/* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div style={{flex:1, display:'flex', overflow:'hidden'}}>
        {/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <aside style={{width:240, background:C.panel, borderRight:`1px solid ${C.border}`, display:'flex', flexDirection:'column', flexShrink:0, overflow:'hidden'}}>
          <div style={{padding:'8px 10px', borderBottom:`1px solid ${C.border}`}}>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:4}}>
              <span style={{fontSize:10, fontWeight:800, color:C.dim, textTransform:'uppercase', letterSpacing:'0.08em'}}>Ungeplant</span>
              <CountBadge val={unplanned.length} col={unplanned.length>0?C.red:C.green}/>
            </div>
          </div>
          <div style={{flex:1, overflowY:'auto', padding:'6px 8px'}}>
            {unplanned.length===0 && partialPlanned.length===0 && (
              <div style={{textAlign:'center', color:C.muted, fontSize:12, paddingTop:28}}>âœ… Alle eingeplant!</div>
            )}
            {[...unplanned, ...partialPlanned].map(p => {
              const pt = PROJECT_TYPES[p.type];
              const kwpInfo = p.kwp > 0 ? ` Â· ${p.kwp} kWp` : '';
              const bigDC = p.kwp > 10;
              return (
                <div key={p.id} onClick={()=>setModal({type:'plan',proj:p})} style={{
                  background: C.cardHover,
                  border:`1px solid ${p.priority==='high'?C.red:p.priority==='medium'?C.yellow:C.border}`,
                  borderLeft:`3px solid ${p.priority==='high'?C.red:p.priority==='medium'?C.yellow:C.green}`,
                  borderRadius:7, padding:'7px 9px', marginBottom:4, cursor:'pointer',
                  transition: 'all 0.15s ease',
                }}>
                  <div style={{display:'flex', justifyContent:'space-between', marginBottom:2}}>
                    <span style={{fontSize:10, color:C.dim, fontWeight:600}}>{p.id}</span>
                    <span style={{fontSize:10, color:pt.color, background:pt.color+'15', borderRadius:3, padding:'0 4px', fontWeight:700}}>
                      {pt.icon} {pt.label}{kwpInfo}
                    </span>
                  </div>
                  <div style={{fontSize:12, fontWeight:700, color:C.text}}>{p.customer}</div>
                  <div style={{fontSize:11, color:C.dim}}>{p.plz} {p.city} Â· {p.address}</div>
                  {p.notes && <div style={{fontSize:9, color:C.muted, marginTop:2}}>ğŸ“‹ {p.notes}</div>}
                  {bigDC && <div style={{fontSize:9, color:C.orange, fontWeight:700, marginTop:3}}>âš¡ {p.kwp}kWp â†’ DC 2 Tage</div>}
                  {p.status==='dc_planned' && <div style={{fontSize:9, color:C.yellow, fontWeight:700, marginTop:3}}>â³ DC geplant â€“ AC fehlt</div>}
                </div>
              );
            })}
          </div>
          <div style={{padding:'6px 8px', borderTop:`1px solid ${C.border}`}}>
            <div style={{fontSize:10, color:C.muted, marginBottom:4, textTransform:'uppercase', letterSpacing:'0.06em'}}>Monteure</div>
            <div style={{display:'flex', gap:3}}>
              {[['all','Alle'],['own','Eigene'],['sub','Subs']].map(([k,l]) =>
                <button key={k} onClick={()=>setMonteurFilter(k)} style={{
                  flex:1, background:monteurFilter===k?C.brand+'22':'transparent', color:monteurFilter===k?C.brand:C.dim,
                  border:`1px solid ${monteurFilter===k?C.brand+'44':C.border}`, borderRadius:5, padding:'4px 0', fontSize:10, cursor:'pointer', fontWeight:monteurFilter===k?700:400
                }}>{l}</button>
              )}
            </div>
          </div>
        </aside>

        {/* â”€â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <main style={{flex:1, overflow:'auto'}}>
          {view==='week' && <WeekView weekDays={weekDays} techs={filteredMonteure} engel={BAUENGEL}
            techSlots={techSlots} engelSlots={engelSlots} projekte={projekte}
            updateProject={updateProject} onCardClick={p => setModal({type:'detail',proj:p})}/>}
          {view==='month' && <MonthView baseDate={baseDate} projekte={projekte} techs={filteredMonteure} engel={BAUENGEL} onCardClick={p => setModal({type:'detail',proj:p})}/>}
          {view==='map' && <MapView projekte={projekte}/>}
          {view==='capacity' && <CapacityView weekDays={weekDays} techs={filteredMonteure} engel={BAUENGEL} techSlots={techSlots} engelSlots={engelSlots} projekte={projekte}/>}
        </main>

        {/* â”€â”€â”€ KI PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {kiOpen && (
          <KIPanel projekte={projekte} weekDays={weekDays} techSlots={techSlots} engelSlots={engelSlots}
            updateProject={updateProject} onClose={()=>setKiOpen(false)}/>
        )}
      </div>

      {/* â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {modal && modal.type==='plan' && (
        <PlanModal proj={modal.proj} onClose={()=>setModal(null)} updateProject={updateProject} monteure={MONTEURE} engel={BAUENGEL}/>
      )}
      {modal && modal.type==='detail' && (
        <DetailModal proj={modal.proj} onClose={()=>setModal(null)} onReplan={(p)=>setModal({type:'plan',proj:p})}/>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEEK VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function WeekView({ weekDays, techs, engel, techSlots, engelSlots, projekte, updateProject, onCardClick }) {
  const colTemplate = '160px repeat(5,1fr)';

  // Hover-Highlight + Auto-Scroll: GegenstÃ¼ck sichtbar machen
  const [hoveredProjId, setHoveredProjId] = useState(null);
  const savedScrollRef = useRef(null);
  const scrollContainerRef = useRef(null);

  const handleHoverProject = useCallback((projId) => {
    setHoveredProjId(projId);
    // Auto-scroll: Finde alle Karten dieses Projekts und scrolle so dass beide sichtbar
    const container = scrollContainerRef.current || document.querySelector('main');
    if(!container) return;
    // Scroll-Position merken
    savedScrollRef.current = { top: container.scrollTop, left: container.scrollLeft };
    // Alle Karten des Projekts finden
    requestAnimationFrame(() => {
      const cards = container.querySelectorAll(`[data-proj-id="${projId}"]`);
      if(cards.length < 2) return; // Nur eine Karte = kein Scroll nÃ¶tig
      const containerRect = container.getBoundingClientRect();
      let minTop = Infinity, maxBottom = -Infinity, minLeft = Infinity, maxRight = -Infinity;
      cards.forEach(card => {
        const r = card.getBoundingClientRect();
        minTop = Math.min(minTop, r.top - containerRect.top + container.scrollTop);
        maxBottom = Math.max(maxBottom, r.bottom - containerRect.top + container.scrollTop);
        minLeft = Math.min(minLeft, r.left - containerRect.left + container.scrollLeft);
        maxRight = Math.max(maxRight, r.right - containerRect.left + container.scrollLeft);
      });
      // PrÃ¼fe ob alle Karten im sichtbaren Bereich
      const visTop = container.scrollTop;
      const visBottom = container.scrollTop + containerRect.height;
      const visLeft = container.scrollLeft;
      const visRight = container.scrollLeft + containerRect.width;
      const allVisible = minTop >= visTop && maxBottom <= visBottom && minLeft >= visLeft && maxRight <= visRight;
      if(!allVisible) {
        // Scrolle so dass alle Karten zentriert sichtbar sind
        const targetTop = Math.max(0, (minTop + maxBottom) / 2 - containerRect.height / 2);
        const targetLeft = Math.max(0, (minLeft + maxRight) / 2 - containerRect.width / 2);
        container.scrollTo({ top: targetTop, left: targetLeft, behavior: 'smooth' });
      }
    });
  }, []);

  const handleLeaveProject = useCallback(() => {
    setHoveredProjId(null);
    // Scroll zurÃ¼ck
    const container = scrollContainerRef.current || document.querySelector('main');
    if(container && savedScrollRef.current) {
      container.scrollTo({ top: savedScrollRef.current.top, left: savedScrollRef.current.left, behavior: 'smooth' });
      savedScrollRef.current = null;
    }
  }, []);

  return (
    <div data-dispatch-grid="" style={{minWidth:820, position:'relative'}}>

      {/* Dimming overlay when hovering a project */}
      {hoveredProjId && (
        <style>{`
          [data-dispatch-grid] [data-proj-card]:not([data-proj-id="${hoveredProjId}"]) {
            opacity: 0.2 !important;
            filter: grayscale(0.7) !important;
            transition: opacity 0.2s, filter 0.2s !important;
          }
          [data-dispatch-grid] [data-proj-card][data-proj-id="${hoveredProjId}"] {
            opacity: 1 !important;
            filter: none !important;
            transform: scale(1.02);
            z-index: 20;
            box-shadow: 0 0 16px rgba(245,197,0,0.25), 0 0 4px rgba(245,197,0,0.15);
            transition: all 0.2s !important;
          }
        `}</style>
      )}

      {/* Header */}
      <div style={{display:'grid', gridTemplateColumns:colTemplate, position:'sticky', top:0, zIndex:30, background:C.bg, height:56}}>
        <div style={{background:C.cardHover, borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'8px 10px'}}>
          <span style={{fontSize:10, color:C.muted, fontWeight:700, textTransform:'uppercase', letterSpacing:'0.06em'}}>Person</span>
        </div>
        {weekDays.map(wd => {
          const ds = fmtDate(wd);
          const w = getWeather(ds);
          const isToday = ds==='2026-02-23';
          return (
            <div key={ds} style={{background:isToday?C.brand+'0D':C.cardHover, borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'7px 10px', textAlign:'center'}}>
              <div style={{fontSize:13, fontWeight:isToday?800:500, color:isToday?C.brand:C.text}}>{fmtDay(wd)}</div>
              <div style={{marginTop:3, display:'flex', alignItems:'center', justifyContent:'center', gap:5}}>
                <span style={{fontSize:13}}>{w.icon}</span>
                <span style={{fontSize:11, fontWeight:600, color:w.warn?C.yellow:C.dim}}>{w.temp}Â°C</span>
                <span style={{fontSize:10, color:C.muted}}>{w.rain}%ğŸ’§</span>
                {w.warn && <span style={{background:C.yellow+'22', color:C.yellow, borderRadius:3, padding:'0 4px', fontSize:9, fontWeight:800}}>âš ï¸</span>}
              </div>
            </div>
          );
        })}
      </div>

      {/* Monteure Section Header */}
      <SectionHeader label="ğŸ‘· Monteure" count={techs.length} colTemplate={colTemplate}/>

      {/* Monteure Rows */}
      {techs.map(tech => {
        // Pre-compute which days are "spanned over" by a 2-day card starting on previous day
        const spannedDays = new Set();
        weekDays.forEach((wd, idx) => {
          const ds = fmtDate(wd);
          const items = techSlots[`${tech.id}_${ds}`] || [];
          items.forEach(item => {
            if(item.phase === 'dc_spanned') spannedDays.add(ds);
          });
        });

        return (
          <div key={tech.id} style={{display:'grid', gridTemplateColumns:colTemplate}}>
            <PersonCell who={tech}/>
            {weekDays.map((wd, dayIdx) => {
              const ds = fmtDate(wd);
              const key = `${tech.id}_${ds}`;
              const allItems = techSlots[key] || [];
              // Filter out spanned placeholders for rendering
              const items = allItems.filter(it => it.phase !== 'dc_spanned');
              const isSpannedOver = spannedDays.has(ds) && items.length === 0;
              const full = allItems.length >= tech.cap;

              // If this day is completely covered by a span from previous day, hide the cell
              if(isSpannedOver) return null;

              // Check if any item spans 2 days
              const hasSpan2 = items.some(it => it.span === 2);

              return (
                <div key={ds} style={{
                  background:C.panel, borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`,
                  padding:'3px 3px', minHeight:80, position:'relative',
                  gridColumn: hasSpan2 ? 'span 2' : undefined,
                }}>
                  {items.map(({proj, phase, span: itemSpan}) => (
                    <ProjectCard key={`${proj.id}_${phase}`} proj={proj} phase={phase} dataAttr={`${proj.id}-${phase.replace('_ext','')}`} onClick={()=>onCardClick(proj)} isSpan2={itemSpan===2} onHoverProject={handleHoverProject} onLeaveProject={handleLeaveProject}/>
                  ))}
                  {full && <div style={{fontSize:9, color:C.red, textAlign:'center', fontWeight:700}}>â— VOLL</div>}
                </div>
              );
            })}
          </div>
        );
      })}

      {/* Bauengel Section Header */}
      <SectionHeader label="ğŸ•Šï¸ Bauengel" count={engel.length} colTemplate={colTemplate} color={C.teal}/>

      {/* Bauengel Rows */}
      {engel.map(e => (
        <div key={e.id} style={{display:'grid', gridTemplateColumns:colTemplate}}>
          <PersonCell who={e} isEngel/>
          {weekDays.map(wd => {
            const ds = fmtDate(wd);
            const key = `${e.id}_${ds}`;
            const items = engelSlots[key] || [];
            return (
              <div key={ds} style={{background:C.teal+'04', borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'3px 3px', minHeight:60, position:'relative'}}>
                {items.map(proj => (
                  <div key={proj.id} data-proj-card="" data-proj-id={proj.id}
                    onClick={()=>onCardClick(proj)}
                    onMouseEnter={()=>handleHoverProject(proj.id)}
                    onMouseLeave={handleLeaveProject}
                    style={{
                    background:C.teal+'10', border:`1px solid ${C.teal}44`, borderLeft:`3px solid ${C.teal}`,
                    borderRadius:5, padding:'4px 6px', marginBottom:3, cursor:'pointer',
                    transition:'opacity 0.2s, filter 0.2s, transform 0.2s',
                  }}>
                    <div style={{fontSize:10, fontWeight:700, color:C.teal}}>ğŸ•Šï¸ QS</div>
                    <div style={{fontSize:11, color:C.text, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{proj.customer}</div>
                    <div style={{fontSize:9, color:C.dim}}>{proj.plz} Â· {proj.id}</div>
                    <div style={{fontSize:9, color:C.dim}}>{proj.city} Â· {proj.address}</div>
                  </div>
                ))}
              </div>
            );
          })}
        </div>
      ))}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECT CARD (in Wochenansicht)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ProjectCard({ proj, phase, dataAttr, onClick, isSpan2, onHoverProject, onLeaveProject }) {
  const pt = PROJECT_TYPES[proj.type];
  const isExt = phase.includes('ext');
  const phaseCol = isExt ? C.orange : phase==='dc' ? C.dc : phase==='ac' ? C.ac : C.teal;
  const phaseLabel = isExt ? `${phase.replace('_ext','').toUpperCase()}+` : phase.toUpperCase();
  const bs = proj.baustelleStatus ? BSTATUS[proj.baustelleStatus] : null;

  // UnvollstÃ¤ndige Planung: Projekt braucht DC+AC aber nur eines ist geplant
  const needsBoth = !!(pt.dcSkill && pt.acSkill);
  const hasDC = !!proj.dcDate;
  const hasAC = !!proj.acDate;
  const isIncomplete = needsBoth && ((hasDC && !hasAC) || (hasAC && !hasDC));
  const missingPhase = isIncomplete ? (!hasAC ? 'AC' : 'DC') : null;

  let cardAnimation = null;
  if(isIncomplete) {
    cardAnimation = 'pulse-incomplete 1.8s ease-in-out infinite';
  } else if(bs?.animation) {
    cardAnimation = `${bs.animation} 1.2s ease-in-out infinite`;
  }
  const techId = phase.startsWith('dc') ? proj.dcTechId : proj.acTechId;
  const tech = MONTEURE.find(m => m.id === techId);
  const [hover, setHover] = useState(false);

  // Progress
  const steps = phase.startsWith('dc') ? getDcSteps(proj.type) : getAcSteps(proj.type);
  const progress = phase.startsWith('dc') ? (proj.dcProgress||[]) : (proj.acProgress||[]);
  const lastStep = progress.length > 0 ? progress[progress.length-1] : null;
  const stepDef = lastStep ? steps?.find(s => s.key === lastStep.step) : null;
  const lastFoto = progress.length > 0 ? [...progress].reverse().find(p => p.foto) : null;
  // Bau-Bild: letztes Fortschritts-Foto oder generisches bauFoto
  const displayFoto = (lastFoto && lastFoto.foto) || proj.bauFoto;

  return (
    <div data-proj={dataAttr} data-proj-card="" data-proj-id={proj.id}
      onClick={onClick}
      onMouseEnter={()=>onHoverProject && onHoverProject(proj.id)}
      onMouseLeave={()=>onLeaveProject && onLeaveProject()}
      style={{
      background:C.cardHover, border:`1px solid ${bs ? bs.col+'66' : phaseCol+'44'}`,
      borderLeft:`3px solid ${bs ? bs.col : phaseCol}`,
      borderRadius:6, padding:0, marginBottom:3, cursor:'pointer', position:'relative',
      animation: cardAnimation, overflow:'hidden', transition:'opacity 0.2s, filter 0.2s, transform 0.2s',
    }}>
      {/* Bau-Bild oben */}
      {displayFoto && (
        <div style={{height:isSpan2?56:42, position:'relative', overflow:'hidden'}}>
          <img src={displayFoto} style={{width:'100%', height:'100%', objectFit:'cover', display:'block', opacity:0.8}} onError={e=>{e.target.parentElement.style.display='none'}}/>
          <div style={{position:'absolute', inset:0, background:'linear-gradient(transparent 30%, rgba(11,13,18,0.85) 100%)'}}/>
          {/* Phase badge on image */}
          <span style={{position:'absolute', top:3, right:4, background:phaseCol+'cc', color:'#000', borderRadius:3, padding:'1px 6px', fontSize:8, fontWeight:900}}>{phaseLabel}</span>
          {isSpan2 && <span style={{position:'absolute', top:3, left:4, background:C.orange+'cc', color:'#000', borderRadius:3, padding:'1px 5px', fontSize:8, fontWeight:900}}>2 TAGE</span>}
          {lastFoto && lastFoto.foto && <span style={{position:'absolute', bottom:3, right:4, background:'rgba(0,0,0,0.7)', borderRadius:3, padding:'1px 5px', fontSize:7, color:C.text}}>ğŸ“· Bauengel</span>}
        </div>
      )}

      {/* Content */}
      <div style={{padding:'4px 6px 5px'}}>
        <div style={{fontSize:11, fontWeight:700, color:C.text, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>
          {proj.customer}
        </div>
        <div style={{fontSize:9, color:C.dim, marginTop:1}}>{proj.plz} {proj.city} Â· {proj.address}</div>
        <div style={{display:'flex', gap:4, alignItems:'center', marginTop:2, flexWrap:'wrap'}}>
          <span style={{fontSize:8, color:pt.color, fontWeight:600}}>{pt.icon} {pt.label}</span>
          {proj.kwp > 0 && <span style={{fontSize:8, color:C.orange, fontWeight:700}}>{proj.kwp}kWp</span>}
          <span style={{fontSize:7, color:C.muted}}>{proj.id}</span>
          {!displayFoto && <span style={{marginLeft:'auto', background:phaseCol+'22', color:phaseCol, borderRadius:3, padding:'0 4px', fontSize:8, fontWeight:800}}>{phaseLabel}</span>}
        </div>

        {/* Monteur-Zeile mit Foto + Hover */}
        {tech && (
          <div onMouseEnter={()=>setHover(true)} onMouseLeave={()=>setHover(false)} style={{
            display:'flex', alignItems:'center', gap:4, marginTop:3, padding:'2px 4px',
            background:C.panel, borderRadius:4, border:`1px solid ${C.border}`, position:'relative',
          }}>
            {tech.foto ? (
              <img src={tech.foto} style={{width:18, height:18, borderRadius:'50%', objectFit:'cover', border:`1px solid ${tech.color}44`}} onError={e=>{e.target.style.display='none'}}/>
            ) : (
              <Avatar ini={tech.ini} col={tech.color} size={18}/>
            )}
            <span style={{fontSize:9, color:C.text, fontWeight:600, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap', flex:1}}>{tech.name}</span>
            {tech.sub && <span style={{fontSize:7, color:C.muted, background:C.muted+'22', borderRadius:2, padding:'0 3px'}}>SU</span>}
            {/* Hover-Tooltip */}
            {hover && (
              <div style={{position:'absolute', bottom:'100%', left:0, marginBottom:4, background:C.panel, border:`1px solid ${C.border}`, borderRadius:8, padding:'8px 10px', zIndex:50, minWidth:180, boxShadow:'0 4px 16px rgba(0,0,0,0.5)'}}>
                <div style={{display:'flex', gap:8, alignItems:'center', marginBottom:6}}>
                  {tech.foto ? (
                    <img src={tech.foto} style={{width:36, height:36, borderRadius:'50%', objectFit:'cover', border:`2px solid ${tech.color}`}} onError={e=>{e.target.style.display='none'}}/>
                  ) : (
                    <Avatar ini={tech.ini} col={tech.color} size={36}/>
                  )}
                  <div>
                    <div style={{fontSize:12, fontWeight:700, color:C.text}}>{tech.name}</div>
                    <div style={{fontSize:10, color:C.dim}}>{tech.region} Â· PLZ {tech.plz}</div>
                  </div>
                </div>
                <div style={{display:'flex', gap:3, flexWrap:'wrap'}}>
                  {tech.skills.map(s => {
                    const col = PROJECT_TYPES[s]?.color || C.muted;
                    return <span key={s} style={{background:col+'18', color:col, borderRadius:3, padding:'1px 4px', fontSize:8, fontWeight:700}}>{s.replace('pv_','').toUpperCase()}</span>;
                  })}
                </div>
                <div style={{fontSize:9, color:C.dim, marginTop:4}}>KapazitÃ¤t: {tech.cap} pro Tag{tech.sub?' Â· Subunternehmer':''}</div>
              </div>
            )}
          </div>
        )}

        {/* Fortschrittsbalken â€“ IMMER */}
        {steps && (
          <div style={{marginTop:3}}>
            <div style={{display:'flex', gap:1, marginBottom:1}}>
              {steps.map(s => {
                const done = progress.some(p => p.step === s.key);
                return <div key={s.key} style={{flex:1, height:3, borderRadius:1, background:done?C.green:C.border+'88'}}/>;
              })}
            </div>
            {stepDef ? (
              <div style={{fontSize:8, color:C.green, fontWeight:600}}>{stepDef.icon} {stepDef.label}</div>
            ) : (
              <div style={{fontSize:7, color:C.muted}}>â³ {progress.length}/{steps.length}</div>
            )}
          </div>
        )}

        {/* Baustellen-Status */}
        {bs && (
          <div style={{marginTop:2}}>
            {proj.baustelleStatus === 'beide_da' && (
              <div style={{display:'flex', gap:3, flexWrap:'wrap'}}>
                <StatusBadge col={C.green} label={`â–¶ ${fmtTime(proj.montageStartedAt)||''}`} blink={false}/>
                <StatusBadge col={C.teal} label={`ğŸ•Šï¸ ${fmtTime(proj.engelArrivedAt)||''}`} blink={false}/>
              </div>
            )}
            {proj.baustelleStatus === 'engel_vor_ort' && (
              <div style={{display:'flex', gap:3, flexWrap:'wrap'}}>
                <StatusBadge col={C.red} label="âš  Nicht gestartet!" blink/>
                <StatusBadge col={C.teal} label={`ğŸ•Šï¸ ${fmtTime(proj.engelArrivedAt)||''}`} blink={false}/>
              </div>
            )}
            {proj.baustelleStatus === 'engel_fehlt' && (
              <div style={{display:'flex', gap:3, flexWrap:'wrap'}}>
                {proj.montageStartedAt && <StatusBadge col={C.green} label={`â–¶ ${fmtTime(proj.montageStartedAt)}`} blink={false}/>}
                <StatusBadge col={C.orange} label="Engel FEHLT!" blink/>
              </div>
            )}
            {proj.baustelleStatus === 'monteur_nicht_gestartet' && <StatusBadge col={C.red} label="Nicht gestartet!" blink/>}
            {proj.baustelleStatus === 'gestartet' && <StatusBadge col={C.green} label={`â–¶ ${fmtTime(proj.montageStartedAt)||''}`} blink/>}
          </div>
        )}

        {/* UnvollstÃ¤ndige Planung Warnung */}
        {isIncomplete && (
          <div style={{marginTop:3, background:C.orange+'15', border:`1px solid ${C.orange}44`, borderRadius:4, padding:'2px 6px', display:'flex', alignItems:'center', gap:4, animation:'blink 1.5s ease-in-out infinite'}}>
            <span style={{fontSize:9, color:C.orange, fontWeight:800}}>âš  {missingPhase} fehlt!</span>
            <span style={{fontSize:8, color:C.dim}}>Montage unvollstÃ¤ndig</span>
          </div>
        )}
      </div>
    </div>
  );
}

function StatusBadge({ col, label, blink }) {
  return (
    <div style={{
      display:'inline-flex', alignItems:'center', gap:3,
      background:col+'15', borderRadius:3, padding:'1px 5px',
      animation: blink ? `blink 0.8s ease-in-out infinite` : undefined,
    }}>
      <span style={{fontSize:8, color:col, fontWeight:700}}>{label}</span>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONTH VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MonthView({ baseDate, projekte, techs, engel, onCardClick }) {
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDow = (firstDay.getDay() + 6) % 7; // Mo=0
  const daysInMonth = lastDay.getDate();

  // Build calendar grid cells
  const calendarCells = [];
  for(let i = 0; i < startDow; i++) calendarCells.push(null);
  for(let d = 1; d <= daysInMonth; d++) calendarCells.push(d);
  while(calendarCells.length % 7 !== 0) calendarCells.push(null);

  // Group projects by date
  const projectsByDate = useMemo(() => {
    const byDate = {};
    projekte.forEach(p => {
      if(p.dcDate) {
        const key = p.dcDate;
        byDate[key] = [...(byDate[key]||[]), { proj:p, phase:'dc' }];
        if(p.dcDuration >= 2) {
          const day2 = nextWorkday(p.dcDate);
          byDate[day2] = [...(byDate[day2]||[]), { proj:p, phase:'dc_ext' }];
        }
      }
      if(p.acDate) {
        const key = p.acDate;
        byDate[key] = [...(byDate[key]||[]), { proj:p, phase:'ac' }];
      }
    });
    return byDate;
  }, [projekte]);

  const today = '2026-02-23';
  const dayNames = ['Mo','Di','Mi','Do','Fr','Sa','So'];

  return (
    <div style={{padding:12, overflow:'auto', height:'100%'}}>
      {/* Day headers */}
      <div style={{display:'grid', gridTemplateColumns:'repeat(7,1fr)', gap:2, marginBottom:4}}>
        {dayNames.map(d => (
          <div key={d} style={{textAlign:'center', fontSize:11, fontWeight:700, color:C.dim, padding:'6px 0',
            background: (d==='Sa'||d==='So') ? C.red+'08' : 'transparent', borderRadius:4
          }}>{d}</div>
        ))}
      </div>

      {/* Calendar grid */}
      <div style={{display:'grid', gridTemplateColumns:'repeat(7,1fr)', gap:2}}>
        {calendarCells.map((day, idx) => {
          if(day === null) return <div key={`empty-${idx}`} style={{background:C.panel+'40', borderRadius:6, minHeight:90}}/>;

          const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
          const items = projectsByDate[dateStr] || [];
          const isToday = dateStr === today;
          const isWeekend = idx % 7 >= 5;
          const weatherInfo = getWeather(dateStr);

          return (
            <div key={dateStr} style={{
              background: isToday ? C.brand+'12' : isWeekend ? C.red+'06' : C.panel,
              border: `1px solid ${isToday ? C.brand+'55' : C.border}`,
              borderRadius:6, minHeight:90, padding:'4px 5px', position:'relative',
              overflow:'hidden',
            }}>
              {/* Day number + weather */}
              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:3}}>
                <span style={{
                  fontSize:13, fontWeight: isToday ? 800 : 600,
                  color: isToday ? C.brand : isWeekend ? C.red+'88' : C.text,
                  background: isToday ? C.brand+'22' : 'transparent',
                  borderRadius: isToday ? 4 : 0,
                  padding: isToday ? '0 5px' : 0,
                }}>{day}</span>
                {!isWeekend && weatherInfo && (
                  <span style={{fontSize:10, color:C.muted}}>{weatherInfo.icon}</span>
                )}
              </div>

              {/* Projects */}
              {items.slice(0,4).map(({proj, phase}) => {
                const pt = PROJECT_TYPES[proj.type];
                const phaseCol = phase==='dc'||phase==='dc_ext' ? C.dc : C.ac;
                const bs = proj.baustelleStatus ? BSTATUS[proj.baustelleStatus] : null;
                return (
                  <div key={`${proj.id}-${phase}`} onClick={()=>onCardClick(proj)} style={{
                    background: bs ? bs.col+'12' : phaseCol+'10',
                    borderLeft:`2px solid ${bs ? bs.col : phaseCol}`,
                    borderRadius:3, padding:'2px 4px', marginBottom:2, fontSize:9, cursor:'pointer',
                    animation: bs?.animation ? `${bs.animation} 1.2s ease-in-out infinite` : undefined,
                  }}>
                    <div style={{fontWeight:700, color:C.text, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{proj.customer}</div>
                    <div style={{display:'flex', gap:3, color:C.dim, alignItems:'center'}}>
                      <span style={{color:pt.color}}>{pt.icon}</span>
                      <span>{phase.replace('_ext','+').toUpperCase()}</span>
                      {proj.kwp > 0 && <span>{proj.kwp}kWp</span>}
                      <span>{proj.plz}</span>
                    </div>
                  </div>
                );
              })}
              {items.length > 4 && (
                <div style={{fontSize:9, color:C.muted, textAlign:'center', fontWeight:600}}>+{items.length - 4} weitere</div>
              )}

              {/* Count badge */}
              {items.length > 0 && (
                <div style={{position:'absolute', top:3, right:4, background:C.brand+'22', color:C.brand, borderRadius:4, padding:'0 4px', fontSize:9, fontWeight:800}}>{items.length}</div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MapView({ projekte }) {
  const mapRef = useRef(null);
  const mapInstance = useRef(null);

  useEffect(() => {
    if(mapInstance.current) return;
    const map = L.map(mapRef.current, { zoomControl:true }).setView([51.75, 8.65], 9);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution:'&copy; OSM &copy; CARTO', maxZoom:19
    }).addTo(map);
    mapInstance.current = map;

    // Baustellen-Marker
    const todayProjects = projekte.filter(p => p.dcDate==='2026-02-23' && p.lat && p.lng);
    todayProjects.forEach(p => {
      const bs = p.baustelleStatus ? BSTATUS[p.baustelleStatus] : null;
      const col = bs ? bs.col : C.dim;
      const pulseClass = bs?.animation || '';

      // Custom marker with pulse
      const size = bs ? 18 : 12;
      const html = `<div style="
        width:${size}px;height:${size}px;border-radius:50%;
        background:${col};border:2px solid #fff;
        ${bs?.animation ? `box-shadow:0 0 12px ${col}aa;animation:${bs.animation} 1.2s ease-in-out infinite;` : ''}
      "></div>`;

      const icon = L.divIcon({ html, className:'', iconSize:[size,size], iconAnchor:[size/2,size/2] });
      const marker = L.marker([p.lat, p.lng], { icon }).addTo(map);

      // Popup
      const statusText = bs ? bs.label : 'Geplant';
      const times = [];
      if(p.montageStartedAt) times.push(`â–¶ Montage: ${fmtTime(p.montageStartedAt)}`);
      if(p.engelArrivedAt) times.push(`ğŸ•Šï¸ Engel: ${fmtTime(p.engelArrivedAt)}`);
      marker.bindPopup(`
        <div style="font-family:'DM Sans',sans-serif;color:#222;min-width:200px">
          <strong>${p.customer}</strong><br>
          <span style="color:#666">${p.plz} ${p.city} Â· ${p.address}</span><br>
          <span style="color:#666">${p.id} Â· ${PROJECT_TYPES[p.type]?.icon} ${PROJECT_TYPES[p.type]?.label}</span>
          ${p.kwp > 0 ? `<br><span style="color:#666">${p.kwp} kWp${p.kwp>10?' (2-Tage DC)':''}</span>` : ''}
          <hr style="border:0;border-top:1px solid #eee;margin:6px 0">
          <div style="color:${col};font-weight:700">${statusText}</div>
          ${times.map(t => `<div style="font-size:12px;color:#555">${t}</div>`).join('')}
        </div>
      `);
    });

    // DCâ†’AC Verbindungslinien auf Karte
    projekte.filter(p => p.dcDate && p.acDate && p.lat && p.lng).forEach(p => {
      // Leichte Verschiebung fÃ¼r AC (simuliert verschiedene Standorte - in echt wÃ¤re es gleich)
      // Hier zeigen wir die Verbindung als gestrichelte Linie
      if(p.dcDate !== p.acDate) {
        const pt = PROJECT_TYPES[p.type];
        // Gleicher Ort, aber sinnvoll mit Label
        L.circleMarker([p.lat, p.lng], {
          radius:22, color:pt?.color || C.dim, fillColor:'transparent',
          weight:1, dashArray:'4,4', opacity:0.3
        }).addTo(map).bindTooltip(`${p.customer} Â· DC ${fmtDay(p.dcDate)} â†’ AC ${fmtDay(p.acDate)}`, {className:'dark-tip'});
      }
    });

    // Fit bounds
    if(todayProjects.length > 0) {
      const bounds = todayProjects.map(p => [p.lat, p.lng]);
      map.fitBounds(bounds, { padding:[40,40], maxZoom:11 });
    }
  }, [projekte]);

  return (
    <div style={{height:'100%', position:'relative'}}>
      <div ref={mapRef} style={{height:'100%', width:'100%'}}/>
      {/* Legende */}
      <div style={{position:'absolute', bottom:20, left:20, background:C.panel+'ee', border:`1px solid ${C.border}`, borderRadius:8, padding:'10px 14px', zIndex:1000}}>
        <div style={{fontSize:10, color:C.dim, fontWeight:700, marginBottom:6}}>LIVE STATUS</div>
        {[
          [C.green, 'â— Montage + Engel âœ“'],
          [C.orange, 'â— Bauengel fehlt'],
          [C.red, 'â— Montage nicht gestartet'],
          [C.dim, 'â— Geplant (noch nicht heute)'],
        ].map(([col, label]) => (
          <div key={label} style={{display:'flex', alignItems:'center', gap:6, marginBottom:3}}>
            <div style={{width:10, height:10, borderRadius:'50%', background:col}}/>
            <span style={{fontSize:11, color:C.text}}>{label}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPACITY VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function CapacityView({ weekDays, techs, engel, techSlots, engelSlots, projekte }) {
  const stats = {
    all: projekte.length,
    fully: projekte.filter(p => p.status==='fully_planned').length,
    partial: projekte.filter(p => p.status==='dc_planned').length,
    unplanned: projekte.filter(p => p.status==='unplanned').length,
  };

  return (
    <div style={{padding:16, display:'grid', gridTemplateColumns:'1fr 1fr', gap:14}}>
      <div style={{gridColumn:'1/-1', display:'grid', gridTemplateColumns:'repeat(4,1fr)', gap:10}}>
        {[['Gesamt',stats.all,C.text],['VollstÃ¤ndig',stats.fully,C.green],['Nur DC',stats.partial,C.yellow],['Ungeplant',stats.unplanned,C.red]].map(([l,v,col]) =>
          <div key={l} style={{background:C.panel, border:`1px solid ${C.border}`, borderRadius:9, padding:'12px 14px'}}>
            <div style={{fontSize:11, color:C.dim, marginBottom:4}}>{l}</div>
            <div style={{fontSize:26, fontWeight:800, color:col}}>{v}</div>
          </div>
        )}
      </div>

      <div style={{background:C.panel, border:`1px solid ${C.border}`, borderRadius:10, padding:14}}>
        <div style={{fontSize:13, fontWeight:700, marginBottom:12}}>ğŸ‘· Monteur-Auslastung (KW)</div>
        {techs.map(t => {
          const load = weekDays.reduce((s,wd) => s + (techSlots[`${t.id}_${fmtDate(wd)}`]||[]).length, 0);
          const max = t.cap * weekDays.length;
          const pct = max>0 ? load/max*100 : 0;
          return (
            <div key={t.id} style={{marginBottom:8}}>
              <div style={{display:'flex', gap:6, alignItems:'center', marginBottom:2}}>
                <Avatar ini={t.ini} col={t.color} size={18}/>
                <span style={{fontSize:11, flex:1, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{t.name}</span>
                <span style={{fontSize:11, color:pct>=80?C.red:pct>=40?C.yellow:C.green, fontWeight:600}}>{pct.toFixed(0)}%</span>
              </div>
              <ProgressBar pct={pct}/>
            </div>
          );
        })}
      </div>

      <div style={{background:C.panel, border:`1px solid ${C.border}`, borderRadius:10, padding:14}}>
        <div style={{fontSize:13, fontWeight:700, marginBottom:12, color:C.teal}}>ğŸ•Šï¸ Bauengel-Auslastung (KW)</div>
        {engel.map(e => {
          const load = weekDays.reduce((s,wd) => s + (engelSlots[`${e.id}_${fmtDate(wd)}`]||[]).length, 0);
          const max = e.cap * weekDays.length;
          const pct = max>0 ? load/max*100 : 0;
          return (
            <div key={e.id} style={{marginBottom:8}}>
              <div style={{display:'flex', gap:6, alignItems:'center', marginBottom:2}}>
                <Avatar ini={e.ini} col={C.teal} size={18}/>
                <span style={{fontSize:11, flex:1}}>{e.name}</span>
                <span style={{fontSize:11, color:pct>=80?C.red:pct>=40?C.yellow:C.teal, fontWeight:600}}>{pct.toFixed(0)}%</span>
              </div>
              <ProgressBar pct={pct} color={C.teal}/>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED COMPONENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SectionHeader({ label, count, colTemplate, color=C.dim }) {
  return (
    <div style={{display:'grid', gridTemplateColumns:colTemplate, position:'sticky', top:56, zIndex:20, background:C.bg}}>
      <div style={{borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'4px 10px', display:'flex', gap:6, alignItems:'center', background:'rgba(0,0,0,0.5)'}}>
        <span style={{fontSize:10, fontWeight:800, color, textTransform:'uppercase', letterSpacing:'0.08em'}}>{label}</span>
        <span style={{background:color+'22', color, borderRadius:4, padding:'0 5px', fontSize:10, fontWeight:700}}>{count}</span>
      </div>
      {Array.from({length:5}).map((_,i) =>
        <div key={i} style={{borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, background:'rgba(0,0,0,0.5)'}}/>
      )}
    </div>
  );
}

function PersonCell({ who, isEngel=false }) {
  return (
    <div style={{background:C.cardHover, borderRight:`1px solid ${C.border}`, borderBottom:`1px solid ${C.border}`, padding:'7px 9px', display:'flex', flexDirection:'column', gap:4}}>
      <div style={{display:'flex', alignItems:'center', gap:6}}>
        <Avatar ini={who.ini} col={who.color || C.dim}/>
        <div style={{minWidth:0}}>
          <div style={{fontSize:11, fontWeight:700, color:C.text, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{who.name}</div>
          <div style={{fontSize:9, color:C.muted}}>{who.region}{who.sub?' Â· SU':''}{isEngel?' Â· ğŸ•Šï¸':''}</div>
        </div>
      </div>
      {!isEngel && who.skills && (
        <div style={{display:'flex', gap:2, flexWrap:'wrap'}}>
          {who.skills.map(s => {
            const pt = Object.values(PROJECT_TYPES).find((_,i) => Object.keys(PROJECT_TYPES)[i]===s) || {};
            const col = PROJECT_TYPES[s]?.color || C.muted;
            return <span key={s} style={{background:col+'18', color:col, borderRadius:3, padding:'1px 3px', fontSize:8, fontWeight:700}}>{s.replace('pv_','').replace('_',' ').toUpperCase()}</span>;
          })}
        </div>
      )}
    </div>
  );
}

function Avatar({ ini, col, size=26 }) {
  return (
    <div style={{width:size, height:size, borderRadius:'50%', flexShrink:0, background:(col||C.dim)+'20', color:col||C.dim, display:'flex', alignItems:'center', justifyContent:'center', fontSize:size*0.35, fontWeight:800, border:`1px solid ${col||C.dim}30`}}>{ini}</div>
  );
}

function Badge({ col, label }) {
  return <div style={{background:col+'15', color:col, borderRadius:4, padding:'2px 8px', fontSize:11, fontWeight:700}}>{label}</div>;
}

function CountBadge({ val, col }) {
  return <div style={{background:col+'25', color:col, borderRadius:4, padding:'0 7px', fontSize:11, fontWeight:700}}>{val}</div>;
}

function SmBtn({ onClick, children }) {
  return <button onClick={onClick} style={{background:'none', border:'none', color:C.dim, cursor:'pointer', padding:'3px 8px', fontSize:14}}>{children}</button>;
}

function ProgressBar({ pct, color }) {
  const col = color || (pct>=80 ? C.red : pct>=40 ? C.yellow : C.green);
  return (
    <div style={{height:4, background:C.cardHover, borderRadius:2, overflow:'hidden'}}>
      <div style={{height:'100%', background:col, width:`${Math.min(pct,100)}%`, borderRadius:2, transition:'width 0.4s'}}/>
    </div>
  );
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAN MODAL (Sidebar-Klick â†’ Terminierung + Umplanung)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function PlanModal({ proj, onClose, updateProject, monteure, engel }) {
  const pt = PROJECT_TYPES[proj.type];
  const [dcDate, setDcDate] = useState(proj.dcDate || '');
  const [acDate, setAcDate] = useState(proj.acDate || '');
  const [dcTechId, setDcTechId] = useState(proj.dcTechId || '');
  const [acTechId, setAcTechId] = useState(proj.acTechId || '');
  const [engelId, setEngelId] = useState(proj.engelId || '');
  const [reason, setReason] = useState('');
  const isReplan = !!(proj.dcDate || proj.acDate);

  const dcSkill = pt.dcSkill;
  const acSkill = pt.acSkill;
  const dcMonteure = dcSkill ? monteure.filter(m => m.skills.includes(dcSkill)) : [];
  const acMonteure = acSkill ? monteure.filter(m => m.skills.includes(acSkill)) : [];

  // Auto AC-Datum wenn DC gesetzt wird (1 Werktag nach letztem DC-Tag)
  const handleDcDateChange = (val) => {
    setDcDate(val);
    if(val && pt.acSkill) {
      const autoAc = calcAcDate(val, proj.dcDuration || 1);
      setAcDate(autoAc);
    }
  };

  const handleSave = () => {
    const changes = {};
    if(dcDate) changes.dcDate = dcDate;
    if(dcTechId) changes.dcTechId = Number(dcTechId);
    if(pt.acSkill && acDate) changes.acDate = acDate;
    if(acTechId) changes.acTechId = Number(acTechId);
    if(engelId) changes.engelId = Number(engelId);
    if(reason) changes.replanReason = reason;
    updateProject(proj.id, changes);
    onClose();
  };

  const inputStyle = {width:'100%', background:C.card, border:`1px solid ${C.border}`, borderRadius:6, padding:'8px 10px', color:C.text, fontSize:13, outline:'none'};
  const selectStyle = {...inputStyle, cursor:'pointer'};
  const labelStyle = {fontSize:11, color:C.dim, fontWeight:600, marginBottom:4, display:'block'};

  return (
    <div onClick={onClose} style={{position:'fixed', inset:0, background:'rgba(0,0,0,0.7)', zIndex:9999, display:'flex', alignItems:'center', justifyContent:'center', backdropFilter:'blur(4px)'}}>
      <div onClick={e=>e.stopPropagation()} style={{background:C.panel, border:`1px solid ${C.border}`, borderRadius:14, width:460, maxHeight:'88vh', overflow:'auto', padding:0}}>
        {/* Header */}
        <div style={{padding:'16px 20px', borderBottom:`1px solid ${C.border}`, display:'flex', justifyContent:'space-between', alignItems:'center'}}>
          <div>
            <div style={{fontSize:10, color:pt.color, fontWeight:700, marginBottom:2}}>{pt.icon} {pt.label} {proj.kwp > 0 ? `Â· ${proj.kwp} kWp` : ''}</div>
            <div style={{fontSize:18, fontWeight:800, color:C.text}}>{isReplan ? 'ğŸ”„ Umplanung' : 'ğŸ“… Terminierung'}: {proj.customer}</div>
            <div style={{fontSize:12, color:C.dim, marginTop:2}}>{proj.plz} {proj.city} Â· {proj.address}</div>
          </div>
          <button onClick={onClose} style={{background:C.cardHover, border:`1px solid ${C.border}`, borderRadius:8, width:32, height:32, cursor:'pointer', color:C.dim, fontSize:16, display:'flex', alignItems:'center', justifyContent:'center'}}>âœ•</button>
        </div>

        {/* Info */}
        <div style={{padding:'10px 20px', borderBottom:`1px solid ${C.border}`, display:'flex', gap:8, flexWrap:'wrap'}}>
          <Badge col={pt.color} label={`${proj.id}`}/>
          {proj.notes && <Badge col={C.dim} label={`ğŸ“‹ ${proj.notes}`}/>}
          {proj.kwp > 10 && <Badge col={C.orange} label={`âš¡ ${proj.kwp}kWp â†’ DC 2 Tage`}/>}
          {proj.priority==='high' && <Badge col={C.red} label="ğŸ”´ Hoch"/>}
          {proj.priority==='medium' && <Badge col={C.yellow} label="ğŸŸ¡ Mittel"/>}
        </div>

        {/* Umplanungsgrund */}
        {isReplan && (
          <div style={{padding:'12px 20px 0'}}>
            <div style={{background:C.orange+'10', border:`1px solid ${C.orange}33`, borderRadius:8, padding:12}}>
              <div style={{fontSize:12, fontWeight:700, color:C.orange, marginBottom:6}}>âš ï¸ Grund der Umplanung</div>
              <select value={reason} onChange={e=>setReason(e.target.value)} style={selectStyle}>
                <option value="">â€“ Grund wÃ¤hlen â€“</option>
                <option value="wetter">ğŸŒ§ï¸ Wetter (Regen/Sturm)</option>
                <option value="material">ğŸ“¦ Material fehlt</option>
                <option value="monteur_krank">ğŸ¤’ Monteur krank</option>
                <option value="kunde">ğŸ‘¤ Kunde nicht verfÃ¼gbar</option>
                <option value="geruestbau">ğŸ—ï¸ GerÃ¼st nicht rechtzeitig</option>
                <option value="netzanmeldung">ğŸ“‹ Netzanmeldung fehlt</option>
                <option value="sonstiges">ğŸ“ Sonstiges</option>
              </select>
            </div>
          </div>
        )}

        {/* Form */}
        <div style={{padding:'12px 20px', display:'flex', flexDirection:'column', gap:12}}>
          {pt.dcSkill && (
            <div style={{background:C.dc+'08', border:`1px solid ${C.dc}22`, borderRadius:8, padding:12}}>
              <div style={{fontSize:12, fontWeight:700, color:C.dc, marginBottom:10}}>âš¡ DC â€“ {pt.dcTag || 'Dachmontage'}</div>
              <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                <div>
                  <label style={labelStyle}>Datum</label>
                  <input type="date" value={dcDate} onChange={e=>handleDcDateChange(e.target.value)} style={inputStyle}/>
                </div>
                <div>
                  <label style={labelStyle}>Monteur</label>
                  <select value={dcTechId} onChange={e=>setDcTechId(e.target.value)} style={selectStyle}>
                    <option value="">â€“ WÃ¤hlen â€“</option>
                    {dcMonteure.map(m => <option key={m.id} value={m.id}>{m.ini} Â· {m.name}{m.sub?' (SU)':''}</option>)}
                  </select>
                </div>
              </div>
              {proj.dcDuration >= 2 && <div style={{fontSize:10, color:C.orange, marginTop:6}}>âš¡ 2-Tage-Montage ({proj.kwp}kWp)</div>}
            </div>
          )}

          {pt.acSkill && (
            <div style={{background:C.ac+'08', border:`1px solid ${C.ac}22`, borderRadius:8, padding:12}}>
              <div style={{fontSize:12, fontWeight:700, color:C.ac, marginBottom:6}}>ğŸ”Œ AC â€“ {pt.acTag || 'Elektro + IBN'}</div>
              <div style={{fontSize:10, color:C.dim, marginBottom:8}}>AC immer 1 Werktag nach letztem DC-Tag</div>
              <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                <div>
                  <label style={labelStyle}>Datum (auto berechnet)</label>
                  <input type="date" value={acDate} onChange={e=>setAcDate(e.target.value)} style={{...inputStyle, background:C.ac+'08'}}/>
                </div>
                <div>
                  <label style={labelStyle}>Monteur</label>
                  <select value={acTechId} onChange={e=>setAcTechId(e.target.value)} style={selectStyle}>
                    <option value="">â€“ WÃ¤hlen â€“</option>
                    {acMonteure.map(m => <option key={m.id} value={m.id}>{m.ini} Â· {m.name}{m.sub?' (SU)':''}</option>)}
                  </select>
                </div>
              </div>
            </div>
          )}

          <div style={{background:C.teal+'08', border:`1px solid ${C.teal}22`, borderRadius:8, padding:12}}>
            <div style={{fontSize:12, fontWeight:700, color:C.teal, marginBottom:4}}>ğŸ•Šï¸ Bauengel</div>
            <div style={{fontSize:10, color:C.dim, marginBottom:8}}>Sortiert nach Entfernung zur Baustelle ({proj.plz} {proj.city})</div>
            {(() => {
              const sorted = [...engel].map(e => ({...e, dist: plzDist(proj.plz, e.plz)})).sort((a,b) => a.dist - b.dist);
              const recommended = sorted[0];
              // Auto-select nearest if none chosen
              if(!engelId && recommended) setTimeout(()=>setEngelId(String(recommended.id)),0);
              return (
                <div style={{display:'flex', flexDirection:'column', gap:4}}>
                  {sorted.map((e, idx) => {
                    const isSelected = String(engelId) === String(e.id);
                    const isRec = idx === 0;
                    const distKm = e.dist < 1 ? '<1' : e.dist.toFixed(0);
                    return (
                      <div key={e.id} onClick={()=>setEngelId(String(e.id))} style={{
                        display:'flex', alignItems:'center', gap:8, padding:'6px 8px',
                        background: isSelected ? C.teal+'18' : C.card,
                        border: `1px solid ${isSelected ? C.teal : C.border}`,
                        borderRadius:6, cursor:'pointer', transition:'all 0.15s',
                      }}>
                        {e.foto ? (
                          <img src={e.foto} style={{width:28, height:28, borderRadius:'50%', objectFit:'cover', border:`2px solid ${isSelected?C.teal:C.border}`, flexShrink:0}} onError={ev=>{ev.target.style.display='none'}}/>
                        ) : (
                          <Avatar ini={e.ini} col={C.teal} size={28}/>
                        )}
                        <div style={{flex:1, minWidth:0}}>
                          <div style={{display:'flex', gap:4, alignItems:'center'}}>
                            <span style={{fontSize:11, fontWeight:700, color:isSelected?C.teal:C.text}}>{e.name}</span>
                            {isRec && <span style={{fontSize:8, background:C.green+'22', color:C.green, borderRadius:3, padding:'1px 5px', fontWeight:800}}>âœ“ EMPFOHLEN</span>}
                          </div>
                          <div style={{fontSize:9, color:C.dim}}>{e.region} Â· PLZ {e.plz}</div>
                        </div>
                        <div style={{textAlign:'right', flexShrink:0}}>
                          <div style={{fontSize:11, fontWeight:700, color:e.dist < 10 ? C.green : e.dist < 25 ? C.yellow : C.red}}>~{distKm} km</div>
                        </div>
                        {isSelected && <div style={{width:8, height:8, borderRadius:'50%', background:C.teal, flexShrink:0}}/>}
                      </div>
                    );
                  })}
                </div>
              );
            })()}
          </div>
        </div>

        {/* Actions */}
        <div style={{padding:'10px 20px 16px', display:'flex', gap:8, justifyContent:'flex-end'}}>
          <button onClick={onClose} style={{background:C.cardHover, border:`1px solid ${C.border}`, borderRadius:8, padding:'8px 20px', color:C.dim, fontSize:13, cursor:'pointer', fontWeight:600}}>Abbrechen</button>
          <button onClick={handleSave} style={{background:C.brand, border:'none', borderRadius:8, padding:'8px 24px', color:C.bg, fontSize:13, cursor:'pointer', fontWeight:800}}>
            {isReplan ? 'ğŸ”„ Umplanen' : 'ğŸ’¾ Einplanen'}
          </button>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL MODAL (Kalender-Klick â†’ Datensatz + Fortschritt + Umplanung)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DetailModal({ proj, onClose, onReplan }) {
  const pt = PROJECT_TYPES[proj.type];
  const bs = proj.baustelleStatus ? BSTATUS[proj.baustelleStatus] : null;
  const dcTech = MONTEURE.find(m => m.id === proj.dcTechId);
  const acTech = MONTEURE.find(m => m.id === proj.acTechId);
  const engelPerson = BAUENGEL.find(e => e.id === proj.engelId);
  const planer = PLANER.find(p => p.id === proj.planerId);
  const dcSteps = getDcSteps(proj.type);
  const acSteps = getAcSteps(proj.type);
  const dcProg = proj.dcProgress || [];
  const acProg = proj.acProgress || [];

  const Row = ({label, value, color}) => value ? (
    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'5px 0', borderBottom:`1px solid ${C.border}30`}}>
      <span style={{fontSize:12, color:C.dim}}>{label}</span>
      <span style={{fontSize:13, fontWeight:600, color:color||C.text}}>{value}</span>
    </div>
  ) : null;

  const ProgressTimeline = ({steps, progress, phaseColor}) => (
    <div style={{marginTop:6}}>
      {/* Mini progress bar */}
      <div style={{display:'flex', gap:2, marginBottom:8}}>
        {steps.map(s => {
          const done = progress.some(p => p.step === s.key);
          return <div key={s.key} style={{flex:1, height:4, borderRadius:2, background:done?C.green:C.border+'66', transition:'all 0.3s'}}/>;
        })}
      </div>
      <div style={{fontSize:10, color:C.dim, marginBottom:4}}>{progress.length}/{steps.length} Schritte abgeschlossen</div>
      {steps.map(s => {
        const entry = progress.find(p => p.step === s.key);
        return (
          <React.Fragment key={s.key}>
            <div style={{display:'flex', alignItems:'center', gap:8, padding:'4px 0', opacity:entry?1:0.4}}>
              <div style={{width:22, height:22, borderRadius:'50%', background:entry?C.green+'22':C.border, display:'flex', alignItems:'center', justifyContent:'center', fontSize:11, flexShrink:0, border:`1px solid ${entry?C.green:C.border}`}}>
                {entry ? 'âœ“' : s.icon}
              </div>
              <div style={{flex:1, minWidth:0}}>
                <span style={{fontSize:11, fontWeight:entry?700:400, color:entry?C.text:C.muted}}>{s.label}</span>
              </div>
              {entry && (
                <div style={{display:'flex', gap:4, alignItems:'center'}}>
                  {entry.foto && <span style={{fontSize:10, background:C.blue+'18', color:C.blue, borderRadius:3, padding:'1px 5px'}}>ğŸ“·</span>}
                  <span style={{fontSize:10, color:C.dim}}>{fmtTime(entry.at)}</span>
                </div>
              )}
            </div>
            {/* Inline Foto vom Bauengel/Monteur */}
            {entry && entry.foto && (
              <div style={{marginLeft:30, marginBottom:6, borderRadius:6, overflow:'hidden', border:`1px solid ${C.border}`, maxHeight:100}}>
                <img src={entry.foto} style={{width:'100%', height:100, objectFit:'cover', display:'block'}} onError={e=>{e.target.parentElement.style.display='none'}}/>
              </div>
            )}
          </React.Fragment>
        );
      })}
    </div>
  );

  return (
    <div onClick={onClose} style={{position:'fixed', inset:0, background:'rgba(0,0,0,0.7)', zIndex:9999, display:'flex', alignItems:'center', justifyContent:'center', backdropFilter:'blur(4px)'}}>
      <div onClick={e=>e.stopPropagation()} style={{background:C.panel, border:`1px solid ${C.border}`, borderRadius:14, width:480, maxHeight:'90vh', overflow:'auto'}}>
        {/* Header */}
        <div style={{padding:'16px 20px', borderBottom:`1px solid ${C.border}`, position:'relative'}}>
          {bs && (
            <div style={{marginBottom:8, display:'inline-flex', background:bs.col+'18', border:`1px solid ${bs.col}44`, borderRadius:6, padding:'3px 10px', alignItems:'center', gap:4}}>
              <span style={{fontSize:11, fontWeight:700, color:bs.col}}>{bs.label}</span>
            </div>
          )}
          <div style={{fontSize:10, color:pt.color, fontWeight:700, marginBottom:2}}>{pt.icon} {pt.label} {proj.kwp > 0 ? `Â· ${proj.kwp} kWp` : ''}</div>
          <div style={{fontSize:20, fontWeight:800, color:C.text}}>{proj.customer}</div>
          <div style={{fontSize:13, color:C.dim, marginTop:4}}>{proj.plz} {proj.city} Â· {proj.address}</div>
          <button onClick={onClose} style={{position:'absolute', top:14, right:14, background:C.cardHover, border:`1px solid ${C.border}`, borderRadius:8, width:32, height:32, cursor:'pointer', color:C.dim, fontSize:16, display:'flex', alignItems:'center', justifyContent:'center'}}>âœ•</button>
        </div>

        {/* Details */}
        <div style={{padding:'8px 20px'}}>
          <Row label="Projekt-ID" value={proj.id}/>
          <Row label="Typ" value={`${pt.icon} ${pt.label}`} color={pt.color}/>
          {proj.kwp > 0 && <Row label="Leistung" value={`${proj.kwp} kWp`} color={C.orange}/>}
          {proj.notes && <Row label="Dachtyp" value={proj.notes}/>}
          <Row label="PrioritÃ¤t" value={proj.priority==='high'?'ğŸ”´ Hoch':proj.priority==='medium'?'ğŸŸ¡ Mittel':'ğŸŸ¢ Normal'} color={proj.priority==='high'?C.red:proj.priority==='medium'?C.yellow:C.green}/>
          {planer && <Row label="Geplant von (Innendienst)" value={`${planer.ini} Â· ${planer.name}`} color={C.purple}/>}
          <Row label="Status" value={proj.status==='fully_planned'?'âœ… VollstÃ¤ndig geplant':proj.status==='dc_planned'?'â³ DC geplant':'âš  Ungeplant'} color={proj.status==='fully_planned'?C.green:proj.status==='dc_planned'?C.yellow:C.red}/>
        </div>

        {/* DC Planung + Fortschritt */}
        {proj.dcDate && (
          <div style={{margin:'0 20px 8px', background:C.dc+'08', border:`1px solid ${C.dc}22`, borderRadius:8, padding:'10px 12px'}}>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
              <span style={{fontSize:12, fontWeight:700, color:C.dc}}>âš¡ DC â€“ {pt.dcTag || 'Dachmontage'}</span>
              <span style={{fontSize:13, fontWeight:700, color:C.text}}>{fmtDay(proj.dcDate)}{proj.dcDuration>=2 ? ` (${proj.dcDuration} Tage)` : ''}</span>
            </div>
            {dcTech && (
              <div style={{display:'flex', alignItems:'center', gap:6, marginTop:6}}>
                <Avatar ini={dcTech.ini} col={dcTech.color} size={22}/>
                <span style={{fontSize:12, color:C.text}}>{dcTech.name}</span>
                {dcTech.sub && <span style={{fontSize:9, color:C.muted, background:C.muted+'22', borderRadius:3, padding:'1px 4px'}}>SU</span>}
              </div>
            )}
            {proj.montageStartedAt && <div style={{fontSize:10, color:C.green, marginTop:4}}>â–¶ Gestartet um {fmtTime(proj.montageStartedAt)}</div>}
            {/* DC Fortschritt */}
            {dcSteps && <ProgressTimeline steps={dcSteps} progress={dcProg} phaseColor={C.dc}/>}
          </div>
        )}

        {/* AC Planung + Fortschritt */}
        {proj.acDate && (
          <div style={{margin:'0 20px 8px', background:C.ac+'08', border:`1px solid ${C.ac}22`, borderRadius:8, padding:'10px 12px'}}>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
              <span style={{fontSize:12, fontWeight:700, color:C.ac}}>ğŸ”Œ AC â€“ {pt.acTag || 'Elektro + IBN'}</span>
              <span style={{fontSize:13, fontWeight:700, color:C.text}}>{fmtDay(proj.acDate)}</span>
            </div>
            {acTech && (
              <div style={{display:'flex', alignItems:'center', gap:6, marginTop:6}}>
                <Avatar ini={acTech.ini} col={acTech.color} size={22}/>
                <span style={{fontSize:12, color:C.text}}>{acTech.name}</span>
                {acTech.sub && <span style={{fontSize:9, color:C.muted, background:C.muted+'22', borderRadius:3, padding:'1px 4px'}}>SU</span>}
              </div>
            )}
            {/* AC Fortschritt */}
            {acSteps && acProg.length > 0 && <ProgressTimeline steps={acSteps} progress={acProg} phaseColor={C.ac}/>}
          </div>
        )}

        {/* Bauengel */}
        {engelPerson && (
          <div style={{margin:'0 20px 8px', background:C.teal+'08', border:`1px solid ${C.teal}22`, borderRadius:8, padding:'10px 12px'}}>
            <div style={{fontSize:12, fontWeight:700, color:C.teal}}>ğŸ•Šï¸ Bauengel</div>
            <div style={{display:'flex', alignItems:'center', gap:6, marginTop:6}}>
              <Avatar ini={engelPerson.ini} col={C.teal} size={22}/>
              <span style={{fontSize:12, color:C.text}}>{engelPerson.name}</span>
              <span style={{fontSize:10, color:C.dim}}>{engelPerson.region}</span>
            </div>
            {proj.engelArrivedAt && <div style={{fontSize:10, color:C.teal, marginTop:4}}>ğŸ•Šï¸ Angekommen um {fmtTime(proj.engelArrivedAt)}</div>}
          </div>
        )}

        {/* Fotos + Aktualisierung */}
        {(proj.fotoCount > 0 || proj.letzteAktualisierung) && (
          <div style={{padding:'4px 20px 8px', display:'flex', gap:8, flexWrap:'wrap'}}>
            {proj.fotoCount > 0 && <Badge col={C.blue} label={`ğŸ“· ${proj.fotoCount} Fotos`}/>}
            {proj.letzteAktualisierung && <Badge col={C.dim} label={`ğŸ• ${fmtTime(proj.letzteAktualisierung)}`}/>}
          </div>
        )}

        {/* Umplanen-Button */}
        <div style={{padding:'8px 20px', borderTop:`1px solid ${C.border}`}}>
          {proj.replanReason && (
            <div style={{background:C.orange+'10', border:`1px solid ${C.orange}22`, borderRadius:6, padding:'6px 10px', marginBottom:8, fontSize:11, color:C.orange}}>
              ğŸ”„ Letzte Umplanung: {{wetter:'ğŸŒ§ï¸ Wetter',material:'ğŸ“¦ Material',monteur_krank:'ğŸ¤’ Monteur krank',kunde:'ğŸ‘¤ Kunde',geruestbau:'ğŸ—ï¸ GerÃ¼st',netzanmeldung:'ğŸ“‹ Netzanmeldung',sonstiges:'ğŸ“ Sonstiges'}[proj.replanReason] || proj.replanReason}
            </div>
          )}
        </div>

        {/* Actions */}
        <div style={{padding:'4px 20px 16px', display:'flex', gap:8, justifyContent:'center'}}>
          <button onClick={onClose} style={{background:C.cardHover, border:`1px solid ${C.border}`, borderRadius:8, padding:'8px 24px', color:C.text, fontSize:13, cursor:'pointer', fontWeight:600}}>SchlieÃŸen</button>
          <button onClick={()=>{onClose(); onReplan(proj);}} style={{background:C.orange+'22', border:`1px solid ${C.orange}44`, borderRadius:8, padding:'8px 24px', color:C.orange, fontSize:13, cursor:'pointer', fontWeight:700}}>ğŸ”„ Umplanen</button>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KI PANEL â€“ Disponent, Briefing, Umplanung, Heatmap + Chat
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API key moved to server-side proxy

function buildKIContext(projekte, weekDays) {
  const planned = projekte.filter(p => p.dcDate || p.acDate);
  const unplanned = projekte.filter(p => !p.dcDate && !p.acDate);
  const incomplete = projekte.filter(p => {
    const pt = PROJECT_TYPES[p.type];
    return pt.dcSkill && pt.acSkill && ((p.dcDate && !p.acDate) || (p.acDate && !p.dcDate));
  });
  const days = weekDays.map(d => fmtDate(d));
  const wetterInfo = days.map(d => {
    const w = getWeather(d);
    return `${fmtDay(d)}: ${w.temp}Â°C, ${w.rain}% Regen ${w.warn?'âš  WARNUNG':'OK'}`;
  }).join('\n');
  const monteurInfo = MONTEURE.map(m =>
    `${m.ini} ${m.name} | PLZ ${m.plz} | ${m.region} | Skills: ${m.skills.join(',')} | Kap: ${m.cap}/Tag${m.sub?' (SU)':''}`
  ).join('\n');
  const engelInfo = BAUENGEL.map(e => `${e.ini} ${e.name} | PLZ ${e.plz} | ${e.region} | Kap: ${e.cap}/Tag`).join('\n');
  const projInfo = projekte.map(p => {
    const pt = PROJECT_TYPES[p.type];
    let s = `${p.id} | ${p.customer} | ${p.plz} ${p.city} | ${pt.icon} ${pt.label} | ${p.kwp}kWp | Prio: ${p.priority}`;
    if(p.dcDate) s += ` | DC: ${p.dcDate} (${MONTEURE.find(m=>m.id===p.dcTechId)?.name||'?'})`;
    if(p.acDate) s += ` | AC: ${p.acDate} (${MONTEURE.find(m=>m.id===p.acTechId)?.name||'?'})`;
    if(!p.dcDate && !p.acDate) s += ' | âš  UNGEPLANT';
    if(p.dcDate && !p.acDate && pt.acSkill) s += ' | âš  AC FEHLT';
    if(p.baustelleStatus) s += ` | Status: ${BSTATUS[p.baustelleStatus]?.label||p.baustelleStatus}`;
    return s;
  }).join('\n');

  return `Du bist der KI-Disponent bei bee-doo Solar, NRW. Heute ist Mo, 23.02.2026.
Du unterstÃ¼tzt bei Montageplanung, Wochenplanung, Umplanung und Analysen.
Antworte IMMER auf Deutsch, kurz und prÃ¤zise. Benutze Emojis.

REGELN:
- DC und AC sind NIEMALS am selben Tag! AC = mindestens 1 Werktag nach letztem DC-Tag.
- Bei >10kWp dauert DC 2 Tage.
- Monteure mÃ¶glichst nah an Baustelle (PLZ vergleichen).
- Bauengel mÃ¶glichst nah an Baustelle.
- Bei Regen >60%: KEINE Dachmontagen planen!
- PrioritÃ¤t high > medium > low.

WETTER KW 8:
${wetterInfo}

MONTEURE (${MONTEURE.length}):
${monteurInfo}

BAUENGEL (${BAUENGEL.length}):
${engelInfo}

PROJEKTE (${projekte.length}):
${projInfo}

ZUSAMMENFASSUNG:
- ${unplanned.length} ungeplant
- ${incomplete.length} unvollstÃ¤ndig (DC/AC fehlt)
- ${planned.length} geplant
- Wetter-Warnungen: ${days.filter(d=>getWeather(d).warn).map(d=>fmtDay(d)).join(', ')||'keine'}

Wenn du PlanungsvorschlÃ¤ge machst, gib sie in diesem Format:
PLAN: [Projekt-ID] | DC: [Datum] | Monteur: [Name] | AC: [Datum] | Monteur: [Name] | Engel: [Name]`;
}

function KIPanel({ projekte, weekDays, techSlots, engelSlots, updateProject, onClose }) {
  const [kiTab, setKiTab] = useState('briefing');
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [briefing, setBriefing] = useState(null);
  const [autoplan, setAutoplan] = useState(null);
  const chatEndRef = useRef(null);

  const systemPrompt = useMemo(() => buildKIContext(projekte, weekDays), [projekte, weekDays]);

  const callClaude = async (userMsg, tabContext='') => {
    setLoading(true);
    try {
      const msgs = tabContext
        ? [{ role:'user', content: tabContext + '\n\n' + userMsg }]
        : [...messages.map(m=>({role:m.role,content:m.text})), { role:'user', content: userMsg }];
      const resp = await fetch('/api/ai-proxy', {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ model:'claude-sonnet-4-5-20250514', max_tokens:2000, system:systemPrompt, messages:msgs })
      });
      const data = await resp.json();
      const text = data.content?.map(c=>c.text||'').join('')||'Fehler bei KI-Antwort';
      setLoading(false);
      return text;
    } catch(e) { setLoading(false); return `âŒ Fehler: ${e.message}`; }
  };

  // Auto-Briefing laden
  useEffect(() => {
    if(kiTab==='briefing' && !briefing) {
      (async()=>{
        const text = await callClaude(
          'Erstelle ein kurzes Tages-Briefing fÃ¼r heute (23.02.2026). Maximal 10 Zeilen. Zeige: 1) Aktive Baustellen heute mit Status, 2) Wetter-Risiken, 3) Probleme (fehlende Bauengel, nicht gestartet), 4) Monteur-Auslastung, 5) Dringendste Handlungsempfehlung.',
          'TAGES-BRIEFING fÃ¼r den Disponenten:'
        );
        setBriefing(text);
      })();
    }
  }, [kiTab]);

  const handleAutoplan = async () => {
    setAutoplan(null);
    const text = await callClaude(
      'Plane alle ungeplanten Projekte optimal fÃ¼r KW 8 ein. Beachte: Wetter, PLZ-NÃ¤he Monteurâ†”Baustelle, KapazitÃ¤ten, DCâ‰ AC selber Tag, >10kWp=2 Tage DC. Gib fÃ¼r jedes Projekt einen konkreten Vorschlag im PLAN: Format. Danach eine kurze BegrÃ¼ndung pro Vorschlag.',
      'AUTOPLANER â€“ Optimale Wochenplanung:'
    );
    setAutoplan(text);
  };

  const handleUmplanung = async () => {
    const text = await callClaude(
      'Analysiere alle Wetter-Warnungen und laufenden Probleme. Welche Baustellen sollten UMGEPLANT werden? FÃ¼r jede: Warum + konkreter Alternativtermin + passender Monteur. Gib konkrete PLAN: VorschlÃ¤ge.',
      'INTELLIGENTE UMPLANUNG â€“ Wetter & AusfÃ¤lle:'
    );
    setMessages(prev => [...prev, {role:'user',text:'ğŸ”„ Umplanungs-Analyse gestartet'},{role:'assistant',text}]);
    setKiTab('chat');
  };

  const handleMonteurCheck = async () => {
    const q = 'Welche Monteure sind diese Woche Ã¼ber- oder unterlastet? Wer hat noch freie KapazitÃ¤t?';
    setMessages(prev=>[...prev,{role:'user',text:q}]);
    setKiTab('chat');
    const t = await callClaude(q);
    setMessages(prev=>[...prev,{role:'assistant',text:t}]);
  };

  const handleProblemReport = async () => {
    const q = 'Zeige alle Projekte die Probleme haben: fehlende Bauengel, nicht gestartete Montagen, unvollstÃ¤ndige Planung. Was muss ich JETZT tun?';
    setMessages(prev=>[...prev,{role:'user',text:q}]);
    setKiTab('chat');
    const t = await callClaude(q);
    setMessages(prev=>[...prev,{role:'assistant',text:t}]);
  };

  const handleHeatmap = async () => {
    const text = await callClaude(
      'Erstelle eine KapazitÃ¤ts-Analyse fÃ¼r die nÃ¤chsten 4 Wochen. Zeige pro Woche: Wie viele Slots frei vs. belegt, welche Monteure Ã¼berlastet/unterlastet sind, wo EngpÃ¤sse drohen. Gib Empfehlungen zur Auslastungsoptimierung.',
      'KAPAZITÃ„TS-ANALYSE:'
    );
    setMessages(prev => [...prev, {role:'user',text:'ğŸ“Š KapazitÃ¤ts-Analyse gestartet'},{role:'assistant',text}]);
    setKiTab('chat');
  };

  const handleSend = async () => {
    if(!input.trim()) return;
    const userMsg = input.trim();
    setInput('');
    setMessages(prev => [...prev, {role:'user', text:userMsg}]);
    const reply = await callClaude(userMsg);
    setMessages(prev => [...prev, {role:'assistant', text:reply}]);
  };

  useEffect(()=>{ chatEndRef.current?.scrollIntoView({behavior:'smooth'}); }, [messages]);

  const tabBtnStyle = (active) => ({
    background:active?C.purple+'22':'transparent', color:active?C.purple:C.dim,
    border:`1px solid ${active?C.purple+'44':'transparent'}`, borderRadius:5,
    padding:'3px 8px', fontSize:9, cursor:'pointer', fontWeight:active?700:400, whiteSpace:'nowrap',
  });

  return (
    <aside style={{width:360, background:C.panel, borderLeft:`1px solid ${C.purple}33`, display:'flex', flexDirection:'column', flexShrink:0, overflow:'hidden'}}>
      {/* Header */}
      <div style={{padding:'8px 12px', borderBottom:`1px solid ${C.border}`, display:'flex', justifyContent:'space-between', alignItems:'center'}}>
        <div style={{display:'flex', alignItems:'center', gap:6}}>
          <span style={{fontSize:16}}>âœ¦</span>
          <span style={{fontSize:13, fontWeight:800, background:'linear-gradient(135deg,#A78BFA,#7C3AED)', WebkitBackgroundClip:'text', WebkitTextFillColor:'transparent'}}>KI-Disponent</span>
        </div>
        <button onClick={onClose} style={{background:'transparent', border:'none', color:C.dim, cursor:'pointer', fontSize:14}}>âœ•</button>
      </div>

      {/* Tabs */}
      <div style={{padding:'6px 8px', borderBottom:`1px solid ${C.border}`, display:'flex', gap:4, flexWrap:'wrap'}}>
        {[['briefing','ğŸ“‹ Briefing'],['autoplan','âœ¨ Autoplaner'],['tools','ğŸ”§ Tools'],['chat','ğŸ’¬ Chat']].map(([k,l]) =>
          <button key={k} onClick={()=>setKiTab(k)} style={tabBtnStyle(kiTab===k)}>{l}</button>
        )}
      </div>

      {/* Content */}
      <div style={{flex:1, overflowY:'auto', padding:'10px 12px'}}>
        {/* BRIEFING */}
        {kiTab==='briefing' && (
          <div>
            <div style={{fontSize:12, fontWeight:800, color:C.purple, marginBottom:8}}>ğŸ“‹ Tages-Briefing Mo, 23.02.</div>
            {loading && !briefing && <div style={{textAlign:'center', padding:20, color:C.dim}}>
              <div style={{fontSize:20, animation:'blink 1s infinite'}}>âœ¦</div>
              <div style={{fontSize:11, marginTop:6}}>KI analysiert...</div>
            </div>}
            {briefing && <div style={{fontSize:11, color:C.text, lineHeight:'1.6', whiteSpace:'pre-wrap'}}>{briefing}</div>}
            <button onClick={()=>{setBriefing(null);}} style={{marginTop:10, background:C.purple+'15', border:`1px solid ${C.purple}33`, borderRadius:6, padding:'5px 12px', color:C.purple, fontSize:10, cursor:'pointer', fontWeight:600, width:'100%'}}>ğŸ”„ Neu generieren</button>
          </div>
        )}

        {/* AUTOPLANER */}
        {kiTab==='autoplan' && (
          <div>
            <div style={{fontSize:12, fontWeight:800, color:C.purple, marginBottom:4}}>âœ¨ KI-Autoplaner</div>
            <div style={{fontSize:10, color:C.dim, marginBottom:10}}>KI plant alle ungeplanten Projekte optimal ein â€“ basierend auf Wetter, Entfernungen, KapazitÃ¤ten und PrioritÃ¤ten.</div>
            {!autoplan && !loading && (
              <button onClick={handleAutoplan} style={{background:'linear-gradient(135deg,#A78BFA,#7C3AED)', border:'none', borderRadius:8, padding:'10px 20px', color:'#fff', fontSize:13, cursor:'pointer', fontWeight:800, width:'100%', boxShadow:'0 2px 12px rgba(167,139,250,0.3)'}}>âœ¨ Woche planen lassen</button>
            )}
            {loading && !autoplan && <div style={{textAlign:'center', padding:20, color:C.dim}}>
              <div style={{fontSize:24, animation:'blink 1s infinite'}}>âœ¦</div>
              <div style={{fontSize:11, marginTop:6}}>KI optimiert Wochenplan...</div>
              <div style={{fontSize:9, color:C.muted, marginTop:4}}>Analysiert {projekte.length} Projekte, {MONTEURE.length} Monteure, Wetter...</div>
            </div>}
            {autoplan && (
              <div>
                <div style={{fontSize:11, color:C.text, lineHeight:'1.6', whiteSpace:'pre-wrap', background:C.card, borderRadius:8, padding:10, border:`1px solid ${C.border}`}}>{autoplan}</div>
                <div style={{display:'flex', gap:6, marginTop:10}}>
                  <button onClick={()=>setAutoplan(null)} style={{flex:1, background:C.cardHover, border:`1px solid ${C.border}`, borderRadius:6, padding:'6px', color:C.dim, fontSize:10, cursor:'pointer', fontWeight:600}}>ğŸ”„ Neu</button>
                  <button onClick={()=>{setMessages(prev=>[...prev,{role:'user',text:'Autoplaner-Ergebnis'},{role:'assistant',text:autoplan}]);setKiTab('chat');}} style={{flex:1, background:C.purple+'22', border:`1px solid ${C.purple}44`, borderRadius:6, padding:'6px', color:C.purple, fontSize:10, cursor:'pointer', fontWeight:600}}>ğŸ’¬ Im Chat besprechen</button>
                </div>
              </div>
            )}
          </div>
        )}

        {/* TOOLS */}
        {kiTab==='tools' && (
          <div style={{display:'flex', flexDirection:'column', gap:8}}>
            <div style={{fontSize:12, fontWeight:800, color:C.purple, marginBottom:4}}>ğŸ”§ KI-Tools</div>
            <button onClick={handleUmplanung} disabled={loading} style={{background:C.orange+'10', border:`1px solid ${C.orange}33`, borderRadius:8, padding:'12px', cursor:'pointer', textAlign:'left'}}>
              <div style={{fontSize:12, fontWeight:700, color:C.orange}}>ğŸ”„ Intelligente Umplanung</div>
              <div style={{fontSize:10, color:C.dim, marginTop:3}}>Analysiert Wetter-Warnungen und AusfÃ¤lle, schlÃ¤gt optimale Alternativtermine vor</div>
            </button>
            <button onClick={handleHeatmap} disabled={loading} style={{background:C.blue+'10', border:`1px solid ${C.blue}33`, borderRadius:8, padding:'12px', cursor:'pointer', textAlign:'left'}}>
              <div style={{fontSize:12, fontWeight:700, color:C.blue}}>ğŸ“Š KapazitÃ¤ts-Heatmap</div>
              <div style={{fontSize:10, color:C.dim, marginTop:3}}>4-Wochen-Vorschau: EngpÃ¤sse, Auslastung, freie Slots pro Monteur</div>
            </button>
            <button onClick={handleMonteurCheck} disabled={loading} style={{background:C.green+'10', border:`1px solid ${C.green}33`, borderRadius:8, padding:'12px', cursor:'pointer', textAlign:'left'}}>
              <div style={{fontSize:12, fontWeight:700, color:C.green}}>ğŸ‘· Monteur-Check</div>
              <div style={{fontSize:10, color:C.dim, marginTop:3}}>Wer ist Ã¼berlastet, wer hat noch KapazitÃ¤t?</div>
            </button>
            <button onClick={handleProblemReport} disabled={loading} style={{background:C.red+'10', border:`1px solid ${C.red}33`, borderRadius:8, padding:'12px', cursor:'pointer', textAlign:'left'}}>
              <div style={{fontSize:12, fontWeight:700, color:C.red}}>ğŸš¨ Problem-Report</div>
              <div style={{fontSize:10, color:C.dim, marginTop:3}}>Alle akuten Probleme + sofortige Handlungsempfehlung</div>
            </button>
            {loading && <div style={{textAlign:'center', color:C.dim, fontSize:10, padding:8}}>âœ¦ KI arbeitet...</div>}
          </div>
        )}

        {/* CHAT */}
        {kiTab==='chat' && (
          <div style={{display:'flex', flexDirection:'column', height:'100%'}}>
            {messages.length===0 && (
              <div style={{textAlign:'center', padding:20, color:C.muted}}>
                <div style={{fontSize:28, marginBottom:8}}>âœ¦</div>
                <div style={{fontSize:12, fontWeight:600}}>KI-Disponent</div>
                <div style={{fontSize:10, marginTop:4}}>Frag mich was zu Planung, Montage, KapazitÃ¤t oder Optimierung</div>
              </div>
            )}
            {messages.map((m, i) => (
              <div key={i} style={{marginBottom:8, display:'flex', flexDirection:'column', alignItems:m.role==='user'?'flex-end':'flex-start'}}>
                <div style={{
                  maxWidth:'90%', padding:'6px 10px', borderRadius:m.role==='user'?'10px 10px 2px 10px':'10px 10px 10px 2px',
                  background:m.role==='user'?C.purple+'22':C.card, border:`1px solid ${m.role==='user'?C.purple+'33':C.border}`,
                  fontSize:11, color:C.text, lineHeight:'1.5', whiteSpace:'pre-wrap',
                }}>{m.text}</div>
              </div>
            ))}
            {loading && <div style={{fontSize:10, color:C.purple, padding:4}}>âœ¦ KI denkt nach...</div>}
            <div ref={chatEndRef}/>
          </div>
        )}
      </div>

      {/* Chat Input â€“ immer sichtbar */}
      <div style={{padding:'8px 10px', borderTop:`1px solid ${C.border}`, display:'flex', gap:6}}>
        <input value={input} onChange={e=>setInput(e.target.value)}
          onKeyDown={e=>e.key==='Enter'&&!e.shiftKey&&(e.preventDefault(),handleSend())}
          placeholder="Frag die KI..." disabled={loading}
          style={{flex:1, background:C.card, border:`1px solid ${C.border}`, borderRadius:6, padding:'7px 10px', color:C.text, fontSize:11, outline:'none'}}/>
        <button onClick={handleSend} disabled={loading||!input.trim()} style={{
          background:C.purple, border:'none', borderRadius:6, padding:'0 14px', color:'#fff',
          fontSize:12, cursor:'pointer', fontWeight:700, opacity:loading||!input.trim()?0.4:1,
        }}>â†‘</button>
      </div>
    </aside>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rootEl = ReactDOM.createRoot(document.getElementById('root'));
rootEl.render(<DispatchApp/>);
</script>

<script>
function _esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=String(s);return d.innerHTML;}
</script>
<!-- bee-doo KI-Modul -->
<script>
const BEEDOO_AI = {
  API_URL: '/api/ai-proxy',
  // API_KEY: moved to server-side proxy
  MODEL: 'claude-sonnet-4-5-20250514',
  
  async call(systemPrompt, userMessage, maxTokens = 1500) {
    try {
      const res = await fetch(this.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: this.MODEL,
          max_tokens: maxTokens,
          system: systemPrompt,
          messages: [{ role: 'user', content: userMessage }]
        })
      });
      if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'API Fehler'); }
      const data = await res.json();
      return data.content?.[0]?.text || '';
    } catch(e) { console.error('[bee-doo KI]', e); throw e; }
  },
  
  async callWithImage(systemPrompt, userMessage, base64, mediaType = 'image/jpeg', maxTokens = 1500) {
    try {
      const res = await fetch(this.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: this.MODEL,
          max_tokens: maxTokens,
          system: systemPrompt,
          messages: [{ role: 'user', content: [
            { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
            { type: 'text', text: userMessage }
          ] }]
        })
      });
      if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'API Fehler'); }
      const data = await res.json();
      return data.content?.[0]?.text || '';
    } catch(e) { console.error('[bee-doo KI]', e); throw e; }
  },
  
  safeHTML(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; },
  parseJSON(text) {
    try { return JSON.parse(text.replace(/```json|```/g, '').trim()); } catch(e) { return null; }
  }
};
</script>

<script>
window.BEEDOO_KI_DISPATCH = {
  async suggestAssignment(job, monteure) {
    const sys = `Du bist ein Montage-Dispositions-Experte fÃ¼r Solar-Installationen in NRW. Schlage die optimale Monteur-Zuordnung vor.
BerÃ¼cksichtige: Skills, Region/Entfernung, Auslastung, Erfahrung mit Auftragstyp.
Antworte als JSON: {"best_match":{"name":"...","reason":"..."},"alternatives":[{"name":"...","reason":"..."}],"scheduling_tip":"...","risk":"..."}`;
    const msg = `Auftrag: ${JSON.stringify(job)}\nVerfÃ¼gbare Monteure: ${JSON.stringify(monteure)}`;
    const result = await BEEDOO_AI.call(sys, msg);
    return BEEDOO_AI.parseJSON(result);
  },

  async optimizeRoute(assignments) {
    const sys = `Du bist ein Routen-Optimierer fÃ¼r Solar-Montage-Teams in NRW. Optimiere die Tagesroute.
Antworte als JSON: {"optimized_order":[{"name":"...","time":"...","reason":"..."}],"total_drive_time":"...","saved_time":"...","tip":"..."}`;
    const result = await BEEDOO_AI.call(sys, `Heutige AuftrÃ¤ge: ${JSON.stringify(assignments)}`);
    return BEEDOO_AI.parseJSON(result);
  },

  createButton() {
    const btn = document.createElement('button');
    btn.innerHTML = 'ğŸ¤– KI-Disposition';
    btn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;background:linear-gradient(135deg,#F5C500,#E07800);color:#000;border:none;padding:12px 20px;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;box-shadow:0 4px 20px rgba(245,197,0,.3);font-family:inherit;transition:all .2s';
    btn.onclick = async () => {
      btn.innerHTML = 'â³ Optimiere...';
      btn.disabled = true;
      try {
        const result = await BEEDOO_AI.call(
          'Du bist Dispositions-KI fÃ¼r Solar-Montagen. Analysiere die aktuelle Auftragslage und gib Empfehlungen. Antworte als JSON: {"status":"...","warnings":[{"text":"..."}],"suggestions":[{"text":"..."}],"efficiency_score":0}',
          'Analysiere das aktuelle Dispatch-Board: ' + document.querySelector('#root')?.textContent?.substring(0, 3000)
        );
        const data = BEEDOO_AI.parseJSON(result);
        if (data) this.showResults(data);
      } catch(e) { alert('KI-Fehler: ' + e.message); }
      btn.innerHTML = 'ğŸ¤– KI-Disposition';
      btn.disabled = false;
    };
    document.body.appendChild(btn);
  },

  showResults(data) {
    let p = document.getElementById('beedoo-dispatch-ai');
    if (!p) { p = document.createElement('div'); p.id = 'beedoo-dispatch-ai'; p.style.cssText = 'position:fixed;top:60px;right:20px;width:380px;max-width:90vw;max-height:80vh;background:#111827;border:1px solid #F5C50040;border-radius:16px;z-index:9998;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:20px'; document.body.appendChild(p); }
    let h = '<div style="display:flex;justify-content:space-between;margin-bottom:12px"><span style="font-weight:700;color:#F5C500;font-size:16px">ğŸ¤– Dispatch-KI</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:#666;font-size:18px;cursor:pointer">âœ•</button></div>';
    h += '<div style="text-align:center;margin-bottom:12px"><div style="font-size:32px;font-weight:800;color:#F5C500">' + (data.efficiency_score || 'â€”') + '%</div><div style="color:#9ca3af;font-size:11px">Effizienz-Score</div></div>';
    if (data.warnings?.length) { data.warnings.forEach(w => h += '<div style="background:#f8717115;padding:8px;border-radius:6px;margin-bottom:4px;border-left:3px solid #f87171;font-size:12px;color:#fca5a5">âš ï¸ ' + _esc(w.text) + '</div>'); }
    if (data.suggestions?.length) { h += '<div style="margin-top:8px;font-weight:600;color:#F5C500;font-size:12px;margin-bottom:6px">Empfehlungen:</div>'; data.suggestions.forEach(s => h += '<div style="background:#1e2235;padding:8px;border-radius:6px;margin-bottom:4px;font-size:12px;color:#d1d5db">ğŸ’¡ ' + _esc(s.text) + '</div>'); }
    p.innerHTML = h;
  }
};
document.addEventListener('DOMContentLoaded', () => setTimeout(() => BEEDOO_KI_DISPATCH.createButton(), 1000));
</script>

</body>
</html>
