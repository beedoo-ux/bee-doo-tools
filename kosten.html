<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo | Kosten-Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d1117;--s1:#161b22;--s2:#1c2333;--s3:#242c3d;--bd:#30363d;--t:#58a6ff;--y:#F5C500;--g:#3fb950;--r:#f85149;--o:#d29922;--ts:#8b95a5;--tw:#e6edf3;font-family:'DM Sans',sans-serif}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tw);min-height:100vh}
.header{background:linear-gradient(135deg,#0d1117 0%,#1a1a2e 50%,#16213e 100%);padding:20px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd)}
.header-left{display:flex;align-items:center;gap:14px}
.logo{width:40px;height:40px;background:var(--y);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:#000}
.header h1{font-size:20px;font-weight:700;letter-spacing:-0.3px}
.header .sub{font-size:12px;color:var(--ts);margin-top:2px}
.back{color:var(--ts);text-decoration:none;font-size:13px;transition:color .2s}
.back:hover{color:var(--y)}
.controls{display:flex;align-items:center;gap:12px;padding:16px 28px;background:var(--s1);border-bottom:1px solid var(--bd)}
.period-btn{background:var(--s2);border:1px solid var(--bd);color:var(--tw);padding:8px 16px;border-radius:8px;font-size:13px;font-family:inherit;cursor:pointer;transition:all .2s}
.period-btn:hover{border-color:var(--y);color:var(--y)}
.period-btn.active{background:var(--y);color:#000;border-color:var(--y);font-weight:600}
.content{padding:24px 28px;max-width:1400px;margin:0 auto}
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:24px}
.kpi{background:var(--s1);border:1px solid var(--bd);border-radius:12px;padding:20px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.yellow::before{background:var(--y)}
.kpi.blue::before{background:var(--t)}
.kpi.green::before{background:var(--g)}
.kpi.orange::before{background:var(--o)}
.kpi.red::before{background:var(--r)}
.kpi-label{font-size:11px;color:var(--ts);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.kpi-value{font-size:28px;font-weight:700;letter-spacing:-1px}
.kpi-sub{font-size:11px;color:var(--ts);margin-top:6px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.card{background:var(--s1);border:1px solid var(--bd);border-radius:12px;overflow:hidden}
.card-title{padding:16px 20px;border-bottom:1px solid var(--bd);font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.card-body{padding:20px}
.breakdown-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--bd)}
.breakdown-row:last-child{border-bottom:none}
.breakdown-left{display:flex;align-items:center;gap:10px}
.breakdown-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.breakdown-label{font-size:13px}
.breakdown-bar-wrap{flex:1;margin:0 16px;height:8px;background:var(--s3);border-radius:4px;overflow:hidden;min-width:80px}
.breakdown-bar{height:100%;border-radius:4px;transition:width .6s ease}
.breakdown-val{font-size:13px;font-weight:600;white-space:nowrap;min-width:90px;text-align:right}
.breakdown-pct{font-size:11px;color:var(--ts);min-width:40px;text-align:right}
.vt-table{width:100%;border-collapse:collapse}
.vt-table th{text-align:left;font-size:11px;color:var(--ts);text-transform:uppercase;letter-spacing:0.5px;padding:10px 12px;border-bottom:1px solid var(--bd)}
.vt-table td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--bd)}
.vt-table tr:last-child td{border-bottom:none}
.vt-table tr:hover{background:var(--s2)}
.vt-name{font-weight:600}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.badge-hgb{background:#58a6ff22;color:var(--t)}
.badge-ang{background:#3fb95022;color:var(--g)}
.cost-high{color:var(--r)}
.cost-mid{color:var(--o)}
.cost-low{color:var(--g)}
.trend-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.trend-card{background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:14px 16px;text-align:center}
.trend-month{font-size:11px;color:var(--ts);margin-bottom:6px}
.trend-val{font-size:22px;font-weight:700}
.trend-sub{font-size:11px;color:var(--ts);margin-top:4px}
.trend-change{font-size:11px;font-weight:600;margin-top:4px}
.trend-up{color:var(--r)}
.trend-down{color:var(--g)}
.donut-wrap{display:flex;align-items:center;justify-content:center;gap:32px;padding:16px 0}
.donut-center{text-align:center}
.donut-center .big{font-size:28px;font-weight:700}
.donut-center .small{font-size:11px;color:var(--ts)}
.loading{display:flex;align-items:center;justify-content:center;height:300px;color:var(--ts);font-size:14px}
.empty{text-align:center;padding:48px;color:var(--ts)}
.info-strip{background:var(--s2);border:1px solid var(--bd);border-radius:8px;padding:10px 16px;margin-bottom:20px;font-size:12px;color:var(--ts);display:flex;align-items:center;gap:8px}
@media(max-width:768px){
  .kpi-row{grid-template-columns:repeat(2,1fr)}.kpi-row .kpi:last-child{grid-column:span 2}
  .grid-2{grid-template-columns:1fr}
  .controls{flex-wrap:wrap;gap:8px}
  .content{padding:16px}
  .header{padding:16px}
  .kpi-value{font-size:22px}
}
@media(max-width:480px){
  .kpi-row{grid-template-columns:1fr}
  .kpi-row .kpi:last-child{grid-column:span 1}
  .header h1{font-size:16px}
  .vt-table{font-size:11px}
  .vt-table td,.vt-table th{padding:8px 6px}
}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect,useMemo} = React;

const SB_URL = 'https://hqzpemfaljxcysyqssng.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';
const sbG = async (t,q='') => { const r = await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{headers:{apikey:SB_KEY,Authorization:`Bearer ${SB_KEY}`}}); return r.json(); };
const fmtE = v => new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(v||0);
const fmtN = v => new Intl.NumberFormat('de-DE',{maximumFractionDigits:0}).format(v||0);
const monthLabel = p => { const [y,m] = p.split('-'); const names=['','Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez']; return `${names[parseInt(m)]} ${y}`; };

const COLORS = {provision:'#58a6ff',eigenlead:'#F5C500',empfehlung:'#3fb950',speicher:'#d29922',stufenbonus:'#f778ba',teambonus:'#bc8cff',systemgebuehr:'#f85149'};
const LABELS = {provision:'Grundprovision',eigenlead:'Eigenlead-Bonus',empfehlung:'Empfehlungs-Bonus',speicher:'Speicher-Bonus',stufenbonus:'Stufenbonus',teambonus:'Team-Bonus',systemgebuehr:'Systemgeb√ºhr'};

function DonutChart({data,size=180}){
  const total = data.reduce((s,d)=>s+d.value,0);
  if(!total) return null;
  const r = size/2; const ir = r*0.62; const cx=r; const cy=r;
  let cumAngle = -90;
  const paths = data.filter(d=>d.value>0).map((d,i)=>{
    const pct = d.value/total; const angle = pct*360;
    const startRad = cumAngle*Math.PI/180;
    const endRad = (cumAngle+angle)*Math.PI/180;
    cumAngle += angle;
    const x1=cx+r*Math.cos(startRad); const y1=cy+r*Math.sin(startRad);
    const x2=cx+r*Math.cos(endRad); const y2=cy+r*Math.sin(endRad);
    const ix1=cx+ir*Math.cos(endRad); const iy1=cy+ir*Math.sin(endRad);
    const ix2=cx+ir*Math.cos(startRad); const iy2=cy+ir*Math.sin(startRad);
    const large = angle>180?1:0;
    const path = `M${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} L${ix1},${iy1} A${ir},${ir} 0 ${large},0 ${ix2},${iy2} Z`;
    return <path key={i} d={path} fill={d.color} opacity={0.85}>
      <title>{d.label}: {fmtE(d.value)} ({(pct*100).toFixed(1)}%)</title>
    </path>;
  });
  return <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>{paths}</svg>;
}

function App(){
  const [loading, setLoading] = useState(true);
  const [auftraege, setAuftraege] = useState([]);
  const [mitarbeiter, setMitarbeiter] = useState([]);
  const [regeln, setRegeln] = useState([]);
  const [sonder, setSonder] = useState([]);
  const [teamBonus, setTeamBonus] = useState([]);
  const [stufen, setStufen] = useState([]);
  const [sgConfig, setSgConfig] = useState({prozent:3,max_netto:200});
  const [selectedPeriod, setSelectedPeriod] = useState('all');

  useEffect(()=>{
    Promise.all([
      sbG('pay_auftraege','select=*&order=auftrags_datum.desc'),
      sbG('pay_mitarbeiter','aktiv=eq.true&select=id,vorname,nachname,typ'),
      sbG('provisions_regeln','aktiv=eq.true'),
      sbG('pay_sonderprovisionen','aktiv=eq.true'),
      sbG('pay_team_bonus','aktiv=eq.true'),
      sbG('pay_stufenbonus','aktiv=eq.true'),
      sbG('pay_systemgebuehr','aktiv=eq.true&limit=1'),
    ]).then(([a,m,r,s,t,st,sg])=>{
      setAuftraege(a); setMitarbeiter(m); setRegeln(r); setSonder(s); setTeamBonus(t); setStufen(st);
      setSgConfig(sg[0]||{prozent:3,max_netto:200,ust_satz:19});
      setLoading(false);
    });
  },[]);

  const vpById = useMemo(()=>{ const m={}; mitarbeiter.forEach(v=>{m[v.id]=v}); return m; },[mitarbeiter]);
  const regelMap = useMemo(()=>{ const m={}; regeln.forEach(r=>{m[r.mitarbeiter_typ]=r}); return m; },[regeln]);
  const sonderByVP = useMemo(()=>{ const m={}; sonder.forEach(s=>{m[s.mitarbeiter_id]=s}); return m; },[sonder]);
  const teamBonusByVP = useMemo(()=>{ const m={}; teamBonus.forEach(t=>{m[t.mitarbeiter_id]=t}); return m; },[teamBonus]);
  const typMap = {hgb_vertriebler_haupt:'hgb_vertriebler_haupt',hgb84:'hgb_vertriebler_haupt',angestellt_vt:'angestellt_vertriebler',angestellt_vertriebler:'angestellt_vertriebler',hgb_vertriebler_agentur:'hgb_vertriebler_agentur',vertriebler:'vertriebler'};

  // Available months
  const months = useMemo(()=>{
    const ms = new Set();
    auftraege.forEach(a=>{ if(a.auftrags_datum) ms.add(a.auftrags_datum.substring(0,7)); });
    return [...ms].sort();
  },[auftraege]);

  // Filter & calculate
  const analysis = useMemo(()=>{
    if(!auftraege.length||!mitarbeiter.length||!regeln.length) return null;

    // Filter auszahlbare auftraege
    const auszahlbar = auftraege.filter(a=>!a.storniert && a.zahlungsstatus==='anzahlung_eingegangen');
    const filtered = selectedPeriod==='all' ? auszahlbar : auszahlbar.filter(a=>(a.auftrags_datum||'').startsWith(selectedPeriod));
    
    // Stornos
    const stornos = auftraege.filter(a=>a.storniert);
    const filteredStornos = selectedPeriod==='all' ? stornos : stornos.filter(a=>(a.auftrags_datum||'').startsWith(selectedPeriod));

    // Group by VP
    const byVP = {};
    filtered.forEach(a=>{ if(!a.vertriebler_id) return; if(!byVP[a.vertriebler_id]) byVP[a.vertriebler_id]=[]; byVP[a.vertriebler_id].push(a); });

    // Sales per VP per month (for Staffel calc)
    const salesPerVPMonth = {};
    auszahlbar.forEach(a=>{ if(!a.vertriebler_id||!a.auftrags_datum) return; const k=a.vertriebler_id+'_'+a.auftrags_datum.substring(0,7); salesPerVPMonth[k]=(salesPerVPMonth[k]||0)+1; });

    let totalProvision=0,totalEigenlead=0,totalEmpfehlung=0,totalSpeicher=0,totalStufen=0,totalTeam=0,totalSG=0;
    let totalSales=0,totalKwp=0;
    const vtData = [];

    for(const [vpId,orders] of Object.entries(byVP)){
      const vp = vpById[vpId]; if(!vp) continue;
      const ruleTyp = typMap[vp.typ]||vp.typ;
      const regel = regelMap[ruleTyp]; if(!regel) continue;
      const isHGB = (vp.typ||'').includes('hgb');
      const sf = sonderByVP[vpId];

      let vpProv=0,vpEL=0,vpEmpf=0,vpSp=0,vpStufen=0,vpTeam=0,vpSG=0,vpKwp=0;

      // Group by month for Staffel
      const byMonth = {};
      orders.forEach(o=>{ const m=o.auftrags_datum?.substring(0,7)||'?'; if(!byMonth[m]) byMonth[m]=[]; byMonth[m].push(o); });

      for(const [om,mo] of Object.entries(byMonth)){
        const monthKey=vpId+'_'+om;
        const monthTotal=salesPerVPMonth[monthKey]||mo.length;
        const staffel=monthTotal>=regel.staffel_schwelle;
        const baseBetrag=sf?sf.betrag:(staffel?regel.staffel_betrag_sale:regel.basis_betrag_sale);

        for(const o of mo){
          vpProv+=baseBetrag;
          vpKwp+=(o.kwp||0);
          const q=(o.lead_quelle||'').toLowerCase();
          if(q.includes('eigenlead')&&regel.betrag_eigenlead>0&&!(sf&&(sf.beschreibung||'').toLowerCase().includes('kein eigenlead'))) vpEL+=regel.betrag_eigenlead;
          if(q.includes('empfehlung')&&regel.betrag_empfehlung>0) vpEmpf+=regel.betrag_empfehlung;
          if(o.speichererweiterung&&regel.betrag_speicher>0) vpSp+=regel.betrag_speicher;
        }
      }

      // Stufenbonus
      for(const s of stufen){
        if(s.gilt_fuer!==ruleTyp) continue;
        for(const [k,cnt] of Object.entries(salesPerVPMonth)){
          if(!k.startsWith(vpId+'_')) continue;
          const om=k.split('_')[1];
          if(selectedPeriod!=='all'&&om!==selectedPeriod) continue;
          if(cnt>=s.min_anlagen&&s.bonus_betrag>vpStufen) vpStufen=s.bonus_betrag;
        }
      }

      // Team-Bonus
      const tb = teamBonusByVP[vpId];
      if(tb){
        let tbSales=0;
        if(tb.bezugsgruppe==='alle_vt'){
          Object.values(byVP).forEach(vo=>{tbSales+=vo.length});
        } else if(tb.bezugsgruppe==='eigenes_team'&&tb.team_mitglieder){
          const members=Array.isArray(tb.team_mitglieder)?tb.team_mitglieder:[];
          for(const [vid,vo] of Object.entries(byVP)){
            const v=vpById[vid];
            if(v&&members.includes(`${v.vorname} ${v.nachname}`)) tbSales+=vo.length;
          }
        }
        vpTeam=tbSales*tb.betrag_pro_sale;
      }

      // Systemgeb√ºhr
      const vpBrutto=vpProv+vpEL+vpEmpf+vpSp+vpStufen+vpTeam;
      vpSG=isHGB?Math.min(vpBrutto*(sgConfig.prozent/100),sgConfig.max_netto):0;

      totalProvision+=vpProv; totalEigenlead+=vpEL; totalEmpfehlung+=vpEmpf;
      totalSpeicher+=vpSp; totalStufen+=vpStufen; totalTeam+=vpTeam; totalSG+=vpSG;
      totalSales+=orders.length; totalKwp+=vpKwp;

      vtData.push({
        name:`${vp.vorname} ${vp.nachname}`,
        typ:isHGB?'HGB':'Ang.',
        sales:orders.length,
        kwp:vpKwp,
        provision:vpProv,eigenlead:vpEL,empfehlung:vpEmpf,speicher:vpSp,
        stufen:vpStufen,team:vpTeam,sg:vpSG,
        total:vpProv+vpEL+vpEmpf+vpSp+vpStufen+vpTeam-vpSG,
        avgPerSale: orders.length?(vpProv+vpEL+vpEmpf+vpSp+vpStufen+vpTeam-vpSG)/orders.length:0
      });
    }

    vtData.sort((a,b)=>b.total-a.total);
    const totalGesamt=totalProvision+totalEigenlead+totalEmpfehlung+totalSpeicher+totalStufen+totalTeam-totalSG;
    const avgPerSale=totalSales?totalGesamt/totalSales:0;
    const avgPerKwp=totalKwp?totalGesamt/totalKwp:0;
    const stornoRate=filteredStornos.length/(filtered.length+filteredStornos.length)*100||0;

    // Per-month trend
    const monthTrend = {};
    for(const vt of vtData){
      // simplified: use total/sales for this VT across the period
    }
    // Calculate per-month costs
    const trendData = [];
    for(const m of months){
      const mOrders = auszahlbar.filter(a=>(a.auftrags_datum||'').startsWith(m));
      if(!mOrders.length) continue;
      let mTotal=0;
      const mByVP={};
      mOrders.forEach(a=>{ if(!a.vertriebler_id) return; if(!mByVP[a.vertriebler_id]) mByVP[a.vertriebler_id]=[]; mByVP[a.vertriebler_id].push(a); });
      for(const [vid,ords] of Object.entries(mByVP)){
        const vp=vpById[vid]; if(!vp) continue;
        const rt=typMap[vp.typ]||vp.typ; const rl=regelMap[rt]; if(!rl) continue;
        const sf2=sonderByVP[vid];
        const mk=vid+'_'+m; const mt=salesPerVPMonth[mk]||ords.length;
        const st2=mt>=rl.staffel_schwelle;
        const bb=sf2?sf2.betrag:(st2?rl.staffel_betrag_sale:rl.basis_betrag_sale);
        for(const o of ords){
          mTotal+=bb;
          const q=(o.lead_quelle||'').toLowerCase();
          if(q.includes('eigenlead')&&rl.betrag_eigenlead>0&&!(sf2&&(sf2.beschreibung||'').toLowerCase().includes('kein eigenlead'))) mTotal+=rl.betrag_eigenlead;
          if(q.includes('empfehlung')&&rl.betrag_empfehlung>0) mTotal+=rl.betrag_empfehlung;
          if(o.speichererweiterung&&rl.betrag_speicher>0) mTotal+=rl.betrag_speicher;
        }
      }
      trendData.push({month:m,total:mTotal,sales:mOrders.length,avg:mOrders.length?mTotal/mOrders.length:0});
    }

    return {
      totalGesamt,totalProvision,totalEigenlead,totalEmpfehlung,totalSpeicher,totalStufen,totalTeam,totalSG,
      totalSales,totalKwp,avgPerSale,avgPerKwp,stornoRate,
      vtData,trendData,filteredStornos:filteredStornos.length
    };
  },[auftraege,mitarbeiter,regeln,sonder,teamBonus,stufen,sgConfig,selectedPeriod,vpById,regelMap,sonderByVP,teamBonusByVP,months]);

  if(loading) return <div className="loading">‚è≥ Lade Daten...</div>;

  const a = analysis;
  const breakdownData = a ? [
    {key:'provision',label:LABELS.provision,value:a.totalProvision,color:COLORS.provision},
    {key:'eigenlead',label:LABELS.eigenlead,value:a.totalEigenlead,color:COLORS.eigenlead},
    {key:'empfehlung',label:LABELS.empfehlung,value:a.totalEmpfehlung,color:COLORS.empfehlung},
    {key:'speicher',label:LABELS.speicher,value:a.totalSpeicher,color:COLORS.speicher},
    {key:'stufenbonus',label:LABELS.stufenbonus,value:a.totalStufen,color:COLORS.stufenbonus},
    {key:'teambonus',label:LABELS.teambonus,value:a.totalTeam,color:COLORS.teambonus},
    {key:'systemgebuehr',label:LABELS.systemgebuehr+' (abzgl.)',value:a.totalSG,color:COLORS.systemgebuehr},
  ]:[];
  const breakdownTotal = breakdownData.reduce((s,d)=>s+(d.key==='systemgebuehr'?0:d.value),0);

  // Avg cost color
  const costColor = v => v > 2500 ? 'cost-high' : v > 1800 ? 'cost-mid' : 'cost-low';

  return <>
    <div className="header">
      <div className="header-left">
        <div className="logo">‚Ç¨</div>
        <div>
          <h1>Kosten-Dashboard</h1>
          <div className="sub">bee-doo PAY ‚Äì Was kostet ein Auftrag?</div>
        </div>
      </div>
      <a href="index.html" className="back">‚Üê Zur√ºck zur Toolbox</a>
    </div>

    <div className="controls">
      <button className={`period-btn ${selectedPeriod==='all'?'active':''}`} onClick={()=>setSelectedPeriod('all')}>Gesamt</button>
      {months.map(m=><button key={m} className={`period-btn ${selectedPeriod===m?'active':''}`} onClick={()=>setSelectedPeriod(m)}>{monthLabel(m)}</button>)}
    </div>

    {a && <div className="content">
      <div className="info-strip">
        üìä Berechnung auf Basis von {a.totalSales} auszahlbaren Auftr√§gen{selectedPeriod!=='all'?` im ${monthLabel(selectedPeriod)}`:''}. {a.filteredStornos} Stornierungen nicht eingerechnet.
      </div>

      <div className="kpi-row">
        <div className="kpi yellow">
          <div className="kpi-label">Gesamtkosten Vertrieb</div>
          <div className="kpi-value">{fmtE(a.totalGesamt)}</div>
          <div className="kpi-sub">{a.totalSales} Auftr√§ge ¬∑ {a.totalKwp.toFixed(0)} kWp</div>
        </div>
        <div className="kpi blue">
          <div className="kpi-label">√ò Kosten / Auftrag</div>
          <div className="kpi-value">{fmtE(a.avgPerSale)}</div>
          <div className="kpi-sub">inkl. aller Boni & Geb√ºhren</div>
        </div>
        <div className="kpi green">
          <div className="kpi-label">√ò Kosten / kWp</div>
          <div className="kpi-value">{fmtE(a.avgPerKwp)}</div>
          <div className="kpi-sub">{(a.totalKwp/a.totalSales).toFixed(1)} kWp √ò-Anlage</div>
        </div>
        <div className="kpi orange">
          <div className="kpi-label">Storno-Quote</div>
          <div className="kpi-value">{a.stornoRate.toFixed(1)}%</div>
          <div className="kpi-sub">{a.filteredStornos} von {a.totalSales+a.filteredStornos} Auftr√§gen</div>
        </div>
        <div className="kpi red">
          <div className="kpi-label">Systemgeb√ºhr Einnahme</div>
          <div className="kpi-value">{fmtE(a.totalSG)}</div>
          <div className="kpi-sub">3% gedeckelt 200‚Ç¨/VT</div>
        </div>
      </div>

      <div className="grid-2">
        <div className="card">
          <div className="card-title">üìä Kostenaufschl√ºsselung</div>
          <div className="card-body">
            <div className="donut-wrap">
              <DonutChart data={breakdownData.filter(d=>d.key!=='systemgebuehr')} size={160}/>
              <div className="donut-center">
                <div className="big">{fmtE(a.totalGesamt)}</div>
                <div className="small">Netto-Kosten</div>
              </div>
            </div>
            {breakdownData.map(d=>{
              const pct = breakdownTotal?d.value/breakdownTotal*100:0;
              return <div key={d.key} className="breakdown-row">
                <div className="breakdown-left">
                  <div className="breakdown-dot" style={{background:d.color}}/>
                  <span className="breakdown-label">{d.label}</span>
                </div>
                <div className="breakdown-bar-wrap">
                  <div className="breakdown-bar" style={{width:`${Math.min(pct,100)}%`,background:d.color}}/>
                </div>
                <span className="breakdown-val">{fmtE(d.value)}</span>
                <span className="breakdown-pct">{pct.toFixed(1)}%</span>
              </div>;
            })}
          </div>
        </div>

        <div className="card">
          <div className="card-title">üìà Monats-Trend (√ò/Auftrag)</div>
          <div className="card-body">
            {a.trendData.length>0 ? <div className="trend-row">
              {a.trendData.map((t,i)=>{
                const prev=i>0?a.trendData[i-1].avg:null;
                const change=prev?(t.avg-prev)/prev*100:null;
                return <div key={t.month} className="trend-card">
                  <div className="trend-month">{monthLabel(t.month)}</div>
                  <div className="trend-val" style={{color: t.avg>2500?'var(--r)':t.avg>1800?'var(--o)':'var(--g)'}}>{fmtE(t.avg)}</div>
                  <div className="trend-sub">{t.sales} Sales ¬∑ {fmtE(t.total)}</div>
                  {change!==null && <div className={`trend-change ${change>0?'trend-up':'trend-down'}`}>
                    {change>0?'‚ñ≤':'‚ñº'} {Math.abs(change).toFixed(1)}% vs. Vormonat
                  </div>}
                </div>;
              })}
            </div> : <div className="empty">Keine Trenddaten verf√ºgbar</div>}
          </div>
        </div>
      </div>

      <div className="card" style={{marginBottom:24}}>
        <div className="card-title">üë§ Kosten pro Vertriebler</div>
        <div className="card-body" style={{padding:0,overflowX:'auto'}}>
          <table className="vt-table">
            <thead>
              <tr>
                <th>#</th><th>Vertriebler</th><th>Typ</th><th>Sales</th><th>kWp</th>
                <th>Grundprov.</th><th>Eigenlead</th><th>Empfehlung</th><th>Speicher</th>
                <th>Stufen</th><th>Team</th><th>Œ£ Gesamt</th><th>√ò/Sale</th>
              </tr>
            </thead>
            <tbody>
              {a.vtData.map((v,i)=><tr key={v.name}>
                <td style={{color:'var(--ts)'}}>{i+1}</td>
                <td className="vt-name">{v.name}</td>
                <td><span className={`badge ${v.typ==='HGB'?'badge-hgb':'badge-ang'}`}>{v.typ}</span></td>
                <td>{v.sales}</td>
                <td>{v.kwp.toFixed(1)}</td>
                <td>{fmtE(v.provision)}</td>
                <td style={{color:v.eigenlead?'var(--y)':'var(--ts)'}}>{v.eigenlead?fmtE(v.eigenlead):'‚Äì'}</td>
                <td style={{color:v.empfehlung?'var(--g)':'var(--ts)'}}>{v.empfehlung?fmtE(v.empfehlung):'‚Äì'}</td>
                <td style={{color:v.speicher?'var(--o)':'var(--ts)'}}>{v.speicher?fmtE(v.speicher):'‚Äì'}</td>
                <td style={{color:v.stufen?'#f778ba':'var(--ts)'}}>{v.stufen?fmtE(v.stufen):'‚Äì'}</td>
                <td style={{color:v.team?'#bc8cff':'var(--ts)'}}>{v.team?fmtE(v.team):'‚Äì'}</td>
                <td style={{fontWeight:700}}>{fmtE(v.total)}</td>
                <td className={costColor(v.avgPerSale)} style={{fontWeight:600}}>{fmtE(v.avgPerSale)}</td>
              </tr>)}
              {a.vtData.length>0 && <tr style={{background:'var(--s2)',fontWeight:700}}>
                <td></td><td>GESAMT</td><td></td>
                <td>{a.totalSales}</td>
                <td>{a.totalKwp.toFixed(0)}</td>
                <td>{fmtE(a.totalProvision)}</td>
                <td style={{color:'var(--y)'}}>{fmtE(a.totalEigenlead)}</td>
                <td style={{color:'var(--g)'}}>{fmtE(a.totalEmpfehlung)}</td>
                <td style={{color:'var(--o)'}}>{fmtE(a.totalSpeicher)}</td>
                <td style={{color:'#f778ba'}}>{fmtE(a.totalStufen)}</td>
                <td style={{color:'#bc8cff'}}>{fmtE(a.totalTeam)}</td>
                <td>{fmtE(a.totalGesamt)}</td>
                <td className={costColor(a.avgPerSale)}>{fmtE(a.avgPerSale)}</td>
              </tr>}
            </tbody>
          </table>
        </div>
      </div>
    </div>}
  </>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
