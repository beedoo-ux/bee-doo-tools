<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo | Empfehlungsprogramm</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ù</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;0,9..40,900;1,9..40,400&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { overflow-x: hidden; width: 100%; }
body { background: #080C14; color: #fff; font-family: 'DM Sans', sans-serif; -webkit-font-smoothing: antialiased; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(245,197,0,0.2); border-radius: 3px; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
@keyframes countUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.ani { animation: fadeIn 0.4s ease both; }
.ani-1 { animation-delay: 0.05s; }
.ani-2 { animation-delay: 0.1s; }
.ani-3 { animation-delay: 0.15s; }
.ani-4 { animation-delay: 0.2s; }
.ani-5 { animation-delay: 0.25s; }

@media (max-width: 768px) {
  .resp-grid { grid-template-columns: 1fr 1fr !important; }
  .resp-stack { grid-template-columns: 1fr !important; }
}
@media (max-width: 480px) {
  .resp-grid { grid-template-columns: 1fr !important; }
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = "https://hqzpemfaljxcysyqssng.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik";
const BRAND = { yellow: "#F5C500", dark: "#080C14", card: "#0F1520", cardHover: "#141C2A", border: "rgba(255,255,255,0.06)", text: "#fff", textSec: "#8b95a5", textDim: "rgba(255,255,255,0.35)", green: "#22c55e", red: "#ef4444", blue: "#3b82f6", orange: "#f97316", purple: "#a855f7" };
const font = "'DM Sans', sans-serif";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Data loaded from Supabase

// ‚îÄ‚îÄ‚îÄ Pr√§mien-Staffelung ‚îÄ‚îÄ‚îÄ
const PRAEMIEN_STUFEN = [700, 800, 900, 1000];
const getPraemie = (n) => n <= 0 ? 0 : n === 1 ? 700 : n === 2 ? 800 : n === 3 ? 900 : 1000;
const getTotalPraemie = (sales) => { let sum = 0; for (let i = 1; i <= sales; i++) sum += getPraemie(i); return sum; };
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Data loaded from Supabase (no more mock data)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPER COMPONENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Card = ({ children, style, className, onClick }) => (
  <div onClick={onClick} className={className} style={{ background: BRAND.card, border: `1px solid ${BRAND.border}`, borderRadius: 14, padding: "18px 20px", ...style }}>
    {children}
  </div>
);

const Badge = ({ text, color, small }) => (
  <span style={{ display: "inline-flex", alignItems: "center", padding: small ? "1px 6px" : "3px 10px", borderRadius: 6, background: color + "15", color: color, fontSize: small ? 9 : 11, fontWeight: 700, letterSpacing: 0.3 }}>{text}</span>
);

const StatusBadge = ({ status }) => {
  const map = { neu: [BRAND.blue, "NEU"], kontaktiert: [BRAND.orange, "KONTAKTIERT"], termin: [BRAND.purple, "TERMIN"], sale: [BRAND.green, "SALE ‚úì"], storno: [BRAND.red, "STORNO"], aktiv: [BRAND.green, "AKTIV"], pausiert: [BRAND.orange, "PAUSIERT"], gesperrt: [BRAND.red, "GESPERRT"], offen: [BRAND.orange, "OFFEN"], angewiesen: [BRAND.blue, "ANGEWIESEN"], bezahlt: [BRAND.green, "BEZAHLT"] };
  const [c, t] = map[status] || [BRAND.textSec, status];
  return <Badge text={t} color={c} />;
};

const KPI = ({ icon, label, value, sub, color, delay }) => (
  <Card className={`ani ani-${delay || 1}`} style={{ textAlign: "center" }}>
    <div style={{ fontSize: 28, marginBottom: 6 }}>{icon}</div>
    <div style={{ fontSize: 28, fontWeight: 900, color: color || BRAND.yellow, animation: "countUp 0.6s ease both", animationDelay: `${(delay||1)*0.1}s` }}>{value}</div>
    <div style={{ fontSize: 11, color: BRAND.textSec, marginTop: 2 }}>{label}</div>
    {sub && <div style={{ fontSize: 10, color: BRAND.textDim, marginTop: 4 }}>{sub}</div>}
  </Card>
);

const TabBtn = ({ active, label, icon, onClick, count }) => (
  <button onClick={onClick} style={{ display: "flex", alignItems: "center", gap: 6, padding: "10px 16px", borderRadius: 10, border: active ? "none" : `1px solid ${BRAND.border}`, background: active ? `${BRAND.yellow}15` : "transparent", color: active ? BRAND.yellow : BRAND.textSec, fontSize: 13, fontWeight: active ? 700 : 500, fontFamily: font, cursor: "pointer", transition: "all 0.2s", whiteSpace: "nowrap" }}>
    <span style={{ fontSize: 16 }}>{icon}</span>
    {label}
    {count != null && <span style={{ background: active ? BRAND.yellow : BRAND.textDim, color: active ? BRAND.dark : "#fff", borderRadius: 10, padding: "0 6px", fontSize: 10, fontWeight: 800, minWidth: 18, textAlign: "center" }}>{count}</span>}
  </button>
);

const SearchInput = ({ value, onChange, placeholder }) => (
  <div style={{ position: "relative", flex: 1, maxWidth: 320 }}>
    <span style={{ position: "absolute", left: 12, top: "50%", transform: "translateY(-50%)", fontSize: 14, opacity: 0.4 }}>üîç</span>
    <input value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder || "Suchen..."} style={{ width: "100%", padding: "10px 12px 10px 36px", borderRadius: 10, border: `1px solid ${BRAND.border}`, background: "rgba(255,255,255,0.04)", color: "#fff", fontSize: 13, fontFamily: font, outline: "none" }} />
  </div>
);

const formatDate = (d) => d ? new Date(d).toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" }) : "‚Äî";
const formatDateTime = (d) => d ? new Date(d).toLocaleString("de-DE", { day: "2-digit", month: "2-digit", year: "2-digit", hour: "2-digit", minute: "2-digit" }) : "‚Äî";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ √úBERSICHT ‚îÄ‚îÄ‚îÄ
function TabUebersicht({ werber, leads, payouts, settings }) {
  const totalWerber = werber.length;
  const totalLeads = leads.length;
  const totalSales = leads.filter(l => l.status === "sale").length;
  const convRate = totalLeads > 0 ? Math.round((totalSales / totalLeads) * 100) : 0;
  const offenePayout = payouts.filter(p => p.status === "offen").reduce((s, p) => s + p.betrag, 0);
  const ausgezahlt = payouts.filter(p => p.status === "bezahlt").reduce((s, p) => s + p.betrag, 0);

  const statusCounts = { neu: 0, kontaktiert: 0, termin: 0, sale: 0, storno: 0 };
  leads.forEach(l => { if (statusCounts[l.status] != null) statusCounts[l.status]++; });

  const pipelineSteps = [
    { key: "neu", label: "Neu", color: BRAND.blue, icon: "üì•" },
    { key: "kontaktiert", label: "Kontaktiert", color: BRAND.orange, icon: "üìû" },
    { key: "termin", label: "Termin", color: BRAND.purple, icon: "üìÖ" },
    { key: "sale", label: "Sale", color: BRAND.green, icon: "‚úÖ" },
    { key: "storno", label: "Storno", color: BRAND.red, icon: "‚ùå" },
  ];

  // Top Werber
  const topWerber = [...werber].sort((a, b) => b.successful - a.successful).slice(0, 5);

  // Recent activity
  const recentLeads = [...leads].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      {/* KPI Row */}
      <div className="resp-grid" style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12 }}>
        <KPI icon="ü§ù" label="Werber registriert" value={totalWerber} delay={1} />
        <KPI icon="üì•" label="Leads generiert" value={totalLeads} sub={`${totalSales} Sales ¬∑ ${convRate}% Conversion`} color={BRAND.blue} delay={2} />
        <KPI icon="üí∞" label="Offene Auszahlungen" value={offenePayout.toLocaleString("de-DE") + "‚Ç¨"} sub={payouts.filter(p => p.status === "offen").length + " Vorg√§nge"} color={BRAND.orange} delay={3} />
        <KPI icon="‚úÖ" label="Bereits ausgezahlt" value={ausgezahlt.toLocaleString("de-DE") + "‚Ç¨"} sub="Gesamt" color={BRAND.green} delay={4} />
      </div>

      {/* Pipeline + Top Werber */}
      <div className="resp-stack" style={{ display: "grid", gridTemplateColumns: "2fr 1fr", gap: 12 }}>
        <Card className="ani ani-3">
          <div style={{ fontSize: 10, color: BRAND.textDim, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1.5, marginBottom: 14 }}>üìä Lead Pipeline</div>
          <div style={{ display: "flex", gap: 4 }}>
            {pipelineSteps.map(s => {
              const pct = totalLeads > 0 ? Math.max(5, Math.round((statusCounts[s.key] / totalLeads) * 100)) : 20;
              return (
                <div key={s.key} style={{ flex: pct, textAlign: "center" }}>
                  <div style={{ height: 48, background: s.color + "20", borderRadius: 8, display: "flex", alignItems: "center", justifyContent: "center", border: `1px solid ${s.color}30`, marginBottom: 6, transition: "all 0.3s" }}>
                    <span style={{ fontSize: 20, fontWeight: 900, color: s.color }}>{statusCounts[s.key]}</span>
                  </div>
                  <div style={{ fontSize: 9, color: BRAND.textSec, fontWeight: 600 }}>{s.icon} {s.label}</div>
                </div>
              );
            })}
          </div>
          {/* Conversion funnel bar */}
          <div style={{ marginTop: 14, display: "flex", gap: 2, height: 8, borderRadius: 4, overflow: "hidden" }}>
            {pipelineSteps.map(s => (
              <div key={s.key} style={{ flex: Math.max(1, statusCounts[s.key]), background: s.color, transition: "flex 0.5s" }} />
            ))}
          </div>
        </Card>

        <Card className="ani ani-4">
          <div style={{ fontSize: 10, color: BRAND.textDim, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1.5, marginBottom: 14 }}>üèÜ Top Werber</div>
          {topWerber.map((w, i) => (
            <div key={w.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 0", borderBottom: i < topWerber.length - 1 ? `1px solid ${BRAND.border}` : "none" }}>
              <span style={{ width: 22, fontSize: 12, fontWeight: 800, color: i < 3 ? BRAND.yellow : BRAND.textDim, textAlign: "center" }}>{i + 1}</span>
              <div style={{ width: 32, height: 32, borderRadius: "50%", background: `${BRAND.yellow}15`, border: `2px solid ${i === 0 ? BRAND.yellow : BRAND.border}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, fontWeight: 800, color: BRAND.yellow }}>{w.vorname[0]}{w.nachname[0]}</div>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ fontSize: 13, fontWeight: 600, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{w.vorname} {w.nachname}</div>
                <div style={{ fontSize: 10, color: BRAND.textSec }}>{w.referrals} Empfehlungen ¬∑ {w.successful} Sales</div>
              </div>
            </div>
          ))}
        </Card>
      </div>

      {/* Recent Activity */}
      <Card className="ani ani-5">
        <div style={{ fontSize: 10, color: BRAND.textDim, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1.5, marginBottom: 14 }}>üïê Neueste Leads</div>
        <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
          {recentLeads.map(l => {
            const wName = werber.find(w => w.code === l.werber_code);
            return (
              <div key={l.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 12px", borderRadius: 10, background: "rgba(255,255,255,0.02)", border: `1px solid ${BRAND.border}` }}>
                <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                  <div style={{ fontSize: 18 }}>{l.interesse === "PV" ? "‚òÄÔ∏è" : l.interesse === "WP" ? "üå°" : "‚ö°"}</div>
                  <div>
                    <div style={{ fontSize: 13, fontWeight: 600 }}>{l.vorname} {l.nachname}, {l.ort}</div>
                    <div style={{ fontSize: 10, color: BRAND.textSec }}>von {wName ? `${wName.vorname} ${wName.nachname}` : l.werber_code} ¬∑ {formatDateTime(l.created_at)}</div>
                  </div>
                </div>
                <StatusBadge status={l.status} />
              </div>
            );
          })}
        </div>
      </Card>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ WERBER ‚îÄ‚îÄ‚îÄ
function TabWerber({ werber, leads }) {
  const [search, setSearch] = useState("");
  const [selectedWerber, setSelectedWerber] = useState(null);

  const filtered = werber.filter(w => {
    const s = search.toLowerCase();
    return !s || `${w.vorname} ${w.nachname} ${w.code} ${w.ort}`.toLowerCase().includes(s);
  });

  const WerberDetail = ({ w }) => {
    const wLeads = leads.filter(l => l.werber_code === w.code);
    const link = `https://bee-doo-tools.vercel.app/empfehlung-landing.html?ref=${w.code}`;
    return (
      <div style={{ position: "fixed", inset: 0, zIndex: 9000, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "center", justifyContent: "center", padding: 16 }} onClick={() => setSelectedWerber(null)}>
        <div onClick={e => e.stopPropagation()} style={{ width: "100%", maxWidth: 540, maxHeight: "90vh", background: "#111927", borderRadius: 16, border: `1px solid ${BRAND.border}`, overflow: "auto" }}>
          <div style={{ padding: "20px 24px", background: `${BRAND.yellow}08`, borderBottom: `1px solid ${BRAND.yellow}15` }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                <div style={{ width: 48, height: 48, borderRadius: "50%", background: `${BRAND.yellow}15`, border: `2px solid ${BRAND.yellow}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, fontWeight: 900, color: BRAND.yellow }}>{w.vorname[0]}{w.nachname[0]}</div>
                <div>
                  <div style={{ fontSize: 18, fontWeight: 800 }}>{w.vorname} {w.nachname}</div>
                  <div style={{ fontSize: 12, color: BRAND.textSec }}>Code: <span style={{ color: BRAND.yellow, fontWeight: 700 }}>{w.code}</span> ¬∑ {w.ort}</div>
                </div>
              </div>
              <button onClick={() => setSelectedWerber(null)} style={{ background: "none", border: "none", color: BRAND.textSec, fontSize: 22, cursor: "pointer" }}>√ó</button>
            </div>
          </div>
          <div style={{ padding: "16px 24px" }}>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, marginBottom: 16 }}>
              <div style={{ padding: "10px", borderRadius: 10, background: `${BRAND.blue}08`, border: `1px solid ${BRAND.blue}15`, textAlign: "center" }}>
                <div style={{ fontSize: 22, fontWeight: 900, color: BRAND.blue }}>{w.referrals}</div>
                <div style={{ fontSize: 9, color: BRAND.textSec }}>Empfehlungen</div>
              </div>
              <div style={{ padding: "10px", borderRadius: 10, background: `${BRAND.green}08`, border: `1px solid ${BRAND.green}15`, textAlign: "center" }}>
                <div style={{ fontSize: 22, fontWeight: 900, color: BRAND.green }}>{w.successful}</div>
                <div style={{ fontSize: 9, color: BRAND.textSec }}>Sales</div>
              </div>
              <div style={{ padding: "10px", borderRadius: 10, background: `${BRAND.yellow}08`, border: `1px solid ${BRAND.yellow}15`, textAlign: "center" }}>
                <div style={{ fontSize: 22, fontWeight: 900, color: BRAND.yellow }}>{getTotalPraemie(w.successful).toLocaleString("de-DE")}‚Ç¨</div>
                <div style={{ fontSize: 9, color: BRAND.textSec }}>Verdient</div>
              </div>
            </div>
            <div style={{ padding: "10px 14px", borderRadius: 10, background: "rgba(255,255,255,0.03)", border: `1px solid ${BRAND.border}`, marginBottom: 16 }}>
              <div style={{ fontSize: 9, color: BRAND.textDim, fontWeight: 700, textTransform: "uppercase", marginBottom: 4 }}>Empfehlungslink</div>
              <div style={{ fontSize: 12, color: BRAND.yellow, wordBreak: "break-all", fontWeight: 600 }}>{link}</div>
            </div>
            <div style={{ fontSize: 10, color: BRAND.textDim, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1, marginBottom: 8 }}>Leads ({wLeads.length})</div>
            {wLeads.map(l => (
              <div key={l.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "8px 10px", marginBottom: 4, borderRadius: 8, background: "rgba(255,255,255,0.02)" }}>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600 }}>{l.vorname} {l.nachname}</div>
                  <div style={{ fontSize: 10, color: BRAND.textSec }}>{l.interesse} ¬∑ {l.ort}</div>
                </div>
                <StatusBadge status={l.status} />
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 16, flexWrap: "wrap" }}>
        <SearchInput value={search} onChange={setSearch} placeholder="Werber suchen..." />
        <div style={{ fontSize: 12, color: BRAND.textSec }}>{filtered.length} Werber</div>
      </div>
      <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
        {filtered.map(w => (
          <Card key={w.id} onClick={() => setSelectedWerber(w)} style={{ cursor: "pointer", transition: "all 0.2s", display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 10 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <div style={{ width: 40, height: 40, borderRadius: "50%", background: `${BRAND.yellow}12`, border: `2px solid ${w.status === "aktiv" ? BRAND.green : BRAND.orange}30`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, fontWeight: 800, color: BRAND.yellow }}>{w.vorname[0]}{w.nachname[0]}</div>
              <div>
                <div style={{ fontSize: 14, fontWeight: 700 }}>{w.vorname} {w.nachname} <span style={{ color: BRAND.yellow, fontSize: 11 }}>#{w.code}</span></div>
                <div style={{ fontSize: 11, color: BRAND.textSec }}>{w.ort} ¬∑ Berater: {w.berater_name} ¬∑ {formatDate(w.created_at)}</div>
              </div>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <div style={{ textAlign: "center" }}><div style={{ fontSize: 16, fontWeight: 800, color: BRAND.blue }}>{w.referrals}</div><div style={{ fontSize: 8, color: BRAND.textDim }}>Empfehlungen</div></div>
              <div style={{ textAlign: "center" }}><div style={{ fontSize: 16, fontWeight: 800, color: BRAND.green }}>{w.successful}</div><div style={{ fontSize: 8, color: BRAND.textDim }}>Sales</div></div>
              {w.pending_payout > 0 && <Badge text={`${w.pending_payout}‚Ç¨ offen`} color={BRAND.orange} />}
              <StatusBadge status={w.status} />
            </div>
          </Card>
        ))}
      </div>
      {selectedWerber && <WerberDetail w={selectedWerber} />}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ LEADS ‚îÄ‚îÄ‚îÄ
function TabLeads({ leads, werber }) {
  const [search, setSearch] = useState("");
  const [filterStatus, setFilterStatus] = useState("alle");

  const filtered = leads.filter(l => {
    const s = search.toLowerCase();
    const matchSearch = !s || `${l.vorname} ${l.nachname} ${l.ort} ${l.werber_code}`.toLowerCase().includes(s);
    const matchStatus = filterStatus === "alle" || l.status === filterStatus;
    return matchSearch && matchStatus;
  }).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  const statusFilters = [
    { key: "alle", label: "Alle", count: leads.length },
    { key: "neu", label: "Neu", count: leads.filter(l => l.status === "neu").length },
    { key: "kontaktiert", label: "Kontaktiert", count: leads.filter(l => l.status === "kontaktiert").length },
    { key: "termin", label: "Termin", count: leads.filter(l => l.status === "termin").length },
    { key: "sale", label: "Sale", count: leads.filter(l => l.status === "sale").length },
    { key: "storno", label: "Storno", count: leads.filter(l => l.status === "storno").length },
  ];

  return (
    <div>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 12, flexWrap: "wrap" }}>
        <SearchInput value={search} onChange={setSearch} placeholder="Lead suchen..." />
      </div>
      <div style={{ display: "flex", gap: 6, marginBottom: 16, flexWrap: "wrap" }}>
        {statusFilters.map(f => (
          <button key={f.key} onClick={() => setFilterStatus(f.key)} style={{ padding: "6px 12px", borderRadius: 8, border: filterStatus === f.key ? "none" : `1px solid ${BRAND.border}`, background: filterStatus === f.key ? `${BRAND.yellow}15` : "transparent", color: filterStatus === f.key ? BRAND.yellow : BRAND.textSec, fontSize: 12, fontWeight: 600, fontFamily: font, cursor: "pointer" }}>
            {f.label} ({f.count})
          </button>
        ))}
      </div>
      <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
        {filtered.map(l => {
          const wName = werber.find(w => w.code === l.werber_code);
          return (
            <Card key={l.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "14px 16px", flexWrap: "wrap", gap: 8 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 10, flex: 1, minWidth: 200 }}>
                <div style={{ fontSize: 22 }}>{l.interesse === "PV" ? "‚òÄÔ∏è" : l.interesse === "WP" ? "üå°" : "‚ö°"}</div>
                <div>
                  <div style={{ fontSize: 14, fontWeight: 700 }}>{l.vorname} {l.nachname}</div>
                  <div style={{ fontSize: 11, color: BRAND.textSec }}>{l.plz} {l.ort} ¬∑ {l.interesse} ¬∑ {l.telefon}</div>
                  <div style={{ fontSize: 10, color: BRAND.textDim, marginTop: 2 }}>Werber: <span style={{ color: BRAND.yellow }}>{wName ? `${wName.vorname} ${wName.nachname}` : l.werber_code}</span> ¬∑ {formatDateTime(l.created_at)}</div>
                </div>
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                {l.berater_zugewiesen && <div style={{ fontSize: 10, color: BRAND.textSec }}>‚Üí {l.berater_zugewiesen}</div>}
                <StatusBadge status={l.status} />
              </div>
            </Card>
          );
        })}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ AUSZAHLUNGEN ‚îÄ‚îÄ‚îÄ
function TabPayouts({ payouts }) {
  const [filterStatus, setFilterStatus] = useState("alle");

  const filtered = payouts.filter(p => filterStatus === "alle" || p.status === filterStatus).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  const totalOffen = payouts.filter(p => p.status === "offen").reduce((s, p) => s + p.betrag, 0);
  const totalAngewiesen = payouts.filter(p => p.status === "angewiesen").reduce((s, p) => s + p.betrag, 0);
  const totalBezahlt = payouts.filter(p => p.status === "bezahlt").reduce((s, p) => s + p.betrag, 0);

  return (
    <div>
      <div className="resp-grid" style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 12, marginBottom: 16 }}>
        <Card style={{ textAlign: "center", borderColor: `${BRAND.orange}20` }}>
          <div style={{ fontSize: 22, fontWeight: 900, color: BRAND.orange }}>{totalOffen.toLocaleString("de-DE")}‚Ç¨</div>
          <div style={{ fontSize: 10, color: BRAND.textSec }}>Offen ({payouts.filter(p => p.status === "offen").length})</div>
        </Card>
        <Card style={{ textAlign: "center", borderColor: `${BRAND.blue}20` }}>
          <div style={{ fontSize: 22, fontWeight: 900, color: BRAND.blue }}>{totalAngewiesen.toLocaleString("de-DE")}‚Ç¨</div>
          <div style={{ fontSize: 10, color: BRAND.textSec }}>Angewiesen ({payouts.filter(p => p.status === "angewiesen").length})</div>
        </Card>
        <Card style={{ textAlign: "center", borderColor: `${BRAND.green}20` }}>
          <div style={{ fontSize: 22, fontWeight: 900, color: BRAND.green }}>{totalBezahlt.toLocaleString("de-DE")}‚Ç¨</div>
          <div style={{ fontSize: 10, color: BRAND.textSec }}>Bezahlt ({payouts.filter(p => p.status === "bezahlt").length})</div>
        </Card>
      </div>

      <div style={{ display: "flex", gap: 6, marginBottom: 16, flexWrap: "wrap" }}>
        {["alle", "offen", "angewiesen", "bezahlt"].map(s => (
          <button key={s} onClick={() => setFilterStatus(s)} style={{ padding: "6px 12px", borderRadius: 8, border: filterStatus === s ? "none" : `1px solid ${BRAND.border}`, background: filterStatus === s ? `${BRAND.yellow}15` : "transparent", color: filterStatus === s ? BRAND.yellow : BRAND.textSec, fontSize: 12, fontWeight: 600, fontFamily: font, cursor: "pointer", textTransform: "capitalize" }}>
            {s === "alle" ? "Alle" : s.charAt(0).toUpperCase() + s.slice(1)}
          </button>
        ))}
      </div>

      <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
        {filtered.map(p => (
          <Card key={p.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "14px 16px", flexWrap: "wrap", gap: 8 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ fontSize: 22 }}>{p.typ === "ueberweisung" ? "üè¶" : "üéÅ"}</div>
              <div>
                <div style={{ fontSize: 13, fontWeight: 700 }}>{p.werber_name}</div>
                <div style={{ fontSize: 11, color: BRAND.textSec }}>f√ºr {p.lead_name} ¬∑ {p.typ === "ueberweisung" ? "√úberweisung" : "Gutschein"}</div>
                <div style={{ fontSize: 10, color: BRAND.textDim }}>{formatDate(p.created_at)}{p.bezahlt_am ? ` ¬∑ bezahlt ${formatDate(p.bezahlt_am)}` : ""}</div>
              </div>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ fontSize: 18, fontWeight: 900, color: p.status === "bezahlt" ? BRAND.green : BRAND.yellow }}>{p.betrag}‚Ç¨</div>
              <StatusBadge status={p.status} />
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ EINSTELLUNGEN ‚îÄ‚îÄ‚îÄ
function TabSettings({ settings, setSettings }) {
  const update = (key, val) => setSettings(s => ({ ...s, [key]: val }));

  const SettingRow = ({ label, desc, children }) => (
    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "14px 0", borderBottom: `1px solid ${BRAND.border}`, flexWrap: "wrap", gap: 8 }}>
      <div style={{ flex: 1, minWidth: 200 }}>
        <div style={{ fontSize: 14, fontWeight: 600 }}>{label}</div>
        {desc && <div style={{ fontSize: 11, color: BRAND.textSec, marginTop: 2 }}>{desc}</div>}
      </div>
      <div>{children}</div>
    </div>
  );

  const Toggle = ({ value, onChange }) => (
    <div onClick={() => onChange(!value)} style={{ width: 48, height: 26, borderRadius: 13, background: value ? BRAND.green : "rgba(255,255,255,0.1)", cursor: "pointer", position: "relative", transition: "all 0.2s" }}>
      <div style={{ width: 20, height: 20, borderRadius: "50%", background: "#fff", position: "absolute", top: 3, left: value ? 25 : 3, transition: "left 0.2s", boxShadow: "0 2px 4px rgba(0,0,0,0.3)" }} />
    </div>
  );

  const NumInput = ({ value, onChange, suffix }) => (
    <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
      <input type="number" value={value} onChange={e => onChange(Number(e.target.value))} style={{ width: 80, padding: "8px 10px", borderRadius: 8, border: `1px solid ${BRAND.border}`, background: "rgba(255,255,255,0.04)", color: BRAND.yellow, fontSize: 16, fontWeight: 700, fontFamily: font, textAlign: "right", outline: "none" }} />
      {suffix && <span style={{ fontSize: 13, color: BRAND.textSec }}>{suffix}</span>}
    </div>
  );

  return (
    <Card>
      <div style={{ fontSize: 10, color: BRAND.textDim, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1.5, marginBottom: 16 }}>‚öôÔ∏è Globale Einstellungen</div>

      <SettingRow label="Programm aktiv" desc="Empfehlungsprogramm ein-/ausschalten">
        <Toggle value={settings.programm_aktiv} onChange={v => update("programm_aktiv", v)} />
      </SettingRow>

      <SettingRow label="Pr√§mien-Staffelung" desc="Gestaffelte Pr√§mie je nach Anzahl erfolgreicher Empfehlungen">
        <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
          {PRAEMIEN_STUFEN.map((b, i) => (
            <div key={i} style={{ padding: "6px 10px", borderRadius: 8, background: `${BRAND.yellow}10`, border: `1px solid ${BRAND.yellow}25`, textAlign: "center" }}>
              <div style={{ fontSize: 14, fontWeight: 900, color: BRAND.yellow }}>{b}‚Ç¨</div>
              <div style={{ fontSize: 8, color: BRAND.textDim }}>{i < 3 ? `${i+1}. Sale` : "4.+"}</div>
            </div>
          ))}
        </div>
      </SettingRow>

      <SettingRow label="Auszahlungsart" desc="Wie soll die Pr√§mie ausgezahlt werden?">
        <div style={{ display: "flex", gap: 6 }}>
          {[["ueberweisung", "üè¶ √úberweisung"], ["gutschein", "üéÅ Gutschein"], ["both", "üè¶+üéÅ Beides"]].map(([key, label]) => (
            <button key={key} onClick={() => update("praemie_typ", key)} style={{ padding: "6px 12px", borderRadius: 8, border: settings.praemie_typ === key ? "none" : `1px solid ${BRAND.border}`, background: settings.praemie_typ === key ? `${BRAND.yellow}20` : "transparent", color: settings.praemie_typ === key ? BRAND.yellow : BRAND.textSec, fontSize: 11, fontWeight: 600, fontFamily: font, cursor: "pointer" }}>{label}</button>
          ))}
        </div>
      </SettingRow>

      <SettingRow label="Berater-Bonus aktiv" desc="Berater bekommt Extra-Provision f√ºr Empfehlungs-Leads">
        <Toggle value={settings.berater_bonus_aktiv} onChange={v => update("berater_bonus_aktiv", v)} />
      </SettingRow>

      <SettingRow label="Berater-Bonus Standard" desc="Standard-Bonus pro Empfehlungs-Sale (individuell √ºberschreibbar)">
        <NumInput value={settings.berater_bonus} onChange={v => update("berater_bonus", v)} suffix="‚Ç¨" />
      </SettingRow>

      <SettingRow label="Landing Page Text" desc="Text auf der √∂ffentlichen Empfehlungsseite">
        <textarea value={settings.landing_text} onChange={e => update("landing_text", e.target.value)} rows={3} style={{ width: 320, maxWidth: "100%", padding: "10px 12px", borderRadius: 10, border: `1px solid ${BRAND.border}`, background: "rgba(255,255,255,0.04)", color: "#fff", fontSize: 12, fontFamily: font, resize: "vertical", outline: "none" }} />
      </SettingRow>

      <div style={{ marginTop: 16, padding: "12px 16px", borderRadius: 10, background: `${BRAND.blue}08`, border: `1px solid ${BRAND.blue}15` }}>
        <div style={{ fontSize: 11, fontWeight: 700, color: BRAND.blue }}>üí° Landing Page URL</div>
        <div style={{ fontSize: 12, color: BRAND.yellow, marginTop: 4, wordBreak: "break-all" }}>https://bee-doo-tools.vercel.app/empfehlung-landing.html?ref=CODE</div>
      </div>
    </Card>
  );
}

// ‚îÄ‚îÄ‚îÄ BERATER ‚îÄ‚îÄ‚îÄ
function TabBerater({ berater, setBerater, settings, werber, leads }) {
  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
      <div style={{ fontSize: 12, color: BRAND.textSec }}>Individuell einstellbar pro Berater. Standard-Bonus: {settings.berater_bonus}‚Ç¨</div>
      {berater.map((b, idx) => (
        <Card key={b.berater_name} className="ani" style={{ animationDelay: `${idx * 0.05}s` }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 14, flexWrap: "wrap", gap: 8 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ width: 40, height: 40, borderRadius: "50%", background: `${BRAND.yellow}12`, border: `2px solid ${BRAND.yellow}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, fontWeight: 900, color: BRAND.yellow }}>{b.berater_name.split(" ").map(n => n[0]).join("")}</div>
              <div>
                <div style={{ fontSize: 16, fontWeight: 800 }}>{b.berater_name}</div>
                <div style={{ fontSize: 11, color: BRAND.textSec }}>{(werber||[]).filter(w => w.berater_name === b.berater_name).length} Werber ¬∑ {(leads||[]).filter(l => l.berater_zugewiesen === b.berater_name).length} Leads ¬∑ {(leads||[]).filter(l => l.berater_zugewiesen === b.berater_name && l.status === "sale").length} Sales</div>
              </div>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <Badge text={`${getTotalPraemie((leads||[]).filter(l => l.berater_zugewiesen === b.berater_name && l.status === "sale").length).toLocaleString("de-DE")}‚Ç¨ Pr√§mien`} color={BRAND.green} />
            </div>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12 }}>
            <div>
              <div style={{ fontSize: 10, color: BRAND.textDim, marginBottom: 4 }}>Bonus pro Sale</div>
              <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                <input type="number" value={b.bonus_pro_lead} onChange={e => {
                  const newB = [...berater];
                  newB[idx] = { ...b, bonus_pro_lead: Number(e.target.value) };
                  setBerater(newB);
                }} style={{ width: 60, padding: "6px 8px", borderRadius: 6, border: `1px solid ${BRAND.border}`, background: "rgba(255,255,255,0.04)", color: BRAND.yellow, fontSize: 14, fontWeight: 700, fontFamily: font, textAlign: "right", outline: "none" }} />
                <span style={{ fontSize: 12, color: BRAND.textSec }}>‚Ç¨</span>
              </div>
            </div>
            <div>
              <div style={{ fontSize: 10, color: BRAND.textDim, marginBottom: 4 }}>Custom Kunden-Pr√§mie</div>
              <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                <input type="number" value={b.custom_praemie || ""} placeholder={String(settings.praemie_kunde)} onChange={e => {
                  const newB = [...berater];
                  newB[idx] = { ...b, custom_praemie: e.target.value ? Number(e.target.value) : null };
                  setBerater(newB);
                }} style={{ width: 60, padding: "6px 8px", borderRadius: 6, border: `1px solid ${BRAND.border}`, background: "rgba(255,255,255,0.04)", color: b.custom_praemie ? BRAND.orange : BRAND.textDim, fontSize: 14, fontWeight: 700, fontFamily: font, textAlign: "right", outline: "none" }} />
                <span style={{ fontSize: 12, color: BRAND.textSec }}>‚Ç¨</span>
              </div>
            </div>
            <div>
              <div style={{ fontSize: 10, color: BRAND.textDim, marginBottom: 4 }}>Bonus aktiv</div>
              <div onClick={() => {
                const newB = [...berater];
                newB[idx] = { ...b, bonus_aktiv: !b.bonus_aktiv };
                setBerater(newB);
              }} style={{ width: 48, height: 26, borderRadius: 13, background: b.bonus_aktiv ? BRAND.green : "rgba(255,255,255,0.1)", cursor: "pointer", position: "relative", transition: "all 0.2s" }}>
                <div style={{ width: 20, height: 20, borderRadius: "50%", background: "#fff", position: "absolute", top: 3, left: b.bonus_aktiv ? 25 : 3, transition: "left 0.2s", boxShadow: "0 2px 4px rgba(0,0,0,0.3)" }} />
              </div>
            </div>
          </div>
        </Card>
      ))}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ SQL SETUP TAB ‚îÄ‚îÄ‚îÄ
function TabSetup() {
  const sql = `-- ‚ïê‚ïê‚ïê Supabase SQL: Empfehlungsprogramm Tabellen ‚ïê‚ïê‚ïê

CREATE TABLE IF NOT EXISTS referral_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  praemie_kunde NUMERIC DEFAULT 200,
  praemie_typ TEXT DEFAULT 'both',
  berater_bonus NUMERIC DEFAULT 50,
  berater_bonus_aktiv BOOLEAN DEFAULT true,
  programm_aktiv BOOLEAN DEFAULT true,
  landing_text TEXT DEFAULT 'Empfehlen Sie bee-doo weiter!',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS referral_customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT UNIQUE NOT NULL,
  vorname TEXT NOT NULL,
  nachname TEXT NOT NULL,
  email TEXT,
  telefon TEXT,
  plz TEXT,
  ort TEXT,
  berater_name TEXT,
  berater_id TEXT,
  status TEXT DEFAULT 'aktiv',
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS referral_leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  werber_code TEXT REFERENCES referral_customers(code),
  vorname TEXT NOT NULL,
  nachname TEXT NOT NULL,
  email TEXT,
  telefon TEXT NOT NULL,
  plz TEXT,
  ort TEXT,
  strasse TEXT,
  interesse TEXT,
  status TEXT DEFAULT 'neu',
  berater_zugewiesen TEXT,
  notizen TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS referral_payouts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  werber_id UUID REFERENCES referral_customers(id),
  lead_id UUID REFERENCES referral_leads(id),
  werber_name TEXT,
  lead_name TEXT,
  betrag NUMERIC NOT NULL,
  typ TEXT NOT NULL,
  status TEXT DEFAULT 'offen',
  iban TEXT,
  notizen TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  bezahlt_am TIMESTAMPTZ
);

CREATE TABLE IF NOT EXISTS referral_berater_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  berater_name TEXT UNIQUE NOT NULL,
  bonus_pro_lead NUMERIC DEFAULT 50,
  bonus_aktiv BOOLEAN DEFAULT true,
  custom_praemie NUMERIC,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- RLS Policies
ALTER TABLE referral_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE referral_customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE referral_leads ENABLE ROW LEVEL SECURITY;
ALTER TABLE referral_payouts ENABLE ROW LEVEL SECURITY;
ALTER TABLE referral_berater_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow all" ON referral_settings FOR ALL USING (true);
CREATE POLICY "Allow all" ON referral_customers FOR ALL USING (true);
CREATE POLICY "Allow all" ON referral_leads FOR ALL USING (true);
CREATE POLICY "Allow all" ON referral_payouts FOR ALL USING (true);
CREATE POLICY "Allow all" ON referral_berater_settings FOR ALL USING (true);

-- Seed settings
INSERT INTO referral_settings (praemie_kunde, praemie_typ, berater_bonus, berater_bonus_aktiv, programm_aktiv, landing_text)
VALUES (200, 'both', 50, true, true, 'Empfehlen Sie bee-doo weiter und erhalten Sie eine Pr√§mie f√ºr jeden erfolgreichen Abschluss!')
ON CONFLICT DO NOTHING;`;

  return (
    <Card>
      <div style={{ fontSize: 10, color: BRAND.textDim, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1.5, marginBottom: 10 }}>üóÑÔ∏è Datenbank Setup</div>
      <div style={{ fontSize: 12, color: BRAND.textSec, marginBottom: 14 }}>Dieses SQL im Supabase SQL Editor ausf√ºhren um die Tabellen zu erstellen. Danach funktioniert die App mit echten Daten.</div>
      <div style={{ padding: "12px 16px", borderRadius: 10, background: "#0A0E16", border: `1px solid ${BRAND.border}`, maxHeight: 400, overflow: "auto" }}>
        <pre style={{ fontSize: 11, color: BRAND.green, fontFamily: "monospace", whiteSpace: "pre-wrap", lineHeight: 1.5 }}>{sql}</pre>
      </div>
      <button onClick={() => { navigator.clipboard.writeText(sql); }} style={{ marginTop: 12, padding: "10px 20px", borderRadius: 10, border: "none", background: `${BRAND.yellow}20`, color: BRAND.yellow, fontSize: 13, fontWeight: 700, fontFamily: font, cursor: "pointer" }}>üìã SQL kopieren</button>
    </Card>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB = {
  headers: { apikey: SUPABASE_KEY, "Content-Type": "application/json", Authorization: "Bearer " + SUPABASE_KEY },
  async get(table, query) { const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query || "select=*"}`, { headers: SB.headers }); return r.ok ? r.json() : []; },
  async post(table, data) { const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, { method: "POST", headers: { ...SB.headers, Prefer: "return=representation" }, body: JSON.stringify(data) }); return r.ok ? r.json() : null; },
  async patch(table, match, data) { const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${match}`, { method: "PATCH", headers: { ...SB.headers, Prefer: "return=representation" }, body: JSON.stringify(data) }); return r.ok ? r.json() : null; },
  async del(table, match) { return fetch(`${SUPABASE_URL}/rest/v1/${table}?${match}`, { method: "DELETE", headers: SB.headers }); },
};

function App() {
  const [tab, setTab] = useState("uebersicht");
  const [settings, setSettings] = useState({ praemie_kunde: 200, praemie_typ: "both", berater_bonus: 50, berater_bonus_aktiv: true, programm_aktiv: true, landing_text: "" });
  const [berater, setBerater] = useState([]);
  const [werber, setWerber] = useState([]);
  const [leads, setLeads] = useState([]);
  const [payouts, setPayouts] = useState([]);
  const [loading, setLoading] = useState(true);

  // Load all data
  const loadData = async () => {
    try {
      const [sArr, w, l, p, b] = await Promise.all([
        SB.get("referral_settings", "select=*&limit=1"),
        SB.get("referral_customers", "select=*&order=created_at.desc"),
        SB.get("referral_leads", "select=*&order=created_at.desc"),
        SB.get("referral_payouts", "select=*&order=created_at.desc"),
        SB.get("referral_berater_settings", "select=*&order=berater_name.asc"),
      ]);
      if (sArr && sArr[0]) setSettings(sArr[0]);
      // Enrich werber with lead stats
      const enrichedW = (w || []).map(ww => {
        const wLeads = (l || []).filter(ll => ll.werber_code === ww.code);
        const successful = wLeads.filter(ll => ll.status === "sale").length;
        const pending = (p || []).filter(pp => pp.werber_name === `${ww.vorname} ${ww.nachname}` && pp.status === "offen").reduce((s, pp) => s + Number(pp.betrag), 0);
        return { ...ww, referrals: wLeads.length, successful, pending_payout: pending };
      });
      setWerber(enrichedW);
      setLeads(l || []);
      setPayouts(p || []);
      setBerater(b || []);
    } catch (e) { console.error("Load error:", e); }
    setLoading(false);
  };

  useEffect(() => { loadData(); }, []);

  // Save settings to Supabase
  const saveSettings = async (newSettings) => {
    setSettings(newSettings);
    if (newSettings.id) {
      await SB.patch("referral_settings", `id=eq.${newSettings.id}`, {
        praemie_kunde: newSettings.praemie_kunde, praemie_typ: newSettings.praemie_typ,
        berater_bonus: newSettings.berater_bonus, berater_bonus_aktiv: newSettings.berater_bonus_aktiv,
        programm_aktiv: newSettings.programm_aktiv, landing_text: newSettings.landing_text, updated_at: new Date().toISOString()
      });
    }
  };

  // Save berater settings
  const saveBerater = async (newBerater) => {
    setBerater(newBerater);
    for (const b of newBerater) {
      if (b.id) {
        await SB.patch("referral_berater_settings", `id=eq.${b.id}`, { bonus_pro_lead: b.bonus_pro_lead, bonus_aktiv: b.bonus_aktiv, custom_praemie: b.custom_praemie });
      }
    }
  };

  const tabs = [
    { key: "uebersicht", label: "√úbersicht", icon: "üìä" },
    { key: "werber", label: "Werber", icon: "ü§ù", count: werber.length },
    { key: "leads", label: "Leads", icon: "üì•", count: leads.length },
    { key: "payouts", label: "Auszahlungen", icon: "üí∞", count: payouts.filter(p => p.status === "offen").length },
    { key: "berater", label: "Berater", icon: "üë§" },
    { key: "settings", label: "Einstellungen", icon: "‚öôÔ∏è" },
  ];

  if (loading) return (
    <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ textAlign: "center" }}>
        <div style={{ fontSize: 32, marginBottom: 12 }}>üêù</div>
        <div style={{ fontSize: 14, color: BRAND.textSec }}>Daten werden geladen...</div>
      </div>
    </div>
  );

  // tabs defined above in the App function

  return (
    <div style={{ minHeight: "100vh", maxWidth: 1200, margin: "0 auto", padding: "0 16px 40px" }}>
      {/* Header */}
      <div style={{ padding: "24px 0 20px", display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 12 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <a href="index.html" style={{ fontSize: 12, color: BRAND.textDim, textDecoration: "none" }}>‚Üê Launcher</a>
          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
            <span style={{ fontSize: 28, fontWeight: 900 }}>bee</span>
            <span style={{ fontSize: 28, fontWeight: 900, color: BRAND.yellow }}>¬∑</span>
            <span style={{ fontSize: 28, fontWeight: 900 }}>doo</span>
            <span style={{ fontSize: 12, fontWeight: 700, color: BRAND.textDim, marginLeft: 8, borderLeft: `2px solid ${BRAND.border}`, paddingLeft: 8 }}>EMPFEHLUNGEN</span>
          </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <div style={{ width: 10, height: 10, borderRadius: "50%", background: settings.programm_aktiv ? BRAND.green : BRAND.red }} />
          <span style={{ fontSize: 12, color: settings.programm_aktiv ? BRAND.green : BRAND.red, fontWeight: 700 }}>
            {settings.programm_aktiv ? "Programm aktiv" : "Programm inaktiv"}
          </span>
        </div>
      </div>

      {/* Tab Navigation */}
      <div style={{ display: "flex", gap: 6, marginBottom: 20, overflowX: "auto", paddingBottom: 4 }}>
        {tabs.map(t => (
          <TabBtn key={t.key} active={tab === t.key} label={t.label} icon={t.icon} count={t.count} onClick={() => setTab(t.key)} />
        ))}
      </div>

      {/* Tab Content */}
      <div key={tab} className="ani">
        {tab === "uebersicht" && <TabUebersicht werber={werber} leads={leads} payouts={payouts} settings={settings} />}
        {tab === "werber" && <TabWerber werber={werber} leads={leads} />}
        {tab === "leads" && <TabLeads leads={leads} werber={werber} />}
        {tab === "payouts" && <TabPayouts payouts={payouts} onReload={loadData} />}
        {tab === "berater" && <TabBerater berater={berater} setBerater={saveBerater} settings={settings} werber={werber} leads={leads} />}
        {tab === "settings" && <TabSettings settings={settings} setSettings={saveSettings} />}
      </div>

      <div style={{ textAlign: "center", padding: "24px 0", fontSize: 10, color: "rgba(255,255,255,0.1)" }}>v1.0 ¬∑ bee-doo Empfehlungsprogramm ¬∑ üêù</div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
