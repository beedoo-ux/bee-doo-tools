<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo Â· Kundenboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--bg2:#1a1d27;--bg3:#22252f;--bg4:#2a2d3a;--bg5:#32364a;
  --text:#f0f0f0;--text2:#b0b8c8;--text3:#6b7280;
  --gold:#F5C500;--gold2:#FFD740;--gold-dim:rgba(245,197,0,.10);--gold-dim2:rgba(245,197,0,.05);
  --green:#22c55e;--green-dim:rgba(34,197,94,.10);
  --red:#ef4444;--red-dim:rgba(239,68,68,.10);
  --blue:#3b82f6;--blue-dim:rgba(59,130,246,.10);
  --orange:#f59e0b;--orange-dim:rgba(245,158,11,.10);
  --purple:#a855f7;--purple-dim:rgba(168,85,247,.10);
  --cyan:#06b6d4;--cyan-dim:rgba(6,182,212,.10);
  --r:10px;--r2:14px;
}
html{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px}
body{min-height:100vh}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
input,select,button{font-family:inherit}

.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:360px;border-right:1px solid var(--bg4);display:flex;flex-direction:column;background:var(--bg);flex-shrink:0}
.main{flex:1;overflow-y:auto;background:var(--bg)}

.sb-header{padding:16px;border-bottom:1px solid var(--bg3)}
.sb-logo{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.sb-logo b{font-size:20px;font-weight:800;color:var(--gold)}
.sb-logo span{font-size:12px;color:var(--text3)}
.search-box{position:relative}
.search-box input{width:100%;padding:10px 12px 10px 36px;background:var(--bg2);border:1.5px solid var(--bg4);border-radius:var(--r);color:var(--text);font-size:13px;outline:none;transition:.2s}
.search-box input:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-dim)}
.search-box input::placeholder{color:var(--text3)}
.search-box svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3);width:16px;height:16px}
.search-hint{font-size:10px;color:var(--text3);margin-top:6px}

.filters{padding:10px 16px;border-bottom:1px solid var(--bg3);display:flex;flex-direction:column;gap:8px}
.filter-row{display:flex;gap:6px;flex-wrap:wrap}
.filter-select{padding:6px 10px;background:var(--bg2);border:1px solid var(--bg4);border-radius:7px;color:var(--text2);font-size:11px;outline:none;cursor:pointer;flex:1;min-width:0;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b7280'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:24px}
.filter-select:focus{border-color:var(--gold)}
.filter-chip{padding:4px 10px;background:var(--bg2);border:1px solid var(--bg4);border-radius:20px;color:var(--text2);font-size:11px;cursor:pointer;transition:.15s;white-space:nowrap;user-select:none}
.filter-chip:hover{border-color:var(--text3)}
.filter-chip.active{background:var(--gold-dim);border-color:var(--gold);color:var(--gold)}
.filter-chip .count{background:var(--bg4);padding:1px 5px;border-radius:8px;font-size:9px;margin-left:4px}
.filter-chip.active .count{background:rgba(245,197,0,.2)}

.results-header{padding:10px 16px;font-size:11px;color:var(--text3);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--bg3)}
.results-list{flex:1;overflow-y:auto}
.result-item{padding:12px 16px;border-bottom:1px solid var(--bg3);cursor:pointer;transition:.1s}
.result-item:hover{background:var(--gold-dim2)}
.result-item.active{background:var(--gold-dim);border-left:3px solid var(--gold)}
.ri-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.ri-name{font-weight:700;font-size:14px;line-height:1.2}
.ri-badge{padding:2px 8px;border-radius:6px;font-size:9px;font-weight:700;white-space:nowrap;flex-shrink:0;letter-spacing:.3px}
.ri-meta{font-size:11px;color:var(--text3);margin-top:3px;display:flex;flex-wrap:wrap;gap:4px}
.ri-meta span{display:inline-flex;align-items:center;gap:3px}
.ri-tags{display:flex;gap:4px;margin-top:5px;flex-wrap:wrap}
.ri-tag{font-size:9px;padding:2px 6px;border-radius:4px;background:var(--bg3);color:var(--text2)}

.main-inner{padding:20px;max-width:1200px;margin:0 auto}
.empty-main{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text3);text-align:center;padding:40px}
.empty-main h2{font-size:18px;color:var(--text2);margin-bottom:6px}
.empty-main p{font-size:13px}

.dash-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px}
.dash-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--r);padding:14px 16px;text-align:center;transition:.2s}
.dash-card:hover{border-color:var(--bg5)}
.dash-val{font-size:24px;font-weight:800;line-height:1}
.dash-label{font-size:10px;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:.5px}

.k-header{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--r2);padding:20px;margin-bottom:14px}
.k-top{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
.k-name{font-size:26px;font-weight:800;line-height:1.1}
.k-an{color:var(--gold);font-size:12px;font-weight:600;margin-top:3px;display:flex;align-items:center;gap:8px}
.k-meta{display:flex;flex-wrap:wrap;gap:14px;margin-top:10px}
.k-meta-item{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text2)}
.k-meta-item svg{width:13px;height:13px;color:var(--text3);flex-shrink:0}
.k-status-pill{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px}

.key-nums{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.key-num{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--r);padding:16px;text-align:center}
.kn-val{font-size:22px;font-weight:800;line-height:1}
.kn-label{font-size:10px;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:.4px}

.cards-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
.card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--r2);padding:18px;overflow:hidden}
.card-t{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:12px;display:flex;align-items:center;gap:7px}
.card-t svg{width:13px;height:13px}

.dg{display:grid;grid-template-columns:1fr 1fr;gap:1px}
.dg-item{padding:7px 0;border-bottom:1px solid var(--bg3)}
.dg-item:last-child,.dg-item:nth-last-child(2){border:none}
.dg-l{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.4px}
.dg-v{font-size:13px;font-weight:500;margin-top:1px;word-break:break-word}

.timeline{position:relative;padding-left:24px;max-height:350px;overflow-y:auto}
.timeline::before{content:'';position:absolute;left:7px;top:4px;bottom:4px;width:2px;background:var(--bg4)}
.tl-item{position:relative;padding-bottom:12px}
.tl-item:last-child{padding-bottom:0}
.tl-dot{position:absolute;left:-24px;top:2px;width:14px;height:14px;border-radius:50%;border:2px solid var(--bg4);background:var(--bg2)}
.tl-dot.done{border-color:var(--green);background:var(--green-dim)}
.tl-dot.active{border-color:var(--gold);background:var(--gold-dim)}
.tl-dot.storno{border-color:var(--red);background:var(--red-dim)}
.tl-label{font-size:12px;font-weight:600;line-height:1.3}
.tl-date{font-size:10px;color:var(--text3)}

.ptbl{width:100%;border-collapse:collapse;font-size:12px}
.ptbl th{text-align:left;padding:6px 10px;font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);border-bottom:2px solid var(--bg4);font-weight:600}
.ptbl td{padding:6px 10px;border-bottom:1px solid var(--bg3)}
.ptbl tr:hover td{background:var(--gold-dim2)}
.ptbl .amt{font-weight:700;font-variant-numeric:tabular-nums;text-align:right}
.ptbl .pos{color:var(--green)}
.ptbl .neg{color:var(--red)}
.ptbl .total td{border-top:2px solid var(--gold);font-weight:700}

.map-box{height:180px;border-radius:var(--r);overflow:hidden;border:1px solid var(--bg3)}
.leaflet-container{background:var(--bg3)!important}

.vp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.vp-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--r);padding:14px;cursor:pointer;transition:.15s}
.vp-card:hover{border-color:var(--gold);transform:translateY(-1px)}
.vp-name{font-weight:700;font-size:14px}
.vp-id{font-size:10px;color:var(--text3)}
.vp-stats{display:flex;gap:12px;margin-top:8px}
.vp-stat{text-align:center}
.vp-stat-val{font-size:18px;font-weight:800}
.vp-stat-label{font-size:9px;color:var(--text3);text-transform:uppercase}

.loading{display:flex;align-items:center;justify-content:center;padding:30px;color:var(--text3);font-size:13px}
.spinner{width:16px;height:16px;border:2px solid var(--bg4);border-top-color:var(--gold);border-radius:50%;animation:spin .5s linear infinite;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:1024px){.sidebar{width:300px}.dash-grid{grid-template-columns:repeat(3,1fr)}.key-nums{grid-template-columns:repeat(2,1fr)}.cards-2{grid-template-columns:1fr}}
@media(max-width:768px){.app{flex-direction:column}.sidebar{width:100%;height:auto;max-height:50vh;border-right:none;border-bottom:1px solid var(--bg4)}.main{height:50vh}.dash-grid{grid-template-columns:repeat(2,1fr)}.vp-grid{grid-template-columns:1fr}}
@media(max-width:480px){.main-inner{padding:12px}.k-name{font-size:20px}.key-nums{grid-template-columns:1fr 1fr}.dg{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;
const SB="https://hqzpemfaljxcysyqssng.supabase.co/rest/v1";
const ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik";
const HD={"apikey":ANON,"Authorization":"Bearer "+ANON};
async function sb(t,p=""){const r=await fetch(SB+"/"+t+"?"+p,{headers:HD});if(!r.ok)throw new Error(r.status);return r.json()}
async function sbC(t,p=""){const r=await fetch(SB+"/"+t+"?"+p+"&limit=0",{headers:{...HD,"Prefer":"count=exact"}});return parseInt((r.headers.get("content-range")||"").split("/")[1])||0}
const eur=n=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(n||0);
const num=n=>new Intl.NumberFormat("de-DE").format(n||0);
const df=d=>{if(!d)return"â€“";return new Date(d).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})};
const kwpF=v=>{if(!v)return"â€“";return v>100?(v/100).toFixed(2):v.toFixed(2)};
function stC(s){if(!s)return{bg:"var(--bg4)",c:"var(--text3)"};const l=s.toLowerCase();if(l.includes("storniert")||l.includes("abgelehnt")||l.includes("nicht machbar"))return{bg:"var(--red-dim)",c:"var(--red)"};if(l.includes("komplett")||l.includes("abnahme")||l.includes("abgeschlossen")||l.includes("efs")||l.includes("golfstrom"))return{bg:"var(--green-dim)",c:"var(--green)"};if(l.includes("hold")||l.includes("warten")||l.includes("zurÃ¼ck"))return{bg:"var(--orange-dim)",c:"var(--orange)"};if(l.includes("montage")||l.includes("planung")||l.includes("freigabe")||l.includes("baustelle")||l.includes("lieferschein"))return{bg:"var(--blue-dim)",c:"var(--blue)"};if(l.includes("quali")||l.includes("vertrag")||l.includes("finanzierung")||l.includes("barzahler"))return{bg:"var(--purple-dim)",c:"var(--purple)"};if(l.includes("auftrag")||l.includes("angebot"))return{bg:"var(--cyan-dim)",c:"var(--cyan)"};return{bg:"var(--gold-dim)",c:"var(--gold)"};}
const I=({d,s=14})=>React.createElement("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},React.createElement("path",{d}));
function parseWF(wf){if(!wf)return[];const e=[];const rx=/(\d{2}\.\d{2}\.\d{4})\s*-\s*(\d{2}:\d{2})-?\s*(.*?)(?=\d{2}\.\d{2}\.\d{4}|$)/g;let m;while((m=rx.exec(wf))!==null)e.push({date:m[1],time:m[2],text:m[3].trim().replace(/^-\s*/,"")});return e;}

function KMap({lat,lng,name}){
  const ref=useRef(null),inst=useRef(null);
  useEffect(()=>{
    if(!lat||!lng||!ref.current)return;
    if(inst.current){inst.current.remove();inst.current=null;}
    const m=L.map(ref.current,{zoomControl:false,attributionControl:false}).setView([lat,lng],15);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(m);
    L.circleMarker([lat,lng],{radius:8,color:"#F5C500",fillColor:"#F5C500",fillOpacity:.8,weight:2}).addTo(m);
    inst.current=m;
    return()=>{if(inst.current){inst.current.remove();inst.current=null;}};
  },[lat,lng]);
  if(!lat||!lng)return React.createElement("div",{style:{height:180,background:"var(--bg3)",borderRadius:"var(--r)",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text3)",fontSize:11}},"Keine GPS-Daten");
  return React.createElement("div",{ref,className:"map-box"});
}

function App(){
  const[query,setQuery]=useState("");const[auftraege,setAuftraege]=useState([]);const[selected,setSelected]=useState(null);
  const[kunde,setKunde]=useState(null);const[efsData,setEfsData]=useState(null);const[payouts,setPayouts]=useState([]);
  const[loading,setLoading]=useState(false);const[detailLoading,setDetailLoading]=useState(false);
  const[stats,setStats]=useState(null);const[vpList,setVpList]=useState([]);const[statusList,setStatusList]=useState([]);
  const[filterVP,setFilterVP]=useState("");const[filterStatus,setFilterStatus]=useState("");const[filterTyp,setFilterTyp]=useState("");
  const[mainView,setMainView]=useState("dashboard");const[vpCards,setVpCards]=useState([]);
  const[vbName,setVbName]=useState("");const searchTimer=useRef(null);const vbCache=useRef(new Map());

  useEffect(()=>{(async()=>{try{
    const[kC,aC,eC,pC]=await Promise.all([sbC("customers"),sbC("auftraege"),sbC("efs_projekte"),sbC("pay_auszahlungen_historie")]);
    const vps=await sb("mitarbeiter","typ=in.(vertriebler,hgb_84)&aktiv=eq.true&select=id,vorname,nachname,kuerzel&order=nachname");
    setVpList(vps);
    const aufAll=await sb("auftraege","select=beedoo_fortschritt&beedoo_fortschritt=not.is.null&limit=2000");
    const sc={};aufAll.forEach(a=>{const s=a.beedoo_fortschritt;if(s)sc[s]=(sc[s]||0)+1;});
    const sorted=Object.entries(sc).sort((a,b)=>b[1]-a[1]);setStatusList(sorted);
    setStats({kunden:kC,auftraege:aC,efs:eC,payouts:pC,stornos:sorted.find(s=>s[0].toLowerCase().includes("storniert"))?.[1]||0,hold:sorted.filter(s=>s[0].toLowerCase().includes("hold")).reduce((a,b)=>a+b[1],0)});
  }catch(e){console.error(e)}})();},[]);

  useEffect(()=>{clearTimeout(searchTimer.current);searchTimer.current=setTimeout(()=>doSearch(),250);},[query,filterVP,filterStatus,filterTyp]);

  async function doSearch(){
    const q=query.trim();
    if(q.length<2&&!filterVP&&!filterStatus&&!filterTyp){setAuftraege([]);return;}
    setLoading(true);
    try{
      let p=[];
      if(q.length>=2){if(/^\d{3,5}$/.test(q))p.push("auftrag_nr=ilike.*"+q+"*");else if(/^\d{5}$/.test(q))p.push("kunde_plz=eq."+q);else p.push("kunde_name=ilike.*"+encodeURIComponent(q)+"*");}
      if(filterVP)p.push("vertriebler_id=eq."+filterVP);
      if(filterStatus)p.push("beedoo_fortschritt=eq."+encodeURIComponent(filterStatus));
      if(filterTyp)p.push("produkt_typ=eq."+filterTyp);
      p.push("order=auftrags_datum.desc","limit=200");
      setAuftraege(await sb("auftraege",p.join("&")));
    }catch(e){console.error(e);setAuftraege([]);}
    setLoading(false);
  }

  async function loadDetail(row){
    setSelected(row);setMainView("detail");setDetailLoading(true);
    try{
      const cust=await sb("customers","auftrag_nr=eq."+encodeURIComponent(row.auftrag_nr)+"&limit=1");setKunde(cust[0]||null);
      if(row.efs_projekt_id){const e=await sb("efs_projekte","id=eq."+row.efs_projekt_id+"&limit=1");setEfsData(e[0]||null);}
      else{const nn=row.kunde_name?.split(" ").pop()||"";if(nn.length>2){const e=await sb("efs_projekte","kunde_nachname=ilike.*"+encodeURIComponent(nn)+"*&limit=1");setEfsData(e[0]||null);}else setEfsData(null);}
      const nn=row.kunde_name?.split(" ").pop()||"";
      if(nn.length>2){const pa=await sb("pay_auszahlungen_historie","kunde=ilike.*"+encodeURIComponent(nn)+"*&order=periode.desc");setPayouts(pa.filter(x=>{const kn=row.kunde_name?.toLowerCase()||"";return kn.split(" ").some(w=>w.length>2&&(x.kunde||"").toLowerCase().includes(w));}));}else setPayouts([]);
      if(row.vertriebler_id){if(vbCache.current.has(row.vertriebler_id))setVbName(vbCache.current.get(row.vertriebler_id));
      else{const d=await sb("mitarbeiter","id=eq."+row.vertriebler_id+"&limit=1");const n=d[0]?d[0].vorname+" "+d[0].nachname:"â€“";vbCache.current.set(row.vertriebler_id,n);setVbName(n);}}else setVbName("");
    }catch(e){console.error(e);}setDetailLoading(false);
  }

  async function loadVPBoard(){setMainView("vp-board");try{
    const pa=await sb("pay_auszahlungen_historie","select=vertriebler,vp_nummer,netto,periode&netto=neq.0");
    const byVP={};pa.forEach(p=>{if(!byVP[p.vertriebler])byVP[p.vertriebler]={name:p.vertriebler,vp:p.vp_nummer,total:0,deals:0,months:{}};byVP[p.vertriebler].total+=p.netto;byVP[p.vertriebler].deals++;if(!byVP[p.vertriebler].months[p.periode])byVP[p.vertriebler].months[p.periode]=0;byVP[p.vertriebler].months[p.periode]+=p.netto;});
    setVpCards(Object.values(byVP).sort((a,b)=>b.total-a.total));
  }catch(e){console.error(e);}}

  const quickChips=useMemo(()=>{const imp=["Storniert","Hold","Erwarte Baustellenbeginn","Quali Call","DC in Planung","Barzahler"];return statusList.filter(([s])=>imp.some(k=>s.toLowerCase().includes(k.toLowerCase()))).slice(0,6);},[statusList]);

  return React.createElement("div",{className:"app"},
    React.createElement("div",{className:"sidebar"},
      React.createElement("div",{className:"sb-header"},
        React.createElement("div",{className:"sb-logo"},React.createElement("b",null,"bee-doo"),React.createElement("span",null,"Kundenboard")),
        React.createElement("div",{className:"search-box"},
          React.createElement("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2"},React.createElement("circle",{cx:"11",cy:"11",r:"8"}),React.createElement("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})),
          React.createElement("input",{value:query,onChange:e=>setQuery(e.target.value),placeholder:"Name, AN-Nr, PLZ suchen..."})
        ),
        React.createElement("div",{className:"search-hint"},auftraege.length>0?auftraege.length+" Treffer":"Mind. 2 Zeichen oder Filter wÃ¤hlen")
      ),
      React.createElement("div",{className:"filters"},
        React.createElement("div",{className:"filter-row"},
          React.createElement("select",{className:"filter-select",value:filterVP,onChange:e=>setFilterVP(e.target.value)},
            React.createElement("option",{value:""},"Alle Berater"),
            vpList.map(v=>React.createElement("option",{key:v.id,value:v.id},v.vorname+" "+v.nachname))
          ),
          React.createElement("select",{className:"filter-select",value:filterTyp,onChange:e=>setFilterTyp(e.target.value)},
            React.createElement("option",{value:""},"Alle Typen"),
            React.createElement("option",{value:"pv_finanz"},"Finanzierung"),
            React.createElement("option",{value:"pv_bar"},"Barzahler")
          )
        ),
        React.createElement("div",{className:"filter-row"},
          React.createElement("select",{className:"filter-select",value:filterStatus,onChange:e=>setFilterStatus(e.target.value)},
            React.createElement("option",{value:""},"Alle Status"),
            statusList.map(([s,c])=>React.createElement("option",{key:s,value:s},s+" ("+c+")"))
          )
        ),
        React.createElement("div",{className:"filter-row",style:{flexWrap:"wrap"}},
          quickChips.map(([s,c])=>React.createElement("div",{key:s,className:"filter-chip"+(filterStatus===s?" active":""),onClick:()=>setFilterStatus(filterStatus===s?"":s)},
            s.length>20?s.substring(0,18)+"â€¦":s,React.createElement("span",{className:"count"},c)
          ))
        ),
        React.createElement("div",{className:"filter-row"},
          React.createElement("div",{className:"filter-chip"+(mainView==="dashboard"?" active":""),onClick:()=>setMainView("dashboard"),style:{flex:1,textAlign:"center"}},"ðŸ“Š Dashboard"),
          React.createElement("div",{className:"filter-chip"+(mainView==="vp-board"?" active":""),onClick:loadVPBoard,style:{flex:1,textAlign:"center"}},"ðŸ‘¥ VP-Board")
        )
      ),
      React.createElement("div",{className:"results-header"},React.createElement("span",null,"Suchergebnisse"),React.createElement("span",null,auftraege.length)),
      React.createElement("div",{className:"results-list"},
        loading?React.createElement("div",{className:"loading"},React.createElement("div",{className:"spinner"}),"Suche..."):
        auftraege.length===0?React.createElement("div",{style:{padding:20,textAlign:"center",color:"var(--text3)",fontSize:12}},"Keine Treffer"):
        auftraege.map(a=>{const sc=stC(a.beedoo_fortschritt);const isA=selected?.id===a.id;return React.createElement("div",{key:a.id,className:"result-item"+(isA?" active":""),onClick:()=>loadDetail(a)},
          React.createElement("div",{className:"ri-top"},
            React.createElement("div",{className:"ri-name"},a.kunde_name||"â€“"),
            React.createElement("div",{className:"ri-badge",style:{background:sc.bg,color:sc.c}},(a.beedoo_fortschritt||"offen").substring(0,22))
          ),
          React.createElement("div",{className:"ri-meta"},
            React.createElement("span",{style:{color:"var(--gold)",fontWeight:600}},"AN "+a.auftrag_nr),
            React.createElement("span",null,kwpF(a.anlagen_kwp)+" kWp"),
            React.createElement("span",null,df(a.auftrags_datum))
          ),
          React.createElement("div",{className:"ri-tags"},
            a.lead_quelle&&React.createElement("div",{className:"ri-tag"},a.lead_quelle),
            a.produkt_typ&&React.createElement("div",{className:"ri-tag"},a.produkt_typ==="pv_finanz"?"Finanzierung":"Barzahler"),
            a.kunde_plz&&React.createElement("div",{className:"ri-tag"},a.kunde_plz)
          )
        );})
      )
    ),
    React.createElement("div",{className:"main"},
      mainView==="dashboard"&&React.createElement(DashboardView,{stats,statusList,onStatusClick:s=>{setFilterStatus(s)}}),
      mainView==="detail"&&(detailLoading?React.createElement("div",{className:"loading",style:{height:"100%"}},React.createElement("div",{className:"spinner"}),"Lade..."):
        selected?React.createElement(DetailView,{a:selected,k:kunde,e:efsData,pays:payouts,vbName}):React.createElement("div",{className:"empty-main"},React.createElement("h2",null,"Kunde auswÃ¤hlen"),React.createElement("p",null,"Links einen Auftrag anklicken"))),
      mainView==="vp-board"&&React.createElement(VPBoardView,{cards:vpCards,onSelect:vp=>{setQuery(vp.name.split(" ").pop());setMainView("dashboard")}})
    )
  );
}

function DashboardView({stats,statusList,onStatusClick}){
  if(!stats)return React.createElement("div",{className:"loading",style:{height:"100%"}},React.createElement("div",{className:"spinner"}),"Lade Dashboard...");
  const cats={"ðŸŸ¢ Abgeschlossen":[],"ðŸ”µ In Montage":[],"ðŸŸ¡ In Bearbeitung":[],"ðŸŸ  On Hold / ZurÃ¼ck":[],"ðŸ”´ Storniert":[]};
  statusList.forEach(([s,c])=>{const l=s.toLowerCase();if(l.includes("storniert")||l.includes("nicht machbar")||l.includes("abgelehnt"))cats["ðŸ”´ Storniert"].push([s,c]);else if(l.includes("abnahme")||l.includes("komplett")||l.includes("efs")||l.includes("golfstrom"))cats["ðŸŸ¢ Abgeschlossen"].push([s,c]);else if(l.includes("montage")||l.includes("baustelle")||l.includes("lieferschein")||l.includes("planung")||l.includes("freigabe"))cats["ðŸ”µ In Montage"].push([s,c]);else if(l.includes("hold")||l.includes("zurÃ¼ck")||l.includes("nacharbeit"))cats["ðŸŸ  On Hold / ZurÃ¼ck"].push([s,c]);else cats["ðŸŸ¡ In Bearbeitung"].push([s,c]);});
  return React.createElement("div",{className:"main-inner"},
    React.createElement("div",{className:"dash-grid"},
      React.createElement("div",{className:"dash-card"},React.createElement("div",{className:"dash-val",style:{color:"var(--gold)"}},num(stats.auftraege)),React.createElement("div",{className:"dash-label"},"AuftrÃ¤ge")),
      React.createElement("div",{className:"dash-card"},React.createElement("div",{className:"dash-val",style:{color:"var(--green)"}},num(stats.kunden)),React.createElement("div",{className:"dash-label"},"Kunden")),
      React.createElement("div",{className:"dash-card"},React.createElement("div",{className:"dash-val",style:{color:"var(--blue)"}},num(stats.efs)),React.createElement("div",{className:"dash-label"},"EFS Projekte")),
      React.createElement("div",{className:"dash-card"},React.createElement("div",{className:"dash-val",style:{color:"var(--orange)"}},num(stats.hold)),React.createElement("div",{className:"dash-label"},"On Hold")),
      React.createElement("div",{className:"dash-card"},React.createElement("div",{className:"dash-val",style:{color:"var(--red)"}},num(stats.stornos)),React.createElement("div",{className:"dash-label"},"Storniert"))
    ),
    React.createElement("h3",{style:{fontSize:13,fontWeight:700,color:"var(--text2)",marginBottom:12,textTransform:"uppercase",letterSpacing:1}},"Status-Ãœbersicht"),
    Object.entries(cats).map(([cat,items])=>{if(items.length===0)return null;const total=items.reduce((a,b)=>a+b[1],0);return React.createElement("div",{key:cat,style:{marginBottom:16}},
      React.createElement("div",{style:{fontSize:12,fontWeight:700,color:"var(--text2)",marginBottom:8,display:"flex",justifyContent:"space-between"}},React.createElement("span",null,cat),React.createElement("span",{style:{color:"var(--text3)"}},total)),
      React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:6}},items.sort((a,b)=>b[1]-a[1]).map(([s,c])=>{const sc=stC(s);return React.createElement("div",{key:s,onClick:()=>onStatusClick(s),style:{padding:"6px 12px",background:sc.bg,color:sc.c,borderRadius:8,fontSize:11,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6,transition:".15s",border:"1px solid transparent"},onMouseEnter:e=>{e.currentTarget.style.borderColor=sc.c},onMouseLeave:e=>{e.currentTarget.style.borderColor="transparent"}},
        s.length>30?s.substring(0,28)+"â€¦":s,React.createElement("span",{style:{background:"rgba(0,0,0,.2)",padding:"1px 6px",borderRadius:6,fontSize:9}},c)
      );}))
    );})
  );
}

function VPBoardView({cards,onSelect}){
  return React.createElement("div",{className:"main-inner"},
    React.createElement("h3",{style:{fontSize:13,fontWeight:700,color:"var(--text2)",marginBottom:14,textTransform:"uppercase",letterSpacing:1}},"Vertriebler-Board Â· Auszahlungen Oktâ€“Jan"),
    React.createElement("div",{className:"vp-grid"},cards.map(vp=>{
      const lm=Object.keys(vp.months).sort().pop();const lv=vp.months[lm]||0;
      return React.createElement("div",{key:vp.name,className:"vp-card",onClick:()=>onSelect(vp)},
        React.createElement("div",{className:"vp-name"},vp.name),
        React.createElement("div",{className:"vp-id"},vp.vp),
        React.createElement("div",{className:"vp-stats"},
          React.createElement("div",{className:"vp-stat"},React.createElement("div",{className:"vp-stat-val",style:{color:"var(--gold)"}},eur(vp.total)),React.createElement("div",{className:"vp-stat-label"},"Gesamt")),
          React.createElement("div",{className:"vp-stat"},React.createElement("div",{className:"vp-stat-val",style:{color:"var(--green)"}},vp.deals),React.createElement("div",{className:"vp-stat-label"},"Deals")),
          React.createElement("div",{className:"vp-stat"},React.createElement("div",{className:"vp-stat-val",style:{color:"var(--blue)"}},eur(lv)),React.createElement("div",{className:"vp-stat-label"},lm))
        )
      );
    }))
  );
}

function DetailView({a,k,e,pays,vbName}){
  const sc=stC(a.beedoo_fortschritt);const wf=parseWF(a.workflow_history);const payT=pays.reduce((s,p)=>s+(p.netto||0),0);
  const lat=k?.lat||null,lng=k?.lng||null;
  return React.createElement("div",{className:"main-inner"},
    React.createElement("div",{className:"k-header"},React.createElement("div",{className:"k-top"},
      React.createElement("div",null,
        React.createElement("div",{className:"k-name"},a.kunde_name||"â€“"),
        React.createElement("div",{className:"k-an"},"AN "+a.auftrag_nr,React.createElement("span",{style:{color:"var(--text3)"}}," Â· "),a.produkt_typ==="pv_finanz"?"â˜€ï¸ Finanzierung":a.produkt_typ==="pv_bar"?"ðŸ’µ Barzahler":"â˜€ï¸ PV"),
        React.createElement("div",{className:"k-meta"},
          (k?.strasse||a.kunde_plz)&&React.createElement("div",{className:"k-meta-item"},React.createElement(I,{d:"M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z M9 22V12h6v10"}),(k?.strasse||"")+" "+(k?.hausnr||"")+(k?.strasse?", ":"")+(a.kunde_plz||k?.plz||"")+" "+(k?.ort||"")),
          (a.kunde_telefon||k?.telefon||k?.mobil)&&React.createElement("div",{className:"k-meta-item"},React.createElement(I,{d:"M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"}),a.kunde_telefon||k?.telefon||k?.mobil),
          (a.kunde_email||k?.email)&&React.createElement("div",{className:"k-meta-item"},React.createElement(I,{d:"M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M22 6l-10 7L2 6"}),a.kunde_email||k?.email),
          vbName&&React.createElement("div",{className:"k-meta-item"},React.createElement(I,{d:"M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2M12 3a4 4 0 100 8 4 4 0 000-8z"}),"Berater: ",React.createElement("strong",{style:{color:"var(--gold)",marginLeft:3}},vbName))
        )
      ),
      React.createElement("div",{className:"k-status-pill",style:{background:sc.bg,color:sc.c}},a.beedoo_fortschritt||"Offen")
    )),
    React.createElement("div",{className:"key-nums"},
      React.createElement("div",{className:"key-num"},React.createElement("div",{className:"kn-val",style:{color:"var(--gold)"}},kwpF(a.anlagen_kwp)+" kWp"),React.createElement("div",{className:"kn-label"},"AnlagengrÃ¶ÃŸe")),
      React.createElement("div",{className:"key-num"},React.createElement("div",{className:"kn-val",style:{color:"var(--green)"}},a.an_wert_netto?eur(a.an_wert_netto/100):(e?.gesamtpreis_eur?eur(e.gesamtpreis_eur):"â€“")),React.createElement("div",{className:"kn-label"},"Auftragswert")),
      React.createElement("div",{className:"key-num"},React.createElement("div",{className:"kn-val",style:{color:payT>=0?"var(--blue)":"var(--red)"}},eur(payT)),React.createElement("div",{className:"kn-label"},"Provision")),
      React.createElement("div",{className:"key-num"},React.createElement("div",{className:"kn-val",style:{color:"var(--purple)"}},a.angebot_module||"â€“"),React.createElement("div",{className:"kn-label"},"Module"))
    ),
    React.createElement("div",{className:"cards-2"},
      React.createElement("div",{className:"card"},
        React.createElement("div",{className:"card-t"},React.createElement(I,{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z"})," Auftrag"),
        React.createElement("div",{className:"dg"},
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Auftragsnr."),React.createElement("div",{className:"dg-v",style:{color:"var(--gold)"}},a.auftrag_nr)),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Datum"),React.createElement("div",{className:"dg-v"},df(a.auftrags_datum))),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Produkt"),React.createElement("div",{className:"dg-v"},a.produkt_bezeichnung||a.produkt_typ||"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Module"),React.createElement("div",{className:"dg-v"},(a.angebot_module||"â€“")+"Ã— "+(a.angebot_solarmodule||"â€“").substring(0,25))),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Lead-Quelle"),React.createElement("div",{className:"dg-v"},a.lead_quelle||"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Eigenlead"),React.createElement("div",{className:"dg-v"},a.ist_eigenlead?"âœ… Ja":a.ist_empfehlung?"ðŸ¤ Empfehlung":"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Zahlungsstatus"),React.createElement("div",{className:"dg-v"},a.zahlungsstatus||"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Dokumente"),React.createElement("div",{className:"dg-v"},a.dokumentstatus||"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Metrify"),React.createElement("div",{className:"dg-v"},a.metrify_status||"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Leveto-ID"),React.createElement("div",{className:"dg-v"},a.leveto_lead_id||"â€“"))
        )
      ),
      React.createElement("div",{className:"card"},
        React.createElement("div",{className:"card-t"},React.createElement(I,{d:"M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"})," ",e?"EFS Finanzierung":"Finanzen"),
        e?React.createElement("div",{className:"dg"},
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Gesamtpreis"),React.createElement("div",{className:"dg-v",style:{color:"var(--gold)"}},eur(e.gesamtpreis_eur))),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"EFS Auszahlung"),React.createElement("div",{className:"dg-v",style:{color:"var(--green)"}},eur(e.efs_auszahlung_eur))),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Monatl. Rate"),React.createElement("div",{className:"dg-v"},eur(e.monatl_rate_eur))),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Zinssatz"),React.createElement("div",{className:"dg-v"},e.nominalzins?(e.nominalzins*100).toFixed(2)+"%":"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Preismodell"),React.createElement("div",{className:"dg-v"},e.preismodell||"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Vertragsstatus"),React.createElement("div",{className:"dg-v"},e.contract_status||"â€“")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"PV-Module"),React.createElement("div",{className:"dg-v"},e.pv_anzahl+"Ã— "+e.pv_hersteller+" ("+e.pv_kwp+" kWp)")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Wechselrichter"),React.createElement("div",{className:"dg-v"},e.wr_hersteller+" "+e.wr_kw+" kW")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"Batterie"),React.createElement("div",{className:"dg-v"},e.bat_hersteller+" "+e.bat_kwh+" kWh")),
          React.createElement("div",{className:"dg-item"},React.createElement("div",{className:"dg-l"},"ZustÃ¤ndiger"),React.createElement("div",{className:"dg-v"},e.zustaendiger||"â€“"))
        ):React.createElement("div",{style:{color:"var(--text3)",fontSize:12,textAlign:"center",padding:30}},"Kein EFS-Projekt verknÃ¼pft",a.an_wert_netto?React.createElement("div",{style:{marginTop:16}},React.createElement("div",{className:"dg-l"},"Netto-Auftragswert"),React.createElement("div",{className:"dg-v",style:{color:"var(--gold)",fontSize:18,fontWeight:700}},eur(a.an_wert_netto/100))):null)
      )
    ),
    React.createElement("div",{className:"cards-2"},
      React.createElement("div",{className:"card"},
        React.createElement("div",{className:"card-t"},React.createElement(I,{d:"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"})," Workflow-Timeline ",wf.length>0&&React.createElement("span",{style:{color:"var(--text3)",fontWeight:400}},"("+wf.length+")")),
        wf.length>0?React.createElement("div",{className:"timeline"},wf.map((s,i)=>{
          const isLast=i===wf.length-1;const isStorno=s.text.toLowerCase().includes("storniert");
          return React.createElement("div",{className:"tl-item",key:i},
            React.createElement("div",{className:"tl-dot "+(isStorno?"storno":isLast?"active":"done")}),
            React.createElement("div",{className:"tl-label"},s.text),
            React.createElement("div",{className:"tl-date"},s.date+" um "+s.time)
          );})):React.createElement("div",{style:{color:"var(--text3)",fontSize:12,textAlign:"center",padding:30}},"Keine Workflow-Daten")
      ),
      React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:14}},
        React.createElement("div",{className:"card"},
          React.createElement("div",{className:"card-t"},React.createElement(I,{d:"M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z M9 22V12h6v10"})," Standort"),
          React.createElement(KMap,{lat,lng,name:a.kunde_name})
        ),
        React.createElement("div",{className:"card",style:{flex:1}},
          React.createElement("div",{className:"card-t"},React.createElement(I,{d:"M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"})," Provisionen ",pays.length>0&&React.createElement("span",{style:{color:"var(--text3)",fontWeight:400}},"("+pays.length+")")),
          pays.length>0?React.createElement("div",{style:{overflowX:"auto"}},React.createElement("table",{className:"ptbl"},
            React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Periode"),React.createElement("th",null,"Berater"),React.createElement("th",{style:{textAlign:"right"}},"Betrag"))),
            React.createElement("tbody",null,
              pays.map((p,i)=>React.createElement("tr",{key:i},React.createElement("td",null,p.periode),React.createElement("td",null,p.vertriebler,React.createElement("br"),React.createElement("span",{style:{fontSize:9,color:"var(--text3)"}},p.vp_nummer)),React.createElement("td",{className:"amt "+(p.netto>=0?"pos":"neg")},eur(p.netto)))),
              React.createElement("tr",{className:"total"},React.createElement("td",{colSpan:2},"Gesamt"),React.createElement("td",{className:"amt "+(payT>=0?"pos":"neg")},eur(payT)))
            )
          )):React.createElement("div",{style:{color:"var(--text3)",fontSize:12,textAlign:"center",padding:20}},"Keine Auszahlungsdaten")
        )
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
