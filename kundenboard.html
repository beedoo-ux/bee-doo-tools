<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bee-doo Kundenboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
:root {
  --bg: #111113;
  --bg2: #1a1a1e;
  --bg3: #222228;
  --bg4: #2a2a32;
  --gold: #F5C500;
  --gold-dim: #c9a200;
  --gold-glow: rgba(245,197,0,0.15);
  --text: #e8e8ec;
  --text2: #a0a0aa;
  --text3: #68687a;
  --green: #34d399;
  --red: #f87171;
  --blue: #60a5fa;
  --orange: #fb923c;
  --purple: #a78bfa;
  --border: rgba(255,255,255,0.06);
  --radius: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--bg4); border-radius:3px; }

.header { 
  background:var(--bg2); border-bottom:1px solid var(--border); 
  padding:16px 24px; display:flex; align-items:center; gap:16px;
  position:sticky; top:0; z-index:100; backdrop-filter:blur(20px);
}
.logo { display:flex; align-items:center; gap:10px; flex-shrink:0; }
.logo-dot { width:28px; height:28px; background:var(--gold); border-radius:6px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; color:#111; }
.logo-text { font-size:18px; font-weight:600; color:var(--text); white-space:nowrap; }
.logo-text span { color:var(--text3); font-weight:400; margin-left:6px; font-size:15px; }

.search-wrap { flex:1; max-width:560px; position:relative; }
.search-input {
  width:100%; padding:10px 16px 10px 42px; background:var(--bg3); border:1px solid var(--border);
  border-radius:10px; color:var(--text); font-size:15px; font-family:inherit; outline:none;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.search-input:focus { border-color:var(--gold); box-shadow:0 0 0 3px var(--gold-glow); }
.search-input::placeholder { color:var(--text3); }
.search-icon { position:absolute; left:14px; top:50%; transform:translateY(-50%); color:var(--text3); pointer-events:none; }
.search-badge { position:absolute; right:12px; top:50%; transform:translateY(-50%); background:var(--bg4); padding:2px 8px; border-radius:5px; font-size:11px; color:var(--text3); }
.stats-bar { display:flex; gap:20px; margin-left:auto; }
.stat-item { text-align:center; }
.stat-num { font-size:20px; font-weight:700; color:var(--gold); line-height:1; }
.stat-label { font-size:11px; color:var(--text3); margin-top:2px; }

.main { display:flex; height:calc(100vh - 65px); }
.sidebar { 
  width:380px; min-width:380px; background:var(--bg2); border-right:1px solid var(--border);
  overflow-y:auto; display:flex; flex-direction:column;
}
.content { flex:1; overflow-y:auto; padding:24px; }

.list-header { 
  padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; 
  justify-content:space-between; position:sticky; top:0; background:var(--bg2); z-index:10;
}
.list-header h3 { font-size:13px; color:var(--text2); font-weight:500; }
.list-count { font-size:12px; color:var(--text3); background:var(--bg3); padding:2px 8px; border-radius:8px; }

.customer-item {
  padding:14px 16px; border-bottom:1px solid var(--border); cursor:pointer;
  transition:background 0.15s;
}
.customer-item:hover { background:var(--bg3); }
.customer-item.active { background:var(--gold-glow); border-left:3px solid var(--gold); }
.ci-name { font-size:15px; font-weight:600; color:var(--text); margin-bottom:3px; }
.ci-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.ci-tag { font-size:11px; padding:2px 7px; border-radius:5px; background:var(--bg4); color:var(--text2); white-space:nowrap; }
.ci-tag.gold { background:var(--gold-glow); color:var(--gold); }
.ci-tag.green { background:rgba(52,211,153,0.12); color:var(--green); }
.ci-tag.red { background:rgba(248,113,113,0.12); color:var(--red); }
.ci-tag.blue { background:rgba(96,165,250,0.12); color:var(--blue); }
.ci-tag.orange { background:rgba(251,146,60,0.12); color:var(--orange); }
.ci-sub { font-size:12px; color:var(--text3); margin-top:4px; }

.detail-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text3); gap:12px; }
.detail-empty svg { opacity:0.3; }
.detail-empty p { font-size:15px; }

.detail-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:24px; gap:16px; flex-wrap:wrap; }
.dh-left h1 { font-size:26px; font-weight:700; color:var(--text); line-height:1.2; }
.dh-left .dh-sub { font-size:14px; color:var(--text2); margin-top:4px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.dh-status { padding:6px 14px; border-radius:8px; font-size:13px; font-weight:600; white-space:nowrap; }
.dh-status.active { background:rgba(52,211,153,0.12); color:var(--green); }
.dh-status.storno { background:rgba(248,113,113,0.12); color:var(--red); }
.dh-status.pending { background:rgba(251,146,60,0.12); color:var(--orange); }

.cards-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(340px, 1fr)); gap:16px; margin-bottom:24px; }
.card { background:var(--bg2); border:1px solid var(--border); border-radius:var(--radius); padding:20px; transition:border-color 0.2s; }
.card:hover { border-color:rgba(255,255,255,0.1); }
.card-title { font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:0.8px; color:var(--text3); margin-bottom:14px; display:flex; align-items:center; gap:8px; }
.card-title svg { color:var(--gold); }
.card-row { display:flex; justify-content:space-between; align-items:baseline; padding:6px 0; border-bottom:1px solid var(--border); }
.card-row:last-child { border-bottom:none; }
.card-label { font-size:13px; color:var(--text2); flex-shrink:0; }
.card-value { font-size:14px; color:var(--text); font-weight:500; text-align:right; max-width:60%; word-break:break-word; }
.card-value.gold { color:var(--gold); font-weight:700; }
.card-value.green { color:var(--green); }
.card-value.red { color:var(--red); }
.card-full { grid-column:1 / -1; }

.timeline { padding:4px 0; }
.tl-item { display:flex; gap:14px; position:relative; padding-bottom:16px; }
.tl-item:last-child { padding-bottom:0; }
.tl-line { position:absolute; left:11px; top:24px; bottom:0; width:2px; background:var(--bg4); }
.tl-item:last-child .tl-line { display:none; }
.tl-dot { 
  width:24px; height:24px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center;
  position:relative; z-index:1;
}
.tl-dot.green { background:rgba(52,211,153,0.2); border:2px solid var(--green); }
.tl-dot.gold { background:var(--gold-glow); border:2px solid var(--gold); }
.tl-dot.red { background:rgba(248,113,113,0.2); border:2px solid var(--red); }
.tl-dot.blue { background:rgba(96,165,250,0.2); border:2px solid var(--blue); }
.tl-dot.orange { background:rgba(251,146,60,0.2); border:2px solid var(--orange); }
.tl-dot.default { background:var(--bg4); border:2px solid var(--bg4); }
.tl-content { flex:1; min-width:0; }
.tl-title { font-size:13px; color:var(--text); font-weight:500; }
.tl-date { font-size:11px; color:var(--text3); margin-top:1px; }

.prov-table { width:100%; border-collapse:collapse; font-size:13px; }
.prov-table th { text-align:left; color:var(--text3); font-weight:500; padding:6px 8px; border-bottom:1px solid var(--border); font-size:12px; }
.prov-table td { padding:6px 8px; border-bottom:1px solid var(--border); color:var(--text); }
.prov-table tr:last-child td { border-bottom:none; }
.prov-table .amount { text-align:right; font-weight:600; font-variant-numeric:tabular-nums; }
.prov-table .amount.pos { color:var(--green); }
.prov-table .amount.neg { color:var(--red); }

.loading { display:flex; align-items:center; justify-content:center; padding:40px; }
.spinner { width:32px; height:32px; border:3px solid var(--bg4); border-top-color:var(--gold); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }

@media (max-width:1024px) {
  .main { flex-direction:column; height:auto; }
  .sidebar { width:100%; min-width:unset; max-height:40vh; border-right:none; border-bottom:1px solid var(--border); }
  .content { padding:16px; }
  .cards-grid { grid-template-columns:1fr; }
  .stats-bar { display:none; }
}
@media (max-width:640px) {
  .header { padding:12px 16px; flex-wrap:wrap; }
  .search-wrap { max-width:100%; order:3; width:100%; }
  .logo-text span { display:none; }
  .detail-header { flex-direction:column; }
  .dh-left h1 { font-size:22px; }
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SB = 'https://hqzpemfaljxcysyqssng.supabase.co/rest/v1';
const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxenBlbWZhbGp4Y3lzeXFzc25nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzUzOTcsImV4cCI6MjA4NjkxMTM5N30.LSlMApceWuLk5MUctCGCVspXfYhc_As559aaoV2uSik';

async function sbFetch(table, params = '') {
  const r = await fetch(`${SB}/${table}?${params}`, {
    headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Prefer': 'count=exact' }
  });
  const count = r.headers.get('content-range')?.split('/')?.pop() || '0';
  return { data: await r.json(), count: parseInt(count) };
}

/* â”€â”€ Icons â”€â”€ */
const Ico = {
  search: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>,
  user: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  sun: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
  euro: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M4 10h12M4 14h9M17 4a8 8 0 0 1 0 16"/></svg>,
  clock: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
  zap: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
  wrench: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
  bank: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
  home: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
  empty: <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
};

/* â”€â”€ Helpers â”€â”€ */
const fmtEuro = v => (!v && v !== 0) ? 'â€“' : new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(v);
const fmtDate = d => { if(!d) return 'â€“'; try{ return new Date(d).toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'}); } catch{ return d; }};
const fmtKwp = v => { if(!v) return 'â€“'; const n=parseFloat(v); return (n>100?(n/100):n).toFixed(2)+' kWp'; };

function parseWorkflow(wf) {
  if (!wf) return [];
  return wf.split(/(?=\d{2}\.\d{2}\.\d{4})/).map(p => {
    const m = p.match(/(\d{2}\.\d{2}\.\d{4})\s*-\s*(\d{2}:\d{2})-?\s*(.*)/);
    if (!m) return null;
    let text = m[3].replace(/^\s*BeeDoo:\s*/i,'').replace(/^\s*[AD]C Montage:\s*/i,'ðŸ”§ ').trim();
    return { date:m[1], time:m[2], text };
  }).filter(Boolean).reverse();
}

function statusColor(s) {
  if(!s) return 'default';
  const l=s.toLowerCase();
  if(l.includes('storniert')||l.includes('technisch nicht')) return 'red';
  if(l.includes('erwarte')||l.includes('montage')||l.includes('lieferschein')||l.includes('netzanmeldung')||l.includes('fertiggestellt')) return 'green';
  if(l.includes('on hold')||l.includes('nacharbeit')) return 'orange';
  if(l.includes('auftrag')||l.includes('dc')||l.includes('ac')||l.includes('freigabe')||l.includes('quali')) return 'blue';
  return 'gold';
}

function statusBadge(f) {
  if(!f) return {cls:'pending',label:'Unbekannt'};
  const l=f.toLowerCase();
  if(l.includes('storniert')) return {cls:'storno',label:f};
  if(l.includes('erwarte')||l.includes('montage')||l.includes('netz')||l.includes('fertig')) return {cls:'active',label:f};
  return {cls:'pending',label:f};
}

/* â”€â”€ Card Row â”€â”€ */
const Row = ({label,value,cls}) => (
  <div className="card-row">
    <span className="card-label">{label}</span>
    <span className={`card-value ${cls||''}`}>{value || 'â€“'}</span>
  </div>
);

/* â”€â”€ Detail View â”€â”€ */
function DetailView({detail}) {
  const {auftrag:a, efs, vb, scouter, prov, customer} = detail;
  const timeline = parseWorkflow(a.workflow_history);
  const sb = statusBadge(a.beedoo_fortschritt);
  const provSum = prov.reduce((s,p)=>s+(p.netto||0),0);
  const typ = a.produkt_typ==='pv_finanz'?'Finanzierung':a.produkt_typ==='pv_bar'?'Barzahler':a.produkt_typ||'â€“';

  return (
    <div>
      <div className="detail-header">
        <div className="dh-left">
          <h1>{a.kunde_name}</h1>
          <div className="dh-sub">
            <span style={{color:'var(--gold)',fontWeight:600}}>AN {a.auftrag_nr}</span>
            <span>Â·</span>
            <span>{fmtDate(a.auftrags_datum)}</span>
            {a.produkt_bezeichnung && <><span>Â·</span><span>{a.produkt_bezeichnung}</span></>}
          </div>
        </div>
        <div className={`dh-status ${sb.cls}`}>{sb.label}</div>
      </div>

      <div className="cards-grid">
        {/* KUNDENDATEN */}
        <div className="card">
          <div className="card-title">{Ico.user} Kundendaten</div>
          <Row label="Name" value={a.kunde_name}/>
          <Row label="Adresse" value={[a.kunde_strasse,a.kunde_hausnr].filter(Boolean).join(' ')}/>
          <Row label="PLZ / Ort" value={[a.kunde_plz,a.kunde_ort].filter(Boolean).join(' ')}/>
          <Row label="Telefon" value={a.kunde_telefon||customer?.telefon||customer?.mobil}/>
          <Row label="E-Mail" value={a.kunde_email||customer?.email}/>
          {a.lead_quelle && <Row label="Lead-Quelle" value={a.lead_quelle}/>}
          {customer?.lat && <Row label="GPS" value={`${customer.lat}, ${customer.lng}`}/>}
        </div>

        {/* ANLAGE */}
        <div className="card">
          <div className="card-title">{Ico.sun} Anlage</div>
          <Row label="Leistung" value={fmtKwp(a.anlagen_kwp)} cls="gold"/>
          <Row label="Module" value={a.angebot_solarmodule||a.produkt_bezeichnung}/>
          <Row label="Anzahl Module" value={a.angebot_module}/>
          <Row label="Typ" value={typ}/>
          {efs && <>
            <Row label="Wechselrichter" value={`${efs.wr_hersteller||''} ${efs.wr_kw||''}kW`}/>
            <Row label="Batterie" value={`${efs.bat_hersteller||''} ${efs.bat_kwh||''}kWh`}/>
          </>}
        </div>

        {/* VERTRIEB */}
        <div className="card">
          <div className="card-title">{Ico.zap} Vertrieb</div>
          <Row label="Berater" value={vb?`${vb.vorname} ${vb.nachname}`:null}/>
          {vb?.typ && <Row label="Typ" value={vb.typ}/>}
          {vb?.email && <Row label="Email" value={vb.email}/>}
          {scouter && <Row label="Scouter" value={`${scouter.vorname} ${scouter.nachname}`}/>}
          <Row label="Lead-Quelle" value={a.lead_quelle}/>
          {a.ist_eigenlead && <Row label="Eigenlead" value="âœ“ Ja" cls="green"/>}
          {a.ist_empfehlung && <Row label="Empfehlung" value="âœ“ Ja" cls="green"/>}
          <Row label="Abschlussdatum" value={fmtDate(a.datum_angenommen||a.auftrags_datum)}/>
        </div>

        {/* FINANZEN */}
        <div className="card">
          <div className="card-title">{Ico.euro} Finanzen</div>
          <Row label="Auftragswert netto" value={a.an_wert_netto?fmtEuro(a.an_wert_netto/100):null} cls="gold"/>
          {efs && <>
            <Row label="Gesamtpreis" value={fmtEuro(efs.gesamtpreis_eur)}/>
            <Row label="EFS-Auszahlung" value={fmtEuro(efs.efs_auszahlung_eur)} cls="green"/>
            <Row label="Monatl. Rate" value={fmtEuro(efs.monatl_rate_eur)}/>
            <Row label="Zinssatz" value={efs.nominalzins?(efs.nominalzins*100).toFixed(2)+'%':null}/>
            <Row label="Preismodell" value={efs.preismodell}/>
          </>}
          <Row label="Zahlungsstatus" value={a.zahlungsstatus}/>
        </div>

        {/* MONTAGE / EFS */}
        {efs && (
          <div className="card">
            <div className="card-title">{Ico.wrench} Montage / EFS</div>
            <Row label="EFS-Status" value={efs.simplified_status||efs.status} cls={efs.simplified_status?.includes('SIGN')?'green':''}/>
            <Row label="Vertragsstatus" value={efs.contract_status}/>
            {efs.projekt_strasse && <Row label="Projektadresse" value={`${efs.projekt_strasse} ${efs.projekt_hausnr}, ${efs.projekt_plz} ${efs.projekt_stadt}`}/>}
            {efs.zweitkunde_name && <Row label="Zweitkunde" value={efs.zweitkunde_name}/>}
            <Row label="ZustÃ¤ndiger" value={efs.zustaendiger}/>
            <Row label="PV-System" value={`${efs.pv_anzahl}Ã— ${efs.pv_hersteller} ${efs.pv_watt}W`}/>
          </div>
        )}

        {/* PROVISION */}
        <div className="card">
          <div className="card-title">{Ico.bank} Provisionen</div>
          {prov.length===0 ? (
            <div style={{color:'var(--text3)',fontSize:13,padding:'8px 0'}}>Keine Auszahlungen gefunden</div>
          ) : (<>
            <table className="prov-table">
              <thead><tr><th>Periode</th><th>Berater</th><th style={{textAlign:'right'}}>Betrag</th></tr></thead>
              <tbody>{prov.map((p,i) => (
                <tr key={i}>
                  <td>{p.periode}</td>
                  <td>{p.vertriebler}</td>
                  <td className={`amount ${p.netto>=0?'pos':'neg'}`}>{fmtEuro(p.netto)}</td>
                </tr>
              ))}</tbody>
            </table>
            <div className="card-row" style={{marginTop:8,borderTop:'1px solid var(--border)',paddingTop:8}}>
              <span className="card-label" style={{fontWeight:600}}>Gesamt</span>
              <span className={`card-value ${provSum>=0?'green':'red'}`} style={{fontSize:16}}>{fmtEuro(provSum)}</span>
            </div>
          </>)}
        </div>

        {/* AUFTRAGSSTATUS */}
        <div className="card">
          <div className="card-title">{Ico.home} Auftragsstatus</div>
          <Row label="Fortschritt" value={a.beedoo_fortschritt}/>
          <Row label="Auftragsstatus" value={a.auftragsstatus}/>
          {a.metrify_status && <Row label="Metrify" value={a.metrify_status}/>}
          {a.dokumentstatus && <Row label="Dokumente" value={a.dokumentstatus}/>}
          {a.speichererweiterung && <Row label="Speichererweiterung" value="âœ“ Ja" cls="green"/>}
          {a.mvpp_name && a.mvpp_name!=='-' && <Row label="MVPP" value={a.mvpp_name}/>}
          {a.kundennummer && <Row label="Kundennr." value={a.kundennummer}/>}
        </div>

        {/* TIMELINE */}
        {timeline.length > 0 && (
          <div className="card card-full">
            <div className="card-title">{Ico.clock} Workflow-Timeline ({timeline.length} Events)</div>
            <div className="timeline">
              {timeline.slice(0,25).map((ev,i) => (
                <div className="tl-item" key={i}>
                  <div className="tl-line"></div>
                  <div className={`tl-dot ${statusColor(ev.text)}`}>
                    <div style={{width:8,height:8,borderRadius:'50%',background:'currentColor'}}></div>
                  </div>
                  <div className="tl-content">
                    <div className="tl-title">{ev.text}</div>
                    <div className="tl-date">{ev.date} um {ev.time}</div>
                  </div>
                </div>
              ))}
              {timeline.length > 25 && (
                <div style={{color:'var(--text3)',fontSize:12,paddingLeft:38}}>... und {timeline.length-25} weitere Events</div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* â”€â”€ App â”€â”€ */
function App() {
  const [searchQ, setSearchQ] = useState('');
  const [items, setItems] = useState([]);
  const [selId, setSelId] = useState(null);
  const [detail, setDetail] = useState(null);
  const [loadList, setLoadList] = useState(false);
  const [loadDet, setLoadDet] = useState(false);
  const [stats, setStats] = useState({a:0,k:0});
  const timer = useRef(null);

  useEffect(() => {
    (async()=>{
      const [a,c] = await Promise.all([sbFetch('auftraege','select=id&limit=0'), sbFetch('customers','select=id&limit=0')]);
      setStats({a:a.count,k:c.count});
    })();
  }, []);

  useEffect(() => {
    if(timer.current) clearTimeout(timer.current);
    timer.current = setTimeout(()=>doSearch(searchQ), 300);
    return ()=>clearTimeout(timer.current);
  }, [searchQ]);

  async function doSearch(q) {
    setLoadList(true);
    let filter = 'order=auftrags_datum.desc&limit=50';
    if(q && q.length>=2) {
      if(/^\d+$/.test(q.trim())) filter = `auftrag_nr=eq.${q.trim()}&limit=50`;
      else if(/^an/i.test(q)) filter = `auftrag_nr=eq.${q.replace(/^AN[-\s]*/i,'')}&limit=50`;
      else if(/^\d{5}$/.test(q.trim())) filter = `kunde_plz=eq.${q.trim()}&order=auftrags_datum.desc&limit=50`;
      else filter = `kunde_name=ilike.*${encodeURIComponent(q)}*&order=auftrags_datum.desc&limit=50`;
    }
    const {data} = await sbFetch('auftraege', `select=id,auftrag_nr,kunde_name,kunde_plz,kunde_ort,anlagen_kwp,beedoo_fortschritt,auftrags_datum,produkt_bezeichnung,lead_quelle,vertriebler_id&${filter}`);
    setItems(data||[]);
    setLoadList(false);
  }

  async function loadDetail(item) {
    setSelId(item.id);
    setLoadDet(true);
    
    const [fullRes, ] = await Promise.all([sbFetch('auftraege', `id=eq.${item.id}`)]);
    const a = fullRes.data?.[0] || item;

    // Parallel loads
    const promises = [];
    promises.push(a.efs_projekt_id ? sbFetch('efs_projekte',`id=eq.${a.efs_projekt_id}`) : {data:[]});
    promises.push(a.vertriebler_id ? sbFetch('mitarbeiter',`id=eq.${a.vertriebler_id}&select=id,vorname,nachname,typ,email,telefon`) : {data:[]});
    promises.push(a.scouter_id ? sbFetch('mitarbeiter',`id=eq.${a.scouter_id}&select=id,vorname,nachname,typ`) : {data:[]});
    
    // Customer record
    const anNr = a.auftrag_nr ? `AN-${a.auftrag_nr}` : null;
    promises.push(anNr ? sbFetch('customers',`auftrag_nr=eq.${anNr}`) : {data:[]});

    // Provision - search by last name
    const nachname = a.kunde_name?.split(' ').pop();
    promises.push(nachname?.length>2 ? sbFetch('pay_auszahlungen_historie',`kunde=ilike.*${encodeURIComponent(nachname)}*&order=periode.desc`) : {data:[]});

    const [efsR, vbR, scR, custR, provR] = await Promise.all(promises);

    // Filter prov to matching customer
    const provFiltered = (provR.data||[]).filter(p => {
      if(!p.kunde || !a.kunde_name) return false;
      const words = a.kunde_name.toLowerCase().split(/\s+/).filter(w=>w.length>2);
      const pk = p.kunde.toLowerCase();
      return words.filter(w=>pk.includes(w)).length >= Math.min(2, words.length);
    });

    setDetail({
      auftrag: a,
      efs: efsR.data?.[0]||null,
      vb: vbR.data?.[0]||null,
      scouter: scR.data?.[0]||null,
      customer: custR.data?.[0]||null,
      prov: provFiltered
    });
    setLoadDet(false);
  }

  return (<>
    <div className="header">
      <div className="logo">
        <div className="logo-dot">b</div>
        <div className="logo-text">Kundenboard<span>â€” Alle Daten auf einen Blick</span></div>
      </div>
      <div className="search-wrap">
        <span className="search-icon">{Ico.search}</span>
        <input className="search-input" placeholder="Kunde, AN-Nr oder PLZ suchen..."
          value={searchQ} onChange={e=>setSearchQ(e.target.value)} autoFocus/>
        {searchQ && <span className="search-badge">{items.length} Treffer</span>}
      </div>
      <div className="stats-bar">
        <div className="stat-item"><div className="stat-num">{stats.a.toLocaleString('de')}</div><div className="stat-label">AuftrÃ¤ge</div></div>
        <div className="stat-item"><div className="stat-num">{stats.k.toLocaleString('de')}</div><div className="stat-label">Kunden</div></div>
      </div>
    </div>
    
    <div className="main">
      <div className="sidebar">
        <div className="list-header">
          <h3>{searchQ ? 'Suchergebnisse' : 'Neueste AuftrÃ¤ge'}</h3>
          <span className="list-count">{items.length}</span>
        </div>
        {loadList ? <div className="loading"><div className="spinner"></div></div> : 
          items.map(c => {
            const s = statusBadge(c.beedoo_fortschritt);
            const tagCls = s.cls==='storno'?'red':s.cls==='active'?'green':'orange';
            return (
              <div key={c.id} className={`customer-item ${selId===c.id?'active':''}`} onClick={()=>loadDetail(c)}>
                <div className="ci-name">{c.kunde_name||'â€”'}</div>
                <div className="ci-row">
                  <span className="ci-tag gold">AN {c.auftrag_nr}</span>
                  {c.anlagen_kwp>0 && <span className="ci-tag">{fmtKwp(c.anlagen_kwp)}</span>}
                  {c.beedoo_fortschritt && <span className={`ci-tag ${tagCls}`}>{c.beedoo_fortschritt?.substring(0,28)}</span>}
                </div>
                <div className="ci-sub">{c.kunde_plz} {c.kunde_ort} Â· {fmtDate(c.auftrags_datum)}{c.lead_quelle?` Â· ${c.lead_quelle}`:''}</div>
              </div>
            );
          })
        }
      </div>

      <div className="content">
        {loadDet ? <div className="loading"><div className="spinner"></div></div> :
         !detail ? <div className="detail-empty">{Ico.empty}<p>Kunde auswÃ¤hlen um alle Details zu sehen</p></div> :
         <DetailView detail={detail}/>}
      </div>
    </div>
  </>);
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
