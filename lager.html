<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>bee-doo Â· LAGER</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“¦</text></svg>"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.2/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0c1222;color:#e1e7ef;font-family:'DM Sans',system-ui,sans-serif}
button,select,input,textarea{font-family:inherit}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#263354;border-radius:2px}
.back-btn{position:fixed;top:10px;left:10px;z-index:9999;background:#151d30;border:1px solid #263354;color:#5c6b8a;padding:6px 14px;border-radius:8px;font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;text-decoration:none;transition:all .15s}
.back-btn:hover{border-color:#FDE154;color:#FDE154}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.slide-up{animation:slideUp 0.2s ease both}
</style>

<style>

/* â•â•â• bee-doo Responsive + Lesbarkeit Fix â•â•â• */

/* === LESBARKEIT: Schriften aufhellen === */
/* Zu dunkle GrautÃ¶ne auf Dark Theme aufhellen */
body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

/* === TABLET (768px) === */
@media (max-width: 768px) {
  /* Grid â†’ weniger Spalten */
  [style*="grid-template-columns"][style*="repeat"] { 
    grid-template-columns: repeat(2, 1fr) !important; 
  }
  [style*="gridTemplateColumns"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* Flex-Container wrappen */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'], [style*="display:'flex'"] {
    flex-wrap: wrap !important;
  }
  /* Ausnahme: Nav-Items und kleine Icon-Rows nicht wrappen */
  [style*="align-items:center"][style*="gap:4px"],
  [style*="alignItems:"center""][style*="gap:"4px""] {
    flex-wrap: nowrap !important;
  }
  
  /* Sidebar verkleinern */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'] {
    width: 200px !important;
    min-width: 200px !important;
  }
  
  /* Modals nicht breiter als Screen */
  .modal, [style*="width:480px"], [style*="width:520px"], [style*="width:560px"],
  [style*="width:600px"], [style*="width:640px"], [style*="width:700px"] {
    width: 95vw !important;
    max-width: 95vw !important;
  }
  
  /* Padding reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"] {
    padding: 20px !important;
  }
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"] {
    padding: 20px !important;
  }
  
  /* Tabellen scrollbar */
  table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  
  /* Font-Size Minimum */
  * { min-height: 0; }
}

/* === MOBILE (480px) === */
@media (max-width: 480px) {
  /* Grid â†’ 1 Spalte */
  [style*="grid-template-columns"], [style*="gridTemplateColumns"] { 
    grid-template-columns: 1fr !important; 
  }
  .grid { grid-template-columns: 1fr !important; }
  
  /* Sidebar ausblenden oder collapsieren */
  [style*="width:240px"], [style*="width: 240px"],
  [style*="width:260px"], [style*="width: 260px"],
  [style*="width:280px"], [style*="width: 280px"],
  [style*="width:200px"], [style*="width: 200px"],
  [style*='width:"240px"'], [style*='width:"260px"'], [style*='width:"280px"'],
  [style*='width:"200px"'] {
    position: fixed !important;
    left: -300px !important;
    z-index: 999 !important;
    transition: left 0.3s ease !important;
    width: 260px !important;
    height: 100vh !important;
    top: 0 !important;
  }
  
  /* Alle Flex-Container stacken */
  [style*="display:flex"], [style*="display: flex"],
  [style*='display:"flex"'] {
    flex-wrap: wrap !important;
  }
  [style*="flex-direction:row"], [style*="flexDirection:"row""],
  [style*="flex-direction: row"] {
    flex-direction: column !important;
  }
  
  /* Form-Elemente full width */
  input, select, textarea, .input-field {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    font-size: 16px !important; /* Prevents iOS zoom */
  }
  
  /* Buttons touch-friendly */
  button, .btn-primary, .btn-secondary, [role="button"] {
    min-height: 44px !important;
    min-width: 44px !important;
    font-size: 14px !important;
  }
  
  /* Padding stark reduzieren */
  [style*="padding:40px"], [style*="padding:48px"], [style*="padding:32px"],
  [style*="padding:28px"], [style*="padding:24px"],
  [style*="padding: 40px"], [style*="padding: 48px"], [style*="padding: 32px"],
  [style*="padding: 28px"], [style*="padding: 24px"] {
    padding: 12px !important;
  }
  
  /* Gap reduzieren */
  [style*="gap:24px"], [style*="gap:20px"], [style*="gap:28px"],
  [style*="gap: 24px"], [style*="gap: 20px"], [style*="gap: 28px"] {
    gap: 12px !important;
  }
  
  /* Font sizes - minimum 12px */
  [style*="font-size:8px"], [style*="font-size:9px"], [style*="font-size:10px"],
  [style*="font-size: 8px"], [style*="font-size: 9px"], [style*="font-size: 10px"],
  [style*="fontSize:8px"], [style*="fontSize:9px"], [style*="fontSize:10px"],
  [style*='fontSize:"8px"'], [style*='fontSize:"9px"'], [style*='fontSize:"10px"'] {
    font-size: 12px !important;
  }
  
  /* Bilder responsive */
  img { max-width: 100% !important; height: auto !important; }
  
  /* Fixed elements repositionieren */
  [style*="position:fixed"][style*="top:12px"][style*="left:12px"],
  [style*="position: fixed"][style*="top: 12px"][style*="left: 12px"] {
    top: 6px !important;
    left: 6px !important;
    font-size: 11px !important;
    padding: 4px 8px !important;
  }
  
  /* Logo kleiner */
  .logo { font-size: 32px !important; }
  
  /* Text wrap erzwingen */
  * { word-wrap: break-word !important; overflow-wrap: break-word !important; }
  [style*="white-space:nowrap"], [style*="white-space: nowrap"],
  [style*='whiteSpace:"nowrap"'] {
    white-space: normal !important;
  }
  
  /* Modals full width */
  .modal, [class*="modal"], [style*="width:480px"], [style*="width:520px"],
  [style*="width:560px"], [style*="width:600px"] {
    width: 96vw !important;
    max-width: 96vw !important;
    padding: 16px !important;
    margin: 8px !important;
  }
  
  /* Map containers */
  #map, .leaflet-container, [style*="height:100vh"] {
    height: calc(100vh - 60px) !important;
  }
  .map-toolbar {
    flex-direction: column !important;
    top: 6px !important;
    left: 6px !important;
    right: 6px !important;
  }
  .map-tool-btn {
    font-size: 11px !important;
    padding: 5px 10px !important;
  }
}

/* â•â•â• Lesbarkeit: Zu dunkle Farben aufhellen â•â•â• */
/* #0c1222 backgrounds â†’ Schrift mindestens #8b95a5 */
[style*="color:#0c1222"], [style*="color: #0c1222"] { color: #8b95a5 !important; }
[style*="color:#151d30"], [style*="color: #151d30"] { color: #8b95a5 !important; }
[style*="color:#263354"], [style*="color: #263354"] { color: #7a8baa !important; }
[style*="color:#1c2640"], [style*="color: #1c2640"] { color: #8b95a5 !important; }
[style*="color:#334155"], [style*="color: #334155"] { color: #8b95a5 !important; }
[style*="color:#252530"], [style*="color: #252530"] { color: #8b95a5 !important; }
[style*='color:"#0c1222"'] { color: #8b95a5 !important; }
[style*='color:"#151d30"'] { color: #8b95a5 !important; }
[style*='color:"#263354"'] { color: #7a8baa !important; }
[style*='color:"#1c2640"'] { color: #8b95a5 !important; }
[style*='color:"#334155"'] { color: #8b95a5 !important; }
[style*='color:"#252530"'] { color: #8b95a5 !important; }

/* GrÃ¼ntÃ¶ne auf Dark besser lesbar machen */
[style*="color:#166534"], [style*="color: #166534"] { color: #34d399 !important; }
[style*='color:"#166534"'] { color: #34d399 !important; }

/* Generell: Alle font-sizes unter 10px auf mindestens 11px */

/* lager.html specific */
@media (max-width: 480px) {
  input, select { font-size: 14px !important; padding: 8px !important; }
}
</style>
</head>
<body>
<a href="index.html" class="back-btn">â† Launcher</a>
<div id="root"></div>
<script type="text/babel">
const { useState, useMemo, useEffect, useRef } = React;

// â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Y="#FDE154",BG="#0c1222",C1="#151d30",C2="#1c2640",BR="#263354";
const TX="#e1e7ef",TX2="#5c6b8a";
const OK="#34d399",WARN="#f59e0b",ERR="#f87171",PURPLE="#E879F9",BLUE="#60A5FA";
const FARBEN=[BLUE,OK,PURPLE,WARN,"#F472B6","#2DD4BF",Y,ERR];
const CARD={background:C1,border:`1px solid ${BR}`,borderRadius:12,padding:"16px"};
const INPUT={background:C2,border:`1px solid ${BR}`,borderRadius:8,color:TX,padding:"8px 12px",fontSize:13,width:"100%",boxSizing:"border-box",outline:"none"};
const KAT_LISTE=["Alle","Wechselrichter","Batterie","ZubehÃ¶r","ZÃ¤hlerschrank","Wallbox","Unterkonstruktion","PV-Module","Kabel"];

// â”€â”€ ARTIKEL-STAMM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LIEFERANTEN_DEFAULT={
  "Fox":         {name:"Fox",         farbe:"#F97316", info:"Wechselrichter Â· Batterien Â· Wallbox Â· EPS", email:"bestellung@fox-ess.de"},
  "SL Rack":     {name:"SL Rack",     farbe:"#60A5FA", info:"Unterkonstruktion",                          email:"order@sl-rack.com"},
  "Cordes":      {name:"Cordes",      farbe:"#34d399", info:"ZÃ¤hlerschrÃ¤nke",                             email:"bestellung@cordes-gmbh.de"},
  "Tritec":      {name:"Tritec",      farbe:"#FDE154", info:"PV-Module Â· Spediteur",                      email:"lager@tritec-energy.de"},
  "Consolinno":  {name:"Consolinno",  farbe:"#E879F9", info:"HEMS",                                       email:"order@consolinno.de"},
  "Elektriker":  {name:"Elektriker",  farbe:"#5c6b8a", info:"Vor Ort â€“ kein Lagerbestand nÃ¶tig",          email:""},
};
const BREVO_KEY=window.BEEDOO_BREVO||"";
const LIEFERANTEN=LIEFERANTEN_DEFAULT; // wird in App durch useState Ã¼berschrieben

const INIT_ART=[
  {id:"WR-50", name:"Wechselrichter 5.0 kW",  kat:"Wechselrichter",  bestand:8,  min:5,  einheit:"Stk",preis:1240,sn:true, lief:"Fox"},
  {id:"WR-80", name:"Wechselrichter 8.0 kW",  kat:"Wechselrichter",  bestand:3,  min:5,  einheit:"Stk",preis:1480,sn:true, lief:"Fox"},
  {id:"WR-100",name:"Wechselrichter 10.0 kW", kat:"Wechselrichter",  bestand:5,  min:3,  einheit:"Stk",preis:1680,sn:true, lief:"Fox"},
  {id:"BAT-M", name:"Batterie Master",         kat:"Batterie",        bestand:10, min:5,  einheit:"Stk",preis:2100,sn:true, lief:"Fox"},
  {id:"BAT-S1",name:"Batterie Slave 1",        kat:"Batterie",        bestand:18, min:10, einheit:"Stk",preis:1800,sn:true, lief:"Fox"},
  {id:"BAT-S2",name:"Batterie Slave 2",        kat:"Batterie",        bestand:7,  min:10, einheit:"Stk",preis:1800,sn:true, lief:"Fox"},
  {id:"EPS",   name:"EPS Box",                 kat:"ZubehÃ¶r",         bestand:12, min:5,  einheit:"Stk",preis:320, sn:true, lief:"Fox"},
  {id:"ZS-1P", name:"ZÃ¤hlerschrank 1-phasig", kat:"ZÃ¤hlerschrank",   bestand:6,  min:3,  einheit:"Stk",preis:480, sn:false,lief:"Cordes"},
  {id:"ZS-3P", name:"ZÃ¤hlerschrank 3-phasig", kat:"ZÃ¤hlerschrank",   bestand:9,  min:4,  einheit:"Stk",preis:640, sn:false,lief:"Cordes"},
  {id:"WB-11", name:"Wallbox 11 kW",           kat:"Wallbox",         bestand:4,  min:3,  einheit:"Stk",preis:890, sn:true, lief:"Fox"},
  {id:"WB-22", name:"Wallbox 22 kW",           kat:"Wallbox",         bestand:2,  min:3,  einheit:"Stk",preis:1190,sn:true, lief:"Fox"},
  {id:"UK-PRO",name:"UK Profil 40mm",          kat:"Unterkonstruktion",bestand:320,min:100,einheit:"m",  preis:4.80,sn:false,lief:"SL Rack"},
  {id:"UK-HAK",name:"UK Dachhaken",            kat:"Unterkonstruktion",bestand:440,min:200,einheit:"Stk",preis:3.20,sn:false,lief:"SL Rack"},
  {id:"UK-KLE",name:"UK Klemme Mitte",         kat:"Unterkonstruktion",bestand:280,min:150,einheit:"Stk",preis:2.10,sn:false,lief:"SL Rack"},
  {id:"MOD-405",name:"PV-Modul 405W",          kat:"PV-Module",       bestand:84, min:40, einheit:"Stk",preis:89,  sn:false,lief:"Tritec"},
  {id:"MOD-430",name:"PV-Modul 430W",          kat:"PV-Module",       bestand:22, min:30, einheit:"Stk",preis:94,  sn:false,lief:"Tritec"},
  {id:"KAB-DC",name:"DC-Kabel 6mmÂ²",           kat:"Kabel",           bestand:0,  min:0,  einheit:"m",  preis:1.20,sn:false,lief:"Elektriker"},
  {id:"MC4",   name:"MC4-Steckverbinder",      kat:"Kabel",           bestand:0,  min:0,  einheit:"Paar",preis:2.40,sn:false,lief:"Elektriker"},
  {id:"HEMS",  name:"HEMS Consolinno",         kat:"ZubehÃ¶r",         bestand:5,  min:3,  einheit:"Stk",preis:490, sn:true, lief:"Consolinno"},
];

// â”€â”€ PAKETE-VORLAGEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const INIT_PAKETE=[
  {id:"PKT-001",name:"Starter 5kW + 10kWh",farbe:BLUE,beschreibung:"Einstiegspaket",
   komp:[{aId:"WR-50",m:1},{aId:"BAT-M",m:1},{aId:"BAT-S1",m:1},{aId:"EPS",m:1},{aId:"ZS-3P",m:1}]},
  {id:"PKT-002",name:"Standard 8kW + 15kWh",farbe:OK,beschreibung:"Meistverkauft",
   komp:[{aId:"WR-80",m:1},{aId:"BAT-M",m:1},{aId:"BAT-S1",m:2},{aId:"EPS",m:1},{aId:"ZS-3P",m:1}]},
  {id:"PKT-003",name:"Premium 10kW + 20kWh",farbe:PURPLE,beschreibung:"GroÃŸe Anlagen",
   komp:[{aId:"WR-100",m:1},{aId:"BAT-M",m:1},{aId:"BAT-S1",m:2},{aId:"BAT-S2",m:1},{aId:"EPS",m:1},{aId:"ZS-3P",m:1}]},
];

// â”€â”€ AUFTRÃ„GE MIT STÃœCKLISTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// quelle: "field" = vom Berater gewÃ¤hlt | "planung" = von Planung ergÃ¤nzt
const INIT_AUFTRAEGE=[
  {
    id:"AU-2026-0092",
    kunde:"Fischer, Maria",adresse:"Detmolder Str. 88, Bielefeld",
    montageDatum:"2026-02-28",berater:"T. Hoffmann",system:"Standard 8kW",
    status:"offen",
    stueckliste:[
      {aId:"WR-80",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"BAT-M",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"BAT-S1", m:2, quelle:"field",   sn:"",      komm:false},
      {aId:"EPS",    m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"ZS-3P",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"MOD-430",m:20,quelle:"field",   sn:"",      komm:false},
      {aId:"UK-PRO", m:48,quelle:"planung", sn:"",      komm:false},
      {aId:"UK-HAK", m:24,quelle:"planung", sn:"",      komm:false},
      {aId:"UK-KLE", m:40,quelle:"planung", sn:"",      komm:false},
      {aId:"KAB-DC", m:60,quelle:"planung", sn:"",      komm:false},
      {aId:"MC4",    m:20,quelle:"planung", sn:"",      komm:false},
    ]
  },
  {
    id:"AU-2026-0091",
    kunde:"Braun, Stefan",adresse:"Herforder Str. 12, Herford",
    montageDatum:"2026-03-03",berater:"S. Wagner",system:"Premium 10kW + Wallbox",
    status:"offen",
    stueckliste:[
      {aId:"WR-100", m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"BAT-M",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"BAT-S1", m:2, quelle:"field",   sn:"",      komm:false},
      {aId:"BAT-S2", m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"EPS",    m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"ZS-3P",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"WB-22",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"MOD-430",m:24,quelle:"field",   sn:"",      komm:false},
      {aId:"UK-PRO", m:58,quelle:"planung", sn:"",      komm:false},
      {aId:"UK-HAK", m:29,quelle:"planung", sn:"",      komm:false},
      {aId:"UK-KLE", m:48,quelle:"planung", sn:"",      komm:false},
      {aId:"KAB-DC", m:72,quelle:"planung", sn:"",      komm:false},
      {aId:"MC4",    m:24,quelle:"planung", sn:"",      komm:false},
    ]
  },
  {
    id:"AU-2026-0090",
    kunde:"MÃ¼ller, Hans",adresse:"GÃ¼tersloher Str. 5, GÃ¼tersloh",
    montageDatum:"2026-03-07",berater:"M. Klein",system:"Starter 5kW",
    status:"offen",
    stueckliste:[
      {aId:"WR-50",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"BAT-M",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"BAT-S1", m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"EPS",    m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"ZS-3P",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"WB-11",  m:1, quelle:"field",   sn:"",      komm:false},
      {aId:"MOD-405",m:14,quelle:"field",   sn:"",      komm:false},
      {aId:"UK-PRO", m:34,quelle:"planung", sn:"",      komm:false},
      {aId:"UK-HAK", m:17,quelle:"planung", sn:"",      komm:false},
      {aId:"UK-KLE", m:28,quelle:"planung", sn:"",      komm:false},
      {aId:"KAB-DC", m:42,quelle:"planung", sn:"",      komm:false},
      {aId:"MC4",    m:14,quelle:"planung", sn:"",      komm:false},
    ]
  },
];

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Badge({color,label}){
  return <span style={{background:`${color}18`,color,border:`1px solid ${color}40`,borderRadius:6,padding:"2px 8px",fontSize:10,fontWeight:700,letterSpacing:"0.5px",display:"inline-block"}}>{label}</span>;
}
function Bar({v,max,color}){
  return <div style={{background:BR,borderRadius:4,height:4,width:"100%"}}><div style={{width:`${Math.min((v/Math.max(max,1))*100,100)}%`,height:"100%",background:color||OK,borderRadius:4,transition:"width 0.4s ease"}}/></div>;
}

function getArt(id,art){return art.find(a=>a.id===id);}

function getStuecklistenStatus(sl,art){
  let total=sl.length,fehlen=0,teilverfuegbar=0;
  const fehlTeile=[];
  sl.forEach(s=>{
    const a=getArt(s.aId,art);
    if(!a||a.bestand<s.m){fehlen++;fehlTeile.push(a?.name||s.aId);}
    else if(a.bestand<s.m*2) teilverfuegbar++;
  });
  if(fehlen>0) return {color:ERR,label:"Fehlteile",icon:"âœ•",fehlen,fehlTeile};
  if(teilverfuegbar>0) return {color:WARN,label:"Knapp",icon:"âš ",fehlen:0,fehlTeile:[]};
  return {color:OK,label:"VerfÃ¼gbar",icon:"âœ“",fehlen:0,fehlTeile:[]};
}

function getKommStatus(sl){
  const total=sl.length;
  const done=sl.filter(s=>s.komm).length;
  if(done===0) return {pct:0,color:TX2,label:"Offen"};
  if(done===total) return {pct:100,color:OK,label:"Komplett"};
  return {pct:Math.round(done/total*100),color:WARN,label:`${done}/${total}`};
}

// â”€â”€ QR CODE COMPONENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function QRCode({value,size=120}){
  const ref=useRef(null);
  useEffect(()=>{
    if(!ref.current) return;
    ref.current.innerHTML="";
    try{
      new window.QRCode(ref.current,{text:value,width:size,height:size,colorDark:"#e1e7ef",colorLight:"#151d30",correctLevel:window.QRCode.CorrectLevel.M});
    }catch(e){}
  },[value,size]);
  return <div ref={ref} style={{display:"inline-block"}}/>;
}

// â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App(){
  const [tab,setTab]=useState("auftraege");
  const [art,setArt]=useState(INIT_ART);
  const [pakete,setPakete]=useState(INIT_PAKETE);
  const [auftraege,setAuftraege]=useState(INIT_AUFTRAEGE);
  const [bestellungen,setBestellungen]=useState([]);
  const [liefConfig,setLiefConfig]=useState(LIEFERANTEN_DEFAULT);
  const [ccIntern,setCcIntern]=useState("lager@bee-doo.de");
  const [modal,setModal]=useState(null);
  const [toast,setToast]=useState(null);

  function showToast(msg,ok=true){setToast({msg,ok});setTimeout(()=>setToast(null),3200);}

  const kritisch=art.filter(a=>a.bestand<a.min&&a.lief!=="Elektriker");
  const gesamtwert=art.reduce((s,a)=>s+a.bestand*a.preis,0);
  const offeneAu=auftraege.filter(a=>a.status!=="ausgegeben").length;
  const offeneBest=bestellungen.filter(b=>b.status==="bestellt").length;

  const TABS=[
    {id:"auftraege",    label:"AuftrÃ¤ge",   icon:"ğŸ“‹"},
    {id:"prognose",     label:"Prognose",   icon:"ğŸ“ˆ"},
    {id:"bestand",      label:"Bestand",    icon:"ğŸ“¦"},
    {id:"bestellen",    label:"Bestellen",  icon:"ğŸ›’"},
    {id:"wareneingang", label:"Eingang",    icon:"ğŸ“¥"},
    {id:"lieferanten",  label:"Lieferanten",icon:"ğŸ­"},
  ];

  return (
    <div style={{fontFamily:"'DM Sans',system-ui,sans-serif",background:BG,minHeight:"100vh",color:TX,maxWidth:480,margin:"0 auto",paddingBottom:80}}>

      {/* HEADER */}
      <div style={{background:C1,borderBottom:`1px solid ${BR}`,padding:"48px 16px 0",position:"sticky",top:0,zIndex:50}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12}}>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <div style={{width:36,height:36,borderRadius:10,background:`${PURPLE}20`,border:`1px solid ${PURPLE}40`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}}>ğŸ“¦</div>
            <div>
              <div style={{fontWeight:800,fontSize:16}}>bee-doo LAGER</div>
              <div style={{fontSize:10,color:TX2}}>
                {offeneAu} AuftrÃ¤ge Â· {offeneBest>0&&<span style={{color:WARN}}>{offeneBest} ausstehend</span>}
                {kritisch.length>0&&<span style={{color:ERR}}> Â· {kritisch.length} kritisch</span>}
              </div>
            </div>
          </div>
          <div style={{textAlign:"right"}}>
            <div style={{fontSize:10,color:TX2}}>Lagerwert</div>
            <div style={{fontSize:14,fontWeight:700,color:Y}}>â‚¬{gesamtwert.toLocaleString("de-DE",{maximumFractionDigits:0})}</div>
          </div>
        </div>
        <div style={{display:"flex",gap:3,background:C2,borderRadius:10,padding:3}}>
          {TABS.map(t=>(
            <button key={t.id} onClick={()=>setTab(t.id)} style={{flex:1,padding:"6px 4px",borderRadius:8,border:"none",cursor:"pointer",background:tab===t.id?C1:"transparent",color:tab===t.id?TX:TX2,fontSize:9,fontWeight:700,letterSpacing:"0.3px",boxShadow:tab===t.id?`0 0 0 1px ${BR}`:"none",transition:"all 0.15s"}}>
              <div style={{fontSize:13,marginBottom:1}}>{t.icon}</div>{t.label}
            </button>
          ))}
        </div>
        <div style={{height:12}}/>
      </div>

      <div style={{padding:"12px 16px"}}>
        {tab==="prognose"     && <PrognoseTab art={art} showToast={showToast}/>}
        {tab==="auftraege"    && <AuftraegeTab auftraege={auftraege} setAuftraege={setAuftraege} art={art} setArt={setArt} pakete={pakete} setModal={setModal} showToast={showToast}/>}
        {tab==="bestand"      && <BestandTab art={art} setArt={setArt} kritisch={kritisch} setModal={setModal}/>}
        {tab==="bestellen"    && <BestellenTab art={art} setArt={setArt} kritisch={kritisch} bestellungen={bestellungen} setBestellungen={setBestellungen} liefConfig={liefConfig} ccIntern={ccIntern} showToast={showToast}/>}
        {tab==="wareneingang" && <WareneingangTab art={art} setArt={setArt} bestellungen={bestellungen} setBestellungen={setBestellungen} liefConfig={liefConfig} showToast={showToast}/>}
        {tab==="lieferanten"  && <LieferantenTab liefConfig={liefConfig} setLiefConfig={setLiefConfig} ccIntern={ccIntern} setCcIntern={setCcIntern} showToast={showToast}/>}
      </div>

      {/* MODALS */}
      {modal?.type==="kommissionierung" && <KommissionierModal auftrag={modal.data} art={art} setArt={setArt} auftraege={auftraege} setAuftraege={setAuftraege} showToast={showToast} onClose={()=>setModal(null)}/>}
      {modal?.type==="neuerAuftrag"     && <NeuerAuftragModal art={art} pakete={pakete} onSave={a=>{setAuftraege(p=>[a,...p]);setModal(null);showToast("Auftrag angelegt");}} onClose={()=>setModal(null)}/>}
      {modal?.type==="editAuftrag"      && <EditStuecklisteModal auftrag={modal.data} art={art} onSave={a=>{setAuftraege(p=>p.map(x=>x.id===a.id?a:x));setModal(null);showToast("StÃ¼ckliste gespeichert");}} onClose={()=>setModal(null)}/>}
      {modal?.type==="paketBuilder"     && <PaketBuilderModal paket={modal.data} art={art} onSave={p=>{if(modal.data)setPakete(pr=>pr.map(x=>x.id===p.id?p:x));else setPakete(pr=>[...pr,{...p,id:`PKT-${String(pr.length+1).padStart(3,"0")}`}]);setModal(null);showToast("Paket gespeichert");}} onDelete={id=>{setPakete(p=>p.filter(x=>x.id!==id));setModal(null);showToast("Paket gelÃ¶scht");}} onClose={()=>setModal(null)}/>}
      {modal?.type==="artikel"          && <ArtikelModal art2={modal.data} onSave={a=>{if(modal.data)setArt(p=>p.map(x=>x.id===a.id?a:x));else setArt(p=>[...p,a]);setModal(null);showToast("Artikel gespeichert");}} onClose={()=>setModal(null)}/>}

      {toast&&<div style={{position:"fixed",bottom:90,left:"50%",transform:"translateX(-50%)",background:toast.ok?`${OK}20`:`${ERR}20`,border:`1px solid ${toast.ok?OK:ERR}50`,color:toast.ok?OK:ERR,borderRadius:10,padding:"10px 18px",fontSize:13,fontWeight:600,zIndex:999,whiteSpace:"nowrap",boxShadow:"0 4px 20px #00000060"}}>{toast.ok?"âœ“":"!"} {toast.msg}</div>}
    </div>
  );
}

// â”€â”€ AUFTRÃ„GE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AuftraegeTab({auftraege,setAuftraege,art,pakete,setModal,showToast}){
  const [filter,setFilter]=useState("offen");

  // Sortierung nach Montagedatum
  const sorted=useMemo(()=>[...auftraege]
    .filter(a=>filter==="alle"||a.status!=="ausgegeben")
    .sort((a,b)=>new Date(a.montageDatum)-new Date(b.montageDatum))
  ,[auftraege,filter]);

  const heute=new Date();

  return (
    <div>
      {/* FILTER */}
      <div style={{display:"flex",gap:6,marginBottom:14}}>
        {["offen","alle"].map(f=>(
          <button key={f} onClick={()=>setFilter(f)} style={{padding:"5px 14px",borderRadius:20,border:`1px solid ${filter===f?Y:BR}`,background:filter===f?`${Y}15`:"transparent",color:filter===f?Y:TX2,fontSize:11,fontWeight:600,cursor:"pointer"}}>
            {f==="offen"?"Offene AuftrÃ¤ge":"Alle"}
          </button>
        ))}
      </div>

      {/* AUFTRAGS-KARTEN */}
      <div style={{display:"flex",flexDirection:"column",gap:10}}>
        {sorted.map(au=>{
          const st=getStuecklistenStatus(au.stueckliste,art);
          const ks=getKommStatus(au.stueckliste);
          const md=new Date(au.montageDatum);
          const tage=Math.round((md-heute)/(1000*60*60*24));
          const dringend=tage<=3&&tage>=0;
          const vergangen=tage<0;

          return (
            <div key={au.id} className="slide-up" style={{...CARD,borderColor:dringend?`${WARN}60`:vergangen?`${ERR}40`:BR,position:"relative",overflow:"hidden"}}>
              {/* Farbstreifen links */}
              <div style={{position:"absolute",left:0,top:0,bottom:0,width:4,background:st.color,borderRadius:"12px 0 0 12px"}}/>
              <div style={{paddingLeft:8}}>

                {/* HEADER */}
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                  <div>
                    <div style={{fontSize:10,color:TX2,marginBottom:2}}>{au.id} Â· {au.berater}</div>
                    <div style={{fontWeight:800,fontSize:14,color:TX}}>{au.kunde}</div>
                    <div style={{fontSize:11,color:TX2}}>ğŸ“ {au.adresse}</div>
                  </div>
                  <div style={{textAlign:"right",flexShrink:0,marginLeft:8}}>
                    <div style={{fontSize:11,fontWeight:700,color:dringend?WARN:vergangen?ERR:TX}}>
                      {vergangen?"ÃœberfÃ¤llig":dringend?`in ${tage}T`:`in ${tage}T`}
                    </div>
                    <div style={{fontSize:10,color:TX2}}>{md.toLocaleDateString("de-DE")}</div>
                  </div>
                </div>

                {/* SYSTEM + STATUS */}
                <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:10}}>
                  <span style={{background:`${PURPLE}15`,color:PURPLE,border:`1px solid ${PURPLE}30`,borderRadius:6,padding:"2px 8px",fontSize:10,fontWeight:600}}>âš¡ {au.system}</span>
                  <Badge color={st.color} label={st.label}/>
                  {au.status==="ausgegeben"&&<Badge color={OK} label="Ausgegeben"/>}
                </div>

                {/* FEHLTEILE */}
                {st.fehlen>0&&(
                  <div style={{background:`${ERR}10`,border:`1px solid ${ERR}30`,borderRadius:8,padding:"6px 10px",marginBottom:10,fontSize:11,color:ERR}}>
                    âœ• Fehlend: {st.fehlTeile.slice(0,3).join(", ")}{st.fehlTeile.length>3&&` +${st.fehlTeile.length-3}`}
                  </div>
                )}

                {/* KOMMISSIONIER-FORTSCHRITT */}
                <div style={{marginBottom:10}}>
                  <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                    <span style={{fontSize:10,color:TX2}}>Kommissionierung</span>
                    <span style={{fontSize:10,fontWeight:700,color:ks.color}}>{ks.label}</span>
                  </div>
                  <Bar v={ks.pct} max={100} color={ks.color}/>
                </div>

                {/* AKTIONEN */}
                <div style={{display:"flex",gap:8}}>
                  <button onClick={()=>setModal({type:"kommissionierung",data:au})} style={{flex:1,padding:"9px",borderRadius:8,border:"none",background:ks.pct===100?`${OK}20`:Y,color:ks.pct===100?OK:BG,fontWeight:700,fontSize:12,cursor:"pointer"}}>
                    {ks.pct===100?"âœ“ Ausgeben":"ğŸ“¦ Kommissionieren"}
                  </button>
                  <button onClick={()=>setModal({type:"editAuftrag",data:au})} style={{padding:"9px 12px",borderRadius:8,border:`1px solid ${BR}`,background:"transparent",color:TX2,fontSize:12,cursor:"pointer"}}>âœï¸</button>
                  <button onClick={()=>setModal({type:"kommissionierung",data:{...au,_qrOnly:true}})} style={{padding:"9px 12px",borderRadius:8,border:`1px solid ${BR}`,background:"transparent",color:TX2,fontSize:12,cursor:"pointer"}}>QR</button>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* NEUER AUFTRAG */}
      <button onClick={()=>setModal({type:"neuerAuftrag"})} style={{width:"100%",marginTop:14,padding:"13px",borderRadius:10,border:`1px dashed ${BR}`,background:"transparent",color:TX2,fontSize:12,fontWeight:600,cursor:"pointer"}}>
        + Neuen Auftrag / StÃ¼ckliste anlegen
      </button>
    </div>
  );
}

// â”€â”€ KOMMISSIONIER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function KommissionierModal({auftrag,art,setArt,auftraege,setAuftraege,showToast,onClose}){
  const [sl,setSl]=useState(auftrag.stueckliste.map(s=>({...s})));
  const [qrMode,setQrMode]=useState(auftrag._qrOnly||false);
  const [scan,setScan]=useState("");
  const ks=getKommStatus(sl);
  const fertig=ks.pct===100;

  function toggleKomm(idx){
    setSl(prev=>prev.map((s,i)=>i===idx?{...s,komm:!s.komm}:s));
  }
  function setSN(idx,v){
    setSl(prev=>prev.map((s,i)=>i===idx?{...s,sn:v}:s));
  }

  // Barcode/Artikel-ID Scan simulieren
  function handleScan(e){
    if(e.key==="Enter"&&scan){
      const idx=sl.findIndex(s=>s.aId===scan.toUpperCase());
      if(idx>=0){toggleKomm(idx);setScan("");showToast(`${getArt(sl[idx].aId,art)?.name} gescannt`);}
      else showToast(`Artikel ${scan} nicht in StÃ¼ckliste`,false);
      setScan("");
    }
  }

  function ausgeben(){
    // Bestand abbuchen
    setArt(prev=>prev.map(a=>{
      const pos=sl.find(s=>s.aId===a.id);
      return pos?{...a,bestand:a.bestand-pos.m}:a;
    }));
    setAuftraege(prev=>prev.map(a=>a.id===auftrag.id?{...a,status:"ausgegeben",stueckliste:sl}:a));
    showToast(`Auftrag ${auftrag.id} ausgegeben â€“ Bestand gebucht`);
    onClose();
  }

  if(qrMode){
    return (
      <div style={{position:"fixed",inset:0,background:"#00000095",zIndex:300,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
        <div style={{background:C1,borderRadius:"16px 16px 0 0",width:"100%",maxWidth:480,padding:24,border:`1px solid ${BR}`,textAlign:"center"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
            <div style={{fontWeight:800,fontSize:15}}>QR-Code Â· {auftrag.id}</div>
            <button onClick={onClose} style={{background:"none",border:"none",color:TX2,fontSize:22,cursor:"pointer"}}>âœ•</button>
          </div>
          <div style={{display:"inline-flex",padding:16,background:"#151d30",borderRadius:12,border:`1px solid ${BR}`,marginBottom:16}}>
            <QRCode value={`bee-doo|${auftrag.id}|${auftrag.kunde}|${auftrag.montageDatum}`} size={160}/>
          </div>
          <div style={{fontSize:13,fontWeight:700,color:TX,marginBottom:4}}>{auftrag.kunde}</div>
          <div style={{fontSize:11,color:TX2,marginBottom:4}}>{auftrag.system}</div>
          <div style={{fontSize:11,color:TX2}}>Montage: {new Date(auftrag.montageDatum).toLocaleDateString("de-DE")}</div>
          <button onClick={()=>setQrMode(false)} style={{width:"100%",marginTop:20,padding:"11px",borderRadius:10,border:`1px solid ${BR}`,background:"transparent",color:TX2,fontWeight:600,fontSize:13,cursor:"pointer"}}>Zur Kommissionierung</button>
        </div>
      </div>
    );
  }

  return (
    <div style={{position:"fixed",inset:0,background:"#00000095",zIndex:300,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
      <div style={{background:C1,borderRadius:"16px 16px 0 0",width:"100%",maxWidth:480,maxHeight:"92vh",overflowY:"auto",border:`1px solid ${BR}`}}>

        {/* STICKY HEADER IM MODAL */}
        <div style={{position:"sticky",top:0,background:C1,borderBottom:`1px solid ${BR}`,padding:"14px 16px",zIndex:10}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
            <div>
              <div style={{fontSize:10,color:TX2}}>{auftrag.id}</div>
              <div style={{fontWeight:800,fontSize:14}}>{auftrag.kunde}</div>
              <div style={{fontSize:11,color:TX2}}>âš¡ {auftrag.system} Â· {new Date(auftrag.montageDatum).toLocaleDateString("de-DE")}</div>
            </div>
            <div style={{display:"flex",gap:8,alignItems:"center"}}>
              <div style={{textAlign:"center"}}>
                <div style={{fontSize:20,fontWeight:800,color:ks.color}}>{ks.pct}%</div>
                <div style={{fontSize:9,color:TX2}}>komplett</div>
              </div>
              <button onClick={()=>setQrMode(true)} style={{padding:"6px 10px",borderRadius:8,border:`1px solid ${BR}`,background:"transparent",color:TX2,fontSize:11,cursor:"pointer"}}>QR</button>
              <button onClick={onClose} style={{background:"none",border:"none",color:TX2,fontSize:22,cursor:"pointer"}}>âœ•</button>
            </div>
          </div>
          <Bar v={ks.pct} max={100} color={ks.color}/>
        </div>

        <div style={{padding:"12px 16px"}}>
          {/* BARCODE SCAN */}
          <div style={{marginBottom:14}}>
            <input style={{...INPUT,background:`${Y}08`,border:`1px solid ${Y}30`}}
              value={scan} onChange={e=>setScan(e.target.value)} onKeyDown={handleScan}
              placeholder="ğŸ“· Artikel-ID scannen / eingeben + Enter"/>
          </div>

          {/* STÃœCKLISTE â€“ NACH QUELLE GRUPPIERT */}
          {["field","planung"].map(q=>{
            const pos=sl.map((s,i)=>({...s,idx:i})).filter(s=>s.quelle===q);
            if(pos.length===0) return null;
            return (
              <div key={q} style={{marginBottom:16}}>
                <div style={{fontSize:10,fontWeight:700,letterSpacing:"0.5px",color:q==="field"?BLUE:PURPLE,marginBottom:8}}>
                  {q==="field"?"âš¡ VOM BERATER GEWÃ„HLT":"ğŸ”§ VON PLANUNG ERGÃ„NZT"}
                </div>
                {pos.map(s=>{
                  const a=getArt(s.aId,art);
                  const verfÃ¼gbar=a&&a.bestand>=s.m;
                  return (
                    <div key={s.idx} onClick={()=>toggleKomm(s.idx)} style={{display:"flex",alignItems:"center",gap:10,marginBottom:8,background:s.komm?`${OK}08`:C2,border:`1px solid ${s.komm?OK+"40":BR}`,borderRadius:10,padding:"10px 12px",cursor:"pointer",transition:"all 0.15s"}}>
                      {/* CHECKBOX */}
                      <div style={{width:22,height:22,borderRadius:6,border:`2px solid ${s.komm?OK:BR}`,background:s.komm?OK:"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.15s"}}>
                        {s.komm&&<span style={{fontSize:12,color:BG,fontWeight:800}}>âœ“</span>}
                      </div>
                      <div style={{flex:1}}>
                        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                          <div style={{fontWeight:600,fontSize:12,color:s.komm?TX2:TX,textDecoration:s.komm?"line-through":"none"}}>{s.m}Ã— {a?.name||s.aId}</div>
                          {!verfÃ¼gbar&&<Badge color={ERR} label="Fehlt"/>}
                        </div>
                        <div style={{fontSize:10,color:TX2}}>Lager: {a?.bestand||0} {a?.einheit||""}</div>
                        {a?.sn&&s.komm&&(
                          <input
                            style={{...INPUT,fontSize:10,padding:"4px 8px",marginTop:4}}
                            value={s.sn} onChange={e=>{e.stopPropagation();setSN(s.idx,e.target.value);}}
                            onClick={e=>e.stopPropagation()}
                            placeholder="Seriennummer..."
                          />
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            );
          })}

          {/* AUSGEBEN BUTTON */}
          <button onClick={ausgeben} disabled={!fertig} style={{width:"100%",padding:"14px",borderRadius:10,border:"none",background:fertig?Y:BR,color:fertig?BG:TX2,fontWeight:700,fontSize:14,cursor:fertig?"pointer":"default",marginTop:8}}>
            {fertig?"âœ“ Auftrag ausgeben & Bestand buchen":"Alle Positionen abhaken zum Ausgeben"}
          </button>
          {!fertig&&<div style={{textAlign:"center",fontSize:11,color:TX2,marginTop:8}}>{sl.filter(s=>!s.komm).length} Positionen noch offen</div>}
        </div>
      </div>
    </div>
  );
}

// â”€â”€ NEUER AUFTRAG MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function NeuerAuftragModal({art,pakete,onSave,onClose}){
  const [kunde,setKunde]=useState("");
  const [adresse,setAdresse]=useState("");
  const [datum,setDatum]=useState("");
  const [berater,setBerater]=useState("");
  const [system,setSystem]=useState("");
  const [selPaket,setSelPaket]=useState("");
  const [sl,setSl]=useState([]);
  const [addId,setAddId]=useState(art[0]?.id||"");
  const [addM,setAddM]=useState(1);
  const [addQ,setAddQ]=useState("planung");

  function loadPaket(pid){
    setSelPaket(pid);
    const p=pakete.find(x=>x.id===pid);
    if(p){
      setSl(p.komp.map(k=>({aId:k.aId,m:k.m,quelle:"field",sn:"",komm:false})));
      setSystem(p.name);
    }
  }

  function addPos(){
    if(sl.find(s=>s.aId===addId)) setSl(p=>p.map(s=>s.aId===addId?{...s,m:s.m+addM}:s));
    else setSl(p=>[...p,{aId:addId,m:addM,quelle:addQ,sn:"",komm:false}]);
  }
  function removePos(id){setSl(p=>p.filter(s=>s.aId!==id));}

  const ok=kunde&&datum&&system&&sl.length>0;

  return (
    <div style={{position:"fixed",inset:0,background:"#00000095",zIndex:300,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
      <div style={{background:C1,borderRadius:"16px 16px 0 0",width:"100%",maxWidth:480,maxHeight:"92vh",overflowY:"auto",padding:20,border:`1px solid ${BR}`}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:18}}>
          <div style={{fontWeight:800,fontSize:16}}>Neuer Auftrag</div>
          <button onClick={onClose} style={{background:"none",border:"none",color:TX2,fontSize:22,cursor:"pointer"}}>âœ•</button>
        </div>

        {/* STAMMDATEN */}
        <div style={{display:"flex",flexDirection:"column",gap:10,marginBottom:16}}>
          <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Kunde *</label><input style={INPUT} value={kunde} onChange={e=>setKunde(e.target.value)} placeholder="Name, Vorname"/></div>
          <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Adresse</label><input style={INPUT} value={adresse} onChange={e=>setAdresse(e.target.value)} placeholder="StraÃŸe, PLZ Ort"/></div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Montagedatum *</label><input style={INPUT} type="date" value={datum} onChange={e=>setDatum(e.target.value)}/></div>
            <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Berater</label><input style={INPUT} value={berater} onChange={e=>setBerater(e.target.value)} placeholder="Name"/></div>
          </div>
          <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>System / Beschreibung *</label><input style={INPUT} value={system} onChange={e=>setSystem(e.target.value)} placeholder="z.B. Standard 8kW + Wallbox"/></div>
        </div>

        {/* PAKET ALS VORLAGE */}
        <div style={{marginBottom:16}}>
          <label style={{fontSize:11,color:TX2,display:"block",marginBottom:6,fontWeight:700}}>VORLAGE LADEN (optional)</label>
          <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
            {pakete.map(p=>(
              <button key={p.id} onClick={()=>loadPaket(p.id)} style={{padding:"6px 12px",borderRadius:8,border:`1px solid ${selPaket===p.id?p.farbe:BR}`,background:selPaket===p.id?`${p.farbe}15`:"transparent",color:selPaket===p.id?p.farbe:TX2,fontSize:11,fontWeight:600,cursor:"pointer"}}>
                {p.name}
              </button>
            ))}
          </div>
        </div>

        {/* STÃœCKLISTE */}
        <div style={{marginBottom:16}}>
          <label style={{fontSize:11,color:TX2,fontWeight:700,letterSpacing:"0.5px",display:"block",marginBottom:8}}>STÃœCKLISTE</label>
          {sl.map(s=>{
            const a=getArt(s.aId,art);
            return (
              <div key={s.aId} style={{display:"flex",alignItems:"center",gap:8,marginBottom:6,background:C2,borderRadius:8,padding:"8px 10px"}}>
                <div style={{width:6,height:6,borderRadius:"50%",flexShrink:0,background:s.quelle==="field"?BLUE:PURPLE}}/>
                <div style={{flex:1}}>
                  <div style={{fontSize:12,color:TX}}>{s.m}Ã— {a?.name||s.aId}</div>
                  <div style={{fontSize:10,color:TX2}}>{s.quelle==="field"?"Field":"Planung"}</div>
                </div>
                <button onClick={()=>removePos(s.aId)} style={{background:`${ERR}15`,border:"none",color:ERR,borderRadius:6,padding:"4px 8px",fontSize:12,cursor:"pointer"}}>âœ•</button>
              </div>
            );
          })}

          {/* POSITION HINZUFÃœGEN */}
          <div style={{background:C2,borderRadius:10,padding:10,marginTop:8}}>
            <div style={{fontSize:10,color:TX2,marginBottom:8,fontWeight:600}}>POSITION HINZUFÃœGEN</div>
            <select style={{...INPUT,appearance:"auto",marginBottom:8}} value={addId} onChange={e=>setAddId(e.target.value)}>
              {art.map(a=><option key={a.id} value={a.id}>{a.name} ({a.bestand} {a.einheit})</option>)}
            </select>
            <div style={{display:"flex",gap:8}}>
              <input style={{...INPUT,flex:"0 0 80px"}} type="number" min="1" value={addM} onChange={e=>setAddM(+e.target.value)} placeholder="Menge"/>
              <select style={{...INPUT,appearance:"auto",flex:1}} value={addQ} onChange={e=>setAddQ(e.target.value)}>
                <option value="field">Field (Berater)</option>
                <option value="planung">Planung</option>
              </select>
              <button onClick={addPos} style={{padding:"8px 14px",borderRadius:8,border:"none",background:Y,color:BG,fontWeight:700,cursor:"pointer"}}>+</button>
            </div>
          </div>
        </div>

        <button onClick={()=>ok&&onSave({id:`AU-${Date.now()}`,kunde,adresse,montageDatum:datum,berater,system,status:"offen",stueckliste:sl})} style={{width:"100%",padding:"13px",borderRadius:10,border:"none",background:ok?Y:BR,color:ok?BG:TX2,fontWeight:700,fontSize:14,cursor:ok?"pointer":"default"}}>
          âœ“ Auftrag anlegen
        </button>
      </div>
    </div>
  );
}

// â”€â”€ EDIT STÃœCKLISTE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function EditStuecklisteModal({auftrag,art,onSave,onClose}){
  const [sl,setSl]=useState(auftrag.stueckliste.map(s=>({...s})));
  const [addId,setAddId]=useState(art[0]?.id||"");
  const [addM,setAddM]=useState(1);
  const [addQ,setAddQ]=useState("planung");

  function addPos(){
    if(sl.find(s=>s.aId===addId)) setSl(p=>p.map(s=>s.aId===addId?{...s,m:s.m+addM}:s));
    else setSl(p=>[...p,{aId:addId,m:addM,quelle:addQ,sn:"",komm:false}]);
  }
  function setM(id,m){
    if(m<=0) setSl(p=>p.filter(s=>s.aId!==id));
    else setSl(p=>p.map(s=>s.aId===id?{...s,m}:s));
  }

  return (
    <div style={{position:"fixed",inset:0,background:"#00000095",zIndex:300,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
      <div style={{background:C1,borderRadius:"16px 16px 0 0",width:"100%",maxWidth:480,maxHeight:"92vh",overflowY:"auto",padding:20,border:`1px solid ${BR}`}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
          <div>
            <div style={{fontWeight:800,fontSize:15}}>StÃ¼ckliste bearbeiten</div>
            <div style={{fontSize:11,color:TX2}}>{auftrag.id} Â· {auftrag.kunde}</div>
          </div>
          <button onClick={onClose} style={{background:"none",border:"none",color:TX2,fontSize:22,cursor:"pointer"}}>âœ•</button>
        </div>

        <div style={{marginBottom:16}}>
          {["field","planung"].map(q=>{
            const pos=sl.map((s,i)=>({...s,i})).filter(s=>s.quelle===q);
            if(pos.length===0) return null;
            return (
              <div key={q} style={{marginBottom:12}}>
                <div style={{fontSize:10,fontWeight:700,color:q==="field"?BLUE:PURPLE,letterSpacing:"0.5px",marginBottom:6}}>
                  {q==="field"?"âš¡ FIELD":"ğŸ”§ PLANUNG"}
                </div>
                {pos.map(s=>{
                  const a=getArt(s.aId,art);
                  return (
                    <div key={s.aId} style={{display:"flex",alignItems:"center",gap:8,marginBottom:6,background:C2,borderRadius:8,padding:"8px 10px"}}>
                      <div style={{flex:1}}>
                        <div style={{fontSize:12,color:TX}}>{a?.name||s.aId}</div>
                        <div style={{fontSize:10,color:TX2}}>Lager: {a?.bestand} {a?.einheit}</div>
                      </div>
                      <div style={{display:"flex",alignItems:"center",gap:4}}>
                        <button onClick={()=>setM(s.aId,s.m-1)} style={{width:26,height:26,borderRadius:6,border:`1px solid ${BR}`,background:C1,color:TX,cursor:"pointer",fontSize:15}}>âˆ’</button>
                        <span style={{minWidth:24,textAlign:"center",fontWeight:700}}>{s.m}</span>
                        <button onClick={()=>setM(s.aId,s.m+1)} style={{width:26,height:26,borderRadius:6,border:`1px solid ${BR}`,background:C1,color:TX,cursor:"pointer",fontSize:15}}>+</button>
                        <button onClick={()=>setM(s.aId,0)} style={{width:26,height:26,borderRadius:6,border:"none",background:`${ERR}20`,color:ERR,cursor:"pointer",fontSize:12}}>âœ•</button>
                      </div>
                    </div>
                  );
                })}
              </div>
            );
          })}
        </div>

        {/* POSITION HINZUFÃœGEN */}
        <div style={{background:C2,borderRadius:10,padding:10,marginBottom:16}}>
          <div style={{fontSize:10,color:TX2,marginBottom:8,fontWeight:600}}>POSITION HINZUFÃœGEN</div>
          <select style={{...INPUT,appearance:"auto",marginBottom:8}} value={addId} onChange={e=>setAddId(e.target.value)}>
            {art.map(a=><option key={a.id} value={a.id}>{a.name} ({a.bestand} {a.einheit})</option>)}
          </select>
          <div style={{display:"flex",gap:8}}>
            <input style={{...INPUT,flex:"0 0 80px"}} type="number" min="1" value={addM} onChange={e=>setAddM(+e.target.value)}/>
            <select style={{...INPUT,appearance:"auto",flex:1}} value={addQ} onChange={e=>setAddQ(e.target.value)}>
              <option value="planung">Planung</option>
              <option value="field">Field</option>
            </select>
            <button onClick={addPos} style={{padding:"8px 14px",borderRadius:8,border:"none",background:Y,color:BG,fontWeight:700,cursor:"pointer"}}>+</button>
          </div>
        </div>

        <button onClick={()=>onSave({...auftrag,stueckliste:sl})} style={{width:"100%",padding:"13px",borderRadius:10,border:"none",background:Y,color:BG,fontWeight:700,fontSize:14,cursor:"pointer"}}>âœ“ StÃ¼ckliste speichern</button>
      </div>
    </div>
  );
}

// â”€â”€ BESTAND TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BestandTab({art,setArt,kritisch,setModal}){
  const [search,setSearch]=useState("");
  const [kat,setKat]=useState("Alle");
  const filtered=useMemo(()=>art.filter(a=>(kat==="Alle"||a.kat===kat)&&(a.name.toLowerCase().includes(search.toLowerCase())||a.id.includes(search.toUpperCase()))),[art,kat,search]);

  return (
    <div>
      {kritisch.length>0&&<div style={{background:`${WARN}12`,border:`1px solid ${WARN}30`,borderRadius:10,padding:"10px 14px",marginBottom:12}}><div style={{color:WARN,fontWeight:700,fontSize:12}}>âš ï¸ {kritisch.length} unter Mindestbestand</div><div style={{color:TX2,fontSize:11,marginTop:2}}>{kritisch.map(a=>a.name).join(" Â· ")}</div></div>}
      <input style={INPUT} placeholder="ğŸ”  Artikel suchen..." value={search} onChange={e=>setSearch(e.target.value)}/>
      <div style={{display:"flex",gap:6,overflowX:"auto",paddingBottom:4,marginTop:8,marginBottom:12}}>
        {KAT_LISTE.map(k=><button key={k} onClick={()=>setKat(k)} style={{padding:"5px 10px",borderRadius:20,border:`1px solid ${kat===k?Y:BR}`,background:kat===k?`${Y}15`:"transparent",color:kat===k?Y:TX2,fontSize:10,fontWeight:600,cursor:"pointer",whiteSpace:"nowrap"}}>{k}</button>)}
      </div>
      <div style={{display:"flex",flexDirection:"column",gap:8}}>
        {filtered.map(a=>(
          <div key={a.id} onClick={()=>setModal({type:"artikel",data:a})} style={{...CARD,cursor:"pointer"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
              <div style={{flex:1,marginRight:8}}>
                <div style={{fontSize:11,color:TX2,marginBottom:2}}>{a.id} Â· {a.kat}</div>
                <div style={{fontWeight:700,fontSize:13}}>{a.name}</div>
              </div>
              {a.bestand===0?<Badge color={ERR} label="Kein Bestand"/>:a.bestand<a.min?<Badge color={WARN} label="Nachbestellen"/>:<Badge color={OK} label="OK"/>}
            </div>
            <Bar v={a.bestand} max={Math.max(a.min*2,a.bestand)} color={a.bestand<a.min?WARN:OK}/>
            <div style={{display:"flex",justifyContent:"space-between",marginTop:8,alignItems:"center"}}>
              <div><span style={{fontWeight:800,fontSize:16,color:a.lief==="Elektriker"?TX2:a.bestand<a.min?WARN:TX}}>{a.lief==="Elektriker"?"â€”":a.bestand}</span><span style={{color:TX2,fontSize:11}}>{a.lief==="Elektriker"?" Elektriker vor Ort":` / ${a.min} Min Â· ${a.einheit}`}</span></div>
              <div style={{display:"flex",alignItems:"center",gap:6}}>
                {a.lief&&<span style={{fontSize:10,fontWeight:600,color:LIEFERANTEN[a.lief]?.farbe||TX2,background:`${LIEFERANTEN[a.lief]?.farbe||TX2}15`,border:`1px solid ${LIEFERANTEN[a.lief]?.farbe||TX2}30`,borderRadius:6,padding:"1px 7px"}}>{a.lief}</span>}
                <span style={{color:TX2,fontSize:11}}>â‚¬{a.preis.toFixed(2)}/{a.einheit}</span>
              </div>
            </div>
          </div>
        ))}
      </div>
      <button onClick={()=>setModal({type:"artikel",data:null})} style={{width:"100%",marginTop:12,padding:"12px",borderRadius:10,border:`1px dashed ${BR}`,background:"transparent",color:TX2,fontSize:12,fontWeight:600,cursor:"pointer"}}>+ Neuer Artikel</button>
    </div>
  );
}

// â”€â”€ PAKETE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PaketeTab({pakete,setPakete,art,setModal,showToast}){
  function getV(p){let m=Infinity;p.komp.forEach(k=>{const a=art.find(x=>x.id===k.aId);if(a)m=Math.min(m,Math.floor(a.bestand/k.m));});return m===Infinity?0:m;}
  return (
    <div>
      <div style={{fontSize:11,color:TX2,marginBottom:12}}>Paket-Vorlagen fÃ¼r StÃ¼cklisten-Erstellung</div>
      <div style={{display:"flex",flexDirection:"column",gap:10}}>
        {pakete.map(p=>{
          const v=getV(p);
          const pPreis=p.komp.reduce((s,k)=>{const a=art.find(x=>x.id===k.aId);return s+(a?.preis||0)*k.m;},0);
          return (
            <div key={p.id} style={{...CARD,borderColor:v>0?`${p.farbe}50`:BR}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
                <div style={{flex:1}}>
                  <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4}}><div style={{width:8,height:8,borderRadius:"50%",background:p.farbe}}/><span style={{fontSize:10,color:TX2}}>{p.id} Â· â‚¬{pPreis.toLocaleString("de-DE",{maximumFractionDigits:0})}/Stk</span></div>
                  <div style={{fontWeight:800,fontSize:14}}>{p.name}</div>
                  <div style={{fontSize:11,color:TX2}}>{p.beschreibung}</div>
                </div>
                <div style={{textAlign:"center",marginLeft:12,flexShrink:0}}>
                  <div style={{fontSize:28,fontWeight:800,color:v===0?ERR:v<3?WARN:OK,lineHeight:1}}>{v}</div>
                  <div style={{fontSize:9,color:TX2}}>mÃ¶glich</div>
                </div>
              </div>
              <div style={{borderTop:`1px solid ${BR}`,paddingTop:10}}>
                {p.komp.map((k,i)=>{const a=art.find(x=>x.id===k.aId);const vm=a?Math.floor(a.bestand/k.m):0;return(
                  <div key={i} style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                    <div style={{display:"flex",alignItems:"center",gap:6}}><div style={{width:5,height:5,borderRadius:"50%",background:vm===0?ERR:vm<3?WARN:OK}}/><span style={{fontSize:11,color:TX}}>{k.m}Ã— {a?.name||k.aId}</span></div>
                    <span style={{fontSize:11,color:TX2}}>{a?.bestand||0} Lager</span>
                  </div>
                );})}
              </div>
              <button onClick={()=>setModal({type:"paketBuilder",data:p})} style={{width:"100%",marginTop:10,padding:"8px",borderRadius:8,border:`1px solid ${BR}`,background:"transparent",color:TX2,fontSize:11,fontWeight:600,cursor:"pointer"}}>âœï¸ Bearbeiten</button>
            </div>
          );
        })}
      </div>
      <button onClick={()=>setModal({type:"paketBuilder",data:null})} style={{width:"100%",marginTop:12,padding:"13px",borderRadius:10,border:`1px dashed ${PURPLE}60`,background:`${PURPLE}08`,color:PURPLE,fontSize:13,fontWeight:700,cursor:"pointer"}}>+ Neues Paket</button>
    </div>
  );
}

// â”€â”€ PAKET BUILDER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PaketBuilderModal({paket,art,onSave,onDelete,onClose}){
  const [name,setName]=useState(paket?.name||"");
  const [beschr,setBeschr]=useState(paket?.beschreibung||"");
  const [farbe,setFarbe]=useState(paket?.farbe||BLUE);
  const [komp,setKomp]=useState(paket?.komp||[]);
  const [addId,setAddId]=useState(art[0]?.id||"");
  function add(){if(komp.find(k=>k.aId===addId))setKomp(p=>p.map(k=>k.aId===addId?{...k,m:k.m+1}:k));else setKomp(p=>[...p,{aId:addId,m:1}]);}
  function setM(id,m){if(m<=0)setKomp(p=>p.filter(k=>k.aId!==id));else setKomp(p=>p.map(k=>k.aId===id?{...k,m}:k));}
  const gp=komp.reduce((s,k)=>{const a=art.find(x=>x.id===k.aId);return s+(a?.preis||0)*k.m;},0);
  const ok=name&&komp.length>0;
  return (
    <div style={{position:"fixed",inset:0,background:"#00000095",zIndex:300,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
      <div style={{background:C1,borderRadius:"16px 16px 0 0",width:"100%",maxWidth:480,maxHeight:"92vh",overflowY:"auto",padding:20,border:`1px solid ${BR}`}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:16}}><div style={{fontWeight:800,fontSize:15}}>{paket?"Paket bearbeiten":"Neues Paket"}</div><button onClick={onClose} style={{background:"none",border:"none",color:TX2,fontSize:22,cursor:"pointer"}}>âœ•</button></div>
        <div style={{marginBottom:10}}><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Name *</label><input style={INPUT} value={name} onChange={e=>setName(e.target.value)} placeholder="z.B. Standard 8kW + 15kWh"/></div>
        <div style={{marginBottom:10}}><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Beschreibung</label><input style={INPUT} value={beschr} onChange={e=>setBeschr(e.target.value)}/></div>
        <div style={{marginBottom:14}}><label style={{fontSize:11,color:TX2,display:"block",marginBottom:6}}>Farbe</label><div style={{display:"flex",gap:8}}>{FARBEN.map(f=><div key={f} onClick={()=>setFarbe(f)} style={{width:28,height:28,borderRadius:"50%",background:f,cursor:"pointer",border:farbe===f?`3px solid ${TX}`:"3px solid transparent"}}/>)}</div></div>
        <div style={{marginBottom:14}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}><label style={{fontSize:11,color:TX2,fontWeight:700}}>KOMPONENTEN *</label>{komp.length>0&&<span style={{fontSize:11,color:TX2}}>â‚¬{gp.toLocaleString("de-DE",{maximumFractionDigits:0})}/Paket</span>}</div>
          {komp.map(k=>{const a=art.find(x=>x.id===k.aId);return(
            <div key={k.aId} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,background:C2,borderRadius:8,padding:"9px 10px"}}>
              <div style={{flex:1}}><div style={{fontSize:12,fontWeight:600}}>{a?.name||k.aId}</div><div style={{fontSize:10,color:TX2}}>Lager: {a?.bestand} {a?.einheit}</div></div>
              <div style={{display:"flex",alignItems:"center",gap:4}}>
                <button onClick={()=>setM(k.aId,k.m-1)} style={{width:28,height:28,borderRadius:6,border:`1px solid ${BR}`,background:C1,color:TX,cursor:"pointer",fontSize:16}}>âˆ’</button>
                <span style={{fontSize:15,fontWeight:700,minWidth:22,textAlign:"center"}}>{k.m}</span>
                <button onClick={()=>setM(k.aId,k.m+1)} style={{width:28,height:28,borderRadius:6,border:`1px solid ${BR}`,background:C1,color:TX,cursor:"pointer",fontSize:16}}>+</button>
                <button onClick={()=>setM(k.aId,0)} style={{width:28,height:28,borderRadius:6,border:"none",background:`${ERR}20`,color:ERR,cursor:"pointer",fontSize:12}}>âœ•</button>
              </div>
            </div>
          );})}
          <div style={{display:"flex",gap:8,marginTop:8}}>
            <select style={{...INPUT,flex:1,appearance:"auto"}} value={addId} onChange={e=>setAddId(e.target.value)}>{art.map(a=><option key={a.id} value={a.id}>{a.name} ({a.bestand} {a.einheit})</option>)}</select>
            <button onClick={add} style={{padding:"8px 14px",borderRadius:8,border:"none",background:Y,color:BG,fontWeight:700,cursor:"pointer"}}>+ Add</button>
          </div>
        </div>
        <button onClick={()=>ok&&onSave({id:paket?.id,name,beschreibung:beschr,farbe,komp})} style={{width:"100%",padding:"13px",borderRadius:10,border:"none",background:ok?Y:BR,color:ok?BG:TX2,fontWeight:700,fontSize:14,cursor:ok?"pointer":"default",marginBottom:8}}>âœ“ Speichern</button>
        {paket&&<button onClick={()=>{if(window.confirm("Paket lÃ¶schen?"))onDelete(paket.id);}} style={{width:"100%",padding:"10px",borderRadius:10,border:`1px solid ${ERR}40`,background:"transparent",color:ERR,fontWeight:600,fontSize:13,cursor:"pointer"}}>ğŸ—‘ LÃ¶schen</button>}
      </div>
    </div>
  );
}

// â”€â”€ ARTIKEL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ArtikelModal({art2,onSave,onClose}){
  const [f,setF]=useState(art2||{id:"",name:"",kat:"Wechselrichter",bestand:0,min:5,einheit:"Stk",preis:0,sn:false,lief:"Fox"});
  const upd=(k,v)=>setF(p=>({...p,[k]:v}));
  const ok=f.id&&f.name;
  return (
    <div style={{position:"fixed",inset:0,background:"#00000095",zIndex:300,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
      <div style={{background:C1,borderRadius:"16px 16px 0 0",width:"100%",maxWidth:480,maxHeight:"85vh",overflowY:"auto",padding:20,border:`1px solid ${BR}`}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:16}}><div style={{fontWeight:800,fontSize:15}}>{art2?"Artikel bearbeiten":"Neuer Artikel"}</div><button onClick={onClose} style={{background:"none",border:"none",color:TX2,fontSize:22,cursor:"pointer"}}>âœ•</button></div>
        <div style={{display:"flex",flexDirection:"column",gap:10}}>
          <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Artikel-ID *</label><input style={INPUT} value={f.id} onChange={e=>upd("id",e.target.value)} placeholder="z.B. WR-80"/></div>
          <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Bezeichnung *</label><input style={INPUT} value={f.name} onChange={e=>upd("name",e.target.value)}/></div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Kategorie</label><select style={{...INPUT,appearance:"auto"}} value={f.kat} onChange={e=>upd("kat",e.target.value)}>{KAT_LISTE.filter(k=>k!=="Alle").map(k=><option key={k}>{k}</option>)}</select></div>
            <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Lieferant</label><select style={{...INPUT,appearance:"auto"}} value={f.lief||""} onChange={e=>upd("lief",e.target.value)}>{Object.keys(LIEFERANTEN).map(l=><option key={l}>{l}</option>)}</select></div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}}>
            <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Einheit</label><select style={{...INPUT,appearance:"auto"}} value={f.einheit} onChange={e=>upd("einheit",e.target.value)}>{["Stk","m","Paar","Rolle","Box"].map(u=><option key={u}>{u}</option>)}</select></div>
            <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Bestand</label><input style={INPUT} type="number" value={f.bestand} onChange={e=>upd("bestand",+e.target.value)}/></div>
            <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Minimum</label><input style={INPUT} type="number" value={f.min} onChange={e=>upd("min",+e.target.value)}/></div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div><label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Preis â‚¬</label><input style={INPUT} type="number" step="0.01" value={f.preis} onChange={e=>upd("preis",+e.target.value)}/></div>
            <div style={{display:"flex",alignItems:"flex-end",paddingBottom:2}}><div style={{display:"flex",alignItems:"center",gap:8}}><input type="checkbox" id="sn4" checked={f.sn} onChange={e=>upd("sn",e.target.checked)}/><label htmlFor="sn4" style={{fontSize:12,color:TX,cursor:"pointer"}}>Seriennummern erfassen</label></div></div>
          </div>
          <button onClick={()=>ok&&onSave(f)} style={{width:"100%",padding:"12px",borderRadius:10,border:"none",background:ok?Y:BR,color:ok?BG:TX2,fontWeight:700,fontSize:14,cursor:ok?"pointer":"default",marginTop:4}}>âœ“ {art2?"Speichern":"Anlegen"}</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ BESTELLEN TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BestellenTab({art,setArt,kritisch,bestellungen,setBestellungen,liefConfig,ccIntern,showToast}){
  const [collapsed,setCollapsed]=useState({});
  const [sending,setSending]=useState({});

  const bestellbar=kritisch.filter(a=>a.lief&&a.lief!=="Elektriker");
  const nachLief=useMemo(()=>{
    const g={};
    bestellbar.forEach(a=>{if(!g[a.lief])g[a.lief]=[];g[a.lief].push(a);});
    return g;
  },[bestellbar]);

  async function sendeBestellung(lief,items){
    const l=liefConfig[lief];
    if(!l?.email){showToast("Keine E-Mail fÃ¼r "+lief+" hinterlegt",false);return;}
    setSending(p=>({...p,[lief]:true}));

    const zeilen=items.map(a=>`â€¢ ${a.min*2}x ${a.name} (Artikel-Nr: ${a.id})`).join("\n");
    const summe=items.reduce((s,a)=>s+a.min*2*a.preis,0);
    const datum=new Date().toLocaleDateString("de-DE");
    const betreff=`Bestellung bee-doo GmbH â€“ ${datum} â€“ ${lief}`;
    const text=`Sehr geehrte Damen und Herren,\n\nhiermit bestellen wir folgende Artikel:\n\n${zeilen}\n\nGesamtwert ca.: â‚¬${summe.toLocaleString("de-DE",{maximumFractionDigits:0})}\n\nBitte liefern Sie an:\nbee-doo GmbH / Tritec Lager\nBielefeld\n\nMit freundlichen GrÃ¼ÃŸen\nbee-doo GmbH`;

    try{
      const res=await fetch("https://api.brevo.com/v3/smtp/email",{
        method:"POST",
        headers:{"accept":"application/json","api-key":BREVO_KEY,"content-type":"application/json"},
        body:JSON.stringify({
          sender:{name:"bee-doo Lager",email:"lager@bee-doo.de"},
          to:[{email:l.email,name:lief}],
          cc:[{email:ccIntern,name:"bee-doo intern"}],
          subject:betreff,
          textContent:text,
        })
      });
      if(res.ok){
        const neu=items.map(a=>({id:`B-${Date.now()}-${a.id}`,artId:a.id,name:a.name,lief,menge:a.min*2,einheit:a.einheit,preis:a.preis,datum,status:"bestellt",emailSent:true}));
        setBestellungen(p=>[...neu,...p]);
        showToast(`Bestellung an ${lief} gesendet âœ‰`);
      } else {
        showToast("E-Mail Fehler: "+res.status,false);
      }
    } catch(e){
      showToast("Netzwerkfehler",false);
    }
    setSending(p=>({...p,[lief]:false}));
  }

  function bestelleOhneEmail(lief,items){
    const neu=items.map(a=>({id:`B-${Date.now()}-${a.id}`,artId:a.id,name:a.name,lief,menge:a.min*2,einheit:a.einheit,preis:a.preis,datum:new Date().toLocaleDateString("de-DE"),status:"bestellt",emailSent:false}));
    setBestellungen(p=>[...neu,...p]);
    showToast(`${items.length} Artikel bei ${lief} vorgemerkt`);
  }

  const bereitsBestellteIds=new Set(bestellungen.filter(b=>b.status==="bestellt").map(b=>b.artId));

  return (
    <div>
      {Object.keys(nachLief).length>0?(
        <div style={{marginBottom:20}}>
          <div style={{fontSize:10,color:WARN,fontWeight:700,letterSpacing:"0.5px",marginBottom:10}}>âš ï¸ NACHBESTELL-VORSCHLÃ„GE</div>
          {Object.entries(nachLief).map(([lief,items])=>{
            const l=liefConfig[lief];
            const gesamtWert=items.reduce((s,a)=>s+a.min*2*a.preis,0);
            const isOpen=!collapsed[lief];
            const hatEmail=!!l?.email;
            const alleSchonBestellt=items.every(a=>bereitsBestellteIds.has(a.id));
            return (
              <div key={lief} style={{...CARD,marginBottom:10,borderColor:`${l?.farbe||WARN}50`}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:isOpen?10:0}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <div style={{width:10,height:10,borderRadius:"50%",background:l?.farbe||WARN}}/>
                    <div>
                      <div style={{fontWeight:800,fontSize:14}}>{lief}</div>
                      <div style={{fontSize:10,color:TX2}}>{items.length} Artikel Â· ca. â‚¬{gesamtWert.toLocaleString("de-DE",{maximumFractionDigits:0})}</div>
                      {hatEmail?<div style={{fontSize:10,color:TX2}}>âœ‰ {l.email}</div>:<div style={{fontSize:10,color:ERR}}>âš  Keine E-Mail hinterlegt</div>}
                    </div>
                  </div>
                  <div style={{display:"flex",gap:6,flexShrink:0}}>
                    {!alleSchonBestellt&&(
                      <button
                        onClick={()=>hatEmail?sendeBestellung(lief,items):bestelleOhneEmail(lief,items)}
                        disabled={sending[lief]}
                        style={{background:hatEmail?l?.farbe||Y:"transparent",border:hatEmail?"none":`1px solid ${l?.farbe||Y}`,color:hatEmail?BG:l?.farbe||Y,borderRadius:8,padding:"7px 10px",fontSize:11,fontWeight:700,cursor:"pointer",opacity:sending[lief]?0.6:1}}
                      >{sending[lief]?"...":hatEmail?"âœ‰ Bestellen":"Vormerken"}</button>
                    )}
                    {alleSchonBestellt&&<Badge color={OK} label="Bestellt"/>}
                    <button onClick={()=>setCollapsed(p=>({...p,[lief]:!p[lief]}))} style={{background:"transparent",border:`1px solid ${BR}`,color:TX2,borderRadius:8,padding:"7px 10px",fontSize:11,cursor:"pointer"}}>{isOpen?"â–²":"â–¼"}</button>
                  </div>
                </div>
                {isOpen&&items.map(a=>(
                  <div key={a.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",background:C2,borderRadius:8,padding:"8px 10px",marginBottom:6,opacity:bereitsBestellteIds.has(a.id)?0.5:1}}>
                    <div>
                      <div style={{fontWeight:600,fontSize:12}}>{a.name}</div>
                      <div style={{fontSize:11,color:TX2}}>Bestand: {a.bestand} Â· Min: {a.min} Â· Vorschlag: {a.min*2} {a.einheit}</div>
                      <div style={{fontSize:11,color:TX2}}>ca. â‚¬{(a.min*2*a.preis).toLocaleString("de-DE",{maximumFractionDigits:0})}</div>
                    </div>
                    {bereitsBestellteIds.has(a.id)?<Badge color={OK} label="Bestellt"/>:null}
                  </div>
                ))}
              </div>
            );
          })}
        </div>
      ):(
        <div style={{textAlign:"center",padding:"30px 20px",color:TX2}}>
          <div style={{fontSize:36,marginBottom:8}}>âœ…</div>
          <div style={{fontSize:14,fontWeight:600,color:OK}}>Alles im grÃ¼nen Bereich</div>
          <div style={{fontSize:12,marginTop:4}}>Kein Artikel unter Mindestbestand</div>
        </div>
      )}
      {kritisch.filter(a=>a.lief==="Elektriker").length>0&&(
        <div style={{background:`${TX2}10`,border:`1px solid ${TX2}30`,borderRadius:10,padding:"10px 14px",marginBottom:12}}>
          <div style={{fontSize:11,color:TX2,fontWeight:600}}>ğŸ”§ Kabel & Verbinder â†’ Elektriker vor Ort</div>
        </div>
      )}
    </div>
  );
}

// â”€â”€ WARENEINGANG TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function WareneingangTab({art,setArt,bestellungen,setBestellungen,liefConfig,showToast}){
  const [selected,setSelected]=useState(null); // bestellung id
  const [eingangDatum,setEingangDatum]=useState(new Date().toISOString().split("T")[0]);
  const [mengen,setMengen]=useState({});
  const [filter,setFilter]=useState("offen");

  const offene=bestellungen.filter(b=>b.status==="bestellt");
  const geliefert=bestellungen.filter(b=>b.status==="geliefert");

  // Gruppiert nach Lieferant
  const offeneNachLief=useMemo(()=>{
    const g={};
    offene.forEach(b=>{if(!g[b.lief])g[b.lief]=[];g[b.lief].push(b);});
    return g;
  },[offene]);

  function starteEingang(b){
    setSelected(b.id);
    setMengen({[b.id]:b.menge});
  }

  function buchEin(b){
    const menge=parseInt(mengen[b.id])||b.menge;
    setArt(prev=>prev.map(a=>a.id===b.artId?{...a,bestand:a.bestand+menge}:a));
    setBestellungen(prev=>prev.map(x=>x.id===b.id?{...x,status:"geliefert",eingangMenge:menge,eingangDatum}:x));
    setSelected(null);
    showToast(`${menge}Ã— ${b.name} eingebucht â€“ Bestand aktualisiert`);
  }

  const l=(lief)=>liefConfig[lief];

  return (
    <div>
      {/* SUB-FILTER */}
      <div style={{display:"flex",gap:6,marginBottom:14}}>
        {[["offen","Offene Bestellungen"],["geliefert","Wareneingang"]].map(([v,label])=>(
          <button key={v} onClick={()=>setFilter(v)} style={{padding:"5px 14px",borderRadius:20,border:`1px solid ${filter===v?Y:BR}`,background:filter===v?`${Y}15`:"transparent",color:filter===v?Y:TX2,fontSize:11,fontWeight:600,cursor:"pointer"}}>{label}</button>
        ))}
      </div>

      {filter==="offen"&&(
        <>
          {offene.length===0?(
            <div style={{textAlign:"center",padding:"40px 20px",color:TX2}}>
              <div style={{fontSize:32,marginBottom:8}}>ğŸ“­</div>
              <div style={{fontSize:13,fontWeight:600}}>Keine offenen Bestellungen</div>
            </div>
          ):(
            <>
              <div style={{marginBottom:14}}>
                <label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Wareneingangsdatum</label>
                <input style={INPUT} type="date" value={eingangDatum} onChange={e=>setEingangDatum(e.target.value)}/>
              </div>
              {Object.entries(offeneNachLief).map(([lief,items])=>(
                <div key={lief} style={{...CARD,marginBottom:12,borderColor:`${l(lief)?.farbe||OK}50`}}>
                  <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10}}>
                    <div style={{width:10,height:10,borderRadius:"50%",background:l(lief)?.farbe||OK}}/>
                    <div>
                      <div style={{fontWeight:800,fontSize:14}}>{lief}</div>
                      <div style={{fontSize:10,color:TX2}}>{items.length} Positionen offen Â· bestellt {items[0].datum}</div>
                    </div>
                  </div>
                  {items.map(b=>(
                    <div key={b.id} style={{background:C2,borderRadius:8,padding:"10px 12px",marginBottom:6}}>
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:selected===b.id?8:0}}>
                        <div>
                          <div style={{fontWeight:600,fontSize:12}}>{b.name}</div>
                          <div style={{fontSize:11,color:TX2}}>Bestellt: {b.menge} {b.einheit} Â· {b.datum}</div>
                          {b.emailSent&&<div style={{fontSize:10,color:OK}}>âœ‰ Bestellung wurde per E-Mail gesendet</div>}
                        </div>
                        {selected!==b.id?(
                          <button onClick={()=>starteEingang(b)} style={{background:OK,border:"none",color:BG,borderRadius:8,padding:"7px 12px",fontSize:11,fontWeight:700,cursor:"pointer"}}>Einbuchen</button>
                        ):(
                          <button onClick={()=>setSelected(null)} style={{background:"transparent",border:`1px solid ${BR}`,color:TX2,borderRadius:8,padding:"7px 10px",fontSize:11,cursor:"pointer"}}>âœ•</button>
                        )}
                      </div>
                      {selected===b.id&&(
                        <div>
                          <div style={{display:"flex",gap:8,alignItems:"center"}}>
                            <div style={{flex:1}}>
                              <label style={{fontSize:10,color:TX2,display:"block",marginBottom:3}}>TatsÃ¤chlich gelieferte Menge</label>
                              <input style={INPUT} type="number" value={mengen[b.id]||b.menge} onChange={e=>setMengen(p=>({...p,[b.id]:e.target.value}))}/>
                            </div>
                            <button onClick={()=>buchEin(b)} style={{marginTop:18,padding:"9px 16px",borderRadius:8,border:"none",background:OK,color:BG,fontWeight:700,fontSize:12,cursor:"pointer",whiteSpace:"nowrap"}}>âœ“ Einbuchen</button>
                          </div>
                          <div style={{fontSize:10,color:TX2,marginTop:6}}>Datum: {new Date(eingangDatum).toLocaleDateString("de-DE")}</div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              ))}
            </>
          )}
        </>
      )}

      {filter==="geliefert"&&(
        <div>
          {geliefert.length===0?(
            <div style={{textAlign:"center",padding:"40px 20px",color:TX2}}>
              <div style={{fontSize:32,marginBottom:8}}>ğŸ“‹</div>
              <div style={{fontSize:13,fontWeight:600}}>Noch keine EingÃ¤nge gebucht</div>
            </div>
          ):(
            geliefert.map(b=>{
              const lc=liefConfig[b.lief];
              return (
                <div key={b.id} style={{...CARD,marginBottom:8,opacity:0.75}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                    <div>
                      <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:2}}>
                        <div style={{width:7,height:7,borderRadius:"50%",background:lc?.farbe||OK}}/>
                        <span style={{fontSize:10,color:TX2}}>{b.lief}</span>
                      </div>
                      <div style={{fontWeight:600,fontSize:12}}>{b.name}</div>
                      <div style={{fontSize:11,color:TX2}}>ğŸ“¦ {b.eingangMenge||b.menge} {b.einheit} Â· Eingang: {b.eingangDatum||b.datum}</div>
                      <div style={{fontSize:10,color:TX2}}>Bestellt: {b.datum}</div>
                    </div>
                    <Badge color={OK} label="Geliefert"/>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}
    </div>
  );
}

// â”€â”€ LIEFERANTEN TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LieferantenTab({liefConfig,setLiefConfig,ccIntern,setCcIntern,showToast}){
  const [editing,setEditing]=useState(null);
  const [editData,setEditData]=useState({});

  function startEdit(name){
    setEditing(name);
    setEditData({...liefConfig[name]});
  }
  function saveEdit(){
    setLiefConfig(p=>({...p,[editing]:{...p[editing],...editData}}));
    setEditing(null);
    showToast("Lieferant gespeichert");
  }

  return (
    <div>
      {/* CC INTERN */}
      <div style={{...CARD,marginBottom:14}}>
        <div style={{fontSize:11,color:TX2,marginBottom:4,fontWeight:600}}>CC INTERNE E-MAIL (alle Bestellungen)</div>
        <div style={{display:"flex",gap:8}}>
          <input style={{...INPUT,flex:1}} value={ccIntern} onChange={e=>setCcIntern(e.target.value)} placeholder="lager@bee-doo.de"/>
          <button onClick={()=>showToast("CC gespeichert")} style={{padding:"8px 14px",borderRadius:8,border:"none",background:Y,color:BG,fontWeight:700,fontSize:12,cursor:"pointer"}}>âœ“</button>
        </div>
      </div>

      <div style={{fontSize:10,color:TX2,fontWeight:700,letterSpacing:"0.5px",marginBottom:8}}>LIEFERANTEN & E-MAIL-ADRESSEN</div>

      {Object.entries(liefConfig).filter(([n])=>n!=="Elektriker").map(([name,l])=>(
        <div key={name} style={{...CARD,marginBottom:8,borderColor:`${l.farbe}40`}}>
          {editing===name?(
            <div>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10}}>
                <div style={{width:10,height:10,borderRadius:"50%",background:l.farbe}}/>
                <span style={{fontWeight:800,fontSize:14}}>{name}</span>
              </div>
              <div style={{marginBottom:8}}>
                <label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>E-Mail Bestellung</label>
                <input style={INPUT} value={editData.email||""} onChange={e=>setEditData(p=>({...p,email:e.target.value}))} placeholder="bestellung@lieferant.de"/>
              </div>
              <div style={{marginBottom:10}}>
                <label style={{fontSize:11,color:TX2,display:"block",marginBottom:4}}>Info / Sortiment</label>
                <input style={INPUT} value={editData.info||""} onChange={e=>setEditData(p=>({...p,info:e.target.value}))}/>
              </div>
              <div style={{display:"flex",gap:8}}>
                <button onClick={saveEdit} style={{flex:1,padding:"9px",borderRadius:8,border:"none",background:Y,color:BG,fontWeight:700,fontSize:12,cursor:"pointer"}}>âœ“ Speichern</button>
                <button onClick={()=>setEditing(null)} style={{padding:"9px 14px",borderRadius:8,border:`1px solid ${BR}`,background:"transparent",color:TX2,fontSize:12,cursor:"pointer"}}>Abbrechen</button>
              </div>
            </div>
          ):(
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:3}}>
                  <div style={{width:10,height:10,borderRadius:"50%",background:l.farbe}}/>
                  <span style={{fontWeight:800,fontSize:14}}>{name}</span>
                </div>
                <div style={{fontSize:11,color:TX2}}>{l.info}</div>
                {l.email?<div style={{fontSize:11,color:OK,marginTop:2}}>âœ‰ {l.email}</div>:<div style={{fontSize:11,color:ERR,marginTop:2}}>âš  Keine E-Mail hinterlegt</div>}
              </div>
              <button onClick={()=>startEdit(name)} style={{padding:"7px 12px",borderRadius:8,border:`1px solid ${BR}`,background:"transparent",color:TX2,fontSize:11,cursor:"pointer"}}>âœï¸</button>
            </div>
          )}
        </div>
      ))}
    </div>
  );
}



// â”€â”€ PROGNOSE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SB_URL_P="https://hqzpemfaljxcysyqssng.supabase.co";
const SB_KEY_P=window.BEEDOO_SVC||"";

// Materialberechnung aus kWp (basierend auf pv_pakete Katalog)
function calcMaterial(kwp){
  // Aiko 470W Module (0.47 kWp pro Modul)
  const module=Math.round(kwp/0.47);
  // WR nach kWp Stufen (Fox Smart/Pro)
  const wr=kwp<=10.34?"Fox Smart 12":kwp<=14.1?"Fox Smart 12":kwp<=18.8?"Fox Smart 15":kwp<=22.56?"Fox Pro 20":"Fox Pro 25";
  // Akku: 6.4 kWh bis 10.34 kWp, 9.84 kWh darÃ¼ber
  const akku_kwh=kwp<=10.34?6.4:9.84;
  // UK: ~2.5m Profil + 1.25 Haken + 2 Klemmen pro Modul (SL RACK Faustregel)
  const uk_profil=Math.round(module*2.5);
  const uk_haken=Math.round(module*1.25);
  const uk_klemme=Math.round(module*2);
  return {module,wr,akku_kwh,uk_profil,uk_haken,uk_klemme};
}

function PrognoseTab({art,showToast}){
  const [auftraege,setAuftraege]=useState([]);
  const [pakete,setPakete]=useState([]);
  const [loading,setLoading]=useState(true);
  const [szenario,setSzenario]=useState("base");
  const [woche,setWoche]=useState(0); // 0=alle 4 Wochen, 1-4=einzelne Woche
  const [stornoRate,setStornoRate]=useState(15); // % Stornorisiko

  useEffect(()=>{
    async function load(){
      setLoading(true);
      try{
        const headers={"apikey":SB_KEY_P,"Authorization":"Bearer "+SB_KEY_P};
        const [auftrRes,paketRes]=await Promise.all([
          fetch(`${SB_URL_P}/rest/v1/pay_auftraege?storniert=eq.false&select=auftrag_nr,erstellt_am,montage_datum,kwp,speichererweiterung,zahlungsstatus&limit=500`,{headers}),
          fetch(`${SB_URL_P}/rest/v1/pv_pakete?aktiv=eq.true&select=kwp,platten,akku_kwh,wechselrichter&limit=100`,{headers}),
        ]);
        const [auftrData,paketData]=await Promise.all([auftrRes.json(),paketRes.json()]);
        setAuftraege(Array.isArray(auftrData)?auftrData:[]);
        setPakete(Array.isArray(paketData)?paketData:[]);
      }catch(e){console.error(e);}
      setLoading(false);
    }
    load();
  },[]);

  const heute=new Date("2026-02-22");

  // Pipeline-Logik:
  // 1. AuftrÃ¤ge ohne Montage-Datum + erstellt_am < 14 Tage â†’ noch in Widerrufsfrist
  // 2. AuftrÃ¤ge ohne Montage-Datum + erstellt_am >= 14 Tage â†’ werden terminiert, dann 4 Wochen Fenster
  // 3. AuftrÃ¤ge mit Montage-Datum â†’ konkret geplant

  const pipeline=useMemo(()=>{
    const result=[];
    auftraege.forEach(a=>{
      const erstellt=a.erstellt_am?new Date(a.erstellt_am):null;
      const montage=a.montage_datum?new Date(a.montage_datum):null;
      const tageSeit=erstellt?Math.floor((heute-erstellt)/(1000*60*60*24)):0;
      const widerrufVorbei=tageSeit>=14;
      const kwp=parseFloat(a.kwp)||11.1; // Fallback auf Durchschnitt

      let wocheNr=null; // 1-4 = in welcher der nÃ¤chsten 4 Wochen gebaut

      if(montage){
        const tage=Math.floor((montage-heute)/(1000*60*60*24));
        if(tage>=0&&tage<=28) wocheNr=Math.min(4,Math.ceil((tage+1)/7));
      } else if(widerrufVorbei){
        // Wird terminiert â†’ gleichmÃ¤ÃŸig Ã¼ber die nÃ¤chsten 4 Wochen verteilen
        // Ã„lteste AuftrÃ¤ge zuerst (Woche 1), neuere spÃ¤ter
        const idx=result.filter(r=>!r.montage&&r.widerrufVorbei).length;
        wocheNr=(idx%4)+1;
      }

      result.push({...a,kwp,tageSeit,widerrufVorbei,montageKonkret:!!montage,wocheNr});
    });
    return result;
  },[auftraege]);

  // Szenarien-Faktoren
  const szFaktoren={pessimistisch:0.70,base:1.0,optimistisch:1.25};
  const factor=szFaktoren[szenario];
  const stornoFactor=1-(stornoRate/100);

  // Materialberechnung pro Woche
  const wochenDaten=useMemo(()=>{
    const wochen=[1,2,3,4].map(w=>{
      const auftr=pipeline.filter(a=>a.wocheNr===w);
      const anzahl=Math.round(auftr.length*factor*stornoFactor);
      const kwpGesamt=auftr.reduce((s,a)=>s+a.kwp,0)*factor*stornoFactor;
      const avgKwp=auftr.length>0?kwpGesamt/Math.max(anzahl,1):11.1;

      // Material summieren
      let mat={module:0,wr_smart12:0,wr_smart15:0,wr_pro20:0,wr_pro25:0,akku_64:0,akku_984:0,uk_profil:0,uk_haken:0,uk_klemme:0,zs3p:0};
      const n=Math.max(0,Math.round(auftr.length*factor*stornoFactor));
      for(let i=0;i<n;i++){
        const kwp=auftr[i%Math.max(auftr.length,1)]?.kwp||11.1;
        const m=calcMaterial(kwp);
        mat.module+=m.module;
        if(m.wr.includes("Smart 12"))mat.wr_smart12++;
        else if(m.wr.includes("Smart 15"))mat.wr_smart15++;
        else if(m.wr.includes("Pro 20"))mat.wr_pro20++;
        else mat.wr_pro25++;
        if(m.akku_kwh<=6.4)mat.akku_64++;else mat.akku_984++;
        mat.uk_profil+=m.uk_profil;
        mat.uk_haken+=m.uk_haken;
        mat.uk_klemme+=m.uk_klemme;
        mat.zs3p++; // immer 3-phasig
      }
      return {woche:w,auftraege:auftr,anzahl,kwpGesamt:Math.round(kwpGesamt),avgKwp:Math.round(avgKwp*10)/10,mat};
    });
    return wochen;
  },[pipeline,factor,stornoFactor]);

  // 4-Wochen Gesamt
  const gesamt=useMemo(()=>{
    const g={module:0,wr_smart12:0,wr_smart15:0,wr_pro20:0,wr_pro25:0,akku_64:0,akku_984:0,uk_profil:0,uk_haken:0,uk_klemme:0,zs3p:0,anzahl:0,kwp:0};
    wochenDaten.forEach(w=>{
      g.anzahl+=w.anzahl;g.kwp+=w.kwpGesamt;
      Object.keys(w.mat).forEach(k=>g[k]=(g[k]||0)+w.mat[k]);
    });
    return g;
  },[wochenDaten]);

  // Lager-Abgleich
  function getStock(artId){return art.find(a=>a.id===artId)?.bestand||0;}
  function getAmpel(bedarf,bestand){
    if(bestand>=bedarf)return OK;
    if(bestand>=bedarf*0.5)return WARN;
    return ERR;
  }

  // Datum-Labels fÃ¼r Wochen
  function wocheLabel(w){
    const von=new Date(heute);von.setDate(heute.getDate()+(w-1)*7);
    const bis=new Date(heute);bis.setDate(heute.getDate()+w*7-1);
    return `${von.getDate()}.${von.getMonth()+1} â€“ ${bis.getDate()}.${bis.getMonth()+1}`;
  }

  const anzInWiderruf=pipeline.filter(a=>!a.widerrufVorbei&&!a.montageKonkret).length;
  const anzTerminiert=pipeline.filter(a=>a.widerrufVorbei&&!a.montageKonkret).length;
  const anzKonkret=pipeline.filter(a=>a.montageKonkret).length;

  const anzeigeDaten=woche===0?null:wochenDaten.find(w=>w.woche===woche);
  const matAnzeige=woche===0?gesamt:anzeigeDaten?.mat;
  const anzAnzeige=woche===0?gesamt.anzahl:(anzeigeDaten?.anzahl||0);

  if(loading) return <div style={{textAlign:"center",padding:"60px 20px",color:TX2}}><div style={{fontSize:28,marginBottom:8}}>â³</div>Lade Auftragsdaten...</div>;

  return (
    <div>
      {/* PIPELINE ÃœBERSICHT */}
      <div style={{...CARD,marginBottom:14}}>
        <div style={{fontSize:10,color:TX2,fontWeight:700,letterSpacing:"0.5px",marginBottom:10}}>PIPELINE STATUS</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
          {[
            {n:anzInWiderruf,label:"In Widerrufsfrist",color:TX2,icon:"â³"},
            {n:anzTerminiert,label:"Zu terminieren",color:WARN,icon:"ğŸ“…"},
            {n:anzKonkret,label:"Konkret geplant",color:OK,icon:"âœ“"},
          ].map(({n,label,color,icon})=>(
            <div key={label} style={{textAlign:"center",background:C2,borderRadius:8,padding:"10px 6px"}}>
              <div style={{fontSize:22,fontWeight:800,color}}>{n}</div>
              <div style={{fontSize:9,color:TX2,marginTop:2,lineHeight:1.3}}>{icon} {label}</div>
            </div>
          ))}
        </div>
      </div>

      {/* SZENARIO WAHL */}
      <div style={{...CARD,marginBottom:14}}>
        <div style={{fontSize:10,color:TX2,fontWeight:700,letterSpacing:"0.5px",marginBottom:10}}>SZENARIO & PARAMETER</div>
        <div style={{display:"flex",gap:6,marginBottom:12}}>
          {[
            {id:"pessimistisch",label:"Pessimistisch",sub:"â€“30%",color:ERR},
            {id:"base",label:"Basis",sub:"Realistisch",color:OK},
            {id:"optimistisch",label:"Optimistisch",sub:"+25%",color:BLUE},
          ].map(s=>(
            <button key={s.id} onClick={()=>setSzenario(s.id)} style={{flex:1,padding:"8px 4px",borderRadius:8,border:`1px solid ${szenario===s.id?s.color:BR}`,background:szenario===s.id?`${s.color}15`:"transparent",color:szenario===s.id?s.color:TX2,fontSize:10,fontWeight:700,cursor:"pointer",textAlign:"center"}}>
              <div style={{fontSize:12}}>{s.label}</div>
              <div style={{fontSize:9,opacity:0.7}}>{s.sub}</div>
            </button>
          ))}
        </div>
        <div>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
            <span style={{fontSize:11,color:TX2}}>Storno-Risiko</span>
            <span style={{fontSize:11,fontWeight:700,color:stornoRate>20?ERR:stornoRate>10?WARN:OK}}>{stornoRate}%</span>
          </div>
          <input type="range" min="0" max="40" value={stornoRate} onChange={e=>setStornoRate(+e.target.value)} style={{width:"100%",accentColor:Y}}/>
        </div>
      </div>

      {/* WOCHEN TABS */}
      <div style={{display:"flex",gap:4,marginBottom:14}}>
        <button onClick={()=>setWoche(0)} style={{flex:1,padding:"7px 4px",borderRadius:8,border:`1px solid ${woche===0?Y:BR}`,background:woche===0?`${Y}15`:"transparent",color:woche===0?Y:TX2,fontSize:9,fontWeight:700,cursor:"pointer",textAlign:"center"}}>
          <div>Gesamt</div><div style={{fontSize:8,opacity:0.7}}>4 Wochen</div>
        </button>
        {wochenDaten.map(w=>(
          <button key={w.woche} onClick={()=>setWoche(w.woche)} style={{flex:1,padding:"7px 4px",borderRadius:8,border:`1px solid ${woche===w.woche?PURPLE:BR}`,background:woche===w.woche?`${PURPLE}15`:"transparent",color:woche===w.woche?PURPLE:TX2,fontSize:9,fontWeight:700,cursor:"pointer",textAlign:"center"}}>
            <div>KW{Math.ceil((new Date(heute).setDate(heute.getDate()+(w.woche-1)*7),new Date(heute.getTime()+(w.woche-1)*7*86400000).getDate())/7)+8}</div>
            <div style={{fontSize:8,opacity:0.7}}>{wocheLabel(w.woche)}</div>
            <div style={{fontSize:10,fontWeight:800,color:w.anzahl>0?TX:TX2}}>{w.anzahl}x</div>
          </button>
        ))}
      </div>

      {/* ZUSAMMENFASSUNG */}
      <div style={{...CARD,marginBottom:14,background:`${PURPLE}08`,borderColor:`${PURPLE}40`}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
          <div style={{fontWeight:800,fontSize:14}}>{woche===0?"4-Wochen Gesamt":`Woche ${woche} Â· ${wocheLabel(woche)}`}</div>
          <div style={{textAlign:"right"}}>
            <div style={{fontSize:20,fontWeight:800,color:PURPLE}}>{anzAnzeige}</div>
            <div style={{fontSize:9,color:TX2}}>Montagen</div>
          </div>
        </div>
        <div style={{fontSize:11,color:TX2}}>
          {woche===0?`Ã˜ ${Math.round(gesamt.kwp/Math.max(gesamt.anzahl,1)*10)/10} kWp Â· ${gesamt.kwp} kWp Gesamt`:`${anzeigeDaten?.kwpGesamt||0} kWp Â· Ã˜ ${anzeigeDaten?.avgKwp||0} kWp`}
        </div>
      </div>

      {/* MATERIAL-BEDARFS-LISTE MIT LAGER-AMPEL */}
      {matAnzeige&&(
        <div>
          <div style={{fontSize:10,color:TX2,fontWeight:700,letterSpacing:"0.5px",marginBottom:8}}>MATERIALBEDARF vs. LAGERBESTAND</div>

          {[
            {label:"PV-Module (Aiko)",      bedarf:matAnzeige.module,     lager:getStock("MOD-405")+getStock("MOD-430"), einheit:"Stk",  lief:"Tritec"},
            {label:"Fox Smart 12 WR",       bedarf:matAnzeige.wr_smart12, lager:getStock("WR-50")+getStock("WR-80")+getStock("WR-100"), einheit:"Stk", lief:"Fox"},
            {label:"Fox Smart 15 WR",       bedarf:matAnzeige.wr_smart15, lager:getStock("WR-100"),  einheit:"Stk", lief:"Fox"},
            {label:"Fox Pro 20/25 WR",      bedarf:matAnzeige.wr_pro20+matAnzeige.wr_pro25,lager:0, einheit:"Stk", lief:"Fox"},
            {label:"Batterie 6.4 kWh",      bedarf:matAnzeige.akku_64,   lager:getStock("BAT-M"),   einheit:"Stk",lief:"Fox"},
            {label:"Batterie 9.84 kWh",     bedarf:matAnzeige.akku_984,  lager:getStock("BAT-S1")+getStock("BAT-S2"),einheit:"Stk",lief:"Fox"},
            {label:"UK Profil (SL RACK)",   bedarf:matAnzeige.uk_profil, lager:getStock("UK-PRO"),  einheit:"m",   lief:"SL Rack"},
            {label:"UK Dachhaken",          bedarf:matAnzeige.uk_haken,  lager:getStock("UK-HAK"),  einheit:"Stk", lief:"SL Rack"},
            {label:"UK Klemmen",            bedarf:matAnzeige.uk_klemme, lager:getStock("UK-KLE"),  einheit:"Stk", lief:"SL Rack"},
            {label:"ZÃ¤hlerschrank 3P",      bedarf:matAnzeige.zs3p,      lager:getStock("ZS-3P"),   einheit:"Stk", lief:"Cordes"},
          ].filter(r=>r.bedarf>0).map(r=>{
            const ampel=getAmpel(r.bedarf,r.lager);
            const pct=Math.min(100,Math.round(r.lager/Math.max(r.bedarf,1)*100));
            const lc=LIEFERANTEN_DEFAULT[r.lief];
            return (
              <div key={r.label} style={{...CARD,marginBottom:8,borderLeft:`4px solid ${ampel}`,borderRadius:"0 10px 10px 0",paddingLeft:12}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                  <div>
                    <div style={{fontWeight:600,fontSize:12}}>{r.label}</div>
                    <div style={{fontSize:10,color:TX2}}>
                      <span style={{color:lc?.farbe}}>{r.lief}</span>
                    </div>
                  </div>
                  <div style={{textAlign:"right"}}>
                    <div style={{fontSize:14,fontWeight:800,color:ampel}}>{r.lager}<span style={{fontSize:10,color:TX2,fontWeight:400}}>/{r.bedarf} {r.einheit}</span></div>
                    <div style={{fontSize:10,color:ampel}}>{ampel===OK?"âœ“ Ausreichend":ampel===WARN?"âš  Knapp":"âœ• Fehlt"}</div>
                  </div>
                </div>
                <div style={{background:BR,borderRadius:4,height:4}}>
                  <div style={{width:`${pct}%`,height:"100%",background:ampel,borderRadius:4,transition:"width 0.4s"}}/>
                </div>
                {ampel!==OK&&(
                  <div style={{fontSize:10,color:ampel,marginTop:6}}>
                    {ampel===ERR?`âœ• Fehlen ${r.bedarf-r.lager} ${r.einheit} â€“ Sofort bei ${r.lief} bestellen`:`âš  Nur ${Math.round(pct)}% vorhanden â€“ Nachbestellen empfohlen`}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}

      {/* SZENARIO ERKLÃ„RUNG */}
      <div style={{background:C2,borderRadius:10,padding:"10px 14px",marginTop:6}}>
        <div style={{fontSize:10,color:TX2,lineHeight:1.6}}>
          <span style={{fontWeight:700,color:TX}}>Basis-Annahmen: </span>
          AuftrÃ¤ge nach 14 Tagen Widerruf gleichmÃ¤ÃŸig Ã¼ber 4 Wochen. Aktuell {anzInWiderruf} in Widerrufsfrist + {anzTerminiert} zu terminieren. Storno-Rate: {stornoRate}%. Module: Aiko 470W. UK: 2.5m Profil + 1.25 Haken + 2 Klemmen pro Modul.
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

</script>

<script>
function _esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=String(s);return d.innerHTML;}
</script>
<!-- bee-doo KI-Modul -->
<script>
const BEEDOO_AI = {
  API_URL: 'https://api.anthropic.com/v1/messages',
  API_KEY: atob(['c2stYW50LWFwaTAzLTBy','UThlLUVLZGhhWVhrZEFT','Q0JXWjgwYW0wMHRZWmVn','S0h5dWh3Si1sQnVjMlFt','X1ZBR25LMWlRWThEaXNk','ZHBqUG5JSTVR','WXpDVXFOWG5zck12QUJ3','LU9WNjVwd0FB'].join('')),
  MODEL: 'claude-sonnet-4-5-20250514',
  
  async call(systemPrompt, userMessage, maxTokens = 1500) {
    try {
      const res = await fetch(this.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': this.API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: this.MODEL,
          max_tokens: maxTokens,
          system: systemPrompt,
          messages: [{ role: 'user', content: userMessage }]
        })
      });
      if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'API Fehler'); }
      const data = await res.json();
      return data.content?.[0]?.text || '';
    } catch(e) { console.error('[bee-doo KI]', e); throw e; }
  },
  
  async callWithImage(systemPrompt, userMessage, base64, mediaType = 'image/jpeg', maxTokens = 1500) {
    try {
      const res = await fetch(this.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': this.API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: this.MODEL,
          max_tokens: maxTokens,
          system: systemPrompt,
          messages: [{ role: 'user', content: [
            { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
            { type: 'text', text: userMessage }
          ] }]
        })
      });
      if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'API Fehler'); }
      const data = await res.json();
      return data.content?.[0]?.text || '';
    } catch(e) { console.error('[bee-doo KI]', e); throw e; }
  },
  
  safeHTML(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; },
  parseJSON(text) {
    try { return JSON.parse(text.replace(/```json|```/g, '').trim()); } catch(e) { return null; }
  }
};
</script>

<script>
window.BEEDOO_KI_LAGER = {
  async analyzeStock() {
    const sys = `Du bist Lager-/Logistik-Experte fÃ¼r Solar-Material. Analysiere den aktuellen Bestand und prognostiziere EngpÃ¤sse.
Antworte als JSON: {"status":"ok/warnung/kritisch","low_stock":[{"item":"...","current":0,"needed":"...","reorder_by":"..."}],"overstock":[{"item":"...","excess":"..."}],"forecast":"...","order_suggestion":"...","tips":["..."]}`;
    const data = document.querySelector('#root')?.textContent?.substring(0, 4000) || '';
    const result = await BEEDOO_AI.call(sys, `Aktueller Lagerbestand:\n${data}`);
    return BEEDOO_AI.parseJSON(result);
  },

  createButton() {
    const btn = document.createElement('button');
    btn.innerHTML = 'ğŸ¤– Lager-KI';
    btn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;background:linear-gradient(135deg,#F5C500,#E07800);color:#000;border:none;padding:12px 20px;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;box-shadow:0 4px 20px rgba(245,197,0,.3);font-family:inherit;transition:all .2s';
    btn.onclick = async () => {
      btn.innerHTML = 'â³ PrÃ¼fe Bestand...';
      try {
        const data = await this.analyzeStock();
        if (data) { let msg = data.status?.toUpperCase() + '\n\n'; if(data.low_stock?.length) msg += 'Nachbestellen:\n' + data.low_stock.map(l=>l.item+': '+l.current+' (brauche '+l.needed+')').join('\n'); if(data.forecast) msg += '\n\nPrognose: '+data.forecast; alert(msg); }
      } catch(e) { alert('Fehler: '+e.message); }
      btn.innerHTML = 'ğŸ¤– Lager-KI';
    };
    document.body.appendChild(btn);
  }
};
document.addEventListener('DOMContentLoaded', () => setTimeout(() => BEEDOO_KI_LAGER.createButton(), 1000));
</script>

</body>
</html>
